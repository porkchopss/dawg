/*! jQuery v1.8.3 jquery.com | jquery.org/license */
(function(e, t) {
  function _(e) {
    var t = M[e] = {};
    return v.each(e.split(y), function(e, n) {
      t[n] = !0
    }), t
  }

  function H(e, n, r) {
    if (r === t && e.nodeType === 1) {
      var i = "data-" + n.replace(P, "-$1").toLowerCase();
      r = e.getAttribute(i);
      if (typeof r == "string") {
        try {
          r = r === "true" ? !0 : r === "false" ? !1 : r === "null" ? null : +r + "" === r ? +r : D.test(r) ? v.parseJSON(r) : r
        } catch (s) {}
        v.data(e, n, r)
      } else r = t
    }
    return r
  }

  function B(e) {
    var t;
    for (t in e) {
      if (t === "data" && v.isEmptyObject(e[t])) continue;
      if (t !== "toJSON") return !1
    }
    return !0
  }

  function et() {
    return !1
  }

  function tt() {
    return !0
  }

  function ut(e) {
    return !e || !e.parentNode || e.parentNode.nodeType === 11
  }

  function at(e, t) {
    do e = e[t]; while (e && e.nodeType !== 1);
    return e
  }

  function ft(e, t, n) {
    t = t || 0;
    if (v.isFunction(t)) return v.grep(e, function(e, r) {
      var i = !!t.call(e, r, e);
      return i === n
    });
    if (t.nodeType) return v.grep(e, function(e, r) {
      return e === t === n
    });
    if (typeof t == "string") {
      var r = v.grep(e, function(e) {
        return e.nodeType === 1
      });
      if (it.test(t)) return v.filter(t, r, !n);
      t = v.filter(t, r)
    }
    return v.grep(e, function(e, r) {
      return v.inArray(e, t) >= 0 === n
    })
  }

  function lt(e) {
    var t = ct.split("|"),
      n = e.createDocumentFragment();
    if (n.createElement)
      while (t.length) n.createElement(t.pop());
    return n
  }

  function Lt(e, t) {
    return e.getElementsByTagName(t)[0] || e.appendChild(e.ownerDocument.createElement(t))
  }

  function At(e, t) {
    if (t.nodeType !== 1 || !v.hasData(e)) return;
    var n, r, i, s = v._data(e),
      o = v._data(t, s),
      u = s.events;
    if (u) {
      delete o.handle, o.events = {};
      for (n in u)
        for (r = 0, i = u[n].length; r < i; r++) v.event.add(t, n, u[n][r])
    }
    o.data && (o.data = v.extend({}, o.data))
  }

  function Ot(e, t) {
    var n;
    if (t.nodeType !== 1) return;
    t.clearAttributes && t.clearAttributes(), t.mergeAttributes && t.mergeAttributes(e), n = t.nodeName.toLowerCase(), n === "object" ? (t.parentNode && (t.outerHTML = e.outerHTML), v.support.html5Clone && e.innerHTML && !v.trim(t.innerHTML) && (t.innerHTML = e.innerHTML)) : n === "input" && Et.test(e.type) ? (t.defaultChecked = t.checked = e.checked, t.value !== e.value && (t.value = e.value)) : n === "option" ? t.selected = e.defaultSelected : n === "input" || n === "textarea" ? t.defaultValue = e.defaultValue : n === "script" && t.text !== e.text && (t.text = e.text), t.removeAttribute(v.expando)
  }

  function Mt(e) {
    return typeof e.getElementsByTagName != "undefined" ? e.getElementsByTagName("*") : typeof e.querySelectorAll != "undefined" ? e.querySelectorAll("*") : []
  }

  function _t(e) {
    Et.test(e.type) && (e.defaultChecked = e.checked)
  }

  function Qt(e, t) {
    if (t in e) return t;
    var n = t.charAt(0).toUpperCase() + t.slice(1),
      r = t,
      i = Jt.length;
    while (i--) {
      t = Jt[i] + n;
      if (t in e) return t
    }
    return r
  }

  function Gt(e, t) {
    return e = t || e, v.css(e, "display") === "none" || !v.contains(e.ownerDocument, e)
  }

  function Yt(e, t) {
    var n, r, i = [],
      s = 0,
      o = e.length;
    for (; s < o; s++) {
      n = e[s];
      if (!n.style) continue;
      i[s] = v._data(n, "olddisplay"), t ? (!i[s] && n.style.display === "none" && (n.style.display = ""), n.style.display === "" && Gt(n) && (i[s] = v._data(n, "olddisplay", nn(n.nodeName)))) : (r = Dt(n, "display"), !i[s] && r !== "none" && v._data(n, "olddisplay", r))
    }
    for (s = 0; s < o; s++) {
      n = e[s];
      if (!n.style) continue;
      if (!t || n.style.display === "none" || n.style.display === "") n.style.display = t ? i[s] || "" : "none"
    }
    return e
  }

  function Zt(e, t, n) {
    var r = Rt.exec(t);
    return r ? Math.max(0, r[1] - (n || 0)) + (r[2] || "px") : t
  }

  function en(e, t, n, r) {
    var i = n === (r ? "border" : "content") ? 4 : t === "width" ? 1 : 0,
      s = 0;
    for (; i < 4; i += 2) n === "margin" && (s += v.css(e, n + $t[i], !0)), r ? (n === "content" && (s -= parseFloat(Dt(e, "padding" + $t[i])) || 0), n !== "margin" && (s -= parseFloat(Dt(e, "border" + $t[i] + "Width")) || 0)) : (s += parseFloat(Dt(e, "padding" + $t[i])) || 0, n !== "padding" && (s += parseFloat(Dt(e, "border" + $t[i] + "Width")) || 0));
    return s
  }

  function tn(e, t, n) {
    var r = t === "width" ? e.offsetWidth : e.offsetHeight,
      i = !0,
      s = v.support.boxSizing && v.css(e, "boxSizing") === "border-box";
    if (r <= 0 || r == null) {
      r = Dt(e, t);
      if (r < 0 || r == null) r = e.style[t];
      if (Ut.test(r)) return r;
      i = s && (v.support.boxSizingReliable || r === e.style[t]), r = parseFloat(r) || 0
    }
    return r + en(e, t, n || (s ? "border" : "content"), i) + "px"
  }

  function nn(e) {
    if (Wt[e]) return Wt[e];
    var t = v("<" + e + ">").appendTo(i.body),
      n = t.css("display");
    t.remove();
    if (n === "none" || n === "") {
      Pt = i.body.appendChild(Pt || v.extend(i.createElement("iframe"), {
        frameBorder: 0,
        width: 0,
        height: 0
      }));
      if (!Ht || !Pt.createElement) Ht = (Pt.contentWindow || Pt.contentDocument).document, Ht.write("<!doctype html><html><body>"), Ht.close();
      t = Ht.body.appendChild(Ht.createElement(e)), n = Dt(t, "display"), i.body.removeChild(Pt)
    }
    return Wt[e] = n, n
  }

  function fn(e, t, n, r) {
    var i;
    if (v.isArray(t)) v.each(t, function(t, i) {
      n || sn.test(e) ? r(e, i) : fn(e + "[" + (typeof i == "object" ? t : "") + "]", i, n, r)
    });
    else if (!n && v.type(t) === "object")
      for (i in t) fn(e + "[" + i + "]", t[i], n, r);
    else r(e, t)
  }

  function Cn(e) {
    return function(t, n) {
      typeof t != "string" && (n = t, t = "*");
      var r, i, s, o = t.toLowerCase().split(y),
        u = 0,
        a = o.length;
      if (v.isFunction(n))
        for (; u < a; u++) r = o[u], s = /^\+/.test(r), s && (r = r.substr(1) || "*"), i = e[r] = e[r] || [], i[s ? "unshift" : "push"](n)
    }
  }

  function kn(e, n, r, i, s, o) {
    s = s || n.dataTypes[0], o = o || {}, o[s] = !0;
    var u, a = e[s],
      f = 0,
      l = a ? a.length : 0,
      c = e === Sn;
    for (; f < l && (c || !u); f++) u = a[f](n, r, i), typeof u == "string" && (!c || o[u] ? u = t : (n.dataTypes.unshift(u), u = kn(e, n, r, i, u, o)));
    return (c || !u) && !o["*"] && (u = kn(e, n, r, i, "*", o)), u
  }

  function Ln(e, n) {
    var r, i, s = v.ajaxSettings.flatOptions || {};
    for (r in n) n[r] !== t && ((s[r] ? e : i || (i = {}))[r] = n[r]);
    i && v.extend(!0, e, i)
  }

  function An(e, n, r) {
    var i, s, o, u, a = e.contents,
      f = e.dataTypes,
      l = e.responseFields;
    for (s in l) s in r && (n[l[s]] = r[s]);
    while (f[0] === "*") f.shift(), i === t && (i = e.mimeType || n.getResponseHeader("content-type"));
    if (i)
      for (s in a)
        if (a[s] && a[s].test(i)) {
          f.unshift(s);
          break
        } if (f[0] in r) o = f[0];
    else {
      for (s in r) {
        if (!f[0] || e.converters[s + " " + f[0]]) {
          o = s;
          break
        }
        u || (u = s)
      }
      o = o || u
    }
    if (o) return o !== f[0] && f.unshift(o), r[o]
  }

  function On(e, t) {
    var n, r, i, s, o = e.dataTypes.slice(),
      u = o[0],
      a = {},
      f = 0;
    e.dataFilter && (t = e.dataFilter(t, e.dataType));
    if (o[1])
      for (n in e.converters) a[n.toLowerCase()] = e.converters[n];
    for (; i = o[++f];)
      if (i !== "*") {
        if (u !== "*" && u !== i) {
          n = a[u + " " + i] || a["* " + i];
          if (!n)
            for (r in a) {
              s = r.split(" ");
              if (s[1] === i) {
                n = a[u + " " + s[0]] || a["* " + s[0]];
                if (n) {
                  n === !0 ? n = a[r] : a[r] !== !0 && (i = s[0], o.splice(f--, 0, i));
                  break
                }
              }
            }
          if (n !== !0)
            if (n && e["throws"]) t = n(t);
            else try {
              t = n(t)
            } catch (l) {
              return {
                state: "parsererror",
                error: n ? l : "No conversion from " + u + " to " + i
              }
            }
        }
        u = i
      } return {
      state: "success",
      data: t
    }
  }

  function Fn() {
    try {
      return new e.XMLHttpRequest
    } catch (t) {}
  }

  function In() {
    try {
      return new e.ActiveXObject("Microsoft.XMLHTTP")
    } catch (t) {}
  }

  function $n() {
    return setTimeout(function() {
      qn = t
    }, 0), qn = v.now()
  }

  function Jn(e, t) {
    v.each(t, function(t, n) {
      var r = (Vn[t] || []).concat(Vn["*"]),
        i = 0,
        s = r.length;
      for (; i < s; i++)
        if (r[i].call(e, t, n)) return
    })
  }

  function Kn(e, t, n) {
    var r, i = 0,
      s = 0,
      o = Xn.length,
      u = v.Deferred().always(function() {
        delete a.elem
      }),
      a = function() {
        var t = qn || $n(),
          n = Math.max(0, f.startTime + f.duration - t),
          r = n / f.duration || 0,
          i = 1 - r,
          s = 0,
          o = f.tweens.length;
        for (; s < o; s++) f.tweens[s].run(i);
        return u.notifyWith(e, [f, i, n]), i < 1 && o ? n : (u.resolveWith(e, [f]), !1)
      },
      f = u.promise({
        elem: e,
        props: v.extend({}, t),
        opts: v.extend(!0, {
          specialEasing: {}
        }, n),
        originalProperties: t,
        originalOptions: n,
        startTime: qn || $n(),
        duration: n.duration,
        tweens: [],
        createTween: function(t, n, r) {
          var i = v.Tween(e, f.opts, t, n, f.opts.specialEasing[t] || f.opts.easing);
          return f.tweens.push(i), i
        },
        stop: function(t) {
          var n = 0,
            r = t ? f.tweens.length : 0;
          for (; n < r; n++) f.tweens[n].run(1);
          return t ? u.resolveWith(e, [f, t]) : u.rejectWith(e, [f, t]), this
        }
      }),
      l = f.props;
    Qn(l, f.opts.specialEasing);
    for (; i < o; i++) {
      r = Xn[i].call(f, e, l, f.opts);
      if (r) return r
    }
    return Jn(f, l), v.isFunction(f.opts.start) && f.opts.start.call(e, f), v.fx.timer(v.extend(a, {
      anim: f,
      queue: f.opts.queue,
      elem: e
    })), f.progress(f.opts.progress).done(f.opts.done, f.opts.complete).fail(f.opts.fail).always(f.opts.always)
  }

  function Qn(e, t) {
    var n, r, i, s, o;
    for (n in e) {
      r = v.camelCase(n), i = t[r], s = e[n], v.isArray(s) && (i = s[1], s = e[n] = s[0]), n !== r && (e[r] = s, delete e[n]), o = v.cssHooks[r];
      if (o && "expand" in o) {
        s = o.expand(s), delete e[r];
        for (n in s) n in e || (e[n] = s[n], t[n] = i)
      } else t[r] = i
    }
  }

  function Gn(e, t, n) {
    var r, i, s, o, u, a, f, l, c, h = this,
      p = e.style,
      d = {},
      m = [],
      g = e.nodeType && Gt(e);
    n.queue || (l = v._queueHooks(e, "fx"), l.unqueued == null && (l.unqueued = 0, c = l.empty.fire, l.empty.fire = function() {
      l.unqueued || c()
    }), l.unqueued++, h.always(function() {
      h.always(function() {
        l.unqueued--, v.queue(e, "fx").length || l.empty.fire()
      })
    })), e.nodeType === 1 && ("height" in t || "width" in t) && (n.overflow = [p.overflow, p.overflowX, p.overflowY], v.css(e, "display") === "inline" && v.css(e, "float") === "none" && (!v.support.inlineBlockNeedsLayout || nn(e.nodeName) === "inline" ? p.display = "inline-block" : p.zoom = 1)), n.overflow && (p.overflow = "hidden", v.support.shrinkWrapBlocks || h.done(function() {
      p.overflow = n.overflow[0], p.overflowX = n.overflow[1], p.overflowY = n.overflow[2]
    }));
    for (r in t) {
      s = t[r];
      if (Un.exec(s)) {
        delete t[r], a = a || s === "toggle";
        if (s === (g ? "hide" : "show")) continue;
        m.push(r)
      }
    }
    o = m.length;
    if (o) {
      u = v._data(e, "fxshow") || v._data(e, "fxshow", {}), "hidden" in u && (g = u.hidden), a && (u.hidden = !g), g ? v(e).show() : h.done(function() {
        v(e).hide()
      }), h.done(function() {
        var t;
        v.removeData(e, "fxshow", !0);
        for (t in d) v.style(e, t, d[t])
      });
      for (r = 0; r < o; r++) i = m[r], f = h.createTween(i, g ? u[i] : 0), d[i] = u[i] || v.style(e, i), i in u || (u[i] = f.start, g && (f.end = f.start, f.start = i === "width" || i === "height" ? 1 : 0))
    }
  }

  function Yn(e, t, n, r, i) {
    return new Yn.prototype.init(e, t, n, r, i)
  }

  function Zn(e, t) {
    var n, r = {
        height: e
      },
      i = 0;
    t = t ? 1 : 0;
    for (; i < 4; i += 2 - t) n = $t[i], r["margin" + n] = r["padding" + n] = e;
    return t && (r.opacity = r.width = e), r
  }

  function tr(e) {
    return v.isWindow(e) ? e : e.nodeType === 9 ? e.defaultView || e.parentWindow : !1
  }
  var n, r, i = e.document,
    s = e.location,
    o = e.navigator,
    u = e.jQuery,
    a = e.$,
    f = Array.prototype.push,
    l = Array.prototype.slice,
    c = Array.prototype.indexOf,
    h = Object.prototype.toString,
    p = Object.prototype.hasOwnProperty,
    d = String.prototype.trim,
    v = function(e, t) {
      return new v.fn.init(e, t, n)
    },
    m = /[\-+]?(?:\d*\.|)\d+(?:[eE][\-+]?\d+|)/.source,
    g = /\S/,
    y = /\s+/,
    b = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,
    w = /^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,
    E = /^<(\w+)\s*\/?>(?:<\/\1>|)$/,
    S = /^[\],:{}\s]*$/,
    x = /(?:^|:|,)(?:\s*\[)+/g,
    T = /\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,
    N = /"[^"\\\r\n]*"|true|false|null|-?(?:\d\d*\.|)\d+(?:[eE][\-+]?\d+|)/g,
    C = /^-ms-/,
    k = /-([\da-z])/gi,
    L = function(e, t) {
      return (t + "").toUpperCase()
    },
    A = function() {
      i.addEventListener ? (i.removeEventListener("DOMContentLoaded", A, !1), v.ready()) : i.readyState === "complete" && (i.detachEvent("onreadystatechange", A), v.ready())
    },
    O = {};
  v.fn = v.prototype = {
    constructor: v,
    init: function(e, n, r) {
      var s, o, u, a;
      if (!e) return this;
      if (e.nodeType) return this.context = this[0] = e, this.length = 1, this;
      if (typeof e == "string") {
        e.charAt(0) === "<" && e.charAt(e.length - 1) === ">" && e.length >= 3 ? s = [null, e, null] : s = w.exec(e);
        if (s && (s[1] || !n)) {
          if (s[1]) return n = n instanceof v ? n[0] : n, a = n && n.nodeType ? n.ownerDocument || n : i, e = v.parseHTML(s[1], a, !0), E.test(s[1]) && v.isPlainObject(n) && this.attr.call(e, n, !0), v.merge(this, e);
          o = i.getElementById(s[2]);
          if (o && o.parentNode) {
            if (o.id !== s[2]) return r.find(e);
            this.length = 1, this[0] = o
          }
          return this.context = i, this.selector = e, this
        }
        return !n || n.jquery ? (n || r).find(e) : this.constructor(n).find(e)
      }
      return v.isFunction(e) ? r.ready(e) : (e.selector !== t && (this.selector = e.selector, this.context = e.context), v.makeArray(e, this))
    },
    selector: "",
    jquery: "1.8.3",
    length: 0,
    size: function() {
      return this.length
    },
    toArray: function() {
      return l.call(this)
    },
    get: function(e) {
      return e == null ? this.toArray() : e < 0 ? this[this.length + e] : this[e]
    },
    pushStack: function(e, t, n) {
      var r = v.merge(this.constructor(), e);
      return r.prevObject = this, r.context = this.context, t === "find" ? r.selector = this.selector + (this.selector ? " " : "") + n : t && (r.selector = this.selector + "." + t + "(" + n + ")"), r
    },
    each: function(e, t) {
      return v.each(this, e, t)
    },
    ready: function(e) {
      return v.ready.promise().done(e), this
    },
    eq: function(e) {
      return e = +e, e === -1 ? this.slice(e) : this.slice(e, e + 1)
    },
    first: function() {
      return this.eq(0)
    },
    last: function() {
      return this.eq(-1)
    },
    slice: function() {
      return this.pushStack(l.apply(this, arguments), "slice", l.call(arguments).join(","))
    },
    map: function(e) {
      return this.pushStack(v.map(this, function(t, n) {
        return e.call(t, n, t)
      }))
    },
    end: function() {
      return this.prevObject || this.constructor(null)
    },
    push: f,
    sort: [].sort,
    splice: [].splice
  }, v.fn.init.prototype = v.fn, v.extend = v.fn.extend = function() {
    var e, n, r, i, s, o, u = arguments[0] || {},
      a = 1,
      f = arguments.length,
      l = !1;
    typeof u == "boolean" && (l = u, u = arguments[1] || {}, a = 2), typeof u != "object" && !v.isFunction(u) && (u = {}), f === a && (u = this, --a);
    for (; a < f; a++)
      if ((e = arguments[a]) != null)
        for (n in e) {
          r = u[n], i = e[n];
          if (u === i) continue;
          l && i && (v.isPlainObject(i) || (s = v.isArray(i))) ? (s ? (s = !1, o = r && v.isArray(r) ? r : []) : o = r && v.isPlainObject(r) ? r : {}, u[n] = v.extend(l, o, i)) : i !== t && (u[n] = i)
        }
    return u
  }, v.extend({
    noConflict: function(t) {
      return e.$ === v && (e.$ = a), t && e.jQuery === v && (e.jQuery = u), v
    },
    isReady: !1,
    readyWait: 1,
    holdReady: function(e) {
      e ? v.readyWait++ : v.ready(!0)
    },
    ready: function(e) {
      if (e === !0 ? --v.readyWait : v.isReady) return;
      if (!i.body) return setTimeout(v.ready, 1);
      v.isReady = !0;
      if (e !== !0 && --v.readyWait > 0) return;
      r.resolveWith(i, [v]), v.fn.trigger && v(i).trigger("ready").off("ready")
    },
    isFunction: function(e) {
      return v.type(e) === "function"
    },
    isArray: Array.isArray || function(e) {
      return v.type(e) === "array"
    },
    isWindow: function(e) {
      return e != null && e == e.window
    },
    isNumeric: function(e) {
      return !isNaN(parseFloat(e)) && isFinite(e)
    },
    type: function(e) {
      return e == null ? String(e) : O[h.call(e)] || "object"
    },
    isPlainObject: function(e) {
      if (!e || v.type(e) !== "object" || e.nodeType || v.isWindow(e)) return !1;
      try {
        if (e.constructor && !p.call(e, "constructor") && !p.call(e.constructor.prototype, "isPrototypeOf")) return !1
      } catch (n) {
        return !1
      }
      var r;
      for (r in e);
      return r === t || p.call(e, r)
    },
    isEmptyObject: function(e) {
      var t;
      for (t in e) return !1;
      return !0
    },
    error: function(e) {
      throw new Error(e)
    },
    parseHTML: function(e, t, n) {
      var r;
      return !e || typeof e != "string" ? null : (typeof t == "boolean" && (n = t, t = 0), t = t || i, (r = E.exec(e)) ? [t.createElement(r[1])] : (r = v.buildFragment([e], t, n ? null : []), v.merge([], (r.cacheable ? v.clone(r.fragment) : r.fragment).childNodes)))
    },
    parseJSON: function(t) {
      if (!t || typeof t != "string") return null;
      t = v.trim(t);
      if (e.JSON && e.JSON.parse) return e.JSON.parse(t);
      if (S.test(t.replace(T, "@").replace(N, "]").replace(x, ""))) return (new Function("return " + t))();
      v.error("Invalid JSON: " + t)
    },
    parseXML: function(n) {
      var r, i;
      if (!n || typeof n != "string") return null;
      try {
        e.DOMParser ? (i = new DOMParser, r = i.parseFromString(n, "text/xml")) : (r = new ActiveXObject("Microsoft.XMLDOM"), r.async = "false", r.loadXML(n))
      } catch (s) {
        r = t
      }
      return (!r || !r.documentElement || r.getElementsByTagName("parsererror").length) && v.error("Invalid XML: " + n), r
    },
    noop: function() {},
    globalEval: function(t) {
      t && g.test(t) && (e.execScript || function(t) {
        e.eval.call(e, t)
      })(t)
    },
    camelCase: function(e) {
      return e.replace(C, "ms-").replace(k, L)
    },
    nodeName: function(e, t) {
      return e.nodeName && e.nodeName.toLowerCase() === t.toLowerCase()
    },
    each: function(e, n, r) {
      var i, s = 0,
        o = e.length,
        u = o === t || v.isFunction(e);
      if (r) {
        if (u) {
          for (i in e)
            if (n.apply(e[i], r) === !1) break
        } else
          for (; s < o;)
            if (n.apply(e[s++], r) === !1) break
      } else if (u) {
        for (i in e)
          if (n.call(e[i], i, e[i]) === !1) break
      } else
        for (; s < o;)
          if (n.call(e[s], s, e[s++]) === !1) break;
      return e
    },
    trim: d && !d.call("\ufeff\u00a0") ? function(e) {
      return e == null ? "" : d.call(e)
    } : function(e) {
      return e == null ? "" : (e + "").replace(b, "")
    },
    makeArray: function(e, t) {
      var n, r = t || [];
      return e != null && (n = v.type(e), e.length == null || n === "string" || n === "function" || n === "regexp" || v.isWindow(e) ? f.call(r, e) : v.merge(r, e)), r
    },
    inArray: function(e, t, n) {
      var r;
      if (t) {
        if (c) return c.call(t, e, n);
        r = t.length, n = n ? n < 0 ? Math.max(0, r + n) : n : 0;
        for (; n < r; n++)
          if (n in t && t[n] === e) return n
      }
      return -1
    },
    merge: function(e, n) {
      var r = n.length,
        i = e.length,
        s = 0;
      if (typeof r == "number")
        for (; s < r; s++) e[i++] = n[s];
      else
        while (n[s] !== t) e[i++] = n[s++];
      return e.length = i, e
    },
    grep: function(e, t, n) {
      var r, i = [],
        s = 0,
        o = e.length;
      n = !!n;
      for (; s < o; s++) r = !!t(e[s], s), n !== r && i.push(e[s]);
      return i
    },
    map: function(e, n, r) {
      var i, s, o = [],
        u = 0,
        a = e.length,
        f = e instanceof v || a !== t && typeof a == "number" && (a > 0 && e[0] && e[a - 1] || a === 0 || v.isArray(e));
      if (f)
        for (; u < a; u++) i = n(e[u], u, r), i != null && (o[o.length] = i);
      else
        for (s in e) i = n(e[s], s, r), i != null && (o[o.length] = i);
      return o.concat.apply([], o)
    },
    guid: 1,
    proxy: function(e, n) {
      var r, i, s;
      return typeof n == "string" && (r = e[n], n = e, e = r), v.isFunction(e) ? (i = l.call(arguments, 2), s = function() {
        return e.apply(n, i.concat(l.call(arguments)))
      }, s.guid = e.guid = e.guid || v.guid++, s) : t
    },
    access: function(e, n, r, i, s, o, u) {
      var a, f = r == null,
        l = 0,
        c = e.length;
      if (r && typeof r == "object") {
        for (l in r) v.access(e, n, l, r[l], 1, o, i);
        s = 1
      } else if (i !== t) {
        a = u === t && v.isFunction(i), f && (a ? (a = n, n = function(e, t, n) {
          return a.call(v(e), n)
        }) : (n.call(e, i), n = null));
        if (n)
          for (; l < c; l++) n(e[l], r, a ? i.call(e[l], l, n(e[l], r)) : i, u);
        s = 1
      }
      return s ? e : f ? n.call(e) : c ? n(e[0], r) : o
    },
    now: function() {
      return (new Date).getTime()
    }
  }), v.ready.promise = function(t) {
    if (!r) {
      r = v.Deferred();
      if (i.readyState === "complete") setTimeout(v.ready, 1);
      else if (i.addEventListener) i.addEventListener("DOMContentLoaded", A, !1), e.addEventListener("load", v.ready, !1);
      else {
        i.attachEvent("onreadystatechange", A), e.attachEvent("onload", v.ready);
        var n = !1;
        try {
          n = e.frameElement == null && i.documentElement
        } catch (s) {}
        n && n.doScroll && function o() {
          if (!v.isReady) {
            try {
              n.doScroll("left")
            } catch (e) {
              return setTimeout(o, 50)
            }
            v.ready()
          }
        }()
      }
    }
    return r.promise(t)
  }, v.each("Boolean Number String Function Array Date RegExp Object".split(" "), function(e, t) {
    O["[object " + t + "]"] = t.toLowerCase()
  }), n = v(i);
  var M = {};
  v.Callbacks = function(e) {
    e = typeof e == "string" ? M[e] || _(e) : v.extend({}, e);
    var n, r, i, s, o, u, a = [],
      f = !e.once && [],
      l = function(t) {
        n = e.memory && t, r = !0, u = s || 0, s = 0, o = a.length, i = !0;
        for (; a && u < o; u++)
          if (a[u].apply(t[0], t[1]) === !1 && e.stopOnFalse) {
            n = !1;
            break
          } i = !1, a && (f ? f.length && l(f.shift()) : n ? a = [] : c.disable())
      },
      c = {
        add: function() {
          if (a) {
            var t = a.length;
            (function r(t) {
              v.each(t, function(t, n) {
                var i = v.type(n);
                i === "function" ? (!e.unique || !c.has(n)) && a.push(n) : n && n.length && i !== "string" && r(n)
              })
            })(arguments), i ? o = a.length : n && (s = t, l(n))
          }
          return this
        },
        remove: function() {
          return a && v.each(arguments, function(e, t) {
            var n;
            while ((n = v.inArray(t, a, n)) > -1) a.splice(n, 1), i && (n <= o && o--, n <= u && u--)
          }), this
        },
        has: function(e) {
          return v.inArray(e, a) > -1
        },
        empty: function() {
          return a = [], this
        },
        disable: function() {
          return a = f = n = t, this
        },
        disabled: function() {
          return !a
        },
        lock: function() {
          return f = t, n || c.disable(), this
        },
        locked: function() {
          return !f
        },
        fireWith: function(e, t) {
          return t = t || [], t = [e, t.slice ? t.slice() : t], a && (!r || f) && (i ? f.push(t) : l(t)), this
        },
        fire: function() {
          return c.fireWith(this, arguments), this
        },
        fired: function() {
          return !!r
        }
      };
    return c
  }, v.extend({
    Deferred: function(e) {
      var t = [
          ["resolve", "done", v.Callbacks("once memory"), "resolved"],
          ["reject", "fail", v.Callbacks("once memory"), "rejected"],
          ["notify", "progress", v.Callbacks("memory")]
        ],
        n = "pending",
        r = {
          state: function() {
            return n
          },
          always: function() {
            return i.done(arguments).fail(arguments), this
          },
          then: function() {
            var e = arguments;
            return v.Deferred(function(n) {
              v.each(t, function(t, r) {
                var s = r[0],
                  o = e[t];
                i[r[1]](v.isFunction(o) ? function() {
                  var e = o.apply(this, arguments);
                  e && v.isFunction(e.promise) ? e.promise().done(n.resolve).fail(n.reject).progress(n.notify) : n[s + "With"](this === i ? n : this, [e])
                } : n[s])
              }), e = null
            }).promise()
          },
          promise: function(e) {
            return e != null ? v.extend(e, r) : r
          }
        },
        i = {};
      return r.pipe = r.then, v.each(t, function(e, s) {
        var o = s[2],
          u = s[3];
        r[s[1]] = o.add, u && o.add(function() {
          n = u
        }, t[e ^ 1][2].disable, t[2][2].lock), i[s[0]] = o.fire, i[s[0] + "With"] = o.fireWith
      }), r.promise(i), e && e.call(i, i), i
    },
    when: function(e) {
      var t = 0,
        n = l.call(arguments),
        r = n.length,
        i = r !== 1 || e && v.isFunction(e.promise) ? r : 0,
        s = i === 1 ? e : v.Deferred(),
        o = function(e, t, n) {
          return function(r) {
            t[e] = this, n[e] = arguments.length > 1 ? l.call(arguments) : r, n === u ? s.notifyWith(t, n) : --i || s.resolveWith(t, n)
          }
        },
        u, a, f;
      if (r > 1) {
        u = new Array(r), a = new Array(r), f = new Array(r);
        for (; t < r; t++) n[t] && v.isFunction(n[t].promise) ? n[t].promise().done(o(t, f, n)).fail(s.reject).progress(o(t, a, u)) : --i
      }
      return i || s.resolveWith(f, n), s.promise()
    }
  }), v.support = function() {
    var t, n, r, s, o, u, a, f, l, c, h, p = i.createElement("div");
    p.setAttribute("className", "t"), p.innerHTML = "  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>", n = p.getElementsByTagName("*"), r = p.getElementsByTagName("a")[0];
    if (!n || !r || !n.length) return {};
    s = i.createElement("select"), o = s.appendChild(i.createElement("option")), u = p.getElementsByTagName("input")[0], r.style.cssText = "top:1px;float:left;opacity:.5", t = {
      leadingWhitespace: p.firstChild.nodeType === 3,
      tbody: !p.getElementsByTagName("tbody").length,
      htmlSerialize: !!p.getElementsByTagName("link").length,
      style: /top/.test(r.getAttribute("style")),
      hrefNormalized: r.getAttribute("href") === "/a",
      opacity: /^0.5/.test(r.style.opacity),
      cssFloat: !!r.style.cssFloat,
      checkOn: u.value === "on",
      optSelected: o.selected,
      getSetAttribute: p.className !== "t",
      enctype: !!i.createElement("form").enctype,
      html5Clone: i.createElement("nav").cloneNode(!0).outerHTML !== "<:nav></:nav>",
      boxModel: i.compatMode === "CSS1Compat",
      submitBubbles: !0,
      changeBubbles: !0,
      focusinBubbles: !1,
      deleteExpando: !0,
      noCloneEvent: !0,
      inlineBlockNeedsLayout: !1,
      shrinkWrapBlocks: !1,
      reliableMarginRight: !0,
      boxSizingReliable: !0,
      pixelPosition: !1
    }, u.checked = !0, t.noCloneChecked = u.cloneNode(!0).checked, s.disabled = !0, t.optDisabled = !o.disabled;
    try {
      delete p.test
    } catch (d) {
      t.deleteExpando = !1
    }!p.addEventListener && p.attachEvent && p.fireEvent && (p.attachEvent("onclick", h = function() {
      t.noCloneEvent = !1
    }), p.cloneNode(!0).fireEvent("onclick"), p.detachEvent("onclick", h)), u = i.createElement("input"), u.value = "t", u.setAttribute("type", "radio"), t.radioValue = u.value === "t", u.setAttribute("checked", "checked"), u.setAttribute("name", "t"), p.appendChild(u), a = i.createDocumentFragment(), a.appendChild(p.lastChild), t.checkClone = a.cloneNode(!0).cloneNode(!0).lastChild.checked, t.appendChecked = u.checked, a.removeChild(u), a.appendChild(p);
    if (p.attachEvent)
      for (l in {
          submit: !0,
          change: !0,
          focusin: !0
        }) f = "on" + l, c = f in p, c || (p.setAttribute(f, "return;"), c = typeof p[f] == "function"), t[l + "Bubbles"] = c;
    return v(function() {
      var n, r, s, o, u = "padding:0;margin:0;border:0;display:block;overflow:hidden;",
        a = i.getElementsByTagName("body")[0];
      if (!a) return;
      n = i.createElement("div"), n.style.cssText = "visibility:hidden;border:0;width:0;height:0;position:static;top:0;margin-top:1px", a.insertBefore(n, a.firstChild), r = i.createElement("div"), n.appendChild(r), r.innerHTML = "<table><tr><td></td><td>t</td></tr></table>", s = r.getElementsByTagName("td"), s[0].style.cssText = "padding:0;margin:0;border:0;display:none", c = s[0].offsetHeight === 0, s[0].style.display = "", s[1].style.display = "none", t.reliableHiddenOffsets = c && s[0].offsetHeight === 0, r.innerHTML = "", r.style.cssText = "box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;", t.boxSizing = r.offsetWidth === 4, t.doesNotIncludeMarginInBodyOffset = a.offsetTop !== 1, e.getComputedStyle && (t.pixelPosition = (e.getComputedStyle(r, null) || {}).top !== "1%", t.boxSizingReliable = (e.getComputedStyle(r, null) || {
        width: "4px"
      }).width === "4px", o = i.createElement("div"), o.style.cssText = r.style.cssText = u, o.style.marginRight = o.style.width = "0", r.style.width = "1px", r.appendChild(o), t.reliableMarginRight = !parseFloat((e.getComputedStyle(o, null) || {}).marginRight)), typeof r.style.zoom != "undefined" && (r.innerHTML = "", r.style.cssText = u + "width:1px;padding:1px;display:inline;zoom:1", t.inlineBlockNeedsLayout = r.offsetWidth === 3, r.style.display = "block", r.style.overflow = "visible", r.innerHTML = "<div></div>", r.firstChild.style.width = "5px", t.shrinkWrapBlocks = r.offsetWidth !== 3, n.style.zoom = 1), a.removeChild(n), n = r = s = o = null
    }), a.removeChild(p), n = r = s = o = u = a = p = null, t
  }();
  var D = /(?:\{[\s\S]*\}|\[[\s\S]*\])$/,
    P = /([A-Z])/g;
  v.extend({
    cache: {},
    deletedIds: [],
    uuid: 0,
    expando: "jQuery" + (v.fn.jquery + Math.random()).replace(/\D/g, ""),
    noData: {
      embed: !0,
      object: "clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",
      applet: !0
    },
    hasData: function(e) {
      return e = e.nodeType ? v.cache[e[v.expando]] : e[v.expando], !!e && !B(e)
    },
    data: function(e, n, r, i) {
      if (!v.acceptData(e)) return;
      var s, o, u = v.expando,
        a = typeof n == "string",
        f = e.nodeType,
        l = f ? v.cache : e,
        c = f ? e[u] : e[u] && u;
      if ((!c || !l[c] || !i && !l[c].data) && a && r === t) return;
      c || (f ? e[u] = c = v.deletedIds.pop() || v.guid++ : c = u), l[c] || (l[c] = {}, f || (l[c].toJSON = v.noop));
      if (typeof n == "object" || typeof n == "function") i ? l[c] = v.extend(l[c], n) : l[c].data = v.extend(l[c].data, n);
      return s = l[c], i || (s.data || (s.data = {}), s = s.data), r !== t && (s[v.camelCase(n)] = r), a ? (o = s[n], o == null && (o = s[v.camelCase(n)])) : o = s, o
    },
    removeData: function(e, t, n) {
      if (!v.acceptData(e)) return;
      var r, i, s, o = e.nodeType,
        u = o ? v.cache : e,
        a = o ? e[v.expando] : v.expando;
      if (!u[a]) return;
      if (t) {
        r = n ? u[a] : u[a].data;
        if (r) {
          v.isArray(t) || (t in r ? t = [t] : (t = v.camelCase(t), t in r ? t = [t] : t = t.split(" ")));
          for (i = 0, s = t.length; i < s; i++) delete r[t[i]];
          if (!(n ? B : v.isEmptyObject)(r)) return
        }
      }
      if (!n) {
        delete u[a].data;
        if (!B(u[a])) return
      }
      o ? v.cleanData([e], !0) : v.support.deleteExpando || u != u.window ? delete u[a] : u[a] = null
    },
    _data: function(e, t, n) {
      return v.data(e, t, n, !0)
    },
    acceptData: function(e) {
      var t = e.nodeName && v.noData[e.nodeName.toLowerCase()];
      return !t || t !== !0 && e.getAttribute("classid") === t
    }
  }), v.fn.extend({
    data: function(e, n) {
      var r, i, s, o, u, a = this[0],
        f = 0,
        l = null;
      if (e === t) {
        if (this.length) {
          l = v.data(a);
          if (a.nodeType === 1 && !v._data(a, "parsedAttrs")) {
            s = a.attributes;
            for (u = s.length; f < u; f++) o = s[f].name, o.indexOf("data-") || (o = v.camelCase(o.substring(5)), H(a, o, l[o]));
            v._data(a, "parsedAttrs", !0)
          }
        }
        return l
      }
      return typeof e == "object" ? this.each(function() {
        v.data(this, e)
      }) : (r = e.split(".", 2), r[1] = r[1] ? "." + r[1] : "", i = r[1] + "!", v.access(this, function(n) {
        if (n === t) return l = this.triggerHandler("getData" + i, [r[0]]), l === t && a && (l = v.data(a, e), l = H(a, e, l)), l === t && r[1] ? this.data(r[0]) : l;
        r[1] = n, this.each(function() {
          var t = v(this);
          t.triggerHandler("setData" + i, r), v.data(this, e, n), t.triggerHandler("changeData" + i, r)
        })
      }, null, n, arguments.length > 1, null, !1))
    },
    removeData: function(e) {
      return this.each(function() {
        v.removeData(this, e)
      })
    }
  }), v.extend({
    queue: function(e, t, n) {
      var r;
      if (e) return t = (t || "fx") + "queue", r = v._data(e, t), n && (!r || v.isArray(n) ? r = v._data(e, t, v.makeArray(n)) : r.push(n)), r || []
    },
    dequeue: function(e, t) {
      t = t || "fx";
      var n = v.queue(e, t),
        r = n.length,
        i = n.shift(),
        s = v._queueHooks(e, t),
        o = function() {
          v.dequeue(e, t)
        };
      i === "inprogress" && (i = n.shift(), r--), i && (t === "fx" && n.unshift("inprogress"), delete s.stop, i.call(e, o, s)), !r && s && s.empty.fire()
    },
    _queueHooks: function(e, t) {
      var n = t + "queueHooks";
      return v._data(e, n) || v._data(e, n, {
        empty: v.Callbacks("once memory").add(function() {
          v.removeData(e, t + "queue", !0), v.removeData(e, n, !0)
        })
      })
    }
  }), v.fn.extend({
    queue: function(e, n) {
      var r = 2;
      return typeof e != "string" && (n = e, e = "fx", r--), arguments.length < r ? v.queue(this[0], e) : n === t ? this : this.each(function() {
        var t = v.queue(this, e, n);
        v._queueHooks(this, e), e === "fx" && t[0] !== "inprogress" && v.dequeue(this, e)
      })
    },
    dequeue: function(e) {
      return this.each(function() {
        v.dequeue(this, e)
      })
    },
    delay: function(e, t) {
      return e = v.fx ? v.fx.speeds[e] || e : e, t = t || "fx", this.queue(t, function(t, n) {
        var r = setTimeout(t, e);
        n.stop = function() {
          clearTimeout(r)
        }
      })
    },
    clearQueue: function(e) {
      return this.queue(e || "fx", [])
    },
    promise: function(e, n) {
      var r, i = 1,
        s = v.Deferred(),
        o = this,
        u = this.length,
        a = function() {
          --i || s.resolveWith(o, [o])
        };
      typeof e != "string" && (n = e, e = t), e = e || "fx";
      while (u--) r = v._data(o[u], e + "queueHooks"), r && r.empty && (i++, r.empty.add(a));
      return a(), s.promise(n)
    }
  });
  var j, F, I, q = /[\t\r\n]/g,
    R = /\r/g,
    U = /^(?:button|input)$/i,
    z = /^(?:button|input|object|select|textarea)$/i,
    W = /^a(?:rea|)$/i,
    X = /^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,
    V = v.support.getSetAttribute;
  v.fn.extend({
    attr: function(e, t) {
      return v.access(this, v.attr, e, t, arguments.length > 1)
    },
    removeAttr: function(e) {
      return this.each(function() {
        v.removeAttr(this, e)
      })
    },
    prop: function(e, t) {
      return v.access(this, v.prop, e, t, arguments.length > 1)
    },
    removeProp: function(e) {
      return e = v.propFix[e] || e, this.each(function() {
        try {
          this[e] = t, delete this[e]
        } catch (n) {}
      })
    },
    addClass: function(e) {
      var t, n, r, i, s, o, u;
      if (v.isFunction(e)) return this.each(function(t) {
        v(this).addClass(e.call(this, t, this.className))
      });
      if (e && typeof e == "string") {
        t = e.split(y);
        for (n = 0, r = this.length; n < r; n++) {
          i = this[n];
          if (i.nodeType === 1)
            if (!i.className && t.length === 1) i.className = e;
            else {
              s = " " + i.className + " ";
              for (o = 0, u = t.length; o < u; o++) s.indexOf(" " + t[o] + " ") < 0 && (s += t[o] + " ");
              i.className = v.trim(s)
            }
        }
      }
      return this
    },
    removeClass: function(e) {
      var n, r, i, s, o, u, a;
      if (v.isFunction(e)) return this.each(function(t) {
        v(this).removeClass(e.call(this, t, this.className))
      });
      if (e && typeof e == "string" || e === t) {
        n = (e || "").split(y);
        for (u = 0, a = this.length; u < a; u++) {
          i = this[u];
          if (i.nodeType === 1 && i.className) {
            r = (" " + i.className + " ").replace(q, " ");
            for (s = 0, o = n.length; s < o; s++)
              while (r.indexOf(" " + n[s] + " ") >= 0) r = r.replace(" " + n[s] + " ", " ");
            i.className = e ? v.trim(r) : ""
          }
        }
      }
      return this
    },
    toggleClass: function(e, t) {
      var n = typeof e,
        r = typeof t == "boolean";
      return v.isFunction(e) ? this.each(function(n) {
        v(this).toggleClass(e.call(this, n, this.className, t), t)
      }) : this.each(function() {
        if (n === "string") {
          var i, s = 0,
            o = v(this),
            u = t,
            a = e.split(y);
          while (i = a[s++]) u = r ? u : !o.hasClass(i), o[u ? "addClass" : "removeClass"](i)
        } else if (n === "undefined" || n === "boolean") this.className && v._data(this, "__className__", this.className), this.className = this.className || e === !1 ? "" : v._data(this, "__className__") || ""
      })
    },
    hasClass: function(e) {
      var t = " " + e + " ",
        n = 0,
        r = this.length;
      for (; n < r; n++)
        if (this[n].nodeType === 1 && (" " + this[n].className + " ").replace(q, " ").indexOf(t) >= 0) return !0;
      return !1
    },
    val: function(e) {
      var n, r, i, s = this[0];
      if (!arguments.length) {
        if (s) return n = v.valHooks[s.type] || v.valHooks[s.nodeName.toLowerCase()], n && "get" in n && (r = n.get(s, "value")) !== t ? r : (r = s.value, typeof r == "string" ? r.replace(R, "") : r == null ? "" : r);
        return
      }
      return i = v.isFunction(e), this.each(function(r) {
        var s, o = v(this);
        if (this.nodeType !== 1) return;
        i ? s = e.call(this, r, o.val()) : s = e, s == null ? s = "" : typeof s == "number" ? s += "" : v.isArray(s) && (s = v.map(s, function(e) {
          return e == null ? "" : e + ""
        })), n = v.valHooks[this.type] || v.valHooks[this.nodeName.toLowerCase()];
        if (!n || !("set" in n) || n.set(this, s, "value") === t) this.value = s
      })
    }
  }), v.extend({
    valHooks: {
      option: {
        get: function(e) {
          var t = e.attributes.value;
          return !t || t.specified ? e.value : e.text
        }
      },
      select: {
        get: function(e) {
          var t, n, r = e.options,
            i = e.selectedIndex,
            s = e.type === "select-one" || i < 0,
            o = s ? null : [],
            u = s ? i + 1 : r.length,
            a = i < 0 ? u : s ? i : 0;
          for (; a < u; a++) {
            n = r[a];
            if ((n.selected || a === i) && (v.support.optDisabled ? !n.disabled : n.getAttribute("disabled") === null) && (!n.parentNode.disabled || !v.nodeName(n.parentNode, "optgroup"))) {
              t = v(n).val();
              if (s) return t;
              o.push(t)
            }
          }
          return o
        },
        set: function(e, t) {
          var n = v.makeArray(t);
          return v(e).find("option").each(function() {
            this.selected = v.inArray(v(this).val(), n) >= 0
          }), n.length || (e.selectedIndex = -1), n
        }
      }
    },
    attrFn: {},
    attr: function(e, n, r, i) {
      var s, o, u, a = e.nodeType;
      if (!e || a === 3 || a === 8 || a === 2) return;
      if (i && v.isFunction(v.fn[n])) return v(e)[n](r);
      if (typeof e.getAttribute == "undefined") return v.prop(e, n, r);
      u = a !== 1 || !v.isXMLDoc(e), u && (n = n.toLowerCase(), o = v.attrHooks[n] || (X.test(n) ? F : j));
      if (r !== t) {
        if (r === null) {
          v.removeAttr(e, n);
          return
        }
        return o && "set" in o && u && (s = o.set(e, r, n)) !== t ? s : (e.setAttribute(n, r + ""), r)
      }
      return o && "get" in o && u && (s = o.get(e, n)) !== null ? s : (s = e.getAttribute(n), s === null ? t : s)
    },
    removeAttr: function(e, t) {
      var n, r, i, s, o = 0;
      if (t && e.nodeType === 1) {
        r = t.split(y);
        for (; o < r.length; o++) i = r[o], i && (n = v.propFix[i] || i, s = X.test(i), s || v.attr(e, i, ""), e.removeAttribute(V ? i : n), s && n in e && (e[n] = !1))
      }
    },
    attrHooks: {
      type: {
        set: function(e, t) {
          if (U.test(e.nodeName) && e.parentNode) v.error("type property can't be changed");
          else if (!v.support.radioValue && t === "radio" && v.nodeName(e, "input")) {
            var n = e.value;
            return e.setAttribute("type", t), n && (e.value = n), t
          }
        }
      },
      value: {
        get: function(e, t) {
          return j && v.nodeName(e, "button") ? j.get(e, t) : t in e ? e.value : null
        },
        set: function(e, t, n) {
          if (j && v.nodeName(e, "button")) return j.set(e, t, n);
          e.value = t
        }
      }
    },
    propFix: {
      tabindex: "tabIndex",
      readonly: "readOnly",
      "for": "htmlFor",
      "class": "className",
      maxlength: "maxLength",
      cellspacing: "cellSpacing",
      cellpadding: "cellPadding",
      rowspan: "rowSpan",
      colspan: "colSpan",
      usemap: "useMap",
      frameborder: "frameBorder",
      contenteditable: "contentEditable"
    },
    prop: function(e, n, r) {
      var i, s, o, u = e.nodeType;
      if (!e || u === 3 || u === 8 || u === 2) return;
      return o = u !== 1 || !v.isXMLDoc(e), o && (n = v.propFix[n] || n, s = v.propHooks[n]), r !== t ? s && "set" in s && (i = s.set(e, r, n)) !== t ? i : e[n] = r : s && "get" in s && (i = s.get(e, n)) !== null ? i : e[n]
    },
    propHooks: {
      tabIndex: {
        get: function(e) {
          var n = e.getAttributeNode("tabindex");
          return n && n.specified ? parseInt(n.value, 10) : z.test(e.nodeName) || W.test(e.nodeName) && e.href ? 0 : t
        }
      }
    }
  }), F = {
    get: function(e, n) {
      var r, i = v.prop(e, n);
      return i === !0 || typeof i != "boolean" && (r = e.getAttributeNode(n)) && r.nodeValue !== !1 ? n.toLowerCase() : t
    },
    set: function(e, t, n) {
      var r;
      return t === !1 ? v.removeAttr(e, n) : (r = v.propFix[n] || n, r in e && (e[r] = !0), e.setAttribute(n, n.toLowerCase())), n
    }
  }, V || (I = {
    name: !0,
    id: !0,
    coords: !0
  }, j = v.valHooks.button = {
    get: function(e, n) {
      var r;
      return r = e.getAttributeNode(n), r && (I[n] ? r.value !== "" : r.specified) ? r.value : t
    },
    set: function(e, t, n) {
      var r = e.getAttributeNode(n);
      return r || (r = i.createAttribute(n), e.setAttributeNode(r)), r.value = t + ""
    }
  }, v.each(["width", "height"], function(e, t) {
    v.attrHooks[t] = v.extend(v.attrHooks[t], {
      set: function(e, n) {
        if (n === "") return e.setAttribute(t, "auto"), n
      }
    })
  }), v.attrHooks.contenteditable = {
    get: j.get,
    set: function(e, t, n) {
      t === "" && (t = "false"), j.set(e, t, n)
    }
  }), v.support.hrefNormalized || v.each(["href", "src", "width", "height"], function(e, n) {
    v.attrHooks[n] = v.extend(v.attrHooks[n], {
      get: function(e) {
        var r = e.getAttribute(n, 2);
        return r === null ? t : r
      }
    })
  }), v.support.style || (v.attrHooks.style = {
    get: function(e) {
      return e.style.cssText.toLowerCase() || t
    },
    set: function(e, t) {
      return e.style.cssText = t + ""
    }
  }), v.support.optSelected || (v.propHooks.selected = v.extend(v.propHooks.selected, {
    get: function(e) {
      var t = e.parentNode;
      return t && (t.selectedIndex, t.parentNode && t.parentNode.selectedIndex), null
    }
  })), v.support.enctype || (v.propFix.enctype = "encoding"), v.support.checkOn || v.each(["radio", "checkbox"], function() {
    v.valHooks[this] = {
      get: function(e) {
        return e.getAttribute("value") === null ? "on" : e.value
      }
    }
  }), v.each(["radio", "checkbox"], function() {
    v.valHooks[this] = v.extend(v.valHooks[this], {
      set: function(e, t) {
        if (v.isArray(t)) return e.checked = v.inArray(v(e).val(), t) >= 0
      }
    })
  });
  var $ = /^(?:textarea|input|select)$/i,
    J = /^([^\.]*|)(?:\.(.+)|)$/,
    K = /(?:^|\s)hover(\.\S+|)\b/,
    Q = /^key/,
    G = /^(?:mouse|contextmenu)|click/,
    Y = /^(?:focusinfocus|focusoutblur)$/,
    Z = function(e) {
      return v.event.special.hover ? e : e.replace(K, "mouseenter$1 mouseleave$1")
    };
  v.event = {
      add: function(e, n, r, i, s) {
        var o, u, a, f, l, c, h, p, d, m, g;
        if (e.nodeType === 3 || e.nodeType === 8 || !n || !r || !(o = v._data(e))) return;
        r.handler && (d = r, r = d.handler, s = d.selector), r.guid || (r.guid = v.guid++), a = o.events, a || (o.events = a = {}), u = o.handle, u || (o.handle = u = function(e) {
          return typeof v == "undefined" || !!e && v.event.triggered === e.type ? t : v.event.dispatch.apply(u.elem, arguments)
        }, u.elem = e), n = v.trim(Z(n)).split(" ");
        for (f = 0; f < n.length; f++) {
          l = J.exec(n[f]) || [], c = l[1], h = (l[2] || "").split(".").sort(), g = v.event.special[c] || {}, c = (s ? g.delegateType : g.bindType) || c, g = v.event.special[c] || {}, p = v.extend({
            type: c,
            origType: l[1],
            data: i,
            handler: r,
            guid: r.guid,
            selector: s,
            needsContext: s && v.expr.match.needsContext.test(s),
            namespace: h.join(".")
          }, d), m = a[c];
          if (!m) {
            m = a[c] = [], m.delegateCount = 0;
            if (!g.setup || g.setup.call(e, i, h, u) === !1) e.addEventListener ? e.addEventListener(c, u, !1) : e.attachEvent && e.attachEvent("on" + c, u)
          }
          g.add && (g.add.call(e, p), p.handler.guid || (p.handler.guid = r.guid)), s ? m.splice(m.delegateCount++, 0, p) : m.push(p), v.event.global[c] = !0
        }
        e = null
      },
      global: {},
      remove: function(e, t, n, r, i) {
        var s, o, u, a, f, l, c, h, p, d, m, g = v.hasData(e) && v._data(e);
        if (!g || !(h = g.events)) return;
        t = v.trim(Z(t || "")).split(" ");
        for (s = 0; s < t.length; s++) {
          o = J.exec(t[s]) || [], u = a = o[1], f = o[2];
          if (!u) {
            for (u in h) v.event.remove(e, u + t[s], n, r, !0);
            continue
          }
          p = v.event.special[u] || {}, u = (r ? p.delegateType : p.bindType) || u, d = h[u] || [], l = d.length, f = f ? new RegExp("(^|\\.)" + f.split(".").sort().join("\\.(?:.*\\.|)") + "(\\.|$)") : null;
          for (c = 0; c < d.length; c++) m = d[c], (i || a === m.origType) && (!n || n.guid === m.guid) && (!f || f.test(m.namespace)) && (!r || r === m.selector || r === "**" && m.selector) && (d.splice(c--, 1), m.selector && d.delegateCount--, p.remove && p.remove.call(e, m));
          d.length === 0 && l !== d.length && ((!p.teardown || p.teardown.call(e, f, g.handle) === !1) && v.removeEvent(e, u, g.handle), delete h[u])
        }
        v.isEmptyObject(h) && (delete g.handle, v.removeData(e, "events", !0))
      },
      customEvent: {
        getData: !0,
        setData: !0,
        changeData: !0
      },
      trigger: function(n, r, s, o) {
        if (!s || s.nodeType !== 3 && s.nodeType !== 8) {
          var u, a, f, l, c, h, p, d, m, g, y = n.type || n,
            b = [];
          if (Y.test(y + v.event.triggered)) return;
          y.indexOf("!") >= 0 && (y = y.slice(0, -1), a = !0), y.indexOf(".") >= 0 && (b = y.split("."), y = b.shift(), b.sort());
          if ((!s || v.event.customEvent[y]) && !v.event.global[y]) return;
          n = typeof n == "object" ? n[v.expando] ? n : new v.Event(y, n) : new v.Event(y), n.type = y, n.isTrigger = !0, n.exclusive = a, n.namespace = b.join("."), n.namespace_re = n.namespace ? new RegExp("(^|\\.)" + b.join("\\.(?:.*\\.|)") + "(\\.|$)") : null, h = y.indexOf(":") < 0 ? "on" + y : "";
          if (!s) {
            u = v.cache;
            for (f in u) u[f].events && u[f].events[y] && v.event.trigger(n, r, u[f].handle.elem, !0);
            return
          }
          n.result = t, n.target || (n.target = s), r = r != null ? v.makeArray(r) : [], r.unshift(n), p = v.event.special[y] || {};
          if (p.trigger && p.trigger.apply(s, r) === !1) return;
          m = [
            [s, p.bindType || y]
          ];
          if (!o && !p.noBubble && !v.isWindow(s)) {
            g = p.delegateType || y, l = Y.test(g + y) ? s : s.parentNode;
            for (c = s; l; l = l.parentNode) m.push([l, g]), c = l;
            c === (s.ownerDocument || i) && m.push([c.defaultView || c.parentWindow || e, g])
          }
          for (f = 0; f < m.length && !n.isPropagationStopped(); f++) l = m[f][0], n.type = m[f][1], d = (v._data(l, "events") || {})[n.type] && v._data(l, "handle"), d && d.apply(l, r), d = h && l[h], d && v.acceptData(l) && d.apply && d.apply(l, r) === !1 && n.preventDefault();
          return n.type = y, !o && !n.isDefaultPrevented() && (!p._default || p._default.apply(s.ownerDocument, r) === !1) && (y !== "click" || !v.nodeName(s, "a")) && v.acceptData(s) && h && s[y] && (y !== "focus" && y !== "blur" || n.target.offsetWidth !== 0) && !v.isWindow(s) && (c = s[h], c && (s[h] = null), v.event.triggered = y, s[y](), v.event.triggered = t, c && (s[h] = c)), n.result
        }
        return
      },
      dispatch: function(n) {
        n = v.event.fix(n || e.event);
        var r, i, s, o, u, a, f, c, h, p, d = (v._data(this, "events") || {})[n.type] || [],
          m = d.delegateCount,
          g = l.call(arguments),
          y = !n.exclusive && !n.namespace,
          b = v.event.special[n.type] || {},
          w = [];
        g[0] = n, n.delegateTarget = this;
        if (b.preDispatch && b.preDispatch.call(this, n) === !1) return;
        if (m && (!n.button || n.type !== "click"))
          for (s = n.target; s != this; s = s.parentNode || this)
            if (s.disabled !== !0 || n.type !== "click") {
              u = {}, f = [];
              for (r = 0; r < m; r++) c = d[r], h = c.selector, u[h] === t && (u[h] = c.needsContext ? v(h, this).index(s) >= 0 : v.find(h, this, null, [s]).length), u[h] && f.push(c);
              f.length && w.push({
                elem: s,
                matches: f
              })
            } d.length > m && w.push({
          elem: this,
          matches: d.slice(m)
        });
        for (r = 0; r < w.length && !n.isPropagationStopped(); r++) {
          a = w[r], n.currentTarget = a.elem;
          for (i = 0; i < a.matches.length && !n.isImmediatePropagationStopped(); i++) {
            c = a.matches[i];
            if (y || !n.namespace && !c.namespace || n.namespace_re && n.namespace_re.test(c.namespace)) n.data = c.data, n.handleObj = c, o = ((v.event.special[c.origType] || {}).handle || c.handler).apply(a.elem, g), o !== t && (n.result = o, o === !1 && (n.preventDefault(), n.stopPropagation()))
          }
        }
        return b.postDispatch && b.postDispatch.call(this, n), n.result
      },
      props: "attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),
      fixHooks: {},
      keyHooks: {
        props: "char charCode key keyCode".split(" "),
        filter: function(e, t) {
          return e.which == null && (e.which = t.charCode != null ? t.charCode : t.keyCode), e
        }
      },
      mouseHooks: {
        props: "button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),
        filter: function(e, n) {
          var r, s, o, u = n.button,
            a = n.fromElement;
          return e.pageX == null && n.clientX != null && (r = e.target.ownerDocument || i, s = r.documentElement, o = r.body, e.pageX = n.clientX + (s && s.scrollLeft || o && o.scrollLeft || 0) - (s && s.clientLeft || o && o.clientLeft || 0), e.pageY = n.clientY + (s && s.scrollTop || o && o.scrollTop || 0) - (s && s.clientTop || o && o.clientTop || 0)), !e.relatedTarget && a && (e.relatedTarget = a === e.target ? n.toElement : a), !e.which && u !== t && (e.which = u & 1 ? 1 : u & 2 ? 3 : u & 4 ? 2 : 0), e
        }
      },
      fix: function(e) {
        if (e[v.expando]) return e;
        var t, n, r = e,
          s = v.event.fixHooks[e.type] || {},
          o = s.props ? this.props.concat(s.props) : this.props;
        e = v.Event(r);
        for (t = o.length; t;) n = o[--t], e[n] = r[n];
        return e.target || (e.target = r.srcElement || i), e.target.nodeType === 3 && (e.target = e.target.parentNode), e.metaKey = !!e.metaKey, s.filter ? s.filter(e, r) : e
      },
      special: {
        load: {
          noBubble: !0
        },
        focus: {
          delegateType: "focusin"
        },
        blur: {
          delegateType: "focusout"
        },
        beforeunload: {
          setup: function(e, t, n) {
            v.isWindow(this) && (this.onbeforeunload = n)
          },
          teardown: function(e, t) {
            this.onbeforeunload === t && (this.onbeforeunload = null)
          }
        }
      },
      simulate: function(e, t, n, r) {
        var i = v.extend(new v.Event, n, {
          type: e,
          isSimulated: !0,
          originalEvent: {}
        });
        r ? v.event.trigger(i, null, t) : v.event.dispatch.call(t, i), i.isDefaultPrevented() && n.preventDefault()
      }
    }, v.event.handle = v.event.dispatch, v.removeEvent = i.removeEventListener ? function(e, t, n) {
      e.removeEventListener && e.removeEventListener(t, n, !1)
    } : function(e, t, n) {
      var r = "on" + t;
      e.detachEvent && (typeof e[r] == "undefined" && (e[r] = null), e.detachEvent(r, n))
    }, v.Event = function(e, t) {
      if (!(this instanceof v.Event)) return new v.Event(e, t);
      e && e.type ? (this.originalEvent = e, this.type = e.type, this.isDefaultPrevented = e.defaultPrevented || e.returnValue === !1 || e.getPreventDefault && e.getPreventDefault() ? tt : et) : this.type = e, t && v.extend(this, t), this.timeStamp = e && e.timeStamp || v.now(), this[v.expando] = !0
    }, v.Event.prototype = {
      preventDefault: function() {
        this.isDefaultPrevented = tt;
        var e = this.originalEvent;
        if (!e) return;
        e.preventDefault ? e.preventDefault() : e.returnValue = !1
      },
      stopPropagation: function() {
        this.isPropagationStopped = tt;
        var e = this.originalEvent;
        if (!e) return;
        e.stopPropagation && e.stopPropagation(), e.cancelBubble = !0
      },
      stopImmediatePropagation: function() {
        this.isImmediatePropagationStopped = tt, this.stopPropagation()
      },
      isDefaultPrevented: et,
      isPropagationStopped: et,
      isImmediatePropagationStopped: et
    }, v.each({
      mouseenter: "mouseover",
      mouseleave: "mouseout"
    }, function(e, t) {
      v.event.special[e] = {
        delegateType: t,
        bindType: t,
        handle: function(e) {
          var n, r = this,
            i = e.relatedTarget,
            s = e.handleObj,
            o = s.selector;
          if (!i || i !== r && !v.contains(r, i)) e.type = s.origType, n = s.handler.apply(this, arguments), e.type = t;
          return n
        }
      }
    }), v.support.submitBubbles || (v.event.special.submit = {
      setup: function() {
        if (v.nodeName(this, "form")) return !1;
        v.event.add(this, "click._submit keypress._submit", function(e) {
          var n = e.target,
            r = v.nodeName(n, "input") || v.nodeName(n, "button") ? n.form : t;
          r && !v._data(r, "_submit_attached") && (v.event.add(r, "submit._submit", function(e) {
            e._submit_bubble = !0
          }), v._data(r, "_submit_attached", !0))
        })
      },
      postDispatch: function(e) {
        e._submit_bubble && (delete e._submit_bubble, this.parentNode && !e.isTrigger && v.event.simulate("submit", this.parentNode, e, !0))
      },
      teardown: function() {
        if (v.nodeName(this, "form")) return !1;
        v.event.remove(this, "._submit")
      }
    }), v.support.changeBubbles || (v.event.special.change = {
      setup: function() {
        if ($.test(this.nodeName)) {
          if (this.type === "checkbox" || this.type === "radio") v.event.add(this, "propertychange._change", function(e) {
            e.originalEvent.propertyName === "checked" && (this._just_changed = !0)
          }), v.event.add(this, "click._change", function(e) {
            this._just_changed && !e.isTrigger && (this._just_changed = !1), v.event.simulate("change", this, e, !0)
          });
          return !1
        }
        v.event.add(this, "beforeactivate._change", function(e) {
          var t = e.target;
          $.test(t.nodeName) && !v._data(t, "_change_attached") && (v.event.add(t, "change._change", function(e) {
            this.parentNode && !e.isSimulated && !e.isTrigger && v.event.simulate("change", this.parentNode, e, !0)
          }), v._data(t, "_change_attached", !0))
        })
      },
      handle: function(e) {
        var t = e.target;
        if (this !== t || e.isSimulated || e.isTrigger || t.type !== "radio" && t.type !== "checkbox") return e.handleObj.handler.apply(this, arguments)
      },
      teardown: function() {
        return v.event.remove(this, "._change"), !$.test(this.nodeName)
      }
    }), v.support.focusinBubbles || v.each({
      focus: "focusin",
      blur: "focusout"
    }, function(e, t) {
      var n = 0,
        r = function(e) {
          v.event.simulate(t, e.target, v.event.fix(e), !0)
        };
      v.event.special[t] = {
        setup: function() {
          n++ === 0 && i.addEventListener(e, r, !0)
        },
        teardown: function() {
          --n === 0 && i.removeEventListener(e, r, !0)
        }
      }
    }), v.fn.extend({
      on: function(e, n, r, i, s) {
        var o, u;
        if (typeof e == "object") {
          typeof n != "string" && (r = r || n, n = t);
          for (u in e) this.on(u, n, r, e[u], s);
          return this
        }
        r == null && i == null ? (i = n, r = n = t) : i == null && (typeof n == "string" ? (i = r, r = t) : (i = r, r = n, n = t));
        if (i === !1) i = et;
        else if (!i) return this;
        return s === 1 && (o = i, i = function(e) {
          return v().off(e), o.apply(this, arguments)
        }, i.guid = o.guid || (o.guid = v.guid++)), this.each(function() {
          v.event.add(this, e, i, r, n)
        })
      },
      one: function(e, t, n, r) {
        return this.on(e, t, n, r, 1)
      },
      off: function(e, n, r) {
        var i, s;
        if (e && e.preventDefault && e.handleObj) return i = e.handleObj, v(e.delegateTarget).off(i.namespace ? i.origType + "." + i.namespace : i.origType, i.selector, i.handler), this;
        if (typeof e == "object") {
          for (s in e) this.off(s, n, e[s]);
          return this
        }
        if (n === !1 || typeof n == "function") r = n, n = t;
        return r === !1 && (r = et), this.each(function() {
          v.event.remove(this, e, r, n)
        })
      },
      bind: function(e, t, n) {
        return this.on(e, null, t, n)
      },
      unbind: function(e, t) {
        return this.off(e, null, t)
      },
      live: function(e, t, n) {
        return v(this.context).on(e, this.selector, t, n), this
      },
      die: function(e, t) {
        return v(this.context).off(e, this.selector || "**", t), this
      },
      delegate: function(e, t, n, r) {
        return this.on(t, e, n, r)
      },
      undelegate: function(e, t, n) {
        return arguments.length === 1 ? this.off(e, "**") : this.off(t, e || "**", n)
      },
      trigger: function(e, t) {
        return this.each(function() {
          v.event.trigger(e, t, this)
        })
      },
      triggerHandler: function(e, t) {
        if (this[0]) return v.event.trigger(e, t, this[0], !0)
      },
      toggle: function(e) {
        var t = arguments,
          n = e.guid || v.guid++,
          r = 0,
          i = function(n) {
            var i = (v._data(this, "lastToggle" + e.guid) || 0) % r;
            return v._data(this, "lastToggle" + e.guid, i + 1), n.preventDefault(), t[i].apply(this, arguments) || !1
          };
        i.guid = n;
        while (r < t.length) t[r++].guid = n;
        return this.click(i)
      },
      hover: function(e, t) {
        return this.mouseenter(e).mouseleave(t || e)
      }
    }), v.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "), function(e, t) {
      v.fn[t] = function(e, n) {
        return n == null && (n = e, e = null), arguments.length > 0 ? this.on(t, null, e, n) : this.trigger(t)
      }, Q.test(t) && (v.event.fixHooks[t] = v.event.keyHooks), G.test(t) && (v.event.fixHooks[t] = v.event.mouseHooks)
    }),
    function(e, t) {
      function nt(e, t, n, r) {
        n = n || [], t = t || g;
        var i, s, a, f, l = t.nodeType;
        if (!e || typeof e != "string") return n;
        if (l !== 1 && l !== 9) return [];
        a = o(t);
        if (!a && !r)
          if (i = R.exec(e))
            if (f = i[1]) {
              if (l === 9) {
                s = t.getElementById(f);
                if (!s || !s.parentNode) return n;
                if (s.id === f) return n.push(s), n
              } else if (t.ownerDocument && (s = t.ownerDocument.getElementById(f)) && u(t, s) && s.id === f) return n.push(s), n
            } else {
              if (i[2]) return S.apply(n, x.call(t.getElementsByTagName(e), 0)), n;
              if ((f = i[3]) && Z && t.getElementsByClassName) return S.apply(n, x.call(t.getElementsByClassName(f), 0)), n
            } return vt(e.replace(j, "$1"), t, n, r, a)
      }

      function rt(e) {
        return function(t) {
          var n = t.nodeName.toLowerCase();
          return n === "input" && t.type === e
        }
      }

      function it(e) {
        return function(t) {
          var n = t.nodeName.toLowerCase();
          return (n === "input" || n === "button") && t.type === e
        }
      }

      function st(e) {
        return N(function(t) {
          return t = +t, N(function(n, r) {
            var i, s = e([], n.length, t),
              o = s.length;
            while (o--) n[i = s[o]] && (n[i] = !(r[i] = n[i]))
          })
        })
      }

      function ot(e, t, n) {
        if (e === t) return n;
        var r = e.nextSibling;
        while (r) {
          if (r === t) return -1;
          r = r.nextSibling
        }
        return 1
      }

      function ut(e, t) {
        var n, r, s, o, u, a, f, l = L[d][e + " "];
        if (l) return t ? 0 : l.slice(0);
        u = e, a = [], f = i.preFilter;
        while (u) {
          if (!n || (r = F.exec(u))) r && (u = u.slice(r[0].length) || u), a.push(s = []);
          n = !1;
          if (r = I.exec(u)) s.push(n = new m(r.shift())), u = u.slice(n.length), n.type = r[0].replace(j, " ");
          for (o in i.filter)(r = J[o].exec(u)) && (!f[o] || (r = f[o](r))) && (s.push(n = new m(r.shift())), u = u.slice(n.length), n.type = o, n.matches = r);
          if (!n) break
        }
        return t ? u.length : u ? nt.error(e) : L(e, a).slice(0)
      }

      function at(e, t, r) {
        var i = t.dir,
          s = r && t.dir === "parentNode",
          o = w++;
        return t.first ? function(t, n, r) {
          while (t = t[i])
            if (s || t.nodeType === 1) return e(t, n, r)
        } : function(t, r, u) {
          if (!u) {
            var a, f = b + " " + o + " ",
              l = f + n;
            while (t = t[i])
              if (s || t.nodeType === 1) {
                if ((a = t[d]) === l) return t.sizset;
                if (typeof a == "string" && a.indexOf(f) === 0) {
                  if (t.sizset) return t
                } else {
                  t[d] = l;
                  if (e(t, r, u)) return t.sizset = !0, t;
                  t.sizset = !1
                }
              }
          } else
            while (t = t[i])
              if (s || t.nodeType === 1)
                if (e(t, r, u)) return t
        }
      }

      function ft(e) {
        return e.length > 1 ? function(t, n, r) {
          var i = e.length;
          while (i--)
            if (!e[i](t, n, r)) return !1;
          return !0
        } : e[0]
      }

      function lt(e, t, n, r, i) {
        var s, o = [],
          u = 0,
          a = e.length,
          f = t != null;
        for (; u < a; u++)
          if (s = e[u])
            if (!n || n(s, r, i)) o.push(s), f && t.push(u);
        return o
      }

      function ct(e, t, n, r, i, s) {
        return r && !r[d] && (r = ct(r)), i && !i[d] && (i = ct(i, s)), N(function(s, o, u, a) {
          var f, l, c, h = [],
            p = [],
            d = o.length,
            v = s || dt(t || "*", u.nodeType ? [u] : u, []),
            m = e && (s || !t) ? lt(v, h, e, u, a) : v,
            g = n ? i || (s ? e : d || r) ? [] : o : m;
          n && n(m, g, u, a);
          if (r) {
            f = lt(g, p), r(f, [], u, a), l = f.length;
            while (l--)
              if (c = f[l]) g[p[l]] = !(m[p[l]] = c)
          }
          if (s) {
            if (i || e) {
              if (i) {
                f = [], l = g.length;
                while (l--)(c = g[l]) && f.push(m[l] = c);
                i(null, g = [], f, a)
              }
              l = g.length;
              while (l--)(c = g[l]) && (f = i ? T.call(s, c) : h[l]) > -1 && (s[f] = !(o[f] = c))
            }
          } else g = lt(g === o ? g.splice(d, g.length) : g), i ? i(null, o, g, a) : S.apply(o, g)
        })
      }

      function ht(e) {
        var t, n, r, s = e.length,
          o = i.relative[e[0].type],
          u = o || i.relative[" "],
          a = o ? 1 : 0,
          f = at(function(e) {
            return e === t
          }, u, !0),
          l = at(function(e) {
            return T.call(t, e) > -1
          }, u, !0),
          h = [function(e, n, r) {
            return !o && (r || n !== c) || ((t = n).nodeType ? f(e, n, r) : l(e, n, r))
          }];
        for (; a < s; a++)
          if (n = i.relative[e[a].type]) h = [at(ft(h), n)];
          else {
            n = i.filter[e[a].type].apply(null, e[a].matches);
            if (n[d]) {
              r = ++a;
              for (; r < s; r++)
                if (i.relative[e[r].type]) break;
              return ct(a > 1 && ft(h), a > 1 && e.slice(0, a - 1).join("").replace(j, "$1"), n, a < r && ht(e.slice(a, r)), r < s && ht(e = e.slice(r)), r < s && e.join(""))
            }
            h.push(n)
          } return ft(h)
      }

      function pt(e, t) {
        var r = t.length > 0,
          s = e.length > 0,
          o = function(u, a, f, l, h) {
            var p, d, v, m = [],
              y = 0,
              w = "0",
              x = u && [],
              T = h != null,
              N = c,
              C = u || s && i.find.TAG("*", h && a.parentNode || a),
              k = b += N == null ? 1 : Math.E;
            T && (c = a !== g && a, n = o.el);
            for (;
              (p = C[w]) != null; w++) {
              if (s && p) {
                for (d = 0; v = e[d]; d++)
                  if (v(p, a, f)) {
                    l.push(p);
                    break
                  } T && (b = k, n = ++o.el)
              }
              r && ((p = !v && p) && y--, u && x.push(p))
            }
            y += w;
            if (r && w !== y) {
              for (d = 0; v = t[d]; d++) v(x, m, a, f);
              if (u) {
                if (y > 0)
                  while (w--) !x[w] && !m[w] && (m[w] = E.call(l));
                m = lt(m)
              }
              S.apply(l, m), T && !u && m.length > 0 && y + t.length > 1 && nt.uniqueSort(l)
            }
            return T && (b = k, c = N), x
          };
        return o.el = 0, r ? N(o) : o
      }

      function dt(e, t, n) {
        var r = 0,
          i = t.length;
        for (; r < i; r++) nt(e, t[r], n);
        return n
      }

      function vt(e, t, n, r, s) {
        var o, u, f, l, c, h = ut(e),
          p = h.length;
        if (!r && h.length === 1) {
          u = h[0] = h[0].slice(0);
          if (u.length > 2 && (f = u[0]).type === "ID" && t.nodeType === 9 && !s && i.relative[u[1].type]) {
            t = i.find.ID(f.matches[0].replace($, ""), t, s)[0];
            if (!t) return n;
            e = e.slice(u.shift().length)
          }
          for (o = J.POS.test(e) ? -1 : u.length - 1; o >= 0; o--) {
            f = u[o];
            if (i.relative[l = f.type]) break;
            if (c = i.find[l])
              if (r = c(f.matches[0].replace($, ""), z.test(u[0].type) && t.parentNode || t, s)) {
                u.splice(o, 1), e = r.length && u.join("");
                if (!e) return S.apply(n, x.call(r, 0)), n;
                break
              }
          }
        }
        return a(e, h)(r, t, s, n, z.test(e)), n
      }

      function mt() {}
      var n, r, i, s, o, u, a, f, l, c, h = !0,
        p = "undefined",
        d = ("sizcache" + Math.random()).replace(".", ""),
        m = String,
        g = e.document,
        y = g.documentElement,
        b = 0,
        w = 0,
        E = [].pop,
        S = [].push,
        x = [].slice,
        T = [].indexOf || function(e) {
          var t = 0,
            n = this.length;
          for (; t < n; t++)
            if (this[t] === e) return t;
          return -1
        },
        N = function(e, t) {
          return e[d] = t == null || t, e
        },
        C = function() {
          var e = {},
            t = [];
          return N(function(n, r) {
            return t.push(n) > i.cacheLength && delete e[t.shift()], e[n + " "] = r
          }, e)
        },
        k = C(),
        L = C(),
        A = C(),
        O = "[\\x20\\t\\r\\n\\f]",
        M = "(?:\\\\.|[-\\w]|[^\\x00-\\xa0])+",
        _ = M.replace("w", "w#"),
        D = "([*^$|!~]?=)",
        P = "\\[" + O + "*(" + M + ")" + O + "*(?:" + D + O + "*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|(" + _ + ")|)|)" + O + "*\\]",
        H = ":(" + M + ")(?:\\((?:(['\"])((?:\\\\.|[^\\\\])*?)\\2|([^()[\\]]*|(?:(?:" + P + ")|[^:]|\\\\.)*|.*))\\)|)",
        B = ":(even|odd|eq|gt|lt|nth|first|last)(?:\\(" + O + "*((?:-\\d)?\\d*)" + O + "*\\)|)(?=[^-]|$)",
        j = new RegExp("^" + O + "+|((?:^|[^\\\\])(?:\\\\.)*)" + O + "+$", "g"),
        F = new RegExp("^" + O + "*," + O + "*"),
        I = new RegExp("^" + O + "*([\\x20\\t\\r\\n\\f>+~])" + O + "*"),
        q = new RegExp(H),
        R = /^(?:#([\w\-]+)|(\w+)|\.([\w\-]+))$/,
        U = /^:not/,
        z = /[\x20\t\r\n\f]*[+~]/,
        W = /:not\($/,
        X = /h\d/i,
        V = /input|select|textarea|button/i,
        $ = /\\(?!\\)/g,
        J = {
          ID: new RegExp("^#(" + M + ")"),
          CLASS: new RegExp("^\\.(" + M + ")"),
          NAME: new RegExp("^\\[name=['\"]?(" + M + ")['\"]?\\]"),
          TAG: new RegExp("^(" + M.replace("w", "w*") + ")"),
          ATTR: new RegExp("^" + P),
          PSEUDO: new RegExp("^" + H),
          POS: new RegExp(B, "i"),
          CHILD: new RegExp("^:(only|nth|first|last)-child(?:\\(" + O + "*(even|odd|(([+-]|)(\\d*)n|)" + O + "*(?:([+-]|)" + O + "*(\\d+)|))" + O + "*\\)|)", "i"),
          needsContext: new RegExp("^" + O + "*[>+~]|" + B, "i")
        },
        K = function(e) {
          var t = g.createElement("div");
          try {
            return e(t)
          } catch (n) {
            return !1
          } finally {
            t = null
          }
        },
        Q = K(function(e) {
          return e.appendChild(g.createComment("")), !e.getElementsByTagName("*").length
        }),
        G = K(function(e) {
          return e.innerHTML = "<a href='#'></a>", e.firstChild && typeof e.firstChild.getAttribute !== p && e.firstChild.getAttribute("href") === "#"
        }),
        Y = K(function(e) {
          e.innerHTML = "<select></select>";
          var t = typeof e.lastChild.getAttribute("multiple");
          return t !== "boolean" && t !== "string"
        }),
        Z = K(function(e) {
          return e.innerHTML = "<div class='hidden e'></div><div class='hidden'></div>", !e.getElementsByClassName || !e.getElementsByClassName("e").length ? !1 : (e.lastChild.className = "e", e.getElementsByClassName("e").length === 2)
        }),
        et = K(function(e) {
          e.id = d + 0, e.innerHTML = "<a name='" + d + "'></a><div name='" + d + "'></div>", y.insertBefore(e, y.firstChild);
          var t = g.getElementsByName && g.getElementsByName(d).length === 2 + g.getElementsByName(d + 0).length;
          return r = !g.getElementById(d), y.removeChild(e), t
        });
      try {
        x.call(y.childNodes, 0)[0].nodeType
      } catch (tt) {
        x = function(e) {
          var t, n = [];
          for (; t = this[e]; e++) n.push(t);
          return n
        }
      }
      nt.matches = function(e, t) {
        return nt(e, null, null, t)
      }, nt.matchesSelector = function(e, t) {
        return nt(t, null, null, [e]).length > 0
      }, s = nt.getText = function(e) {
        var t, n = "",
          r = 0,
          i = e.nodeType;
        if (i) {
          if (i === 1 || i === 9 || i === 11) {
            if (typeof e.textContent == "string") return e.textContent;
            for (e = e.firstChild; e; e = e.nextSibling) n += s(e)
          } else if (i === 3 || i === 4) return e.nodeValue
        } else
          for (; t = e[r]; r++) n += s(t);
        return n
      }, o = nt.isXML = function(e) {
        var t = e && (e.ownerDocument || e).documentElement;
        return t ? t.nodeName !== "HTML" : !1
      }, u = nt.contains = y.contains ? function(e, t) {
        var n = e.nodeType === 9 ? e.documentElement : e,
          r = t && t.parentNode;
        return e === r || !!(r && r.nodeType === 1 && n.contains && n.contains(r))
      } : y.compareDocumentPosition ? function(e, t) {
        return t && !!(e.compareDocumentPosition(t) & 16)
      } : function(e, t) {
        while (t = t.parentNode)
          if (t === e) return !0;
        return !1
      }, nt.attr = function(e, t) {
        var n, r = o(e);
        return r || (t = t.toLowerCase()), (n = i.attrHandle[t]) ? n(e) : r || Y ? e.getAttribute(t) : (n = e.getAttributeNode(t), n ? typeof e[t] == "boolean" ? e[t] ? t : null : n.specified ? n.value : null : null)
      }, i = nt.selectors = {
        cacheLength: 50,
        createPseudo: N,
        match: J,
        attrHandle: G ? {} : {
          href: function(e) {
            return e.getAttribute("href", 2)
          },
          type: function(e) {
            return e.getAttribute("type")
          }
        },
        find: {
          ID: r ? function(e, t, n) {
            if (typeof t.getElementById !== p && !n) {
              var r = t.getElementById(e);
              return r && r.parentNode ? [r] : []
            }
          } : function(e, n, r) {
            if (typeof n.getElementById !== p && !r) {
              var i = n.getElementById(e);
              return i ? i.id === e || typeof i.getAttributeNode !== p && i.getAttributeNode("id").value === e ? [i] : t : []
            }
          },
          TAG: Q ? function(e, t) {
            if (typeof t.getElementsByTagName !== p) return t.getElementsByTagName(e)
          } : function(e, t) {
            var n = t.getElementsByTagName(e);
            if (e === "*") {
              var r, i = [],
                s = 0;
              for (; r = n[s]; s++) r.nodeType === 1 && i.push(r);
              return i
            }
            return n
          },
          NAME: et && function(e, t) {
            if (typeof t.getElementsByName !== p) return t.getElementsByName(name)
          },
          CLASS: Z && function(e, t, n) {
            if (typeof t.getElementsByClassName !== p && !n) return t.getElementsByClassName(e)
          }
        },
        relative: {
          ">": {
            dir: "parentNode",
            first: !0
          },
          " ": {
            dir: "parentNode"
          },
          "+": {
            dir: "previousSibling",
            first: !0
          },
          "~": {
            dir: "previousSibling"
          }
        },
        preFilter: {
          ATTR: function(e) {
            return e[1] = e[1].replace($, ""), e[3] = (e[4] || e[5] || "").replace($, ""), e[2] === "~=" && (e[3] = " " + e[3] + " "), e.slice(0, 4)
          },
          CHILD: function(e) {
            return e[1] = e[1].toLowerCase(), e[1] === "nth" ? (e[2] || nt.error(e[0]), e[3] = +(e[3] ? e[4] + (e[5] || 1) : 2 * (e[2] === "even" || e[2] === "odd")), e[4] = +(e[6] + e[7] || e[2] === "odd")) : e[2] && nt.error(e[0]), e
          },
          PSEUDO: function(e) {
            var t, n;
            if (J.CHILD.test(e[0])) return null;
            if (e[3]) e[2] = e[3];
            else if (t = e[4]) q.test(t) && (n = ut(t, !0)) && (n = t.indexOf(")", t.length - n) - t.length) && (t = t.slice(0, n), e[0] = e[0].slice(0, n)), e[2] = t;
            return e.slice(0, 3)
          }
        },
        filter: {
          ID: r ? function(e) {
            return e = e.replace($, ""),
              function(t) {
                return t.getAttribute("id") === e
              }
          } : function(e) {
            return e = e.replace($, ""),
              function(t) {
                var n = typeof t.getAttributeNode !== p && t.getAttributeNode("id");
                return n && n.value === e
              }
          },
          TAG: function(e) {
            return e === "*" ? function() {
              return !0
            } : (e = e.replace($, "").toLowerCase(), function(t) {
              return t.nodeName && t.nodeName.toLowerCase() === e
            })
          },
          CLASS: function(e) {
            var t = k[d][e + " "];
            return t || (t = new RegExp("(^|" + O + ")" + e + "(" + O + "|$)")) && k(e, function(e) {
              return t.test(e.className || typeof e.getAttribute !== p && e.getAttribute("class") || "")
            })
          },
          ATTR: function(e, t, n) {
            return function(r, i) {
              var s = nt.attr(r, e);
              return s == null ? t === "!=" : t ? (s += "", t === "=" ? s === n : t === "!=" ? s !== n : t === "^=" ? n && s.indexOf(n) === 0 : t === "*=" ? n && s.indexOf(n) > -1 : t === "$=" ? n && s.substr(s.length - n.length) === n : t === "~=" ? (" " + s + " ").indexOf(n) > -1 : t === "|=" ? s === n || s.substr(0, n.length + 1) === n + "-" : !1) : !0
            }
          },
          CHILD: function(e, t, n, r) {
            return e === "nth" ? function(e) {
              var t, i, s = e.parentNode;
              if (n === 1 && r === 0) return !0;
              if (s) {
                i = 0;
                for (t = s.firstChild; t; t = t.nextSibling)
                  if (t.nodeType === 1) {
                    i++;
                    if (e === t) break
                  }
              }
              return i -= r, i === n || i % n === 0 && i / n >= 0
            } : function(t) {
              var n = t;
              switch (e) {
                case "only":
                case "first":
                  while (n = n.previousSibling)
                    if (n.nodeType === 1) return !1;
                  if (e === "first") return !0;
                  n = t;
                case "last":
                  while (n = n.nextSibling)
                    if (n.nodeType === 1) return !1;
                  return !0
              }
            }
          },
          PSEUDO: function(e, t) {
            var n, r = i.pseudos[e] || i.setFilters[e.toLowerCase()] || nt.error("unsupported pseudo: " + e);
            return r[d] ? r(t) : r.length > 1 ? (n = [e, e, "", t], i.setFilters.hasOwnProperty(e.toLowerCase()) ? N(function(e, n) {
              var i, s = r(e, t),
                o = s.length;
              while (o--) i = T.call(e, s[o]), e[i] = !(n[i] = s[o])
            }) : function(e) {
              return r(e, 0, n)
            }) : r
          }
        },
        pseudos: {
          not: N(function(e) {
            var t = [],
              n = [],
              r = a(e.replace(j, "$1"));
            return r[d] ? N(function(e, t, n, i) {
              var s, o = r(e, null, i, []),
                u = e.length;
              while (u--)
                if (s = o[u]) e[u] = !(t[u] = s)
            }) : function(e, i, s) {
              return t[0] = e, r(t, null, s, n), !n.pop()
            }
          }),
          has: N(function(e) {
            return function(t) {
              return nt(e, t).length > 0
            }
          }),
          contains: N(function(e) {
            return function(t) {
              return (t.textContent || t.innerText || s(t)).indexOf(e) > -1
            }
          }),
          enabled: function(e) {
            return e.disabled === !1
          },
          disabled: function(e) {
            return e.disabled === !0
          },
          checked: function(e) {
            var t = e.nodeName.toLowerCase();
            return t === "input" && !!e.checked || t === "option" && !!e.selected
          },
          selected: function(e) {
            return e.parentNode && e.parentNode.selectedIndex, e.selected === !0
          },
          parent: function(e) {
            return !i.pseudos.empty(e)
          },
          empty: function(e) {
            var t;
            e = e.firstChild;
            while (e) {
              if (e.nodeName > "@" || (t = e.nodeType) === 3 || t === 4) return !1;
              e = e.nextSibling
            }
            return !0
          },
          header: function(e) {
            return X.test(e.nodeName)
          },
          text: function(e) {
            var t, n;
            return e.nodeName.toLowerCase() === "input" && (t = e.type) === "text" && ((n = e.getAttribute("type")) == null || n.toLowerCase() === t)
          },
          radio: rt("radio"),
          checkbox: rt("checkbox"),
          file: rt("file"),
          password: rt("password"),
          image: rt("image"),
          submit: it("submit"),
          reset: it("reset"),
          button: function(e) {
            var t = e.nodeName.toLowerCase();
            return t === "input" && e.type === "button" || t === "button"
          },
          input: function(e) {
            return V.test(e.nodeName)
          },
          focus: function(e) {
            var t = e.ownerDocument;
            return e === t.activeElement && (!t.hasFocus || t.hasFocus()) && !!(e.type || e.href || ~e.tabIndex)
          },
          active: function(e) {
            return e === e.ownerDocument.activeElement
          },
          first: st(function() {
            return [0]
          }),
          last: st(function(e, t) {
            return [t - 1]
          }),
          eq: st(function(e, t, n) {
            return [n < 0 ? n + t : n]
          }),
          even: st(function(e, t) {
            for (var n = 0; n < t; n += 2) e.push(n);
            return e
          }),
          odd: st(function(e, t) {
            for (var n = 1; n < t; n += 2) e.push(n);
            return e
          }),
          lt: st(function(e, t, n) {
            for (var r = n < 0 ? n + t : n; --r >= 0;) e.push(r);
            return e
          }),
          gt: st(function(e, t, n) {
            for (var r = n < 0 ? n + t : n; ++r < t;) e.push(r);
            return e
          })
        }
      }, f = y.compareDocumentPosition ? function(e, t) {
        return e === t ? (l = !0, 0) : (!e.compareDocumentPosition || !t.compareDocumentPosition ? e.compareDocumentPosition : e.compareDocumentPosition(t) & 4) ? -1 : 1
      } : function(e, t) {
        if (e === t) return l = !0, 0;
        if (e.sourceIndex && t.sourceIndex) return e.sourceIndex - t.sourceIndex;
        var n, r, i = [],
          s = [],
          o = e.parentNode,
          u = t.parentNode,
          a = o;
        if (o === u) return ot(e, t);
        if (!o) return -1;
        if (!u) return 1;
        while (a) i.unshift(a), a = a.parentNode;
        a = u;
        while (a) s.unshift(a), a = a.parentNode;
        n = i.length, r = s.length;
        for (var f = 0; f < n && f < r; f++)
          if (i[f] !== s[f]) return ot(i[f], s[f]);
        return f === n ? ot(e, s[f], -1) : ot(i[f], t, 1)
      }, [0, 0].sort(f), h = !l, nt.uniqueSort = function(e) {
        var t, n = [],
          r = 1,
          i = 0;
        l = h, e.sort(f);
        if (l) {
          for (; t = e[r]; r++) t === e[r - 1] && (i = n.push(r));
          while (i--) e.splice(n[i], 1)
        }
        return e
      }, nt.error = function(e) {
        throw new Error("Syntax error, unrecognized expression: " + e)
      }, a = nt.compile = function(e, t) {
        var n, r = [],
          i = [],
          s = A[d][e + " "];
        if (!s) {
          t || (t = ut(e)), n = t.length;
          while (n--) s = ht(t[n]), s[d] ? r.push(s) : i.push(s);
          s = A(e, pt(i, r))
        }
        return s
      }, g.querySelectorAll && function() {
        var e, t = vt,
          n = /'|\\/g,
          r = /\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g,
          i = [":focus"],
          s = [":active"],
          u = y.matchesSelector || y.mozMatchesSelector || y.webkitMatchesSelector || y.oMatchesSelector || y.msMatchesSelector;
        K(function(e) {
          e.innerHTML = "<select><option selected=''></option></select>", e.querySelectorAll("[selected]").length || i.push("\\[" + O + "*(?:checked|disabled|ismap|multiple|readonly|selected|value)"), e.querySelectorAll(":checked").length || i.push(":checked")
        }), K(function(e) {
          e.innerHTML = "<p test=''></p>", e.querySelectorAll("[test^='']").length && i.push("[*^$]=" + O + "*(?:\"\"|'')"), e.innerHTML = "<input type='hidden'/>", e.querySelectorAll(":enabled").length || i.push(":enabled", ":disabled")
        }), i = new RegExp(i.join("|")), vt = function(e, r, s, o, u) {
          if (!o && !u && !i.test(e)) {
            var a, f, l = !0,
              c = d,
              h = r,
              p = r.nodeType === 9 && e;
            if (r.nodeType === 1 && r.nodeName.toLowerCase() !== "object") {
              a = ut(e), (l = r.getAttribute("id")) ? c = l.replace(n, "\\$&") : r.setAttribute("id", c), c = "[id='" + c + "'] ", f = a.length;
              while (f--) a[f] = c + a[f].join("");
              h = z.test(e) && r.parentNode || r, p = a.join(",")
            }
            if (p) try {
              return S.apply(s, x.call(h.querySelectorAll(p), 0)), s
            } catch (v) {} finally {
              l || r.removeAttribute("id")
            }
          }
          return t(e, r, s, o, u)
        }, u && (K(function(t) {
          e = u.call(t, "div");
          try {
            u.call(t, "[test!='']:sizzle"), s.push("!=", H)
          } catch (n) {}
        }), s = new RegExp(s.join("|")), nt.matchesSelector = function(t, n) {
          n = n.replace(r, "='$1']");
          if (!o(t) && !s.test(n) && !i.test(n)) try {
            var a = u.call(t, n);
            if (a || e || t.document && t.document.nodeType !== 11) return a
          } catch (f) {}
          return nt(n, null, null, [t]).length > 0
        })
      }(), i.pseudos.nth = i.pseudos.eq, i.filters = mt.prototype = i.pseudos, i.setFilters = new mt, nt.attr = v.attr, v.find = nt, v.expr = nt.selectors, v.expr[":"] = v.expr.pseudos, v.unique = nt.uniqueSort, v.text = nt.getText, v.isXMLDoc = nt.isXML, v.contains = nt.contains
    }(e);
  var nt = /Until$/,
    rt = /^(?:parents|prev(?:Until|All))/,
    it = /^.[^:#\[\.,]*$/,
    st = v.expr.match.needsContext,
    ot = {
      children: !0,
      contents: !0,
      next: !0,
      prev: !0
    };
  v.fn.extend({
    find: function(e) {
      var t, n, r, i, s, o, u = this;
      if (typeof e != "string") return v(e).filter(function() {
        for (t = 0, n = u.length; t < n; t++)
          if (v.contains(u[t], this)) return !0
      });
      o = this.pushStack("", "find", e);
      for (t = 0, n = this.length; t < n; t++) {
        r = o.length, v.find(e, this[t], o);
        if (t > 0)
          for (i = r; i < o.length; i++)
            for (s = 0; s < r; s++)
              if (o[s] === o[i]) {
                o.splice(i--, 1);
                break
              }
      }
      return o
    },
    has: function(e) {
      var t, n = v(e, this),
        r = n.length;
      return this.filter(function() {
        for (t = 0; t < r; t++)
          if (v.contains(this, n[t])) return !0
      })
    },
    not: function(e) {
      return this.pushStack(ft(this, e, !1), "not", e)
    },
    filter: function(e) {
      return this.pushStack(ft(this, e, !0), "filter", e)
    },
    is: function(e) {
      return !!e && (typeof e == "string" ? st.test(e) ? v(e, this.context).index(this[0]) >= 0 : v.filter(e, this).length > 0 : this.filter(e).length > 0)
    },
    closest: function(e, t) {
      var n, r = 0,
        i = this.length,
        s = [],
        o = st.test(e) || typeof e != "string" ? v(e, t || this.context) : 0;
      for (; r < i; r++) {
        n = this[r];
        while (n && n.ownerDocument && n !== t && n.nodeType !== 11) {
          if (o ? o.index(n) > -1 : v.find.matchesSelector(n, e)) {
            s.push(n);
            break
          }
          n = n.parentNode
        }
      }
      return s = s.length > 1 ? v.unique(s) : s, this.pushStack(s, "closest", e)
    },
    index: function(e) {
      return e ? typeof e == "string" ? v.inArray(this[0], v(e)) : v.inArray(e.jquery ? e[0] : e, this) : this[0] && this[0].parentNode ? this.prevAll().length : -1
    },
    add: function(e, t) {
      var n = typeof e == "string" ? v(e, t) : v.makeArray(e && e.nodeType ? [e] : e),
        r = v.merge(this.get(), n);
      return this.pushStack(ut(n[0]) || ut(r[0]) ? r : v.unique(r))
    },
    addBack: function(e) {
      return this.add(e == null ? this.prevObject : this.prevObject.filter(e))
    }
  }), v.fn.andSelf = v.fn.addBack, v.each({
    parent: function(e) {
      var t = e.parentNode;
      return t && t.nodeType !== 11 ? t : null
    },
    parents: function(e) {
      return v.dir(e, "parentNode")
    },
    parentsUntil: function(e, t, n) {
      return v.dir(e, "parentNode", n)
    },
    next: function(e) {
      return at(e, "nextSibling")
    },
    prev: function(e) {
      return at(e, "previousSibling")
    },
    nextAll: function(e) {
      return v.dir(e, "nextSibling")
    },
    prevAll: function(e) {
      return v.dir(e, "previousSibling")
    },
    nextUntil: function(e, t, n) {
      return v.dir(e, "nextSibling", n)
    },
    prevUntil: function(e, t, n) {
      return v.dir(e, "previousSibling", n)
    },
    siblings: function(e) {
      return v.sibling((e.parentNode || {}).firstChild, e)
    },
    children: function(e) {
      return v.sibling(e.firstChild)
    },
    contents: function(e) {
      return v.nodeName(e, "iframe") ? e.contentDocument || e.contentWindow.document : v.merge([], e.childNodes)
    }
  }, function(e, t) {
    v.fn[e] = function(n, r) {
      var i = v.map(this, t, n);
      return nt.test(e) || (r = n), r && typeof r == "string" && (i = v.filter(r, i)), i = this.length > 1 && !ot[e] ? v.unique(i) : i, this.length > 1 && rt.test(e) && (i = i.reverse()), this.pushStack(i, e, l.call(arguments).join(","))
    }
  }), v.extend({
    filter: function(e, t, n) {
      return n && (e = ":not(" + e + ")"), t.length === 1 ? v.find.matchesSelector(t[0], e) ? [t[0]] : [] : v.find.matches(e, t)
    },
    dir: function(e, n, r) {
      var i = [],
        s = e[n];
      while (s && s.nodeType !== 9 && (r === t || s.nodeType !== 1 || !v(s).is(r))) s.nodeType === 1 && i.push(s), s = s[n];
      return i
    },
    sibling: function(e, t) {
      var n = [];
      for (; e; e = e.nextSibling) e.nodeType === 1 && e !== t && n.push(e);
      return n
    }
  });
  var ct = "abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",
    ht = / jQuery\d+="(?:null|\d+)"/g,
    pt = /^\s+/,
    dt = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,
    vt = /<([\w:]+)/,
    mt = /<tbody/i,
    gt = /<|&#?\w+;/,
    yt = /<(?:script|style|link)/i,
    bt = /<(?:script|object|embed|option|style)/i,
    wt = new RegExp("<(?:" + ct + ")[\\s/>]", "i"),
    Et = /^(?:checkbox|radio)$/,
    St = /checked\s*(?:[^=]|=\s*.checked.)/i,
    xt = /\/(java|ecma)script/i,
    Tt = /^\s*<!(?:\[CDATA\[|\-\-)|[\]\-]{2}>\s*$/g,
    Nt = {
      option: [1, "<select multiple='multiple'>", "</select>"],
      legend: [1, "<fieldset>", "</fieldset>"],
      thead: [1, "<table>", "</table>"],
      tr: [2, "<table><tbody>", "</tbody></table>"],
      td: [3, "<table><tbody><tr>", "</tr></tbody></table>"],
      col: [2, "<table><tbody></tbody><colgroup>", "</colgroup></table>"],
      area: [1, "<map>", "</map>"],
      _default: [0, "", ""]
    },
    Ct = lt(i),
    kt = Ct.appendChild(i.createElement("div"));
  Nt.optgroup = Nt.option, Nt.tbody = Nt.tfoot = Nt.colgroup = Nt.caption = Nt.thead, Nt.th = Nt.td, v.support.htmlSerialize || (Nt._default = [1, "X<div>", "</div>"]), v.fn.extend({
      text: function(e) {
        return v.access(this, function(e) {
          return e === t ? v.text(this) : this.empty().append((this[0] && this[0].ownerDocument || i).createTextNode(e))
        }, null, e, arguments.length)
      },
      wrapAll: function(e) {
        if (v.isFunction(e)) return this.each(function(t) {
          v(this).wrapAll(e.call(this, t))
        });
        if (this[0]) {
          var t = v(e, this[0].ownerDocument).eq(0).clone(!0);
          this[0].parentNode && t.insertBefore(this[0]), t.map(function() {
            var e = this;
            while (e.firstChild && e.firstChild.nodeType === 1) e = e.firstChild;
            return e
          }).append(this)
        }
        return this
      },
      wrapInner: function(e) {
        return v.isFunction(e) ? this.each(function(t) {
          v(this).wrapInner(e.call(this, t))
        }) : this.each(function() {
          var t = v(this),
            n = t.contents();
          n.length ? n.wrapAll(e) : t.append(e)
        })
      },
      wrap: function(e) {
        var t = v.isFunction(e);
        return this.each(function(n) {
          v(this).wrapAll(t ? e.call(this, n) : e)
        })
      },
      unwrap: function() {
        return this.parent().each(function() {
          v.nodeName(this, "body") || v(this).replaceWith(this.childNodes)
        }).end()
      },
      append: function() {
        return this.domManip(arguments, !0, function(e) {
          (this.nodeType === 1 || this.nodeType === 11) && this.appendChild(e)
        })
      },
      prepend: function() {
        return this.domManip(arguments, !0, function(e) {
          (this.nodeType === 1 || this.nodeType === 11) && this.insertBefore(e, this.firstChild)
        })
      },
      before: function() {
        if (!ut(this[0])) return this.domManip(arguments, !1, function(e) {
          this.parentNode.insertBefore(e, this)
        });
        if (arguments.length) {
          var e = v.clean(arguments);
          return this.pushStack(v.merge(e, this), "before", this.selector)
        }
      },
      after: function() {
        if (!ut(this[0])) return this.domManip(arguments, !1, function(e) {
          this.parentNode.insertBefore(e, this.nextSibling)
        });
        if (arguments.length) {
          var e = v.clean(arguments);
          return this.pushStack(v.merge(this, e), "after", this.selector)
        }
      },
      remove: function(e, t) {
        var n, r = 0;
        for (;
          (n = this[r]) != null; r++)
          if (!e || v.filter(e, [n]).length) !t && n.nodeType === 1 && (v.cleanData(n.getElementsByTagName("*")), v.cleanData([n])), n.parentNode && n.parentNode.removeChild(n);
        return this
      },
      empty: function() {
        var e, t = 0;
        for (;
          (e = this[t]) != null; t++) {
          e.nodeType === 1 && v.cleanData(e.getElementsByTagName("*"));
          while (e.firstChild) e.removeChild(e.firstChild)
        }
        return this
      },
      clone: function(e, t) {
        return e = e == null ? !1 : e, t = t == null ? e : t, this.map(function() {
          return v.clone(this, e, t)
        })
      },
      html: function(e) {
        return v.access(this, function(e) {
          var n = this[0] || {},
            r = 0,
            i = this.length;
          if (e === t) return n.nodeType === 1 ? n.innerHTML.replace(ht, "") : t;
          if (typeof e == "string" && !yt.test(e) && (v.support.htmlSerialize || !wt.test(e)) && (v.support.leadingWhitespace || !pt.test(e)) && !Nt[(vt.exec(e) || ["", ""])[1].toLowerCase()]) {
            e = e.replace(dt, "<$1></$2>");
            try {
              for (; r < i; r++) n = this[r] || {}, n.nodeType === 1 && (v.cleanData(n.getElementsByTagName("*")), n.innerHTML = e);
              n = 0
            } catch (s) {}
          }
          n && this.empty().append(e)
        }, null, e, arguments.length)
      },
      replaceWith: function(e) {
        return ut(this[0]) ? this.length ? this.pushStack(v(v.isFunction(e) ? e() : e), "replaceWith", e) : this : v.isFunction(e) ? this.each(function(t) {
          var n = v(this),
            r = n.html();
          n.replaceWith(e.call(this, t, r))
        }) : (typeof e != "string" && (e = v(e).detach()), this.each(function() {
          var t = this.nextSibling,
            n = this.parentNode;
          v(this).remove(), t ? v(t).before(e) : v(n).append(e)
        }))
      },
      detach: function(e) {
        return this.remove(e, !0)
      },
      domManip: function(e, n, r) {
        e = [].concat.apply([], e);
        var i, s, o, u, a = 0,
          f = e[0],
          l = [],
          c = this.length;
        if (!v.support.checkClone && c > 1 && typeof f == "string" && St.test(f)) return this.each(function() {
          v(this).domManip(e, n, r)
        });
        if (v.isFunction(f)) return this.each(function(i) {
          var s = v(this);
          e[0] = f.call(this, i, n ? s.html() : t), s.domManip(e, n, r)
        });
        if (this[0]) {
          i = v.buildFragment(e, this, l), o = i.fragment, s = o.firstChild, o.childNodes.length === 1 && (o = s);
          if (s) {
            n = n && v.nodeName(s, "tr");
            for (u = i.cacheable || c - 1; a < c; a++) r.call(n && v.nodeName(this[a], "table") ? Lt(this[a], "tbody") : this[a], a === u ? o : v.clone(o, !0, !0))
          }
          o = s = null, l.length && v.each(l, function(e, t) {
            t.src ? v.ajax ? v.ajax({
              url: t.src,
              type: "GET",
              dataType: "script",
              async: !1,
              global: !1,
              "throws": !0
            }) : v.error("no ajax") : v.globalEval((t.text || t.textContent || t.innerHTML || "").replace(Tt, "")), t.parentNode && t.parentNode.removeChild(t)
          })
        }
        return this
      }
    }), v.buildFragment = function(e, n, r) {
      var s, o, u, a = e[0];
      return n = n || i, n = !n.nodeType && n[0] || n, n = n.ownerDocument || n, e.length === 1 && typeof a == "string" && a.length < 512 && n === i && a.charAt(0) === "<" && !bt.test(a) && (v.support.checkClone || !St.test(a)) && (v.support.html5Clone || !wt.test(a)) && (o = !0, s = v.fragments[a], u = s !== t), s || (s = n.createDocumentFragment(), v.clean(e, n, s, r), o && (v.fragments[a] = u && s)), {
        fragment: s,
        cacheable: o
      }
    }, v.fragments = {}, v.each({
      appendTo: "append",
      prependTo: "prepend",
      insertBefore: "before",
      insertAfter: "after",
      replaceAll: "replaceWith"
    }, function(e, t) {
      v.fn[e] = function(n) {
        var r, i = 0,
          s = [],
          o = v(n),
          u = o.length,
          a = this.length === 1 && this[0].parentNode;
        if ((a == null || a && a.nodeType === 11 && a.childNodes.length === 1) && u === 1) return o[t](this[0]), this;
        for (; i < u; i++) r = (i > 0 ? this.clone(!0) : this).get(), v(o[i])[t](r), s = s.concat(r);
        return this.pushStack(s, e, o.selector)
      }
    }), v.extend({
      clone: function(e, t, n) {
        var r, i, s, o;
        v.support.html5Clone || v.isXMLDoc(e) || !wt.test("<" + e.nodeName + ">") ? o = e.cloneNode(!0) : (kt.innerHTML = e.outerHTML, kt.removeChild(o = kt.firstChild));
        if ((!v.support.noCloneEvent || !v.support.noCloneChecked) && (e.nodeType === 1 || e.nodeType === 11) && !v.isXMLDoc(e)) {
          Ot(e, o), r = Mt(e), i = Mt(o);
          for (s = 0; r[s]; ++s) i[s] && Ot(r[s], i[s])
        }
        if (t) {
          At(e, o);
          if (n) {
            r = Mt(e), i = Mt(o);
            for (s = 0; r[s]; ++s) At(r[s], i[s])
          }
        }
        return r = i = null, o
      },
      clean: function(e, t, n, r) {
        var s, o, u, a, f, l, c, h, p, d, m, g, y = t === i && Ct,
          b = [];
        if (!t || typeof t.createDocumentFragment == "undefined") t = i;
        for (s = 0;
          (u = e[s]) != null; s++) {
          typeof u == "number" && (u += "");
          if (!u) continue;
          if (typeof u == "string")
            if (!gt.test(u)) u = t.createTextNode(u);
            else {
              y = y || lt(t), c = t.createElement("div"), y.appendChild(c), u = u.replace(dt, "<$1></$2>"), a = (vt.exec(u) || ["", ""])[1].toLowerCase(), f = Nt[a] || Nt._default, l = f[0], c.innerHTML = f[1] + u + f[2];
              while (l--) c = c.lastChild;
              if (!v.support.tbody) {
                h = mt.test(u), p = a === "table" && !h ? c.firstChild && c.firstChild.childNodes : f[1] === "<table>" && !h ? c.childNodes : [];
                for (o = p.length - 1; o >= 0; --o) v.nodeName(p[o], "tbody") && !p[o].childNodes.length && p[o].parentNode.removeChild(p[o])
              }!v.support.leadingWhitespace && pt.test(u) && c.insertBefore(t.createTextNode(pt.exec(u)[0]), c.firstChild), u = c.childNodes, c.parentNode.removeChild(c)
            } u.nodeType ? b.push(u) : v.merge(b, u)
        }
        c && (u = c = y = null);
        if (!v.support.appendChecked)
          for (s = 0;
            (u = b[s]) != null; s++) v.nodeName(u, "input") ? _t(u) : typeof u.getElementsByTagName != "undefined" && v.grep(u.getElementsByTagName("input"), _t);
        if (n) {
          m = function(e) {
            if (!e.type || xt.test(e.type)) return r ? r.push(e.parentNode ? e.parentNode.removeChild(e) : e) : n.appendChild(e)
          };
          for (s = 0;
            (u = b[s]) != null; s++)
            if (!v.nodeName(u, "script") || !m(u)) n.appendChild(u), typeof u.getElementsByTagName != "undefined" && (g = v.grep(v.merge([], u.getElementsByTagName("script")), m), b.splice.apply(b, [s + 1, 0].concat(g)), s += g.length)
        }
        return b
      },
      cleanData: function(e, t) {
        var n, r, i, s, o = 0,
          u = v.expando,
          a = v.cache,
          f = v.support.deleteExpando,
          l = v.event.special;
        for (;
          (i = e[o]) != null; o++)
          if (t || v.acceptData(i)) {
            r = i[u], n = r && a[r];
            if (n) {
              if (n.events)
                for (s in n.events) l[s] ? v.event.remove(i, s) : v.removeEvent(i, s, n.handle);
              a[r] && (delete a[r], f ? delete i[u] : i.removeAttribute ? i.removeAttribute(u) : i[u] = null, v.deletedIds.push(r))
            }
          }
      }
    }),
    function() {
      var e, t;
      v.uaMatch = function(e) {
        e = e.toLowerCase();
        var t = /(chrome)[ \/]([\w.]+)/.exec(e) || /(webkit)[ \/]([\w.]+)/.exec(e) || /(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e) || /(msie) ([\w.]+)/.exec(e) || e.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e) || [];
        return {
          browser: t[1] || "",
          version: t[2] || "0"
        }
      }, e = v.uaMatch(o.userAgent), t = {}, e.browser && (t[e.browser] = !0, t.version = e.version), t.chrome ? t.webkit = !0 : t.webkit && (t.safari = !0), v.browser = t, v.sub = function() {
        function e(t, n) {
          return new e.fn.init(t, n)
        }
        v.extend(!0, e, this), e.superclass = this, e.fn = e.prototype = this(), e.fn.constructor = e, e.sub = this.sub, e.fn.init = function(r, i) {
          return i && i instanceof v && !(i instanceof e) && (i = e(i)), v.fn.init.call(this, r, i, t)
        }, e.fn.init.prototype = e.fn;
        var t = e(i);
        return e
      }
    }();
  var Dt, Pt, Ht, Bt = /alpha\([^)]*\)/i,
    jt = /opacity=([^)]*)/,
    Ft = /^(top|right|bottom|left)$/,
    It = /^(none|table(?!-c[ea]).+)/,
    qt = /^margin/,
    Rt = new RegExp("^(" + m + ")(.*)$", "i"),
    Ut = new RegExp("^(" + m + ")(?!px)[a-z%]+$", "i"),
    zt = new RegExp("^([-+])=(" + m + ")", "i"),
    Wt = {
      BODY: "block"
    },
    Xt = {
      position: "absolute",
      visibility: "hidden",
      display: "block"
    },
    Vt = {
      letterSpacing: 0,
      fontWeight: 400
    },
    $t = ["Top", "Right", "Bottom", "Left"],
    Jt = ["Webkit", "O", "Moz", "ms"],
    Kt = v.fn.toggle;
  v.fn.extend({
    css: function(e, n) {
      return v.access(this, function(e, n, r) {
        return r !== t ? v.style(e, n, r) : v.css(e, n)
      }, e, n, arguments.length > 1)
    },
    show: function() {
      return Yt(this, !0)
    },
    hide: function() {
      return Yt(this)
    },
    toggle: function(e, t) {
      var n = typeof e == "boolean";
      return v.isFunction(e) && v.isFunction(t) ? Kt.apply(this, arguments) : this.each(function() {
        (n ? e : Gt(this)) ? v(this).show(): v(this).hide()
      })
    }
  }), v.extend({
    cssHooks: {
      opacity: {
        get: function(e, t) {
          if (t) {
            var n = Dt(e, "opacity");
            return n === "" ? "1" : n
          }
        }
      }
    },
    cssNumber: {
      fillOpacity: !0,
      fontWeight: !0,
      lineHeight: !0,
      opacity: !0,
      orphans: !0,
      widows: !0,
      zIndex: !0,
      zoom: !0
    },
    cssProps: {
      "float": v.support.cssFloat ? "cssFloat" : "styleFloat"
    },
    style: function(e, n, r, i) {
      if (!e || e.nodeType === 3 || e.nodeType === 8 || !e.style) return;
      var s, o, u, a = v.camelCase(n),
        f = e.style;
      n = v.cssProps[a] || (v.cssProps[a] = Qt(f, a)), u = v.cssHooks[n] || v.cssHooks[a];
      if (r === t) return u && "get" in u && (s = u.get(e, !1, i)) !== t ? s : f[n];
      o = typeof r, o === "string" && (s = zt.exec(r)) && (r = (s[1] + 1) * s[2] + parseFloat(v.css(e, n)), o = "number");
      if (r == null || o === "number" && isNaN(r)) return;
      o === "number" && !v.cssNumber[a] && (r += "px");
      if (!u || !("set" in u) || (r = u.set(e, r, i)) !== t) try {
        f[n] = r
      } catch (l) {}
    },
    css: function(e, n, r, i) {
      var s, o, u, a = v.camelCase(n);
      return n = v.cssProps[a] || (v.cssProps[a] = Qt(e.style, a)), u = v.cssHooks[n] || v.cssHooks[a], u && "get" in u && (s = u.get(e, !0, i)), s === t && (s = Dt(e, n)), s === "normal" && n in Vt && (s = Vt[n]), r || i !== t ? (o = parseFloat(s), r || v.isNumeric(o) ? o || 0 : s) : s
    },
    swap: function(e, t, n) {
      var r, i, s = {};
      for (i in t) s[i] = e.style[i], e.style[i] = t[i];
      r = n.call(e);
      for (i in t) e.style[i] = s[i];
      return r
    }
  }), e.getComputedStyle ? Dt = function(t, n) {
    var r, i, s, o, u = e.getComputedStyle(t, null),
      a = t.style;
    return u && (r = u.getPropertyValue(n) || u[n], r === "" && !v.contains(t.ownerDocument, t) && (r = v.style(t, n)), Ut.test(r) && qt.test(n) && (i = a.width, s = a.minWidth, o = a.maxWidth, a.minWidth = a.maxWidth = a.width = r, r = u.width, a.width = i, a.minWidth = s, a.maxWidth = o)), r
  } : i.documentElement.currentStyle && (Dt = function(e, t) {
    var n, r, i = e.currentStyle && e.currentStyle[t],
      s = e.style;
    return i == null && s && s[t] && (i = s[t]), Ut.test(i) && !Ft.test(t) && (n = s.left, r = e.runtimeStyle && e.runtimeStyle.left, r && (e.runtimeStyle.left = e.currentStyle.left), s.left = t === "fontSize" ? "1em" : i, i = s.pixelLeft + "px", s.left = n, r && (e.runtimeStyle.left = r)), i === "" ? "auto" : i
  }), v.each(["height", "width"], function(e, t) {
    v.cssHooks[t] = {
      get: function(e, n, r) {
        if (n) return e.offsetWidth === 0 && It.test(Dt(e, "display")) ? v.swap(e, Xt, function() {
          return tn(e, t, r)
        }) : tn(e, t, r)
      },
      set: function(e, n, r) {
        return Zt(e, n, r ? en(e, t, r, v.support.boxSizing && v.css(e, "boxSizing") === "border-box") : 0)
      }
    }
  }), v.support.opacity || (v.cssHooks.opacity = {
    get: function(e, t) {
      return jt.test((t && e.currentStyle ? e.currentStyle.filter : e.style.filter) || "") ? .01 * parseFloat(RegExp.$1) + "" : t ? "1" : ""
    },
    set: function(e, t) {
      var n = e.style,
        r = e.currentStyle,
        i = v.isNumeric(t) ? "alpha(opacity=" + t * 100 + ")" : "",
        s = r && r.filter || n.filter || "";
      n.zoom = 1;
      if (t >= 1 && v.trim(s.replace(Bt, "")) === "" && n.removeAttribute) {
        n.removeAttribute("filter");
        if (r && !r.filter) return
      }
      n.filter = Bt.test(s) ? s.replace(Bt, i) : s + " " + i
    }
  }), v(function() {
    v.support.reliableMarginRight || (v.cssHooks.marginRight = {
      get: function(e, t) {
        return v.swap(e, {
          display: "inline-block"
        }, function() {
          if (t) return Dt(e, "marginRight")
        })
      }
    }), !v.support.pixelPosition && v.fn.position && v.each(["top", "left"], function(e, t) {
      v.cssHooks[t] = {
        get: function(e, n) {
          if (n) {
            var r = Dt(e, t);
            return Ut.test(r) ? v(e).position()[t] + "px" : r
          }
        }
      }
    })
  }), v.expr && v.expr.filters && (v.expr.filters.hidden = function(e) {
    return e.offsetWidth === 0 && e.offsetHeight === 0 || !v.support.reliableHiddenOffsets && (e.style && e.style.display || Dt(e, "display")) === "none"
  }, v.expr.filters.visible = function(e) {
    return !v.expr.filters.hidden(e)
  }), v.each({
    margin: "",
    padding: "",
    border: "Width"
  }, function(e, t) {
    v.cssHooks[e + t] = {
      expand: function(n) {
        var r, i = typeof n == "string" ? n.split(" ") : [n],
          s = {};
        for (r = 0; r < 4; r++) s[e + $t[r] + t] = i[r] || i[r - 2] || i[0];
        return s
      }
    }, qt.test(e) || (v.cssHooks[e + t].set = Zt)
  });
  var rn = /%20/g,
    sn = /\[\]$/,
    on = /\r?\n/g,
    un = /^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,
    an = /^(?:select|textarea)/i;
  v.fn.extend({
    serialize: function() {
      return v.param(this.serializeArray())
    },
    serializeArray: function() {
      return this.map(function() {
        return this.elements ? v.makeArray(this.elements) : this
      }).filter(function() {
        return this.name && !this.disabled && (this.checked || an.test(this.nodeName) || un.test(this.type))
      }).map(function(e, t) {
        var n = v(this).val();
        return n == null ? null : v.isArray(n) ? v.map(n, function(e, n) {
          return {
            name: t.name,
            value: e.replace(on, "\r\n")
          }
        }) : {
          name: t.name,
          value: n.replace(on, "\r\n")
        }
      }).get()
    }
  }), v.param = function(e, n) {
    var r, i = [],
      s = function(e, t) {
        t = v.isFunction(t) ? t() : t == null ? "" : t, i[i.length] = encodeURIComponent(e) + "=" + encodeURIComponent(t)
      };
    n === t && (n = v.ajaxSettings && v.ajaxSettings.traditional);
    if (v.isArray(e) || e.jquery && !v.isPlainObject(e)) v.each(e, function() {
      s(this.name, this.value)
    });
    else
      for (r in e) fn(r, e[r], n, s);
    return i.join("&").replace(rn, "+")
  };
  var ln, cn, hn = /#.*$/,
    pn = /^(.*?):[ \t]*([^\r\n]*)\r?$/mg,
    dn = /^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,
    vn = /^(?:GET|HEAD)$/,
    mn = /^\/\//,
    gn = /\?/,
    yn = /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
    bn = /([?&])_=[^&]*/,
    wn = /^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,
    En = v.fn.load,
    Sn = {},
    xn = {},
    Tn = ["*/"] + ["*"];
  try {
    cn = s.href
  } catch (Nn) {
    cn = i.createElement("a"), cn.href = "", cn = cn.href
  }
  ln = wn.exec(cn.toLowerCase()) || [], v.fn.load = function(e, n, r) {
    if (typeof e != "string" && En) return En.apply(this, arguments);
    if (!this.length) return this;
    var i, s, o, u = this,
      a = e.indexOf(" ");
    return a >= 0 && (i = e.slice(a, e.length), e = e.slice(0, a)), v.isFunction(n) ? (r = n, n = t) : n && typeof n == "object" && (s = "POST"), v.ajax({
      url: e,
      type: s,
      dataType: "html",
      data: n,
      complete: function(e, t) {
        r && u.each(r, o || [e.responseText, t, e])
      }
    }).done(function(e) {
      o = arguments, u.html(i ? v("<div>").append(e.replace(yn, "")).find(i) : e)
    }), this
  }, v.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "), function(e, t) {
    v.fn[t] = function(e) {
      return this.on(t, e)
    }
  }), v.each(["get", "post"], function(e, n) {
    v[n] = function(e, r, i, s) {
      return v.isFunction(r) && (s = s || i, i = r, r = t), v.ajax({
        type: n,
        url: e,
        data: r,
        success: i,
        dataType: s
      })
    }
  }), v.extend({
    getScript: function(e, n) {
      return v.get(e, t, n, "script")
    },
    getJSON: function(e, t, n) {
      return v.get(e, t, n, "json")
    },
    ajaxSetup: function(e, t) {
      return t ? Ln(e, v.ajaxSettings) : (t = e, e = v.ajaxSettings), Ln(e, t), e
    },
    ajaxSettings: {
      url: cn,
      isLocal: dn.test(ln[1]),
      global: !0,
      type: "GET",
      contentType: "application/x-www-form-urlencoded; charset=UTF-8",
      processData: !0,
      async: !0,
      accepts: {
        xml: "application/xml, text/xml",
        html: "text/html",
        text: "text/plain",
        json: "application/json, text/javascript",
        "*": Tn
      },
      contents: {
        xml: /xml/,
        html: /html/,
        json: /json/
      },
      responseFields: {
        xml: "responseXML",
        text: "responseText"
      },
      converters: {
        "* text": e.String,
        "text html": !0,
        "text json": v.parseJSON,
        "text xml": v.parseXML
      },
      flatOptions: {
        context: !0,
        url: !0
      }
    },
    ajaxPrefilter: Cn(Sn),
    ajaxTransport: Cn(xn),
    ajax: function(e, n) {
      function T(e, n, s, a) {
        var l, y, b, w, S, T = n;
        if (E === 2) return;
        E = 2, u && clearTimeout(u), o = t, i = a || "", x.readyState = e > 0 ? 4 : 0, s && (w = An(c, x, s));
        if (e >= 200 && e < 300 || e === 304) c.ifModified && (S = x.getResponseHeader("Last-Modified"), S && (v.lastModified[r] = S), S = x.getResponseHeader("Etag"), S && (v.etag[r] = S)), e === 304 ? (T = "notmodified", l = !0) : (l = On(c, w), T = l.state, y = l.data, b = l.error, l = !b);
        else {
          b = T;
          if (!T || e) T = "error", e < 0 && (e = 0)
        }
        x.status = e, x.statusText = (n || T) + "", l ? d.resolveWith(h, [y, T, x]) : d.rejectWith(h, [x, T, b]), x.statusCode(g), g = t, f && p.trigger("ajax" + (l ? "Success" : "Error"), [x, c, l ? y : b]), m.fireWith(h, [x, T]), f && (p.trigger("ajaxComplete", [x, c]), --v.active || v.event.trigger("ajaxStop"))
      }
      typeof e == "object" && (n = e, e = t), n = n || {};
      var r, i, s, o, u, a, f, l, c = v.ajaxSetup({}, n),
        h = c.context || c,
        p = h !== c && (h.nodeType || h instanceof v) ? v(h) : v.event,
        d = v.Deferred(),
        m = v.Callbacks("once memory"),
        g = c.statusCode || {},
        b = {},
        w = {},
        E = 0,
        S = "canceled",
        x = {
          readyState: 0,
          setRequestHeader: function(e, t) {
            if (!E) {
              var n = e.toLowerCase();
              e = w[n] = w[n] || e, b[e] = t
            }
            return this
          },
          getAllResponseHeaders: function() {
            return E === 2 ? i : null
          },
          getResponseHeader: function(e) {
            var n;
            if (E === 2) {
              if (!s) {
                s = {};
                while (n = pn.exec(i)) s[n[1].toLowerCase()] = n[2]
              }
              n = s[e.toLowerCase()]
            }
            return n === t ? null : n
          },
          overrideMimeType: function(e) {
            return E || (c.mimeType = e), this
          },
          abort: function(e) {
            return e = e || S, o && o.abort(e), T(0, e), this
          }
        };
      d.promise(x), x.success = x.done, x.error = x.fail, x.complete = m.add, x.statusCode = function(e) {
        if (e) {
          var t;
          if (E < 2)
            for (t in e) g[t] = [g[t], e[t]];
          else t = e[x.status], x.always(t)
        }
        return this
      }, c.url = ((e || c.url) + "").replace(hn, "").replace(mn, ln[1] + "//"), c.dataTypes = v.trim(c.dataType || "*").toLowerCase().split(y), c.crossDomain == null && (a = wn.exec(c.url.toLowerCase()), c.crossDomain = !(!a || a[1] === ln[1] && a[2] === ln[2] && (a[3] || (a[1] === "http:" ? 80 : 443)) == (ln[3] || (ln[1] === "http:" ? 80 : 443)))), c.data && c.processData && typeof c.data != "string" && (c.data = v.param(c.data, c.traditional)), kn(Sn, c, n, x);
      if (E === 2) return x;
      f = c.global, c.type = c.type.toUpperCase(), c.hasContent = !vn.test(c.type), f && v.active++ === 0 && v.event.trigger("ajaxStart");
      if (!c.hasContent) {
        c.data && (c.url += (gn.test(c.url) ? "&" : "?") + c.data, delete c.data), r = c.url;
        if (c.cache === !1) {
          var N = v.now(),
            C = c.url.replace(bn, "$1_=" + N);
          c.url = C + (C === c.url ? (gn.test(c.url) ? "&" : "?") + "_=" + N : "")
        }
      }(c.data && c.hasContent && c.contentType !== !1 || n.contentType) && x.setRequestHeader("Content-Type", c.contentType), c.ifModified && (r = r || c.url, v.lastModified[r] && x.setRequestHeader("If-Modified-Since", v.lastModified[r]), v.etag[r] && x.setRequestHeader("If-None-Match", v.etag[r])), x.setRequestHeader("Accept", c.dataTypes[0] && c.accepts[c.dataTypes[0]] ? c.accepts[c.dataTypes[0]] + (c.dataTypes[0] !== "*" ? ", " + Tn + "; q=0.01" : "") : c.accepts["*"]);
      for (l in c.headers) x.setRequestHeader(l, c.headers[l]);
      if (!c.beforeSend || c.beforeSend.call(h, x, c) !== !1 && E !== 2) {
        S = "abort";
        for (l in {
            success: 1,
            error: 1,
            complete: 1
          }) x[l](c[l]);
        o = kn(xn, c, n, x);
        if (!o) T(-1, "No Transport");
        else {
          x.readyState = 1, f && p.trigger("ajaxSend", [x, c]), c.async && c.timeout > 0 && (u = setTimeout(function() {
            x.abort("timeout")
          }, c.timeout));
          try {
            E = 1, o.send(b, T)
          } catch (k) {
            if (!(E < 2)) throw k;
            T(-1, k)
          }
        }
        return x
      }
      return x.abort()
    },
    active: 0,
    lastModified: {},
    etag: {}
  });
  var Mn = [],
    _n = /\?/,
    Dn = /(=)\?(?=&|$)|\?\?/,
    Pn = v.now();
  v.ajaxSetup({
    jsonp: "callback",
    jsonpCallback: function() {
      var e = Mn.pop() || v.expando + "_" + Pn++;
      return this[e] = !0, e
    }
  }), v.ajaxPrefilter("json jsonp", function(n, r, i) {
    var s, o, u, a = n.data,
      f = n.url,
      l = n.jsonp !== !1,
      c = l && Dn.test(f),
      h = l && !c && typeof a == "string" && !(n.contentType || "").indexOf("application/x-www-form-urlencoded") && Dn.test(a);
    if (n.dataTypes[0] === "jsonp" || c || h) return s = n.jsonpCallback = v.isFunction(n.jsonpCallback) ? n.jsonpCallback() : n.jsonpCallback, o = e[s], c ? n.url = f.replace(Dn, "$1" + s) : h ? n.data = a.replace(Dn, "$1" + s) : l && (n.url += (_n.test(f) ? "&" : "?") + n.jsonp + "=" + s), n.converters["script json"] = function() {
      return u || v.error(s + " was not called"), u[0]
    }, n.dataTypes[0] = "json", e[s] = function() {
      u = arguments
    }, i.always(function() {
      e[s] = o, n[s] && (n.jsonpCallback = r.jsonpCallback, Mn.push(s)), u && v.isFunction(o) && o(u[0]), u = o = t
    }), "script"
  }), v.ajaxSetup({
    accepts: {
      script: "text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"
    },
    contents: {
      script: /javascript|ecmascript/
    },
    converters: {
      "text script": function(e) {
        return v.globalEval(e), e
      }
    }
  }), v.ajaxPrefilter("script", function(e) {
    e.cache === t && (e.cache = !1), e.crossDomain && (e.type = "GET", e.global = !1)
  }), v.ajaxTransport("script", function(e) {
    if (e.crossDomain) {
      var n, r = i.head || i.getElementsByTagName("head")[0] || i.documentElement;
      return {
        send: function(s, o) {
          n = i.createElement("script"), n.async = "async", e.scriptCharset && (n.charset = e.scriptCharset), n.src = e.url, n.onload = n.onreadystatechange = function(e, i) {
            if (i || !n.readyState || /loaded|complete/.test(n.readyState)) n.onload = n.onreadystatechange = null, r && n.parentNode && r.removeChild(n), n = t, i || o(200, "success")
          }, r.insertBefore(n, r.firstChild)
        },
        abort: function() {
          n && n.onload(0, 1)
        }
      }
    }
  });
  var Hn, Bn = e.ActiveXObject ? function() {
      for (var e in Hn) Hn[e](0, 1)
    } : !1,
    jn = 0;
  v.ajaxSettings.xhr = e.ActiveXObject ? function() {
      return !this.isLocal && Fn() || In()
    } : Fn,
    function(e) {
      v.extend(v.support, {
        ajax: !!e,
        cors: !!e && "withCredentials" in e
      })
    }(v.ajaxSettings.xhr()), v.support.ajax && v.ajaxTransport(function(n) {
      if (!n.crossDomain || v.support.cors) {
        var r;
        return {
          send: function(i, s) {
            var o, u, a = n.xhr();
            n.username ? a.open(n.type, n.url, n.async, n.username, n.password) : a.open(n.type, n.url, n.async);
            if (n.xhrFields)
              for (u in n.xhrFields) a[u] = n.xhrFields[u];
            n.mimeType && a.overrideMimeType && a.overrideMimeType(n.mimeType), !n.crossDomain && !i["X-Requested-With"] && (i["X-Requested-With"] = "XMLHttpRequest");
            try {
              for (u in i) a.setRequestHeader(u, i[u])
            } catch (f) {}
            a.send(n.hasContent && n.data || null), r = function(e, i) {
              var u, f, l, c, h;
              try {
                if (r && (i || a.readyState === 4)) {
                  r = t, o && (a.onreadystatechange = v.noop, Bn && delete Hn[o]);
                  if (i) a.readyState !== 4 && a.abort();
                  else {
                    u = a.status, l = a.getAllResponseHeaders(), c = {}, h = a.responseXML, h && h.documentElement && (c.xml = h);
                    try {
                      c.text = a.responseText
                    } catch (p) {}
                    try {
                      f = a.statusText
                    } catch (p) {
                      f = ""
                    }!u && n.isLocal && !n.crossDomain ? u = c.text ? 200 : 404 : u === 1223 && (u = 204)
                  }
                }
              } catch (d) {
                i || s(-1, d)
              }
              c && s(u, f, c, l)
            }, n.async ? a.readyState === 4 ? setTimeout(r, 0) : (o = ++jn, Bn && (Hn || (Hn = {}, v(e).unload(Bn)), Hn[o] = r), a.onreadystatechange = r) : r()
          },
          abort: function() {
            r && r(0, 1)
          }
        }
      }
    });
  var qn, Rn, Un = /^(?:toggle|show|hide)$/,
    zn = new RegExp("^(?:([-+])=|)(" + m + ")([a-z%]*)$", "i"),
    Wn = /queueHooks$/,
    Xn = [Gn],
    Vn = {
      "*": [function(e, t) {
        var n, r, i = this.createTween(e, t),
          s = zn.exec(t),
          o = i.cur(),
          u = +o || 0,
          a = 1,
          f = 20;
        if (s) {
          n = +s[2], r = s[3] || (v.cssNumber[e] ? "" : "px");
          if (r !== "px" && u) {
            u = v.css(i.elem, e, !0) || n || 1;
            do a = a || ".5", u /= a, v.style(i.elem, e, u + r); while (a !== (a = i.cur() / o) && a !== 1 && --f)
          }
          i.unit = r, i.start = u, i.end = s[1] ? u + (s[1] + 1) * n : n
        }
        return i
      }]
    };
  v.Animation = v.extend(Kn, {
    tweener: function(e, t) {
      v.isFunction(e) ? (t = e, e = ["*"]) : e = e.split(" ");
      var n, r = 0,
        i = e.length;
      for (; r < i; r++) n = e[r], Vn[n] = Vn[n] || [], Vn[n].unshift(t)
    },
    prefilter: function(e, t) {
      t ? Xn.unshift(e) : Xn.push(e)
    }
  }), v.Tween = Yn, Yn.prototype = {
    constructor: Yn,
    init: function(e, t, n, r, i, s) {
      this.elem = e, this.prop = n, this.easing = i || "swing", this.options = t, this.start = this.now = this.cur(), this.end = r, this.unit = s || (v.cssNumber[n] ? "" : "px")
    },
    cur: function() {
      var e = Yn.propHooks[this.prop];
      return e && e.get ? e.get(this) : Yn.propHooks._default.get(this)
    },
    run: function(e) {
      var t, n = Yn.propHooks[this.prop];
      return this.options.duration ? this.pos = t = v.easing[this.easing](e, this.options.duration * e, 0, 1, this.options.duration) : this.pos = t = e, this.now = (this.end - this.start) * t + this.start, this.options.step && this.options.step.call(this.elem, this.now, this), n && n.set ? n.set(this) : Yn.propHooks._default.set(this), this
    }
  }, Yn.prototype.init.prototype = Yn.prototype, Yn.propHooks = {
    _default: {
      get: function(e) {
        var t;
        return e.elem[e.prop] == null || !!e.elem.style && e.elem.style[e.prop] != null ? (t = v.css(e.elem, e.prop, !1, ""), !t || t === "auto" ? 0 : t) : e.elem[e.prop]
      },
      set: function(e) {
        v.fx.step[e.prop] ? v.fx.step[e.prop](e) : e.elem.style && (e.elem.style[v.cssProps[e.prop]] != null || v.cssHooks[e.prop]) ? v.style(e.elem, e.prop, e.now + e.unit) : e.elem[e.prop] = e.now
      }
    }
  }, Yn.propHooks.scrollTop = Yn.propHooks.scrollLeft = {
    set: function(e) {
      e.elem.nodeType && e.elem.parentNode && (e.elem[e.prop] = e.now)
    }
  }, v.each(["toggle", "show", "hide"], function(e, t) {
    var n = v.fn[t];
    v.fn[t] = function(r, i, s) {
      return r == null || typeof r == "boolean" || !e && v.isFunction(r) && v.isFunction(i) ? n.apply(this, arguments) : this.animate(Zn(t, !0), r, i, s)
    }
  }), v.fn.extend({
    fadeTo: function(e, t, n, r) {
      return this.filter(Gt).css("opacity", 0).show().end().animate({
        opacity: t
      }, e, n, r)
    },
    animate: function(e, t, n, r) {
      var i = v.isEmptyObject(e),
        s = v.speed(t, n, r),
        o = function() {
          var t = Kn(this, v.extend({}, e), s);
          i && t.stop(!0)
        };
      return i || s.queue === !1 ? this.each(o) : this.queue(s.queue, o)
    },
    stop: function(e, n, r) {
      var i = function(e) {
        var t = e.stop;
        delete e.stop, t(r)
      };
      return typeof e != "string" && (r = n, n = e, e = t), n && e !== !1 && this.queue(e || "fx", []), this.each(function() {
        var t = !0,
          n = e != null && e + "queueHooks",
          s = v.timers,
          o = v._data(this);
        if (n) o[n] && o[n].stop && i(o[n]);
        else
          for (n in o) o[n] && o[n].stop && Wn.test(n) && i(o[n]);
        for (n = s.length; n--;) s[n].elem === this && (e == null || s[n].queue === e) && (s[n].anim.stop(r), t = !1, s.splice(n, 1));
        (t || !r) && v.dequeue(this, e)
      })
    }
  }), v.each({
    slideDown: Zn("show"),
    slideUp: Zn("hide"),
    slideToggle: Zn("toggle"),
    fadeIn: {
      opacity: "show"
    },
    fadeOut: {
      opacity: "hide"
    },
    fadeToggle: {
      opacity: "toggle"
    }
  }, function(e, t) {
    v.fn[e] = function(e, n, r) {
      return this.animate(t, e, n, r)
    }
  }), v.speed = function(e, t, n) {
    var r = e && typeof e == "object" ? v.extend({}, e) : {
      complete: n || !n && t || v.isFunction(e) && e,
      duration: e,
      easing: n && t || t && !v.isFunction(t) && t
    };
    r.duration = v.fx.off ? 0 : typeof r.duration == "number" ? r.duration : r.duration in v.fx.speeds ? v.fx.speeds[r.duration] : v.fx.speeds._default;
    if (r.queue == null || r.queue === !0) r.queue = "fx";
    return r.old = r.complete, r.complete = function() {
      v.isFunction(r.old) && r.old.call(this), r.queue && v.dequeue(this, r.queue)
    }, r
  }, v.easing = {
    linear: function(e) {
      return e
    },
    swing: function(e) {
      return .5 - Math.cos(e * Math.PI) / 2
    }
  }, v.timers = [], v.fx = Yn.prototype.init, v.fx.tick = function() {
    var e, n = v.timers,
      r = 0;
    qn = v.now();
    for (; r < n.length; r++) e = n[r], !e() && n[r] === e && n.splice(r--, 1);
    n.length || v.fx.stop(), qn = t
  }, v.fx.timer = function(e) {
    e() && v.timers.push(e) && !Rn && (Rn = setInterval(v.fx.tick, v.fx.interval))
  }, v.fx.interval = 13, v.fx.stop = function() {
    clearInterval(Rn), Rn = null
  }, v.fx.speeds = {
    slow: 600,
    fast: 200,
    _default: 400
  }, v.fx.step = {}, v.expr && v.expr.filters && (v.expr.filters.animated = function(e) {
    return v.grep(v.timers, function(t) {
      return e === t.elem
    }).length
  });
  var er = /^(?:body|html)$/i;
  v.fn.offset = function(e) {
    if (arguments.length) return e === t ? this : this.each(function(t) {
      v.offset.setOffset(this, e, t)
    });
    var n, r, i, s, o, u, a, f = {
        top: 0,
        left: 0
      },
      l = this[0],
      c = l && l.ownerDocument;
    if (!c) return;
    return (r = c.body) === l ? v.offset.bodyOffset(l) : (n = c.documentElement, v.contains(n, l) ? (typeof l.getBoundingClientRect != "undefined" && (f = l.getBoundingClientRect()), i = tr(c), s = n.clientTop || r.clientTop || 0, o = n.clientLeft || r.clientLeft || 0, u = i.pageYOffset || n.scrollTop, a = i.pageXOffset || n.scrollLeft, {
      top: f.top + u - s,
      left: f.left + a - o
    }) : f)
  }, v.offset = {
    bodyOffset: function(e) {
      var t = e.offsetTop,
        n = e.offsetLeft;
      return v.support.doesNotIncludeMarginInBodyOffset && (t += parseFloat(v.css(e, "marginTop")) || 0, n += parseFloat(v.css(e, "marginLeft")) || 0), {
        top: t,
        left: n
      }
    },
    setOffset: function(e, t, n) {
      var r = v.css(e, "position");
      r === "static" && (e.style.position = "relative");
      var i = v(e),
        s = i.offset(),
        o = v.css(e, "top"),
        u = v.css(e, "left"),
        a = (r === "absolute" || r === "fixed") && v.inArray("auto", [o, u]) > -1,
        f = {},
        l = {},
        c, h;
      a ? (l = i.position(), c = l.top, h = l.left) : (c = parseFloat(o) || 0, h = parseFloat(u) || 0), v.isFunction(t) && (t = t.call(e, n, s)), t.top != null && (f.top = t.top - s.top + c), t.left != null && (f.left = t.left - s.left + h), "using" in t ? t.using.call(e, f) : i.css(f)
    }
  }, v.fn.extend({
    position: function() {
      if (!this[0]) return;
      var e = this[0],
        t = this.offsetParent(),
        n = this.offset(),
        r = er.test(t[0].nodeName) ? {
          top: 0,
          left: 0
        } : t.offset();
      return n.top -= parseFloat(v.css(e, "marginTop")) || 0, n.left -= parseFloat(v.css(e, "marginLeft")) || 0, r.top += parseFloat(v.css(t[0], "borderTopWidth")) || 0, r.left += parseFloat(v.css(t[0], "borderLeftWidth")) || 0, {
        top: n.top - r.top,
        left: n.left - r.left
      }
    },
    offsetParent: function() {
      return this.map(function() {
        var e = this.offsetParent || i.body;
        while (e && !er.test(e.nodeName) && v.css(e, "position") === "static") e = e.offsetParent;
        return e || i.body
      })
    }
  }), v.each({
    scrollLeft: "pageXOffset",
    scrollTop: "pageYOffset"
  }, function(e, n) {
    var r = /Y/.test(n);
    v.fn[e] = function(i) {
      return v.access(this, function(e, i, s) {
        var o = tr(e);
        if (s === t) return o ? n in o ? o[n] : o.document.documentElement[i] : e[i];
        o ? o.scrollTo(r ? v(o).scrollLeft() : s, r ? s : v(o).scrollTop()) : e[i] = s
      }, e, i, arguments.length, null)
    }
  }), v.each({
    Height: "height",
    Width: "width"
  }, function(e, n) {
    v.each({
      padding: "inner" + e,
      content: n,
      "": "outer" + e
    }, function(r, i) {
      v.fn[i] = function(i, s) {
        var o = arguments.length && (r || typeof i != "boolean"),
          u = r || (i === !0 || s === !0 ? "margin" : "border");
        return v.access(this, function(n, r, i) {
          var s;
          return v.isWindow(n) ? n.document.documentElement["client" + e] : n.nodeType === 9 ? (s = n.documentElement, Math.max(n.body["scroll" + e], s["scroll" + e], n.body["offset" + e], s["offset" + e], s["client" + e])) : i === t ? v.css(n, r, i, u) : v.style(n, r, i, u)
        }, n, o ? i : t, o, null)
      }
    })
  }), e.jQuery = e.$ = v, typeof define == "function" && define.amd && define.amd.jQuery && define("jquery", [], function() {
    return v
  })
})(window);
var dialog = {
  zorder: 1,
  zOrderDefault: 10000,
  close: function(name, options) {
    if (name === 'printPreview' && libPrint && libPrint.initItems !== null && libPrint.initItems.removeHeaderButtons) {
      for (let i = 0; i < libPrint.initItems.removeHeaderButtons.length; i++) {
        if (libPrint.initItems.removeHeaderButtons[i] == '#printButtonCsv') {
          $(".printPreview-wrapper " + libPrint.initItems.removeHeaderButtons[i]).show();
          break;
        }
      }
    }
    var callback = undefined;
    var afterClose = undefined;
    var clearDialog = function(c) {
      if ($("#{0}-remoteSource".format(name)).length > 0) {
        if ($("#{0}-remoteSource".format(name)).attr('data-reload-source') == 'yes') {
          $("#{0}-content-html".format(name)).html("");
        }
      } else if (options !== undefined) {
        if (options.clear && options.clear === true) {
          $("#{0}-content-html".format(name)).html("");
        }
      }
      c();
    };
    var afterClear = function() {
      $("#{0}".format(name)).hide();
      $("#{0}-overlay".format(name)).hide();
    };
    if (options !== undefined) {
      if (options.callback) {
        callback = options.callback;
      }
      if (options.afterClose) {
        afterClose = options.afterClose;
      }
    }
    if (callback !== undefined) {
      if (callback() === true) {
        clearDialog(afterClear);
      }
    } else {
      clearDialog(afterClear);
    }
    if (afterClose !== undefined) {
      afterClose();
    }
  },
  open: function(name, options) {
    if (!dialog.assetsLoaded(name, options, function() {
        dialog.open(name, options);
      })) return;
    var callback = undefined;
    var afterOpen = undefined;
    var nextZOrderDialog = 0;
    var nextZOrderOverlay = 0;
    var params = {};
    var requestUrl = undefined;
    if (options !== undefined) {
      if (options.callback) {
        callback = options.callback;
      }
      if (options.requestParams) {
        params = options.requestParams;
      }
      if (options.afterOpen) {
        afterOpen = options.afterOpen;
      }
      if (options.requestUrl) {
        requestUrl = options.requestUrl;
      }
    }
    var makeRequest = function(c) {
      if ($("#{0}-remoteSource".format(name)).length > 0) {
        if ($("#{0}-remoteSource".format(name)).attr('data-reload-source') == 'yes' || $("#{0}-remoteSource".format(name)).attr('data-source-loaded') == 'no') {
          var url = $("#{0}-remoteSource".format(name)).attr('data-source');
          app.busy();
          $.post(url, {
            data: params
          }, function(response) {
            $("#{0}-remoteSource".format(name)).attr('data-source-loaded', 'yes');
            $("#{0}-content-html".format(name)).html(response);
            app.free();
            c();
          });
        } else {
          c();
        }
      } else if (requestUrl !== undefined) {
        app.busy();
        if (options.requestData) {
          $.post(requestUrl, {
            data: options.requestData
          }, function(response) {
            $("#{0}-content-html".format(name)).html(response);
            app.free();
            c();
          });
        } else {
          $.get(requestUrl, function(response) {
            $("#{0}-content-html".format(name)).html(response);
            app.free();
            c();
          });
        }
      } else {
        c();
      }
    };
    var afterRequest = function() {
      dialog.zorder++;
      nextZOrderDialog = parseInt(dialog.zOrderDefault) + parseInt(dialog.zorder);
      nextZOrderOverlay = parseInt(dialog.zOrderDefault) + parseInt(dialog.zorder);
      $("#{0}".format(name)).css('z-index', nextZOrderDialog);
      $("#{0}-overlay".format(name)).css('z-index', nextZOrderOverlay);
      $("#{0}".format(name)).show();
      $("#{0}-overlay".format(name)).show();
      if (afterOpen !== undefined) {
        afterOpen();
      }
    };
    if (callback !== undefined) {
      if (callback() === true) {
        makeRequest(afterRequest);
      }
    } else {
      makeRequest(afterRequest);
    }
    if (name == 'printPreviewDownload') {
      $("#printPreviewDownload").absoluteCenterHeight();
    }
  },
  getNextZIndex: function() {
    dialog.zorder++;
    return parseInt(dialog.zOrderDefault) + parseInt(dialog.zorder);
  },
  confirm: function(message, confirmAction, cancelAction, closeAction, okText, cancelText) {
    if (typeof $.ui != 'undefined' && !app.isMobile) {
      if ($('#standard-confirm-dialog').length < 1) {
        $('body').append('<div id="standard-confirm-dialog"><p></p></div>');
      }
      const confirmTextBlock = $('#standard-confirm-dialog p');
      confirmTextBlock.html('');
      message.split(/(?:\r\n|\r|\n)/g).forEach((line, index) => {
        let text = document.createTextNode(line);
        index > 0 ? confirmTextBlock.append('<br/>') : null;
        confirmTextBlock.append(text);
      });
      dialog.setHighestZIndex();
      $('#standard-confirm-dialog').on('dialogopen', function(event, ui) {
        if (closeAction !== undefined) {
          var closeButton = $('.standard-confirm-dialog-parent .ui-dialog-titlebar-close');
          if (!closeButton.length) {
            closeButton = $('.standard-confirm-dialog-parent .ui-icon-closethick');
          }
          closeButton.on('click', function() {
            if (typeof closeAction == 'function') closeAction();
          }).bind(this);
        }
        $(".ui-widget-overlay").css({
          'background': "#000000",
          'opacity': '.35',
          'filter': 'Alpha(Opacity=35)',
          'z-index': dialog.getNextZIndex()
        });
        $('.standard-confirm-dialog-parent').zIndex(dialog.getNextZIndex());
        $('.standard-confirm-dialog-parent .ui-icon-closethick').css({
          'margin': '0',
          'top': '0',
          'left': '0'
        });
        $('.standard-confirm-dialog-parent .ui-dialog-buttonpane button').css({
          'float': 'right',
          'padding': '.2em .6em .3em .6em'
        });
      });
      $('#standard-confirm-dialog').dialog({
        position: {
          my: 'top',
          at: 'top+150'
        },
        autoOpen: true,
        modal: true,
        closeOnEscape: true,
        width: 400,
        dialogClass: 'standard-confirm-dialog-parent',
        buttons: [{
          text: okText || "Ok",
          click: function() {
            $(this).dialog("close");
            if (typeof confirmAction == 'function') confirmAction();
          }
        }, {
          text: cancelText || "Cancel",
          click: function() {
            $(this).dialog("close");
            if (typeof cancelAction == 'function') cancelAction();
          }
        }]
      });
    } else {
      message = message.replace(/\<br\>|\<br\/\>|\<\/br\>|\<br \/\>/gi, '\n').replace(/<(?:.|\n)*?>/gm, '');
      if (confirm(message) && typeof confirmAction == 'function') confirmAction();
    }
  },
  alert: function(message, okAction) {
    if (typeof $.ui != 'undefined' && !app.isMobile) {
      if ($('#standard-alert-dialog').length < 1) {
        $('body').append('<div id="standard-alert-dialog"></div>');
      }
      message = message.replace(/(?:\r\n|\r|\n)/g, '<br/>');
      $('#standard-alert-dialog').html('<p>' + message + '</p>');
      dialog.setHighestZIndex();
      $('#standard-alert-dialog').on('dialogopen', function(event, ui) {
        $(".ui-widget-overlay").css({
          'background': "#000000",
          'opacity': '.35',
          'filter': 'Alpha(Opacity=35)',
          'z-index': dialog.getNextZIndex()
        });
        $('.standard-alert-dialog-parent').zIndex(dialog.getNextZIndex());
        $('.standard-alert-dialog-parent .ui-icon-closethick').css({
          'margin': '0',
          'top': '0',
          'left': '0'
        });
        $('.standard-alert-dialog-parent .ui-dialog-buttonpane button').css({
          'float': 'right',
          'padding': '.2em .6em .3em .6em'
        });
      });
      $('#standard-alert-dialog').dialog({
        position: {
          my: 'top',
          at: 'top+150',
          of: 'body'
        },
        autoOpen: true,
        modal: true,
        closeOnEscape: true,
        width: 300,
        dialogClass: 'standard-alert-dialog-parent',
        close: function() {
          if (okAction !== undefined) {
            okAction();
          }
        },
        buttons: [{
          text: "Ok",
          click: function() {
            $(this).dialog("close");
          }
        }]
      });
    } else {
      message = message.replace(/\<br\>|\<br\/\>|\<\/br\>|\<br \/\>/gi, '\n').replace(/<(?:.|\n)*?>/gm, '');
      alert(message);
    }
  },
  setHighestZIndex: function() {
    var index_highest = 0;
    $("*:visible").each(function() {
      if ($.inArray($(this).attr('id'), ['loading']) == -1) {
        var index_current = parseInt($(this).css("zIndex"), 10);
        if (index_current > index_highest) {
          index_highest = index_current;
        }
      }
    });
    if (index_highest > dialog.zOrderDefault) {
      dialog.zorder = index_highest - dialog.zOrderDefault;
    }
  },
  assetsLoaded: function(name, options, callback) {
    var assets = $("#{0}".format(name)).attr('data-lazyload');
    if (typeof assets == 'undefined' || assets == null || assets == '' || typeof LazyLoader == 'undefined') return true;
    $("#{0}".format(name)).removeAttr('data-lazyload');
    LazyLoader.load(assets, callback);
  },
  sorryTryAgain: function() {
    this.alert("Sorry, an error has occurred. Please try again.");
  }
};
(function($) {
  var defaultOptions = {
    makeClone: false,
    sourceClass: null,
    sourceHide: false,
    dragClass: null,
    canDropClass: null,
    dropClass: null,
    isActive: true,
    container: null,
    appendDraggedTo: null,
    canDrag: function($src, e) {
      return $src;
    },
    canDrop: function($dst) {
      return $dst.hasClass("drop") || $dst.parents(".drop").size() > 0;
    },
    didDrop: function($src, $dst, e) {
      $src.appendTo($dst);
    },
    afterDrop: function($scr, $dst, e) {},
    didDropOut: function(e, $activeElement, $originalElement, didMove) {},
    onMove: function(e, $activeElement) {},
    onScroll: function() {},
    beforeDrop: function($sourceElement, $destElement, $activeElement, e, didMove) {},
    getDropTarget: function($activeElement, posX, posY) {
      $activeElement.css("display", "none");
      var destElement = document.elementFromPoint(posX - document.documentElement.scrollLeft - document.body.scrollLeft, posY - document.documentElement.scrollTop - document.body.scrollTop);
      $activeElement.css("display", "");
      return destElement;
    }
  };
  var $sourceElement = null;
  var $activeElement = null;
  var $destElement = null;
  var $originalElement = null;
  var dragOffsetX, dragOffsetY;
  var startX, startY;
  var didMove;
  var limits;

  function cancelDestElement(options) {
    if ($destElement != null) {
      if (options.dropClass)
        $('.' + options.dropClass).removeClass(options.dropClass);
      $destElement = null;
    }
    if ($activeElement != null) {
      if (options.canDropClass) {
        $activeElement.removeClass(options.canDropClass);
      }
    }
  }
  var methods = {
    init: function(options) {
      options = $.extend({}, defaultOptions, options);
      this.data("options", options);
      this.bind("mousedown.dragdrop touchstart.dragdrop", methods.onStart);
      return this;
    },
    destroy: function() {
      this.unbind("mousedown.dragdrop touchstart.dragdrop");
      return this;
    },
    on: function() {
      this.data("options").isActive = true;
    },
    off: function() {
      this.data("options").isActive = false;
    },
    onStart: function(e) {
      var $me = $(this);
      var options = $me.data("options");
      if (!options.isActive)
        return;
      if ($activeElement)
        return;
      if (e.touches && e.touches.length > 1)
        return;
      $originalElement = $me;
      var $element = options.canDrag($me, e);
      if ($element) {
        $sourceElement = $element;
        var offset = $sourceElement.offset();
        var width = $sourceElement.width();
        var height = $sourceElement.height();
        if (e.type == "touchstart") {
          dragOffsetX = e.originalEvent.touches[0].clientX - offset.left;
          dragOffsetY = e.originalEvent.touches[0].clientY - offset.top;
          startX = e.originalEvent.touches[0].clientX;
          startY = e.originalEvent.touches[0].clientY;
        } else {
          dragOffsetX = e.pageX - offset.left;
          dragOffsetY = e.pageY - offset.top;
          startX = e.pageX;
          startY = e.pageY;
        }
        didMove = false;
        if (options.makeClone) {
          $activeElement = $sourceElement.clone(false);
          $activeElement.appendTo((options.appendDraggedTo !== null) ? options.appendDraggedTo : $element.parent());
          if (options.sourceClass)
            $sourceElement.addClass(options.sourceClass);
          else if (options.sourceHide)
            $sourceElement.css("visibility", "hidden");
        } else {
          $activeElement = $sourceElement;
        }
        $activeElement.css({
          position: "absolute",
          left: offset.left,
          top: offset.top,
          width: width,
          height: height
        });
        if (options.dragClass)
          $activeElement.addClass(options.dragClass);
        var $c = options.container;
        if ($c) {
          var offset = $c.offset();
          limits = {
            minX: offset.left,
            minY: offset.top,
            maxX: offset.left + $c.outerWidth() - $element.outerWidth(),
            maxY: offset.top + $c.outerHeight() - $element.outerHeight()
          };
        }
        $(document).bind("mousemove.dragdrop touchmove.dragdrop", {
          source: $me
        }, methods.onMove).bind("mouseup.dragdrop touchend.dragdrop", {
          source: $me
        }, methods.onEnd);
        e.stopPropagation();
        return false;
      }
    },
    onMove: function(e) {
      if (!$activeElement)
        return;
      var $me = e.data.source;
      var options = $me.data("options");
      var posX, posY;
      if (e.type == "touchmove") {
        posX = e.originalEvent.touches[0].clientX;
        posY = e.originalEvent.touches[0].clientY;
      } else {
        posX = e.pageX;
        posY = e.pageY;
      }
      var destElement = options.getDropTarget($activeElement, posX, posY);
      if (!didMove) {
        didMove = ((Math.abs(startX - posX) > 0) || (Math.abs(startY - posY) > 0));
      }
      posX -= dragOffsetX;
      posY -= dragOffsetY;
      if (limits) {
        if (posY < limits.minY || posY > limits.maxY) {
          var $c = options.container;
          var st = $c.scrollTop();
          if (posY < limits.minY) {
            var dt = limits.minY - posY;
            if (st > 0) {
              $c.scrollTop(st > dt ? st - dt : 0);
              options.onScroll();
            }
          } else {
            var dt = posY - limits.maxY;
            var oh = $c.outerHeight();
            var sh = $c[0].scrollHeight;
            if ((st + oh) < sh) {
              $c.scrollTop(((st + oh + dt) < sh) ? (st + dt) : (sh - oh));
              options.onScroll();
            }
          }
        }
        posX = Math.min(Math.max(posX, limits.minX), limits.maxX);
        posY = Math.min(Math.max(posY, limits.minY), limits.maxY);
      }
      $activeElement.css({
        left: posX,
        top: posY
      });
      if (destElement) {
        if ($destElement == null || $destElement.get(0) != destElement) {
          var $possibleDestElement = $(destElement);
          if (options.canDrop($possibleDestElement)) {
            if (options.dropClass) {
              if ($destElement != null)
                $('.' + options.dropClass).removeClass(options.dropClass);
              (options.parentClass ? $possibleDestElement.closest('.' + options.parentClass) : $possibleDestElement).addClass(options.dropClass);
            }
            if (options.canDropClass) {
              $activeElement.addClass(options.canDropClass);
            }
            $destElement = $possibleDestElement;
          } else if ($destElement != null) {
            cancelDestElement(options);
          }
        }
      } else if ($destElement != null) {
        cancelDestElement(options);
      }
      options.onMove(e, $activeElement);
      e.stopPropagation();
      return false;
    },
    onEnd: function(e) {
      if (!$activeElement)
        return;
      var $me = e.data.source;
      var options = $me.data("options");
      if ($destElement) {
        options.didDrop($sourceElement, $destElement, e);
      }
      options.beforeDrop($sourceElement, $destElement, $activeElement, e, didMove);
      cancelDestElement(options);
      if (options.makeClone) {
        $activeElement.remove();
        if (options.sourceClass)
          $sourceElement.removeClass(options.sourceClass);
        else if (options.sourceHide)
          $sourceElement.css("visibility", "visible");
      } else {
        $activeElement.css("position", "static");
        $activeElement.css("width", "");
        $activeElement.css("height", "");
        if (options.dragClass)
          $activeElement.removeClass(options.dragClass);
        if ($destElement == null)
          options.didDropOut(e, $activeElement, $originalElement, didMove);
      }
      $(document).unbind("mousemove.dragdrop touchmove.dragdrop");
      $(document).unbind("mouseup.dragdrop touchend.dragdrop");
      options.afterDrop($sourceElement, $destElement, e);
      $sourceElement = $activeElement = limits = null;
    }
  };
  $.fn.dragdrop = function(method) {
    if (methods[method]) {
      return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
    } else if (typeof method === 'object' || !method) {
      return methods.init.apply(this, arguments);
    } else {
      $.error('Method ' + method + ' does not exist on jQuery.dragdrop');
    }
  };
})(jQuery);
var ServerClass = function(params) {
  this.lab = function() {
    return params['lab'];
  };
  this.basePath = params['basePath'];
  this.ajaxFailRetry = ('ajaxFailRetry' in params) ? params['ajaxFailRetry'] : 3;
  this.skey = ('skey' in params) ? params['skey'] : null;
  this.reqIDFields = ('reqIDFields' in params) ? params['reqIDFields'] : ['answers', 'ping', 'end', 'save', 'arrProblemAnswer'];
  this.pingInterval = ('pingInterval' in params) ? params['pingInterval'] : 600000;
  this.deferredCalls = null;
  this.callDeferred = false;
  var _this = this;
  if (this.pingInterval > 0)
    setInterval(function() {
      _this.ping();
    }, _this.pingInterval);
  this.isIOS = /iPad|iPhone|iPod/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
};
ServerClass.prototype.ajaxCall = function(url, params) {
  var _this = this;
  var ajaxParam = {
    dataType: 'json',
    cache: false,
    retryCount: 0,
    success: function(data, textStatus, jqXHR) {
      var deferred = ('deferred' in params) ? params['deferred'] : false;
      if (_this.callDeferred) deferred = false;
      if (_this.isIOS && params.preload === true && typeof params.getAudioFiles === 'function' && typeof data.command['setUpProblem'] !== "object") {
        MobyLoader.showMobyLoader(params.getAudioFiles(data), function() {
          _this.onDataSuccess(data, textStatus, jqXHR, deferred);
          if ('callback' in params) {
            var callbackparam = {};
            if ('callbackparam' in params) callbackparam = params['callbackparam'];
            params['callback'].call(_this.lab(), callbackparam);
          }
        });
      } else {
        _this.onDataSuccess(data, textStatus, jqXHR, deferred);
        if ('callback' in params) {
          var callbackparam = {};
          if ('callbackparam' in params) callbackparam = params['callbackparam'];
          params['callback'].call(_this.lab(), callbackparam);
        }
      }
    },
    error: function(jqXHR, textStatus, errorThrown) {
      this.retryCount++;
      if (this.retryCount <= _this.ajaxFailRetry) {
        $.ajax(this);
        return;
      }
    }
  };
  for (p in params)
    ajaxParam[p] = params[p];
  if (!ajaxParam['data']) ajaxParam['data'] = {};
  if ((!('ping' in ajaxParam['data'])) && (!('IsReadAloudStudent' in ajaxParam['data']))) {
    this.deferredCalls = null;
    this.callDeferred = false;
  }
  if (this.skey != '') ajaxParam['data']['skey'] = this.skey;
  ajaxParam['data']['callID'] = Math.floor((Math.random() * 999999) + 1);
  url = this.reqID(url, ajaxParam);
  if ((ajaxParam.async === false || (ajaxParam.data.logout && ajaxParam.data.logout < 0)) && !window.document.documentMode && window.navigator.sendBeacon) {
    window.navigator.sendBeacon(this.basePath + url, $.param(ajaxParam.data));
  } else {
    $.ajax(this.basePath + url, ajaxParam);
  }
};
ServerClass.prototype.reqID = function(url, params) {
  if ('type' in params) {
    if (params['type'] == 'POST') {
      url += '?_=' + Math.floor((Math.random() * 9999) + 1);
      if (this.lab().mode) url += '&mode=' + this.lab().mode;
      if (params['data']['skey']) url += '&skey=' + params['data']['skey'];
      if (params['data']['callID']) url += '&callID=' + params['data']['callID'];
      var extra = '';
      for (var i = 0; i < this.reqIDFields.length; i++)
        if (params['data'][this.reqIDFields[i]]) {
          extra += (extra.length > 0) ? '-' : '';
          extra += this.reqIDFields[i];
        }
      url += '&reqid=' + extra;
    }
  }
  return url;
};
ServerClass.prototype.onDataSuccess = function(data, textStatus, jqXHR, deferred) {
  if (data) {
    if (data['data']) {
      for (var dataindex in data['data'])
        if (this.lab().hasOwnProperty(dataindex))
          this.lab()[dataindex] = data['data'][dataindex];
    }
    if (deferred) this.deferredCalls = data['command'];
    else this.executeCommands(data['command']);
  }
};
ServerClass.prototype.executeCommands = function(commands) {
  if (!commands) return;
  var labFunc;
  for (var cmdindex in commands) {
    if (cmdindex in this.lab()) {
      if (commands[cmdindex] != null) labFunc = this.lab()[cmdindex](commands[cmdindex]);
      else labFunc = this.lab()[cmdindex]();
      delete commands[cmdindex];
      if (typeof labFunc !== 'undefined') {
        this.deferredCalls = commands;
        return;
      }
    } else delete commands[cmdindex];
  }
};
ServerClass.prototype.executeDeferred = function() {
  this.executeCommands(this.deferredCalls);
};
ServerClass.prototype.waitForDeferred = function() {
  this.callDeferred = true;
  $('#loading').hide();
  if ((this.deferredCalls) && (!$.isEmptyObject(this.deferredCalls))) this.executeDeferred();
  else $('#loading').show();
};
ServerClass.prototype.ping = function() {
  this.ajaxCall('update', {
    type: 'POST',
    data: {
      mode: this.lab().mode,
      skey: this.skey,
      ping: true
    }
  });
};
var TimerClass = function(params) {
  $('body').append('<div id="lab-pause"><div class="overlay"></div><img src="https://data.mobymax.com/lab/lab/Pause.png" width="182" height="182" onclick="' + params['labName'] + '.timer.unPause();"/></div>');
  var _this = this;
  setInterval(function() {
    _this.idleTimerCallback();
  }, 1000);
  setInterval(function() {
    _this.timerCallback();
  }, 1000);
  var mouseX, mouseY;
  $(document).mousemove(function(evt) {
    if (evt.clientX != mouseX || evt.clientY != mouseY) {
      _this.idleActive();
      mouseX = evt.clientX;
      mouseY = evt.clientY;
    }
  });
  $(document).keypress(function() {
    _this.idleActive();
  });
  $(document).on("touchstart touchend", function() {
    _this.idleActive();
  });
  this.idleSeconds = ('idleSeconds' in params) ? params['idleSeconds'] : 120;
  this.studentIdle = false;
  this.canPause = true;
  this.idleTimer = 0;
  this.timerActive = true;
  this.timerCounter = 0;
  this.timers = {};
  this.callbackfunctions = {};
  this.labName = params.labName;
};
TimerClass.prototype.idleTimerCallback = function() {
  if (!this.studentIdle && this.canPause) {
    if (++this.idleTimer >= this.idleSeconds) {
      this.studentIdle = true;
      $('#lab-pause').show();
      this.timerPause();
      $(document).trigger('pause.' + this.labName);
    }
  }
}
TimerClass.prototype.timerCallback = function() {
  if (this.timerActive) {
    this.timerCounter++;
    for (var i in this.timers) {
      this.timers[i]++;
      if (typeof this.callbackfunctions[i] !== 'undefined') {
        this.callbackfunctions[i].call(this, this.timers[i]);
      }
    }
  }
}
TimerClass.prototype.idleActive = function() {
  this.idleTimer = 0;
}
TimerClass.prototype.unPause = function() {
  this.idleTimer = 0;
  if (this.studentIdle) {
    this.studentIdle = false;
    $('#lab-pause').hide();
    this.timerUnpause();
    $(document).trigger('resume.' + this.labName);
  }
}
TimerClass.prototype.Start = function(timerName) {
  var _this = this;
  var startValue = (arguments.length > 2) ? arguments[2] : 0;
  if (!timerName) this.timerCounter = startValue;
  else this.timers[timerName] = startValue;
  if (arguments.length > 1) {
    _this.callbackfunctions[timerName] = arguments[1];
  }
}
TimerClass.prototype.timerPause = function() {
  this.timerActive = false;
}
TimerClass.prototype.timerUnpause = function() {
  this.timerActive = true;
}
TimerClass.prototype.GetTime = function(timerName) {
  if (!timerName) return this.timerCounter;
  else return (timerName in this.timers) ? this.timers[timerName] : 0;
};
TimerClass.prototype.RemoveTimer = function(timerName) {
  if (typeof this.timers[timerName] !== 'undefined') {
    delete(this.timers[timerName]);
    delete(this.callbackfunctions[timerName]);
  }
};;
(function($) {
  $.timer = function(func, time, autostart) {
    this.set = function(func, time, autostart) {
      this.init = true;
      if (typeof func == 'object') {
        var paramList = ['autostart', 'time'];
        for (var arg in paramList) {
          if (func[paramList[arg]] != undefined) {
            eval(paramList[arg] + " = func[paramList[arg]]");
          }
        };
        func = func.action;
      }
      if (typeof func == 'function') {
        this.action = func;
      }
      if (!isNaN(time)) {
        this.intervalTime = time;
      }
      if (autostart && !this.isActive) {
        this.isActive = true;
        this.setTimer();
      }
      return this;
    };
    this.once = function(time) {
      var timer = this;
      if (isNaN(time)) {
        time = 0;
      }
      window.setTimeout(function() {
        timer.action();
      }, time);
      return this;
    };
    this.play = function(reset) {
      if (!this.isActive) {
        if (reset) {
          this.setTimer();
        } else {
          this.setTimer(this.remaining);
        }
        this.isActive = true;
      }
      return this;
    };
    this.pause = function() {
      if (this.isActive) {
        this.isActive = false;
        this.remaining -= new Date() - this.last;
        this.clearTimer();
      }
      return this;
    };
    this.stop = function() {
      this.isActive = false;
      this.remaining = this.intervalTime;
      this.clearTimer();
      return this;
    };
    this.toggle = function(reset) {
      if (this.isActive) {
        this.pause();
      } else if (reset) {
        this.play(true);
      } else {
        this.play();
      }
      return this;
    };
    this.reset = function() {
      this.isActive = false;
      this.play(true);
      return this;
    };
    this.clearTimer = function() {
      window.clearTimeout(this.timeoutObject);
    };
    this.setTimer = function(time) {
      var timer = this;
      if (typeof this.action != 'function') {
        return;
      }
      if (isNaN(time)) {
        time = this.intervalTime;
      }
      this.remaining = time;
      this.last = new Date();
      this.clearTimer();
      this.timeoutObject = window.setTimeout(function() {
        timer.go();
      }, time);
    };
    this.isTimerActive = function() {
      return this.isActive;
    };
    this.go = function() {
      if (this.isActive) {
        this.action();
        this.setTimer();
      }
    };
    if (this.init) {
      return new $.timer(func, time, autostart);
    } else {
      this.set(func, time, autostart);
      return this;
    }
  };
})(jQuery);
var SoundClass = function(params) {
  var _this = this;
  this.IsReadAloudTeacher = params['IsReadAloudTeacher'];
  this.IsReadAloudStudent = ('IsReadAloudStudent' in params) ? params['IsReadAloudStudent'] : 2;
  this.soundMessage = params['soundMessage'];
  this.soundStatus = -1;
  this.canPlaySound = false;
  this.soundFile = '';
  this.stoppedPlaying = false;
  this.preloadedSounds = {};
  this.onReady = (params.onReady !== undefined ? params.onReady : function() {});
  this.soundLoadedPromise = $.Deferred();
  soundManager.setup({
    debugMode: false,
    url: '/MM/css/lab/swf/',
    flashVersion: 8,
    useFlashBlock: false,
    flashLoadTimeout: 40000,
    allowScriptAccess: 'always',
    noSWFCache: true,
    preferFlash: ('msie' in $.browser),
    ontimeout: function(status) {
      if (status.type == 'NO_FLASH') _this.soundStatus = 4;
      else if (status.type == 'INIT_TIMEOUT' && FlashDetect.major < 9) _this.soundStatus = 5;
      else _this.soundStatus = 7;
      _this.soundLoadedPromise.reject();
    },
    onready: function() {
      _this.onSoundReady();
      _this.onReady();
      _this.soundLoadedPromise.resolve();
    }
  });
};
SoundClass.prototype.onSoundReady = function() {
  this.soundStatus = 0;
  this.canPlaySound = true;
  if (this.soundFile != '') this.playFile(this.soundFile);
};
SoundClass.prototype.playFile = function(url, pause) {
  var _this = this;
  if (!this.stoppedPlaying) {
    if (((this.IsReadAloudTeacher) && (this.IsReadAloudStudent > 0)) || window.EarlyLab !== undefined) {
      if (this.soundStatus == -1) this.soundFile = url;
      else {
        if (this.canPlaySound) {
          this.stopPlay();
          soundManager.createSound({
            id: 'vSound',
            url: url,
            onload: function(bSuccess) {
              _this.soundStatus = bSuccess ? 1 : 6;
            }
          });
          soundManager.play('vSound', {
            onfinish: function() {
              $(document).trigger('soundManager.soundFinishedPlaying');
            }
          });
          if ((arguments.length > 1) && pause) soundManager.pause('vSound');
        }
      }
    }
  } else {
    this.stoppedPlaying = false;
  }
};
SoundClass.prototype.playMimicRV = function(url, onstart, onend) {
  soundManager.destroySound('rvSound');
  soundManager.createSound({
    id: 'rvSound',
    url: url,
    onplay: onstart,
    onfinish: onend
  });
  soundManager.play('rvSound');
};
SoundClass.prototype.playSoundPreloaded = function(url, callback) {
  var name = url;
  if (this.preloadedSounds[name] !== undefined && this.preloadedSounds[name].loaded == true) {
    var play = function() {
      soundManager.play(name);
    };
    if (callback !== undefined) {
      var duration = soundManager.getSoundById(name).duration === undefined ? 1000 : soundManager.getSoundById(name).duration;
      duration = duration == 0 || duration === undefined || duration === null || duration < 1000 ? 1000 : duration;
      if ((typeof window.nativeBridge != 'undefined' && window.nativeBridge.isSyncLockTablet() == true) || (window.navigator.userAgent.toLowerCase().indexOf('chrome') > 0 && window.navigator.userAgent.toLowerCase().indexOf('android') > 0)) {
        duration += 2000;
      }
      callback(true, soundManager.getSoundById(name).duration, play);
    } else {
      play();
    }
  } else {
    soundManager.destroySound('dynamicSound');
    var autoLoad = (typeof app.labInit !== 'undefined' && typeof app.labInit.isMobile !== 'undefined' && app.labInit.isMobile != '') ? false : true;
    options = {
      id: 'dynamicSound',
      url: url,
      autoLoad: autoLoad,
      onload: function(ok) {
        if (this.readyState === 3) {
          var duration = this.duration == 0 || this.duration === undefined || this.duration === null || this.duration < 1000 ? 1000 : this.duration;
          if ((typeof window.nativeBridge != 'undefined' && window.nativeBridge.isSyncLockTablet() == true) || (window.navigator.userAgent.toLowerCase().indexOf('chrome') > 0 && window.navigator.userAgent.toLowerCase().indexOf('android') > 0)) {
            duration += 2000;
          }
          var play = function() {
            soundManager.play('dynamicSound');
          };
          if (callback !== undefined) {
            callback(ok, duration, play);
          } else {
            if (ok) play();
          }
        } else {
          if (callback !== undefined) {
            callback(false, 1000, function() {});
          }
        }
      }
    };
    soundManager.createSound(options);
  }
};
SoundClass.prototype.playSoundPreloadedPromise = function(mp3, fallbackTime, callback) {
  this.playSoundPreloadedPromiseDeffer = $.Deferred();
  var resolveAfter = function(timeToWait) {
    this.playSoundPreloadedPromiseTimeout = setTimeout(function() {
      this.playSoundPreloadedPromiseDeffer.resolve();
      if (typeof callback !== 'undefined') {
        callback();
      }
    }.bind(this), timeToWait);
  }.bind(this);
  if (mp3) {
    if (isIOS() || navigator.userAgent.indexOf('CriOS') > -1) {
      this.playInitedSound(mp3);
      resolveAfter(fallbackTime);
    } else {
      this.playSoundPreloaded(mp3, function(ok, duration, play) {
        if (ok) {
          play();
          resolveAfter(duration);
        } else {
          this.playFile(mp3);
          resolveAfter(fallbackTime);
        }
      }.bind(this));
    }
  } else {
    resolveAfter(fallbackTime);
  }
  return this.playSoundPreloadedPromiseDeffer;
};
SoundClass.prototype.preloadSounds = function(sounds) {
  if (typeof app.labInit !== 'undefined' && typeof app.labInit.isMobile !== 'undefined' && app.labInit.isMobile != '') {
    return;
  }
  var _this = this;
  var loader = new PxLoader();
  var i, len, foundUnloaded = false;
  for (i = 0, len = sounds.length; i < len; i++) {
    if ((typeof this.preloadedSounds[sounds[i].name] != 'undefined') && (this.preloadedSounds[sounds[i].name].url == sounds[i].url))
      continue;
    loader.addSound(sounds[i].name, sounds[i].url);
    this.preloadedSounds[sounds[i].name] = {
      url: sounds[i].url,
      loaded: false
    };
    foundUnloaded = true;
  }
  if (foundUnloaded) {
    loader.addProgressListener(function(e) {
      if (e.timeout == true || e.error == true || e.loaded == false) {
        this.preloadedSounds[e.resource.sound.sID].loaded = false;
      } else {
        this.preloadedSounds[e.resource.sound.sID].loaded = true;
      }
    }.bind(this));
    loader.start();
  }
};
SoundClass.prototype.stopPlay = function() {
  if (typeof this.playSoundPreloadedPromiseTimeout === 'undefined') {
    this.playSoundPreloadedPromiseTimeout = null;
  }
  if (this.playSoundPreloadedPromiseTimeout) {
    clearTimeout(this.playSoundPreloadedPromiseTimeout);
    this.playSoundPreloadedPromiseTimeout = null;
  }
  if (typeof this.playSoundPreloadedPromiseDeffer === 'undefined') {
    this.playSoundPreloadedPromiseDeffer = null;
  }
  if (this.playSoundPreloadedPromiseDeffer) {
    this.playSoundPreloadedPromiseDeffer.reject();
  }
  if (this.canPlaySound) {
    this.soundFile = '';
    soundManager.destroySound('vSound');
    soundManager.destroySound('dynamicSound');
  } else {
    this.stoppedPlaying = true;
  }
};
SoundClass.prototype.setMessage = function() {
  if (this.IsReadAloudTeacher != 1) this.soundStatus = 2;
  $('#sound-settings .sound-diagnostic-fieldset .sound-diagnostic-text').html(this.soundMessage[this.soundStatus]);
  if (this.soundStatus === 2) {
    $('.sound-setting-fieldset').attr('disabled', 'disabled');
    $('.voice-section').hide();
    $('.word-highlighting-section').hide();
  }
};
var ScreenClass = function(mobyFriendUrls, subject, imageServer, percentComplete, percentCompleteLevel, subjectCss, onNextClickAction) {
  this.ScreenStart = 0;
  this.ScreenEndModule = 0;
  this.ScreenEndSession = 0;
  this.newBadge = null;
  this.mobyFriendsUrl = mobyFriendUrls || [];
  this.subject = subject || '';
  this.subjectCss = subjectCss || subject;
  this.subjectCss = this.subjectCss.toLowerCase();
  this.imageServer = imageServer || '';
  this.gameTimeEarned = 0;
  this.gameTimeTotal = 0;
  this.gameDialogShown = 0;
  this.gameDialogAutoCloseTimeout = null;
  this.badgeShown = 0;
  this.percentComplete = percentComplete || 0;
  this.percentCompleteLevel = percentCompleteLevel || 0;
  this.contestPoints = 0;
  this.badgePoints = 0;
  this.assignedTime = 0;
  this.sweepstakeTicketEarned = false;
  this.gameDialogAutoClose = true;
  this.gameDialogAutoCloseTime = 4000;
  this.onNextClickAction = onNextClickAction || function(e) {};
  this.showStartScreenGradeLabel = false;
  this.showProgress = true;
  this.forbiddenPathRedirectDefault = '/signin';
  $(document).on('click', '.standard-dialog-blue-cross', (function(e) {
    if (this.gameDialogAutoCloseTimeout) {
      clearTimeout(this.gameDialogAutoCloseTimeout);
      this.gameDialogAutoCloseTimeout = null;
    }
    this.resetScreenGameTimeEarned(e);
  }).bind(this));
  $(document).on('click', '.lab-screen-problem-close', (function() {
    this.onProblemMessageClose();
  }).bind(this));
  $(document).on('sweepstakes.ticketEarned', (function() {
    this.sweepstakeTicketEarned = true;
  }).bind(this));
  $(document).on('ajaxComplete', function(event, response, settings) {
    if (response.status == 403) {
      window.location.replace(this.forbiddenPathRedirectDefault);
    }
  }.bind(this));
  $(document).on('click', '.buttonBig', function(e) {
    if (!this.onNextClickAction || this.onNextClickAction === function(e) {} || this.onNextClickAction === function() {}) {
      $(document).trigger('screenClass.nextBtnClicked', [e]);
    }
    this.onNextClickAction(e);
  }.bind(this));
};
ScreenClass.prototype.commonScreen = function(params) {
  var tableHtml = '';
  if (params.table && params.table.length) {
    tableHtml += '<table class="lab-screen-table ' + (params.tableClass || '') + '">';
    for (var i = 0; i < params.table.length; i++) {
      var className = (params.table[i].className || '') + (params.table[i].highlight ? ' highlight' : '');
      tableHtml += '<tr ' + (className.length ? 'class="' + className + '"' : '') + '>\
                    <td class="fieldName">' + params.table[i].name + '</td>\
                    <td class="fieldValue">' + params.table[i].value + '</td>\
                </tr>';
    }
    tableHtml += '</table>';
  }
  var html = '<div class="lab-flowscreen lab-background ' + (params.screenClass || '') + '">\
        <div class="lab-screen-mobyfriend">\
            ' + this.getRandomMobyFriendImage(this.getRandomMobyFriendImageUrl(params.usePreviousMobyFriend)) + '\
            <div class="lab-screen-mobyfriend-content"><h1>' + (params.title || '') + '</h1></div>\
            ' + (params.headerContent || '') + '\
        </div>\
        <div class="lab-screen-content">\
            ' + (params.text ? ('<div class="lab-screen-text">' + params.text + '</div>') : '') + '\
            ' + (params.content || '') + '\
            ' + (params.tableTitle ? ('<h4 class="lab-screen-table-title">' + params.tableTitle + '</h4>') : '') + '\
            ' + tableHtml + '\
        </div>\
    </div>';
  return html;
};
ScreenClass.prototype.bubbleScreen = function(params) {
  var subjectAnimation = '';
  var animateClass = '';
  if (params.animated) {
    animateClass = ' animated';
    subjectAnimation = '<div class="titleSubject">\
                <img src="/MM/img/lab/screenClass/open-animation/' + this.subjectCss + '.gif"/>\
            </div>';
  }
  var additionalHeightSideClass = '';
  var additionalHeightContainerClass = '';
  if (params.additionalHeight === 1) {
    additionalHeightSideClass = ' bubble-container-side-additional-height-1';
    additionalHeightContainerClass = ' bubble-container-additional-height-1';
  }
  if (params.additionalHeight === 2) {
    additionalHeightSideClass = ' bubble-container-side-additional-height-2';
    additionalHeightContainerClass = ' bubble-container-additional-height-2';
  }
  return '<div class="lab-flowscreen ' + this.subjectCss + ' lab-background ' + (params.screenClass || '') + animateClass + '">\
        ' + this.getRandomMobyFriendImage(this.getRandomMobyFriendImageUrl()) + '\
        ' + subjectAnimation + '\
        <div class="lab-screen-bubble-content">\
            ' + (params.title ? ('<div class="lab-screen-bubble-title">' + params.title + '</div>') : '') + '\
            <div class="lab-screen-bubble">\
                <div class="lab-screen-bubble-top"><div></div></div>\
                <div class="lab-screen-bubble-container' + additionalHeightContainerClass + '">\
                    <div class="lab-screen-bubble-container-left' + additionalHeightSideClass + '"><div></div></div>\
                    <div class="lab-screen-bubble-container-right' + additionalHeightSideClass + '"><div></div></div>\
                    <div class="lab-screen-bubble-container-bottom"><div></div></div>\
                    ' + (params.bubbleTitle ? ('<div class="lab-screen-bubble-big-text lab-screen-bubble-score">' + params.bubbleTitle + '</div>') : '') + '\
                    <div class="lab-screen-bubble-items"><div>' + (params.bubbleContent || '') + '</div></div>\
                </div>\
            </div>\
            ' + (params.content || '') + '\
        </div>\
    </div>';
};
ScreenClass.prototype.messageScreen = function(params) {
  params.message = params.message || '';
  params.screenClass = params.screenClass || '';
  var subjectImage = '';
  if (params.animated) {
    subjectImage = '<div class="titleSubject">\
                <img src="/MM/img/lab/screenClass/open-animation/' + this.subjectCss + '.gif"/>\
            </div>';
  }
  var html = '<div class="lab-flowscreen lab-background screenBubble ' + params.screenClass + ' ' + this.subjectCss + (params.animated ? ' animatedstart' : '') + '">\
        ' + this.getRandomMobyFriendImage(this.getRandomMobyFriendImageUrl()) + '\
        ' + subjectImage + '\
        ' + ((params.message !== '') ? ('\
        <div class="lab-screen-messagebox-container">\
            <div class="lab-screen-messagebox">\
                <div>' + params.message + '</div>\
            </div>\
        </div>\
        ') : '') + '\
    </div>';
  return html;
};
ScreenClass.prototype.getRandomMobyFriendImageUrl = function(usePreviousMobyFriend) {
  if ((typeof this.mobyFriendsUrl[this.lastRandomMobyFriend] == undefined) || (typeof usePreviousMobyFriend == undefined || !usePreviousMobyFriend)) {
    this.lastRandomMobyFriend = Math.floor(Math.random() * this.mobyFriendsUrl.length);
  }
  return this.mobyFriendsUrl[this.lastRandomMobyFriend];
};
ScreenClass.prototype.getRandomMobyFriendImage = function(friend) {
  var i, p;
  var html = '<div class="lab-screen-mf">';
  for (i = 0; i < friend.length; i++) {
    html += '<img';
    for (p in friend[i]) {
      html += ' ' + p + '="' + friend[i][p] + '"';
    }
    html += '/>';
  }
  html += '</div>';
  return html;
};
ScreenClass.prototype.setBadge = function(badge) {
  this.newBadge = badge;
};
ScreenClass.prototype.setShowStartScreenGradeLabel = function(show) {
  this.showStartScreenGradeLabel = show;
};
ScreenClass.prototype.setShowProgress = function(show) {
  this.showProgress = show;
};
ScreenClass.prototype.getStartScreen = function(progressItems, isBar, text, title, bubbleTitle, animated) {
  var gradeLevelBlock = '';
  var progressScreen = null;
  var text = text || null;
  isBar = typeof isBar == 'undefined' ? true : isBar;
  if (typeof progressItems == 'undefined') {
    var gradeLevel = this.percentCompleteLevel;
    if (gradeLevel == 0) {
      gradeLevel = 'K';
    }
    var gradeTitle = 'Grade Level ' + gradeLevel;
    var progressObject = {
      percentComplete: this.percentComplete,
      title: gradeTitle,
      showTitle: this.showStartScreenGradeLabel
    };
    progressScreen = this.getProgressScreen([progressObject], isBar);
  } else {
    progressScreen = this.getProgressScreen(progressItems, isBar)
  }
  if (!this.showProgress) {
    progressScreen = '';
  }
  if (isBar) {
    return this.messageScreen({
      message: '<div>Let\'s go!</div><div class="titleBox">' + progressScreen + '</div>',
      animated: true,
      screenClass: 'start-screen-message-bar'
    });
  }
  return this.bubbleScreen({
    screenClass: 'lab-screen-start screenStart',
    title: title || '',
    bubbleTitle: bubbleTitle,
    bubbleContent: text,
    content: progressScreen,
    animated: animated
  });
};
ScreenClass.prototype.showScreenStart = function() {
  this.resetScreenStart();
  var html = this.getStartScreen();
  $('.lab-problem').html(html);
  this.setProgress(this.percentComplete);
  this.screenModeOn();
};
ScreenClass.prototype.setProgress = function(percent) {
  var graph = percent >= 96 ? 96 : percent;
  var graphNumber = graph - 3;
  if (graph < 1) {
    graphNumber = graph - 2;
  }
  $('.progress .full').css('width', graph + '%');
  $('.progress .count').css('left', (graphNumber) + '%');
};
ScreenClass.prototype.hideNextButton = function() {
  $('.lab-next').hide();
};
ScreenClass.prototype.resetScreenStart = function() {
  this.ScreenStart = 0;
  $(document).trigger('screen.resetScreenStart', this.ScreenStart);
};
ScreenClass.prototype.resetScreenSession = function() {
  this.ScreenEndSession = 1;
  $(document).trigger('screen.resetScreenSession', this.ScreenEndSession);
};
ScreenClass.prototype.resetScreenEnd = function() {
  this.ScreenEndModule = 1;
  $(document).trigger('screen.resetScreenEnd', this.ScreenEndModule);
};
ScreenClass.prototype.resetScreenBadge = function() {
  this.newBadge = null;
  $(document).trigger('screen.resetScreenBadge', null);
};
ScreenClass.prototype.resetScreenGameTimeEarned = function() {
  this.gameDialogShown = 0;
  $(document).trigger('screen.resetScreenGameTime', 0);
};
ScreenClass.prototype.showScreenEndModule = function() {
  $('.lab-problem').html(this.getScreenEndModule());
  this.resetScreenEnd();
};
ScreenClass.prototype.getScreenEndModule = function() {
  var gameTimeBlock = '';
  if (this.gameTimeTotal > 0) {
    gameTimeBlock = '<br/><br/>\
            <h3>You\'ve earned:</h3>\
            <span class="earnedNumber">' + this.gameTimeTotal + '</span> seconds of game time!';
  }
  return this.showScreenCongratsModuleEnd('You have finished <br>' + this.subject + '!' + gameTimeBlock, (gameTimeBlock !== '' ? 'withGameTime' : ''));
};
ScreenClass.prototype.getSimpleTable = function(tableItems, tableClass) {
  if (tableItems.length == 0) {
    return '';
  }
  tableClass = tableClass || '';
  var tableRows = [];
  var html = '';
  if (tableClass.length > 0) {
    tableClass = 'flowscreenTable ' + tableClass;
  } else {
    tableClass = 'flowscreenTable';
  }
  for (var i = 0; i < tableItems.length; i++) {
    var item = tableItems[i];
    var itemClass = '';
    if (item.highlight) {
      itemClass = 'class="highlight"';
    }
    var tableRow = '<tr ' + itemClass + '>\
                            <td class="fieldName">' + item.name + '</td>\
                            <td class="fieldValue">' + item.value + '</td>\
                        </tr>';
    tableRows.push(tableRow);
  }
  html = '<table class="' + tableClass + '">\
                ' + tableRows.join("") + '\
            </table>';
  return html;
};
ScreenClass.prototype.getMobyFriendImageHtml = function(cssClass) {
  cssClass = cssClass || '';
  return this.getRandomMobyFriendImage(this.getRandomMobyFriendImageUrl());
};
ScreenClass.prototype.getScreenEarnedPoints = function(gameTime, contestPoints, badgePoints, showZeroValues) {
  showZeroValues = typeof showZeroValues == 'undefined' ? false : showZeroValues;
  gameTime = parseInt(gameTime) || 0;
  contestPoints = parseInt(contestPoints) || 0;
  badgePoints = parseInt(badgePoints) || 0;
  var gameTimeLi = '';
  var contestPointLi = '';
  var badgePointLi = '';
  if (gameTime > 0 || showZeroValues) {
    gameTimeLi = '<li class="gametime">\
                            <span class="earnedNumber">' + gameTime + '</span>\
                            <span class="earnedNumberLabel">' + this.pluralize(gameTime, "second") + ' of <br>game time!</span>\
                        </li>';
  }
  if (contestPoints > 0 || showZeroValues) {
    contestPointLi = '<li class="contestpoint">\
                            <span class="earnedNumber">' + contestPoints + '</span>\
                            <span class="earnedNumberLabel">contest ' + this.pluralize(contestPoints, "point") + '!</span>\
                        </li>';
  }
  if (badgePoints > 0 || showZeroValues) {
    badgePointLi = '<li class="badgepoint">\
                            <span class="earnedNumber">' + badgePoints + '</span>\
                            <span class="earnedNumberLabel">badge ' + this.pluralize(badgePoints, "point") + '!</span>\
                        </li>';
  }
  var html = '<div class="earned">\
                    <h3>You earned:</h3>\
                    <ul>\
                        ' + gameTimeLi + '\
                        ' + contestPointLi + '\
                        ' + badgePointLi + '\
                    </ul>\
                </div>';
  return html;
};
ScreenClass.prototype.pluralize = function(number, word) {
  if (number != 1) {
    return word + 's';
  }
  return word;
};
ScreenClass.prototype.showScreenEndSession = function() {
  var className = 'screenEndSession';
  var gameTimeBlock = '';
  if (this.gameTimeTotal > 0) {
    className += ' withGameTime';
    gameTimeBlock = '<br/><br/>\
            <h3>You\'ve earned:</h3><br/>\
            <span class="earnedNumber">' + this.gameTimeTotal + '</span> seconds of game time!<br/><br/>';
  }
  var text = '<div class="lab-screen-bubble-big-text">Practice complete!</div>';
  this.resetScreenSession();
  $('.lab-problem').html(this.showScreenSimpleText(text + gameTimeBlock, className));
  this.screenModeOn();
};
ScreenClass.prototype.showScreenBadgeEarned = function() {
  var html = this.getScreenBadgeEarned();
  $('.lab-problem').html(html);
  this.screenModeOn();
  $('.lab-next').show();
  this.resetScreenBadge();
};
ScreenClass.prototype.getScreenBadgeEarned = function(badge) {
  if (typeof badge !== 'undefined') {
    this.setBadge(badge);
  }
  var imgSize = '';
  if (this.newBadge.Galaxy.Width) {
    imgSize = ' width="' + this.newBadge.Galaxy.Width + '" height="' + this.newBadge.Galaxy.Width + '"';
  }
  var html = '<div class="lab-congrat screenNewBadge">\
                <div class="lab-text-orange bolded centered lab-font30">YOU EARNED A NEW BADGE!</div>\
                <div class="centered"><img src="' + this.imageServer + this.newBadge.Galaxy.Path + '"' + imgSize + '/></div>\
                <div class="lab-new-badge-title centered bolded">' + this.newBadge.Galaxy.Name + '</div>\
                <div class="lab-new-badge-desc">' + this.newBadge.Galaxy.Description + '</div>' +
    this.newBadge.ReadAloudHtml + '</div>';
  return html;
};
ScreenClass.prototype.showScreenLessonStart = function(lessonName, strands, remainingTime, heading, animated) {
  lessonName = lessonName || '';
  remainingTime = remainingTime || 0;
  heading = heading || 'You\'re starting a new lesson!';
  var tableItems = strands ? strands.slice() : [];
  var headerContent = '';
  if (animated) {
    headerContent = '<div class="titleSubject">\
                <img src="/MM/img/lab/screenClass/open-animation/' + this.subjectCss + '.gif"/>\
            </div>';
  }
  return this.commonScreen({
    screenClass: 'screenLessonStart ' + this.subjectCss + (animated ? ' animated' : ''),
    title: heading,
    tableTitle: lessonName,
    table: tableItems,
    headerContent: headerContent,
  });
};
ScreenClass.prototype.showScreenStartMessage = function(message, animated) {
  return this.messageScreen({
    message: message,
    animated: animated,
    screenClass: 'start-screen-message'
  });
};
ScreenClass.prototype.showScreenLessonStartAnimated = function(lessonName, strands, remainingTime) {
  lessonName = lessonName || '';
  strands = strands || [];
  remainingTime = remainingTime || 0;
  var timeRemainingDiv = '';
  if (remainingTime) {
    var tempMin = Math.floor(remainingTime / 60);
    var tempSec = remainingTime % 60;
    tempSec = tempSec < 10 ? '0' + tempSec : tempSec;
    var minutes = tempMin + ':' + tempSec;
    timeRemainingDiv = '<div class="time">' + minutes + '<div class="label">minutes remaining</div></div>';
  }
  var strandRowsHtml = this.getSimpleTable(strands);
  var contentDivClass = '';
  if (remainingTime == 0) {
    contentDivClass = 'withoutAssignedTime';
  }
  var html = '<div class="flowscreen ' + this.subjectCss + ' screenLessonStart animated">\
                    <div class="overflowHidden"><h1>' + this.subject + '</h1></div>\
                    <div class="mobyFriendHolder">' + this.getRandomMobyFriendImage(this.getRandomMobyFriendImageUrl()) + '</div>\
                    <div class="title">\
                        <div class="welcome">\
                            ' + timeRemainingDiv + '\
                            <h3 class="message">Today you\'re<br> learning:</h3>\
                        </div>\
                    </div>\
                    <div class="content ' + contentDivClass + '">\
                        <div class="strandTable">\
                            <h4>' + lessonName + '</h4>\
                            <table>' + strandRowsHtml + '</table>\
                        </div>\
                    </div>\
                </div>';
  return html;
};
ScreenClass.prototype.showScreenLessonDone = function(lessonName, lessonScore, strands, contestPoints, badgePoints, lessonLabel) {
  lessonLabel = lessonLabel || 'lesson';
  lessonName = lessonName || '';
  lessonScore = lessonScore || null;
  var tableItems = strands ? strands.slice() : [];
  if (lessonScore && tableItems.length > 0) {
    tableItems.push({
      name: (lessonLabel.charAt(0).toUpperCase() + lessonLabel.slice(1)) + ' Score',
      value: lessonScore + '%',
      className: 'overall'
    });
  }
  return this.commonScreen({
    screenClass: 'screenLessonDone ' + this.subjectCss,
    title: 'Your ' + lessonLabel + ' is complete!',
    tableTitle: lessonName,
    table: tableItems
  });
};
ScreenClass.prototype.showScreenCongratulations = function(title, quizScore, gameTime, contestPoints, badgePoints, ccPoints) {
  gameTime = gameTime || 0;
  contestPoints = contestPoints || 0;
  badgePoints = badgePoints || 0;
  ccPoints = ccPoints || 0;
  var additionalHeight = 0;
  if (quizScore === null) {
    quizScore = '<img src="/MM/img/lab/screenClass/checkmark.gif" />';
  } else {
    quizScore += '%';
  }
  var bubbleContent = '\
        <h3>You\'ve earned:</h3>\
        <ul>';
  bubbleContent += '<li class="gametime">\
            <span class="earnedNumber">' + gameTime + '</span>\
            <span class="earnedNumberLabel">' + this.pluralize(gameTime, "second") + ' of game time!</span>\
        </li>';
  if (ccPoints && ccPoints > 0) {
    bubbleContent += '<li class="contestpoint">\
            <span class="earnedNumber">' + ccPoints + '</span>\
            <span class="earnedNumberLabel">class rewards ' + this.pluralize(ccPoints, "point") + '!</span>\
        </li>';
  } else {
    bubbleContent += '<li class="contestpoint">\
            <span class="earnedNumber">' + contestPoints + '</span>\
            <span class="earnedNumberLabel">contest ' + this.pluralize(contestPoints, "point") + '!</span>\
        </li>';
  }
  bubbleContent += '<li class="badgepoint">\
            <span class="earnedNumber">' + badgePoints + '</span>\
            <span class="earnedNumberLabel">badge ' + this.pluralize(badgePoints, "point") + '!</span>\
        </li>';
  if (this.sweepstakeTicketEarned) {
    bubbleContent += '<li class="sweepstakeTicket">\
            <span class="earnedNumber">1</span>\
            <span class="earnedNumberLabel">sweepstakes ticket!</span>\
        </li>';
    additionalHeight++;
  }
  bubbleContent += '</ul>';
  this.sweepstakeTicketEarned = false;
  return this.bubbleScreen({
    screenClass: 'screenBubble screenCongrats',
    title: (title || ''),
    bubbleTitle: quizScore,
    bubbleContent: bubbleContent,
    additionalHeight: additionalHeight
  });
};
ScreenClass.prototype.showScreenQuizDonePass = function(lessonName, quizScore, lessonScore, strands, heading) {
  if (quizScore == null) {
    quizScore = '&#10003;';
  } else {
    quizScore = (quizScore + '%');
  }
  lessonName = lessonName || '';
  heading = heading || 'You\'re starting a new lesson topic!';
  lessonScore = lessonScore || null;
  var tableItems = strands ? strands.slice() : [];
  if (lessonScore && tableItems.length > 0) {
    tableItems.push({
      name: 'Lesson Score',
      value: lessonScore + '%',
      className: 'overall'
    });
  }
  return this.commonScreen({
    screenClass: 'screenQuizDonePass ' + this.subjectCss,
    title: heading,
    tableTitle: lessonName,
    table: tableItems
  });
};
ScreenClass.prototype.showScreenQuizDoneFail = function(lessonName, quizScore, lessonScore, strands, title) {
  lessonName = lessonName || '';
  title = title || 'Let\'s try to improve your score!';
  lessonScore = lessonScore || null;
  var tableItems = strands ? strands.slice() : [];
  if (lessonScore && tableItems.length > 0) {
    tableItems.push({
      name: 'Lesson Score',
      value: lessonScore + '%',
      className: 'overall'
    });
  }
  return this.commonScreen({
    screenClass: 'screenQuizDoneFail ' + this.subjectCss,
    title: title,
    tableTitle: lessonName,
    table: tableItems
  });
};
ScreenClass.prototype.showScreenNextPracticeSet = function(quizScore) {
  var html = '<div class="flowscreen ' + this.subjectCss + ' screenNextPracticeSet screenSimpleText">\
                    <div class="title">\
                        <div>\
                            <div class="score bigScore"> <h3>Score:</h3>' + quizScore + '%</div>\
                            <h1 class="message">Let\'s try to improve your score with another practice set.</h1>\
                            <div class="clear"></div>\
                        </div>\
                    </div>\
                    <div class="MobyFriend">\
                        ' + this.getRandomMobyFriendImage(this.getRandomMobyFriendImageUrl()) + '\
                    </div>\
                </div>';
  return html;
};
ScreenClass.prototype.showScreenPrePlacementStart = function(message) {
  return this.messageScreen({
    message: message || 'Let\'s go!',
    animated: true,
    screenClass: 'screenPrePlacementStart'
  });
}
ScreenClass.prototype.showScreenPlacementStart = function(text, heading) {
  heading = heading || "You're starting a placement test!";
  text = text || 'This is important. \
                You\'ll want to focus and try your hardest \
                so that you can start at the right level.';
  return this.commonScreen({
    screenClass: 'screenPlacementStart animated ' + this.subjectCss,
    title: heading,
    text: text,
    usePreviousMobyFriend: true,
  });
};
ScreenClass.prototype.showScreenSimpleText = function(text, screenName, showMobyFriend, textTagIsUsed, animated) {
  return this.messageScreen({
    message: text,
    animated: animated ? true : false,
    screenClass: 'start-screen-message center-message screenSimpleText ' + (screenName || '')
  });
};
ScreenClass.prototype.showScreenLessonEndWithLessonList = function(lessonList, gameTime, contestPoints, badgePoints) {
  var lessonTable = this.getSimpleTable(lessonList);
  var earnedScreen = this.getScreenEarnedPoints(gameTime, contestPoints, badgePoints, true);
  var mobyFriend = this.getMobyFriendImageHtml();
  var html = '<div class="flowscreen ' + this.subjectCss + ' showScreenLessonEndWithLessonList">' + earnedScreen + mobyFriend + lessonTable + '</div>';
  return html;
};
ScreenClass.prototype.getProgressScreen = function(percentArray, isBar, wrapClass) {
  isBar = typeof isBar == 'undefined' ? true : isBar;
  wrapClass = wrapClass || false;
  var html = '';
  for (var i = 0; i < percentArray.length; i++) {
    var percentItem = percentArray[i];
    var indicator;
    if (isBar) {
      indicator = this.getIndicatorBar(percentItem.percentComplete, percentItem.title, percentItem.showTitle);
    } else {
      indicator = this.getIndicatorCircle(percentItem.percentComplete, percentItem.title, percentItem.showTitle);
    }
    html += indicator;
  }
  if (wrapClass) {
    html = '<div class="' + wrapClass + '">' + html + '</div>';
  }
  return html;
};
ScreenClass.prototype.getProgressIndicator = function(percentComplete, title, showTitle, isBar) {
  percentComplete = parseInt(percentComplete) || 0;
  title = title || '';
  showTitle = typeof showTitle == 'undefined' ? false : showTitle;
  isBar = typeof isBar == 'undefined' ? true : isBar;
  var html;
  if (isBar) {
    var titleBlock = '';
    if (showTitle) {
      titleBlock = '<div class="label">' + title + '</div>';
    }
    var graph = percentComplete >= 96 ? 96 : percentComplete;
    var graphNumber = graph - 3;
    if (graph < 1) {
      graphNumber = graph - 2;
    }
    var countClassCss = 'style = "left: ' + graphNumber + '%"';
    var fullClassCss = 'style = "width: ' + graph + '%"';
    html = '<div class="progress no-label">\
                    <div class="count" ' + countClassCss + '>' + percentComplete + '%</div>\
                    <div class="bar">\
                        <div class="full" ' + fullClassCss + '></div>\
                        <div class="empty"></div>\
                    </div>\
                    ' + titleBlock + '\
                </div>';
  } else {
    var progressCircleTitleDiv = '';
    if (showTitle) {
      progressCircleTitleDiv = '<div class="progressCircleTitle">' + title + '</div>';
    }
    var cssString = 'bottom: ' + percentComplete + '%;height:' + percentComplete + 'px;';
    html = '<div class="progressDiv">\
                    <div class="progressCircleValueDiv">\
                        <div class="progressCircleValue">' + percentComplete + '%</div>\
                        <div class="progressCircleFill"  style="' + cssString + '"></div>\
                    </div>\
                    ' + progressCircleTitleDiv + '\
                </div>';
  }
  return html;
};
ScreenClass.prototype.getIndicatorCircle = function(percentComplete, title, showTitle) {
  return this.getProgressIndicator(percentComplete, title, showTitle, false);
};
ScreenClass.prototype.getIndicatorBar = function(percentComplete, title, showTitle) {
  return this.getProgressIndicator(percentComplete, title, showTitle);
};
ScreenClass.prototype.setAutoGameDialogClose = function(close, milliseconds) {
  this.gameDialogAutoClose = close;
  if (!close) {
    return;
  }
  this.gameDialogAutoCloseTime = milliseconds;
};
ScreenClass.prototype.showScreenAskGrade = function(minGrade, maxGrade, title) {
  var gradeListEndings = ['Kindergarten', 'st', 'nd', 'rd', 'th'];
  var gradeList = [];
  var gradeRow;
  if (!minGrade) {
    minGrade = 0;
  }
  if (!maxGrade) {
    maxGrade = 8;
  }
  if (!title) {
    title = 'Ask your teacher what grade level you should start in.';
  }
  var tableItems = [];
  for (var i = minGrade; i <= maxGrade; i++) {
    if (i == 0) {
      gradeRow = gradeListEndings[0];
    } else {
      gradeRow = (!gradeListEndings[i] ? i + gradeListEndings[gradeListEndings.length - 1] : i + gradeListEndings[i]) + ' Grade';
    }
    tableItems.push({
      name: gradeRow,
      value: '',
      id: 'grade_' + i,
      className: 'lab-screen-table-select'
    });
  }
  var content = '<div class="lab-screen-askgrade"><div>';
  for (var i = minGrade; i <= maxGrade; i++) {
    content += '<div class="lab-screen-askgrade-item" id="grade_' + i + '"><div>Grade</div><div>' + (i == 0 ? 'K' : i) + '</div></div>';
  }
  content += '</div></div>';
  return this.commonScreen({
    screenClass: 'screenAskGrade ' + this.subjectCss,
    title: 'Select your grade level!',
    text: title,
    content: content
  });
};
ScreenClass.prototype.askGradeEvents = function() {
  $('.lab-next').attr('data-onclick', $('.lab-next').attr('onclick'));
  $('.lab-next').attr('onclick', 'void(0);');
  $('.lab-next').show().addClass('disabled');
  $('.lab-flowscreen .lab-screen-askgrade-item').on('click', function(e) {
    $('.lab-flowscreen .lab-screen-askgrade-item.selected').removeClass('selected');
    $(e.currentTarget).addClass('selected');
    $('.lab-next').show().removeClass('disabled');
    $('.lab-next').attr('onclick', $('.lab-next').attr('data-onclick'));
    $('.lab-next').removeAttr('data-onclick');
  });
};
ScreenClass.prototype.showScreenLowerGrade = function(text) {
  text = text || '';
  var html = '<div class="flowscreen screenLowerGrade">\
                    <div class="askGradeStar">\
                        <img src="/MM/img/lab/screenClass/icon-questionmark.png">\
                    </div>\
                    <h2>' + text + '</h2>\
                    <div class="screenLowerGradeOptions">\
                        <ul>\
                            <li>\
                                <input name="lowerGradeOption" type="radio" id="lowerGradeOption_1">\
                                <label for="lowerGradeOption_1">Yes, I want to take this test.</label>\
                            </li>\
                            <li>\
                                <input name="lowerGradeOption" type="radio" id="lowerGradeOption_0">\
                                <label for="lowerGradeOption_0">No, get me out of here!</label>\
                            </li>\
                        </ul>\
                    </div>\
                    ' + this.getRandomMobyFriendImage(this.getRandomMobyFriendImageUrl()) + '\
                </div>';
  return html;
};
ScreenClass.prototype.getGradeSelected = function() {
  return $('.lab-flowscreen .lab-screen-askgrade-item.selected').attr('id').replace('grade_', '');
};
ScreenClass.prototype.showGameDialog = function() {
  if (this.gameDialogShown == 1) {
    return;
  }
  this.gameTimeTotal += this.gameTimeEarned;
  $('#lab-game-dialog-time').html(this.gameTimeEarned);
  $('#lab-game-dialog-time-plural').html(this.gameTimeEarned > 1 ? 's' : '');
  dialog.open('lab-game-dialog');
  this.gameDialogShown = 1;
  this.gameTimeEarned = 0;
  this.gameDialogAutoCloseTimeout = null;
  if (this.gameDialogAutoClose) {
    this.gameDialogAutoCloseTimeout = setTimeout(this.closeGameDialog.bind(this), this.gameDialogAutoCloseTime);
  }
};
ScreenClass.prototype.closeGameDialog = function() {
  this.gameDialogShown = 0;
  this.resetScreenGameTimeEarned();
  dialog.close('lab-game-dialog');
};
ScreenClass.prototype.updateVars = function(params) {
  params = params || {};
  if ('newBadge' in params) {
    this.newBadge = params['newBadge'];
  }
  if ('gameTimeEarned' in params) {
    this.gameTimeEarned = params['gameTimeEarned'];
  }
  if ('gameTimeTotal' in params) {
    this.gameTimeTotal = params['gameTimeTotal'];
  }
  if ('screenStart' in params) {
    this.ScreenStart = params['screenStart'];
  }
  if ('screenEndModule' in params) {
    this.ScreenEndModule = params['screenEndModule'];
  }
  if ('screenEndSession' in params) {
    this.ScreenEndSession = params['screenEndSession'];
  }
  if ('contestPoints' in params) {
    this.contestPoints = params['contestPoints'];
  }
  if ('badgePoints' in params) {
    this.badgePoints = params['badgePoints'];
  }
  if ('percentComplete' in params) {
    this.percentComplete = params['percentComplete'];
  }
  if ('percentCompleteLevel' in params) {
    this.percentCompleteLevel = params['percentCompleteLevel'];
  }
  if ('subject' in params) {
    this.subject = params['subject'];
  }
  if ('subjectCss' in params) {
    this.subjectCss = params['subjectCss'];
  }
  if ('assignedTime' in params) {
    this.assignedTime = params['assignedTime'];
  }
};
ScreenClass.prototype.updateGameTime = function(gameTimeEarned) {
  this.gameTimeEarned = gameTimeEarned;
  this.gameTimeTotal += gameTimeEarned;
};
ScreenClass.prototype.getCorrectImage = function() {
  return $('<img id="correctImage" src="/MM/img/lab/screenClass/s-correct.png">');
};
ScreenClass.prototype.getIncorrectImage = function() {
  return $('<img id="incorrectImage" src="/MM/img/lab/screenClass/incorrect.png">');
};
ScreenClass.prototype.hideAnswerImages = function() {
  $('#correctImage, #incorrectImage').remove();
};
ScreenClass.prototype.hideLoading = function() {
  $('#loading').hide();
};
ScreenClass.prototype.checkDisplayScreen = function(params) {
  this.updateVars(params);
  this.hideLoading();
  if (this.newBadge) {
    this.showScreenBadgeEarned();
    return true;
  }
  if (this.gameTimeEarned) {
    this.showGameDialog();
    return true;
  }
  if (this.ScreenStart) {
    this.showScreenStart();
    this.showAssignedTime(this.assignedTime);
    return true;
  }
  if (this.ScreenEndModule) {
    this.showScreenEndModule();
    return true;
  }
  if (this.ScreenEndSession) {
    this.showScreenEndSession();
    return true;
  }
  this.screenModeOff();
  return false;
};
ScreenClass.prototype.screenModeOn = function() {
  $('.lab-frame').addClass('lab-screen');
};
ScreenClass.prototype.screenModeOff = function() {
  $('.lab-footer .lab-assigned-time').remove();
  $('.lab-frame').removeClass('lab-screen');
};
ScreenClass.prototype.showScreenCongratsModuleEnd = function(message, extraClass) {
  var html = this.bubbleScreen({
    title: '&nbsp;',
    screenClass: 'screenBubble screenEndModule ' + (extraClass || ''),
    bubbleTitle: '<img src="/MM/img/lab/screenClass/happystate.gif" />',
    bubbleContent: '<div class="lab-screen-bubble-big-text">Congrats!</div><br/>' + message
  });
  $('.lab-problem').html(html);
  this.screenModeOn();
};
ScreenClass.prototype.onProblemMessageClose = function() {
  this.hideProblemMessage();
  if (this.onCloseProblemMessagCallback) {
    this.onCloseProblemMessagCallback();
    this.onCloseProblemMessagCallback = null;
  }
}
ScreenClass.prototype.showProblemMessage = function(params) {
  if (this.problemMessageTimeout) {
    clearTimeout(this.problemMessageTimeout);
    this.problemMessageTimeout = null;
  }
  this.hideProblemMessage();
  if (typeof params.onClose === 'function') {
    this.onCloseProblemMessagCallback = params.onClose;
  }
  $('body').append('\
        <div class="lab-problem-message">\
            <div class="standard-dialog-blue-overlay"></div>\
            <div class="lab-screen-bubble-content' + (params.buttons ? ' withButtons' : '') + '">\
                <div class="lab-screen-bubble-cross lab-screen-problem-close"><div>x</div></div>\
                <div class="lab-screen-bubble">\
                    <div class="lab-screen-bubble-top"><div></div></div>\
                    <div class="lab-screen-bubble-container">\
                        <div class="lab-screen-bubble-container-left"><div></div></div>\
                        <div class="lab-screen-bubble-container-right"><div></div></div>\
                        <div class="lab-screen-bubble-container-bottom"><div></div></div>\
                        <div class="lab-screen-bubble-big-text lab-screen-bubble-score"><img src="https://data.mobymax.com/lab/lab/worriedstate.gif" /></div>\
                        <div class="lab-screen-bubble-items"><div>\
                          <div class="lab-screen-bubble-big-text">' + params.title + '</div><br/>\
                          <div class="lab-screen-bubble-text">' + (params.message || '') + '</div>\
                          ' + (params.buttons || '') + '\
                        </div></div>\
                    </div>\
                </div>\
            </div>\
        </div>');
  if (params.timeout === Infinity) return;
  this.problemMessageTimeout = setTimeout(function() {
    this.problemMessageTimeout = null;
    this.onProblemMessageClose();
  }.bind(this), (params.timeout || 2000));
};
ScreenClass.prototype.hideProblemMessage = function() {
  $('.lab-problem-message').remove();
};
ScreenClass.prototype.showAssignedTime = function(time) {
  if (!time || time < 0) return;
  if (!$('.lab-footer .lab-assigned-time').length)
    $('.lab-footer .lab-clear:last-child').before('<div class="lab-assigned-time"></div>');
  $('.lab-footer .lab-assigned-time').html('<span>' + time + '</span>&nbsp;&nbsp;Minute' + (time == 1 ? '' : 's') + ' remaining');
};
var focusTimeObj;
var LabClass = function(objectName) {
  if (objectName) {
    this.errorWasLogged = false;
    this.objectName = objectName;
    this.mobyFriendURL = null;
    this.imageServer = null;
    this.percentComplete = 0;
    this.percentCompleteLevel = 0;
    this.contestPoints = 0;
    this.badgePoints = 0;
    this.ScreenStart = 0;
    this.ScreenEndModule = 0;
    this.ScreenEndSession = 0;
    this.newBadge = null;
    this.subject = null;
    this.subjectCss = null;
    this.db_Time = 0;
    this.db_TimeFocus = 0;
    this.generateCertificate = 0;
    this.generateCertificateId = null;
    this.gameTimeEarned = 0;
    this.TimeNotFocus = 0;
    this.emptyMP3 = 'https://data.mobymax.com/er/words/audio/empty.mp3';
    if (window.app && window.app.labInit) {
      this.initVars(window.app.labInit);
      this.server = new ServerClass({
        lab: this,
        basePath: this.basePath,
        skey: this.skey,
        pingInterval: 60000
      });
      this.timer = new TimerClass({
        labName: objectName,
        idleSeconds: this.idleSeconds
      });
      this.screen = new ScreenClass(this.mobyFriendURL, this.subject, this.imageServer, this.percentComplete, this.percentCompleteLevel, this.subjectCss, this.onNextClick);
      this.timer.Start('thrTimePractice');
      if (responsiveVoice && this.voiceURL) {
        responsiveVoice.fallbackServicePath = this.voiceURL;
      }
      focusTimeObj = new FocusTimeClass(this, this.timer, this.getTimerSession, false);
    }
    this.setupWindowFunctions();
    $.fn.extend({
      ensureLoad: function(handler) {
        return this.each(function() {
          if (this.complete) {
            handler.call(this);
          } else {
            $(this).on('load', handler);
          }
        });
      }
    });
    $(document).on('click', '.lab-screen-sessionEnd-button', (function() {
      this.logout(-1);
    }).bind(this));
    $(document).on('screen.resetScreenStart', (function(e, screenStartValue) {
      var origNextClick = this.onNextClick;
      this.onNextClick = function() {
        this.playEmptySound(origNextClick)
      };
      this.ScreenStart = screenStartValue;
    }).bind(this));
    $(document).on('screen.resetScreenSession', (function(e, screenSessionValue) {
      this.ScreenEndSession = screenSessionValue;
      this.onNextClick = function() {
        this.logout(-1);
      };
    }).bind(this));
    $(document).on('screen.resetScreenEnd', (function(e, screenEndValue) {
      this.ScreenEndModule = screenEndValue;
      this.onNextClick = function() {
        this.logout(-1);
      };
    }).bind(this));
    $(document).on('screen.resetScreenBadge', (function(e, screenBadgeValue) {
      this.newBadge = screenBadgeValue;
    }).bind(this));
    $(document).on('screen.resetScreenGameTime', (function(e, gameTimeEarned) {
      this.gameTimeEarned = gameTimeEarned;
      this.onNextClick();
    }).bind(this));
    $(document).on('screenClass.nextBtnClicked', (function(e, event) {
      this.onNextClick(event);
    }).bind(this));
    $(document).on('click', '.lab-next.lab-right', (function() {
      this.stopResponsiveVoice();
    }).bind(this));
    $(document).on('keypress', '.lab-spell-input', function() {
      $(document).trigger('studentStartedTyping');
    });
  }
};
LabClass.prototype.extendClass = function(ChildClass) {
  ChildClass.prototype = new LabClass();
  ChildClass.prototype.constructor = ChildClass;
  ChildClass.prototype.parent = LabClass.prototype;
}
LabClass.prototype.setupWindowFunctions = function() {
  var _this = this;
  window.onerror = function(msg, url, line) {
    if (_this.errorWasLogged) return true;
    _this.errorWasLogged = true;
    _this.server.ajaxCall('loglab', {
      type: 'POST',
      data: {
        lab: JSON.stringify(_this.objectName),
        accessurl: url + ':' + line,
        message: msg
      }
    });
    if (typeof console == "object") console.log(msg + ' ' + url + ':' + line);
    return true;
  };
  $(document).keydown(function(e) {
    if (e.keyCode == 13) _this.onEnterKey();
  });
  $(window).bind('beforeunload, pagehide', (function() {
    this.logout(-1);
  }).bind(this));
}
LabClass.prototype.Open = function() {
  this.server.ajaxCall('openlab', {
    type: 'POST',
    data: {}
  });
}
LabClass.prototype.waitForDeferred = function() {
  this.server.waitForDeferred();
}
LabClass.prototype.executeDeferred = function() {
  this.server.executeDeferred();
}
LabClass.prototype.noOp = function() {};
LabClass.prototype.showLoading = function() {
  $('#loading').show();
}
LabClass.prototype.hideLoading = function() {
  $('#loading').hide();
}
LabClass.prototype.showTimeup = function() {
  $(".time-up").fadeIn("slow");
  setTimeout(function() {
    $(".time-up").fadeOut("slow")
  }, 1000);
}
LabClass.prototype.onEnterKey = function() {
  this.stopResponsiveVoice();
  if (!this.timer.studentIdle) this.onNextClick();
}
LabClass.prototype.initVars = function(params) {
  if (params != null)
    for (var dataindex in params)
      this[dataindex] = params[dataindex];
}
LabClass.prototype.logout = function(doLogout) {
  this.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
  this.setSession({
    doLogout: doLogout
  });
}
LabClass.prototype.stopResponsiveVoice = function() {
  if (responsiveVoice) {
    responsiveVoice.cancel();
  }
};
LabClass.prototype.getSessionData = function() {
  return {};
}
LabClass.prototype.setSession = function(logout, options) {
  var sessionTime = this.resetTimerSession();
  this.onNextClick = this.noOp;
  var timeFocus = sessionTime - this.TimeNotFocus;
  if (timeFocus < 0) {
    timeFocus = 0;
  }
  this.TimeNotFocus = 0;
  var data = {
    setSession: 1,
    sessionTime: sessionTime,
    gameTimeTotal: this.screen.gameTimeTotal,
    TimeFocus: timeFocus
  }
  var async = true;
  if (logout) {
    data['logout'] = logout['doLogout'];
    async = (logout['doLogout'] < 0) ? false : true;
    data = $(document).triggerHandler('labUnload', data) || data;
  } else {
    this.showLoading();
  }
  $.extend(data, this.getSessionData());
  if (!options) {
    options = {};
  }
  options.type = 'POST';
  options.async = async;
  options.data = data;
  this.server.ajaxCall('update', options);
  this.answers = {};
}
LabClass.prototype.getUpdateVars = function() {
  return {
    assignedTime: (this.assignedTime - Math.floor(focusTimeObj.getActualTotal() / 60)),
    screenStart: this.ScreenStart,
    screenEndModule: this.ScreenEndModule,
    screenEndSession: this.ScreenEndSession,
    newBadge: this.newBadge,
    gameTimeEarned: this.gameTimeEarned,
    contestPoints: this.contestPoints,
    badgePoints: this.badgePoints
  };
};
LabClass.prototype.showGameDialog = function() {
  this.screen.updateVars(this.getUpdateVars());
  this.screen.showGameDialog();
};
LabClass.prototype.closeGameDialog = function() {
  this.screen.closeGameDialog();
  this.onNextClick();
};
LabClass.prototype.checkDisplayScreen = function() {
  if (this.generateCertificate) {
    focusTimeObj.startFlowScreenTimeNotFocusTimer();
    this.createCertificate(this.generateCertificateId);
    return true;
  }
  var screenShown = this.screen.checkDisplayScreen(this.getUpdateVars());
  if (screenShown) {
    focusTimeObj.startFlowScreenTimeNotFocusTimer();
    return true;
  }
  return false;
};
LabClass.prototype.showScreenEndModule = function() {
  this.screen.updateVars(this.getUpdateVars());
  this.screen.showScreenEndModule();
};
LabClass.prototype.showScreenEndSession = function() {
  this.screen.updateVars(this.getUpdateVars());
  this.screen.showScreenEndSession();
};
LabClass.prototype.showScreenBadgeEarned = function() {
  this.screen.showScreenBadgeEarned();
};
LabClass.prototype.createCertificate = function(certificateId) {
  Moby.App.CertificateBuilder.start(certificateId, (function() {
    this.generateCertificate = 0;
    this.generateCertificateId = null;
    this.onNextClick();
  }).bind(this));
};
LabClass.prototype.playEmptySound = function(origNextClick) {
  if (isIOS() && getIOSVersion() < 13) {
    this.onNextClick = origNextClick;
    this.onNextClick();
    return;
  }
  if (!this.isEmptyPlayed) {
    var that = this;
    this.playFile(this.emptyMP3, function() {
      that.onNextClick = origNextClick;
      that.onNextClick();
    });
    this.isEmptyPlayed = true;
  }
};
LabClass.prototype.imageSuccess = function(image) {
  $(image).removeAttr('onclick');
}
LabClass.prototype.imageError = function(image, fromClick) {
  var $image = $(image);
  var retries = $image.attr('data-retries');
  if ((retries < this.imgFailRetry) || (fromClick)) {
    var src = $image.attr('src');
    $image.attr('data-retries', ++retries).attr('src', src);
  }
};
LabClass.prototype.imageLoadRetry = function(container, onLoadedCallback) {
  var $img = $(container + ' img:not(' + this.playImages + ')');
  $img.each(function(i, e) {
    var src = $(e).attr('src');
    $(e).attr('src', src.replace(/(.gif)\?*[^'"]*/g, '$1?' + (Math.random() * (999999 - 100000) + 100000)));
    if (src.indexOf('.gif') > 0 && navigator.userAgent.toLowerCase().indexOf('firefox') >= 0) {
      var imgEl = $(e)[0];
      var imgInterval = setInterval(function() {
        if (imgEl.naturalWidth) {
          clearInterval(imgInterval);
          $(e).trigger('load');
        }
      }, 200);
    }
  });
  return $img.attr('data-retries', '0').attr('onerror', this.objectName + '.imageError(this,false);').attr('onload', this.objectName + '.imageSuccess(this);').ensureLoad(onLoadedCallback ? onLoadedCallback : this.noOp).length;
};
LabClass.prototype.imagesLoaded = function(container) {
  var d = $.Deferred();
  var imgLoaded = 0,
    imgTotal = this.imageLoadRetry(container, function() {
      var $image = $(this);
      if (!$image.attr('onload')) return;
      $image.removeAttr('onload');
      var src = $image.attr('src');
      if (src.indexOf('.gif') > 0 && navigator.userAgent.toLowerCase().indexOf('firefox') < 0) {
        $image.attr('src', src);
      }
      if (++imgLoaded >= imgTotal) d.resolve({
        imageCount: imgTotal,
        timestamp: new Date().getTime()
      });
    });
  if (imgTotal <= 0) d.resolve({
    imageCount: imgTotal,
    timestamp: new Date().getTime()
  });
  return d.promise();
}
LabClass.prototype.startTimerSession = function() {
  if (typeof this.timer.timers['thrTimerSession'] == 'undefined')
    this.timer.Start('thrTimerSession');
}
LabClass.prototype.getTimerSession = function() {
  return this.timer.GetTime('thrTimerSession');
}
LabClass.prototype.resetTimerSession = function() {
  var session = this.getTimerSession();
  this.timer.Start('thrTimerSession');
  return session;
}
LabClass.prototype.showAnimated = function(html, callback, context) {
  function callCallback() {
    if (typeof context !== 'undefined') callback.call(context);
    else if (typeof callback !== 'undefined') callback();
  }
  if (typeof this.animatedTimeout !== 'undefined' && this.animatedTimeout !== null) {
    clearTimeout(this.animatedTimeout);
    this.animatedTimeout = null;
  }
  if (this.useAnimate) {
    if ($('.lab-problem > div').length) {
      $('.lab-problem > div').fadeOut(function() {
        $('.lab-problem').html(html);
        $('.lab-problem > div').hide().fadeIn(callCallback);
      });
    } else {
      $('.lab-problem').html(html);
      $('.lab-problem > div').hide().fadeIn(callCallback);
    }
  } else {
    $('.lab-problem').html(html);
    callCallback();
  }
};
var LiveMessage = {
  messages: [],
  debug: 0,
  teacher_id: null,
  user_id: null,
  student_id: null,
  student_name: "",
  window_id: null,
  load_window_received: 0,
  connection_lost: false,
  notice_div: false,
  overlay_div: false,
  module: null,
  stamp: null,
  init_count: 0,
  client: null,
  presence: null,
  init: function(debug, teacher_id, user_id, student_id, student_name, module) {
    this.init_count++;
    if (this.client) {
      return false;
    }
    var _this = this;
    _this.debug = debug;
    _this.teacher_id = teacher_id;
    _this.user_id = user_id.toString();
    _this.student_id = student_id.toString();
    _this.student_name = student_name;
    _this.client = null;
    _this.module = module;
    _this.stamp = Date.now();
    if (_this.debug == 1) console.log(">>> in init");
    if (app.jsVars && app.jsVars.RealtimeEnabled) {
      _this.client = app.jsVars.AblyRealtime = new Ably.Realtime({
        token: app.jsVars.AblyToken,
        authUrl: '/MM/ably/auth.php',
        echoMessages: false,
        closeOnUnload: true
      });
      _this.window_id = _this.client.connection.id
      app.jsVars.AblyMessagesChannel = app.jsVars.AblyRealtime.channels.get('u-' + _this.user_id);
      app.jsVars.AblyRealtime.connection.once('connected', function() {
        if (_this.debug == 1) console.log('>>> Connected to Ably');
        _this.window_id = _this.client.connection.id;
        if (!module || !module.length) {
          module = (typeof(mmapp) != "undefined" && typeof(mmapp.module.name) != "undefined" ? mmapp.module.name : "MS");
        }
        if (typeof(NSlab) != "undefined") {
          module = "NS";
        }
        if (jQuery.inArray(module, ['PB1', 'PB2', 'PB3', 'SP1', 'SP2', 'SP3', 'SW', 'SWD', 'SWF', 'PH']) !== -1) {
          module = "FS";
        }
        _this.presence = new Presence(app.jsVars.AblyRealtime, {
          debug: _this.debug,
          ids: _this.teacher_id,
          pkINStudentID: _this.student_id,
          Username: _this.student_name,
          module: module,
        });
        app.jsVars.AblyMessagesChannel.subscribe(function(message) {
          if (_this.debug == 1) console.log('>>> Received message with clientId:', message.clientId, 'toStudent');
          _this.getNewMessage(message);
        });
        teacherID = _this.teacher_id[0];
        teacherPresenceChannel = app.jsVars.AblyRealtime.channels.get('tp-' + teacherID);
        teacherPresenceChannel.attach(function(err) {
          if (err) {
            return console.error("Error attaching to the channel");
          }
          teacherPresenceChannel.presence.subscribe(function(presenceMsg) {
            if (_this.debug == 1) console.log(">>> recevied presence message");
            if (presenceMsg.action == 'leave') {
              teacherPresenceChannel.presence.get(function(err, members) {
                if (members.length == 0) {
                  LiveMessage.presence.data.teacher_ids = [];
                  delete LiveMessage.presence.ortcClient.channels.all['t-' + teacherID];
                }
              });
            } else {
              if (presenceMsg.data == "RTPanelOpen" && (presenceMsg.action == 'enter' || presenceMsg.action == 'present')) {
                app.jsVars.AblyRealtime.channels.get('t-' + teacherID);
                LiveMessage.presence.addChannel(teacherID);
                LiveMessage.presence.sendToAll();
              }
            }
          });
        });
        if (module != 'MS' && !app.jsVars.IsCheatersDisabled && _this.student_id > 0 && _this.window_id) {
          if (_this.debug == 1) console.log(">>> Sending windowLoad payload", _this.window_id);
          app.jsVars.AblyMessagesChannel.publish('windowLoad', {
            id: _this.window_id,
            module: module,
            student_id: _this.student_id,
            userAgent: navigator.userAgent,
            url: window.location.toString(),
            stamp: _this.stamp,
          }, function(err) {
            if (err) console.log('realtime app error');
          });
        }
      });
    }
  },
  updateModule: function(module) {
    this.module = module;
    this.presence.setData({
      module: module
    });
  },
  showConnectionIssue: function() {
    if (this.overlay_div != false || this.notice_div != false) {
      return;
    }
    this.overlay_div = $('<div>');
    this.overlay_div.css({
      backgroundColor: 'rgba(0,0,0,0.4)',
      height: '100%',
      width: '100%',
      top: 0,
      left: 0,
      overflow: 'auto',
      position: 'fixed',
      zIndex: 12000,
    });
    this.notice_div = $('<div id="socket_trying_dialog">Your internet connection has been lost. Let\'s wait just a moment to see if it will come back.</div>');
    this.notice_div.css({
      backgroundColor: '#F9EDBE',
      backgroundImage: 'url("/MM/img/spinner3-black.gif")',
      backgroundPosition: '96% 50%',
      backgroundRepeat: 'no-repeat',
      border: '1px solid #F0C36D',
      borderRadius: '5px 5px 5px 5px',
      color: 'gray',
      fontFamily: 'Arial',
      fontSize: '18px',
      fontWeight: 'bold',
      margin: '10px auto',
      padding: '15px 55px 15px 15px',
      textAlign: 'left',
      width: '400px',
      position: 'fixed',
      left: '50%',
      marginLeft: '-230px',
      top: '120px',
      zIndex: 12001,
    });
    this.overlay_div.appendTo('body');
    this.notice_div.appendTo('body');
  },
  hideConnectionIssue: function() {
    $(this.overlay_div).remove();
    $(this.notice_div).remove();
    this.overlay_div = false;
    this.notice_div = false;
  },
  openMessage: function(last_message) {
    var title = '';
    var html = '';
    if (last_message.notification_type == 1 || last_message.notification_type == 3) {
      title = 'New Message';
      html = ' <div class="blue-dialog-student-menu">\
       From : ' + last_message.name + '\
      </div>\
      <div class="blue-dialog-student-contents-html default readaloud-it">\
       ' + last_message.text + '\
      </div>';
    } else if (last_message.notification_type == 2) {
      title = 'New ' + ((last_message.type == 1) ? 'Good' : 'Bad') + ' Vibe';
      html = ' <div class="blue-dialog-student-menu readaloud-it">\
       ' + last_message.name + '\
      </div>\
      <div class="blue-dialog-student-contents-html default">\
       <img src="' + last_message.image + '" />\
       <div class="newMessage-text readaloud-it">' + last_message.text + '</div>\
      </div>\
      ';
    }
    html += '\
   <div class="read-aloud-message-popup">\
    <div class="play">\
     <div id="" class="ls-icon ">\
      <a href="javascript:void(0)" title="" onclick="" style="">\
       <img class="icon" src="/MM/img/MT/svg/icon-audio-play.png">\
      </a>\
     </div>\
    </div>\
    <div class="pause">\
     <div id="" class="ls-icon ">\
      <a href="javascript:void(0)" title="" onclick="" style="">\
       <img class="icon" src="/MM/img/MT/svg/icon-audio-pause.png">\
      </a>\
     </div>\
    </div>\
   </div>\
  ';
    $("#newMessage-content-html").html(html);
    $("#newMessage .standard-dialog-blue-title").html(title);
    dialog.getNextZIndex();
    this.dialog = dialog.open('newMessage');
  },
  getNewMessage: function(message) {
    if (message.name == 'presence' || message.name == 'newNotification') return;
    var _this = this;
    if (_this.debug == 1) console.log(">>> Receiving " + JSON.stringify(message, null, 4));
    if (typeof(FMLab) != "undefined") {
      FMLab.pause();
    }
    switch (message.name) {
      case 'windowLoad':
        if (!app.jsVars.IsCheatersDisabled && this.module != 'MS' && this.window_id && this.student_id == message.data.student_id && message.data.id !== this.window_id && message.data.stamp > this.stamp) {
          if (_this.debug == 1) console.log(">>> triggering windowLoad event");
          this.load_window_received++;
          this.logWindowUnload(message.data.module, message.data.id, message.data.userAgent, message.data.url, message.data.stamp);
          app.jsVars.AblyMessagesChannel.publish('windowUnload', {
            id: _this.window_id,
            module: _this.module,
            student_id: _this.student_id,
            userAgent: navigator.userAgent,
            url: window.location.toString(),
            stamp: _this.stamp,
          }, function(err) {
            if (typeof sign_out == 'function') {
              if (_this.debug == 1) console.log(">>> calling sign_out()");
              sign_out('/signin?varNLO=1');
            } else {
              if (_this.debug == 1) console.log(">>> sign_out() function not available, forcing window.location to");
              window.location = '/signin?varNLO=1';
            }
            if (err) console.log('realtime app error');
          });
        }
        break;
      case 'windowUnload':
        if (!app.jsVars.IsCheatersDisabled && this.module != 'MS' && this.window_id && this.student_id == message.data.student_id && message.data.id !== this.window_id) {
          window.location.reload();
        }
        case 'newMessage':
          if (message.data.messageType == 'from-student') return;
          _this.messages.push(message.data);
          if (message.data.senderTypes && message.data.senderTypes[1] === true) {
            _this.openMessage(_this.messages[0], true);
          }
          break;
        case 'newVibe':
          var t = 0;
          if (typeof(message.data.vibeList) != "undefined" && typeof(message.data.studentVibe) != "undefined") {
            sv = 0;
            $.each(message.data.vibeList, function(key, val) {
              val.name = key;
              val.studentVibeID = message.data.studentVibe[sv].studentVibeID;
              val.notification_type = 2;
              _this.messages.push(val);
              if (_this.messages.length == 1) {
                if (_this.debug == 1) console.log(">>> Opening dialog box");
                _this.openMessage(_this.messages[0]);
              }
              sv++;
            });
          }
          break;
        case 'getProblems':
          var data = JSON.parse(message.data);
          var presenceChannel = app.jsVars.AblyRealtime.channels.get('t-' + data.teacherId);
          var problems = _this.presence.data.Problems;
          if (_this.presence.data.Problems.length === 0 || _this.presence.data.Problems[_this.presence.data.Problems.length - 1].pkMLProblemID !== _this.presence.data.CurrentProblem.pkMLProblemID) {
            problems = problems.concat([{
              pkMLProblemID: _this.presence.data.CurrentProblem.pkMLProblemID,
              currentProblem: true,
              isCorrect: null,
              correctAnswer: _this.presence.data.CurrentProblem.CorrectAnswer,
              time: 0,
              dateCompleted: null,
            }]);
          }
          presenceChannel.publish('getProblems', JSON.stringify(problems));
          break;
        default:
          if (_this.debug == 1) console.log(">>> Unhandled message action: ", JSON.stringify(message, null, 4));
    }
  },
  closeNewMessage: function() {
    var _this = this;
    dialog.close('newMessage', {
      clear: true,
      afterClose: function() {
        if (typeof(FMLab) != "undefined" && LiveMessage.messages.length == 1 && !$('.pause-wrapper').is(':visible')) {
          FMLab.resume();
        }
        if (_this.messages[0].notification_type == 1) {
          readRole = 'Student';
          $.ajax({
            url: "/MM/Services/setReadMessage/" + _this.messages[0].mobyMessageID + "/" + _this.user_id + "/" + _this.messages[0].senderUserID + "/" + readRole,
            cache: false,
            dataType: "json",
            success: function(data) {}
          });
        } else if (_this.messages[0].notification_type == 2) {
          $.ajax({
            url: "/MM/Services/setVibeSeen/" + _this.messages[0].studentVibeID,
            cache: false,
            dataType: "json",
            success: function(data) {}
          });
        }
        if ($('#student-messenger-dialog').is(":visible")) showMessagenger();
        _this.messages.shift();
        if (_this.messages.length > 0) {
          if (_this.debug == 1) console.log(">>> Opening dialog box after close");
          _this.openMessage(_this.messages[0]);
        }
      }
    });
  },
  close: function() {
    if (this.debug == 1) console.log(">>> Unloading LiveMessage");
    if (!navigatingAway) {
      console.log('navigatingAway', navigatingAway);
      return false;
    }
    if (!this.client || !this.presence) return false;
    if (typeof(this.presence.data.teacher_ids) !== "undefined" && this.presence.data.teacher_ids.length) {
      for (var i in this.presence.data.teacher_ids) {
        if (isNaN(this.presence.data.teacher_ids[i])) continue;
        if (this.client) this.client.channels.get("t-" + this.presence.data.teacher_ids[i]).publish('presence', '["' + this.student_id + '"]', function(err) {});
      }
    }
  },
  sendMessage: function(teacherID) {
    if (app.jsVars.AblyRealtime) {
      teacherMessagesChannel = app.jsVars.AblyRealtime.channels.get('t-' + teacherID);
      teacherMessagesChannel.publish('newMessage', {
        messageType: 'from-student',
        student_id: app.jsVars.studentId
      }, function(err) {
        if (err) {
          console.log('realtime app error');
        }
      });
    } else {
      window.alert("Real time functionality not available at this moment. Please check back later.");
    }
  },
  logWindowUnload: function(module, newID, newAgent, newUrl, newStamp) {
    var fields = [{
      title: "Student Name",
      value: this.student_name,
      short: false,
    }, {
      title: "User ID",
      value: this.user_id,
      short: true,
    }, {
      title: "Student ID",
      value: this.student_id,
      short: true,
    }, {
      title: "Teacher ID",
      value: this.teacher_id.join(','),
      short: true,
    }, {
      title: "Module",
      value: module,
      short: true,
    }, {
      title: "Replaced Window ID",
      value: this.window_id,
      short: false,
    }, {
      title: "New Window ID",
      value: newID,
      short: false,
    }, {
      title: "Replaced User Agent",
      value: navigator.userAgent,
      short: false,
    }, {
      title: "New User Agent",
      value: newAgent,
      short: false,
    }, {
      title: "Replaced URL",
      value: window.location.toString(),
      short: false,
    }, {
      title: "New URL",
      value: newUrl,
      short: false,
    }, {
      title: "windowLoad Count",
      value: this.load_window_received,
      short: true,
    }, {
      title: "init() Count",
      value: this.init_count,
      short: true,
    }, {
      title: "Replaced TS",
      value: this.stamp,
      short: true,
    }, {
      title: "New TS",
      value: newStamp,
      short: true,
    }, {
      title: "Encountered",
      value: Date.now(),
      short: true,
    }, ];
    $.ajax({
      url: 'https://hooks.slack.com/services/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',
      type: 'POST',
      dataType: "json",
      data: JSON.stringify({
        text: "Multi-session logout:",
        attachments: [{
          fields: fields,
        }, ],
      }),
      error: function(err) {
        console.log("Unable to log:", err);
        console.log(JSON.stringify(fields, null, 4));
      }
    });
  },
};
var navigatingAway = true;
$(function() {
  $('a').on('click', function() {
    var url = $(this).attr('href');
    if (url === undefined || !url.length || url == "#" || url.indexOf("/MM") !== -1 || url.indexOf("moby") !== -1 || url.indexOf("localhost") !== -1)
      navigatingAway = false;
  });
  $('form').on('submit', function() {
    navigatingAway = false;
  });
  $(document).on('labUnload', function(e, data) {
    if (data.logout === 0) {
      $(document).triggerHandler('pageRedirected');
    }
  });
  $(document).on('pageRedirected', function() {
    console.log('pageRedirected');
    navigatingAway = false;
  });
});

function detectIE() {
  var ua = window.navigator.userAgent;
  if (ua.indexOf('MSIE ') > 0) {
    return true;
  } else if (ua.indexOf('Trident/') > 0) {
    return true;
  } else if (ua.indexOf('Edge/') > 0) {
    return true;
  }
  return false;
}
if (detectIE()) {
  window.addEventListener("unload", function(evt) {
    if (navigatingAway)
      LiveMessage.close();
  });
} else {
  window.addEventListener("beforeunload", function(evt) {
    if (navigatingAway)
      LiveMessage.close();
  });
}
if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
  window.addEventListener("pagehide", function(evt) {
    if (navigatingAway)
      LiveMessage.close();
  });
}
var Base64 = {
  _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
  encode: function(e) {
    var t = "";
    var n, r, i, s, o, u, a;
    var f = 0;
    e = Base64._utf8_encode(e);
    while (f < e.length) {
      n = e.charCodeAt(f++);
      r = e.charCodeAt(f++);
      i = e.charCodeAt(f++);
      s = n >> 2;
      o = (n & 3) << 4 | r >> 4;
      u = (r & 15) << 2 | i >> 6;
      a = i & 63;
      if (isNaN(r)) {
        u = a = 64
      } else if (isNaN(i)) {
        a = 64
      }
      t = t + this._keyStr.charAt(s) + this._keyStr.charAt(o) + this._keyStr.charAt(u) + this._keyStr.charAt(a)
    }
    return t
  },
  decode: function(e) {
    var t = "";
    var n, r, i;
    var s, o, u, a;
    var f = 0;
    e = e.replace(/[^A-Za-z0-9\+\/\=]/g, "");
    while (f < e.length) {
      s = this._keyStr.indexOf(e.charAt(f++));
      o = this._keyStr.indexOf(e.charAt(f++));
      u = this._keyStr.indexOf(e.charAt(f++));
      a = this._keyStr.indexOf(e.charAt(f++));
      n = s << 2 | o >> 4;
      r = (o & 15) << 4 | u >> 2;
      i = (u & 3) << 6 | a;
      t = t + String.fromCharCode(n);
      if (u != 64) {
        t = t + String.fromCharCode(r)
      }
      if (a != 64) {
        t = t + String.fromCharCode(i)
      }
    }
    t = Base64._utf8_decode(t);
    return t
  },
  _utf8_encode: function(e) {
    e = e.replace(/\r\n/g, "\n");
    var t = "";
    for (var n = 0; n < e.length; n++) {
      var r = e.charCodeAt(n);
      if (r < 128) {
        t += String.fromCharCode(r)
      } else if (r > 127 && r < 2048) {
        t += String.fromCharCode(r >> 6 | 192);
        t += String.fromCharCode(r & 63 | 128)
      } else {
        t += String.fromCharCode(r >> 12 | 224);
        t += String.fromCharCode(r >> 6 & 63 | 128);
        t += String.fromCharCode(r & 63 | 128)
      }
    }
    return t
  },
  _utf8_decode: function(e) {
    var t = "";
    var n = 0;
    var r = c1 = c2 = 0;
    while (n < e.length) {
      r = e.charCodeAt(n);
      if (r < 128) {
        t += String.fromCharCode(r);
        n++
      } else if (r > 191 && r < 224) {
        c2 = e.charCodeAt(n + 1);
        t += String.fromCharCode((r & 31) << 6 | c2 & 63);
        n += 2
      } else {
        c2 = e.charCodeAt(n + 1);
        c3 = e.charCodeAt(n + 2);
        t += String.fromCharCode((r & 15) << 12 | (c2 & 63) << 6 | c3 & 63);
        n += 3
      }
    }
    return t
  }
};
'use strict';
(function() {
  function ma(b) {
    if ("string" !== typeof b) throw new q("host must be a string; was a " + typeof b, 4E4, 400);
    if (!b.length) throw new q("host must not be zero-length", 4E4, 400);
  }
  var x = "object" === typeof window && window || "object" === typeof self && self,
    Z = x.Ably = this,
    z = z || function(b, d) {
      var f = {},
        a = f.lib = {},
        c = a.Base = function() {
          function c() {}
          return {
            extend: function(a) {
              c.prototype = this;
              var h = new c;
              a && h.mixIn(a);
              h.hasOwnProperty("init") || (h.init = function() {
                h.$super.init.apply(this, arguments)
              });
              h.init.prototype = h;
              h.$super = this;
              return h
            },
            create: function() {
              var c = this.extend();
              c.init.apply(c, arguments);
              return c
            },
            init: function() {},
            mixIn: function(c) {
              for (var a in c) c.hasOwnProperty(a) && (this[a] = c[a]);
              c.hasOwnProperty("toString") && (this.toString = c.toString)
            },
            clone: function() {
              return this.init.prototype.extend(this)
            }
          }
        }(),
        n = a.WordArray = c.extend({
          init: function(c, a) {
            c = this.words = c || [];
            this.sigBytes = a != d ? a : 4 * c.length
          },
          toString: function(c) {
            return (c || l).stringify(this)
          },
          concat: function(c) {
            var a = this.words,
              h = c.words,
              e = this.sigBytes;
            c = c.sigBytes;
            this.clamp();
            if (e % 4)
              for (var g = 0; g < c; g++) a[e + g >>> 2] |= (h[g >>> 2] >>> 24 - g % 4 * 8 & 255) << 24 - (e + g) % 4 * 8;
            else if (65535 < h.length)
              for (g = 0; g < c; g += 4) a[e + g >>> 2] = h[g >>> 2];
            else a.push.apply(a, h);
            this.sigBytes += c;
            return this
          },
          clamp: function() {
            var c = this.words,
              a = this.sigBytes;
            c[a >>> 2] &= 4294967295 << 32 - a % 4 * 8;
            c.length = b.ceil(a / 4)
          },
          clone: function() {
            var a = c.clone.call(this);
            a.words = this.words.slice(0);
            return a
          },
          random: function(c) {
            function a(c) {
              var a = 987654321;
              return function() {
                a = 36969 * (a & 65535) + (a >> 16) & 4294967295;
                c = 18E3 * (c & 65535) + (c >> 16) & 4294967295;
                return (((a << 16) + c & 4294967295) / 4294967296 + .5) * (.5 < b.random() ? 1 : -1)
              }
            }
            for (var h = [], g = 0, e; g < c; g += 4) {
              var f = a(4294967296 * (e || b.random()));
              e = 987654071 * f();
              h.push(4294967296 * f() | 0)
            }
            return new n.init(h, c)
          }
        }),
        e = f.enc = {},
        l = e.Hex = {
          stringify: function(c) {
            var a = c.words;
            c = c.sigBytes;
            for (var h = [], g = 0; g < c; g++) {
              var e = a[g >>> 2] >>> 24 - g % 4 * 8 & 255;
              h.push((e >>> 4).toString(16));
              h.push((e & 15).toString(16))
            }
            return h.join("")
          },
          parse: function(c) {
            for (var a = c.length, h = [], g = 0; g < a; g += 2) h[g >>> 3] |= parseInt(c.substr(g, 2), 16) << 24 - g % 8 * 4;
            return new n.init(h, a / 2)
          }
        },
        p = e.Latin1 = {
          stringify: function(c) {
            var a = c.words;
            c = c.sigBytes;
            for (var h = [], g = 0; g < c; g++) h.push(String.fromCharCode(a[g >>> 2] >>> 24 - g % 4 * 8 & 255));
            return h.join("")
          },
          parse: function(c) {
            for (var a = c.length, h = [], g = 0; g < a; g++) h[g >>> 2] |= (c.charCodeAt(g) & 255) << 24 - g % 4 * 8;
            return new n.init(h, a)
          }
        },
        g = e.Utf8 = {
          stringify: function(c) {
            try {
              return decodeURIComponent(escape(p.stringify(c)))
            } catch (w) {
              throw Error("Malformed UTF-8 data");
            }
          },
          parse: function(c) {
            return p.parse(unescape(encodeURIComponent(c)))
          }
        },
        v = a.BufferedBlockAlgorithm = c.extend({
          reset: function() {
            this._data = new n.init;
            this._nDataBytes = 0
          },
          _append: function(c) {
            "string" == typeof c && (c = g.parse(c));
            this._data.concat(c);
            this._nDataBytes += c.sigBytes
          },
          _process: function(c) {
            var a = this._data,
              h = a.words,
              g = a.sigBytes,
              e = this.blockSize,
              f = g / (4 * e);
            f = c ? b.ceil(f) : b.max((f | 0) - this._minBufferSize, 0);
            c = f * e;
            g = b.min(4 * c, g);
            if (c) {
              for (var l = 0; l < c; l += e) this._doProcessBlock(h, l);
              l = h.splice(0, c);
              a.sigBytes -= g
            }
            return new n.init(l, g)
          },
          clone: function() {
            var a = c.clone.call(this);
            a._data = this._data.clone();
            return a
          },
          _minBufferSize: 0
        });
      a.Hasher = v.extend({
        cfg: c.extend(),
        init: function(c) {
          this.cfg = this.cfg.extend(c);
          this.reset()
        },
        reset: function() {
          v.reset.call(this);
          this._doReset()
        },
        update: function(c) {
          this._append(c);
          this._process();
          return this
        },
        finalize: function(c) {
          c && this._append(c);
          return this._doFinalize()
        },
        blockSize: 16,
        _createHelper: function(c) {
          return function(a, h) {
            return (new c.init(h)).finalize(a)
          }
        },
        _createHmacHelper: function(c) {
          return function(a, g) {
            return (new h.HMAC.init(c, g)).finalize(a)
          }
        }
      });
      var h = f.algo = {};
      return f
    }(Math);
  (function(b) {
    var d = z,
      f = d.lib,
      a = f.WordArray,
      c = f.Hasher;
    f = d.algo;
    var n = [],
      e = [];
    (function() {
      function c(c) {
        for (var a = b.sqrt(c), h = 2; h <= a; h++)
          if (!(c % h)) return !1;
        return !0
      }

      function a(c) {
        return 4294967296 * (c - (c | 0)) | 0
      }
      for (var f = 2, h = 0; 64 > h;) c(f) && (8 > h && (n[h] = a(b.pow(f, .5))), e[h] = a(b.pow(f, 1 / 3)), h++), f++
    })();
    var l = [];
    f = f.SHA256 = c.extend({
      _doReset: function() {
        this._hash = new a.init(n.slice(0))
      },
      _doProcessBlock: function(c, a) {
        for (var g = this._hash.words, h = g[0], f = g[1], b = g[2], n = g[3], d = g[4], p = g[5], m = g[6], k = g[7], H = 0; 64 > H; H++) {
          if (16 > H) l[H] = c[a + H] | 0;
          else {
            var M = l[H - 15],
              q = l[H - 2];
            l[H] = ((M << 25 | M >>> 7) ^ (M << 14 | M >>> 18) ^ M >>> 3) + l[H - 7] + ((q << 15 | q >>> 17) ^ (q << 13 | q >>> 19) ^ q >>> 10) + l[H - 16]
          }
          M = k + ((d << 26 | d >>> 6) ^ (d << 21 | d >>> 11) ^ (d << 7 | d >>> 25)) + (d & p ^ ~d & m) + e[H] + l[H];
          q = ((h << 30 | h >>> 2) ^ (h << 19 | h >>> 13) ^ (h << 10 | h >>> 22)) + (h & f ^ h & b ^ f & b);
          k = m;
          m = p;
          p = d;
          d = n + M | 0;
          n = b;
          b = f;
          f = h;
          h = M + q | 0
        }
        g[0] = g[0] + h | 0;
        g[1] = g[1] + f | 0;
        g[2] = g[2] + b | 0;
        g[3] = g[3] + n | 0;
        g[4] = g[4] + d | 0;
        g[5] = g[5] + p | 0;
        g[6] = g[6] + m | 0;
        g[7] = g[7] + k | 0
      },
      _doFinalize: function() {
        var c = this._data,
          a = c.words,
          e = 8 * this._nDataBytes,
          h = 8 * c.sigBytes;
        a[h >>> 5] |= 128 << 24 - h % 32;
        a[(h + 64 >>> 9 << 4) + 14] = b.floor(e / 4294967296);
        a[(h + 64 >>> 9 << 4) + 15] = e;
        c.sigBytes = 4 * a.length;
        this._process();
        return this._hash
      },
      clone: function() {
        var a = c.clone.call(this);
        a._hash = this._hash.clone();
        return a
      }
    });
    d.SHA256 = c._createHelper(f);
    d.HmacSHA256 = c._createHmacHelper(f)
  })(Math);
  (function() {
    var b = z,
      d = b.enc.Utf8;
    b.algo.HMAC = b.lib.Base.extend({
      init: function(f, a) {
        f = this._hasher = new f.init;
        "string" == typeof a && (a = d.parse(a));
        var c = f.blockSize,
          b = 4 * c;
        a.sigBytes > b && (a = f.finalize(a));
        a.clamp();
        for (var e = this._oKey = a.clone(), l = this._iKey = a.clone(), p = e.words, g = l.words, v = 0; v < c; v++) p[v] ^= 1549556828, g[v] ^= 909522486;
        e.sigBytes = l.sigBytes = b;
        this.reset()
      },
      reset: function() {
        var f = this._hasher;
        f.reset();
        f.update(this._iKey)
      },
      update: function(f) {
        this._hasher.update(f);
        return this
      },
      finalize: function(f) {
        var a = this._hasher;
        f = a.finalize(f);
        a.reset();
        return a.finalize(this._oKey.clone().concat(f))
      }
    })
  })();
  (function() {
    var b = z,
      d = b.lib.WordArray;
    b.enc.Base64 = {
      stringify: function(f) {
        var a = f.words,
          c = f.sigBytes,
          b = this._map;
        f.clamp();
        f = [];
        for (var e = 0; e < c; e += 3)
          for (var d = (a[e >>> 2] >>> 24 - e % 4 * 8 & 255) << 16 | (a[e + 1 >>> 2] >>> 24 - (e + 1) % 4 * 8 & 255) << 8 | a[e + 2 >>> 2] >>> 24 - (e + 2) % 4 * 8 & 255, p = 0; 4 > p && e + .75 * p < c; p++) f.push(b.charAt(d >>> 6 * (3 - p) & 63));
        if (a = b.charAt(64))
          for (; f.length % 4;) f.push(a);
        return f.join("")
      },
      parse: function(f) {
        var a = f.length,
          c = this._map,
          b = c.charAt(64);
        b && (b = f.indexOf(b), -1 != b && (a = b));
        b = [];
        for (var e = 0, l = 0; l < a; l++)
          if (l % 4) {
            var p = c.indexOf(f.charAt(l - 1)) << l % 4 * 2,
              g = c.indexOf(f.charAt(l)) >>> 6 - l % 4 * 2;
            b[e >>> 2] |= (p | g) << 24 - e % 4 * 8;
            e++
          } return d.create(b, e)
      },
      _map: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="
    }
  })();
  z.lib.Cipher || function(b) {
    var d = z,
      f = d.lib,
      a = f.Base,
      c = f.WordArray,
      n = f.BufferedBlockAlgorithm,
      e = d.enc.Base64,
      l = d.algo.EvpKDF,
      p = f.Cipher = n.extend({
        cfg: a.extend(),
        createEncryptor: function(c, a) {
          return this.create(this._ENC_XFORM_MODE, c, a)
        },
        createDecryptor: function(c, a) {
          return this.create(this._DEC_XFORM_MODE, c, a)
        },
        init: function(c, a, h) {
          this.cfg = this.cfg.extend(h);
          this._xformMode = c;
          this._key = a;
          this.reset()
        },
        reset: function() {
          n.reset.call(this);
          this._doReset()
        },
        process: function(c) {
          this._append(c);
          return this._process()
        },
        finalize: function(c) {
          c && this._append(c);
          return this._doFinalize()
        },
        keySize: 4,
        ivSize: 4,
        _ENC_XFORM_MODE: 1,
        _DEC_XFORM_MODE: 2,
        _createHelper: function() {
          return function(c) {
            return {
              encrypt: function(a, h, g) {
                return ("string" == typeof h ? R : w).encrypt(c, a, h, g)
              },
              decrypt: function(a, h, g) {
                return ("string" == typeof h ? R : w).decrypt(c, a, h, g)
              }
            }
          }
        }()
      });
    f.StreamCipher = p.extend({
      _doFinalize: function() {
        return this._process(!0)
      },
      blockSize: 1
    });
    var g = d.mode = {},
      v = f.BlockCipherMode = a.extend({
        createEncryptor: function(c, a) {
          return this.Encryptor.create(c, a)
        },
        createDecryptor: function(c, a) {
          return this.Decryptor.create(c, a)
        },
        init: function(c, a) {
          this._cipher = c;
          this._iv = a
        }
      });
    g = g.CBC = function() {
      function c(c, a, h) {
        var g = this._iv;
        g ? this._iv = b : g = this._prevBlock;
        for (var e = 0; e < h; e++) c[a + e] ^= g[e]
      }
      var a = v.extend();
      a.Encryptor = a.extend({
        processBlock: function(a, h) {
          var g = this._cipher,
            e = g.blockSize;
          c.call(this, a, h, e);
          g.encryptBlock(a, h);
          this._prevBlock = a.slice(h, h + e)
        }
      });
      a.Decryptor = a.extend({
        processBlock: function(a, h) {
          var g = this._cipher,
            e = g.blockSize,
            b = a.slice(h, h + e);
          g.decryptBlock(a, h);
          c.call(this, a, h, e);
          this._prevBlock = b
        }
      });
      return a
    }();
    var h = (d.pad = {}).Pkcs7 = {
      pad: function(a, h) {
        var g = 4 * h;
        g -= a.sigBytes % g;
        for (var e = g << 24 | g << 16 | g << 8 | g, b = [], d = 0; d < g; d += 4) b.push(e);
        g = c.create(b, g);
        a.concat(g)
      },
      unpad: function(c) {
        c.sigBytes -= c.words[c.sigBytes - 1 >>> 2] & 255
      }
    };
    f.BlockCipher = p.extend({
      cfg: p.cfg.extend({
        mode: g,
        padding: h
      }),
      reset: function() {
        p.reset.call(this);
        var c = this.cfg,
          a = c.iv;
        c = c.mode;
        if (this._xformMode == this._ENC_XFORM_MODE) var h = c.createEncryptor;
        else h = c.createDecryptor, this._minBufferSize = 1;
        this._mode = h.call(c, this, a && a.words)
      },
      _doProcessBlock: function(c, a) {
        this._mode.processBlock(c, a)
      },
      _doFinalize: function() {
        var c = this.cfg.padding;
        if (this._xformMode == this._ENC_XFORM_MODE) {
          c.pad(this._data, this.blockSize);
          var a = this._process(!0)
        } else a = this._process(!0), c.unpad(a);
        return a
      },
      blockSize: 4
    });
    var u = f.CipherParams = a.extend({
      init: function(c) {
        this.mixIn(c)
      },
      toString: function(c) {
        return (c || this.formatter).stringify(this)
      }
    });
    g = (d.format = {}).OpenSSL = {
      stringify: function(a) {
        var h = a.ciphertext;
        a = a.salt;
        return (a ? c.create([1398893684, 1701076831]).concat(a).concat(h) : h).toString(e)
      },
      parse: function(a) {
        a = e.parse(a);
        var h = a.words;
        if (1398893684 == h[0] && 1701076831 == h[1]) {
          var g = c.create(h.slice(2, 4));
          h.splice(0, 4);
          a.sigBytes -= 16
        }
        return u.create({
          ciphertext: a,
          salt: g
        })
      }
    };
    var w = f.SerializableCipher = a.extend({
      cfg: a.extend({
        format: g
      }),
      encrypt: function(c, a, h, g) {
        g = this.cfg.extend(g);
        var e = c.createEncryptor(h, g);
        a = e.finalize(a);
        e = e.cfg;
        return u.create({
          ciphertext: a,
          key: h,
          iv: e.iv,
          algorithm: c,
          mode: e.mode,
          padding: e.padding,
          blockSize: c.blockSize,
          formatter: g.format
        })
      },
      decrypt: function(c, a, h, g) {
        g = this.cfg.extend(g);
        a = this._parse(a, g.format);
        return c.createDecryptor(h, g).finalize(a.ciphertext)
      },
      _parse: function(c, a) {
        return "string" == typeof c ? a.parse(c, this) : c
      }
    });
    d = (d.kdf = {}).OpenSSL = {
      execute: function(a, h, g, e) {
        e || (e = c.random(8));
        a = l.create({
          keySize: h + g
        }).compute(a, e);
        g = c.create(a.words.slice(h), 4 * g);
        a.sigBytes = 4 * h;
        return u.create({
          key: a,
          iv: g,
          salt: e
        })
      }
    };
    var R = f.PasswordBasedCipher = w.extend({
      cfg: w.cfg.extend({
        kdf: d
      }),
      encrypt: function(c, a, h, g) {
        g = this.cfg.extend(g);
        h = g.kdf.execute(h, c.keySize, c.ivSize);
        g.iv = h.iv;
        c = w.encrypt.call(this, c, a, h.key, g);
        c.mixIn(h);
        return c
      },
      decrypt: function(c, a, h, g) {
        g = this.cfg.extend(g);
        a = this._parse(a, g.format);
        h = g.kdf.execute(h, c.keySize, c.ivSize, a.salt);
        g.iv = h.iv;
        return w.decrypt.call(this, c, a, h.key, g)
      }
    })
  }();
  (function() {
    var b = z,
      d = b.lib.BlockCipher,
      f = b.algo,
      a = [],
      c = [],
      n = [],
      e = [],
      l = [],
      p = [],
      g = [],
      v = [],
      h = [],
      u = [];
    (function() {
      for (var b = [], d = 0; 256 > d; d++) b[d] = 128 > d ? d << 1 : d << 1 ^ 283;
      var f = 0,
        w = 0;
      for (d = 0; 256 > d; d++) {
        var m = w ^ w << 1 ^ w << 2 ^ w << 3 ^ w << 4;
        m = m >>> 8 ^ m & 255 ^ 99;
        a[f] = m;
        c[m] = f;
        var k = b[f],
          q = b[k],
          t = b[q],
          r = 257 * b[m] ^ 16843008 * m;
        n[f] = r << 24 | r >>> 8;
        e[f] = r << 16 | r >>> 16;
        l[f] = r << 8 | r >>> 24;
        p[f] = r;
        r = 16843009 * t ^ 65537 * q ^ 257 * k ^ 16843008 * f;
        g[m] = r << 24 | r >>> 8;
        v[m] = r << 16 | r >>> 16;
        h[m] = r << 8 | r >>> 24;
        u[m] = r;
        f ? (f = k ^ b[b[b[t ^ k]]], w ^= b[b[w]]) : f = w = 1
      }
    })();
    var w = [0, 1, 2, 4, 8, 16, 32, 64, 128, 27, 54];
    f = f.AES = d.extend({
      _doReset: function() {
        var c = this._key,
          e = c.words,
          b = c.sigBytes / 4;
        c = 4 * ((this._nRounds = b + 6) + 1);
        for (var d = this._keySchedule = [], f = 0; f < c; f++)
          if (f < b) d[f] = e[f];
          else {
            var l = d[f - 1];
            f % b ? 6 < b && 4 == f % b && (l = a[l >>> 24] << 24 | a[l >>> 16 & 255] << 16 | a[l >>> 8 & 255] << 8 | a[l & 255]) : (l = l << 8 | l >>> 24, l = a[l >>> 24] << 24 | a[l >>> 16 & 255] << 16 | a[l >>> 8 & 255] << 8 | a[l & 255], l ^= w[f / b | 0] << 24);
            d[f] = d[f - b] ^ l
          } e = this._invKeySchedule = [];
        for (b = 0; b < c; b++) f = c - b, l = b % 4 ? d[f] : d[f - 4], e[b] = 4 > b || 4 >= f ? l : g[a[l >>> 24]] ^ v[a[l >>> 16 & 255]] ^ h[a[l >>> 8 & 255]] ^ u[a[l & 255]]
      },
      encryptBlock: function(c, h) {
        this._doCryptBlock(c, h, this._keySchedule, n, e, l, p, a)
      },
      decryptBlock: function(a, e) {
        var b = a[e + 1];
        a[e + 1] = a[e + 3];
        a[e + 3] = b;
        this._doCryptBlock(a, e, this._invKeySchedule, g, v, h, u, c);
        b = a[e + 1];
        a[e + 1] = a[e + 3];
        a[e + 3] = b
      },
      _doCryptBlock: function(c, a, h, g, e, b, f, d) {
        for (var l = this._nRounds, n = c[a] ^ h[0], v = c[a + 1] ^ h[1], w = c[a + 2] ^ h[2], p = c[a + 3] ^ h[3], u = 4, m = 1; m < l; m++) {
          var k = g[n >>> 24] ^ e[v >>> 16 & 255] ^ b[w >>> 8 & 255] ^ f[p & 255] ^ h[u++],
            R = g[v >>> 24] ^ e[w >>> 16 & 255] ^ b[p >>> 8 & 255] ^ f[n & 255] ^ h[u++],
            aa = g[w >>> 24] ^ e[p >>> 16 & 255] ^ b[n >>> 8 & 255] ^ f[v & 255] ^ h[u++];
          p = g[p >>> 24] ^ e[n >>> 16 & 255] ^ b[v >>> 8 & 255] ^ f[w & 255] ^ h[u++];
          n = k;
          v = R;
          w = aa
        }
        k = (d[n >>> 24] << 24 | d[v >>> 16 & 255] << 16 | d[w >>> 8 & 255] << 8 | d[p & 255]) ^ h[u++];
        R = (d[v >>> 24] << 24 | d[w >>> 16 & 255] << 16 | d[p >>> 8 & 255] << 8 | d[n & 255]) ^ h[u++];
        aa = (d[w >>> 24] << 24 | d[p >>> 16 & 255] << 16 | d[n >>> 8 & 255] << 8 | d[v & 255]) ^ h[u++];
        p = (d[p >>> 24] << 24 | d[n >>> 16 & 255] << 16 | d[v >>> 8 & 255] << 8 | d[w & 255]) ^ h[u++];
        c[a] = k;
        c[a + 1] = R;
        c[a + 2] = aa;
        c[a + 3] = p
      },
      keySize: 8
    });
    b.AES = d._createHelper(f)
  })();
  (function() {
    if ("undefined" !== typeof ArrayBuffer) {
      var b = z.lib.WordArray,
        d = b.init;
      (b.init = function(b) {
        if (b instanceof ArrayBuffer) b = new Uint8Array(b);
        else if (b instanceof Int8Array || "undefined" !== typeof Uint8ClampedArray && b instanceof Uint8ClampedArray || b instanceof Int16Array || b instanceof Uint16Array || b instanceof Int32Array || b instanceof Uint32Array || "undefined" !== typeof Float32Array && b instanceof Float32Array || "undefined" !== typeof Float64Array && b instanceof Float64Array) b = new Uint8Array(b.buffer, b.byteOffset, b.byteLength);
        if (b instanceof Uint8Array) {
          for (var a = b.byteLength, c = [], f = 0; f < a; f++) c[f >>> 2] |= b[f] << 24 -
            f % 4 * 8;
          d.call(this, c, a)
        } else d.apply(this, arguments)
      }).prototype = b
    }
  })();
  var ha = function() {
      function b() {}
      b.addListener = function(b, d, a) {
        b.addEventListener ? b.addEventListener(d, a, !1) : b.attachEvent("on" + d, function() {
          a.apply(b, arguments)
        })
      };
      b.removeListener = function(b, d, a) {
        b.removeEventListener ? b.removeEventListener(d, a, !1) : b.detachEvent("on" + d, function() {
          a.apply(b, arguments)
        })
      };
      b.addMessageListener = function(d, f) {
        b.addListener(d, "message", f)
      };
      b.removeMessageListener = function(d, f) {
        b.removeListener(d, "message", f)
      };
      b.addUnloadListener = function(d) {
        b.addListener(x, "unload", d)
      };
      return b
    }(),
    ia = function() {
      function b(c, a, h) {
        for (var g = 0, e = h.length; g < e; g++) {
          var b = h.charCodeAt(g);
          if (128 > b) c.setUint8(a++, b >>> 0 & 127 | 0);
          else if (2048 > b) c.setUint8(a++, b >>> 6 & 31 | 192), c.setUint8(a++, b >>> 0 & 63 | 128);
          else if (65536 > b) c.setUint8(a++, b >>> 12 & 15 | 224), c.setUint8(a++, b >>> 6 & 63 | 128), c.setUint8(a++, b >>> 0 & 63 | 128);
          else if (1114112 > b) c.setUint8(a++, b >>> 18 & 7 | 240), c.setUint8(a++, b >>> 12 & 63 | 128), c.setUint8(a++, b >>> 6 & 63 | 128), c.setUint8(a++, b >>> 0 & 63 | 128);
          else throw Error("bad codepoint " + b);
        }
      }

      function d(c, a, h) {
        var g = "",
          e = a;
        for (a += h; e < a; e++)
          if (h = c.getUint8(e), 0 === (h & 128)) g += String.fromCharCode(h);
          else if (192 === (h & 224)) g += String.fromCharCode((h & 15) << 6 | c.getUint8(++e) & 63);
        else if (224 === (h & 240)) g += String.fromCharCode((h & 15) << 12 | (c.getUint8(++e) & 63) << 6 | (c.getUint8(++e) & 63) << 0);
        else if (240 === (h & 248)) g += String.fromCharCode((h & 7) << 18 | (c.getUint8(++e) & 63) << 12 | (c.getUint8(++e) & 63) << 6 | (c.getUint8(++e) & 63) << 0);
        else throw Error("Invalid byte " + h.toString(16));
        return g
      }

      function f(c) {
        for (var a = 0, h = 0, g = c.length; h < g; h++) {
          var e = c.charCodeAt(h);
          if (128 > e) a += 1;
          else if (2048 > e) a += 2;
          else if (65536 > e) a += 3;
          else if (1114112 > e) a += 4;
          else throw Error("bad codepoint " + e);
        }
        return a
      }

      function a(c, a) {
        this.offset = a || 0;
        this.view = c
      }

      function c(c, a) {
        return k.keysArray(c, !0).filter(function(h) {
          h = c[h];
          return (!a || void 0 !== h && null !== h) && ("function" !== typeof h || !!h.toJSON)
        })
      }

      function n(a, e, h, d) {
        var g = typeof a;
        if ("string" === g) {
          var l = f(a);
          if (32 > l) return e.setUint8(h, l | 160), b(e, h + 1, a), 1 +
            l;
          if (256 > l) return e.setUint8(h, 217), e.setUint8(h + 1, l), b(e, h + 2, a), 2 + l;
          if (65536 > l) return e.setUint8(h, 218), e.setUint16(h + 1, l), b(e, h + 3, a), 3 + l;
          if (4294967296 > l) return e.setUint8(h, 219), e.setUint32(h + 1, l), b(e, h + 5, a), 5 + l
        }
        ArrayBuffer.isView && ArrayBuffer.isView(a) && (a = a.buffer);
        if (a instanceof ArrayBuffer) {
          l = a.byteLength;
          if (256 > l) return e.setUint8(h, 196), e.setUint8(h + 1, l), (new Uint8Array(e.buffer)).set(new Uint8Array(a), h + 2), 2 + l;
          if (65536 > l) return e.setUint8(h, 197), e.setUint16(h + 1, l), (new Uint8Array(e.buffer)).set(new Uint8Array(a), h + 3), 3 + l;
          if (4294967296 > l) return e.setUint8(h, 198), e.setUint32(h + 1, l), (new Uint8Array(e.buffer)).set(new Uint8Array(a), h + 5), 5 + l
        }
        if ("number" === g) {
          if (Math.floor(a) !== a) return e.setUint8(h, 203), e.setFloat64(h + 1, a), 9;
          if (0 <= a) {
            if (128 > a) return e.setUint8(h, a), 1;
            if (256 > a) return e.setUint8(h, 204), e.setUint8(h + 1, a), 2;
            if (65536 > a) return e.setUint8(h, 205), e.setUint16(h + 1, a), 3;
            if (4294967296 > a) return e.setUint8(h, 206), e.setUint32(h + 1, a), 5;
            if (1.8446744073709552E19 > a) return e.setUint8(h, 207), h += 1, 1.8446744073709552E19 > a ? (e.setUint32(h, Math.floor(a * p)), e.setInt32(h + 4, a & -1)) : (e.setUint32(h, 4294967295), e.setUint32(h + 4, 4294967295)), 9;
            throw Error("Number too big 0x" + a.toString(16));
          }
          if (-32 <= a) return e.setInt8(h, a), 1;
          if (-128 <= a) return e.setUint8(h, 208), e.setInt8(h + 1, a), 2;
          if (-32768 <= a) return e.setUint8(h, 209), e.setInt16(h + 1, a), 3;
          if (-2147483648 <= a) return e.setUint8(h, 210), e.setInt32(h + 1, a), 5;
          if (-9223372036854775808 <= a) return e.setUint8(h, 211), h += 1, 0x7fffffffffffffff > a ? (e.setInt32(h, Math.floor(a * p)), e.setInt32(h + 4, a & -1)) : (e.setUint32(h, 2147483647), e.setUint32(h + 4, 2147483647)), 9;
          throw Error("Number too small -0x" + (-a).toString(16).substr(1));
        }
        if ("undefined" === g) {
          if (d) return 0;
          e.setUint8(h, 212);
          e.setUint8(h + 1, 0);
          e.setUint8(h + 2, 0);
          return 3
        }
        if (null === a) {
          if (d) return 0;
          e.setUint8(h, 192);
          return 1
        }
        if ("boolean" === g) return e.setUint8(h, a ? 195 : 194), 1;
        if ("function" === typeof a.toJSON) return n(a.toJSON(), e, h, d);
        if ("object" === g) {
          g = 0;
          var u = Array.isArray(a);
          if (u) l = a.length;
          else {
            var v = c(a, d);
            l = v.length
          }
          16 > l ? (e.setUint8(h, l | (u ? 144 : 128)), g = 1) : 65536 > l ? (e.setUint8(h, u ? 220 : 222), e.setUint16(h + 1, l), g = 3) : 4294967296 > l && (e.setUint8(h, u ? 221 : 223), e.setUint32(h + 1, l), g = 5);
          if (u)
            for (u = 0; u < l; u++) g += n(a[u], e, h + g, d);
          else
            for (u = 0; u < l; u++) {
              var m = v[u];
              g += n(m, e, h + g);
              g += n(a[m], e, h + g, d)
            }
          return g
        }
        if ("function" === g) return 0;
        throw Error("Unknown type " + g);
      }

      function e(a, b) {
        var h = typeof a;
        if ("string" === h) {
          var g = f(a);
          if (32 > g) return 1 + g;
          if (256 > g) return 2 + g;
          if (65536 > g) return 3 + g;
          if (4294967296 > g) return 5 + g
        }
        ArrayBuffer.isView && ArrayBuffer.isView(a) && (a = a.buffer);
        if (a instanceof ArrayBuffer) {
          g = a.byteLength;
          if (256 > g) return 2 + g;
          if (65536 > g) return 3 + g;
          if (4294967296 > g) return 5 + g
        }
        if ("number" === h) {
          if (Math.floor(a) !== a) return 9;
          if (0 <= a) {
            if (128 > a) return 1;
            if (256 > a) return 2;
            if (65536 > a) return 3;
            if (4294967296 > a) return 5;
            if (1.8446744073709552E19 > a) return 9;
            throw Error("Number too big 0x" + a.toString(16));
          }
          if (-32 <= a) return 1;
          if (-128 <= a) return 2;
          if (-32768 <= a) return 3;
          if (-2147483648 <= a) return 5;
          if (-9223372036854775808 <= a) return 9;
          throw Error("Number too small -0x" + a.toString(16).substr(1));
        }
        if ("boolean" === h) return 1;
        if (null === a) return b ? 0 : 1;
        if (void 0 === a) return b ? 0 : 3;
        if ("function" === typeof a.toJSON) return e(a.toJSON(), b);
        if ("object" === h) {
          h = 0;
          if (Array.isArray(a)) {
            g = a.length;
            for (var d = 0; d < g; d++) h += e(a[d], b)
          } else {
            var l = c(a, b);
            g = l.length;
            for (d = 0; d < g; d++) {
              var n = l[d];
              h += e(n) + e(a[n], b)
            }
          }
          if (16 > g) return 1 + h;
          if (65536 > g) return 3 + h;
          if (4294967296 > g) return 5 + h;
          throw Error("Array or object too long 0x" + g.toString(16));
        }
        if ("function" === h) return 0;
        throw Error("Unknown type " + h);
      }
      var l = {
        inspect: function(a) {
          if (void 0 === a) return "undefined";
          if (a instanceof ArrayBuffer) {
            var c = "ArrayBuffer";
            var h = new DataView(a)
          } else a instanceof DataView && (c = "DataView", h = a);
          if (!h) return JSON.stringify(a);
          for (var e = [], g = 0; g < a.byteLength; g++) {
            if (20 < g) {
              e.push("...");
              break
            }
            var b = h.getUint8(g).toString(16);
            1 === b.length && (b = "0" + b);
            e.push(b)
          }
          return "<" + c + " " + e.join(" ") + ">"
        }
      };
      l.utf8Write = b;
      l.utf8Read = d;
      l.utf8ByteCount = f;
      l.encode = function(a, c) {
        var h = e(a, c);
        if (0 != h) {
          h = new ArrayBuffer(h);
          var g = new DataView(h);
          n(a, g, 0, c);
          return h
        }
      };
      l.decode = function(c) {
        var e = new DataView(c);
        e = new a(e);
        var h = e.parse();
        if (e.offset !== c.byteLength) throw Error(c.byteLength - e.offset + " trailing bytes");
        return h
      };
      var p = 1 / 4294967296;
      a.prototype.map = function(a) {
        for (var c = {}, h = 0; h < a; h++) {
          var e = this.parse();
          c[e] = this.parse()
        }
        return c
      };
      a.prototype.bin = a.prototype.buf = function(a) {
        var c = new ArrayBuffer(a);
        (new Uint8Array(c)).set(new Uint8Array(this.view.buffer, this.offset, a), 0);
        this.offset += a;
        return c
      };
      a.prototype.str = function(a) {
        var c = d(this.view, this.offset, a);
        this.offset += a;
        return c
      };
      a.prototype.array = function(a) {
        for (var c = Array(a), h = 0; h < a; h++) c[h] = this.parse();
        return c
      };
      a.prototype.ext = function(a) {
        var c = {};
        c.type = this.view.getInt8(this.offset);
        this.offset++;
        c.data = this.buf(a);
        this.offset += a;
        return c
      };
      a.prototype.parse = function() {
        var a = this.view.getUint8(this.offset);
        if (0 === (a & 128)) return this.offset++, a;
        if (128 === (a & 240)) return this.offset++, this.map(a & 15);
        if (144 === (a & 240)) return this.offset++, this.array(a & 15);
        if (160 === (a & 224)) return this.offset++, this.str(a & 31);
        if (224 === (a & 224)) return a = this.view.getInt8(this.offset), this.offset++, a;
        switch (a) {
          case 192:
            return this.offset++, null;
          case 193:
            this.offset++;
            return;
          case 194:
            return this.offset++, !1;
          case 195:
            return this.offset++, !0;
          case 196:
            return a = this.view.getUint8(this.offset + 1), this.offset += 2, this.bin(a);
          case 197:
            return a = this.view.getUint16(this.offset + 1), this.offset += 3, this.bin(a);
          case 198:
            return a = this.view.getUint32(this.offset + 1), this.offset += 5, this.bin(a);
          case 199:
            return a = this.view.getUint8(this.offset + 1), this.offset += 2, this.ext(a);
          case 200:
            return a = this.view.getUint16(this.offset + 1), this.offset += 3, this.ext(a);
          case 201:
            return a = this.view.getUint32(this.offset + 1), this.offset += 5, this.ext(a);
          case 202:
            return a = this.view.getFloat32(this.offset + 1), this.offset += 5, a;
          case 203:
            return a = this.view.getFloat64(this.offset + 1), this.offset += 9, a;
          case 204:
            return a = this.view.getUint8(this.offset + 1), this.offset += 2, a;
          case 205:
            return a = this.view.getUint16(this.offset + 1), this.offset += 3, a;
          case 206:
            return a = this.view.getUint32(this.offset + 1), this.offset += 5, a;
          case 207:
            a = this.view;
            var c = this.offset + 1;
            c = c || 0;
            a = 4294967296 * a.getUint32(c) + a.getUint32(c + 4);
            this.offset += 9;
            return a;
          case 208:
            return a = this.view.getInt8(this.offset + 1), this.offset += 2, a;
          case 209:
            return a = this.view.getInt16(this.offset + 1), this.offset += 3, a;
          case 210:
            return a = this.view.getInt32(this.offset + 1), this.offset += 5, a;
          case 211:
            return a = this.view, c = (c = this.offset + 1) || 0, a = 4294967296 * a.getInt32(c) + a.getUint32(c + 4), this.offset += 9, a;
          case 212:
            return this.offset++, this.ext(1);
          case 213:
            return this.offset++, this.ext(2);
          case 214:
            return this.offset++, this.ext(4);
          case 215:
            return this.offset++, this.ext(8);
          case 216:
            return this.offset++, this.ext(16);
          case 217:
            return a = this.view.getUint8(this.offset + 1), this.offset += 2, this.str(a);
          case 218:
            return a = this.view.getUint16(this.offset + 1), this.offset += 3, this.str(a);
          case 219:
            return a = this.view.getUint32(this.offset + 1), this.offset += 5, this.str(a);
          case 220:
            return a = this.view.getUint16(this.offset + 1), this.offset += 3, this.array(a);
          case 221:
            return a = this.view.getUint32(this.offset +
              1), this.offset += 5, this.array(a);
          case 222:
            return a = this.view.getUint16(this.offset + 1), this.offset += 3, this.map(a);
          case 223:
            return a = this.view.getUint32(this.offset + 1), this.offset += 5, this.map(a)
        }
        throw Error("Unknown type 0x" + a.toString(16));
      };
      return l
    }();
  "undefined" === typeof Window && "undefined" === typeof WorkerGlobalScope && console.log("Warning: this distribution of Ably is intended for browsers. On nodejs, please use the 'ably' package on npm");
  var ba = x.navigator && x.navigator.userAgent.toString(),
    r = {
      libver: "js-web",
      logTimestamps: !0,
      userAgent: ba,
      currentUrl: x.location && x.location.href,
      noUpgrade: ba && ba.match(/MSIE\s8\.0/),
      binaryType: "arraybuffer",
      WebSocket: x.WebSocket || x.MozWebSocket,
      xhrSupported: x.XMLHttpRequest && "withCredentials" in new XMLHttpRequest,
      jsonpSupported: "undefined" !== typeof document,
      allowComet: function() {
        var b = x.location;
        return !x.WebSocket || !b || !b.origin || -1 < b.origin.indexOf("http")
      }(),
      streamingSupported: !0,
      useProtocolHeartbeats: !0,
      createHmac: null,
      msgpack: ia,
      supportsBinary: !!x.TextDecoder,
      preferBinary: !1,
      ArrayBuffer: x.ArrayBuffer,
      atob: x.atob,
      nextTick: function(b) {
        setTimeout(b, 0)
      },
      addEventListener: x.addEventListener,
      inspect: JSON.stringify,
      stringByteSize: function(b) {
        return x.TextDecoder && (new x.TextEncoder).encode(b).length || b.length
      },
      TextEncoder: x.TextEncoder,
      TextDecoder: x.TextDecoder,
      Promise: x.Promise,
      getRandomValues: function(b) {
        if (void 0 !== b) return function(d, f) {
          b.getRandomValues(d);
          f && f(null)
        }
      }(x.crypto || x.msCrypto)
    },
    S = function() {
      function b() {}

      function m() {
        this.key = this.mode = this.keyLength = this.algorithm = null
      }

      function f(a, c, e) {
        this.algorithm = a.algorithm + "-" + String(a.keyLength) + "-" + a.mode;
        this.cjsAlgorithm = a.algorithm.toUpperCase().replace(/-\d+$/, "");
        this.key = y.toWordArray(a.key);
        e && (this.iv = y.toWordArray(e).clone());
        this.blockLengthWords = c
      }
      var a = z.lib.WordArray;
      if (r.getRandomWordArray) var c = r.getRandomWordArray;
      else if ("undefined" !== typeof Uint32Array && r.getRandomValues) {
        var n = new Uint32Array(4);
        c = function(a, c) {
          var e = a / 4,
            b = 4 == e ? n : new Uint32Array(e);
          r.getRandomValues(b, function(a) {
            c(a, y.toWordArray(b))
          })
        }
      } else c = function(c, e) {
        d.logAction(d.LOG_MAJOR, "Ably.Crypto.generateRandom()", "Warning: the browser you are using does not support secure cryptographically secure randomness generation; falling back to insecure Math.random()");
        for (var b = c / 4, l = Array(b), h = 0; h < b; h++) l[h] = Math.floor(4294967296 * Math.random()) - 2147483648;
        e(null, a.create(l))
      };
      a.create([0, 0, 0, 0]);
      var e = [a.create([269488144, 269488144, 269488144, 269488144], 16), a.create([16777216], 1), a.create([33685504], 2), a.create([50529024], 3), a.create([67372036], 4), a.create([84215045, 83886080], 5), a.create([101058054, 101056512], 6), a.create([117901063, 117901056], 7), a.create([134744072, 134744072], 8), a.create([151587081, 151587081, 150994944], 9), a.create([168430090, 168430090, 168427520], 10), a.create([185273099, 185273099, 185273088], 11), a.create([202116108, 202116108, 202116108], 12), a.create([218959117, 218959117, 218959117, 218103808], 13), a.create([235802126, 235802126, 235802126, 235798528], 14), a.create([252645135, 252645135, 252645135, 252645135], 15), a.create([269488144, 269488144, 269488144, 269488144], 16)];
      b.CipherParams = m;
      b.getDefaultParams = function(a) {
        if ("function" === typeof a || "string" === typeof a)
          if (d.deprecated("Crypto.getDefaultParams(key, callback)", "Crypto.getDefaultParams({key: key})"), "function" === typeof a) b.generateRandomKey(function(c) {
            a(null, b.getDefaultParams({
              key: c
            }))
          });
          else if ("function" === typeof arguments[1]) arguments[1](null, b.getDefaultParams({
          key: a
        }));
        else throw Error("Invalid arguments for Crypto.getDefaultParams");
        else {
          if (!a.key) throw Error("Crypto.getDefaultParams: a key is required");
          var c = "string" === typeof a.key ? z.enc.Base64.parse(a.key.replace("_", "/").replace("-", "+")) : y.toWordArray(a.key);
          var e = new m;
          e.key = c;
          e.algorithm = a.algorithm || "aes";
          e.keyLength = 32 * c.words.length;
          e.mode = a.mode || "cbc";
          if (a.keyLength && a.keyLength !== e.keyLength) throw Error("Crypto.getDefaultParams: a keyLength of " + a.keyLength + " was specified, but the key actually has length " + e.keyLength);
          if ("aes" === e.algorithm && "cbc" === e.mode && 128 !== e.keyLength && 256 !== e.keyLength) throw Error("Unsupported key length " +
            e.keyLength + " for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)");
          return e
        }
      };
      b.generateRandomKey = function(a, e) {
        1 == arguments.length && "function" == typeof a && (e = a, a = void 0);
        c((a || 256) / 8, e)
      };
      b.getCipher = function(a) {
        var c = a instanceof m ? a : b.getDefaultParams(a);
        return {
          cipherParams: c,
          cipher: new f(c, 4, a.iv)
        }
      };
      f.prototype.encrypt = function(a, b) {
        function g() {
          l.getIv(function(c, d) {
            if (c) b(c);
            else {
              var g = l.encryptCipher.process(a.concat(e[h - f]));
              g = d.concat(g);
              b(null, g)
            }
          })
        }
        d.logAction(d.LOG_MICRO, "CBCCipher.encrypt()", "");
        a = y.toWordArray(a);
        var f = a.sigBytes,
          h = f + 16 & -16,
          l = this;
        this.encryptCipher ? g() : this.iv ? (this.encryptCipher = z.algo[this.cjsAlgorithm].createEncryptor(this.key, {
          iv: this.iv
        }), g()) : c(16, function(a, c) {
          a ? b(a) : (l.encryptCipher = z.algo[l.cjsAlgorithm].createEncryptor(l.key, {
            iv: c
          }), l.iv = c, g())
        })
      };
      f.prototype.decrypt = function(c) {
        d.logAction(d.LOG_MICRO, "CBCCipher.decrypt()", "");
        c = y.toWordArray(c);
        var e = this.blockLengthWords,
          b = c.words;
        c = a.create(b.slice(0, e));
        b = a.create(b.slice(e));
        e = z.algo[this.cjsAlgorithm].createDecryptor(this.key, {
          iv: c
        });
        c = e.process(b);
        b = e.finalize();
        e.reset();
        b && b.sigBytes && c.concat(b);
        return c
      };
      f.prototype.getIv = function(a) {
        if (this.iv) {
          var e = this.iv;
          this.iv = null;
          a(null, e)
        } else {
          var b = this;
          c(16, function(c, e) {
            c ? a(c) : a(null, b.encryptCipher.process(e))
          })
        }
      };
      return b
    }(),
    J = function() {
      function b() {}

      function d(a) {
        return a ? x.sessionStorage : x.localStorage
      }

      function f(a, c, b, g) {
        c = {
          value: c
        };
        b && (c.expires = k.now() + b);
        return d(g).setItem(a, JSON.stringify(c))
      }

      function a(a, c) {
        var e = d(c).getItem(a);
        if (!e) return null;
        e = JSON.parse(e);
        return e.expires && e.expires < k.now() ? (d(c).removeItem(a), null) : e.value
      }
      try {
        x.sessionStorage.setItem("ablyjs-storage-test", "ablyjs-storage-test");
        x.sessionStorage.removeItem("ablyjs-storage-test");
        var c = !0
      } catch (e) {
        c = !1
      }
      try {
        x.localStorage.setItem("ablyjs-storage-test", "ablyjs-storage-test");
        x.localStorage.removeItem("ablyjs-storage-test");
        var n = !0
      } catch (e) {
        n = !1
      }
      n && (b.set = function(a, c, b) {
        return f(a, c, b, !1)
      }, b.get = function(c) {
        return a(c, !1)
      }, b.remove = function(a) {
        return d(!1).removeItem(a)
      });
      c && (b.setSession = function(a, c, b) {
        return f(a, c, b, !0)
      }, b.getSession = function(c) {
        return a(c, !0)
      }, b.removeSession = function(a) {
        return d(!0).removeItem(a)
      });
      return b
    }(),
    t = {
      internetUpUrl: "https://internet-up.ably-realtime.com/is-the-internet-up.txt",
      jsonpInternetUpUrl: "https://internet-up.ably-realtime.com/is-the-internet-up-0-9.js",
      defaultTransports: ["xhr_polling", "xhr_streaming", "jsonp", "web_socket"],
      baseTransportOrder: ["xhr_polling", "xhr_streaming", "jsonp", "web_socket"],
      transportPreferenceOrder: ["jsonp", "xhr_polling", "xhr_streaming", "web_socket"],
      upgradeTransports: ["xhr_streaming", "web_socket"]
    };
  r.noUpgrade && (t.upgradeTransports = []);
  var y = function() {
      function b(a) {
        return null !== a && void 0 !== a && void 0 !== a.sigBytes
      }

      function d(a) {
        return null !== a && void 0 !== a && a.constructor === n
      }

      function f(a) {
        return n && n.isView && n.isView(a)
      }

      function a() {}
      var c = z.lib.WordArray,
        n = r.ArrayBuffer,
        e = r.atob,
        l = r.TextEncoder,
        p = r.TextDecoder;
      a.base64CharSet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
      a.hexCharSet = "0123456789abcdef";
      var g = a.isBuffer = function(a) {
          return d(a) || b(a) || f(a)
        },
        v = a.toBuffer = function(a) {
          if (!n) throw Error("Can't convert to Buffer: browser does not support the necessary types");
          if (d(a)) return new Uint8Array(a);
          if (f(a)) return new Uint8Array(a.buffer);
          if (b(a)) {
            var c = new n(a.sigBytes);
            c = new Uint8Array(c);
            for (var e = 0; e < a.sigBytes; e++) c[e] = a.words[e >>> 2] >>> 24 - e % 4 * 8 & 255;
            return c
          }
          throw Error("BufferUtils.toBuffer expected an arraybuffer, typed array, or CryptoJS wordarray");
        };
      a.toArrayBuffer = function(a) {
        return d(a) ? a : v(a).buffer
      };
      a.toWordArray = function(a) {
        f(a) && (a = a.buffer);
        return b(a) ? a : c.create(a)
      };
      a.base64Encode = function(a) {
        if (b(a)) return z.enc.Base64.stringify(a);
        a = v(a);
        var c = "",
          e = a.byteLength,
          h = e % 3;
        e -= h;
        for (var d, g, f, l, n = 0; n < e; n += 3) l = a[n] << 16 | a[n + 1] << 8 | a[n + 2], d = (l & 16515072) >> 18, g = (l & 258048) >> 12, f = (l & 4032) >> 6, l &= 63, c += "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" [d] + "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" [g] + "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" [f] + "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" [l];
        1 == h ? (l = a[e], c += "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" [(l & 252) >> 2] + "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" [(l & 3) << 4] + "==") : 2 == h && (l = a[e] << 8 | a[e + 1], c += "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" [(l & 64512) >> 10] + "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" [(l & 1008) >> 4] + "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" [(l & 15) << 2] + "=");
        return c
      };
      a.base64Decode = function(a) {
        if (n && e) {
          a = e(a);
          for (var c = a.length, h = new Uint8Array(c), b = 0; b < c; b++) {
            var d = a.charCodeAt(b);
            h[b] = d
          }
          return h.buffer
        }
        return z.enc.Base64.parse(a)
      };
      a.hexEncode = function(c) {
        c = a.toWordArray(c);
        return z.enc.Hex.stringify(c)
      };
      a.hexDecode = function(c) {
        c = z.enc.Hex.parse(c);
        return n ? a.toArrayBuffer(c) : c
      };
      a.utf8Encode = function(a) {
        return l ? (new l).encode(a).buffer : z.enc.Utf8.parse(a)
      };
      a.utf8Decode = function(c) {
        if (!g(c)) throw Error("Expected input of utf8decode to be an arraybuffer, typed array, or CryptoJS wordarray");
        if (p && !b(c)) return (new p).decode(c);
        c = a.toWordArray(c);
        return z.enc.Utf8.stringify(c)
      };
      a.bufferCompare = function(c, e) {
        if (!c) return -1;
        if (!e) return 1;
        c = a.toWordArray(c);
        e = a.toWordArray(e);
        c.clamp();
        e.clamp();
        var h = c.sigBytes - e.sigBytes;
        if (0 != h) return h;
        c = c.words;
        e = e.words;
        for (var b = 0; b < c.length; b++)
          if (h = c[b] - e[b], 0 != h) return h;
        return 0
      };
      a.byteLength = function(a) {
        if (d(a) || f(a)) return a.byteLength;
        if (b(a)) return a.sigBytes
      };
      a.typedArrayToBuffer = function(a) {
        return a.buffer
      };
      return a
    }(),
    k = function() {
      function b() {}
      var d = r.msgpack;
      b.mixin = function(a) {
        for (var c = 1; c < arguments.length; c++) {
          var b = arguments[c];
          if (!b) break;
          var e = b.hasOwnProperty,
            d;
          for (d in b)
            if (!e || e.call(b, d)) a[d] = b[d]
        }
        return a
      };
      b.copy = function(a) {
        return b.mixin({}, a)
      };
      b.isArray = Array.isArray || function(a) {
        return "[object Array]" == Object.prototype.toString.call(a)
      };
      b.ensureArray = function(a) {
        return b.isEmptyArg(a) ? [] : b.isArray(a) ? a : [a]
      };
      b.isObject = function(a) {
        return "[object Object]" == Object.prototype.toString.call(a)
      };
      b.isEmpty = function(a) {
        for (var c in a) return !1;
        return !0
      };
      b.isOnlyPropIn = function(a, c) {
        for (var b in a)
          if (b !== c) return !1;
        return !0
      };
      b.isEmptyArg = function(a) {
        return null === a || void 0 === a
      };
      b.shallowClone = function(a) {
        var c = {},
          b;
        for (b in a) c[b] = a[b];
        return c
      };
      b.prototypicalClone = function(a, c) {
        function d() {}
        d.prototype = a;
        var e = new d;
        c && b.mixin(e, c);
        return e
      };
      b.inherits = r.inherits || function(a, c) {
        a.super_ = c;
        a.prototype = b.prototypicalClone(c.prototype, {
          constructor: a
        })
      };
      b.containsValue = function(a, c) {
        for (var b in a)
          if (a[b] == c) return !0;
        return !1
      };
      b.intersect = function(a, c) {
        return b.isArray(c) ? b.arrIntersect(a, c) : b.arrIntersectOb(a, c)
      };
      b.arrIntersect = function(a, c) {
        for (var d = [], e = 0; e < a.length; e++) {
          var f = a[e]; - 1 != b.arrIndexOf(c, f) && d.push(f)
        }
        return d
      };
      b.arrIntersectOb = function(a, c) {
        for (var b = [], e = 0; e < a.length; e++) {
          var d = a[e];
          d in c && b.push(d)
        }
        return b
      };
      b.arrSubtract = function(a, c) {
        for (var d = [], e = 0; e < a.length; e++) {
          var f = a[e]; - 1 == b.arrIndexOf(c, f) && d.push(f)
        }
        return d
      };
      b.arrIndexOf = Array.prototype.indexOf ? function(a, c, b) {
        return a.indexOf(c, b)
      } : function(a, c, b) {
        b = b || 0;
        for (var e = a.length; b < e; b++)
          if (a[b] === c) return b;
        return -1
      };
      b.arrIn = function(a, c) {
        return -1 !== b.arrIndexOf(a, c)
      };
      b.arrDeleteValue = function(a, c) {
        var d = b.arrIndexOf(a, c),
          e = -1 != d;
        e && a.splice(d, 1);
        return e
      };
      b.arrWithoutValue = function(a, c) {
        var d = a.slice();
        b.arrDeleteValue(d, c);
        return d
      };
      b.keysArray = function(a, c) {
        var b = [],
          e;
        for (e in a) c && !a.hasOwnProperty(e) || b.push(e);
        return b
      };
      b.valuesArray = function(a, c) {
        var b = [],
          e;
        for (e in a) c && !a.hasOwnProperty(e) || b.push(a[e]);
        return b
      };
      b.forInOwnNonNullProps = function(a, c) {
        for (var b in a) Object.prototype.hasOwnProperty.call(a, b) && a[b] && c(b)
      };
      b.arrForEach = Array.prototype.forEach ? function(a, c) {
        a.forEach(c)
      } : function(a, c) {
        for (var b = a.length, e = 0; e < b; e++) c(a[e], e, a)
      };
      b.safeArrForEach = function(a, c) {
        return b.arrForEach(a.slice(), c)
      };
      b.arrMap = Array.prototype.map ? function(a, c) {
        return a.map(c)
      } : function(a, c) {
        for (var b = [], e = a.length, d = 0; d < e; d++) b.push(c(a[d], d, a));
        return b
      };
      b.arrFilter = Array.prototype.filter ? function(a, c) {
        return a.filter(c)
      } : function(a, c) {
        for (var b = [], e = a.length, d = 0; d < e; d++) c(a[d]) && b.push(a[d]);
        return b
      };
      b.arrEvery = Array.prototype.every ? function(a, c) {
        return a.every(c)
      } : function(a, c) {
        for (var b = a.length, e = 0; e < b; e++)
          if (!c(a[e], e, a)) return !1;
        return !0
      };
      b.allSame = function(a, c) {
        if (0 === a.length) return !0;
        var d = a[0][c];
        return b.arrEvery(a, function(a) {
          return a[c] === d
        })
      };
      b.nextTick = r.nextTick;
      var f = {
        json: "application/json",
        jsonp: "application/javascript",
        xml: "application/xml",
        html: "text/html",
        msgpack: "application/x-msgpack"
      };
      b.defaultGetHeaders = function(a) {
        return {
          accept: f[a || "json"],
          "X-Ably-Version": t.apiVersion,
          "X-Ably-Lib": t.libstring
        }
      };
      b.defaultPostHeaders = function(a) {
        var c;
        return {
          accept: c = f[a || "json"],
          "content-type": c,
          "X-Ably-Version": t.apiVersion,
          "X-Ably-Lib": t.libstring
        }
      };
      b.arrPopRandomElement = function(a) {
        return a.splice(Math.floor(Math.random() * a.length), 1)[0]
      };
      b.toQueryString = function(a) {
        var c = [];
        if (a)
          for (var b in a) c.push(encodeURIComponent(b) + "=" + encodeURIComponent(a[b]));
        return c.length ? "?" + c.join("&") : ""
      };
      b.parseQueryString = function(a) {
        for (var c, b = /([^?&=]+)=?([^&]*)/g, e = {}; c = b.exec(a);) e[decodeURIComponent(c[1])] = decodeURIComponent(c[2]);
        return e
      };
      b.now = Date.now || function() {
        return (new Date).getTime()
      };
      b.inspect = r.inspect;
      b.isErrorInfo = function(a) {
        return "ErrorInfo" == a.constructor.name
      };
      b.inspectError = function(a) {
        return a && (b.isErrorInfo(a) || "Error" == a.constructor.name || a instanceof Error) ? a.toString() : b.inspect(a)
      };
      b.inspectBody = function(a) {
        return y.isBuffer(a) ? a.toString() : "string" === typeof a ? a : r.inspect(a)
      };
      b.dataSizeBytes = function(a) {
        if (y.isBuffer(a)) return y.byteLength(a);
        if ("string" === typeof a) return r.stringByteSize(a);
        throw Error("Expected input of Utils.dataSizeBytes to be a buffer or string, but was: " + typeof a);
      };
      b.cheapRandStr = function() {
        return String(Math.random()).substr(2)
      };
      b.randomString = r.getRandomValues && "undefined" !== typeof Uint8Array ? function(a) {
        a = new Uint8Array(a);
        r.getRandomValues(a);
        return y.base64Encode(a)
      } : function(a) {
        var c = y.base64CharSet;
        a = Math.round(4 * a / 3);
        for (var b = "", e = 0; e < a; e++) b += c[Math.floor(Math.random() * c.length)];
        return b
      };
      b.randomHexString = r.getRandomValues && "undefined" !== typeof Uint8Array ? function(a) {
        a = new Uint8Array(a);
        r.getRandomValues(a);
        return y.hexEncode(a)
      } : function(a) {
        var c = y.hexCharSet;
        a *= 2;
        for (var b = "", e = 0; e < a; e++) b += c[Math.floor(Math.random() * c.length)];
        return b
      };
      b.arrChooseN = function(a, c) {
        for (var d = Math.min(c, a.length), e = a.slice(), f = [], p = 0; p < d; p++) f.push(b.arrPopRandomElement(e));
        return f
      };
      b.trim = String.prototype.trim ? function(a) {
        return a.trim()
      } : function(a) {
        return a.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, "")
      };
      b.promisify = function(a, c, b) {
        return new Promise(function(e, d) {
          a[c].apply(a, Array.prototype.slice.call(b).concat(function(a, c) {
            a ? d(a) : e(c)
          }))
        })
      };
      b.decodeBody = function(a, c) {
        return "msgpack" == c ? d.decode(a) : JSON.parse(String(a))
      };
      b.encodeBody = function(a, c) {
        return "msgpack" == c ? d.encode(a, !0) : JSON.stringify(a)
      };
      b.allToLowerCase = function(a) {
        return b.arrMap(a, function(a) {
          return a && a.toLowerCase()
        })
      };
      b.allToUpperCase = function(a) {
        return b.arrMap(a, function(a) {
          return a && a.toUpperCase()
        })
      };
      return b
    }(),
    A = function() {
      function b() {}

      function d() {}

      function f(a) {
        var c = a.statusCode;
        return 408 === c && !a.code || 400 === c && !a.code || 500 <= c && 504 >= c
      }

      function a(a) {
        var c = a.connection;
        return (c = c && c.connectionManager.host) ? [c].concat(t.getFallbackHosts(a.options)) : t.getHosts(a.options)
      }
      var c = Date.now || function() {
        return (new Date).getTime()
      };
      d._getHosts = a;
      d.methods = ["get", "delete", "post", "put", "patch"];
      d.methodsWithoutBody = ["get", "delete"];
      d.methodsWithBody = k.arrSubtract(d.methods, d.methodsWithoutBody);
      k.arrForEach(d.methodsWithoutBody, function(a) {
        d[a] = function(c, b, f, g, n) {
          d["do"](a, c, b, f, null, g, n)
        };
        d[a + "Uri"] = function(c, b, f, g, n) {
          d.doUri(a, c, b, f, null, g, n)
        }
      });
      k.arrForEach(d.methodsWithBody, function(a) {
        d[a] = function(c, b, f, g, n, h) {
          d["do"](a, c, b, f, g, n, h)
        };
        d[a + "Uri"] = function(c, b, f, g, n, h) {
          d.doUri(a, c, b, f, g, n, h)
        }
      });
      d["do"] = function(n, e, l, p, g, v, h) {
        h = h || b;
        var u = "function" == typeof l ? l : function(a) {
            return e.baseUri(a) + l
          },
          w = arguments,
          m = e._currentFallback;
        if (m) {
          if (m.validUntil > c()) {
            d.Request(n, e, u(m.host), p, v, g, function(a) {
              a && f(a) ? (e._currentFallback = null, d["do"].apply(d, w)) : h.apply(null, arguments)
            });
            return
          }
          e._currentFallback = null
        }
        m = a(e);
        if (1 == m.length) d.doUri(n, e, u(m[0]), p, g, v, h);
        else {
          var k = function(a, b) {
            var l = a.shift();
            d.doUri(n, e, u(l), p, g, v, function(d) {
              d && f(d) && a.length ? k(a, !0) : (b && (e._currentFallback = {
                host: l,
                validUntil: c() + e.options.timeouts.fallbackRetryTimeout
              }), h.apply(null, arguments))
            })
          };
          k(m)
        }
      };
      d.doUri = function(a, c, b, f, g, v, h) {
        d.Request(a, c, b, f, v, g, h)
      };
      d.supportsAuthHeaders = !1;
      d.supportsLinkHeaders = !1;
      return d
    }(),
    pa = function() {
      function b() {
        this.buffer = []
      }

      function d(a) {
        this._input = a;
        this._index = -1;
        this._buffer = []
      }

      function f(a) {
        this._input = a;
        this._index = -1;
        this._buffer = []
      }
      b.prototype.append = function(a) {
        this.buffer.push(a);
        return this
      };
      b.prototype.toString = function() {
        return this.buffer.join("")
      };
      var a = {
        codex: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
        encode: function(c) {
          var f = new b,
            e = a.codex;
          for (c = new d(c); c.moveNext();) {
            var l = c.current;
            c.moveNext();
            var p = c.current;
            c.moveNext();
            var g = c.current,
              v = l >> 2;
            l = (l & 3) << 4 | p >> 4;
            var h = (p & 15) << 2 | g >> 6,
              u = g & 63;
            isNaN(p) ? h = u = 64 : isNaN(g) && (u = 64);
            f.append(e.charAt(v) + e.charAt(l) + e.charAt(h) + e.charAt(u))
          }
          return f.toString()
        },
        decode: function(a) {
          var c = new b;
          for (a = new f(a); a.moveNext();) {
            var e = a.current;
            if (128 > e) c.append(String.fromCharCode(e));
            else if (191 < e && 224 > e) {
              a.moveNext();
              var d = a.current;
              c.append(String.fromCharCode((e & 31) << 6 | d & 63))
            } else a.moveNext(), d = a.current, a.moveNext(), c.append(String.fromCharCode((e & 15) << 12 | (d & 63) << 6 | a.current & 63))
          }
          return c.toString()
        }
      };
      d.prototype = {
        current: Number.NaN,
        moveNext: function() {
          if (0 < this._buffer.length) return this.current = this._buffer.shift(), !0;
          if (this._index >= this._input.length - 1) return this.current = Number.NaN, !1;
          var a = this._input.charCodeAt(++this._index);
          13 == a && 10 == this._input.charCodeAt(this._index + 1) && (a = 10, this._index += 2);
          128 > a ? this.current = a : (127 < a && 2048 > a ? this.current = a >> 6 | 192 : (this.current = a >> 12 | 224, this._buffer.push(a >> 6 & 63 | 128)), this._buffer.push(a & 63 | 128));
          return !0
        }
      };
      f.prototype = {
        current: 64,
        moveNext: function() {
          if (0 < this._buffer.length) return this.current = this._buffer.shift(), !0;
          if (this._index >= this._input.length - 1) return this.current = 64, !1;
          var c = a.codex.indexOf(this._input.charAt(++this._index)),
            b = a.codex.indexOf(this._input.charAt(++this._index)),
            e = a.codex.indexOf(this._input.charAt(++this._index)),
            d = a.codex.indexOf(this._input.charAt(++this._index)),
            f = (e & 3) << 6 | d;
          this.current = c << 2 | b >> 4;
          64 != e && this._buffer.push((b & 15) << 4 | e >> 2);
          64 != d && this._buffer.push(f);
          return !0
        }
      };
      return a
    }();
  t.ENVIRONMENT = "";
  t.REST_HOST = "rest.ably.io";
  t.REALTIME_HOST = "realtime.ably.io";
  t.FALLBACK_HOSTS = ["A.ably-realtime.com", "B.ably-realtime.com", "C.ably-realtime.com", "D.ably-realtime.com", "E.ably-realtime.com"];
  t.PORT = 80;
  t.TLS_PORT = 443;
  t.TIMEOUTS = {
    disconnectedRetryTimeout: 15E3,
    suspendedRetryTimeout: 3E4,
    httpRequestTimeout: 15E3,
    channelRetryTimeout: 15E3,
    fallbackRetryTimeout: 6E5,
    connectionStateTtl: 12E4,
    realtimeRequestTimeout: 1E4,
    recvTimeout: 9E4,
    preferenceConnectTimeout: 6E3,
    parallelUpgradeDelay: 6E3
  };
  t.httpMaxRetryCount = 3;
  t.maxMessageSize = 65536;
  t.errorReportingUrl = "https://errors.ably.io/api/15/store/";
  t.errorReportingHeaders = {
    "X-Sentry-Auth": "Sentry sentry_version=7, sentry_key=a04e33c8674c451f8a310fbec029acf5, sentry_client=ably-js/0.1",
    "Content-Type": "application/json"
  };
  t.version = "1.2.2";
  t.libstring = r.libver + "-" + t.version;
  t.apiVersion = "1.2";
  t.getHost = function(b, d, f) {
    return d = f ? d == b.restHost && b.realtimeHost || d || b.realtimeHost : d || b.restHost
  };
  t.getPort = function(b, d) {
    return d || b.tls ? b.tlsPort : b.port
  };
  t.getHttpScheme = function(b) {
    return b.tls ? "https://" : "http://"
  };
  t.getFallbackHosts = function(b) {
    var d = b.fallbackHosts;
    b = "undefined" !== typeof b.httpMaxRetryCount ? b.httpMaxRetryCount : t.httpMaxRetryCount;
    return d ? k.arrChooseN(d, b) : []
  };
  t.getHosts = function(b) {
    return [b.restHost].concat(t.getFallbackHosts(b))
  };
  t.objectifyOptions = function(b) {
    return "string" == typeof b ? -1 == b.indexOf(":") ? {
      token: b
    } : {
      key: b
    } : b
  };
  t.normaliseOptions = function(b) {
    b.host && (d.deprecated("host", "restHost"), b.restHost = b.host);
    b.wsHost && (d.deprecated("wsHost", "realtimeHost"), b.realtimeHost = b.wsHost);
    b.queueEvents && (d.deprecated("queueEvents", "queueMessages"), b.queueMessages = b.queueEvents);
    !0 === b.recover && (d.deprecated("{recover: true}", "{recover: function(lastConnectionDetails, cb) { cb(true); }}"), b.recover = function(a, b) {
      b(!0)
    });
    "function" === typeof b.recover && !0 === b.closeOnUnload && (d.logAction(d.LOG_ERROR, "Defaults.normaliseOptions", "closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"), b.recover = null);
    "closeOnUnload" in b || (b.closeOnUnload = !b.recover);
    b.transports && k.arrIn(b.transports, "xhr") && (d.deprecated('transports: ["xhr"]', 'transports: ["xhr_streaming"]'), k.arrDeleteValue(b.transports, "xhr"), b.transports.push("xhr_streaming"));
    "queueMessages" in b || (b.queueMessages = !0);
    var m = !1;
    if (b.restHost) b.realtimeHost = b.realtimeHost || b.restHost;
    else {
      var f = b.environment && String(b.environment).toLowerCase() || t.ENVIRONMENT;
      m = !f || "production" === f;
      b.restHost = m ? t.REST_HOST : f + "-" + t.REST_HOST;
      b.realtimeHost = m ? t.REALTIME_HOST : f + "-" + t.REALTIME_HOST
    }
    b.fallbackHosts = m || b.fallbackHostsUseDefault ? t.FALLBACK_HOSTS : b.fallbackHosts;
    k.arrForEach((b.fallbackHosts || []).concat(b.restHost, b.realtimeHost), ma);
    b.port = b.port || t.PORT;
    b.tlsPort = b.tlsPort || t.TLS_PORT;
    b.maxMessageSize = b.maxMessageSize || t.maxMessageSize;
    "tls" in b || (b.tls = !0);
    b.timeouts = {};
    for (var a in t.TIMEOUTS) b.timeouts[a] = b[a] || t.TIMEOUTS[a];
    b.useBinaryProtocol = "useBinaryProtocol" in b ? r.supportsBinary && b.useBinaryProtocol : r.preferBinary;
    b.clientId && ((b.headers = b.headers || {})["X-Ably-ClientId"] = y.base64Encode(y.utf8Encode(b.clientId)));
    "idempotentRestPublishing" in
    b || (b.idempotentRestPublishing = !0);
    b.promises && !r.Promise && (d.logAction(d.LOG_ERROR, "Defaults.normaliseOptions", "{promises: true} was specified, but no Promise constructor found; disabling promises"), b.promises = !1);
    return b
  };
  var C = function() {
      function b() {
        this.any = [];
        this.events = {};
        this.anyOnce = [];
        this.eventsOnce = {}
      }

      function m(a, c, b) {
        try {
          c.apply(a, b)
        } catch (e) {
          d.logAction(d.LOG_ERROR, "EventEmitter.emit()", "Unexpected listener exception: " + e + "; stack = " + (e && e.stack))
        }
      }

      function f(a, c, b) {
        var e, d, n;
        for (n = 0; n < a.length; n++) {
          var g = a[n];
          b && (g = g[b]);
          if (k.isArray(g)) {
            for (; - 1 !== (e = k.arrIndexOf(g, c));) g.splice(e, 1);
            b && 0 === g.length && delete a[n][b]
          } else if (k.isObject(g))
            for (d in g) g.hasOwnProperty(d) && k.isArray(g[d]) && f([g], c, d)
        }
      }
      b.prototype.on = function(a, c) {
        if (1 == arguments.length && "function" == typeof a) this.any.push(a);
        else if (k.isEmptyArg(a)) this.any.push(c);
        else if (k.isArray(a)) {
          var b = this;
          k.arrForEach(a, function(a) {
            b.on(a, c)
          })
        } else(this.events[a] || (this.events[a] = [])).push(c)
      };
      b.prototype.off = function(a, c) {
        if (0 == arguments.length || k.isEmptyArg(a) && k.isEmptyArg(c)) this.any = [], this.events = {}, this.anyOnce = [], this.eventsOnce = {};
        else if (1 == arguments.length && "function" == typeof a && (c = a, a = null), c && k.isEmptyArg(a)) f([this.any, this.events, this.anyOnce, this.eventsOnce], c);
        else {
          if (k.isArray(a)) {
            var b = this;
            k.arrForEach(a, function(a) {
              b.off(a, c)
            })
          }
          c ? f([this.events, this.eventsOnce], c, a) : (delete this.events[a], delete this.eventsOnce[a])
        }
      };
      b.prototype.listeners = function(a) {
        if (a) {
          var c = this.events[a] || [];
          this.eventsOnce[a] && Array.prototype.push.apply(c, this.eventsOnce[a]);
          return c.length ? c : null
        }
        return this.any.length ? this.any : null
      };
      b.prototype.emit = function(a) {
        var c = Array.prototype.slice.call(arguments, 1),
          b = {
            event: a
          },
          e = [];
        this.anyOnce.length && (Array.prototype.push.apply(e, this.anyOnce), this.anyOnce = []);
        this.any.length && Array.prototype.push.apply(e, this.any);
        var d = this.eventsOnce[a];
        d && (Array.prototype.push.apply(e, d), delete this.eventsOnce[a]);
        (d = this.events[a]) && Array.prototype.push.apply(e, d);
        k.arrForEach(e, function(a) {
          m(b, a, c)
        })
      };
      b.prototype.once = function(a, c) {
        var b = arguments.length,
          e = this;
        if ((0 === b || 1 === b && "function" !== typeof a) && r.Promise) return new r.Promise(function(c) {
          e.once(a, c)
        });
        if (1 == arguments.length && "function" == typeof a) this.anyOnce.push(a);
        else if (k.isEmptyArg(a)) this.anyOnce.push(c);
        else {
          if (k.isArray(a)) throw "Arrays of events can only be used with on(), not once()";
          (this.eventsOnce[a] || (this.eventsOnce[a] = [])).push(c)
        }
      };
      b.prototype.whenState = function(a, c, d) {
        var e = {
            event: a
          },
          f = this,
          n = Array.prototype.slice.call(arguments, 3);
        if ("string" !== typeof a || "string" !== typeof c) throw "whenState requires a valid event String argument";
        if ("function" !== typeof d && r.Promise) return new r.Promise(function(e) {
          b.prototype.whenState.apply(f, [a, c, e].concat(n))
        });
        if (a === c) m(e, d, n);
        else this.once(a, d)
      };
      return b
    }(),
    d = function() {
      function b(a, c) {
        return ("000" + a).slice(-2 - (c || 0))
      }

      function d(a) {
        return r.logTimestamps ? function(c) {
          var e = new Date;
          a(b(e.getHours()) + ":" + b(e.getMinutes()) + ":" + b(e.getSeconds()) + "." + b(e.getMilliseconds(), !0) + " " + c)
        } : a
      }

      function f() {}
      if ("undefined" === typeof Window && "undefined" === typeof WorkerGlobalScope || x.console && x.console.log && "function" === typeof x.console.log.apply) {
        var a = function() {
          console.log.apply(console, arguments)
        };
        var c = console.warn ? function() {
          console.warn.apply(console, arguments)
        } : a
      } else a = x.console && x.console.log ? c = function() {
        Function.prototype.apply.call(console.log, console, arguments)
      } : c = function() {};
      var n = 1,
        e = d(a),
        l = d(c);
      f.LOG_NONE = 0;
      f.LOG_ERROR = 1;
      f.LOG_MAJOR = 2;
      f.LOG_MINOR = 3;
      f.LOG_MICRO = 4;
      f.LOG_DEFAULT = 1;
      f.LOG_DEBUG = 4;
      f.logAction = function(a, c, b) {
        f.shouldLog(a) && (1 === a ? l : e)("Ably: " + c + ": " + b)
      };
      f.deprecated = function(a, c) {
        f.shouldLog(1) && l("Ably: Deprecation warning - '" + a + "' is deprecated and will be removed from a future version. Please use '" + c + "' instead.")
      };
      f.shouldLog = function(a) {
        return a <= n
      };
      f.setLog = function(a, c) {
        void 0 !== a && (n = a);
        void 0 !== c && (e = l = c)
      };
      return f
    }(),
    ca = function() {
      return function(b) {
        function m() {
          for (var f = 0; f < b.length; f++) {
            var a = b[f];
            if (a) try {
              a.apply(null, arguments)
            } catch (c) {
              d.logAction(d.LOG_ERROR, "Multicaster multiple callback handler", "Unexpected exception: " + c + "; stack = " + c.stack)
            }
          }
        }
        b = b || [];
        m.push = function() {
          Array.prototype.push.apply(b, arguments)
        };
        return m
      }
    }(),
    W = function() {
      function b() {}
      b.levels = ["fatal", "error", "warning", "info", "debug"];
      b.report = function(b, f, a, c) {
        b = {
          event_id: k.randomHexString(16),
          tags: k.mixin({
            lib: r.libver
          }, c),
          platform: "javascript",
          level: b,
          release: t.version,
          fingerprint: a && [a],
          message: f,
          request: {
            headers: {
              "User-Agent": r.userAgent
            },
            url: r.currentUrl
          }
        };
        d.logAction(d.LOG_MICRO, "ErrorReporter", "POSTing to error reporter: " + f);
        A.postUri(null, t.errorReportingUrl, t.errorReportingHeaders, JSON.stringify(b), {}, function(a, c) {
          d.logAction(d.LOG_MICRO, "ErrorReporter", "POSTing to error reporter resulted in: " + (a ? k.inspectError(a) : k.inspectBody(c)))
        })
      };
      return b
    }(),
    q = function() {
      function b(b, d, a, c) {
        this.message = b;
        this.code = d;
        this.statusCode = a;
        this.cause = c;
        this.href = void 0
      }
      b.prototype.toString = function() {
        var b = "[" + this.constructor.name;
        this.message && (b += ": " + this.message);
        this.statusCode && (b += "; statusCode=" + this.statusCode);
        this.code && (b += "; code=" + this.code);
        this.cause && (b += "; cause=" + k.inspectError(this.cause));
        !this.href || this.message && -1 < this.message.indexOf("help.ably.io") || (b += "; see " + this.href + " ");
        return b + "]"
      };
      b.fromValues = function(d) {
        var f = k.mixin(new b, d);
        d instanceof Error && (f.message = d.message);
        f.code && !f.href && (f.href = "https://help.ably.io/error/" + f.code);
        return f
      };
      return b
    }(),
    D = function() {
      function b() {
        this.size = this.extras = this.encoding = this.data = this.connectionKey = this.connectionId = this.clientId = this.timestamp = this.id = this.name = void 0
      }

      function m(b) {
        if (b && b.cipher && !b.cipher.channelCipher) {
          if (!S) throw Error("Encryption not enabled; use ably.encryption.js instead");
          var a = S.getCipher(b.cipher);
          b.cipher = a.cipherParams;
          b.channelCipher = a.cipher
        }
      }
      b.prototype.toJSON = function() {
        var b = {
            name: this.name,
            id: this.id,
            clientId: this.clientId,
            connectionId: this.connectionId,
            connectionKey: this.connectionKey,
            encoding: this.encoding,
            extras: this.extras
          },
          a = this.data;
        if (a && y.isBuffer(a))
          if (0 < arguments.length) {
            var c = this.encoding;
            b.encoding = c ? c + "/base64" : "base64";
            a = y.base64Encode(a)
          } else a = y.toBuffer(a);
        b.data = a;
        return b
      };
      b.prototype.toString = function() {
        var b = "[Message";
        this.name && (b += "; name=" + this.name);
        this.id && (b += "; id=" + this.id);
        this.timestamp && (b += "; timestamp=" + this.timestamp);
        this.clientId && (b += "; clientId=" + this.clientId);
        this.connectionId && (b += "; connectionId=" + this.connectionId);
        this.encoding && (b += "; encoding=" + this.encoding);
        this.extras && (b += "; extras =" + JSON.stringify(this.extras));
        this.data && (b = "string" == typeof this.data ? b + ("; data=" + this.data) : y.isBuffer(this.data) ? b + ("; data (buffer)=" + y.base64Encode(this.data)) : b + ("; data (json)=" + JSON.stringify(this.data)));
        this.extras && (b += "; extras=" + JSON.stringify(this.extras));
        return b + "]"
      };
      b.encrypt = function(b, a, c) {
        var d = b.data,
          e = b.encoding,
          f = a.channelCipher;
        e = e ? e + "/" : "";
        y.isBuffer(d) || (d = y.utf8Encode(String(d)), e += "utf-8/");
        f.encrypt(d, function(a, d) {
          a ? c(a) : (b.data = d, b.encoding = e + "cipher+" + f.algorithm, c(null, b))
        })
      };
      b.encode = function(d, a, c) {
        var f = d.data,
          e;
        if ("string" != typeof f && !y.isBuffer(f) && null !== f && void 0 !== f)
          if (k.isObject(f) || k.isArray(f)) d.data = JSON.stringify(f), d.encoding = (e = d.encoding) ? e + "/json" : "json";
          else throw new q("Data type is unsupported", 40013, 400);
        null != a && a.cipher ? b.encrypt(d, a, c) : c(null, d)
      };
      b.encodeArray = function(d, a, c) {
        for (var f = 0, e = 0; e < d.length; e++) b.encode(d[e], a, function(a) {
          a ? c(a) : (f++, f == d.length && c(null, d))
        })
      };
      b.serialize = k.encodeBody;
      b.decode = function(b, a) {
        a && a.channelOptions || (a = {
          channelOptions: a,
          plugins: {},
          baseEncodedPreviousPayload: void 0
        });
        var c = b.data,
          d = b.encoding;
        if (d) {
          d = d.split("/");
          var e, f = d.length,
            p = b.data;
          try {
            for (; 0 < (e = f);) {
              var g = d[--f].match(/([\-\w]+)(\+([\w\-]+))?/);
              if (!g) break;
              var v = g[1];
              switch (v) {
                case "base64":
                  p = y.base64Decode(String(p));
                  e == d.length && (c = p);
                  continue;
                case "utf-8":
                  p = y.utf8Decode(p);
                  continue;
                case "json":
                  p = JSON.parse(p);
                  continue;
                case "cipher":
                  if (null != a.channelOptions && a.channelOptions.cipher) {
                    var h = a.channelOptions.channelCipher;
                    if (g[3] != h.algorithm) throw Error("Unable to decrypt message with given cipher; incompatible cipher params");
                    p = h.decrypt(p);
                    continue
                  } else throw Error("Unable to decrypt message; not an encrypted channel");
                case "vcdiff":
                  if (!a.plugins || !a.plugins.vcdiff) throw new q("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)", 40019, 400);
                  if ("undefined" === typeof Uint8Array) throw new q("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)", 40020, 400);
                  try {
                    var u = a.baseEncodedPreviousPayload;
                    "string" === typeof u && (u = y.utf8Encode(u));
                    u = y.toBuffer(u);
                    p = y.toBuffer(p);
                    c = p = y.typedArrayToBuffer(a.plugins.vcdiff.decode(p, u))
                  } catch (w) {
                    throw new q("Vcdiff delta decode failed with " + w, 40018, 400);
                  }
                  continue;
                default:
                  throw Error("Unknown encoding");
              }
            }
          } catch (w) {
            throw new q("Error processing the " + v + " encoding, decoder returned \u2018" + w.message + "\u2019", w.code || 40013, 400);
          } finally {
            b.encoding = 0 >= e ? null : d.slice(0, e).join("/"), b.data = p
          }
        }
        a.baseEncodedPreviousPayload = c
      };
      b.fromResponseBody = function(f, a, c) {
        c && (f = k.decodeBody(f, c));
        for (c = 0; c < f.length; c++) {
          var n = f[c] = b.fromValues(f[c]);
          try {
            b.decode(n, a)
          } catch (e) {
            d.logAction(d.LOG_ERROR, "Message.fromResponseBody()", e.toString())
          }
        }
        return f
      };
      b.fromValues = function(d) {
        return k.mixin(new b, d)
      };
      b.fromValuesArray = function(d) {
        for (var a = d.length, c = Array(a), f = 0; f < a; f++) c[f] = b.fromValues(d[f]);
        return c
      };
      b.fromEncoded = function(f, a) {
        var c = b.fromValues(f);
        m(a);
        try {
          b.decode(c, a)
        } catch (n) {
          d.logAction(d.LOG_ERROR, "Message.fromEncoded()", n.toString())
        }
        return c
      };
      b.fromEncodedArray = function(d, a) {
        m(a);
        return k.arrMap(d, function(c) {
          return b.fromEncoded(c, a)
        })
      };
      b.getMessagesSize = function(b) {
        for (var a, c = 0, d = 0; d < b.length; d++) {
          a = b[d];
          var e;
          if (!(e = a.size)) {
            e = a;
            var f = 0;
            a.name && (f += a.name.length);
            a.clientId && (f += a.clientId.length);
            a.extras && (f += JSON.stringify(a.extras).length);
            a.data && (f += k.dataSizeBytes(a.data));
            e = e.size = f
          }
          c += e
        }
        return c
      };
      return b
    }(),
    G = function() {
      function b() {
        this.size = this.encoding = this.data = this.connectionId = this.clientId = this.timestamp = this.id = this.action = void 0
      }
      b.Actions = ["absent", "present", "enter", "leave", "update"];
      b.prototype.isSynthesized = function() {
        return this.id.substring(this.connectionId.length, 0) !== this.connectionId
      };
      b.prototype.parseId = function() {
        var b = this.id.split(":");
        return {
          connectionId: b[0],
          msgSerial: parseInt(b[1], 10),
          index: parseInt(b[2], 10)
        }
      };
      b.prototype.toJSON = function() {
        var d = {
            clientId: this.clientId,
            action: k.arrIndexOf(b.Actions, this.action),
            encoding: this.encoding
          },
          f = this.data;
        if (f && y.isBuffer(f))
          if (0 < arguments.length) {
            var a = this.encoding;
            d.encoding = a ? a + "/base64" : "base64";
            f = y.base64Encode(f)
          } else f = y.toBuffer(f);
        d.data = f;
        return d
      };
      b.prototype.toString = function() {
        var b = "[PresenceMessage; action=" +
          this.action;
        this.id && (b += "; id=" + this.id);
        this.timestamp && (b += "; timestamp=" + this.timestamp);
        this.clientId && (b += "; clientId=" + this.clientId);
        this.connectionId && (b += "; connectionId=" + this.connectionId);
        this.encoding && (b += "; encoding=" + this.encoding);
        this.data && (b = "string" == typeof this.data ? b + ("; data=" + this.data) : y.isBuffer(this.data) ? b + ("; data (buffer)=" + y.base64Encode(this.data)) : b + ("; data (json)=" + JSON.stringify(this.data)));
        return b + "]"
      };
      b.encode = D.encode;
      b.decode = D.decode;
      b.fromResponseBody = function(m, f, a) {
        a && (m = k.decodeBody(m, a));
        for (a = 0; a < m.length; a++) {
          var c = m[a] = b.fromValues(m[a], !0);
          try {
            b.decode(c, f)
          } catch (n) {
            d.logAction(d.LOG_ERROR, "PresenceMessage.fromResponseBody()", n.toString())
          }
        }
        return m
      };
      b.fromValues = function(d, f) {
        f && (d.action = b.Actions[d.action]);
        return k.mixin(new b, d)
      };
      b.fromValuesArray = function(d) {
        for (var f = d.length, a = Array(f), c = 0; c < f; c++) a[c] = b.fromValues(d[c]);
        return a
      };
      b.fromEncoded = function(k, f) {
        var a = b.fromValues(k, !0);
        try {
          b.decode(a, f)
        } catch (c) {
          d.logAction(d.LOG_ERROR, "PresenceMessage.fromEncoded()", c.toString())
        }
        return a
      };
      b.fromEncodedArray = function(d, f) {
        return k.arrMap(d, function(a) {
          return b.fromEncoded(a, f)
        })
      };
      b.getMessagesSize = D.getMessagesSize;
      return b
    }(),
    B = function() {
      function b() {
        this.params = this.auth = this.presence = this.messages = this.msgSerial = this.channelSerial = this.channel = this.connectionSerial = this.connectionKey = this.connectionId = this.error = this.count = this.timestamp = this.id = this.flags = this.action = void 0
      }

      function d(a) {
        var c = [];
        if (a)
          for (var b = 0; b < a.length; b++) c.push(a[b].toString());
        return "[ " + c.join(", ") + " ]"
      }
      var f = b.Action = {
        HEARTBEAT: 0,
        ACK: 1,
        NACK: 2,
        CONNECT: 3,
        CONNECTED: 4,
        DISCONNECT: 5,
        DISCONNECTED: 6,
        CLOSE: 7,
        CLOSED: 8,
        ERROR: 9,
        ATTACH: 10,
        ATTACHED: 11,
        DETACH: 12,
        DETACHED: 13,
        PRESENCE: 14,
        MESSAGE: 15,
        SYNC: 16,
        AUTH: 17
      };
      b.channelModes = ["PRESENCE", "PUBLISH", "SUBSCRIBE", "PRESENCE_SUBSCRIBE"];
      b.ActionName = [];
      k.arrForEach(k.keysArray(b.Action, !0), function(a) {
        b.ActionName[f[a]] = a
      });
      var a = {
          HAS_PRESENCE: 1,
          HAS_BACKLOG: 2,
          RESUMED: 4,
          TRANSIENT: 16,
          ATTACH_RESUME: 32,
          PRESENCE: 65536,
          PUBLISH: 131072,
          SUBSCRIBE: 262144,
          PRESENCE_SUBSCRIBE: 524288
        },
        c = k.keysArray(a);
      a.MODE_ALL = a.PRESENCE | a.PUBLISH | a.SUBSCRIBE | a.PRESENCE_SUBSCRIBE;
      b.prototype.hasFlag = function(c) {
        return 0 < (this.flags & a[c])
      };
      b.prototype.setFlag = function(c) {
        return this.flags |= a[c]
      };
      b.prototype.getMode = function() {
        return this.flags && this.flags & a.MODE_ALL
      };
      b.prototype.encodeModesToFlags = function(a) {
        var c = this;
        k.arrForEach(a, function(a) {
          c.setFlag(a)
        })
      };
      b.prototype.decodeModesFromFlags = function() {
        var a = [],
          c = this;
        k.arrForEach(b.channelModes, function(b) {
          c.hasFlag(b) && a.push(b)
        });
        return 0 < a.length ? a : void 0
      };
      b.serialize = k.encodeBody;
      b.deserialize = function(a, c) {
        var e = k.decodeBody(a, c);
        return b.fromDeserialized(e)
      };
      b.fromDeserialized = function(a) {
        var c = a.error;
        c && (a.error = q.fromValues(c));
        var e = a.messages;
        if (e)
          for (c = 0; c < e.length; c++) e[c] = D.fromValues(e[c]);
        if (e = a.presence)
          for (c = 0; c < e.length; c++) e[c] = G.fromValues(e[c], !0);
        return k.mixin(new b, a)
      };
      b.fromValues = function(a) {
        return k.mixin(new b, a)
      };
      var n = "id channel channelSerial connectionId connectionKey connectionSerial count msgSerial timestamp".split(" ");
      b.stringify = function(a) {
        var e = "[ProtocolMessage";
        void 0 !== a.action && (e += "; action=" + b.ActionName[a.action] || a.action);
        for (var f, g = 0; g < n.length; g++) f = n[g], void 0 !== a[f] && (e += "; " + f + "=" + a[f]);
        a.messages && (e += "; messages=" + d(D.fromValuesArray(a.messages)));
        a.presence && (e += "; presence=" + d(G.fromValuesArray(a.presence)));
        a.error && (e += "; error=" + q.fromValues(a.error).toString());
        a.auth && a.auth.accessToken && (e += "; token=" + a.auth.accessToken);
        a.flags && (e += "; flags=" + k.arrFilter(c, function(c) {
          return a.hasFlag(c)
        }).join(","));
        if (a.params) {
          var v = "";
          k.forInOwnNonNullProps(a.params, function(c) {
            0 < v.length && (v += "; ");
            v += c + "=" + a.params[c]
          });
          0 < v.length && (e += "; params=[" + v + "]")
        }
        return e + "]"
      };
      b.isDuplicate = function(a, c) {
        if (a && c && (a.action === f.MESSAGE || a.action === f.PRESENCE) && a.action === c.action && a.channel === c.channel && a.id === c.id) {
          if (a.action === f.PRESENCE) return !0;
          if (a.messages.length === c.messages.length) {
            for (var b = 0; b < a.messages.length; b++) {
              var d = a.messages[b],
                e = c.messages[b];
              if ((d.extras && d.extras.delta && d.extras.delta.format) !== (e.extras && e.extras.delta && e.extras.delta.format)) return !1
            }
            return !0
          }
        }
        return !1
      };
      return b
    }(),
    qa = function() {
      function b(a) {
        this.count = a && a.count || 0;
        this.data = a && a.data || 0;
        this.uncompressedData = a && a.uncompressedData || 0;
        this.failed = a && a.failed || 0;
        this.refused = a && a.refused || 0
      }

      function d(a) {
        var c = this;
        b.call(this, a);
        this.category = void 0;
        a && a.category && (this.category = {}, k.forInOwnNonNullProps(a.category, function(d) {
          c.category[d] = new b(a.category[d])
        }))
      }

      function f(a) {
        this.peak = a && a.peak || 0;
        this.min = a && a.min || 0;
        this.mean = a && a.mean || 0;
        this.opened = a && a.opened || 0;
        this.refused = a && a.refused || 0
      }

      function a(a) {
        this.succeeded = a && a.succeeded || 0;
        this.failed = a && a.failed || 0;
        this.refused = a && a.refused || 0
      }

      function c(a) {
        this.plain = new f(a && a.plain);
        this.tls = new f(a && a.tls);
        this.all = new f(a && a.all)
      }

      function n(a) {
        this.messages = new d(a && a.messages);
        this.presence = new d(a && a.presence);
        this.all = new d(a && a.all)
      }

      function e(a) {
        this.realtime = new n(a && a.realtime);
        this.rest = new n(a && a.rest);
        this.webhook = new n(a && a.webhook);
        this.sharedQueue = new n(a && a.sharedQueue);
        this.externalQueue = new n(a && a.externalQueue);
        this.httpEvent = new n(a && a.httpEvent);
        this.push = new n(a && a.push);
        this.all = new n(a && a.all)
      }

      function l(a) {
        this.all = new n(a && a.all);
        this.inbound = new e(a && a.inbound);
        this.outbound = new e(a && a.outbound)
      }

      function p(a) {
        this.all = new n(a && a.all);
        this.producerPaid = new l(a && a.producerPaid);
        this.consumerPaid = new l(a && a.consumerPaid)
      }

      function g(a) {
        this.messages = a && a.messages || 0;
        var c = a && a.notifications;
        this.notifications = {
          invalid: c && c.invalid || 0,
          attempted: c && c.attempted || 0,
          successful: c && c.successful || 0,
          failed: c && c.failed || 0
        };
        this.directPublishes = a && a.directPublishes || 0
      }

      function v(a) {
        this.succeeded = a && a.succeeded || 0;
        this.skipped = a && a.skipped || 0;
        this.failed = a && a.failed || 0
      }

      function h(a) {
        var c = this;
        this.delta = void 0;
        a && a.delta && (this.delta = {}, k.forInOwnNonNullProps(a.delta, function(b) {
          c.delta[b] = new v(a.delta[b])
        }))
      }

      function u(b) {
        l.call(this, b);
        this.persisted = new n(b && b.persisted);
        this.connections = new c(b && b.connections);
        this.channels = new f(b && b.channels);
        this.apiRequests = new a(b && b.apiRequests);
        this.tokenRequests = new a(b && b.tokenRequests);
        this.xchgProducer = new p(b && b.xchgProducer);
        this.xchgConsumer = new p(b && b.xchgConsumer);
        this.push = new g(b && b.pushStats);
        this.processed = new h(b && b.processed);
        this.inProgress = b && b.inProgress || void 0;
        this.unit = b && b.unit || void 0;
        this.intervalId = b && b.intervalId || void 0
      }
      u.fromValues = function(a) {
        return new u(a)
      };
      return u
    }(),
    X = function() {
      function b() {
        this.deviceIdentityToken = this.metadata = this.clientId = this.formFactor = this.platform = this.deviceSecret = this.id = void 0;
        this.push = {
          recipient: void 0,
          state: void 0,
          errorReason: void 0
        }
      }
      b.prototype.toJSON = function() {
        return {
          id: this.id,
          deviceSecret: this.deviceSecret,
          platform: this.platform,
          formFactor: this.formFactor,
          clientId: this.clientId,
          metadata: this.metadata,
          deviceIdentityToken: this.deviceIdentityToken,
          push: {
            recipient: this.push.recipient,
            state: this.push.state,
            errorReason: this.push.errorReason
          }
        }
      };
      b.prototype.toString = function() {
        var b = "[DeviceDetails";
        this.id && (b += "; id=" + this.id);
        this.platform && (b += "; platform=" + this.platform);
        this.formFactor && (b += "; formFactor=" + this.formFactor);
        this.clientId && (b += "; clientId=" + this.clientId);
        this.metadata && (b += "; metadata=" + this.metadata);
        this.deviceIdentityToken && (b += "; deviceIdentityToken=" + JSON.stringify(this.deviceIdentityToken));
        this.push.recipient && (b += "; push.recipient=" + JSON.stringify(this.push.recipient));
        this.push.state && (b += "; push.state=" + this.push.state);
        this.push.errorReason && (b += "; push.errorReason=" + this.push.errorReason);
        this.push.metadata && (b += "; push.metadata=" + this.push.metadata);
        return b + "]"
      };
      b.toRequestBody = k.encodeBody;
      b.fromResponseBody = function(d, f) {
        f && (d = k.decodeBody(d, f));
        return k.isArray(d) ? b.fromValuesArray(d) : b.fromValues(d)
      };
      b.fromValues = function(d) {
        return k.mixin(new b, d)
      };
      b.fromValuesArray = function(d) {
        for (var f = d.length, a = Array(f), c = 0; c < f; c++) a[c] = b.fromValues(d[c]);
        return a
      };
      return b
    }(),
    da = function() {
      function b() {
        this.clientId = this.deviceId = this.channel = void 0
      }
      b.prototype.toJSON = function() {
        return {
          channel: this.channel,
          deviceId: this.deviceId,
          clientId: this.clientId
        }
      };
      b.prototype.toString = function() {
        var b = "[PushChannelSubscription";
        this.channel && (b += "; channel=" + this.channel);
        this.deviceId && (b += "; deviceId=" + this.deviceId);
        this.clientId && (b += "; clientId=" + this.clientId);
        return b + "]"
      };
      b.toRequestBody = k.encodeBody;
      b.fromResponseBody = function(d, f) {
        f && (d = k.decodeBody(d, f));
        return k.isArray(d) ? b.fromValuesArray(d) : b.fromValues(d)
      };
      b.fromValues = function(d) {
        return k.mixin(new b, d)
      };
      b.fromValuesArray = function(d) {
        for (var f = d.length, a = Array(f), c = 0; c < f; c++) a[c] = b.fromValues(d[c]);
        return a
      };
      return b
    }(),
    K = {
      disconnected: q.fromValues({
        statusCode: 400,
        code: 80003,
        message: "Connection to server temporarily unavailable"
      }),
      suspended: q.fromValues({
        statusCode: 400,
        code: 80002,
        message: "Connection to server unavailable"
      }),
      failed: q.fromValues({
        statusCode: 400,
        code: 8E4,
        message: "Connection failed or disconnected by server"
      }),
      closing: q.fromValues({
        statusCode: 400,
        code: 80017,
        message: "Connection closing"
      }),
      closed: q.fromValues({
        statusCode: 400,
        code: 80017,
        message: "Connection closed"
      }),
      unknownConnectionErr: q.fromValues({
        statusCode: 500,
        code: 50002,
        message: "Internal connection error"
      }),
      unknownChannelErr: q.fromValues({
        statusCode: 500,
        code: 50001,
        message: "Internal channel error"
      })
    },
    ja = function() {
      function b() {
        C.call(this);
        this.messages = []
      }
      k.inherits(b, C);
      b.prototype.count = function() {
        return this.messages.length
      };
      b.prototype.push = function(b) {
        this.messages.push(b)
      };
      b.prototype.shift = function() {
        return this.messages.shift()
      };
      b.prototype.last = function() {
        return this.messages[this.messages.length -
          1]
      };
      b.prototype.copyAll = function() {
        return this.messages.slice()
      };
      b.prototype.append = function(b) {
        this.messages.push.apply(this.messages, b)
      };
      b.prototype.prepend = function(b) {
        this.messages.unshift.apply(this.messages, b)
      };
      b.prototype.completeMessages = function(b, f, a) {
        d.logAction(d.LOG_MICRO, "MessageQueue.completeMessages()", "serial = " + b + "; count = " + f);
        a = a || null;
        var c = this.messages,
          n = c[0];
        if (n) {
          n = n.message.msgSerial;
          b += f;
          if (b > n)
            for (b = c.splice(0, b - n), f = 0; f < b.length; f++) b[f].callback(a);
          0 == c.length && this.emit("idle")
        }
      };
      b.prototype.completeAllMessages = function(b) {
        this.completeMessages(0, Number.MAX_SAFE_INTEGER || Number.MAX_VALUE, b)
      };
      b.prototype.clear = function() {
        d.logAction(d.LOG_MICRO, "MessageQueue.clear()", "clearing " + this.messages.length + " messages");
        this.messages = [];
        this.emit("idle")
      };
      return b
    }(),
    ka = function() {
      function b(b) {
        C.call(this);
        this.transport = b;
        this.messageQueue = new ja;
        var a = this;
        b.on("ack", function(c, b) {
          a.onAck(c, b)
        });
        b.on("nack", function(c, b, d) {
          a.onNack(c, b, d)
        })
      }
      var m = B.Action;
      k.inherits(b, C);
      b.prototype.onAck = function(b, a) {
        d.logAction(d.LOG_MICRO, "Protocol.onAck()", "serial = " + b + "; count = " + a);
        this.messageQueue.completeMessages(b, a)
      };
      b.prototype.onNack = function(b, a, c) {
        d.logAction(d.LOG_ERROR, "Protocol.onNack()", "serial = " + b + "; count = " + a + "; err = " + k.inspectError(c));
        c || (c = new q("Unable to send message; channel not responding", 50001, 500));
        this.messageQueue.completeMessages(b, a, c)
      };
      b.prototype.onceIdle = function(b) {
        var a = this.messageQueue;
        if (0 === a.count()) b();
        else a.once("idle", b)
      };
      b.prototype.send = function(b) {
        b.ackRequired && this.messageQueue.push(b);
        d.shouldLog(d.LOG_MICRO) && d.logAction(d.LOG_MICRO, "Protocol.send()", "sending msg; " + B.stringify(b.message));
        b.sendAttempted = !0;
        this.transport.send(b.message)
      };
      b.prototype.getTransport = function() {
        return this.transport
      };
      b.prototype.getPendingMessages = function() {
        return this.messageQueue.copyAll()
      };
      b.prototype.clearPendingMessages = function() {
        return this.messageQueue.clear()
      };
      b.prototype.finish = function() {
        var b = this.transport;
        this.onceIdle(function() {
          b.disconnect()
        })
      };
      b.PendingMessage = function(b, a) {
        this.message = b;
        this.callback = a;
        this.merged = !1;
        var c = b.action;
        this.sendAttempted = !1;
        this.ackRequired = c == m.MESSAGE || c == m.PRESENCE
      };
      return b
    }(),
    O = function() {
      function b() {}

      function m(a, c) {
        return k.arrIndexOf(g, a.shortName) > k.arrIndexOf(g, c.shortName)
      }

      function f(a, c, b, d) {
        this.options = a;
        this.host = c;
        this.mode = b;
        this.connectionKey = d;
        this.format = a.useBinaryProtocol ? "msgpack" : "json";
        this.timeSerial = this.connectionSerial = void 0
      }

      function a(c, b) {
        C.call(this);
        this.realtime = c;
        this.options = b;
        var h = b.timeouts,
          g = this;
        this.states = {
          initialized: {
            state: "initialized",
            terminal: !1,
            queueEvents: !0,
            sendEvents: !1,
            failState: "disconnected"
          },
          connecting: {
            state: "connecting",
            terminal: !1,
            queueEvents: !0,
            sendEvents: !1,
            retryDelay: h.preferenceConnectTimeout + h.realtimeRequestTimeout,
            failState: "disconnected"
          },
          connected: {
            state: "connected",
            terminal: !1,
            queueEvents: !1,
            sendEvents: !0,
            failState: "disconnected"
          },
          synchronizing: {
            state: "connected",
            terminal: !1,
            queueEvents: !0,
            sendEvents: !1,
            forceQueueEvents: !0,
            failState: "disconnected"
          },
          disconnected: {
            state: "disconnected",
            terminal: !1,
            queueEvents: !0,
            sendEvents: !1,
            retryDelay: h.disconnectedRetryTimeout,
            failState: "disconnected"
          },
          suspended: {
            state: "suspended",
            terminal: !1,
            queueEvents: !1,
            sendEvents: !1,
            retryDelay: h.suspendedRetryTimeout,
            failState: "suspended"
          },
          closing: {
            state: "closing",
            terminal: !1,
            queueEvents: !1,
            sendEvents: !1,
            retryDelay: h.realtimeRequestTimeout,
            failState: "closed"
          },
          closed: {
            state: "closed",
            terminal: !0,
            queueEvents: !1,
            sendEvents: !1,
            failState: "closed"
          },
          failed: {
            state: "failed",
            terminal: !0,
            queueEvents: !1,
            sendEvents: !1,
            failState: "failed"
          }
        };
        this.state = this.states.initialized;
        this.errorReason = null;
        this.queuedMessages = new ja;
        this.msgSerial = 0;
        this.connectionSerial = this.timeSerial = this.connectionKey = this.connectionId = this.connectionDetails = void 0;
        this.connectionStateTtl = h.connectionStateTtl;
        this.maxIdleInterval = null;
        this.transports = k.intersect(b.transports || t.defaultTransports, a.supportedTransports);
        this.baseTransport = k.intersect(t.baseTransportOrder, this.transports)[0];
        this.upgradeTransports = k.intersect(this.transports, t.upgradeTransports);
        this.transportPreference = null;
        this.httpHosts = t.getHosts(b);
        this.activeProtocol = null;
        this.proposedTransports = [];
        this.pendingTransports = [];
        this.mostRecentMsg = this.lastActivity = this.lastAutoReconnectAttempt = this.host = null;
        this.forceFallbackHost = !1;
        this.connectCounter = 0;
        d.logAction(d.LOG_MINOR, "Realtime.ConnectionManager()", "started");
        d.logAction(d.LOG_MICRO, "Realtime.ConnectionManager()", "requested transports = [" + (b.transports || t.defaultTransports) + "]");
        d.logAction(d.LOG_MICRO, "Realtime.ConnectionManager()", "available transports = [" + this.transports + "]");
        d.logAction(d.LOG_MICRO, "Realtime.ConnectionManager()", "http hosts = [" + this.httpHosts + "]");
        if (!this.transports.length) throw d.logAction(d.LOG_ERROR, "realtime.ConnectionManager()", "no requested transports available"), Error("no requested transports available");
        if (h = r.addEventListener) e && "function" === typeof b.recover && h("beforeunload", this.persistConnection.bind(this)), !0 === b.closeOnUnload && h("beforeunload", function() {
          d.logAction(d.LOG_MAJOR, "Realtime.ConnectionManager()", "beforeunload event has triggered the connection to close as closeOnUnload is true");
          g.requestState({
            state: "closing"
          })
        }), h("online", function() {
          if (g.state == g.states.disconnected || g.state == g.states.suspended) d.logAction(d.LOG_MINOR, "ConnectionManager caught browser \u2018online\u2019 event", "reattempting connection"), g.requestState({
            state: "connecting"
          })
        }), h("offline", function() {
          g.state == g.states.connected && (d.logAction(d.LOG_MINOR, "ConnectionManager caught browser \u2018offline\u2019 event", "disconnecting active transport"), g.disconnectAllTransports())
        })
      }

      function c(a, c, b) {
        var d;
        if (a.channel !== c.channel || (d = a.action) !== l.PRESENCE && d !== l.MESSAGE || d !== c.action) return !1;
        d = d === l.PRESENCE ? "presence" : "messages";
        c = a[d].concat(c[d]);
        if (D.getMessagesSize(c) > b || !k.allSame(c, "clientId") || !k.arrEvery(c, function(a) {
            return !a.id
          })) return !1;
        a[d] = c;
        return !0
      }
      var n = !("undefined" === typeof J || !J.get),
        e = !("undefined" === typeof J || !J.getSession),
        l = B.Action,
        p = ka.PendingMessage,
        g = t.transportPreferenceOrder,
        v = g[g.length - 1];
      f.prototype.getConnectParams = function(a) {
        a = a ? k.copy(a) : {};
        var c = this.options;
        switch (this.mode) {
          case "upgrade":
            a.upgrade = this.connectionKey;
            break;
          case "resume":
            a.resume = this.connectionKey;
            void 0 !== this.timeSerial ? a.timeSerial = this.timeSerial : void 0 !== this.connectionSerial && (a.connectionSerial = this.connectionSerial);
            break;
          case "recover":
            var b = c.recover.split(":");
            b && (a.recover = b[0], b = b[1], isNaN(b) ? a.timeSerial = b : a.connectionSerial = b)
        }
        void 0 !== c.clientId && (a.clientId = c.clientId);
        !1 === c.echoMessages && (a.echo = "false");
        void 0 !== this.format && (a.format = this.format);
        void 0 !== this.stream && (a.stream = this.stream);
        void 0 !== this.heartbeats && (a.heartbeats = this.heartbeats);
        a.v = t.apiVersion;
        a.lib = t.libstring;
        void 0 !== c.transportParams && k.mixin(a, c.transportParams);
        return a
      };
      f.prototype.toString = function() {
        var a = "[mode=" + this.mode;
        this.host && (a += ",host=" + this.host);
        this.connectionKey && (a += ",connectionKey=" + this.connectionKey);
        void 0 !== this.connectionSerial && (a += ",connectionSerial=" + this.connectionSerial);
        this.timeSerial && (a += ",timeSerial=" + this.timeSerial);
        this.format && (a += ",format=" + this.format);
        return a + "]"
      };
      k.inherits(a, C);
      a.supportedTransports = {};
      a.prototype.createTransportParams = function(a, c) {
        var b = new f(this.options, a, c, this.connectionKey);
        this.timeSerial ? b.timeSerial = this.timeSerial : void 0 !== this.connectionSerial && (b.connectionSerial = this.connectionSerial);
        return b
      };
      a.prototype.getTransportParams = function(a) {
        var c = this;
        (function(a) {
          if (c.connectionKey) a("resume");
          else if ("string" === typeof c.options.recover) a("recover");
          else {
            var b = c.options.recover,
              h = e && J.getSession("ably-connection-recovery");
            h && "function" === typeof b ? (d.logAction(d.LOG_MINOR, "ConnectionManager.getTransportParams()", "Calling clientOptions-provided recover function with last session data"), b(h, function(b) {
              b ? (c.options.recover = h.recoveryKey, a("recover")) : a("clean")
            })) : a("clean")
          }
        })(function(b) {
          var e = c.createTransportParams(null, b);
          "recover" === b ? (d.logAction(d.LOG_MINOR, "ConnectionManager.getTransportParams()", "Transport recovery mode = recover; recoveryKey = " +
            c.options.recover), (b = c.options.recover.split(":")) && b[2] && (c.msgSerial = b[2])) : d.logAction(d.LOG_MINOR, "ConnectionManager.getTransportParams()", "Transport params = " + e.toString());
          a(e)
        })
      };
      a.prototype.tryATransport = function(c, b, e) {
        var h = this;
        d.logAction(d.LOG_MICRO, "ConnectionManager.tryATransport()", "trying " + b);
        a.supportedTransports[b].tryConnect(this, this.realtime.auth, c, function(a, g) {
          var f = h.state;
          f == h.states.closing || f == h.states.closed || f == h.states.failed ? (g && (d.logAction(d.LOG_MINOR, "ConnectionManager.tryATransport()", "connection " + f.state + " while we were attempting the transport; closing " + g), g.close()), e(!0)) : a ? (d.logAction(d.LOG_MINOR, "ConnectionManager.tryATransport()", "transport " + b + " " + a.event + ", err: " + a.error.toString()), N.isTokenErr(a.error) ? h.realtime.auth._forceNewToken(null, null, function(a) {
            a ? h.actOnErrorFromAuthorize(a) : h.tryATransport(c, b, e)
          }) : "failed" === a.event ? (h.notifyState({
            state: "failed",
            error: a.error
          }), e(!0)) : "disconnected" === a.event && e(!1)) : (d.logAction(d.LOG_MICRO, "ConnectionManager.tryATransport()", "viable transport " + b + "; setting pending"), h.setTransportPending(g, c), e(null, g))
        })
      };
      a.prototype.setTransportPending = function(a, c) {
        var b = c.mode;
        d.logAction(d.LOG_MINOR, "ConnectionManager.setTransportPending()", "transport = " + a + "; mode = " + b);
        k.arrDeleteValue(this.proposedTransports, a);
        this.pendingTransports.push(a);
        var e = this;
        a.once("connected", function(d, h, g, f) {
          "upgrade" == b && e.activeProtocol ? a.shortName !== v && k.arrIn(e.getUpgradePossibilities(), v) ? setTimeout(function() {
            e.scheduleTransportActivation(d, a, h, g, f)
          }, e.options.timeouts.parallelUpgradeDelay) : e.scheduleTransportActivation(d, a, h, g, f) : (e.activateTransport(d, a, h, g, f), k.nextTick(function() {
            e.connectImpl(c)
          }));
          "recover" === b && e.options.recover && (e.options.recover = null, e.unpersistConnection())
        });
        a.on(["disconnected", "closed", "failed"], function(c) {
          e.deactivateTransport(a, this.event, c)
        });
        this.emit("transport.pending", a)
      };
      a.prototype.scheduleTransportActivation = function(a, c, b, e, g) {
        function h() {
          c.disconnect();
          k.arrDeleteValue(f.pendingTransports, c)
        }
        var f = this,
          l = this.activeProtocol && this.activeProtocol.getTransport();
        this.state !== this.states.connected && this.state !== this.states.connecting ? (d.logAction(d.LOG_MINOR, "ConnectionManager.scheduleTransportActivation()", "Current connection state (" + this.state.state + (this.state === this.states.synchronizing ? ", but with an upgrade already in progress" : "") + ") is not valid to upgrade in; abandoning upgrade to " + c.shortName), h()) : l && !m(c, l) ? (d.logAction(d.LOG_MINOR, "ConnectionManager.scheduleTransportActivation()", "Proposed transport " + c.shortName + " is no better than current active transport " + l.shortName + " - abandoning upgrade"), h()) : (d.logAction(d.LOG_MINOR, "ConnectionManager.scheduleTransportActivation()", "Scheduling transport upgrade; transport = " + c), this.realtime.channels.onceNopending(function(l) {
          if (l) d.logAction(d.LOG_ERROR, "ConnectionManager.scheduleTransportActivation()", "Unable to activate transport; transport = " + c + "; err = " + l);
          else if (c.isConnected) {
            if (f.state === f.states.connected) {
              d.logAction(d.LOG_MICRO, "ConnectionManager.scheduleTransportActivation()", "Currently connected, so temporarily pausing events until the upgrade is complete");
              f.state = f.states.synchronizing;
              var n = f.activeProtocol
            } else if (f.state !== f.states.connecting) {
              d.logAction(d.LOG_MINOR, "ConnectionManager.scheduleTransportActivation()", "Current connection state (" + f.state.state + (f.state === f.states.synchronizing ? ", but with an upgrade already in progress" : "") + ") is not valid to upgrade in; abandoning upgrade to " + c.shortName);
              h();
              return
            }
            var v = (l = b !== f.connectionId) ? g : f;
            l && d.logAction(d.LOG_ERROR, "ConnectionManager.scheduleTransportActivation()", "Upgrade resulted in new connectionId; resetting library connection position from " + (f.timeSerial || f.connectionSerial) + " to " + (v.timeSerial || v.connectionSerial) + "; upgrade error was " + a);
            d.logAction(d.LOG_MINOR, "ConnectionManager.scheduleTransportActivation()", "Syncing transport; transport = " + c);
            f.sync(c, v, function(b, h, g) {
              if (b) f.state === f.states.synchronizing && (d.logAction(d.LOG_ERROR, "ConnectionManager.scheduleTransportActivation()", "Unexpected error attempting to sync transport; transport = " + c + "; err = " + b), f.disconnectAllTransports());
              else if (b = function() {
                  d.logAction(d.LOG_MINOR, "ConnectionManager.scheduleTransportActivation()", "Activating transport; transport = " + c);
                  f.activateTransport(a, c, h, e, g);
                  f.state === f.states.synchronizing ? (d.logAction(d.LOG_MICRO, "ConnectionManager.scheduleTransportActivation()", "Pre-upgrade protocol idle, sending queued messages on upgraded transport; transport = " + c), f.state = f.states.connected) : d.logAction(d.LOG_MINOR, "ConnectionManager.scheduleTransportActivation()", "Pre-upgrade protocol idle, but state is now " + f.state.state + ", so leaving unchanged");
                  f.state.sendEvents && f.sendQueuedMessages()
                }, n) n.onceIdle(b);
              else b()
            })
          } else d.logAction(d.LOG_MINOR, "ConnectionManager.scheduleTransportActivation()", "Proposed transport " + c.shortName + "is no longer connected; abandoning upgrade"), h()
        }))
      };
      a.prototype.activateTransport = function(a, c, b, e, g) {
        d.logAction(d.LOG_MINOR, "ConnectionManager.activateTransport()", "transport = " + c);
        a && d.logAction(d.LOG_ERROR, "ConnectionManager.activateTransport()", "error = " + a);
        b && d.logAction(d.LOG_MICRO, "ConnectionManager.activateTransport()", "connectionId =  " + b);
        e && d.logAction(d.LOG_MICRO, "ConnectionManager.activateTransport()", "connectionDetails =  " + JSON.stringify(e));
        g && d.logAction(d.LOG_MICRO, "ConnectionManager.activateTransport()", "serial =  " + (g.timeSerial || g.connectionSerial));
        this.persistTransportPreference(c);
        var h = this.state,
          f = this.states.connected.state;
        d.logAction(d.LOG_MINOR, "ConnectionManager.activateTransport()", "current state = " + h.state);
        if (h.state == this.states.closing.state || h.state == this.states.closed.state || h.state == this.states.failed.state) return d.logAction(d.LOG_MINOR, "ConnectionManager.activateTransport()", "Disconnecting transport and abandoning"), c.disconnect(), !1;
        k.arrDeleteValue(this.pendingTransports, c);
        if (!c.isConnected) return d.logAction(d.LOG_MINOR, "ConnectionManager.activateTransport()", "Declining to activate transport " + c + " since it appears to no longer be connected"), !1;
        var l = this.activeProtocol;
        this.activeProtocol = new ka(c);
        this.host = c.params.host;
        var n = e.connectionKey;
        n && this.connectionKey != n && this.setConnection(b, e, g, !!a);
        this.onConnectionDetailsUpdate(e, c);
        var v = this;
        k.nextTick(function() {
          c.on("connected", function(a, b, d) {
            v.onConnectionDetailsUpdate(d, c);
            v.emit("update", new U(f, f, null, a))
          })
        });
        h.state === this.states.connected.state ? a && (this.errorReason = this.realtime.connection.errorReason = a, this.emit("update", new U(f, f, null, a))) : (this.notifyState({
          state: "connected",
          error: a
        }), this.errorReason = this.realtime.connection.errorReason = a || null);
        this.emit("transport.active", c);
        l && (0 < l.messageQueue.count() && d.logAction(d.LOG_ERROR, "ConnectionManager.activateTransport()", "Previous active protocol (for transport " + l.transport.shortName + ", new one is " + c.shortName + ") finishing with " + l.messageQueue.count() + " messages still pending"), l.transport === c ? (a = "Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = " +
          c.shortName + "; stack = " + Error().stack, d.logAction(d.LOG_ERROR, "ConnectionManager.activateTransport()", a), W.report("error", a, "transport-previously-active")) : l.finish());
        k.safeArrForEach(this.pendingTransports, function(a) {
          a === c ? (a = "Assumption violated: activating a transport that is still marked as a pending transport; transport = " + c.shortName + "; stack = " + Error().stack, d.logAction(d.LOG_ERROR, "ConnectionManager.activateTransport()", a), W.report("error", a, "transport-activating-pending"), k.arrDeleteValue(v.pendingTransports, c)) : a.disconnect()
        });
        k.safeArrForEach(this.proposedTransports, function(a) {
          a === c ? (a = "Assumption violated: activating a transport that is still marked as a proposed transport; transport = " + c.shortName + "; stack = " + Error().stack, d.logAction(d.LOG_ERROR, "ConnectionManager.activateTransport()", a), W.report("error", a, "transport-activating-proposed"), k.arrDeleteValue(v.proposedTransports, c)) : a.dispose()
        });
        return !0
      };
      a.prototype.deactivateTransport = function(a, c, b) {
        var e = this.activeProtocol,
          h = e && e.getTransport() === a,
          g = k.arrDeleteValue(this.pendingTransports, a),
          f = k.arrDeleteValue(this.proposedTransports, a),
          l = this.noTransportsScheduledForActivation();
        d.logAction(d.LOG_MINOR, "ConnectionManager.deactivateTransport()", "transport = " + a);
        d.logAction(d.LOG_MINOR, "ConnectionManager.deactivateTransport()", "state = " + c + (h ? "; was active" : g ? "; was pending" : f ? "; was proposed" : "") + (l ? "" : "; another transport is scheduled for activation"));
        b && b.message && d.logAction(d.LOG_MICRO, "ConnectionManager.deactivateTransport()", "reason =  " +
          b.message);
        h && (d.logAction(d.LOG_MICRO, "ConnectionManager.deactivateTransport()", "Getting, clearing, and requeuing " + this.activeProtocol.messageQueue.count() + " pending messages"), this.queuePendingMessages(e.getPendingMessages()), k.nextTick(function() {
          e.clearPendingMessages()
        }), this.activeProtocol = this.host = null, clearTimeout(this.channelResumeCheckTimer));
        this.emit("transport.inactive", a);
        h && l || h && "failed" === c || "closed" === c || null === e && g && 0 === this.pendingTransports.length ? "disconnected" === c && b && 500 < b.statusCode && 1 < this.httpHosts.length ? (this.unpersistTransportPreference(), this.forceFallbackHost = !0, this.notifyState({
          state: c,
          error: b,
          retryImmediately: !0
        })) : (a = "failed" === c && N.isTokenErr(b) ? "disconnected" : c, this.notifyState({
          state: a,
          error: b
        })) : h && "disconnected" === c && this.state !== this.states.synchronizing && (d.logAction(d.LOG_MICRO, "ConnectionManager.deactivateTransport()", "wasActive but another transport is connected and scheduled for activation, so going into the connecting state until it activates"), this.startSuspendTimer(), this.startTransitionTimer(this.states.connecting), this.notifyState({
          state: "connecting",
          error: b
        }))
      };
      a.prototype.noTransportsScheduledForActivation = function() {
        return k.isEmpty(this.pendingTransports) || this.pendingTransports.every(function(a) {
          return !a.isConnected
        })
      };
      a.prototype.sync = function(a, c, b) {
        var d = setTimeout(function() {
            a.off("sync");
            b(new q("Timeout waiting for sync response", 5E4, 500))
          }, this.options.timeouts.realtimeRequestTimeout),
          e = B.fromValues({
            action: l.SYNC,
            connectionKey: this.connectionKey
          });
        c.timeSerial ? e.timeSerial = c.timeSerial : void 0 !== c.connectionSerial && (e.connectionSerial = c.connectionSerial);
        a.send(e);
        a.once("sync", function(a, c) {
          clearTimeout(d);
          b(null, a, c)
        })
      };
      a.prototype.setConnection = function(a, c, b, e) {
        var h = this,
          g = this.connectionid,
          f = g && g !== a;
        if (f || !g && e) d.logAction(d.LOG_MINOR, "ConnectionManager.setConnection()", "Resetting msgSerial"), this.msgSerial = 0;
        this.connectionId !== a ? (d.logAction(d.LOG_MINOR, "ConnectionManager.setConnection()", "New connectionId; reattaching any attached channels"), k.nextTick(function() {
          h.realtime.channels.reattach()
        })) : this.options.checkChannelsOnResume && (d.logAction(d.LOG_MINOR, "ConnectionManager.setConnection()", "Same connectionId; checkChannelsOnResume is enabled"), clearTimeout(this.channelResumeCheckTimer), this.realtime.channels.resetAttachedMsgIndicators(), this.channelResumeCheckTimer = setTimeout(function() {
          h.realtime.channels.checkAttachedMsgIndicators(a)
        }, 3E4));
        this.realtime.connection.id = this.connectionId = a;
        this.realtime.connection.key = this.connectionKey = c.connectionKey;
        this.setConnectionSerial(b, f || !g)
      };
      a.prototype.clearConnection = function() {
        this.realtime.connection.id = this.connectionId = void 0;
        this.realtime.connection.key = this.connectionKey = void 0;
        this.clearConnectionSerial();
        this.msgSerial = 0;
        this.unpersistConnection()
      };
      a.prototype.setConnectionSerial = function(a, c) {
        var b = a.timeSerial,
          e = a.connectionSerial;
        d.logAction(d.LOG_MICRO, "ConnectionManager.setConnectionSerial()", "Updating connection serial; serial = " + e + "; timeSerial = " + b + "; force = " + c + "; previous = " + this.connectionSerial);
        if (void 0 !== b) {
          if (b <= this.timeSerial && !c) return d.logAction(d.LOG_ERROR, "ConnectionManager.setConnectionSerial()", "received message with timeSerial " + b + ", but current timeSerial is " + this.timeSerial + "; assuming message is a duplicate and discarding it"), !0;
          this.realtime.connection.timeSerial = this.timeSerial = b;
          this.setRecoveryKey()
        } else if (void 0 !== e) {
          if (e <= this.connectionSerial && !c) return d.logAction(d.LOG_ERROR, "ConnectionManager.setConnectionSerial()", "received message with connectionSerial " +
            e + ", but current connectionSerial is " + this.connectionSerial + "; assuming message is a duplicate and discarding it"), !0;
          this.realtime.connection.serial = this.connectionSerial = e;
          this.setRecoveryKey()
        }
      };
      a.prototype.clearConnectionSerial = function() {
        this.realtime.connection.serial = this.connectionSerial = void 0;
        this.realtime.connection.timeSerial = this.timeSerial = void 0;
        this.clearRecoveryKey()
      };
      a.prototype.setRecoveryKey = function() {
        this.realtime.connection.recoveryKey = this.connectionKey + ":" + (this.timeSerial || this.connectionSerial) + ":" + this.msgSerial
      };
      a.prototype.clearRecoveryKey = function() {
        this.realtime.connection.recoveryKey = null
      };
      a.prototype.checkConnectionStateFreshness = function() {
        if (this.lastActivity && this.connectionId) {
          var a = k.now() - this.lastActivity;
          a > this.connectionStateTtl + this.maxIdleInterval && (d.logAction(d.LOG_MINOR, "ConnectionManager.checkConnectionStateFreshness()", "Last known activity from realtime was " + a + "ms ago; discarding connection state"), this.clearConnection(), this.states.connecting.failState = "suspended", this.states.connecting.queueEvents = !1)
        }
      };
      a.prototype.persistConnection = function() {
        if (e) {
          var a = this.realtime.connection.recoveryKey;
          a && (a = {
            recoveryKey: a,
            disconnectedAt: k.now(),
            location: x.location,
            clientId: this.realtime.auth.clientId
          }, e && J.setSession("ably-connection-recovery", a))
        }
      };
      a.prototype.unpersistConnection = function() {
        e && J.removeSession("ably-connection-recovery")
      };
      a.prototype.getError = function() {
        return this.errorReason || this.getStateError()
      };
      a.prototype.getStateError = function() {
        return K[this.state.state]
      };
      a.prototype.activeState = function() {
        return this.state.queueEvents || this.state.sendEvents
      };
      a.prototype.enactStateChange = function(a) {
        d.logAction("failed" === a.current ? d.LOG_ERROR : d.LOG_MAJOR, "Connection state", a.current + (a.reason ? "; reason: " + a.reason : ""));
        d.logAction(d.LOG_MINOR, "ConnectionManager.enactStateChange", "setting new state: " + a.current + "; reason = " + (a.reason && a.reason.message));
        var c = this.state = this.states[a.current];
        a.reason && (this.errorReason = a.reason, this.realtime.connection.errorReason = a.reason);
        (c.terminal || "suspended" === c.state) && this.clearConnection();
        this.emit("connectionstate", a)
      };
      a.prototype.startTransitionTimer = function(a) {
        d.logAction(d.LOG_MINOR, "ConnectionManager.startTransitionTimer()", "transitionState: " + a.state);
        this.transitionTimer && (d.logAction(d.LOG_MINOR, "ConnectionManager.startTransitionTimer()", "clearing already-running timer"), clearTimeout(this.transitionTimer));
        var c = this;
        this.transitionTimer = setTimeout(function() {
          c.transitionTimer && (c.transitionTimer = null, d.logAction(d.LOG_MINOR, "ConnectionManager " + a.state + " timer expired", "requesting new state: " + a.failState), c.notifyState({
            state: a.failState
          }))
        }, a.retryDelay)
      };
      a.prototype.cancelTransitionTimer = function() {
        d.logAction(d.LOG_MINOR, "ConnectionManager.cancelTransitionTimer()", "");
        this.transitionTimer && (clearTimeout(this.transitionTimer), this.transitionTimer = null)
      };
      a.prototype.startSuspendTimer = function() {
        var a = this;
        this.suspendTimer || (this.suspendTimer = setTimeout(function() {
          a.suspendTimer && (a.suspendTimer = null, d.logAction(d.LOG_MINOR, "ConnectionManager suspend timer expired", "requesting new state: suspended"), a.states.connecting.failState = "suspended", a.states.connecting.queueEvents = !1, a.notifyState({
            state: "suspended"
          }))
        }, this.connectionStateTtl))
      };
      a.prototype.checkSuspendTimer = function(a) {
        "disconnected" !== a && "suspended" !== a && "connecting" !== a && this.cancelSuspendTimer()
      };
      a.prototype.cancelSuspendTimer = function() {
        this.states.connecting.failState = "disconnected";
        this.states.connecting.queueEvents = !0;
        this.suspendTimer && (clearTimeout(this.suspendTimer), this.suspendTimer = null)
      };
      a.prototype.startRetryTimer = function(a) {
        var c = this;
        this.retryTimer = setTimeout(function() {
          d.logAction(d.LOG_MINOR, "ConnectionManager retry timer expired", "retrying");
          c.retryTimer = null;
          c.requestState({
            state: "connecting"
          })
        }, a)
      };
      a.prototype.cancelRetryTimer = function() {
        this.retryTimer && (clearTimeout(this.retryTimer), this.retryTimer = null)
      };
      a.prototype.notifyState = function(a) {
        var c = a.state,
          b = this,
          e = "disconnected" === c && (this.state === this.states.connected || this.state === this.states.synchronizing || a.retryImmediately || this.state === this.states.connecting && a.error && N.isTokenErr(a.error) && !(this.errorReason && N.isTokenErr(this.errorReason)));
        d.logAction(d.LOG_MINOR, "ConnectionManager.notifyState()", "new state: " + c + (e ? "; will retry connection immediately" : ""));
        if (c != this.state.state && (this.cancelTransitionTimer(), this.cancelRetryTimer(), this.checkSuspendTimer(a.state), !this.state.terminal)) {
          var h = this.states[a.state];
          a = new U(this.state.state, h.state, h.retryDelay, a.error || K[h.state]);
          if (e) {
            var g = function() {
                b.state === b.states.disconnected && (b.lastAutoReconnectAttempt = k.now(), b.requestState({
                  state: "connecting"
                }))
              },
              f = this.lastAutoReconnectAttempt && k.now() - this.lastAutoReconnectAttempt + 1;
            f && 1E3 > f ? (d.logAction(d.LOG_MICRO, "ConnectionManager.notifyState()", "Last reconnect attempt was only " + f + "ms ago, waiting another " + (1E3 - f) + "ms before trying again"), setTimeout(g, 1E3 - f)) : k.nextTick(g)
          } else "disconnected" !== c && "suspended" !== c || this.startRetryTimer(h.retryDelay);
          ("disconnected" === c && !e || "suspended" === c || h.terminal) && k.nextTick(function() {
            b.disconnectAllTransports()
          });
          "connected" != c || this.activeProtocol || d.logAction(d.LOG_ERROR, "ConnectionManager.notifyState()", "Broken invariant: attempted to go into connected state, but there is no active protocol");
          this.enactStateChange(a);
          this.state.sendEvents ? this.sendQueuedMessages() : this.state.queueEvents || (this.realtime.channels.propogateConnectionInterruption(c, a.reason), this.failQueuedMessages(a.reason))
        }
      };
      a.prototype.requestState = function(a) {
        var c = a.state,
          b = this;
        d.logAction(d.LOG_MINOR, "ConnectionManager.requestState()", "requested state: " + c + "; current state: " + this.state.state);
        if (c != this.state.state && (this.cancelTransitionTimer(), this.cancelRetryTimer(), this.checkSuspendTimer(c), "connecting" != c || "connected" != this.state.state) && ("closing" != c || "closed" != this.state.state)) {
          var e = this.states[c];
          a = new U(this.state.state, e.state, null, a.error || K[e.state]);
          this.enactStateChange(a);
          "connecting" == c && k.nextTick(function() {
            b.startConnect()
          });
          "closing" == c && this.closeImpl()
        }
      };
      a.prototype.startConnect = function() {
        if (this.state !== this.states.connecting) d.logAction(d.LOG_MINOR, "ConnectionManager.startConnect()", "Must be in connecting state to connect, but was " + this.state.state);
        else {
          var a = this.realtime.auth,
            c = this,
            b = ++this.connectCounter,
            e = function() {
              c.checkConnectionStateFreshness();
              c.getTransportParams(function(a) {
                b === c.connectCounter && c.connectImpl(a, b)
              })
            };
          d.logAction(d.LOG_MINOR, "ConnectionManager.startConnect()", "starting connection");
          this.startSuspendTimer();
          this.startTransitionTimer(this.states.connecting);
          if ("basic" === a.method) e();
          else {
            var g = function(a) {
              b === c.connectCounter && (a ? c.actOnErrorFromAuthorize(a) : e())
            };
            this.errorReason && N.isTokenErr(this.errorReason) ? a._forceNewToken(null, null, g) : a._ensureValidAuthCredentials(!1, g)
          }
        }
      };
      a.prototype.connectImpl = function(a, c) {
        var b = this.state.state;
        b !== this.states.connecting.state && b !== this.states.connected.state ? d.logAction(d.LOG_MINOR, "ConnectionManager.connectImpl()", "Must be in connecting state to connect (or connected to upgrade), but was " + b) : this.pendingTransports.length ? d.logAction(d.LOG_MINOR, "ConnectionManager.connectImpl()", "Transports " + this.pendingTransports[0].toString() + " currently pending; taking no action") : b == this.states.connected.state ? this.upgradeIfNeeded(a) : 1 < this.transports.length && this.getTransportPreference() ? this.connectPreference(a) : this.connectBase(a, c)
      };
      a.prototype.connectPreference = function(a) {
        var c = this.getTransportPreference(),
          b = this,
          e = !1;
        k.arrIn(this.transports, c) || (this.unpersistTransportPreference(), this.connectImpl(a));
        d.logAction(d.LOG_MINOR, "ConnectionManager.connectPreference()", "Trying to connect with stored transport preference " + c);
        var h = setTimeout(function() {
          e = !0;
          b.state.state !== b.states.connected.state && (d.logAction(d.LOG_MINOR, "ConnectionManager.connectPreference()", "Shortcircuit connection attempt with " + c + " failed; clearing preference and trying from scratch"), b.disconnectAllTransports(), b.unpersistTransportPreference());
          b.connectImpl(a)
        }, this.options.timeouts.preferenceConnectTimeout);
        a.host = b.httpHosts[0];
        b.tryATransport(a, c, function(c, d) {
          clearTimeout(h);
          e && d ? (d.off(), d.disconnect(), k.arrDeleteValue(this.pendingTransports, d)) : d || c || (b.unpersistTransportPreference(), b.connectImpl(a))
        })
      };
      a.prototype.connectBase = function(a, c) {
        function b(a, b) {
          c === g.connectCounter && (b || a || h())
        }

        function e(a) {
          g.notifyState({
            state: g.states.connecting.failState,
            error: a
          })
        }

        function h() {
          f.length ? A.checkConnectivity(function(d, h) {
            c === g.connectCounter && (d ? e(d) : h ? (a.host = k.arrPopRandomElement(f), g.tryATransport(a, g.baseTransport, b)) : e(new q("Unable to connect (network unreachable)", 80003, 404)))
          }) : e(new q("Unable to connect (and no more fallback hosts to try)", 80003, 404))
        }
        var g = this,
          f = this.httpHosts.slice();
        d.logAction(d.LOG_MINOR, "ConnectionManager.connectBase()", "Trying to connect with base transport " + this.baseTransport);
        var l = f.shift();
        l ? (a.host = l, this.forceFallbackHost && f.length ? (this.forceFallbackHost = !1, h()) : this.tryATransport(a, this.baseTransport, b)) : e(new q("Unable to connect (no available host)", 80003, 404))
      };
      a.prototype.getUpgradePossibilities = function() {
        var a = this.activeProtocol.getTransport().shortName;
        a = k.arrIndexOf(this.upgradeTransports, a);
        return this.upgradeTransports.slice(a + 1)
      };
      a.prototype.upgradeIfNeeded = function(a) {
        var c = this.getUpgradePossibilities(),
          e = this;
        d.logAction(d.LOG_MINOR, "ConnectionManager.upgradeIfNeeded()", "upgrade possibilities: " + k.inspect(c));
        c.length && k.arrForEach(c, function(c) {
          var d = e.createTransportParams(a.host, "upgrade");
          e.tryATransport(d, c, b)
        })
      };
      a.prototype.closeImpl = function() {
        d.logAction(d.LOG_MINOR, "ConnectionManager.closeImpl()", "closing connection");
        this.cancelSuspendTimer();
        this.startTransitionTimer(this.states.closing);
        k.safeArrForEach(this.pendingTransports, function(a) {
          d.logAction(d.LOG_MICRO, "ConnectionManager.closeImpl()", "Closing pending transport: " + a);
          a && a.close()
        });
        k.safeArrForEach(this.proposedTransports, function(a) {
          d.logAction(d.LOG_MICRO, "ConnectionManager.closeImpl()", "Disposing of proposed transport: " + a);
          a && a.dispose()
        });
        this.activeProtocol && (d.logAction(d.LOG_MICRO, "ConnectionManager.closeImpl()", "Closing active transport: " + this.activeProtocol.getTransport()), this.activeProtocol.getTransport().close());
        this.notifyState({
          state: "closed"
        })
      };
      a.prototype.onAuthUpdated = function(a, c) {
        var b = this;
        switch (this.state.state) {
          case "connected":
            d.logAction(d.LOG_MICRO, "ConnectionManager.onAuthUpdated()", "Sending AUTH message on active transport");
            if ((this.pendingTransports.length || this.proposedTransports.length) && b.state !== b.states.synchronizing) {
              this.disconnectAllTransports(!0);
              var e = this.activeProtocol.getTransport().params;
              k.nextTick(function() {
                "connected" === b.state.state && b.upgradeIfNeeded(e)
              })
            }
            this.activeProtocol.getTransport().onAuthUpdated(a);
            var h = B.fromValues({
              action: l.AUTH,
              auth: {
                accessToken: a.token
              }
            });
            this.send(h);
            var g = function() {
                b.off(f);
                c(null, a)
              },
              f = function(a) {
                "failed" === a.current && (b.off(g), b.off(f), c(a.reason || b.getStateError()))
              };
            this.once("connectiondetails", g);
            this.on("connectionstate", f);
            break;
          case "connecting":
            d.logAction(d.LOG_MICRO, "ConnectionManager.onAuthUpdated()", "Aborting current connection attempts in order to start again with the new auth details"), this.disconnectAllTransports();
          default:
            d.logAction(d.LOG_MICRO, "ConnectionManager.onAuthUpdated()", "Connection state is " + this.state.state + "; waiting until either connected or failed");
            var n = function(e) {
              switch (e.current) {
                case "connected":
                  b.off(n);
                  c(null, a);
                  break;
                case "failed":
                case "closed":
                case "suspended":
                  b.off(n), c(e.reason || b.getStateError())
              }
            };
            b.on("connectionstate", n);
            "connecting" === this.state.state ? b.startConnect() : b.requestState({
              state: "connecting"
            })
        }
      };
      a.prototype.disconnectAllTransports = function(a) {
        d.logAction(d.LOG_MINOR, "ConnectionManager.disconnectAllTransports()", "Disconnecting all transports" + (a ? " except the active transport" : ""));
        this.connectCounter++;
        k.safeArrForEach(this.pendingTransports, function(a) {
          d.logAction(d.LOG_MICRO, "ConnectionManager.disconnectAllTransports()", "Disconnecting pending transport: " + a);
          a && a.disconnect()
        });
        this.pendingTransports = [];
        k.safeArrForEach(this.proposedTransports, function(a) {
          d.logAction(d.LOG_MICRO, "ConnectionManager.disconnectAllTransports()", "Disposing of proposed transport: " +
            a);
          a && a.dispose()
        });
        this.proposedTransports = [];
        this.activeProtocol && !a && (d.logAction(d.LOG_MICRO, "ConnectionManager.disconnectAllTransports()", "Disconnecting active transport: " + this.activeProtocol.getTransport()), this.activeProtocol.getTransport().disconnect())
      };
      a.prototype.send = function(a, c, e) {
        e = e || b;
        var g = this.state;
        g.sendEvents ? (d.logAction(d.LOG_MICRO, "ConnectionManager.send()", "sending event"), this.sendImpl(new p(a, e))) : c && g.queueEvents || g.forceQueueEvents ? (d.shouldLog(d.LOG_MICRO) && d.logAction(d.LOG_MICRO, "ConnectionManager.send()", "queueing msg; " + B.stringify(a)), this.queue(a, e)) : (a = "rejecting event, queueEvent was " + c + ", state was " + g.state, d.logAction(d.LOG_MICRO, "ConnectionManager.send()", a), e(this.errorReason || new q(a, 9E4, 400)))
      };
      a.prototype.sendImpl = function(a) {
        var c = a.message;
        a.ackRequired && !a.sendAttempted && (c.msgSerial = this.msgSerial++, this.setRecoveryKey());
        try {
          this.activeProtocol.send(a)
        } catch (w) {
          d.logAction(d.LOG_ERROR, "ConnectionManager.sendImpl()", "Unexpected exception in transport.send(): " +
            w.stack)
        }
      };
      a.prototype.queue = function(a, b) {
        d.logAction(d.LOG_MICRO, "ConnectionManager.queue()", "queueing event");
        var e = this.queuedMessages.last(),
          g = this.options.maxMessageSize;
        e && !e.sendAttempted && c(e.message, a, g) ? (e.merged || (e.callback = ca([e.callback]), e.merged = !0), e.callback.push(b)) : this.queuedMessages.push(new p(a, b))
      };
      a.prototype.sendQueuedMessages = function() {
        d.logAction(d.LOG_MICRO, "ConnectionManager.sendQueuedMessages()", "sending " + this.queuedMessages.count() + " queued messages");
        for (var a; a = this.queuedMessages.shift();) this.sendImpl(a)
      };
      a.prototype.queuePendingMessages = function(a) {
        a && a.length && (d.logAction(d.LOG_MICRO, "ConnectionManager.queuePendingMessages()", "queueing " + a.length + " pending messages"), this.queuedMessages.prepend(a))
      };
      a.prototype.failQueuedMessages = function(a) {
        var c = this.queuedMessages.count();
        0 < c && (d.logAction(d.LOG_ERROR, "ConnectionManager.failQueuedMessages()", "failing " + c + " queued messages, err = " + k.inspectError(a)), this.queuedMessages.completeAllMessages(a))
      };
      a.prototype.onChannelMessage = function(a, c) {
        var b = this.activeProtocol && c === this.activeProtocol.getTransport(),
          e = k.arrIn(this.pendingTransports, c) && this.state == this.states.synchronizing,
          g = a.action === l.MESSAGE || a.action === l.PRESENCE;
        if (b || e) {
          if (g) {
            if (this.setConnectionSerial(a)) return;
            if (B.isDuplicate(a, this.mostRecentMsg)) {
              d.logAction(d.LOG_ERROR, "ConnectionManager.onChannelMessage()", "received message with different connectionSerial, but same message id as a previous; discarding; id = " + a.id);
              return
            }
            this.mostRecentMsg = a
          }
          this.realtime.channels.onChannelMessage(a)
        } else if (-1 < k.arrIndexOf([l.ACK, l.NACK, l.ERROR], a.action)) this.realtime.channels.onChannelMessage(a);
        else d.logAction(d.LOG_MICRO, "ConnectionManager.onChannelMessage()", "received message " + JSON.stringify(a) + "on defunct transport; discarding")
      };
      a.prototype.ping = function(a, c) {
        if (a) {
          d.logAction(d.LOG_MINOR, "ConnectionManager.ping()", "transport = " + a);
          var b = k.now(),
            e = k.cheapRandStr(),
            g = function(d) {
              d === e && (a.off("heartbeat", g), clearTimeout(f), d = k.now() - b, c(null, d))
            },
            f = setTimeout(function() {
              a.off("heartbeat", g);
              c(new q("Timeout waiting for heartbeat response", 5E4, 500))
            }, this.options.timeouts.realtimeRequestTimeout);
          a.on("heartbeat", g);
          a.ping(e)
        } else if ("connected" !== this.state.state) c(new q("Unable to ping service; not connected", 4E4, 400));
        else {
          var h = !1,
            l = this,
            n = function() {
              h || (h = !0, k.nextTick(function() {
                l.ping(null, c)
              }))
            };
          this.on("transport.active", n);
          this.ping(this.activeProtocol.getTransport(), function(a, b) {
            l.off("transport.active", n);
            h || (h = !0, c(a, b))
          })
        }
      };
      a.prototype.abort = function(a) {
        this.activeProtocol.getTransport().fail(a)
      };
      a.prototype.registerProposedTransport = function(a) {
        this.proposedTransports.push(a)
      };
      a.prototype.getTransportPreference = function() {
        return this.transportPreference || n && J.get("ably-transport-preference")
      };
      a.prototype.persistTransportPreference = function(a) {
        k.arrIn(t.upgradeTransports, a.shortName) && (this.transportPreference = a.shortName, n && J.set("ably-transport-preference", a.shortName))
      };
      a.prototype.unpersistTransportPreference = function() {
        this.transportPreference = null;
        n && J.remove("ably-transport-preference")
      };
      a.prototype.actOnErrorFromAuthorize = function(a) {
        if (40171 === a.code) this.notifyState({
          state: "failed",
          error: a
        });
        else if (403 === a.statusCode) {
          var c = "Client configured authentication provider returned 403; failing the connection";
          d.logAction(d.LOG_ERROR, "ConnectionManager.actOnErrorFromAuthorize()", c);
          this.notifyState({
            state: "failed",
            error: new q(c, 80019, 403, a)
          })
        } else c = "Client configured authentication provider request failed", d.logAction(d.LOG_MINOR, "ConnectionManager.actOnErrorFromAuthorize", c), this.notifyState({
          state: this.state.failState,
          error: new q(c, 80019, 401, a)
        })
      };
      a.prototype.onConnectionDetailsUpdate = function(a, c) {
        if (a) {
          this.connectionDetails = a;
          a.maxMessageSize && (this.options.maxMessageSize = a.maxMessageSize);
          var b = a.clientId;
          if (b && (b = this.realtime.auth._uncheckedSetClientId(b))) {
            d.logAction(d.LOG_ERROR, "ConnectionManager.onConnectionDetailsUpdate()", b.message);
            c.fail(b);
            return
          }
          if (b = a.connectionStateTtl) this.connectionStateTtl = b;
          this.maxIdleInterval = a.maxIdleInterval;
          this.emit("connectiondetails", a)
        }
      };
      return a
    }(),
    Q = function() {
      function b(a, b, e) {
        C.call(this);
        this.connectionManager = a;
        a.registerProposedTransport(this);
        this.auth = b;
        this.params = e;
        this.timeouts = e.options.timeouts;
        this.format = e.format;
        this.isDisposed = this.isFinished = this.isConnected = !1;
        this.lastActivity = this.idleTimer = this.maxIdleInterval = null
      }
      var m = B.Action,
        f = B.fromValues({
          action: m.CLOSE
        }),
        a = B.fromValues({
          action: m.DISCONNECT
        });
      k.inherits(b, C);
      b.prototype.connect = function() {};
      b.prototype.close = function() {
        this.isConnected && this.requestClose();
        this.finish("closed", K.closed)
      };
      b.prototype.disconnect = function(a) {
        this.isConnected && this.requestDisconnect();
        this.finish("disconnected", a || K.disconnected)
      };
      b.prototype.fail = function(a) {
        this.isConnected && this.requestDisconnect();
        this.finish("failed", a || K.failed)
      };
      b.prototype.finish = function(a, b) {
        this.isFinished || (this.isFinished = !0, this.isConnected = !1, this.maxIdleInterval = null, clearTimeout(this.idleTimer), this.idleTimer = null, this.emit(a, b), this.dispose())
      };
      b.prototype.onProtocolMessage = function(a) {
        d.shouldLog(d.LOG_MICRO) && d.logAction(d.LOG_MICRO, "Transport.onProtocolMessage()", "received on " + this.shortName + ": " + B.stringify(a) + "; connectionId = " + this.connectionManager.connectionId);
        this.onActivity();
        switch (a.action) {
          case m.HEARTBEAT:
            d.logAction(d.LOG_MICRO, "Transport.onProtocolMessage()", this.shortName + " heartbeat; connectionId = " + this.connectionManager.connectionId);
            this.emit("heartbeat", a.id);
            break;
          case m.CONNECTED:
            this.onConnect(a);
            this.emit("connected", a.error, a.connectionId, a.connectionDetails, a);
            break;
          case m.CLOSED:
            this.onClose(a);
            break;
          case m.DISCONNECTED:
            this.onDisconnect(a);
            break;
          case m.ACK:
            this.emit("ack", a.msgSerial, a.count);
            break;
          case m.NACK:
            this.emit("nack", a.msgSerial, a.count, a.error);
            break;
          case m.SYNC:
            if (void 0 !== a.connectionId) {
              this.emit("sync", a.connectionId, a);
              break
            }
            this.connectionManager.onChannelMessage(a, this);
            break;
          case m.AUTH:
            this.auth.authorize(function(a) {
              a && d.logAction(d.LOG_ERROR, "Transport.onProtocolMessage()", "Ably requested re-authentication, but unable to obtain a new token: " + k.inspectError(a))
            });
            break;
          case m.ERROR:
            d.logAction(d.LOG_MINOR, "Transport.onProtocolMessage()", "received error action; connectionId = " + this.connectionManager.connectionId + "; err = " + k.inspect(a.error) + (a.channel ? ", channel: " + a.channel : ""));
            if (void 0 === a.channel) {
              this.onFatalError(a);
              break
            }
            this.connectionManager.onChannelMessage(a, this);
            break;
          default:
            this.connectionManager.onChannelMessage(a, this)
        }
      };
      b.prototype.onConnect = function(a) {
        this.isConnected = !0;
        if (a = a.connectionDetails.maxIdleInterval) this.maxIdleInterval = a +
          this.timeouts.realtimeRequestTimeout, this.onActivity()
      };
      b.prototype.onDisconnect = function(a) {
        a = a && a.error;
        d.logAction(d.LOG_MINOR, "Transport.onDisconnect()", "err = " + k.inspectError(a));
        this.finish("disconnected", a)
      };
      b.prototype.onFatalError = function(a) {
        a = a && a.error;
        d.logAction(d.LOG_MINOR, "Transport.onFatalError()", "err = " + k.inspectError(a));
        this.finish("failed", a)
      };
      b.prototype.onClose = function(a) {
        a = a && a.error;
        d.logAction(d.LOG_MINOR, "Transport.onClose()", "err = " + k.inspectError(a));
        this.finish("closed", a)
      };
      b.prototype.requestClose = function() {
        d.logAction(d.LOG_MINOR, "Transport.requestClose()", "");
        this.send(f)
      };
      b.prototype.requestDisconnect = function() {
        d.logAction(d.LOG_MINOR, "Transport.requestDisconnect()", "");
        this.send(a)
      };
      b.prototype.ping = function(a) {
        var c = {
          action: B.Action.HEARTBEAT
        };
        a && (c.id = a);
        this.send(B.fromValues(c))
      };
      b.prototype.dispose = function() {
        d.logAction(d.LOG_MINOR, "Transport.dispose()", "");
        this.isDisposed = !0;
        this.off()
      };
      b.prototype.onActivity = function() {
        this.maxIdleInterval && (this.lastActivity = this.connectionManager.lastActivity = k.now(), this.setIdleTimer(this.maxIdleInterval + 100))
      };
      b.prototype.setIdleTimer = function(a) {
        var c = this;
        this.idleTimer || (this.idleTimer = setTimeout(function() {
          c.onIdleTimerExpire()
        }, a))
      };
      b.prototype.onIdleTimerExpire = function() {
        this.idleTimer = null;
        var a = k.now() - this.lastActivity,
          b = this.maxIdleInterval - a;
        0 >= b ? (a = "No activity seen from realtime in " + a + "ms; assuming connection has dropped", d.logAction(d.LOG_ERROR, "Transport.onIdleTimerExpire()", a), this.disconnect(new q(a, 80003, 408))) : this.setIdleTimer(b + 100)
      };
      b.prototype.onAuthUpdated = function() {};
      return b
    }();
  (function() {
    function b(b, a, c) {
      this.shortName = "web_socket";
      c.heartbeats = r.useProtocolHeartbeats;
      Q.call(this, b, a, c);
      this.wsHost = t.getHost(c.options, c.host, !0)
    }
    var m = r.WebSocket;
    k.inherits(b, Q);
    b.isAvailable = function() {
      return !!m
    };
    b.isAvailable() && (O.supportedTransports.web_socket = b);
    b.tryConnect = function(f, a, c, n) {
      function e(a) {
        n({
          event: this.event,
          error: a
        })
      }
      var l = new b(f, a, c);
      l.on(["failed", "disconnected"], e);
      l.on("wsopen", function() {
        d.logAction(d.LOG_MINOR, "WebSocketTransport.tryConnect()", "viable transport " + l);
        l.off(["failed", "disconnected"], e);
        n(null, l)
      });
      l.connect()
    };
    b.prototype.createWebSocket = function(b, a) {
      var c = 0;
      if (a)
        for (var d in a) b += (c++ ? "&" : "?") + d + "=" + a[d];
      this.uri = b;
      return new m(b)
    };
    b.prototype.toString = function() {
      return "WebSocketTransport; uri=" + this.uri
    };
    b.prototype.connect = function() {
      d.logAction(d.LOG_MINOR, "WebSocketTransport.connect()", "starting");
      Q.prototype.connect.call(this);
      var b = this,
        a = this.params,
        c = a.options,
        n = (c.tls ? "wss://" : "ws://") + this.wsHost + ":" + t.getPort(c) + "/";
      d.logAction(d.LOG_MINOR, "WebSocketTransport.connect()", "uri: " + n);
      this.auth.getAuthParams(function(c, f) {
        if (!b.isDisposed) {
          var e = "",
            g;
          for (g in f) e += " " + g + ": " + f[g] + ";";
          d.logAction(d.LOG_MINOR, "WebSocketTransport.connect()", "authParams:" + e + " err: " + c);
          if (c) b.disconnect(c);
          else {
            e = a.getConnectParams(f);
            try {
              var l = b.wsConnection = b.createWebSocket(n, e);
              l.binaryType = r.binaryType;
              l.onopen = function() {
                b.onWsOpen()
              };
              l.onclose = function(a) {
                b.onWsClose(a)
              };
              l.onmessage = function(a) {
                b.onWsData(a.data)
              };
              l.onerror = function(a) {
                b.onWsError(a)
              };
              if (l.on) l.on("ping", function() {
                b.onActivity()
              })
            } catch (h) {
              d.logAction(d.LOG_ERROR, "WebSocketTransport.connect()", "Unexpected exception creating websocket: err = " + (h.stack || h.message)), b.disconnect(h)
            }
          }
        }
      })
    };
    b.prototype.send = function(b) {
      var a = this.wsConnection;
      if (a) try {
        a.send(B.serialize(b, this.params.format))
      } catch (c) {
        b = "Exception from ws connection when trying to send: " + k.inspectError(c), d.logAction(d.LOG_ERROR, "WebSocketTransport.send()", b), this.finish("disconnected", new q(b, 5E4, 500))
      } else d.logAction(d.LOG_ERROR, "WebSocketTransport.send()", "No socket connection")
    };
    b.prototype.onWsData = function(b) {
      d.logAction(d.LOG_MICRO, "WebSocketTransport.onWsData()", "data received; length = " + b.length + "; type = " + typeof b);
      try {
        this.onProtocolMessage(B.deserialize(b, this.format))
      } catch (a) {
        d.logAction(d.LOG_ERROR, "WebSocketTransport.onWsData()", "Unexpected exception handing channel message: " + a.stack)
      }
    };
    b.prototype.onWsOpen = function() {
      d.logAction(d.LOG_MINOR, "WebSocketTransport.onWsOpen()", "opened WebSocket");
      this.emit("wsopen")
    };
    b.prototype.onWsClose = function(b) {
      if ("object" == typeof b) {
        var a = b.wasClean;
        b = b.code
      } else a = 1E3 == b;
      delete this.wsConnection;
      a ? (d.logAction(d.LOG_MINOR, "WebSocketTransport.onWsClose()", "Cleanly closed WebSocket"), a = new q("Websocket closed", 80003, 400)) : (b = "Unclean disconnection of WebSocket ; code = " + b, a = new q(b, 80003, 400), d.logAction(d.LOG_MINOR, "WebSocketTransport.onWsClose()", b));
      this.finish("disconnected", a);
      this.emit("disposed")
    };
    b.prototype.onWsError = function(b) {
      d.logAction(d.LOG_MINOR, "WebSocketTransport.onError()", "Error from WebSocket: " + b.message);
      var a = this;
      k.nextTick(function() {
        a.disconnect(b)
      })
    };
    b.prototype.dispose = function() {
      d.logAction(d.LOG_MINOR, "WebSocketTransport.dispose()", "");
      this.isDisposed = !0;
      var b = this.wsConnection;
      b && (b.onmessage = function() {}, delete this.wsConnection, k.nextTick(function() {
        d.logAction(d.LOG_MICRO, "WebSocketTransport.dispose()", "closing websocket");
        b.close()
      }))
    };
    return b
  })();
  var L = function() {
      function b(b) {
        var a = [80015, 80017, 80030];
        return b.code && (N.isTokenErr(b) ? 0 : k.arrIn(a, b.code) || 4E4 <= b.code && 5E4 > b.code) ? [B.fromValues({
          action: B.Action.ERROR,
          error: b
        })] : [B.fromValues({
          action: B.Action.DISCONNECTED,
          error: b
        })]
      }

      function m(b, a, c) {
        c.format = void 0;
        c.heartbeats = !0;
        Q.call(this, b, a, c);
        this.stream = "stream" in c ? c.stream : !0;
        this.pendingItems = this.pendingCallback = this.recvRequest = this.sendRequest = null
      }
      k.inherits(m, Q);
      m.REQ_SEND = 0;
      m.REQ_RECV = 1;
      m.REQ_RECV_POLL = 2;
      m.REQ_RECV_STREAM = 3;
      m.prototype.connect = function() {
        d.logAction(d.LOG_MINOR, "CometTransport.connect()", "starting");
        Q.prototype.connect.call(this);
        var f = this,
          a = this.params,
          c = a.options;
        a = t.getHost(c, a.host);
        var n = t.getPort(c);
        this.baseUri = (c.tls ? "https://" : "http://") + a + ":" + n + "/comet/";
        var e = this.baseUri + "connect";
        d.logAction(d.LOG_MINOR, "CometTransport.connect()", "uri: " + e);
        this.auth.getAuthParams(function(a, c) {
          if (a) f.disconnect(a);
          else if (!f.isDisposed) {
            f.authParams = c;
            var g = f.params.getConnectParams(c);
            "stream" in g && (f.stream = g.stream);
            d.logAction(d.LOG_MINOR, "CometTransport.connect()", "connectParams:" + k.toQueryString(g));
            var l = !1;
            g = f.recvRequest = f.createRequest(e, null, g, null, f.stream ? 3 : 1);
            g.on("data", function(a) {
              f.recvRequest && (l || (l = !0, f.emit("preconnect")), f.onData(a))
            });
            g.on("complete", function(a) {
              f.recvRequest || (a = a || new q("Request cancelled", 80003, 400));
              f.recvRequest = null;
              l || (l = !0, f.emit("preconnect"));
              f.onActivity();
              if (a)
                if (a.code) f.onData(b(a));
                else f.disconnect(a);
              else k.nextTick(function() {
                f.recv()
              })
            });
            g.exec()
          }
        })
      };
      m.prototype.requestClose = function() {
        d.logAction(d.LOG_MINOR, "CometTransport.requestClose()");
        this._requestCloseOrDisconnect(!0)
      };
      m.prototype.requestDisconnect = function() {
        d.logAction(d.LOG_MINOR, "CometTransport.requestDisconnect()");
        this._requestCloseOrDisconnect(!1)
      };
      m.prototype._requestCloseOrDisconnect = function(b) {
        var a = b ? this.closeUri : this.disconnectUri;
        if (a) {
          var c = this;
          a = this.createRequest(a, null, this.authParams, null, 0);
          a.on("complete", function(a) {
            a && (d.logAction(d.LOG_ERROR, "CometTransport.request" + (b ? "Close()" : "Disconnect()"), "request returned err = " +
              k.inspectError(a)), c.finish("disconnected", a))
          });
          a.exec()
        }
      };
      m.prototype.dispose = function() {
        d.logAction(d.LOG_MINOR, "CometTransport.dispose()", "");
        if (!this.isDisposed) {
          this.isDisposed = !0;
          this.recvRequest && (d.logAction(d.LOG_MINOR, "CometTransport.dispose()", "aborting recv request"), this.recvRequest.abort(), this.recvRequest = null);
          this.finish("disconnected", K.disconnected);
          var b = this;
          k.nextTick(function() {
            b.emit("disposed")
          })
        }
      };
      m.prototype.onConnect = function(b) {
        if (!this.isDisposed) {
          var a = b.connectionKey;
          Q.prototype.onConnect.call(this, b);
          a = this.baseUri + a;
          d.logAction(d.LOG_MICRO, "CometTransport.onConnect()", "baseUri = " + a + "; connectionKey = " + b.connectionKey);
          this.sendUri = a + "/send";
          this.recvUri = a + "/recv";
          this.closeUri = a + "/close";
          this.disconnectUri = a + "/disconnect"
        }
      };
      m.prototype.send = function(b) {
        if (this.sendRequest) this.pendingItems = this.pendingItems || [], this.pendingItems.push(b);
        else {
          var a = this.pendingItems || [];
          a.push(b);
          this.pendingItems = null;
          this.sendItems(a)
        }
      };
      m.prototype.sendAnyPending = function() {
        var b = this.pendingItems;
        b && (this.pendingItems = null, this.sendItems(b))
      };
      m.prototype.sendItems = function(f) {
        var a = this;
        f = this.sendRequest = a.createRequest(a.sendUri, null, a.authParams, this.encodeRequest(f), 0);
        f.on("complete", function(c, f) {
          c && d.logAction(d.LOG_ERROR, "CometTransport.sendItems()", "on complete: err = " + k.inspectError(c));
          a.sendRequest = null;
          if (c)
            if (c.code) a.onData(b(c));
            else a.disconnect(c);
          else {
            if (f) a.onData(f);
            a.pendingItems && k.nextTick(function() {
              a.sendRequest || a.sendAnyPending()
            })
          }
        });
        f.exec()
      };
      m.prototype.recv = function() {
        if (!this.recvRequest && this.isConnected) {
          var d = this,
            a = this.recvRequest = this.createRequest(this.recvUri, null, this.authParams, null, d.stream ? 3 : 2);
          a.on("data", function(a) {
            d.onData(a)
          });
          a.on("complete", function(a) {
            d.recvRequest = null;
            d.onActivity();
            if (a)
              if (a.code) d.onData(b(a));
              else d.disconnect(a);
            else k.nextTick(function() {
              d.recv()
            })
          });
          a.exec()
        }
      };
      m.prototype.onData = function(b) {
        try {
          var a = this.decodeResponse(b);
          if (a && a.length)
            for (b = 0; b < a.length; b++) this.onProtocolMessage(B.fromDeserialized(a[b]))
        } catch (c) {
          d.logAction(d.LOG_ERROR, "CometTransport.onData()", "Unexpected exception handing channel event: " + c.stack)
        }
      };
      m.prototype.encodeRequest = function(b) {
        return JSON.stringify(b)
      };
      m.prototype.decodeResponse = function(b) {
        "string" == typeof b && (b = JSON.parse(b));
        return b
      };
      m.prototype.onAuthUpdated = function(b) {
        this.authParams = {
          access_token: b.token
        }
      };
      return m
    }(),
    Y = function() {
      function b() {}

      function m(b) {
        this.channel = b;
        this.basePath = b.basePath + "/presence"
      }
      k.inherits(m, C);
      m.prototype.get = function(f, a) {
        d.logAction(d.LOG_MICRO, "Presence.get()", "channel = " + this.channel.name);
        if (void 0 === a)
          if ("function" == typeof f) a = f, f = null;
          else {
            if (this.channel.rest.options.promises) return k.promisify(this, "get", arguments);
            a = b
          } var c = this.channel.rest,
          n = c.options.useBinaryProtocol ? "msgpack" : "json",
          e = A.supportsLinkHeaders ? void 0 : n,
          l = k.defaultGetHeaders(n);
        c.options.headers && k.mixin(l, c.options.headers);
        var p = this.channel.channelOptions;
        (new P(c, this.basePath, l, e, function(a, c, b) {
          return G.fromResponseBody(a, p, !b && n)
        })).get(f, a)
      };
      m.prototype.history = function(b, a) {
        d.logAction(d.LOG_MICRO, "Presence.history()", "channel = " + this.channel.name);
        this._history(b, a)
      };
      m.prototype._history = function(d, a) {
        if (void 0 === a)
          if ("function" == typeof d) a = d, d = null;
          else {
            if (this.channel.rest.options.promises) return k.promisify(this, "_history", arguments);
            a = b
          } var c = this.channel.rest,
          f = c.options.useBinaryProtocol ? "msgpack" : "json",
          e = A.supportsLinkHeaders ? void 0 : f,
          l = k.defaultGetHeaders(f);
        c.options.headers && k.mixin(l, c.options.headers);
        var p = this.channel.channelOptions;
        (new P(c, this.basePath + "/history", l, e, function(a, c, b) {
          return G.fromResponseBody(a, p, !b && f)
        })).get(d, a)
      };
      return m
    }(),
    I = function() {
      function b() {}

      function m(a, c, b, d, f) {
        A.supportsAuthHeaders ? a.auth.getAuthHeaders(function(a, e) {
          a ? d(a) : f(k.mixin(e, c), b)
        }) : a.auth.getAuthParams(function(a, e) {
          a ? d(a) : f(c, k.mixin(e, b))
        })
      }

      function f(a, c) {
        return function(b, d, e, h, f) {
          if (b && !d) a(b);
          else {
            if (!h) try {
              d = k.decodeBody(d, c)
            } catch (w) {
              a(w);
              return
            }
            void 0 === d.statusCode ? a(b, d, e, !0, f) : (e = d.statusCode, h = d.response, f = d.headers, 200 > e || 300 <= e ? (b = h && h.error || b, b || (b = Error("Error in unenveloping " + d), b.statusCode = e), a(b, h, f, !0, e)) : a(b, h, f, !0, e))
          }
        }
      }

      function a(a) {
        var c = [];
        if (a)
          for (var b in a) c.push(b + "=" + a[b]);
        return c.join("&")
      }

      function c(c, b, f, g) {
        return function(e, h, l, n, p) {
          e ? d.logAction(d.LOG_MICRO, "Resource." + b + "()", "Received Error; " + (f + (g ? "?" : "") + a(g)) + "; Error: " + k.inspectError(e)) : d.logAction(d.LOG_MICRO, "Resource." + b + "()", "Received; " + (f + (g ? "?" : "") + a(g)) + "; Headers: " + a(l) + "; StatusCode: " + p + "; Body: " + (y.isBuffer(h) ? h.toString() : h));
          c && c(e, h, l, n, p)
        }
      }
      var n = r.msgpack;
      k.arrForEach(A.methodsWithoutBody, function(a) {
        b[a] = function(c, d, e, f, h, n) {
          b["do"](a, c, d, null, e, f, h, n)
        }
      });
      k.arrForEach(A.methodsWithBody, function(a) {
        b[a] = function(c, d, e, f, h, n, k) {
          b["do"](a, c, d, e, f, h, n, k)
        }
      });
      b["do"] = function(b, l, p, g, v, h, u, w) {
        function e(c, f) {
          d.shouldLog(d.LOG_MICRO) && d.logAction(d.LOG_MICRO, "Resource." + b + "()", "Sending; " + (p + (f ? "?" : "") + a(f)));
          var u = [l, p, c, g, f, function(a, c, b, d, g) {
            a && N.isTokenErr(a) ? l.auth.authorize(null, null, function(a) {
              a ? w(a) : m(l, v, h, w, e)
            }) : w(a, c, b, d, g)
          }];
          g || u.splice(3, 1);
          if (d.shouldLog(d.LOG_MICRO)) {
            var q = g;
            if (0 < (c["content-type"] || "").indexOf("msgpack")) try {
              q = n.decode(g)
            } catch (H) {
              d.logAction(d.LOG_MICRO, "Resource." + b + "()", "Sending MsgPack Decoding Error: " + k.inspectError(H))
            }
            d.logAction(d.LOG_MICRO, "Resource." + b + "()", "Sending; " + (p + (f ? "?" : "") + a(f)) + "; Body: " + q)
          }
          A[b].apply(this, u)
        }
        d.shouldLog(d.LOG_MICRO) && (w = c(w, b, p, h));
        u && (w = w && f(w, u), (h = h || {}).envelope = u);
        m(l, v, h, w, e)
      };
      return b
    }(),
    P = function() {
      function b(a, c, b, d, f, k) {
        this.rest = a;
        this.path = c;
        this.headers = b;
        this.envelope = d;
        this.bodyHandler = f;
        this.useHttpPaginatedResponse = k || !1
      }

      function m(a, c, b) {
        this.resource = a;
        this.items = c;
        if (b) {
          var d = this;
          "first" in b && (this.first = function(a) {
            if (!a && d.resource.rest.options.promises) return k.promisify(d, "first", []);
            d.get(b.first, a)
          });
          "current" in b && (this.current = function(a) {
            if (!a && d.resource.rest.options.promises) return k.promisify(d, "current", []);
            d.get(b.current, a)
          });
          this.next = function(a) {
            if (!a && d.resource.rest.options.promises) return k.promisify(d, "next", []);
            "next" in b ? d.get(b.next, a) : a(null, null)
          };
          this.hasNext = function() {
            return "next" in b
          };
          this.isLast = function() {
            return !this.hasNext()
          }
        }
      }

      function f(a, c, b, d, f, k) {
        m.call(this, a, c, f);
        this.statusCode = d;
        this.success = 300 > d && 200 <= d;
        this.headers = b;
        this.errorCode = k && k.code;
        this.errorMessage = k && k.message
      }
      k.arrForEach(A.methodsWithoutBody, function(a) {
        b.prototype[a] = function(c, b) {
          var d = this;
          I[a](d.rest, d.path, d.headers, c, d.envelope, function(a, c, e, f, h) {
            d.handlePage(a, c, e, f, h, b)
          })
        }
      });
      k.arrForEach(A.methodsWithBody, function(a) {
        b.prototype[a] = function(c, b, d) {
          var e = this;
          I[a](e.rest, e.path, b, e.headers, c, e.envelope, function(a, c, b, h, f) {
            d && e.handlePage(a, c, b, h, f, d)
          })
        }
      });
      b.prototype.handlePage = function(a, c, b, e, l, p) {
        if (!a || this.useHttpPaginatedResponse && (c || "number" === typeof a.code)) {
          var g, n;
          try {
            var h = this.bodyHandler(c, b, e)
          } catch (w) {
            p(a || w);
            return
          }
          if (b && (g = b.Link || b.link)) {
            c = g;
            "string" == typeof c && (c = c.split(","));
            e = {};
            for (g = 0; g < c.length; g++)
              if (n = c[g].match(/^\s*<(.+)>;\s*rel="(\w+)"$/)) {
                var u;
                (u = (u = n[1].match(/^\.\/(\w+)\?(.*)$/)) && k.parseQueryString(u[2])) && (e[n[2]] = u)
              } n = e
          }
          this.useHttpPaginatedResponse ? p(null, new f(this, h, b, l, n, a)) : p(null, new m(this, h, n))
        } else d.logAction(d.LOG_ERROR, "PaginatedResource.handlePage()", "Unexpected error getting resource: err = " + k.inspectError(a)), p(a)
      };
      m.prototype.get = function(a, c) {
        var b = this.resource;
        I.get(b.rest, b.path, b.headers, a, b.envelope, function(a, d, f, g, n) {
          b.handlePage(a, d, f, g, n, c)
        })
      };
      k.inherits(f, m);
      return b
    }(),
    N = function() {
      function b() {}

      function m(a) {
        if (!k.isErrorInfo(a)) return new q(k.inspectError(a), a.code || 40170, a.statusCode || 401);
        a.code || (403 === a.statusCode ? a.code = 40300 : (a.code = 40170, a.statusCode = 401));
        return a
      }

      function f(a) {
        if (!a) return "";
        "string" == typeof a && (a = JSON.parse(a));
        var c = {},
          b = k.keysArray(a, !0);
        if (!b) return "";
        b.sort();
        for (var d = 0; d < b.length; d++) c[b[d]] = a[b[d]].sort();
        return JSON.stringify(c)
      }

      function a(a) {
        if (a.authCallback) d.logAction(d.LOG_MINOR, "Auth()", "using token auth with authCallback");
        else if (a.authUrl) d.logAction(d.LOG_MINOR, "Auth()", "using token auth with authUrl");
        else if (a.key) d.logAction(d.LOG_MINOR, "Auth()", "using token auth with client-side signing");
        else if (a.tokenDetails) d.logAction(d.LOG_MINOR, "Auth()", "using token auth with supplied token only");
        else throw d.logAction(d.LOG_ERROR, "Auth()", "authOptions must include valid authentication parameters"), Error("authOptions must include valid authentication parameters");
      }

      function c(c, b) {
        this.client = c;
        this.tokenParams = b.defaultTokenParams || {};
        this.waitingForTokenRequest = this.currentTokenRequestId = null;
        if (b.useTokenAuth || (!("useTokenAuth" in b) || b.useTokenAuth) && (b.authCallback || b.authUrl || b.token || b.tokenDetails)) {
          if (b.key && !l) {
            var e = "client-side token request signing not supported";
            d.logAction(d.LOG_ERROR, "Auth()", e);
            throw Error(e);
          }
          b.key || b.authCallback || b.authUrl || d.logAction(d.LOG_ERROR, "Auth()", "Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help");
          this._saveTokenOptions(b.defaultTokenParams, b);
          a(this.authOptions)
        } else {
          if (!b.key) throw e = "No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)", d.logAction(d.LOG_ERROR, "Auth()", e), new q(e, 40160, 401);
          d.logAction(d.LOG_MINOR, "Auth()", "anonymous, using basic auth");
          this._saveBasicOptions(b)
        }
      }
      var n = Math.pow(2, 17);
      if (r.createHmac) {
        var e = function(a) {
          return Buffer.from(a, "ascii").toString("base64")
        };
        var l = function(a, c) {
          var b = r.createHmac("SHA256", c);
          b.update(a);
          return b.digest("base64")
        }
      } else e = pa.encode, l = function(a, c) {
        return z.HmacSHA256(a, c).toString(z.enc.Base64)
      };
      var p = 0;
      c.prototype.authorize = function(a, c, e) {
        "function" != typeof a || e ? "function" != typeof c || e || (e = c, c = null) : (e = a, c = a = null);
        if (!e) {
          if (this.client.options.promises) return k.promisify(this, "authorize", arguments);
          e = b
        }
        var g = this;
        if (c && c.key && this.authOptions.key !== c.key) throw new q("Unable to update auth options with incompatible key", 40102, 401);
        c && "force" in c && (d.logAction(d.LOG_ERROR, "Auth.authorize", "Deprecation warning: specifying {force: true} in authOptions is no longer necessary, authorize() now always gets a new token. Please remove this, as in version 1.0 and later, having a non-null authOptions will overwrite stored library authOptions, which may not be what you want"), k.isOnlyPropIn(c, "force") && (c = null));
        this._forceNewToken(a, c, function(a, c) {
          if (a) g.client.connection && g.client.connection.connectionManager.actOnErrorFromAuthorize(a), e(a);
          else if (g.client.connection) g.client.connection.connectionManager.onAuthUpdated(c, e);
          else e(null, c)
        })
      };
      c.prototype.authorise = function() {
        d.deprecated("Auth.authorise", "Auth.authorize");
        this.authorize.apply(this, arguments)
      };
      c.prototype._forceNewToken = function(c, b, d) {
        var e = this;
        this.tokenDetails = null;
        this._saveTokenOptions(c, b);
        a(this.authOptions);
        this._ensureValidAuthCredentials(!0, function(a, c) {
          delete e.tokenParams.timestamp;
          delete e.authOptions.queryTime;
          d(a, c)
        })
      };
      c.prototype.requestToken = function(a, c, e) {
        function g(a, b) {
          var e = "/keys/" + a.keyName + "/requestToken",
            g = k.defaultPostHeaders();
          c.requestHeaders && k.mixin(g, c.requestHeaders);
          d.logAction(d.LOG_MICRO, "Auth.requestToken().requestToken", "Sending POST to " + e + "; Token params: " + JSON.stringify(a));
          a = JSON.stringify(a);
          A.post(h, function(a) {
            return h.baseUri(a) + e
          }, g, a, null, b)
        }
        "function" != typeof a || e ? "function" != typeof c || e || (e = c, c = null) : (e = a, c = a = null);
        if (!e && this.client.options.promises) return k.promisify(this, "requestToken", arguments);
        c = c || this.authOptions;
        a = a || k.copy(this.tokenParams);
        e = e || b;
        var h = this.client;
        if (c.authCallback) {
          d.logAction(d.LOG_MINOR, "Auth.requestToken()", "using token auth with authCallback");
          var l = c.authCallback
        } else if (c.authUrl) d.logAction(d.LOG_MINOR, "Auth.requestToken()", "using token auth with authUrl"), l = function(a, b) {
          function e(a, c, e, g) {
            if (a) d.logAction(d.LOG_MICRO, "Auth.requestToken().tokenRequestCallback", "Received Error: " + k.inspectError(a));
            else {
              var f = e["content-type"];
              d.logAction(d.LOG_MICRO, "Auth.requestToken().tokenRequestCallback", "Received; content-type: " + f + "; body: " + k.inspectBody(c))
            }
            if (a || g) return b(a, c);
            y.isBuffer(c) && (c = c.toString());
            if (f)
              if (a = -1 < f.indexOf("application/json"), e = -1 < f.indexOf("text/plain") || -1 < f.indexOf("application/jwt"), a || e) {
                if (a) {
                  if (c.length > n) {
                    b(new q("authUrl response exceeded max permitted length", 40170, 401));
                    return
                  }
                  try {
                    c = JSON.parse(c)
                  } catch (oa) {
                    b(new q("Unexpected error processing authURL response; err = " + oa.message, 40170, 401));
                    return
                  }
                }
                b(null, c, f)
              } else b(new q("authUrl responded with unacceptable content-type " + f + ", should be either text/plain, application/jwt or application/json", 40170, 401));
            else b(new q("authUrl response is missing a content-type header", 40170, 401))
          }
          var g = k.mixin({
              accept: "application/json, text/plain"
            }, c.authHeaders),
            f = c.authMethod && "post" === c.authMethod.toLowerCase();
          if (!f) {
            var l = c.authUrl.indexOf("?");
            if (-1 < l) {
              var p = k.parseQueryString(c.authUrl.slice(l));
              c.authUrl = c.authUrl.slice(0, l);
              c.authParams = k.mixin(p, c.authParams)
            }
          }
          l = k.mixin({}, c.authParams || {}, a);
          d.logAction(d.LOG_MICRO, "Auth.requestToken().tokenRequestCallback", "Requesting token from " + c.authUrl + "; Params: " + JSON.stringify(l) + "; method: " + (f ? "POST" : "GET"));
          f ? (g = g || {}, g["content-type"] = "application/x-www-form-urlencoded", f = k.toQueryString(l).slice(1), A.postUri(h, c.authUrl, g, f, {}, e)) : A.getUri(h, c.authUrl, g || {}, l, e)
        };
        else if (c.key) {
          var p = this;
          d.logAction(d.LOG_MINOR, "Auth.requestToken()", "using token auth with client-side signing");
          l = function(a, b) {
            p.createTokenRequest(a, c, b)
          }
        } else {
          d.logAction(d.LOG_ERROR, "Auth()", "library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help");
          e(new q("Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)", 40171, 403));
          return
        }
        "capability" in
        a && (a.capability = f(a.capability));
        var v = !1,
          t = this.client.options.timeouts.realtimeRequestTimeout,
          r = setTimeout(function() {
            v = !0;
            var a = "Token request callback timed out after " + t / 1E3 + " seconds";
            d.logAction(d.LOG_ERROR, "Auth.requestToken()", a);
            e(new q(a, 40170, 401))
          }, t);
        l(a, function(a, b, f) {
          v || (clearTimeout(r), a ? (d.logAction(d.LOG_ERROR, "Auth.requestToken()", "token request signing call returned error; err = " + k.inspectError(a)), e(m(a))) : "string" === typeof b ? 0 === b.length ? e(new q("Token string is empty", 40170, 401)) : b.length > n ? e(new q("Token string exceeded max permitted length (was " + b.length + " bytes)", 40170, 401)) : "undefined" === b || "null" === b ? e(new q("Token string was literal null/undefined", 40170, 401)) : "{" !== b[0] || f && -1 < f.indexOf("application/jwt") ? e(null, {
            token: b
          }) : e(new q("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details", 40170, 401)) : "object" !== typeof b ? (b = "Expected token request callback to call back with a token string or token request/details object, but got a " +
            typeof b, d.logAction(d.LOG_ERROR, "Auth.requestToken()", b), e(new q(b, 40170, 401))) : (a = JSON.stringify(b).length, a > n && !c.suppressMaxLengthCheck ? e(new q("Token request/details object exceeded max permitted stringified size (was " + a + " bytes)", 40170, 401)) : "issued" in b ? e(null, b) : "keyName" in b ? g(b, function(a, c, b, g) {
            a ? (d.logAction(d.LOG_ERROR, "Auth.requestToken()", "token request API call returned error; err = " + k.inspectError(a)), e(m(a))) : (g || (c = JSON.parse(c)), d.logAction(d.LOG_MINOR, "Auth.getToken()", "token received"), e(null, c))
          }) : (b = "Expected token request callback to call back with a token string, token request object, or token details object", d.logAction(d.LOG_ERROR, "Auth.requestToken()", b), e(new q(b, 40170, 401)))))
        })
      };
      c.prototype.createTokenRequest = function(a, c, b) {
        "function" != typeof a || b ? "function" != typeof c || b || (b = c, c = null) : (b = a, c = a = null);
        if (!b && this.client.options.promises) return k.promisify(this, "createTokenRequest", arguments);
        c = c || this.authOptions;
        a = a || k.copy(this.tokenParams);
        var e = c.key;
        if (e) {
          e = e.split(":");
          var g = e[0],
            h = e[1];
          if (h)
            if ("" === a.clientId) b(new q("clientId can\u2019t be an empty string", 40012, 400));
            else {
              "capability" in a && (a.capability = f(a.capability));
              var n = k.mixin({
                  keyName: g
                }, a),
                p = a.clientId || "",
                v = a.ttl || "",
                m = a.capability || "",
                t = this;
              (function(a) {
                n.timestamp ? a() : t.getTimestamp(c && c.queryTime, function(c, d) {
                  c ? b(c) : (n.timestamp = d, a())
                })
              })(function() {
                var a = n.nonce || (n.nonce = ("000000" + Math.floor(1E16 * Math.random())).slice(-16));
                a = n.keyName + "\n" + v + "\n" + m + "\n" + p + "\n" + n.timestamp + "\n" + a + "\n";
                n.mac = n.mac || l(a, h);
                d.logAction(d.LOG_MINOR, "Auth.getTokenRequest()", "generated signed request");
                b(null, n)
              })
            }
          else b(new q("Invalid key specified", 40101, 403))
        } else b(new q("No key specified", 40101, 403))
      };
      c.prototype.getAuthParams = function(a) {
        "basic" == this.method ? a(null, {
          key: this.key
        }) : this._ensureValidAuthCredentials(!1, function(c, b) {
          c ? a(c) : a(null, {
            access_token: b.token
          })
        })
      };
      c.prototype.getAuthHeaders = function(a) {
        "basic" == this.method ? a(null, {
          authorization: "Basic " + this.basicKey
        }) : this._ensureValidAuthCredentials(!1, function(c, b) {
          c ? a(c) : a(null, {
            authorization: "Bearer " + e(b.token)
          })
        })
      };
      c.prototype.getTimestamp = function(a, c) {
        this.isTimeOffsetSet() || !a && !this.authOptions.queryTime ? c(null, this.getTimestampUsingOffset()) : this.client.time(c)
      };
      c.prototype.getTimestampUsingOffset = function() {
        return k.now() + (this.client.serverTimeOffset || 0)
      };
      c.prototype.isTimeOffsetSet = function() {
        return null !== this.client.serverTimeOffset
      };
      c.prototype._saveBasicOptions = function(a) {
        this.method = "basic";
        this.key = a.key;
        this.basicKey = e(a.key);
        this.authOptions = a || {};
        "clientId" in a && this._userSetClientId(a.clientId)
      };
      c.prototype._saveTokenOptions = function(a, c) {
        this.method = "token";
        a && (this.tokenParams = a);
        c && (c.token && (c.tokenDetails = "string" === typeof c.token ? {
          token: c.token
        } : c.token), c.tokenDetails && (this.tokenDetails = c.tokenDetails), "clientId" in c && this._userSetClientId(c.clientId), this.authOptions = c)
      };
      c.prototype._ensureValidAuthCredentials = function(a, c) {
        var e = this,
          g = this.tokenDetails;
        if (g) {
          if (this._tokenClientIdMismatch(g.clientId)) {
            c(new q("Mismatch between clientId in token (" +
              g.clientId + ") and current clientId (" + this.clientId + ")", 40102, 403));
            return
          }
          if (!this.isTimeOffsetSet() || !g.expires || g.expires >= this.getTimestampUsingOffset()) {
            d.logAction(d.LOG_MINOR, "Auth.getToken()", "using cached token; expires = " + g.expires);
            c(null, g);
            return
          }
          d.logAction(d.LOG_MINOR, "Auth.getToken()", "deleting expired token");
          this.tokenDetails = null
        }(this.waitingForTokenRequest || (this.waitingForTokenRequest = ca())).push(c);
        if (null === this.currentTokenRequestId || a) {
          var f = this.currentTokenRequestId = p++;
          this.requestToken(this.tokenParams, this.authOptions, function(a, c) {
            if (e.currentTokenRequestId > f) d.logAction(d.LOG_MINOR, "Auth._ensureValidAuthCredentials()", "Discarding token request response; overtaken by newer one");
            else {
              e.currentTokenRequestId = null;
              var g = e.waitingForTokenRequest || b;
              e.waitingForTokenRequest = null;
              a ? g(a) : g(null, e.tokenDetails = c)
            }
          })
        }
      };
      c.prototype._userSetClientId = function(a) {
        if ("string" !== typeof a && null !== a) throw new q("clientId must be either a string or null", 40012, 400);
        if ("*" === a) throw new q('Can\u2019t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)', 40012, 400);
        if (a = this._uncheckedSetClientId(a)) throw a;
      };
      c.prototype._uncheckedSetClientId = function(a) {
        if (this._tokenClientIdMismatch(a)) {
          a = "Unexpected clientId mismatch: client has " + this.clientId + ", requested " + a;
          var c = new q(a, 40102, 401);
          d.logAction(d.LOG_ERROR, "Auth._uncheckedSetClientId()", a);
          return c
        }
        this.clientId = this.tokenParams.clientId = a;
        return null
      };
      c.prototype._tokenClientIdMismatch = function(a) {
        return this.clientId && "*" !== this.clientId && a && "*" !== a && this.clientId !== a
      };
      c.isTokenErr = function(a) {
        return a.code && 40140 <= a.code && 40150 > a.code
      };
      return c
    }(),
    E = function() {
      function b() {}

      function m(a) {
        if (!(this instanceof m)) return new m(a);
        if (!a) {
          var c = "no options provided";
          d.logAction(d.LOG_ERROR, "Rest()", c);
          throw Error(c);
        }
        a = t.objectifyOptions(a);
        a.log && d.setLog(a.log.level, a.log.handler);
        d.logAction(d.LOG_MICRO, "Rest()", "initialized with clientOptions " + k.inspect(a));
        this.options = t.normaliseOptions(a);
        if (a.key) {
          c = a.key.match(/^([^:\s]+):([^:.\s]+)$/);
          if (!c) throw c = "invalid key parameter", d.logAction(d.LOG_ERROR, "Rest()", c), Error(c);
          a.keyName = c[1];
          a.keySecret = c[2]
        }
        if ("clientId" in a) {
          if ("string" !== typeof a.clientId && null !== a.clientId) throw new q("clientId must be either a string or null", 40012, 400);
          if ("*" === a.clientId) throw new q('Can\u2019t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})', 40012, 400);
        }
        d.logAction(d.LOG_MINOR, "Rest()", "started; version = " + t.libstring);
        this.baseUri = this.authority = function(c) {
          return t.getHttpScheme(a) + c + ":" + t.getPort(a, !1)
        };
        this.serverTimeOffset = this._currentFallback = null;
        this.auth = new N(this, a);
        this.channels = new f(this);
        this.push = new ra(this)
      }

      function f(a) {
        this.rest = a;
        this.attached = {}
      }
      var a = r.msgpack;
      m.prototype.stats = function(a, d) {
        if (void 0 === d)
          if ("function" == typeof a) d = a, a = null;
          else {
            if (this.options.promises) return k.promisify(this, "stats", arguments);
            d = b
          } var c = k.defaultGetHeaders(),
          f = this.options.useBinaryProtocol ? "msgpack" : "json";
        f = A.supportsLinkHeaders ? void 0 : f;
        this.options.headers && k.mixin(c, this.options.headers);
        (new P(this, "/stats", c, f, function(a, c, b) {
          a = b ? a : JSON.parse(a);
          for (c = 0; c < a.length; c++) a[c] = qa.fromValues(a[c]);
          return a
        })).get(a, d)
      };
      m.prototype.time = function(a, d) {
        if (void 0 === d)
          if ("function" == typeof a) d = a, a = null;
          else {
            if (this.options.promises) return k.promisify(this, "time", arguments);
            d = b
          } var c = k.defaultGetHeaders();
        this.options.headers && k.mixin(c, this.options.headers);
        var f = this;
        A.get(this, function(a) {
          return f.authority(a) + "/time"
        }, c, a, function(a, c, b, e) {
          a ? d(a) : (e || (c = JSON.parse(c)), (a = c[0]) ? (f.serverTimeOffset = a - k.now(), d(null, a)) : (a = Error("Internal error (unexpected result type from GET /time)"), a.statusCode = 500, d(a)))
        })
      };
      m.prototype.request = function(c, d, e, f, p, g) {
        var l = this.options.useBinaryProtocol,
          h = l ? a.encode : JSON.stringify,
          n = l ? a.decode : JSON.parse,
          m = l ? "msgpack" : "json";
        l = A.supportsLinkHeaders ? void 0 : m;
        e = e || {};
        c = c.toLowerCase();
        m = "get" == c ? k.defaultGetHeaders(m) : k.defaultPostHeaders(m);
        if (void 0 === g) {
          if (this.options.promises) return k.promisify(this, "request", [c, d, e, f, p]);
          g = b
        }
        "string" !== typeof f && (f = h(f));
        this.options.headers && k.mixin(m, this.options.headers);
        p && k.mixin(m, p);
        d = new P(this, d, m, l, function(a, c, b) {
          return k.ensureArray(b ? a : n(a))
        }, !0);
        if (!k.arrIn(A.methods, c)) throw new q("Unsupported method " + c, 40500, 405);
        if (k.arrIn(A.methodsWithBody, c)) d[c](e, f, g);
        else d[c](e, g)
      };
      m.prototype.setLog = function(a) {
        d.setLog(a.level, a.handler)
      };
      f.prototype.get = function(a, b) {
        a = String(a);
        var c = this.attached[a];
        c ? b && c.setOptions(b) : this.attached[a] = c = new V(this.rest, a, b);
        return c
      };
      f.prototype.release = function(a) {
        delete this.attached[String(a)]
      };
      return m
    }();
  E.Promise = function(b) {
    b = t.objectifyOptions(b);
    b.promises = !0;
    return new E(b)
  };
  E.Callbacks = E;
  var F = function() {
    function b(f) {
      if (!(this instanceof b)) return new b(f);
      d.logAction(d.LOG_MINOR, "Realtime()", "");
      E.call(this, f);
      this.connection = new sa(this, this.options);
      this.channels = new m(this);
      !1 !== f.autoConnect && this.connect()
    }

    function m(b) {
      C.call(this);
      this.realtime = b;
      this.all = {};
      this.inProgress = {};
      var a = this;
      b.connection.connectionManager.on("transport.active", function() {
        a.onTransportActive()
      })
    }
    k.inherits(b, E);
    b.prototype.connect = function() {
      d.logAction(d.LOG_MINOR, "Realtime.connect()", "");
      this.connection.connect()
    };
    b.prototype.close = function() {
      d.logAction(d.LOG_MINOR, "Realtime.close()", "");
      this.connection.close()
    };
    k.inherits(m, C);
    m.prototype.onChannelMessage = function(b) {
      var a = b.channel;
      if (void 0 === a) d.logAction(d.LOG_ERROR, "Channels.onChannelMessage()", "received event unspecified channel, action = " + b.action);
      else {
        var c = this.all[a];
        if (c) c.onMessage(b);
        else d.logAction(d.LOG_ERROR, "Channels.onChannelMessage()", "received event for non-existent channel: " + a)
      }
    };
    m.prototype.onTransportActive = function() {
      for (var b in this.all) {
        var a = this.all[b];
        "attaching" === a.state || "detaching" === a.state ? a.checkPendingState() : "suspended" === a.state && a.attach()
      }
    };
    m.prototype.reattach = function(b) {
      for (var a in this.all) {
        var c = this.all[a];
        "attached" === c.state && c.requestState("attaching", b)
      }
    };
    m.prototype.resetAttachedMsgIndicators = function() {
      for (var b in this.all) {
        var a = this.all[b];
        "attached" === a.state && (a._attachedMsgIndicator = !1)
      }
    };
    m.prototype.checkAttachedMsgIndicators = function(b) {
      for (var a in this.all) {
        var c = this.all[a];
        if ("attached" === c.state && !1 === c._attachedMsgIndicator) {
          var f = "30s after a resume, found channel which has not received an attached; channelId = " + a + "; connectionId = " + b;
          d.logAction(d.LOG_ERROR, "Channels.checkAttachedMsgIndicators()", f);
          W.report("error", f, "channel-no-attached-after-resume");
          c.requestState("attaching")
        }
      }
    };
    m.prototype.propogateConnectionInterruption = function(b, a) {
      var c = ["attaching", "attached", "detaching", "suspended"],
        d = {
          closing: "detached",
          closed: "detached",
          failed: "failed",
          suspended: "suspended"
        } [b],
        e;
      for (e in this.all) {
        var f = this.all[e];
        k.arrIn(c, f.state) && f.notifyState(d, a)
      }
    };
    m.prototype.get = function(b, a) {
      b = String(b);
      var c = this.all[b];
      if (!c) c = this.all[b] = new T(this.realtime, b, a);
      else if (a) {
        if (c._shouldReattachToSetOptions(a)) throw new q("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.", 4E4, 400);
        c.setOptions(a)
      }
      return c
    };
    m.prototype.release = function(b) {
      this.all[b] && delete this.all[b]
    };
    m.prototype.setInProgress = function(b, a, c) {
      this.inProgress[b.name] = this.inProgress[b.name] || {};
      this.inProgress[b.name][a] = c;
      !c && this.hasNopending() && this.emit("nopending")
    };
    m.prototype.onceNopending = function(b) {
      if (this.hasNopending()) b();
      else this.once("nopending", b)
    };
    m.prototype.hasNopending = function() {
      return k.arrEvery(k.valuesArray(this.inProgress, !0), function(b) {
        return !k.containsValue(b, !0)
      })
    };
    return b
  }();
  F.Promise = function(b) {
    b = t.objectifyOptions(b);
    b.promises = !0;
    return new F(b)
  };
  F.Callbacks = F;
  var U = function() {
      return function(b, d, f, a) {
        this.previous = b;
        this.current = d;
        f && (this.retryIn = f);
        a && (this.reason = a)
      }
    }(),
    ea = function() {
      return function(b, d, f, a) {
        this.previous = b;
        this.current = d;
        "attached" === d && (this.resumed = f);
        a && (this.reason = a)
      }
    }(),
    sa = function() {
      function b() {}

      function m(b, a) {
        C.call(this);
        this.ably = b;
        this.connectionManager = new O(b, a);
        this.state = this.connectionManager.state.state;
        this.recoveryKey = this.timeSerial = this.serial = this.id = this.key = void 0;
        this.errorReason = null;
        var c = this;
        this.connectionManager.on("connectionstate", function(a) {
          var b = c.state = a.current;
          k.nextTick(function() {
            c.emit(b, a)
          })
        });
        this.connectionManager.on("update", function(a) {
          k.nextTick(function() {
            c.emit("update", a)
          })
        })
      }
      k.inherits(m, C);
      m.prototype.whenState = function(b, a) {
        return C.prototype.whenState.call(this, b, this.state, a, new U(void 0, b))
      };
      m.prototype.connect = function() {
        d.logAction(d.LOG_MINOR, "Connection.connect()", "");
        this.connectionManager.requestState({
          state: "connecting"
        })
      };
      m.prototype.ping = function(f) {
        d.logAction(d.LOG_MINOR, "Connection.ping()", "");
        if (!f) {
          if (this.ably.options.promises) return k.promisify(this, "ping", arguments);
          f = b
        }
        this.connectionManager.ping(null, f)
      };
      m.prototype.close = function() {
        d.logAction(d.LOG_MINOR, "Connection.close()", "connectionKey = " + this.key);
        this.connectionManager.requestState({
          state: "closing"
        })
      };
      return m
    }(),
    ra = function() {
      function b() {}

      function d(c) {
        this.rest = c;
        this.deviceRegistrations = new f(c);
        this.channelSubscriptions = new a(c)
      }

      function f(a) {
        this.rest = a
      }

      function a(a) {
        this.rest = a
      }
      d.prototype.publish = function(a, d, e) {
        var c = this.rest,
          f = c.options.useBinaryProtocol ? "msgpack" : "json",
          g = k.mixin({
            recipient: a
          }, d),
          n = k.defaultPostHeaders(f),
          h = {};
        if ("function" !== typeof e) {
          if (this.rest.options.promises) return k.promisify(this, "publish", arguments);
          e = b
        }
        c.options.headers && k.mixin(n, c.options.headers);
        c.options.pushFullWait && k.mixin(h, {
          fullWait: "true"
        });
        g = k.encodeBody(g, f);
        I.post(c, "/push/publish", g, n, h, !1, function(a) {
          e(a)
        })
      };
      f.prototype.save = function(a, d) {
        var c = this.rest,
          f = c.options.useBinaryProtocol ? "msgpack" : "json",
          n = X.fromValues(a),
          g = k.defaultPostHeaders(f),
          m = {};
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "save", arguments);
          d = b
        }
        c.options.headers && k.mixin(g, c.options.headers);
        c.options.pushFullWait && k.mixin(m, {
          fullWait: "true"
        });
        n = k.encodeBody(n, f);
        I.put(c, "/push/deviceRegistrations/" + encodeURIComponent(a.id), n, g, m, !1, function(a, c, b, e) {
          d(a, !a && X.fromResponseBody(c, !e && f))
        })
      };
      f.prototype.get = function(a, d) {
        var c = this.rest,
          f = c.options.useBinaryProtocol ? "msgpack" : "json",
          n = k.defaultGetHeaders(f),
          g = a.id || a;
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "get", arguments);
          d = b
        }
        "string" === typeof g && g.length ? (c.options.headers && k.mixin(n, c.options.headers), I.get(c, "/push/deviceRegistrations/" + encodeURIComponent(g), n, {}, !1, function(a, c, b, e) {
          d(a, !a && X.fromResponseBody(c, !e && f))
        })) : d(new q("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails", 4E4, 400))
      };
      f.prototype.list = function(a, d) {
        var c = this.rest,
          f = c.options.useBinaryProtocol ? "msgpack" : "json",
          n = A.supportsLinkHeaders ? void 0 : f,
          g = k.defaultGetHeaders(f);
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "list", arguments);
          d = b
        }
        c.options.headers && k.mixin(g, c.options.headers);
        (new P(c, "/push/deviceRegistrations", g, n, function(a, c, b) {
          return X.fromResponseBody(a, !b && f)
        })).get(a, d)
      };
      f.prototype.remove = function(a, d) {
        var c = this.rest,
          f = k.defaultGetHeaders(c.options.useBinaryProtocol ? "msgpack" : "json"),
          n = {},
          g = a.id || a;
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "remove", arguments);
          d = b
        }
        "string" === typeof g && g.length ? (c.options.headers && k.mixin(f, c.options.headers), c.options.pushFullWait && k.mixin(n, {
          fullWait: "true"
        }), I["delete"](c, "/push/deviceRegistrations/" + encodeURIComponent(g), f, n, !1, function(a) {
          d(a)
        })) : d(new q("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails", 4E4, 400))
      };
      f.prototype.removeWhere = function(a, d) {
        var c = this.rest,
          f = k.defaultGetHeaders(c.options.useBinaryProtocol ? "msgpack" : "json");
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "removeWhere", arguments);
          d = b
        }
        c.options.headers && k.mixin(f, c.options.headers);
        c.options.pushFullWait && k.mixin(a, {
          fullWait: "true"
        });
        I["delete"](c, "/push/deviceRegistrations", f, a, !1, function(a) {
          d(a)
        })
      };
      a.prototype.save = function(a, d) {
        var c = this.rest,
          f = c.options.useBinaryProtocol ? "msgpack" : "json",
          n = da.fromValues(a),
          g = k.defaultPostHeaders(f),
          m = {};
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "save", arguments);
          d = b
        }
        c.options.headers && k.mixin(g, c.options.headers);
        c.options.pushFullWait && k.mixin(m, {
          fullWait: "true"
        });
        n = k.encodeBody(n, f);
        I.post(c, "/push/channelSubscriptions", n, g, m, !1, function(a, c, b, e) {
          d(a, !a && da.fromResponseBody(c, !e && f))
        })
      };
      a.prototype.list = function(a, d) {
        var c = this.rest,
          f = c.options.useBinaryProtocol ? "msgpack" : "json",
          n = A.supportsLinkHeaders ? void 0 : f,
          g = k.defaultGetHeaders(f);
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "list", arguments);
          d = b
        }
        c.options.headers && k.mixin(g, c.options.headers);
        (new P(c, "/push/channelSubscriptions", g, n, function(a, c, b) {
          return da.fromResponseBody(a, !b && f)
        })).get(a, d)
      };
      a.prototype.removeWhere = function(a, d) {
        var c = this.rest,
          f = k.defaultGetHeaders(c.options.useBinaryProtocol ? "msgpack" : "json");
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "removeWhere", arguments);
          d = b
        }
        c.options.headers && k.mixin(f, c.options.headers);
        c.options.pushFullWait && k.mixin(a, {
          fullWait: "true"
        });
        I["delete"](c, "/push/channelSubscriptions", f, a, !1, function(a) {
          d(a)
        })
      };
      a.prototype.remove = a.prototype.removeWhere;
      a.prototype.listChannels = function(a, d) {
        var c = this.rest,
          f = c.options.useBinaryProtocol ? "msgpack" : "json",
          n = A.supportsLinkHeaders ? void 0 : f,
          g = k.defaultGetHeaders(f);
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "listChannels", arguments);
          d = b
        }
        c.options.headers && k.mixin(g, c.options.headers);
        c.options.pushFullWait && k.mixin(a, {
          fullWait: "true"
        });
        (new P(c, "/push/channels", g, n, function(a, c, b) {
          !b && f && (a = k.decodeBody(a, f));
          for (c = 0; c < a.length; c++) a[c] = String(a[c]);
          return a
        })).get(a, d)
      };
      return function(a) {
        this.rest = a;
        this.admin = new d(a)
      }
    }(),
    V = function() {
      function b() {}

      function m(a, c, b) {
        d.logAction(d.LOG_MINOR, "Channel()", "started; name = " + c);
        C.call(this);
        this.rest = a;
        this.name = c;
        this.basePath = "/channels/" + encodeURIComponent(c);
        this.presence = new Y(this);
        this.setOptions(b)
      }

      function f(a) {
        return k.arrEvery(a, function(a) {
          return !a.id
        })
      }
      k.inherits(m, C);
      m.prototype.setOptions = function(a) {
        this.channelOptions = a = a || {};
        if (a.cipher) {
          if (!S) throw Error("Encryption not enabled; use ably.encryption.js instead");
          var c = S.getCipher(a.cipher);
          a.cipher = c.cipherParams;
          a.channelCipher = c.cipher
        } else "cipher" in a && (a.cipher = null, a.channelCipher = null)
      };
      m.prototype.history = function(a, c) {
        d.logAction(d.LOG_MICRO, "Channel.history()", "channel = " + this.name);
        if (void 0 === c)
          if ("function" == typeof a) c = a, a = null;
          else {
            if (this.rest.options.promises) return k.promisify(this, "history", arguments);
            c = b
          } this._history(a, c)
      };
      m.prototype._history = function(a, c) {
        var b = this.rest,
          d = b.options.useBinaryProtocol ? "msgpack" : "json",
          f = A.supportsLinkHeaders ? void 0 : d,
          p = k.defaultGetHeaders(d);
        b.options.headers && k.mixin(p, b.options.headers);
        var g = this.channelOptions;
        (new P(b, this.basePath + "/messages", p, f, function(a, c, b) {
          return D.fromResponseBody(a, g, !b && d)
        })).get(a, c)
      };
      m.prototype.publish = function() {
        var a = arguments[0],
          c = arguments[1],
          d = arguments[arguments.length - 1],
          e = this;
        if ("function" !== typeof d) {
          if (this.rest.options.promises) return k.promisify(this, "publish", arguments);
          d = b
        }
        if ("string" === typeof a || null === a) {
          var l = [D.fromValues({
            name: a,
            data: c
          })];
          var p = arguments[2]
        } else if (k.isObject(a)) l = [D.fromValues(a)], p = arguments[1];
        else if (k.isArray(a)) l = D.fromValuesArray(a), p = arguments[1];
        else throw new q("The single-argument form of publish() expects a message object or an array of message objects", 40013, 400);
        "object" === typeof p && p || (p = {});
        a = this.rest;
        var g = a.options,
          m = g.useBinaryProtocol ? "msgpack" : "json";
        a = a.options.idempotentRestPublishing;
        var h = k.defaultPostHeaders(m);
        g.headers && k.mixin(h, g.headers);
        if (a && f(l)) {
          var u = k.randomString(9);
          k.arrForEach(l, function(a, c) {
            a.id = u + ":" + c.toString()
          })
        }
        D.encodeArray(l, this.channelOptions, function(a) {
          if (a) d(a);
          else {
            a = D.getMessagesSize(l);
            var c = g.maxMessageSize;
            a > c ? d(new q("Maximum size of messages that can be published at once exceeded ( was " + a + " bytes; limit is " + c + " bytes)", 40009, 400)) : e._publish(D.serialize(l, m), h, p, d)
          }
        })
      };
      m.prototype._publish = function(a, c, b, d) {
        I.post(this.rest, this.basePath + "/messages", a, c, b, !1, d)
      };
      return m
    }(),
    T = function() {
      function b() {}

      function m(a, b, e) {
        d.logAction(d.LOG_MINOR, "RealtimeChannel()", "started; name = " + b);
        V.call(this, a, b, e);
        this.realtime = a;
        this.presence = new ta(this, a.options);
        this.connectionManager = a.connection.connectionManager;
        this.state = "initialized";
        this.subscriptions = new C;
        this.syncChannelSerial = void 0;
        this.properties = {
          attachSerial: void 0
        };
        this.setOptions(e);
        this._mode = this._requestedFlags = this.errorReason = null;
        this._attachResume = this._attachedMsgIndicator = !1;
        this._decodingContext = {
          channelOptions: this.channelOptions,
          plugins: a.options.plugins || {},
          baseEncodedPreviousPayload: void 0
        };
        this._lastPayload = {
          messageId: null,
          protocolMessageChannelSerial: null,
          decodeFailureRecoveryInProgress: null
        };
        this._allChannelChanges = new C
      }

      function f(a) {
        if (a && "params" in a && !k.isObject(a.params)) return new q("options.params must be an object", 4E4, 400);
        if (a && "modes" in a) {
          if (!k.isArray(a.modes)) return new q("options.modes must be an array", 4E4, 400);
          for (var c = 0; c < a.modes.length; c++) {
            var b = a.modes[c];
            if (!b || "string" !== typeof b || !k.arrIn(B.channelModes, String.prototype.toUpperCase.call(b))) return new q("Invalid channel mode: " + b, 4E4, 400)
          }
        }
      }
      var a = B.Action;
      k.inherits(m, V);
      m.invalidStateError = function(a) {
        return {
          statusCode: 400,
          code: 90001,
          message: "Channel operation failed as channel state is " + a
        }
      };
      m.progressOps = {
        statechange: "statechange",
        sync: "sync"
      };
      m.processListenerArgs = function(a) {
        a = Array.prototype.slice.call(a);
        "function" === typeof a[0] && a.unshift(null);
        void 0 == a[a.length - 1] && a.pop();
        return a
      };
      m.prototype.setOptions = function(a, b) {
        if (!b) {
          if (this.rest.options.promises) return k.promisify(this, "setOptions", arguments);
          b = function(a) {
            a && d.logAction(d.LOG_ERROR, "RealtimeChannel.setOptions()", "Set options failed: " + a.toString())
          }
        }
        var c = f(a);
        c ? b(c) : (V.prototype.setOptions.call(this, a), this._decodingContext && (this._decodingContext.channelOptions = this.channelOptions), this._shouldReattachToSetOptions(a) ? (this.attachImpl(), this._allChannelChanges.once(function(a) {
          switch (this.event) {
            case "update":
            case "attached":
              b(null);
              break;
            default:
              b(a.reason)
          }
        })) : b())
      };
      m.prototype._shouldReattachToSetOptions = function(a) {
        return ("attached" === this.state || "attaching" === this.state) && (a.params || a.modes)
      };
      m.prototype.publish = function() {
        var a = arguments.length,
          d = arguments[0],
          e = arguments[a - 1];
        if ("function" !== typeof e) {
          if (this.realtime.options.promises) return k.promisify(this, "publish", arguments);
          e = b;
          ++a
        }
        if (this.connectionManager.activeState()) {
          if (2 == a)
            if (k.isObject(d)) d = [D.fromValues(d)];
            else if (k.isArray(d)) d = D.fromValuesArray(d);
          else throw new q("The single-argument form of publish() expects a message object or an array of message objects", 40013, 400);
          else d = [D.fromValues({
            name: arguments[0],
            data: arguments[1]
          })];
          var f = this,
            p = this.realtime.options.maxMessageSize;
          D.encodeArray(d, this.channelOptions, function(a) {
            a ? e(a) : (a = D.getMessagesSize(d), a > p ? e(new q("Maximum size of messages that can be published at once exceeded ( was " + a + " bytes; limit is " + p + " bytes)", 40009, 400)) : f._publish(d, e))
          })
        } else e(this.connectionManager.getError())
      };
      m.prototype._publish = function(c, b) {
        d.logAction(d.LOG_MICRO, "RealtimeChannel.publish()", "message count = " + c.length);
        var e = this.state;
        switch (e) {
          case "failed":
          case "suspended":
            b(q.fromValues(m.invalidStateError(e)));
            break;
          default:
            d.logAction(d.LOG_MICRO, "RealtimeChannel.publish()", "sending message; channel state is " + e), e = new B, e.action = a.MESSAGE, e.channel = this.name, e.messages = c, this.sendMessage(e, b)
        }
      };
      m.prototype.onEvent = function(a) {
        d.logAction(d.LOG_MICRO, "RealtimeChannel.onEvent()", "received message");
        for (var c = this.subscriptions, b = 0; b < a.length; b++) {
          var f = a[b];
          c.emit(f.name, f)
        }
      };
      m.prototype.attach = function(a, b) {
        "function" === typeof a && (b = a, a = null);
        if (!b) {
          if (this.realtime.options.promises) return k.promisify(this, "attach", arguments);
          b = function(a) {
            a && d.logAction(d.LOG_MAJOR, "RealtimeChannel.attach()", "Channel attach failed: " + a.toString())
          }
        }
        if (a) d.deprecated("channel.attach() with flags", "channel.setOptions() with channelOptions.params"), this._requestedFlags = a;
        else if ("attached" === this.state) {
          b();
          return
        }
        this._attach(!1, null, b)
      };
      m.prototype._attach = function(a, b, e) {
        e || (e = function(a) {
          a && d.logAction(d.LOG_ERROR, "RealtimeChannel._attach()", "Channel attach failed: " + a.toString())
        });
        var c = this.connectionManager;
        c.activeState() ? (("attaching" !== this.state || a) && this.requestState("attaching", b), this.once(function(a) {
          switch (this.event) {
            case "attached":
              e();
              break;
            case "detached":
            case "suspended":
            case "failed":
              e(a.reason || c.getError());
              break;
            case "detaching":
              e(new q("Attach request superseded by a subsequent detach request", 9E4, 409))
          }
        })) : e(c.getError())
      };
      m.prototype.attachImpl = function() {
        d.logAction(d.LOG_MICRO, "RealtimeChannel.attachImpl()", "sending ATTACH message");
        this.setInProgress("statechange", !0);
        var c = B.fromValues({
          action: a.ATTACH,
          channel: this.name,
          params: this.channelOptions.params
        });
        this._requestedFlags ? c.encodeModesToFlags(this._requestedFlags) : this.channelOptions.modes && c.encodeModesToFlags(k.allToUpperCase(this.channelOptions.modes));
        this._attachResume && c.setFlag("ATTACH_RESUME");
        this._lastPayload.decodeFailureRecoveryInProgress && (c.channelSerial = this._lastPayload.protocolMessageChannelSerial);
        this.sendMessage(c, b)
      };
      m.prototype.detach = function(a) {
        if (!a) {
          if (this.realtime.options.promises) return k.promisify(this, "detach", arguments);
          a = b
        }
        var c = this.connectionManager;
        if (c.activeState()) switch (this.state) {
          case "detached":
          case "failed":
            a();
            break;
          default:
            this.requestState("detaching");
          case "detaching":
            this.once(function(b) {
              switch (this.event) {
                case "detached":
                  a();
                  break;
                case "attached":
                case "suspended":
                case "failed":
                  a(b.reason || c.getError());
                  break;
                case "attaching":
                  a(new q("Detach request superseded by a subsequent attach request", 9E4, 409))
              }
            })
        } else a(c.getError())
      };
      m.prototype.detachImpl = function(c) {
        d.logAction(d.LOG_MICRO, "RealtimeChannel.detach()", "sending DETACH message");
        this.setInProgress("statechange", !0);
        var f = B.fromValues({
          action: a.DETACH,
          channel: this.name
        });
        this.sendMessage(f, c || b)
      };
      m.prototype.subscribe = function() {
        var a = m.processListenerArgs(arguments),
          d = a[0],
          e = a[1];
        a = a[2];
        if (!a) {
          if (this.realtime.options.promises) return k.promisify(this, "subscribe", [d, e]);
          a = b
        }
        if ("failed" === this.state) a(q.fromValues(m.invalidStateError("failed")));
        else return this.subscriptions.on(d, e), this.attach(a)
      };
      m.prototype.unsubscribe = function() {
        var a = m.processListenerArgs(arguments);
        this.subscriptions.off(a[0], a[1])
      };
      m.prototype.sync = function() {
        switch (this.state) {
          case "initialized":
          case "detaching":
          case "detached":
            throw new q("Unable to sync to channel; not attached", 4E4);
        }
        var b = this.connectionManager;
        if (!b.activeState()) throw b.getError();
        var d = B.fromValues({
          action: a.SYNC,
          channel: this.name
        });
        this.syncChannelSerial && (d.channelSerial = this.syncChannelSerial);
        b.send(d)
      };
      m.prototype.sendMessage = function(a, b) {
        this.connectionManager.send(a, this.realtime.options.queueMessages, b)
      };
      m.prototype.sendPresence = function(b, d) {
        var c = B.fromValues({
          action: a.PRESENCE,
          channel: this.name,
          presence: k.isArray(b) ? G.fromValuesArray(b) : [G.fromValues(b)]
        });
        this.sendMessage(c, d)
      };
      m.prototype.onMessage = function(b) {
        var c = !1;
        switch (b.action) {
          case a.ATTACHED:
            this._attachedMsgIndicator = !0;
            this.properties.attachSerial = b.channelSerial;
            this._mode = b.getMode();
            this.params = b.params || {};
            var e = b.decodeModesFromFlags();
            this.modes = e && k.allToLowerCase(e) || void 0;
            e = b.hasFlag("RESUMED");
            var f = b.hasFlag("HAS_PRESENCE");
            if ("attached" === this.state) {
              this.setInProgress("statechange", !1);
              if (!e) this.presence.onAttached(f);
              b = new ea(this.state, this.state, e, b.error);
              this._allChannelChanges.emit("update", b);
              e && !this.channelOptions.updateOnAttached || this.emit("update", b)
            } else this.notifyState("attached", b.error, e, f);
            break;
          case a.DETACHED:
            b = b.error ? q.fromValues(b.error) : new q("Channel detached", 90001, 404);
            "detaching" === this.state ? this.notifyState("detached", b) : "attaching" === this.state ? this.notifyState("suspended", b) : this.requestState("attaching", b);
            break;
          case a.SYNC:
            c = !0;
            var p = this.syncChannelSerial = b.channelSerial;
            if (!b.presence) break;
          case a.PRESENCE:
            var g = b.presence;
            e = b.id;
            f = b.connectionId;
            var m = b.timestamp;
            b = this.channelOptions;
            for (var h = 0; h < g.length; h++) {
              try {
                var u = g[h];
                G.decode(u, b)
              } catch (w) {
                d.logAction(d.LOG_ERROR, "RealtimeChannel.onMessage()", w.toString())
              }
              u.connectionId || (u.connectionId = f);
              u.timestamp || (u.timestamp = m);
              u.id || (u.id = e + ":" + h)
            }
            this.presence.setPresence(g, c, p);
            break;
          case a.MESSAGE:
            if ("attached" !== this.state) {
              d.logAction(d.LOG_MAJOR, "RealtimeChannel.onMessage()", 'Message "' + b.id + '" skipped as this channel "' + this.name + '" state is not "attached" (state is "' + this.state + '").');
              break
            }
            p = b.messages;
            h = p[0];
            c = p[p.length - 1];
            e = b.id;
            f = b.connectionId;
            m = b.timestamp;
            if (h.extras && h.extras.delta && h.extras.delta.from !== this._lastPayload.messageId) {
              g = 'Delta message decode failure - previous message not available for message "' + b.id + '" on this channel "' + this.name + '".';
              d.logAction(d.LOG_ERROR, "RealtimeChannel.onMessage()", g);
              this._startDecodeFailureRecovery(new q(g, 40018, 400));
              break
            }
            for (h = 0; h < p.length; h++) {
              g = p[h];
              try {
                D.decode(g, this._decodingContext)
              } catch (w) {
                switch (d.logAction(d.LOG_ERROR, "RealtimeChannel.onMessage()", w.toString()), w.code) {
                  case 40018:
                    this._startDecodeFailureRecovery(w);
                    return;
                  case 40019:
                  case 40021:
                    this.notifyState("failed", w);
                    return
                }
              }
              g.connectionId || (g.connectionId = f);
              g.timestamp || (g.timestamp = m);
              g.id || (g.id = e + ":" + h)
            }
            this._lastPayload.messageId = c.id;
            this._lastPayload.protocolMessageChannelSerial = b.channelSerial;
            this.onEvent(p);
            break;
          case a.ERROR:
            (b = b.error) && 80016 == b.code ? this.checkPendingState() : this.notifyState("failed", q.fromValues(b));
            break;
          default:
            d.logAction(d.LOG_ERROR, "RealtimeChannel.onMessage()", "Fatal protocol error: unrecognised action (" + b.action + ")"), this.connectionManager.abort(K.unknownChannelErr)
        }
      };
      m.prototype._startDecodeFailureRecovery = function(a) {
        var b = this;
        this._lastPayload.decodeFailureRecoveryInProgress || (d.logAction(d.LOG_MAJOR, "RealtimeChannel.onMessage()", "Starting decode failure recovery process."), this._lastPayload.decodeFailureRecoveryInProgress = !0, this._attach(!0, a, function() {
          b._lastPayload.decodeFailureRecoveryInProgress = !1
        }))
      };
      m.prototype.onAttached = function() {
        d.logAction(d.LOG_MINOR, "RealtimeChannel.onAttached", "activating channel; name = " + this.name)
      };
      m.prototype.notifyState = function(a, b, e, f) {
        d.logAction(d.LOG_MICRO, "RealtimeChannel.notifyState", "name = " + this.name + ", current state = " + this.state + ", notifying state " + a);
        this.clearStateTimer();
        if (a !== this.state) {
          this.presence.actOnChannelState(a, f, b);
          "suspended" === a && this.connectionManager.state.sendEvents ? this.startRetryTimer() : this.cancelRetryTimer();
          b && (this.errorReason = b);
          e = new ea(this.state, a, e, b);
          d.logAction("failed" === a ? d.LOG_ERROR : d.LOG_MAJOR, 'Channel state for channel "' + this.name + '"', a + (b ? "; reason: " + b : ""));
          if ("attached" === a) this.onAttached(), this.setInProgress("sync", f), this.setInProgress("statechange", !1);
          else if ("detached" === a || "failed" === a || "suspended" === a) this.setInProgress("statechange", !1), this.setInProgress("sync", !1);
          if ("attached" === a) this._attachResume = !0;
          else if ("detaching" === a || "failed" === a) this._attachResume = !1;
          this.state = a;
          this._allChannelChanges.emit(a, e);
          this.emit(a, e)
        }
      };
      m.prototype.requestState = function(a, b) {
        d.logAction(d.LOG_MINOR, "RealtimeChannel.requestState", "name = " + this.name + ", state = " + a);
        this.notifyState(a, b);
        this.checkPendingState()
      };
      m.prototype.checkPendingState = function() {
        var a = this.connectionManager.state;
        if (a.sendEvents || a.forceQueueEvents) switch (d.logAction(d.LOG_MINOR, "RealtimeChannel.checkPendingState", "name = " + this.name + ", state = " + this.state), this.state) {
          case "attaching":
            this.startStateTimerIfNotRunning();
            this.attachImpl();
            break;
          case "detaching":
            this.startStateTimerIfNotRunning();
            this.detachImpl();
            break;
          case "attached":
            this.sync()
        } else d.logAction(d.LOG_MINOR, "RealtimeChannel.checkPendingState", "sendEvents is false; state is " + this.connectionManager.state.state)
      };
      m.prototype.timeoutPendingState = function() {
        switch (this.state) {
          case "attaching":
            var a = new q("Channel attach timed out", 90007, 408);
            this.notifyState("suspended", a);
            break;
          case "detaching":
            a = new q("Channel detach timed out", 90007, 408);
            this.notifyState("attached", a);
            break;
          default:
            this.checkPendingState()
        }
      };
      m.prototype.startStateTimerIfNotRunning = function() {
        var a = this;
        this.stateTimer || (this.stateTimer = setTimeout(function() {
          d.logAction(d.LOG_MINOR, "RealtimeChannel.startStateTimerIfNotRunning", "timer expired");
          a.stateTimer = null;
          a.timeoutPendingState()
        }, this.realtime.options.timeouts.realtimeRequestTimeout))
      };
      m.prototype.clearStateTimer = function() {
        var a = this.stateTimer;
        a && (clearTimeout(a), this.stateTimer = null)
      };
      m.prototype.startRetryTimer = function() {
        var a = this;
        this.retryTimer || (this.retryTimer = setTimeout(function() {
          "suspended" === a.state && a.connectionManager.state.sendEvents && (a.retryTimer = null, d.logAction(d.LOG_MINOR, "RealtimeChannel retry timer expired", "attempting a new attach"), a.requestState("attaching"))
        }, this.realtime.options.timeouts.channelRetryTimeout))
      };
      m.prototype.cancelRetryTimer = function() {
        this.retryTimer && (clearTimeout(this.retryTimer), this.suspendTimer = null)
      };
      m.prototype.setInProgress = function(a, b) {
        this.rest.channels.setInProgress(this, a, b)
      };
      m.prototype.history = function(a, f) {
        d.logAction(d.LOG_MICRO, "RealtimeChannel.history()", "channel = " + this.name);
        if (void 0 === f)
          if ("function" == typeof a) f = a, a = null;
          else {
            if (this.rest.options.promises) return k.promisify(this, "history", arguments);
            f = b
          } if (a && a.untilAttach) {
          if ("attached" !== this.state) {
            f(new q("option untilAttach requires the channel to be attached", 4E4, 400));
            return
          }
          if (!this.properties.attachSerial) {
            f(new q("untilAttach was specified and channel is attached, but attachSerial is not defined", 4E4, 400));
            return
          }
          delete a.untilAttach;
          a.from_serial = this.properties.attachSerial
        }
        V.prototype._history.call(this, a, f)
      };
      m.prototype.whenState = function(a, b) {
        return C.prototype.whenState.call(this, a, this.state, b)
      };
      return m
    }(),
    ta = function() {
      function b() {}

      function m(a) {
        a = a.channel.realtime;
        var b = a.auth.clientId;
        return (!b || "*" === b) && "connected" === a.connection.state
      }

      function f(a, b, c) {
        switch (a.state) {
          case "attached":
          case "suspended":
            c();
            break;
          case "initialized":
          case "detached":
          case "detaching":
          case "attaching":
            a.attach(function(a) {
              a ? b(a) : c()
            });
            break;
          default:
            b(q.fromValues(T.invalidStateError(a.state)))
        }
      }

      function a(a) {
        Y.call(this, a);
        this.syncComplete = !1;
        this.members = new c(this);
        this._myMembers = new c(this);
        this.subscriptions = new C;
        this.pendingPresence = []
      }

      function c(a) {
        C.call(this);
        this.presence = a;
        this.map = {};
        this.syncInProgress = !1;
        this.residualMembers = null
      }

      function n(a, b) {
        if (a.isSynthesized() || b.isSynthesized()) return a.timestamp > b.timestamp;
        var c = a.parseId(),
          d = b.parseId();
        return c.msgSerial === d.msgSerial ? c.index > d.index : c.msgSerial > d.msgSerial
      }
      k.inherits(a, Y);
      a.prototype.enter = function(a, b) {
        if (m(this)) throw new q("clientId must be specified to enter a presence channel", 40012, 400);
        return this._enterOrUpdateClient(void 0, a, "enter", b)
      };
      a.prototype.update = function(a, b) {
        if (m(this)) throw new q("clientId must be specified to update presence data", 40012, 400);
        return this._enterOrUpdateClient(void 0, a, "update", b)
      };
      a.prototype.enterClient = function(a, b, c) {
        return this._enterOrUpdateClient(a, b, "enter", c)
      };
      a.prototype.updateClient = function(a, b, c) {
        return this._enterOrUpdateClient(a, b, "update", c)
      };
      a.prototype._enterOrUpdateClient = function(a, c, f, g) {
        if (!g)
          if ("function" === typeof c) g = c, c = null;
          else {
            if (this.channel.realtime.options.promises) return k.promisify(this, "_enterOrUpdateClient", [a, c, f]);
            g = b
          } var e = this.channel;
        if (e.connectionManager.activeState()) {
          d.logAction(d.LOG_MICRO, "RealtimePresence." + f + "Client()", "channel = " + e.name + ", client = " + (a || "(implicit) " + this.channel.realtime.auth.clientId));
          var h = G.fromValues({
            action: f,
            data: c
          });
          a && (h.clientId = a);
          var l = this;
          G.encode(h, e.channelOptions, function(a) {
            if (a) g(a);
            else switch (e.state) {
              case "attached":
                e.sendPresence(h, g);
                break;
              case "initialized":
              case "detached":
                e.attach();
              case "attaching":
                l.pendingPresence.push({
                  presence: h,
                  callback: g
                });
                break;
              default:
                a = new q("Unable to " + f + " presence channel while in " + e.state + " state", 90001), a.code = 90001, g(a)
            }
          })
        } else g(e.connectionManager.getError())
      };
      a.prototype.leave = function(a, b) {
        if (m(this)) throw new q("clientId must have been specified to enter or leave a presence channel", 40012, 400);
        return this.leaveClient(void 0, a, b)
      };
      a.prototype.leaveClient = function(a, c, f) {
        if (!f)
          if ("function" === typeof c) f = c, c = null;
          else {
            if (this.channel.realtime.options.promises) return k.promisify(this, "leaveClient", [a, c]);
            f = b
          } var e = this.channel;
        if (e.connectionManager.activeState()) switch (d.logAction(d.LOG_MICRO, "RealtimePresence.leaveClient()", "leaving; channel = " + this.channel.name + ", client = " + a), c = G.fromValues({
          action: "leave",
          data: c
        }), a && (c.clientId = a), e.state) {
          case "attached":
            e.sendPresence(c, f);
            break;
          case "attaching":
            this.pendingPresence.push({
              presence: c,
              callback: f
            });
            break;
          case "initialized":
          case "failed":
            a = new q("Unable to leave presence channel (incompatible state)", 90001);
            f(a);
            break;
          default:
            f(K.failed)
        } else f(e.connectionManager.getError())
      };
      a.prototype.get = function() {
        function a(a) {
          g(null, d ? a.list(d) : a.values())
        }
        var c = Array.prototype.slice.call(arguments);
        1 == c.length && "function" == typeof c[0] && c.unshift(null);
        var d = c[0],
          g = c[1],
          m = !d || ("waitForSync" in d ? d.waitForSync : !0);
        if (!g) {
          if (this.channel.realtime.options.promises) return k.promisify(this, "get", c);
          g = b
        }
        if ("suspended" === this.channel.state) m ? g(q.fromValues({
          statusCode: 400,
          code: 91005,
          message: "Presence state is out of sync due to channel being in the SUSPENDED state"
        })) : a(this.members);
        else {
          var h = this;
          f(this.channel, g, function() {
            var b = h.members;
            m ? b.waitSync(function() {
              a(b)
            }) : a(b)
          })
        }
      };
      a.prototype.history = function(a, c) {
        d.logAction(d.LOG_MICRO, "RealtimePresence.history()", "channel = " + this.name);
        if (void 0 === c)
          if ("function" == typeof a) c = a, a = null;
          else {
            if (this.channel.realtime.options.promises) return k.promisify(this, "history", arguments);
            c = b
          } a && a.untilAttach && ("attached" === this.channel.state ? (delete a.untilAttach, a.from_serial = this.channel.properties.attachSerial) : c(new q("option untilAttach requires the channel to be attached, was: " + this.channel.state, 4E4, 400)));
        Y.prototype._history.call(this, a, c)
      };
      a.prototype.setPresence = function(a, b, c) {
        d.logAction(d.LOG_MICRO, "RealtimePresence.setPresence()", "received presence for " + a.length + " participants; syncChannelSerial = " + c);
        var e, f, h = this.members,
          k = this._myMembers,
          l = [],
          m = this.channel.connectionManager.connectionId;
        b && (this.members.startSync(), c && (f = c.match(/^[\w\-]+:(.*)$/)) && (e = f[1]));
        for (c = 0; c < a.length; c++) switch (f = G.fromValues(a[c]), f.action) {
          case "leave":
            h.remove(f) && l.push(f);
            f.connectionId !== m || f.isSynthesized() || k.remove(f);
            break;
          case "enter":
          case "present":
          case "update":
            h.put(f) && l.push(f), f.connectionId === m && k.put(f)
        }
        b && !e && (h.endSync(), this._ensureMyMembersPresent(), this.channel.setInProgress(T.progressOps.sync, !1), this.channel.syncChannelSerial = null);
        for (c = 0; c < l.length; c++) f = l[c], this.subscriptions.emit(f.action, f)
      };
      a.prototype.onAttached = function(a) {
        d.logAction(d.LOG_MINOR, "RealtimePresence.onAttached()", "channel = " + this.channel.name + ", hasPresence = " + a);
        a ? this.members.startSync() : (this._synthesizeLeaves(this.members.values()), this.members.clear(), this._ensureMyMembersPresent());
        a = this.pendingPresence;
        var b = a.length;
        if (b) {
          this.pendingPresence = [];
          var c = [],
            e = ca();
          d.logAction(d.LOG_MICRO, "RealtimePresence.onAttached", "sending " + b + " queued presence messages");
          for (var f = 0; f < b; f++) {
            var h = a[f];
            c.push(h.presence);
            e.push(h.callback)
          }
          this.channel.sendPresence(c, e)
        }
      };
      a.prototype.actOnChannelState = function(a, b, c) {
        switch (a) {
          case "attached":
            this.onAttached(b);
            break;
          case "detached":
          case "failed":
            this._clearMyMembers(), this.members.clear();
          case "suspended":
            this.failPendingPresence(c)
        }
      };
      a.prototype.failPendingPresence = function(a) {
        if (this.pendingPresence.length) {
          d.logAction(d.LOG_MINOR, "RealtimeChannel.failPendingPresence", "channel; name = " + this.channel.name + ", err = " +
            k.inspectError(a));
          for (var b = 0; b < this.pendingPresence.length; b++) try {
            this.pendingPresence[b].callback(a)
          } catch (p) {}
          this.pendingPresence = []
        }
      };
      a.prototype._clearMyMembers = function() {
        this._myMembers.clear()
      };
      a.prototype._ensureMyMembersPresent = function() {
        function a(a) {
          if (a) {
            a = "Presence auto-re-enter failed: " + a.toString();
            var c = new q(a, 91004, 400);
            d.logAction(d.LOG_ERROR, "RealtimePresence._ensureMyMembersPresent()", a);
            a = new ea(b.channel.state, b.channel.state, !0, c);
            b.channel.emit("update", a)
          }
        }
        var b = this,
          c = this.members,
          f = this._myMembers,
          k;
        for (k in f.map)
          if (!(k in c.map)) {
            var h = f.map[k];
            d.logAction(d.LOG_MICRO, "RealtimePresence._ensureMyMembersPresent()", 'Auto-reentering clientId "' + h.clientId + '" into the presence set');
            this._enterOrUpdateClient(h.clientId, h.data, "enter", a);
            delete f.map[k]
          }
      };
      a.prototype._synthesizeLeaves = function(a) {
        var b = this.subscriptions;
        k.arrForEach(a, function(a) {
          a = G.fromValues({
            action: "leave",
            connectionId: a.connectionId,
            clientId: a.clientId,
            data: a.data,
            encoding: a.encoding,
            timestamp: k.now()
          });
          b.emit("leave", a)
        })
      };
      a.prototype.on = function() {
        d.deprecated("presence.on", "presence.subscribe");
        this.subscribe.apply(this, arguments)
      };
      a.prototype.off = function() {
        d.deprecated("presence.off", "presence.unsubscribe");
        this.unsubscribe.apply(this, arguments)
      };
      a.prototype.subscribe = function() {
        var a = T.processListenerArgs(arguments),
          c = a[0],
          d = a[1];
        a = a[2];
        var f = this.channel;
        if (!a) {
          if (this.channel.realtime.options.promises) return k.promisify(this, "subscribe", [c, d]);
          a = b
        }
        "failed" === f.state ? a(q.fromValues(T.invalidStateError("failed"))) : (this.subscriptions.on(c, d), f.attach(a))
      };
      a.prototype.unsubscribe = function() {
        var a = T.processListenerArgs(arguments);
        this.subscriptions.off(a[0], a[1])
      };
      k.inherits(c, C);
      c.prototype.get = function(a) {
        return this.map[a]
      };
      c.prototype.getClient = function(a) {
        var b = this.map,
          c = [],
          d;
        for (d in b) {
          var e = b[d];
          e.clientId == a && "absent" != e.action && c.push(e)
        }
        return c
      };
      c.prototype.list = function(a) {
        var b = this.map,
          c = a && a.clientId;
        a = a && a.connectionId;
        var d = [],
          e;
        for (e in b) {
          var f = b[e];
          "absent" !== f.action && (c && c != f.clientId || a && a != f.connectionId || d.push(f))
        }
        return d
      };
      c.prototype.put = function(a) {
        if ("enter" === a.action || "update" === a.action) a = G.fromValues(a), a.action = "present";
        var b = this.map,
          c = a.clientId + ":" + a.connectionId;
        this.residualMembers && delete this.residualMembers[c];
        var d = b[c];
        if (d && !n(a, d)) return !1;
        b[c] = a;
        return !0
      };
      c.prototype.values = function() {
        var a = this.map,
          b = [],
          c;
        for (c in a) {
          var d = a[c];
          "absent" != d.action && b.push(d)
        }
        return b
      };
      c.prototype.remove = function(a) {
        var b = this.map,
          c = a.clientId + ":" + a.connectionId,
          d = b[c];
        if (d && !n(a, d)) return !1;
        this.syncInProgress ? (a = G.fromValues(a), a.action = "absent", b[c] = a) : delete b[c];
        return !0
      };
      c.prototype.startSync = function() {
        var a = this.map;
        d.logAction(d.LOG_MINOR, "PresenceMap.startSync()", "channel = " + this.presence.channel.name + "; syncInProgress = " + this.syncInProgress);
        this.syncInProgress || (this.residualMembers = k.copy(a), this.setInProgress(!0))
      };
      c.prototype.endSync = function() {
        var a = this.map,
          b = this.syncInProgress;
        d.logAction(d.LOG_MINOR, "PresenceMap.endSync()", "channel = " + this.presence.channel.name + "; syncInProgress = " + b);
        if (b) {
          for (var c in a) "absent" === a[c].action && delete a[c];
          this.presence._synthesizeLeaves(k.valuesArray(this.residualMembers));
          for (c in this.residualMembers) delete a[c];
          this.residualMembers = null;
          this.setInProgress(!1)
        }
        this.emit("sync")
      };
      c.prototype.waitSync = function(a) {
        var b = this.syncInProgress;
        d.logAction(d.LOG_MINOR, "PresenceMap.waitSync()", "channel = " + this.presence.channel.name + "; syncInProgress = " + b);
        if (b) this.once("sync", a);
        else a()
      };
      c.prototype.clear = function() {
        this.map = {};
        this.setInProgress(!1);
        this.residualMembers = null
      };
      c.prototype.setInProgress = function(a) {
        d.logAction(d.LOG_MICRO, "PresenceMap.setInProgress()", "inProgress = " + a);
        this.syncInProgress = a;
        this.presence.syncComplete = !a
      };
      return a
    }(),
    la = function() {
      function b() {}

      function m() {
        for (var a in c) c[a].dispose()
      }

      function f(b, d, e, f, h, m, q) {
        C.call(this);
        e = e || {};
        e.rnd = k.cheapRandStr();
        var g, l;
        if (l = n) l = g = (g = navigator.userAgent.toString().match(/MSIE\s([\d.]+)/)) && Number(g[1]);
        l && 10 === g && !e.envelope && (e.envelope = "json");
        this.uri = b + k.toQueryString(e);
        this.headers = d || {};
        this.body = f;
        this.method = q ? q.toUpperCase() : k.isEmptyArg(f) ? "GET" : "POST";
        this.requestMode = h;
        this.timeouts = m;
        this.requestComplete = this.timedOut = !1;
        c[this.id = String(++a)] = this
      }
      var a = 0,
        c = {},
        n = "undefined" !== typeof x && x.XDomainRequest;
      k.inherits(f, C);
      var e = f.createRequest = function(a, b, c, d, e, m, n) {
        m = m || t.TIMEOUTS;
        return new f(a, b, k.copy(c), d, e, m, n)
      };
      f.prototype.complete = function(a, b, c, d, e) {
        this.requestComplete || (this.requestComplete = !0, !a && b && this.emit("data", b), this.emit("complete", a, b, c, d, e), this.dispose())
      };
      f.prototype.abort = function() {
        this.dispose()
      };
      f.prototype.exec = function() {
        function a(a, b, c, f) {
          b = b + " (event type: " + a.type + ")" + (e.xhr.statusText ? ", current statusText is " + e.xhr.statusText : "");
          d.logAction(d.LOG_ERROR, "Request.on" + a.type + "()", b);
          e.complete(new q(b, c, f))
        }

        function b() {
          D = r.responseText;
          for (var a = D.length - 1, b, c; F < a && -1 < (b = D.indexOf("\n", F));) {
            c = D.slice(F, b);
            F = b + 1;
            a: {
              try {
                c = JSON.parse(c)
              } catch (na) {
                e.complete(new q("Malformed response body from server: " +
                  na.message, null, 400));
                break a
              }
              e.emit("data", c)
            }
          }
        }

        function c() {
          b();
          e.streamComplete = !0;
          k.nextTick(function() {
            e.complete()
          })
        }
        var e = this,
          f = this.timer = setTimeout(function() {
            e.timedOut = !0;
            r.abort()
          }, 0 == this.requestMode ? this.timeouts.httpRequestTimeout : this.timeouts.recvTimeout),
          m = this.body,
          n = this.method,
          t = this.headers,
          r = this.xhr = new XMLHttpRequest,
          x = t.accept,
          A = "text";
        x ? 0 === x.indexOf("application/x-msgpack") && (A = "arraybuffer") : t.accept = "application/json";
        m && -1 < (t["content-type"] || (t["content-type"] = "application/json")).indexOf("application/json") && "string" != typeof m && (m = JSON.stringify(m));
        r.open(n, this.uri, !0);
        r.responseType = A;
        "authorization" in t && (r.withCredentials = !0);
        for (var B in t) r.setRequestHeader(B, t[B]);
        r.onerror = function(b) {
          a(b, "XHR error occurred", null, 400)
        };
        r.onabort = function(b) {
          e.timedOut ? a(b, "Request aborted due to request timeout expiring", null, 408) : a(b, "Request cancelled", null, 400)
        };
        r.ontimeout = function(b) {
          a(b, "Request timed out", null, 408)
        };
        var C, z, D, E, F = 0,
          G = !1;
        r.onreadystatechange = function() {
          var a = r.readyState;
          if (!(3 > a) && 0 !== r.status) {
            if (void 0 === z)
              if (z = r.status, 1223 === z && (z = 204), clearTimeout(f), E = 400 > z, 204 == z) e.complete(null, null, null, null, z);
              else {
                var d;
                if (d = 3 == e.requestMode && E) d = r, d = d.getResponseHeader && (d.getResponseHeader("transfer-encoding") || !d.getResponseHeader("content-length"));
                C = d
              } if (3 == a && C) b();
            else if (4 == a)
              if (C) c();
              else a: {
                try {
                  var g = r.getResponseHeader && r.getResponseHeader("content-type");
                  if (g ? 0 <= g.indexOf("application/json") : "text" == r.responseType) {
                    var h = "arraybuffer" === r.responseType ? y.utf8Decode(r.response) : String(r.responseText);
                    h.length && (h = JSON.parse(h));
                    G = !0
                  } else h = r.response;
                  if (void 0 !== h.response) {
                    z = h.statusCode;
                    E = 400 > z;
                    var l = h.headers;
                    h = h.response
                  } else {
                    var m = k.trim(r.getAllResponseHeaders()).split("\r\n");
                    a = {};
                    for (g = 0; g < m.length; g++) {
                      var n = k.arrMap(m[g].split(":"), k.trim);
                      a[n[0].toLowerCase()] = n[1]
                    }
                    l = a
                  }
                } catch (ua) {
                  e.complete(new q("Malformed response body from server: " + ua.message, null, 400));
                  break a
                }
                E || k.isArray(h) ? e.complete(null, h, l, G, z) : ((m = h.error && q.fromValues(h.error)) || (m = new q("Error response received from server: " +
                  z + " body was: " + k.inspect(h), null, z)), e.complete(m, h, l, G, z))
              }
          }
        };
        r.send(m)
      };
      f.prototype.dispose = function() {
        var a = this.xhr;
        if (a) {
          a.onreadystatechange = a.onerror = a.onabort = a.ontimeout = b;
          this.xhr = null;
          var d = this.timer;
          d && (clearTimeout(d), this.timer = null);
          this.requestComplete || a.abort()
        }
        delete c[this.id]
      };
      r.xhrSupported && ("object" === typeof ha && ha.addUnloadListener(m), "undefined" !== typeof A && (A.supportsAuthHeaders = !0, A.Request = function(a, b, c, d, f, k, m) {
        a = e(c, d, f, k, 0, b && b.options.timeouts, a);
        a.once("complete", m);
        a.exec();
        return a
      }, A.checkConnectivity = function(a) {
        var b = t.internetUpUrl;
        d.logAction(d.LOG_MICRO, "(XHRRequest)Http.checkConnectivity()", "Sending; " + b);
        A.getUri(null, b, null, null, function(b, c) {
          var e = !b && "yes" == c.replace(/\n/, "");
          d.logAction(d.LOG_MICRO, "(XHRRequest)Http.checkConnectivity()", "Result: " + e);
          a(null, e)
        })
      }));
      return f
    }();
  (function() {
    function b(b, d, a) {
      L.call(this, b, d, a);
      this.shortName = "xhr_streaming"
    }
    k.inherits(b, L);
    b.isAvailable = function() {
      return r.xhrSupported && r.streamingSupported && r.allowComet
    };
    b.tryConnect = function(k, f, a, c) {
      function m(a) {
        c({
          event: this.event,
          error: a
        })
      }
      var e = new b(k, f, a);
      e.on(["failed", "disconnected"], m);
      e.on("preconnect", function() {
        d.logAction(d.LOG_MINOR, "XHRStreamingTransport.tryConnect()", "viable transport " + e);
        e.off(["failed", "disconnected"], m);
        c(null, e)
      });
      e.connect()
    };
    b.prototype.toString = function() {
      return "XHRStreamingTransport; uri=" + this.baseUri + "; isConnected=" + this.isConnected
    };
    b.prototype.createRequest = function(b, d, a, c, k) {
      return la.createRequest(b, d, a, c, k, this.timeouts)
    };
    "undefined" !== typeof O && b.isAvailable() && (O.supportedTransports.xhr_streaming = b);
    return b
  })();
  (function() {
    function b(b, d, a) {
      a.stream = !1;
      L.call(this, b, d, a);
      this.shortName = "xhr_polling"
    }
    k.inherits(b, L);
    b.isAvailable = function() {
      return r.xhrSupported && r.allowComet
    };
    b.tryConnect = function(k, f, a, c) {
      function m(a) {
        c({
          event: this.event,
          error: a
        })
      }
      var e = new b(k, f, a);
      e.on(["failed", "disconnected"], m);
      e.on("preconnect", function() {
        d.logAction(d.LOG_MINOR, "XHRPollingTransport.tryConnect()", "viable transport " + e);
        e.off(["failed", "disconnected"], m);
        c(null, e)
      });
      e.connect()
    };
    b.prototype.toString = function() {
      return "XHRPollingTransport; uri=" + this.baseUri + "; isConnected=" + this.isConnected
    };
    b.prototype.createRequest = function(b, d, a, c, k) {
      return la.createRequest(b, d, a, c, k, this.timeouts)
    };
    "undefined" !== typeof O && b.isAvailable() && (O.supportedTransports.xhr_polling = b);
    return b
  })();
  (function() {
    function b() {}

    function m(a, b, c) {
      c.stream = !1;
      L.call(this, a, b, c);
      this.shortName = "jsonp"
    }

    function f(a, b, d, e, f, l, m, n) {
      C.call(this);
      void 0 === a && (a = c++);
      this.id = a;
      this.uri = b;
      this.params = e || {};
      this.params.rnd = k.cheapRandStr();
      d && (d["X-Ably-Version"] && (this.params.v = d["X-Ably-Version"]), d["X-Ably-Lib"] && (this.params.lib = d["X-Ably-Lib"]));
      this.body = f;
      this.method = n;
      this.requestMode = l;
      this.timeouts = m;
      this.requestComplete = !1
    }
    var a = x._ablyjs_jsonp = {};
    a._ = function(c) {
      return a["_" + c] || b
    };
    var c = 1,
      n = null;
    k.inherits(m, L);
    m.isAvailable = function() {
      return r.jsonpSupported && r.allowComet
    };
    m.isAvailable() && (O.supportedTransports.jsonp = m);
    r.jsonpSupported && (n = document.getElementsByTagName("head")[0]);
    var e = null;
    x.JSONPTransport = m;
    m.tryConnect = function(a, b, c, e) {
      function f(a) {
        e({
          event: this.event,
          error: a
        })
      }
      var g = new m(a, b, c);
      g.on(["failed", "disconnected"], f);
      g.on("preconnect", function() {
        d.logAction(d.LOG_MINOR, "JSONPTransport.tryConnect()", "viable transport " + g);
        g.off(["failed", "disconnected"], f);
        e(null, g)
      });
      g.connect()
    };
    m.prototype.toString = function() {
      return "JSONPTransport; uri=" + this.baseUri + "; isConnected=" + this.isConnected
    };
    var l = m.prototype.createRequest = function(a, b, c, d, e, l, m) {
      l = this && this.timeouts || l || t.TIMEOUTS;
      return new f(void 0, a, b, k.copy(c), d, e, l, m)
    };
    k.inherits(f, C);
    f.prototype.exec = function() {
      var b = this.id,
        c = this.body,
        e = this.method,
        f = this.uri,
        l = this.params,
        m = this;
      l.callback = "_ablyjs_jsonp._(" + b + ")";
      l.envelope = "jsonp";
      c && (l.body = c);
      e && "get" !== e && (l.method = e);
      c = this.script = document.createElement("script");
      f += k.toQueryString(l);
      c.src = f;
      c.src.split("/").slice(-1)[0] !== f.split("/").slice(-1)[0] && d.logAction(d.LOG_ERROR, "JSONP Request.exec()", "Warning: the browser appears to have truncated the script URI. This will likely result in the request failing due to an unparseable body param");
      c.async = !0;
      c.type = "text/javascript";
      c.charset = "UTF-8";
      c.onerror = function(a) {
        m.complete(new q("JSONP script error (event: " + k.inspect(a) + ")", null, 400))
      };
      a["_" + b] = function(a) {
        if (a.statusCode) {
          var b = a.response;
          204 == a.statusCode ? m.complete(null, null, null, a.statusCode) : b ? 400 > a.statusCode || k.isArray(b) ? m.complete(null, b, a.headers, a.statusCode) : (a = b.error || new q("Error response received from server", null, a.statusCode), m.complete(a)) : m.complete(new q("Invalid server response: no envelope detected", null, 500))
        } else m.complete(null, a)
      };
      this.timer = setTimeout(function() {
        m.abort()
      }, this.requestMode == L.REQ_SEND ? this.timeouts.httpRequestTimeout : this.timeouts.recvTimeout);
      n.insertBefore(c, n.firstChild)
    };
    f.prototype.complete = function(a, b, c, d) {
      c = c || {};
      this.requestComplete || (this.requestComplete = !0, b && (c["content-type"] = "string" == typeof b ? "text/plain" : "application/json", this.emit("data", b)), this.emit("complete", a, b, c, !0, d), this.dispose())
    };
    f.prototype.abort = function() {
      this.dispose()
    };
    f.prototype.dispose = function() {
      var b = this.timer;
      b && (clearTimeout(b), this.timer = null);
      b = this.script;
      b.parentNode && b.parentNode.removeChild(b);
      delete a[this.id];
      this.emit("disposed")
    };
    r.jsonpSupported && !A.Request && (A.Request = function(a, b, c, d, e, f, m) {
      var g = l(c, d, e, f, L.REQ_SEND, b && b.options.timeouts, a);
      g.once("complete", m);
      k.nextTick(function() {
        g.exec()
      });
      return g
    }, A.checkConnectivity = function(a) {
      var b = t.jsonpInternetUpUrl;
      if (e) e.push(a);
      else {
        e = [a];
        d.logAction(d.LOG_MICRO, "(JSONP)Http.checkConnectivity()", "Sending; " + b);
        var c = new f("isTheInternetUp", b, null, null, null, L.REQ_SEND, t.TIMEOUTS);
        c.once("complete", function(a, b) {
          var c = !a && b;
          d.logAction(d.LOG_MICRO, "(JSONP)Http.checkConnectivity()", "Result: " + c);
          for (var f = 0; f < e.length; f++) e[f](null, c);
          e = null
        });
        k.nextTick(function() {
          c.exec()
        })
      }
    });
    return m
  })();
  "undefined" !== typeof F && (Z.msgpack = ia, Z.Rest = E, Z.Realtime = F, F.ConnectionManager = O, F.BufferUtils = E.BufferUtils = y, "undefined" !== typeof S && (F.Crypto = E.Crypto = S), F.Defaults = E.Defaults = t, F.Http = E.Http = A, F.Utils = E.Utils = k, F.Http = E.Http = A, F.Message = E.Message = D, F.PresenceMessage = E.PresenceMessage = G, F.ProtocolMessage = E.ProtocolMessage = B);
  if ("object" === typeof x.exports) {
    for (var fa in x.Ably) x.Ably.hasOwnProperty(fa) && (x.exports[fa] = x.Ably[fa]);
    x.exports.__esModule = !0
  }
  "function" === typeof x.define && x.define.amd && x.define("ably", [], function() {
    return x.Ably
  })
}).call({});
var Presence = function(client, data) {
  this.ortcClient = client;
  this.timerTotal = null;
  this.timerProblem = null;
  this.timerOnTask = null;
  this.updateSubject();
  this.setData(data);
  this.addListeners();
  this.initTimers();
};
Presence.prototype.data = {
  debug: 0,
  teacher_ids: [],
  ids: [],
  pkINStudentID: null,
  fkINUserID: null,
  Username: "",
  varRealSubject: "Home page",
  varRealCorrect: 0,
  varRealTotal: 0,
  varRealNotCountedProblems: 0,
  varRealFocus: 0,
  sessionTime: 0,
  totalTime: new Date().getTime(),
  currentProblemTime: 0,
  currentProblemTotalTime: null,
  currentProblemTotalTimeActive: false,
  isPaused: false,
  CurrentProblem: {
    pkMLProblemID: null,
    fkMLStrandID: null,
    fkMLLessonID: null,
    fkMLGradeLevelID: null,
    PracticeSet: 1,
    TypeNew: "",
    ProblemFormat: "",
    IsSummary: false,
    subject: "MM",
    StrandFocusTime: 120,
    IsProblemFocus: 0,
    Attempted: null,
    isCorrect: null,
    Time: 0,
  },
  oldProblemId: null,
  lastEvaluatedProblemId: null,
  module: "MS",
  wrongInRowInThreeSeconds: 0,
  isClickThrough: false,
  Problems: [],
  wrongInRow: 0,
  isNotUnderstanding: false,
  avgProblemTime: null,
  notOnTask: false,
  efficiency: 0,
  onTask: 0,
};
Presence.prototype.initTimers = function() {
  this.timerTotal = $.timer(function() {
    this.data.sessionTime += 1;
  }.bind(this), 1000, false);
  if (!this.data.isPaused)
    this.timerTotal.play();
  this.timerProblem = $.timer(function() {
    this.data.currentProblemTime += 1;
  }.bind(this), 1000, false);
  if (this.isProblem() && !this.data.isPaused) {
    this.timerProblem.play();
    this.data.currentProblemTotalTimeActive = true;
  }
  this.timerOnTask = $.timer(function() {
    if (this.data.currentProblemTotalTimeActive && this.data.CurrentProblem.ProblemType !== 'Teach Me') {
      var problemTime = Number(this.data.CurrentProblem.MedianTime || this.data.CurrentProblem.AverageTime);
      var studentTime = Math.round((new Date() - this.data.currentProblemTotalTime) / 1000);
      var notOnTask = studentTime > (problemTime * 2);
      if (!this.data.notOnTask && notOnTask) {
        this.data.notOnTask = notOnTask;
        this.sendToAll();
      }
    } else if (this.data.notOnTask) {
      this.data.notOnTask = false;
      this.sendToAll();
    }
  }.bind(this), 1000, true);
};
Presence.prototype.pause = function() {
  this.timerTotal.pause();
  this.timerProblem.pause();
  this.sendToAll();
};
Presence.prototype.pauseProblem = function() {
  this.timerProblem.pause();
};
Presence.prototype.resume = function() {
  this.timerTotal.play();
  if (this.isNewProblem()) {
    this.timerProblem.play();
  }
  this.sendToAll();
};
Presence.prototype.send = function(channel, data) {
  if (typeof(app.jsVars.AblyRealtime.channels.all['t-' + channel]) == 'undefined') return;
  presenceChannel = app.jsVars.AblyRealtime.channels.get('t-' + channel);
  presenceChannel.publish('presence', data, function(err) {
    console.log("publish Presence from Student to t-" + channel);
    if (err) console.log('presence app error');
  });
};
Presence.prototype.sendToAll = function(data) {
  var parsedData = JSON.stringify(typeof data !== 'undefined' ? data : this.getData());
  for (var i in this.data.teacher_ids) {
    if (isNaN(this.data.teacher_ids[i])) continue;
    this.send(this.data.teacher_ids[i], parsedData);
  }
};
Presence.prototype.getNewMessage = function(message, channel) {
  var parsedMessage = JSON.parse(message);
  if (typeof(parsedMessage[0]) != "undefined" && isNaN(parsedMessage[0])) {
    if (this.data.debug) {}
    $(document).trigger(parsedMessage[0], channel);
  }
};
Presence.prototype.saveLastProblem = function(pkMLProblemID) {
  if (pkMLProblemID) {
    var oldProblem = parseInt(pkMLProblemID.toString());
    this.data.oldProblemId = oldProblem;
  } else if (this.data.CurrentProblem.pkMLProblemID) {
    var oldProblem = parseInt(this.data.CurrentProblem.pkMLProblemID.toString());
    this.data.oldProblemId = oldProblem;
  }
};
Presence.prototype.setProblemAsEvaluated = function(pkMLProblemID) {
  if (pkMLProblemID) {
    var oldProblem = parseInt(pkMLProblemID.toString());
    this.data.lastEvaluatedProblemId = oldProblem;
  } else if (this.data.CurrentProblem.pkMLProblemID) {
    var oldProblem = parseInt(this.data.CurrentProblem.pkMLProblemID.toString());
    this.data.lastEvaluatedProblemId = oldProblem;
  }
};
Presence.prototype.isNewProblem = function(pkMLProblemID) {
  if (pkMLProblemID) {
    return !(this.data.CurrentProblem.pkMLProblemID == pkMLProblemID);
  } else if (this.data.oldProblemId) {
    if (!this.isProblem()) return false;
    return !(this.data.CurrentProblem.pkMLProblemID == this.data.oldProblemId);
  }
  if (!this.isProblem()) return false;
  return true;
};
Presence.prototype.isEvaluatedProblem = function(pkMLProblemID) {
  if (!this.data.lastEvaluatedProblemId) {
    return false;
  }
  if (pkMLProblemID) {
    return this.data.lastEvaluatedProblemId == pkMLProblemID;
  } else {
    if (!this.isProblem()) return false;
    return this.data.CurrentProblem.pkMLProblemID == this.data.lastEvaluatedProblemId;
  }
  return false;
};
Presence.prototype.isProblem = function() {
  if (!this.data.CurrentProblem.pkMLProblemID) {
    return false;
  }
  if (typeof(this.data.CurrentProblem.ProblemFormat) != "undefined" && this.data.CurrentProblem.ProblemFormat == "Intro") {
    return false;
  }
  return true;
};
Presence.prototype.isManipulativeProblem = function() {
  if (!this.isProblem()) return false;
  if (typeof(this.data.CurrentProblem.CorrectAnswer) != "undefined" && this.data.CurrentProblem.CorrectAnswer) {
    return true;
  }
  if (typeof(this.data.CurrentProblem.ProblemFormat) != "undefined") {
    if (this.data.CurrentProblem.ProblemFormat == "Page" || this.data.CurrentProblem.ProblemFormat == "Explore" || this.data.CurrentProblem.ProblemFormat == "Bullet" || this.data.CurrentProblem.ProblemFormat == "Bullet-CFU" || this.data.CurrentProblem.ProblemFormat == "Short Answer") {
      return false;
    }
  }
  if (typeof(this.data.CurrentProblem.TypeNew) != "undefined") {
    if (this.data.CurrentProblem.TypeNew == "Teach Me" || this.data.CurrentProblem.TypeNew == "Page" || this.data.CurrentProblem.TypeNew == "Short Answer") {
      return false;
    }
  }
  if ($('.problem-feedback').is(':visible') || $('.problem-feedback-student').is(':visible') || $('.problem-fact-feedback').is(':visible')) {
    return false;
  }
  return true;
};
Presence.prototype.getData = function() {
  var problemID = null;
  if (this.data.CurrentProblem.pkMLProblemID !== null) {
    problemID = this.data.CurrentProblem.pkMLProblemID;
  } else if (typeof this.data.CurrentProblem.fkMLProblemID !== 'undefined') {
    problemID = this.data.CurrentProblem.fkMLProblemID;
  } else if (typeof this.data.CurrentProblem.pkMLItemID !== 'undefined') {
    problemID = this.data.CurrentProblem.pkMLItemID;
  }
  var efficiency = this.data.varRealTotal === 0 ? null : Math.round(this.data.efficiency / this.data.varRealTotal);
  var onTask = this.data.varRealTotal === 0 ? null : Math.round(this.data.onTask / this.data.varRealTotal);
  var isIdle = (typeof(this.timerTotal.isActive) == "undefined" || !this.timerTotal.isActive ? true : false);
  return [this.data.pkINStudentID, this.data.Username, this.setSubjectTitle(this.data.varRealSubject), this.data.sessionTime, this.data.varRealCorrect, this.data.varRealTotal, this.data.varRealFocus, this.data.currentProblemTime, (isIdle || this.data.notOnTask), problemID, this.data.CurrentProblem.fkMLStrandID, this.data.CurrentProblem.fkMLLessonID, this.data.CurrentProblem.fkMLGradeLevelID, this.data.CurrentProblem.PracticeSet, this.data.module, (typeof(this.timerProblem.isActive) == "undefined" || !this.timerProblem.isActive ? true : false), this.data.isClickThrough, this.data.totalTime, this.data.currentProblemTotalTimeActive ? this.data.currentProblemTotalTime : null, this.data.isNotUnderstanding, LiveMessage.user_id, this.data.avgProblemTime, app.jsVars.moduleId, efficiency, onTask, this.data.varRealNotCountedProblems, app.jsVars.studentLastSignedIn, this.data.wrongInRow];
};
Presence.prototype.setData = function(data) {
  $.extend(this.data, data);
};
Presence.prototype.setSubjectTitle = function(subject) {
  switch (subject) {
    case 'MobyMax':
      return 'Home page';
    case 'Factmaster':
      return 'Fact Fluency';
    default:
      return subject;
  }
}
Presence.prototype.updateSubject = function() {
  var title = $('.lab-title');
  if (title.length && title.html() != " " && title.html() != "&nbsp;") {
    this.data.varRealSubject = title.text();
    return true;
  } else if (typeof(G_lab) != "undefined" && typeof(G_lab.currentModule.subject) != "undefined" && G_lab.currentModule.subject && G_lab.currentModule.subject.length) {
    this.data.varRealSubject = G_lab.currentModule.subject.capitalize();
  } else if (typeof(mmapp) != "undefined" && typeof(mmapp.module.subject) != "undefined" && mmapp.module.subject && mmapp.module.subject.length) {
    this.data.varRealSubject = mmapp.module.subject.capitalize();
  }
};
Presence.prototype.setFocus = function(data, disableEfficiency) {
  if (typeof disableEfficiency === 'undefined') {
    disableEfficiency = false;
  }
  if (typeof data.isCorrect !== 'undefined') {
    this.data.wrongInRowInThreeSeconds = (!data.isCorrect && data.Time < 3) ? (this.data.wrongInRowInThreeSeconds + 1) : 0;
    this.data.isClickThrough = this.data.wrongInRowInThreeSeconds >= 3;
    this.data.Problems.push(data);
    this.data.wrongInRow = !data.isCorrect ? (this.data.wrongInRow + 1) : 0;
    this.data.isNotUnderstanding = this.data.wrongInRow >= 3;
    if (!disableEfficiency) {
      var date = new Date();
      var studentTime = Math.round((date - this.data.currentProblemTotalTime) / 1000);
      var problemTime = Number(this.data.CurrentProblem.MedianTime || this.data.CurrentProblem.AverageTime);
      if (data.isCorrect) {
        this.data.efficiency += this.calculateEfficiency(studentTime, problemTime);
      }
      this.data.onTask += this.calculateOnTask(studentTime, problemTime);
    }
  }
  if (typeof(data.isProblemFocus) != "undefined") {
    if (data.isProblemFocus) {
      this.data.varRealFocus++;
    }
  } else if (typeof(data.Time) != "undefined") {
    if (typeof(data.StrandFocusTime) != "undefined" && parseInt(data.StrandFocusTime) !== 0 && parseInt(data.Time) >= data.StrandFocusTime) {
      this.data.varRealFocus++;
    } else if (this.data.CurrentProblem.StrandFocusTime !== 0 && parseInt(data.Time) >= this.data.CurrentProblem.StrandFocusTime) {
      this.data.varRealFocus++;
    }
  } else if (this.data.CurrentProblem.StrandFocusTime !== 0 && parseInt(this.data.currentProblemTime) >= this.data.CurrentProblem.StrandFocusTime) {
    this.data.varRealFocus++;
  }
};
Presence.prototype.calculateOnTask = function(studentTime, problemTime) {
  if (this.data.module === 'FM' && this.data.CurrentProblem.timeUp === true) {
    return 0;
  }
  if (studentTime <= problemTime) {
    return 100;
  } else if (studentTime <= (problemTime * 2)) {
    return 50;
  }
  return 0;
};
Presence.prototype.calculateEfficiency = function(studentTime, problemTime) {
  var cutOffTime = problemTime * 4;
  if (studentTime >= cutOffTime) {
    return 0;
  }
  return 100 - (Math.floor(studentTime / (cutOffTime / 10)) * 10);
};
Presence.prototype.updateTimer = function() {
  if (this.timerProblem.isActive) {
    this.timerTotal.pause();
    this.timerProblem.pause();
  }
  if (this.data.currentProblemTotalTimeActive) {
    this.data.currentProblemTotalTimeActive = false;
    if (this.data.Problems.length > 0) {
      var currentProblem = this.data.Problems[this.data.Problems.length - 1];
      var date = new Date();
      currentProblem.time = Math.round((date - this.data.currentProblemTotalTime) / 1000);
      currentProblem.dateCompleted = date;
      this.data.avgProblemTime = this.calculateAvgProblemTime();
    }
  }
  if (!this.isProblem() || this.isNewProblem()) {
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = new Date().getTime();
  }
  if (this.isNewProblem()) {
    this.timerProblem.play();
    this.data.currentProblemTotalTimeActive = true;
    this.data.notOnTask = false;
  }
  this.timerTotal.play();
};
Presence.prototype.readGlobalVars = function() {
  this.updateSubject();
  if (this.data.module && typeof(this[this.data.module.toString()]) != "undefined" && typeof(this[this.data.module.toString()].readGlobalVars) == "function") {
    return this[this.data.module.toString()].readGlobalVars();
  } else {
    return this.MS.readGlobalVars(this);
  }
  return false;
};
Presence.prototype.addListeners = function() {
  $(document).on('update.inRealtime', function(e, channel) {
    this.addChannel(channel);
    if (this.data.debug) {}
    this.updateSubject();
    this.send(channel);
  }.bind(this));
  $(document).on('close.inRealtime', function(e, channel) {
    this.removeChannel(channel);
  }.bind(this));
  if (this.data.module && typeof(this[this.data.module.toString()]) != "undefined" && typeof(this[this.data.module.toString()].addListeners) == "function") {
    return this[this.data.module.toString()].addListeners(this);
  } else {
    return this.MS.addListeners(this);
  }
  return false;
};
Presence.prototype.addChannel = function(channel) {
  if ($.inArray(channel, this.data.teacher_ids) == -1) {
    this.data.teacher_ids[this.data.teacher_ids.length] = channel;
  }
}
Presence.prototype.removeChannel = function(channel) {
  var index = $.inArray(channel, this.data.teacher_ids);
  if (index != -1) {
    delete this.data.teacher_ids[index];
  }
}
Presence.prototype.calculateAvgProblemTime = function() {
  var problems = this.data.Problems.filter(function(item) {
    return typeof item.time !== 'undefined';
  })
  var total = problems.reduce(function(a, b) {
    return a + b.time;
  }, 0);
  return Math.round(total / problems.length);
}
Presence.prototype.MS = {};
Presence.prototype.MS.readGlobalVars = function(parent) {
  var updated = false;
  if (typeof(CurrentProblem) == "object" && CurrentProblem.pkMLProblemID) {
    $.extend(parent.data.CurrentProblem, {
      ProblemFormat: null,
      TypeNew: null,
    }, CurrentProblem);
    updated = true;
  }
  if (typeof(G_lab) != "undefined") {
    if (typeof(G_lab.Strand) != "undefined") {
      parent.data.CurrentProblem.fkMLStrandID = G_lab.Strand;
      updated = true;
      if (typeof(G_lab.arrStrand) != "undefined" && G_lab.arrStrand) {
        for (var i = 0; i < G_lab.arrStrand.length; i++) {
          if (G_lab.arrStrand[i].Strand.pkMLStrandID == parent.data.CurrentProblem.fkMLStrandID) {
            parent.data.CurrentProblem.fkMLGradeLevelID = G_lab.arrStrand[i].Domain.fkMLGradeLevelID;
          }
        }
      }
      if (typeof(G_lab.LessonStrands) != "undefined" && G_lab.LessonStrands) {
        for (var i = 0; i < G_lab.LessonStrands.length; i++) {
          if (G_lab.LessonStrands[i].Strand.pkMLStrandID == parent.data.CurrentProblem.fkMLStrandID && !isNaN(G_lab.LessonStrands[i].Strand.Time)) {
            parent.data.CurrentProblem.StrandFocusTime = parseInt(G_lab.LessonStrands[i].Strand.Time);
          }
        }
      }
    }
    if (typeof(G_lab.Lesson) != "undefined" && G_lab.Lesson) {
      parent.data.CurrentProblem.fkMLLessonID = G_lab.Lesson;
      updated = true;
    }
    if (typeof(G_lab.PracticeSet) != "undefined") {
      parent.data.CurrentProblem.PracticeSet = G_lab.PracticeSet;
      updated = true;
    }
  }
  return updated;
};
Presence.prototype.MS.addListeners = function(parent) {
  $(document).on('displayProblem.MSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.MSLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    this.readGlobalVars();
    if (typeof(data.pkMLProblemID) != "undefined") {
      $.extend(this.data.CurrentProblem, data);
    }
    if (this.data.module === 'FM') {
      this.data.CurrentProblem.timeUp = false;
    }
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.MSLab', function(e, data) {
    if (typeof(data) != 'undefined' && typeof(data.isTemplateAnswer) != 'undefined' && data.isTemplateAnswer == true && !data.isCorrect) return;
    if (this.data.debug) {
      console.log('event evaluateProblem.MSLab, data:');
      console.log(data);
    }
    if (this.isManipulativeProblem() && this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
    }
    if (this.isProblem() && this.isNewProblem()) {
      this.setFocus(data, !this.isManipulativeProblem());
      this.saveLastProblem();
    }
    this.updateTimer();
    if (!this.isNewProblem() && (typeof(data.isCorrect) != "undefined" && !data.isCorrect)) {
      if (['MM', 'MG', 'RL', 'RI', 'WS', 'SC', 'SS', 'GP', 'FR'].includes(this.data.module)) {
        this.timerProblem.play();
        this.data.currentProblemTotalTimeActive = true;
      }
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.MSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.MSLab, data:');
      console.info(data);
    }
    if (this.data.module === 'FM' && data.isCorrect === false) {
      this.data.CurrentProblem.timeUp = true
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('labBackgroundAndTitle.MSLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event labBackgroundAndTitle.MSLab, data:');
      console.info(labTitle);
    }
    if (labTitle) {
      this.data.varRealSubject = labTitle;
    } else {
      this.updateSubject();
    }
    this.updateTimer();
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.MSLab pause.TPlab pause.TMlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.MSLab resume.TPlab resume.TMlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
  $(document).on('next.TMlab', function() {
    if (this.data.debug) {
      console.info('next.TMlab');
      console.info(this);
    }
    this.sendToAll();
  }.bind(parent));
};
Presence.prototype.MR = {};
Presence.prototype.MR.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.MR.addListeners = function(parent) {
  $(document).on('displayProblem.MRLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.MRLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.MRLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.MRLab, data:');
      console.log(data);
    }
    if (this.isManipulativeProblem() && this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
    }
    if (this.isProblem() && this.isNewProblem()) {
      this.setFocus(data, !this.isManipulativeProblem());
      this.saveLastProblem();
    }
    this.updateTimer();
    if (!this.isNewProblem() && (typeof(data.isCorrect) != "undefined" && !data.isCorrect)) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.MRLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.MRLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('labBackgroundAndTitle.MRLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event labBackgroundAndTitle.MRLab, data:');
      console.info(labTitle);
    }
    if (labTitle) {
      this.data.varRealSubject = labTitle;
    } else {
      this.updateSubject();
    }
    if (!this.isProblem() && this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    } else if (this.isProblem() && !this.timerProblem.isActive) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.MRlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('unpause.MRlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.EW = {};
Presence.prototype.EW.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.EW.addListeners = function(parent) {
  $(document).on('displayProblem.EWLab displayProblem.ERLab displayProblem.ESLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.EWLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    if (this.timerProblem.isActive) {
      this.timerProblem.pause();
    }
    if (typeof(data.answer) != "undefined" && data.answer.text.length) {
      this.data.currentProblemTime = 0;
      this.timerProblem.play();
    }
    this.data.currentProblemTotalTime = new Date().getTime();
    this.data.currentProblemTotalTimeActive = true;
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.EWLab evaluateProblem.ERLab evaluateProblem.ESLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.EWLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.EWLab sendFocus.ERLab sendFocus.ESLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.EWLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('labBackgroundAndTitle.EWLab labBackgroundAndTitle.ERLab labBackgroundAndTitle.ESLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event labBackgroundAndTitle.EWLab, data:');
      console.info(labTitle);
    }
    if (labTitle) {
      this.data.varRealSubject = labTitle;
    } else {
      this.updateSubject();
    }
    if (!this.isProblem() && this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    } else if (this.isProblem() && !this.timerProblem.isActive) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.EarlyLab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.EarlyLab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
  $(document).on('nextStory.EarlyLab', function() {
    if (this.data.debug) {
      console.info('nextStory.EarlyLab');
      console.info(this);
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
};
Presence.prototype.ES = {};
Presence.prototype.ES.readGlobalVars = function(parent) {
  return false;
};
Presence.prototype.ES.addListeners = function(parent) {
  $(document).on('displayProblem.ESLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.ESLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    if (this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    }
    if (typeof(data.ESProblem) != "undefined" && typeof(data.ESProblem.pkMLProblemID) != "undefined") {
      this.data.currentProblemTime = 0;
      this.data.currentProblemTotalTime = new Date().getTime();
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.ESLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.ESLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.ESLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.ESLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('labBackgroundAndTitle.ESLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event labBackgroundAndTitle.ESLab, data:');
      console.info(labTitle);
    }
    if (labTitle) {
      this.data.varRealSubject = labTitle;
    } else {
      this.updateSubject();
    }
    if (!this.isProblem() && this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    } else if (this.isProblem() && !this.timerProblem.isActive) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.EarlyLab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.EarlyLab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.ER = {};
Presence.prototype.ER.readGlobalVars = function(parent) {
  return false;
};
Presence.prototype.ER.addListeners = function(parent) {
  $(document).on('displayProblem.ERLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.ERLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    if (this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    }
    if (typeof(data.ERStudentStory) != "undefined" && typeof(data.ERStudentStory.fkMLStoryID) != "undefined") {
      this.data.currentProblemTime = 0;
      this.data.currentProblemTotalTime = new Date().getTime();
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.ERLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.ERLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.ERLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.ERLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('labBackgroundAndTitle.ERLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event labBackgroundAndTitle.ERLab, data:');
      console.info(labTitle);
    }
    if (labTitle) {
      this.data.varRealSubject = labTitle;
    } else {
      this.updateSubject();
    }
    if (!this.isProblem() && this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    } else if (this.isProblem() && !this.timerProblem.isActive) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.EarlyLab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.EarlyLab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.RA = {};
Presence.prototype.RA.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.RA.addListeners = function(parent) {
  $(document).on('displayProblem.RALab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.RALab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.RALab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.RALab, data:');
      console.log(data);
    }
    if (this.isManipulativeProblem() && this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
    }
    if (this.isProblem() && this.isNewProblem()) {
      this.setFocus(data, !this.isManipulativeProblem());
      this.saveLastProblem();
    }
    this.updateTimer();
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.RALab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.RALab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('labBackgroundAndTitle.RALab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event labBackgroundAndTitle.RALab, data:');
      console.info(labTitle);
    }
    if (labTitle) {
      this.data.varRealSubject = labTitle;
    } else {
      this.updateSubject();
    }
    if (!this.isProblem() && this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    } else if (this.isProblem() && !this.timerProblem.isActive) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.RALab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('unpause.RALab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.MW = {};
Presence.prototype.MW.readGlobalVars = function(parent) {
  return false;
};
Presence.prototype.MW.addListeners = function(parent) {
  $(document).on('displayProblem.MWLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.MWLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    if (this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    }
    if (typeof(data.pkMLProblemID) != "undefined") {
      this.data.currentProblemTime = 0;
      this.data.currentProblemTotalTime = new Date().getTime();
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.MWLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.MWLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      this.data.varRealNotCountedProblems++;
      this.saveLastProblem();
    }
    if (this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.MWLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.MWLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('labBackgroundAndTitle.MWLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event labBackgroundAndTitle.MWLab, data:');
      console.info(labTitle);
    }
    if (labTitle) {
      this.data.varRealSubject = labTitle;
    } else {
      this.updateSubject();
    }
    if (!this.isProblem() && this.timerProblem.isActive) {
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    } else if (this.isProblem() && !this.timerProblem.isActive) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.MWlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.MWlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.VL = {};
Presence.prototype.VL.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.VL.addListeners = function(parent) {
  $(document).on('displayProblem.VLLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.VLLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.VLLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.VLLab, data:');
      console.log(data);
    }
    if (this.isNewProblem() && data.type !== 'find') {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
    }
    if (this.isNewProblem()) {
      this.saveLastProblem();
    }
    this.updateTimer();
    if (!this.isNewProblem() && (typeof(data.isCorrect) != "undefined" && !data.isCorrect)) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.VLLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.VLLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('labBackgroundAndTitle.VLLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event labBackgroundAndTitle.VLLab, data:');
      console.info(labTitle);
    }
    if (labTitle) {
      this.data.varRealSubject = labTitle;
    } else {
      this.updateSubject();
    }
    this.timerProblem.pause();
    this.data.currentProblemTotalTimeActive = false;
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.VLlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.VLlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.NS = {};
Presence.prototype.NS.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.NS.addListeners = function(parent) {
  $(document).on('displayProblem.NSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.NSLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.NSLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.NSLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    if (!this.isNewProblem() && (typeof(data.isCorrect) != "undefined" && !data.isCorrect)) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.NSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.NSLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('displayScreen.NSLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event displayScreen.NSLab, data:');
      console.info(labTitle);
    }
    this.saveLastProblem();
    this.data.CurrentProblem.pkMLProblemID = null;
    this.timerProblem.pause();
    this.data.currentProblemTotalTimeActive = false;
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.NSlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.NSlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.AB = {};
Presence.prototype.AB.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.AB.addListeners = function(parent) {
  $(document).on('displayProblem.ABLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.ABLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.ABLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.ABLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.ABLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.ABLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('displayScreen.ABLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event displayScreen.ABLab, data:');
      console.info(labTitle);
    }
    this.saveLastProblem();
    this.data.CurrentProblem.pkMLProblemID = null;
    this.timerProblem.pause();
    this.data.currentProblemTotalTimeActive = false;
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.ABlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.ABlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.AL = {};
Presence.prototype.AL.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.AL.addListeners = function(parent) {
  $(document).on('displayProblem.ALLab displayProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.ALLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.ALLab evaluateProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.ALLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    if (!this.isNewProblem() && (typeof(data.isCorrect) != "undefined" && !data.isCorrect)) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.ALLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.ALLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('displayScreen.ALLab displayScreen.FSLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event displayScreen.ALLab, data:');
      console.info(labTitle);
    }
    this.saveLastProblem();
    this.data.CurrentProblem.pkMLProblemID = null;
    this.timerProblem.pause();
    this.data.currentProblemTotalTimeActive = false;
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.ALlab pause.FSlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.ALlab resume.FSlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.SL = {};
Presence.prototype.SL.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.SL.addListeners = function(parent) {
  $(document).on('displayProblem.SLLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.SLLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.SLLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.SLLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    if (!this.isNewProblem() && (typeof(data.isCorrect) != "undefined" && !data.isCorrect)) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.SLLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.SLLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('displayScreen.SLLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event displayScreen.SLLab, data:');
      console.info(labTitle);
    }
    this.saveLastProblem();
    this.data.CurrentProblem.pkMLProblemID = null;
    this.timerProblem.pause();
    this.data.currentProblemTotalTimeActive = false;
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.SLLab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.SLLab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.CL = {};
Presence.prototype.CL.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.CL.addListeners = function(parent) {
  $(document).on('displayProblem.CLLab displayProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.CLLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.CLLab evaluateProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.CLLab, data:');
      console.log(data);
    }
    if (this.isManipulativeProblem() && this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.CLLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.CLLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('displayScreen.CLLab displayScreen.FSLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event displayScreen.CLLab, data:');
      console.info(labTitle);
    }
    this.saveLastProblem();
    this.data.CurrentProblem.pkMLProblemID = null;
    this.timerProblem.pause();
    this.data.currentProblemTotalTimeActive = false;
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.CLlab pause.CL pause.FSlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.CLlab resume.CL resume.FSlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.FS = {};
Presence.prototype.FS.readGlobalVars = function(parent) {
  return true;
};
Presence.prototype.FS.addListeners = function(parent) {
  $(document).on('displayProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.FSLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    if (this.timerProblem.isActive) {
      this.timerTotal.pause();
      this.timerProblem.pause();
      this.data.currentProblemTotalTimeActive = false;
    }
    if (!this.isProblem() || this.isNewProblem()) {
      this.data.currentProblemTime = 0;
      this.data.currentProblemTotalTime = new Date().getTime();
    }
    this.timerProblem.play();
    this.data.currentProblemTotalTimeActive = true;
    this.timerTotal.play();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evaluateProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evaluateProblem.FSLab, data:');
      console.log(data);
    }
    if (!this.isEvaluatedProblem(this.data.CurrentProblem.pkMLItemID)) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.setProblemAsEvaluated(this.data.CurrentProblem.pkMLItemID);
      this.saveLastProblem();
    }
    if (data.isCorrect || this.data.CurrentProblem.IsTeachMeDone) {
      this.updateTimer();
    }
    if (!this.isNewProblem() && (typeof(data.isCorrect) != "undefined" && !data.isCorrect && !this.data.CurrentProblem.IsTeachMeDone)) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    } else if (!(['evaluateReview', 'evaluateReviewRepeat'].indexOf(data.caller) > -1 && !data.isCorrect)) {
      this.data.currentProblemTotalTimeActive = false;
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.FSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.FSLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('displayScreen.FSLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event displayScreen.FSLab, data:');
      console.info(labTitle);
    }
    this.saveLastProblem();
    this.data.CurrentProblem.pkMLProblemID = null;
    this.timerProblem.pause();
    this.data.currentProblemTotalTimeActive = false;
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('startReview.FSLab', function(e) {
    if (this.data.debug) {
      console.info('event startReview.FSLab');
    }
    this.data.CurrentProblem.pkMLProblemID = null;
    this.data.oldProblemId = null;
    this.data.lastEvaluatedProblemId = null;
  }.bind(parent));
  $(document).on('pause.FSlab pause.PBlab pause.SPlab', function() {
    if (this.data.debug) {
      console.info('User idle');
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.FSlab resume.PBlab resume.SPlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.SWF = {};
Presence.prototype.SWF.readGlobSWFVars = function(parent) {
  return true;
};
Presence.prototype.SWF.addListeners = function(parent) {
  $(document).on('displayProblem.SWFLab displayProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.SWFLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evSWFuateProblem.SWFLab evSWFuateProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evSWFuateProblem.SWFLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    if (!this.isNewProblem() && (typeof(data.isCorrect) != "undefined" && !data.isCorrect)) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.SWFLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.SWFLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('displayScreen.SWFLab displayScreen.FSLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event displayScreen.SWFLab, data:');
      console.info(labTitle);
    }
    this.saveLastProblem();
    this.data.CurrentProblem.pkMLProblemID = null;
    this.timerProblem.pause();
    this.data.currentProblemTotalTimeActive = false;
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.SWFlab pause.FSlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.SWFlab resume.FSlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
Presence.prototype.SWD = {};
Presence.prototype.SWD.readGlobSWDVars = function(parent) {
  return true;
};
Presence.prototype.SWD.addListeners = function(parent) {
  $(document).on('displayProblem.SWDLab displayProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.info('event displayProblem.SWDLab, data:');
      console.info(data);
    }
    this.saveLastProblem();
    $.extend(this.data.CurrentProblem, data);
    this.updateTimer();
    this.sendToAll();
  }.bind(parent));
  $(document).on('evSWDuateProblem.SWDLab evSWDuateProblem.FSLab', function(e, data) {
    if (this.data.debug) {
      console.log('event evSWDuateProblem.SWDLab, data:');
      console.log(data);
    }
    if (this.isNewProblem()) {
      if (typeof(data.isCorrect) != "undefined" && data.isCorrect) {
        this.data.varRealCorrect++;
      }
      this.data.varRealTotal++;
      this.setFocus(data);
      this.saveLastProblem();
    }
    this.updateTimer();
    if (!this.isNewProblem() && (typeof(data.isCorrect) != "undefined" && !data.isCorrect)) {
      this.timerProblem.play();
      this.data.currentProblemTotalTimeActive = true;
    }
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('sendFocus.SWDLab', function(e, data) {
    if (this.data.debug) {
      console.info('event sendFocus.SWDLab, data:');
      console.info(data);
    }
    this.data.varRealFocus++;
    this.sendToAll();
  }.bind(parent));
  $(document).on('displayScreen.SWDLab displayScreen.FSLab', function(e, labTitle) {
    if (this.data.debug) {
      console.info('event displayScreen.SWDLab, data:');
      console.info(labTitle);
    }
    this.saveLastProblem();
    this.data.CurrentProblem.pkMLProblemID = null;
    this.timerProblem.pause();
    this.data.currentProblemTotalTimeActive = false;
    this.data.currentProblemTime = 0;
    this.data.currentProblemTotalTime = null;
    this.updateSubject();
    this.sendToAll();
  }.bind(parent));
  $(document).on('pause.SWDlab pause.FSlab', function() {
    if (this.data.debug) {
      console.info('User idle');
      console.info(this);
    }
    this.pause();
  }.bind(parent));
  $(document).on('resume.SWDlab resume.FSlab', function() {
    if (this.data.debug) {
      console.info('User active');
    }
    this.resume();
  }.bind(parent));
};
$(document).ready(function() {
  var ReadAloudAbstract = function(defaultType = null) {
    var me = this;
    me.moduleId = 'mc';
    me.fallbackServicePath = (app.jsVars !== 'undefined' && app.jsVars.voiceURL !== 'undefined') ? app.jsVars.voiceURL : jsVars.voiceURL;
    me.voicesData = LabClass.prototype.responsiveVoice.voicesData;
    me.defaultType = (defaultType != null) ? defaultType : LabClass.prototype.responsiveVoice.defaultType;
    if (me.defaultType != 'polly') {
      responsiveVoice.setDefaultVoice("US English Female");
    }
    me.findMappedVoiceData = function(id, type) {
      return me.voicesData[type].filter(function(element) {
        return parseInt(element.id) === parseInt(id);
      });
    };
    me.getTextVoiceName = function(id) {
      return me.findMappedVoiceData(id, 'mappedNames')[0].awsValue;
    };
    me.getTextVoiceSpeed = function(id) {
      return me.findMappedVoiceData(id, 'mappedSpeeds')[0].awsValue;
    };
    me.voice = 'joanna';
    if (typeof app.jsVars !== 'undefined' && typeof app.jsVars.voiceName !== 'undefined') {
      me.voice = me.getTextVoiceName(app.jsVars.voiceName);
    } else if (typeof jsVars !== 'undefined' && typeof jsVars.voiceName !== 'undefined') {
      me.voice = me.getTextVoiceName(jsVars.voiceName);
    }
    me.speed = 'medium';
    if (typeof app.jsVars !== 'undefined' && typeof app.jsVars.voiceSpeed !== 'undefined') {
      me.speed = me.getTextVoiceSpeed(app.jsVars.voiceSpeed);
    } else if (typeof jsVars !== 'undefined' && typeof jsVars.voiceSpeed !== 'undefined') {
      me.speed = me.getTextVoiceSpeed(jsVars.voiceSpeed);
    }
    me.text = '';
    me.wrap = '';
    me.soundElement = null;
    me.init = function() {};
    me.stop = function() {
      if (me.defaultType == 'polly') {
        if (me.soundElement !== null && typeof me.soundElement == 'object') {
          me.soundElement.stop();
          $("[data-playing=true]").attr('data-playing', false);
        }
      } else {
        responsiveVoice.cancel();
        $("[data-playing=true]").attr('data-playing', false);
      }
    };
    me.read = function() {
      if (me.text == '') {
        return false;
      }
      if (me.wrap == '') {
        return false;
      }
      if (me.wrap.attr('data-playing') == 'true') {
        me.stop();
        return true;
      }
      $("[data-playing=true]").attr('data-playing', false);
      me.wrap.attr('data-playing', true);
      var isIOS = function() {
        if ((window.navigator.userAgent.toLowerCase().indexOf('ipad') > 0 || window.navigator.userAgent.toLowerCase().indexOf('iphone') > 0 || /iPad|iPhone|iPod/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) && window.navigator.userAgent.toLowerCase().indexOf('crios') < 0) {
          return true;
        }
        return false;
      };
      var isIOS8 = function() {
        var deviceAgent = navigator.userAgent.toLowerCase();
        return /(iphone|ipod|ipad).* os 8_/.test(deviceAgent);
      };
      var prepareText = function(text) {
        text = text.trim();
        text = text.replace(/([0-9]+),([0-9]+)/g, '$1$2');
        return encodeURIComponent(text);
      };
      if (soundManager.supported()) {
        soundManager.destroySound('aSound');
        var url = me.fallbackServicePath + '?t=' + prepareText(me.text);
        if (me.defaultType == 'polly') {
          url += '&apiType=polly&voice=' + me.voice + '&speed=' + me.speed + '&moduleId=' + me.moduleId;
          var oldDefaultType = LabClass.prototype.responsiveVoice.defaultType;
          var oldModuleId = LabClass.prototype.responsiveVoice.moduleId;
          LabClass.prototype.responsiveVoice.defaultType = me.defaultType;
          LabClass.prototype.responsiveVoice.moduleId = me.moduleId;
          var s3Url = LabClass.prototype.responsiveVoice.getS3Hash(url);
          LabClass.prototype.responsiveVoice.defaultType = oldDefaultType;
          LabClass.prototype.responsiveVoice.moduleId = oldModuleId;
          var soundProperties = {
            id: 'aSound',
            url: s3Url,
            onfinish: function() {
              me.stop();
            },
            autoLoad: true
          };
          me.soundElement = soundManager.createSound(soundProperties);
          var lastTry = false;
          var checkPromise = new Promise(function(resolve, reject) {
            var checkResponseInterval = setInterval(function() {
              if (me.soundElement.readyState == 2) {
                if (lastTry) {
                  clearInterval(checkResponseInterval);
                  reject();
                }
                me.soundElement.url = url;
                me.soundElement.load();
                lastTry = true;
              } else if (me.soundElement.readyState >= 3) {
                clearInterval(checkResponseInterval);
                resolve();
              }
            }, 10);
          });
          checkPromise.then(function() {
            me.soundElement.play();
          }).catch(function() {
            console.warn('Unable to load sound file.');
          });
        } else {
          url += '&apiType=fallback&tl=en-US&sv=&vn=&pitch=' + LabClass.prototype.responsiveVoice.defaultSpeakParams.fallback.pitch + '&rate=' + LabClass.prototype.responsiveVoice.defaultSpeakParams.fallback.rate + '&vol=' + LabClass.prototype.responsiveVoice.defaultSpeakParams.fallback.vol;
          me.soundElement = soundManager.createSound({
            id: 'aSound',
            url: url,
            onfinish: function() {
              me.stop();
            },
            autoLoad: true,
            autoPlay: true
          });
        }
      }
      me.text = '';
    };
    me.combineText = function(root) {
      var to_read = $(root).find('.readaloud-it');
      for (var i = 0, c = to_read.length; i < c; i++) {
        var temp_text = $(to_read[i]).text().trim();
        dot = temp_text.match(/[a-zA-Z0-9]$/) ? '. ' : '';
        this.text += temp_text + dot;
      }
    }
  };
  'use strict';
  var ReadAloudUniversal = function(selector, defaultType = null) {
    var that = new ReadAloudAbstract(defaultType);
    that.init = function() {
      $(document).on('click', selector, function() {
        var wrap = $(this);
        wrap.parents('.standard-dialog-blue').find('.blue-dialog-student-menu-arrow, .standard-dialog-blue-cross').click(function() {
          that.stop();
        });
        that.combineText(wrap.parent());
        that.wrap = wrap;
        that.read();
      });
    };
    return that;
  };
  var ReadAloudMessage = function() {
    var that = new ReadAloudAbstract('fallback');
    that.init = function() {
      $(document).on('click', '#read-aloud-messenger-message', function() {
        $(".standard-dialog-blue-cross, .message-navigation-previous, .message-navigation-next, .messenger-menu *").click(function() {
          that.stop();
        });
        var message = $("#messenger-message").clone();
        message.find("#read-aloud-messenger-message").remove();
        that.text = message.text();
        that.wrap = $("#read-aloud-messenger-message");
        that.read();
      });
    };
    return that;
  };
  var ReadAloudVibe = function() {
    return ReadAloudUniversal('.read-aloud-vibe', 'fallback');
  };
  var ReadAloudMessagePopup = function() {
    return ReadAloudUniversal('.read-aloud-message-popup', 'fallback');
  };
  var ReadAloudBadge = function() {
    var that = new ReadAloudAbstract('polly');
    that.init = function() {
      $(document).on('click', '.read-aloud-badge .ls-icon', function() {
        $(".standard-dialog-blue-cross").click(function() {
          that.stop();
        });
        that.text = $('.galaxyDetailDescription').text();
        that.wrap = $('.read-aloud-badge');
        that.read();
      });
    };
    return that;
  };
  new ReadAloudMessage().init();
  new ReadAloudVibe().init();
  new ReadAloudMessagePopup().init();
  new ReadAloudBadge().init();
});
if (typeof responsiveVoice != 'undefined') {
  console.log('ResponsiveVoice already loaded');
  console.log(responsiveVoice);
} else {
  var ResponsiveVoice = function() {
    var self = this;
    self.version = "1.5.0";
    console.log("ResponsiveVoice r" + self.version);
    self.responsivevoices = [{
      name: 'UK English Female',
      flag: 'gb',
      gender: 'f',
      voiceIDs: [3, 5, 1, 6, 7, 171, 201, 8]
    }, {
      name: 'UK English Male',
      flag: 'gb',
      gender: 'm',
      voiceIDs: [0, 4, 2, 75, 202, 159, 6, 7]
    }, {
      name: 'US English Female',
      flag: 'us',
      gender: 'f',
      voiceIDs: [39, 40, 41, 44]
    }, {
      name: 'Arabic Male',
      flag: 'ar',
      gender: 'm',
      voiceIDs: [96, 95, 97, 196, 98],
      deprecated: true
    }, {
      name: 'Arabic Female',
      flag: 'ar',
      gender: 'f',
      voiceIDs: [96, 95, 97, 196, 98]
    }, {
      name: 'Armenian Male',
      flag: 'hy',
      gender: 'f',
      voiceIDs: [99]
    }, {
      name: 'Australian Female',
      flag: 'au',
      gender: 'f',
      voiceIDs: [87, 86, 5, 201, 88]
    }, {
      name: 'Brazilian Portuguese Female',
      flag: 'br',
      gender: 'f',
      voiceIDs: [245, 124, 123, 125, 186, 223, 126]
    }, {
      name: 'Chinese Female',
      flag: 'cn',
      gender: 'f',
      voiceIDs: [249, 58, 59, 60, 155, 191, 231, 61]
    }, {
      name: 'Chinese (Hong Kong) Female',
      flag: 'hk',
      gender: 'f',
      voiceIDs: [192, 193, 232, 250, 251, 252]
    }, {
      name: 'Chinese Taiwan Female',
      flag: 'tw',
      gender: 'f',
      voiceIDs: [252, 194, 233, 253, 254, 255]
    }, {
      name: 'Czech Female',
      flag: 'cz',
      gender: 'f',
      voiceIDs: [101, 100, 102, 197, 103]
    }, {
      name: 'Danish Female',
      flag: 'dk',
      gender: 'f',
      voiceIDs: [105, 104, 106, 198, 107]
    }, {
      name: 'Deutsch Female',
      flag: 'de',
      gender: 'f',
      voiceIDs: [27, 28, 29, 30, 31, 78, 170, 199, 32]
    }, {
      name: 'Dutch Female',
      flag: 'nl',
      gender: 'f',
      voiceIDs: [243, 219, 84, 157, 158, 184, 45]
    }, {
      name: 'Finnish Female',
      flag: 'fi',
      gender: 'f',
      voiceIDs: [90, 89, 91, 209, 92]
    }, {
      name: 'French Female',
      flag: 'fr',
      gender: 'f',
      voiceIDs: [240, 21, 22, 23, 77, 178, 210, 26]
    }, {
      name: 'Greek Female',
      flag: 'gr',
      gender: 'f',
      voiceIDs: [62, 63, 80, 200, 64]
    }, {
      name: 'Hatian Creole Female',
      flag: 'ht',
      gender: 'f',
      voiceIDs: [109]
    }, {
      name: 'Hindi Female',
      flag: 'hi',
      gender: 'f',
      voiceIDs: [247, 66, 154, 179, 213, 67]
    }, {
      name: 'Hungarian Female',
      flag: 'hu',
      gender: 'f',
      voiceIDs: [9, 10, 81, 214, 11]
    }, {
      name: 'Indonesian Female',
      flag: 'id',
      gender: 'f',
      voiceIDs: [241, 111, 112, 180, 215, 113]
    }, {
      name: 'Italian Female',
      flag: 'it',
      gender: 'f',
      voiceIDs: [242, 33, 34, 35, 36, 37, 79, 181, 216, 38]
    }, {
      name: 'Japanese Female',
      flag: 'jp',
      gender: 'f',
      voiceIDs: [248, 50, 51, 52, 153, 182, 217, 53]
    }, {
      name: 'Korean Female',
      flag: 'kr',
      gender: 'f',
      voiceIDs: [54, 55, 56, 156, 183, 218, 57]
    }, {
      name: 'Latin Female',
      flag: 'va',
      gender: 'f',
      voiceIDs: [114]
    }, {
      name: 'Norwegian Female',
      flag: 'no',
      gender: 'f',
      voiceIDs: [72, 73, 221, 74]
    }, {
      name: 'Polish Female',
      flag: 'pl',
      gender: 'f',
      voiceIDs: [244, 120, 119, 121, 185, 222, 122]
    }, {
      name: 'Portuguese Female',
      flag: 'br',
      gender: 'f',
      voiceIDs: [128, 127, 129, 187, 224, 130]
    }, {
      name: 'Romanian Male',
      flag: 'ro',
      gender: 'm',
      voiceIDs: [151, 150, 152, 225, 46]
    }, {
      name: 'Russian Female',
      flag: 'ru',
      gender: 'f',
      voiceIDs: [246, 47, 48, 83, 188, 226, 49]
    }, {
      name: 'Slovak Female',
      flag: 'sk',
      gender: 'f',
      voiceIDs: [133, 132, 134, 227, 135]
    }, {
      name: 'Spanish Female',
      flag: 'es',
      gender: 'f',
      voiceIDs: [19, 238, 16, 17, 18, 20, 76, 174, 207, 15]
    }, {
      name: 'Spanish Latin American Female',
      flag: 'es',
      gender: 'f',
      voiceIDs: [239, 137, 136, 138, 175, 208, 139]
    }, {
      name: 'Swedish Female',
      flag: 'sv',
      gender: 'f',
      voiceIDs: [85, 148, 149, 228, 65]
    }, {
      name: 'Tamil Male',
      flag: 'hi',
      gender: 'm',
      voiceIDs: [141]
    }, {
      name: 'Thai Female',
      flag: 'th',
      gender: 'f',
      voiceIDs: [143, 142, 144, 189, 229, 145]
    }, {
      name: 'Turkish Female',
      flag: 'tr',
      gender: 'f',
      voiceIDs: [69, 70, 82, 190, 230, 71]
    }, {
      name: 'Afrikaans Male',
      flag: 'af',
      gender: 'm',
      voiceIDs: [93]
    }, {
      name: 'Albanian Male',
      flag: 'sq',
      gender: 'm',
      voiceIDs: [94]
    }, {
      name: 'Bosnian Male',
      flag: 'bs',
      gender: 'm',
      voiceIDs: [14]
    }, {
      name: 'Catalan Male',
      flag: 'catalonia',
      gender: 'm',
      voiceIDs: [68]
    }, {
      name: 'Croatian Male',
      flag: 'hr',
      gender: 'm',
      voiceIDs: [13]
    }, {
      name: 'Czech Male',
      flag: 'cz',
      gender: 'm',
      voiceIDs: [161]
    }, {
      name: 'Danish Male',
      flag: 'da',
      gender: 'm',
      voiceIDs: [162],
      deprecated: true
    }, {
      name: 'Esperanto Male',
      flag: 'eo',
      gender: 'm',
      voiceIDs: [108]
    }, {
      name: 'Finnish Male',
      flag: 'fi',
      gender: 'm',
      voiceIDs: [160],
      deprecated: true
    }, {
      name: 'Greek Male',
      flag: 'gr',
      gender: 'm',
      voiceIDs: [163],
      deprecated: true
    }, {
      name: 'Hungarian Male',
      flag: 'hu',
      gender: 'm',
      voiceIDs: [164]
    }, {
      name: 'Icelandic Male',
      flag: 'is',
      gender: 'm',
      voiceIDs: [110]
    }, {
      name: 'Latin Male',
      flag: 'va',
      gender: 'm',
      voiceIDs: [165],
      deprecated: true
    }, {
      name: 'Latvian Male',
      flag: 'lv',
      gender: 'm',
      voiceIDs: [115]
    }, {
      name: 'Macedonian Male',
      flag: 'mk',
      gender: 'm',
      voiceIDs: [116]
    }, {
      name: 'Moldavian Male',
      flag: 'md',
      gender: 'm',
      voiceIDs: [117]
    }, {
      name: 'Montenegrin Male',
      flag: 'me',
      gender: 'm',
      voiceIDs: [118]
    }, {
      name: 'Norwegian Male',
      flag: 'no',
      gender: 'm',
      voiceIDs: [166]
    }, {
      name: 'Serbian Male',
      flag: 'sr',
      gender: 'm',
      voiceIDs: [12]
    }, {
      name: 'Serbo-Croatian Male',
      flag: 'hr',
      gender: 'm',
      voiceIDs: [131]
    }, {
      name: 'Slovak Male',
      flag: 'sk',
      gender: 'm',
      voiceIDs: [167],
      deprecated: true
    }, {
      name: 'Swahili Male',
      flag: 'sw',
      gender: 'm',
      voiceIDs: [140]
    }, {
      name: 'Swedish Male',
      flag: 'sv',
      gender: 'm',
      voiceIDs: [168],
      deprecated: true
    }, {
      name: 'Vietnamese Male',
      flag: 'vi',
      gender: 'm',
      voiceIDs: [146],
      deprecated: true
    }, {
      name: 'Welsh Male',
      flag: 'cy',
      gender: 'm',
      voiceIDs: [147]
    }, {
      name: 'US English Male',
      flag: 'us',
      gender: 'm',
      voiceIDs: [0, 4, 2, 6, 7, 75, 159, 234, 236, 237]
    }, {
      name: 'Fallback UK Female',
      flag: 'gb',
      gender: 'f',
      voiceIDs: [8]
    }, {
      name: 'US English Female ERT',
      flag: 'us',
      gender: 'f',
      voiceIDs: [39, 40, 41, 42, 43, 173, 205, 204, 235, 44]
    }, ];
    self.voicecollection = [{
      name: 'Google UK English Male'
    }, {
      name: 'Agnes'
    }, {
      name: 'Daniel Compact'
    }, {
      name: 'Google UK English Female'
    }, {
      name: 'en-GB',
      rate: 0.25,
      pitch: 1
    }, {
      name: 'en-AU',
      rate: 0.25,
      pitch: 1
    }, {
      name: 'inglés Reino Unido'
    }, {
      name: 'English United Kingdom'
    }, {
      name: 'Fallback en-GB Female',
      lang: 'en-GB',
      fallbackvoice: true
    }, {
      name: 'Eszter Compact'
    }, {
      name: 'hu-HU',
      rate: 0.4
    }, {
      name: 'Fallback Hungarian',
      lang: 'hu',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Fallback Serbian',
      lang: 'sr',
      fallbackvoice: true
    }, {
      name: 'Fallback Croatian',
      lang: 'hr',
      fallbackvoice: true
    }, {
      name: 'Fallback Bosnian',
      lang: 'bs',
      fallbackvoice: true
    }, {
      name: 'Fallback Spanish',
      lang: 'es',
      fallbackvoice: true
    }, {
      name: 'Spanish Spain'
    }, {
      name: 'español España'
    }, {
      name: 'Diego Compact',
      rate: 0.3
    }, {
      name: 'Google Español'
    }, {
      name: 'es-ES',
      rate: 0.20
    }, {
      name: 'Google Français'
    }, {
      name: 'French France'
    }, {
      name: 'francés Francia'
    }, {
      name: 'Virginie Compact',
      rate: 0.5
    }, {
      name: 'fr-FR',
      rate: 0.25
    }, {
      name: 'Fallback French',
      lang: 'fr',
      fallbackvoice: true
    }, {
      name: 'Google Deutsch'
    }, {
      name: 'German Germany'
    }, {
      name: 'alemán Alemania'
    }, {
      name: 'Yannick Compact',
      rate: 0.5
    }, {
      name: 'de-DE',
      rate: 0.25
    }, {
      name: 'Fallback Deutsch',
      lang: 'de',
      fallbackvoice: true
    }, {
      name: 'Google Italiano'
    }, {
      name: 'Italian Italy'
    }, {
      name: 'italiano Italia'
    }, {
      name: 'Paolo Compact',
      rate: 0.5
    }, {
      name: 'it-IT',
      rate: 0.25
    }, {
      name: 'Fallback Italian',
      lang: 'it',
      fallbackvoice: true
    }, {
      name: 'Google US English',
      timerSpeed: 1
    }, {
      name: 'English United States'
    }, {
      name: 'inglés Estados Unidos'
    }, {
      name: 'Vicki'
    }, {
      name: 'en-US',
      rate: 0.2,
      pitch: 1,
      timerSpeed: 1.3
    }, {
      name: 'Fallback English',
      lang: 'en-US',
      fallbackvoice: true,
      timerSpeed: 0
    }, {
      name: 'Fallback Dutch',
      lang: 'nl',
      fallbackvoice: true,
      timerSpeed: 0
    }, {
      name: 'Fallback Romanian',
      lang: 'ro',
      fallbackvoice: true
    }, {
      name: 'Milena Compact'
    }, {
      name: 'ru-RU',
      rate: 0.25
    }, {
      name: 'Fallback Russian',
      lang: 'ru',
      fallbackvoice: true
    }, {
      name: 'Google 日本人',
      timerSpeed: 1
    }, {
      name: 'Kyoko Compact'
    }, {
      name: 'ja-JP',
      rate: 0.25
    }, {
      name: 'Fallback Japanese',
      lang: 'ja',
      fallbackvoice: true
    }, {
      name: 'Google 한국의',
      timerSpeed: 1
    }, {
      name: 'Narae Compact'
    }, {
      name: 'ko-KR',
      rate: 0.25
    }, {
      name: 'Fallback Korean',
      lang: 'ko',
      fallbackvoice: true
    }, {
      name: 'Google 中国的',
      timerSpeed: 1
    }, {
      name: 'Ting-Ting Compact'
    }, {
      name: 'zh-CN',
      rate: 0.25
    }, {
      name: 'Fallback Chinese',
      lang: 'zh-CN',
      fallbackvoice: true
    }, {
      name: 'Alexandros Compact'
    }, {
      name: 'el-GR',
      rate: 0.25
    }, {
      name: 'Fallback Greek',
      lang: 'el',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Fallback Swedish',
      lang: 'sv',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'hi-IN',
      rate: 0.25
    }, {
      name: 'Fallback Hindi',
      lang: 'hi',
      fallbackvoice: true
    }, {
      name: 'Fallback Catalan',
      lang: 'ca',
      fallbackvoice: true
    }, {
      name: 'Aylin Compact'
    }, {
      name: 'tr-TR',
      rate: 0.25
    }, {
      name: 'Fallback Turkish',
      lang: 'tr',
      fallbackvoice: true
    }, {
      name: 'Stine Compact'
    }, {
      name: 'no-NO',
      rate: 0.25
    }, {
      name: 'Fallback Norwegian',
      lang: 'no',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Daniel'
    }, {
      name: 'Monica'
    }, {
      name: 'Amelie'
    }, {
      name: 'Anna'
    }, {
      name: 'Alice'
    }, {
      name: 'Melina'
    }, {
      name: 'Mariska'
    }, {
      name: 'Yelda'
    }, {
      name: 'Milena'
    }, {
      name: 'Xander'
    }, {
      name: 'Alva'
    }, {
      name: 'Lee Compact'
    }, {
      name: 'Karen'
    }, {
      name: 'Fallback Australian',
      lang: 'en-AU',
      fallbackvoice: true
    }, {
      name: 'Mikko Compact'
    }, {
      name: 'Satu'
    }, {
      name: 'fi-FI',
      rate: 0.25
    }, {
      name: 'Fallback Finnish',
      lang: 'fi',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Fallback Afrikans',
      lang: 'af',
      fallbackvoice: true
    }, {
      name: 'Fallback Albanian',
      lang: 'sq',
      fallbackvoice: true
    }, {
      name: 'Maged Compact'
    }, {
      name: 'Tarik'
    }, {
      name: 'ar-SA',
      rate: 0.25
    }, {
      name: 'Fallback Arabic',
      lang: 'ar',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Fallback Armenian',
      lang: 'hy',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Zuzana Compact'
    }, {
      name: 'Zuzana'
    }, {
      name: 'cs-CZ',
      rate: 0.25
    }, {
      name: 'Fallback Czech',
      lang: 'cs',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Ida Compact'
    }, {
      name: 'Sara'
    }, {
      name: 'da-DK',
      rate: 0.25
    }, {
      name: 'Fallback Danish',
      lang: 'da',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Fallback Esperanto',
      lang: 'eo',
      fallbackvoice: true
    }, {
      name: 'Fallback Hatian Creole',
      lang: 'ht',
      fallbackvoice: true
    }, {
      name: 'Fallback Icelandic',
      lang: 'is',
      fallbackvoice: true
    }, {
      name: 'Damayanti'
    }, {
      name: 'id-ID',
      rate: 0.25
    }, {
      name: 'Fallback Indonesian',
      lang: 'id',
      fallbackvoice: true
    }, {
      name: 'Fallback Latin',
      lang: 'la',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Fallback Latvian',
      lang: 'lv',
      fallbackvoice: true
    }, {
      name: 'Fallback Macedonian',
      lang: 'mk',
      fallbackvoice: true
    }, {
      name: 'Fallback Moldavian',
      lang: 'mo',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Fallback Montenegrin',
      lang: 'sr-ME',
      fallbackvoice: true
    }, {
      name: 'Agata Compact'
    }, {
      name: 'Zosia'
    }, {
      name: 'pl-PL',
      rate: 0.25
    }, {
      name: 'Fallback Polish',
      lang: 'pl',
      fallbackvoice: true
    }, {
      name: 'Raquel Compact'
    }, {
      name: 'Luciana'
    }, {
      name: 'pt-BR',
      rate: 0.25
    }, {
      name: 'Fallback Brazilian Portugese',
      lang: 'pt-BR',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Joana Compact'
    }, {
      name: 'Joana'
    }, {
      name: 'pt-PT',
      rate: 0.25
    }, {
      name: 'Fallback Portuguese',
      lang: 'pt-PT',
      fallbackvoice: true
    }, {
      name: 'Fallback Serbo-Croation',
      lang: 'sh',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Laura Compact'
    }, {
      name: 'Laura'
    }, {
      name: 'sk-SK',
      rate: 0.25
    }, {
      name: 'Fallback Slovak',
      lang: 'sk',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Javier Compact'
    }, {
      name: 'Paulina'
    }, {
      name: 'es-MX',
      rate: 0.25
    }, {
      name: 'Fallback Spanish (Latin American)',
      lang: 'es-419',
      fallbackvoice: true,
      service: 'g2'
    }, {
      name: 'Fallback Swahili',
      lang: 'sw',
      fallbackvoice: true
    }, {
      name: 'Fallback Tamil',
      lang: 'ta',
      fallbackvoice: true
    }, {
      name: 'Narisa Compact'
    }, {
      name: 'Kanya'
    }, {
      name: 'th-TH',
      rate: 0.25
    }, {
      name: 'Fallback Thai',
      lang: 'th',
      fallbackvoice: true
    }, {
      name: 'Fallback Vietnamese',
      lang: 'vi',
      fallbackvoice: true
    }, {
      name: 'Fallback Welsh',
      lang: 'cy',
      fallbackvoice: true
    }, {
      name: 'Oskar Compact'
    }, {
      name: 'sv-SE',
      rate: 0.25
    }, {
      name: 'Simona Compact'
    }, {
      name: 'Ioana'
    }, {
      name: 'ro-RO',
      rate: 0.25
    }, {
      name: 'Kyoko'
    }, {
      name: 'Lekha'
    }, {
      name: 'Ting-Ting'
    }, {
      name: 'Yuna'
    }, {
      name: 'Xander Compact'
    }, {
      name: 'nl-NL',
      rate: 0.25
    }, {
      name: 'Fallback UK English Male',
      lang: 'en-GB',
      fallbackvoice: true,
      service: 'g1',
      voicename: 'rjs'
    }, {
      name: 'Finnish Male',
      lang: 'fi',
      fallbackvoice: true,
      service: 'g1',
      voicename: ''
    }, {
      name: 'Czech Male',
      lang: 'cs',
      fallbackvoice: true,
      service: 'g1',
      voicename: ''
    }, {
      name: 'Danish Male',
      lang: 'da',
      fallbackvoice: true,
      service: 'g1',
      voicename: ''
    }, {
      name: 'Greek Male',
      lang: 'el',
      fallbackvoice: true,
      service: 'g1',
      voicename: '',
      rate: 0.25
    }, {
      name: 'Hungarian Male',
      lang: 'hu',
      fallbackvoice: true,
      service: 'g1',
      voicename: ''
    }, {
      name: 'Latin Male',
      lang: 'la',
      fallbackvoice: true,
      service: 'g1',
      voicename: ''
    }, {
      name: 'Norwegian Male',
      lang: 'no',
      fallbackvoice: true,
      service: 'g1',
      voicename: ''
    }, {
      name: 'Slovak Male',
      lang: 'sk',
      fallbackvoice: true,
      service: 'g1',
      voicename: ''
    }, {
      name: 'Swedish Male',
      lang: 'sv',
      fallbackvoice: true,
      service: 'g1',
      voicename: ''
    }, {
      name: 'Fallback US English Male',
      lang: 'en',
      fallbackvoice: true,
      service: 'tts-api',
      voicename: ''
    }, {
      name: 'German Germany',
      lang: 'de_DE'
    }, {
      name: 'English United Kingdom',
      lang: 'en_GB'
    }, {
      name: 'English India',
      lang: 'en_IN'
    }, {
      name: 'English United States',
      lang: 'en_US'
    }, {
      name: 'Spanish Spain',
      lang: 'es_ES'
    }, {
      name: 'Spanish Mexico',
      lang: 'es_MX'
    }, {
      name: 'Spanish United States',
      lang: 'es_US'
    }, {
      name: 'French Belgium',
      lang: 'fr_BE'
    }, {
      name: 'French France',
      lang: 'fr_FR'
    }, {
      name: 'Hindi India',
      lang: 'hi_IN'
    }, {
      name: 'Indonesian Indonesia',
      lang: 'in_ID'
    }, {
      name: 'Italian Italy',
      lang: 'it_IT'
    }, {
      name: 'Japanese Japan',
      lang: 'ja_JP'
    }, {
      name: 'Korean South Korea',
      lang: 'ko_KR'
    }, {
      name: 'Dutch Netherlands',
      lang: 'nl_NL'
    }, {
      name: 'Polish Poland',
      lang: 'pl_PL'
    }, {
      name: 'Portuguese Brazil',
      lang: 'pt_BR'
    }, {
      name: 'Portuguese Portugal',
      lang: 'pt_PT'
    }, {
      name: 'Russian Russia',
      lang: 'ru_RU'
    }, {
      name: 'Thai Thailand',
      lang: 'th_TH'
    }, {
      name: 'Turkish Turkey',
      lang: 'tr_TR'
    }, {
      name: 'Chinese China',
      lang: 'zh_CN_#Hans'
    }, {
      name: 'Chinese Hong Kong',
      lang: 'zh_HK_#Hans'
    }, {
      name: 'Chinese Hong Kong',
      lang: 'zh_HK_#Hant'
    }, {
      name: 'Chinese Taiwan',
      lang: 'zh_TW_#Hant'
    }, {
      name: 'Alex'
    }, {
      name: 'Maged',
      lang: 'ar-SA'
    }, {
      name: 'Zuzana',
      lang: 'cs-CZ'
    }, {
      name: 'Sara',
      lang: 'da-DK'
    }, {
      name: 'Anna',
      lang: 'de-DE'
    }, {
      name: 'Melina',
      lang: 'el-GR'
    }, {
      name: 'Karen',
      lang: 'en-AU'
    }, {
      name: 'Daniel',
      lang: 'en-GB'
    }, {
      name: 'Moira',
      lang: 'en-IE'
    }, {
      name: 'Samantha (Enhanced)',
      lang: 'en-US'
    }, {
      name: 'Samantha',
      lang: 'en-US'
    }, {
      name: 'Tessa',
      lang: 'en-ZA'
    }, {
      name: 'Monica',
      lang: 'es-ES'
    }, {
      name: 'Paulina',
      lang: 'es-MX'
    }, {
      name: 'Satu',
      lang: 'fi-FI'
    }, {
      name: 'Amelie',
      lang: 'fr-CA'
    }, {
      name: 'Thomas',
      lang: 'fr-FR'
    }, {
      name: 'Carmit',
      lang: 'he-IL'
    }, {
      name: 'Lekha',
      lang: 'hi-IN'
    }, {
      name: 'Mariska',
      lang: 'hu-HU'
    }, {
      name: 'Damayanti',
      lang: 'id-ID'
    }, {
      name: 'Alice',
      lang: 'it-IT'
    }, {
      name: 'Kyoko',
      lang: 'ja-JP'
    }, {
      name: 'Yuna',
      lang: 'ko-KR'
    }, {
      name: 'Ellen',
      lang: 'nl-BE'
    }, {
      name: 'Xander',
      lang: 'nl-NL'
    }, {
      name: 'Nora',
      lang: 'no-NO'
    }, {
      name: 'Zosia',
      lang: 'pl-PL'
    }, {
      name: 'Luciana',
      lang: 'pt-BR'
    }, {
      name: 'Joana',
      lang: 'pt-PT'
    }, {
      name: 'Ioana',
      lang: 'ro-RO'
    }, {
      name: 'Milena',
      lang: 'ru-RU'
    }, {
      name: 'Laura',
      lang: 'sk-SK'
    }, {
      name: 'Alva',
      lang: 'sv-SE'
    }, {
      name: 'Kanya',
      lang: 'th-TH'
    }, {
      name: 'Yelda',
      lang: 'tr-TR'
    }, {
      name: 'Ting-Ting',
      lang: 'zh-CN'
    }, {
      name: 'Sin-Ji',
      lang: 'zh-HK'
    }, {
      name: 'Mei-Jia',
      lang: 'zh-TW'
    }, {
      name: 'Microsoft David Mobile - English (United States)',
      lang: 'en-US'
    }, {
      name: 'Microsoft Zira Mobile - English (United States)',
      lang: 'en-US'
    }, {
      name: 'Microsoft Mark Mobile - English (United States)',
      lang: 'en-US'
    }, {
      name: 'native',
      lang: ''
    }, {
      name: 'Google español'
    }, {
      name: 'Google español de Estados Unidos'
    }, {
      name: 'Google français'
    }, {
      name: 'Google Bahasa Indonesia'
    }, {
      name: 'Google italiano'
    }, {
      name: 'Google Nederlands'
    }, {
      name: 'Google polski'
    }, {
      name: 'Google português do Brasil'
    }, {
      name: 'Google русский'
    }, {
      name: 'Google हिन्दी'
    }, {
      name: 'Google 日本語'
    }, {
      name: 'Google 普通话（中国大陆）'
    }, {
      name: 'Google 粤語（香港）'
    }, {
      name: 'zh-HK',
      rate: 0.25
    }, {
      name: 'Fallback Chinese (Hong Kong) Female',
      lang: 'zh-HK',
      fallbackvoice: true,
      service: 'g1'
    }, {
      name: 'Google 粤語（香港）'
    }, {
      name: 'zh-TW',
      rate: 0.25
    }, {
      name: 'Fallback Chinese (Taiwan) Female',
      lang: 'zh-TW',
      fallbackvoice: true,
      service: 'g1'
    }];
    self.iOS = /(iPad|iPhone|iPod)/g.test(navigator.userAgent) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
    self.iOS9 = /(iphone|ipod|ipad).* os 9_/.test(navigator.userAgent.toLowerCase()) || /(iphone|ipod|ipad).* os 10_/.test(navigator.userAgent.toLowerCase());
    self.is_chrome = navigator.userAgent.indexOf('Chrome') > -1;
    self.is_safari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if ((self.is_chrome) && (self.is_safari)) {
      self.is_safari = false;
    }
    self.is_opera = !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
    self.is_android = navigator.userAgent.toLowerCase().indexOf("android") > -1;
    self.iOS_initialized = false;
    self.iOS9_initialized = false;
    self.cache_ios_voices = [{
      "name": "he-IL",
      "voiceURI": "he-IL",
      "lang": "he-IL"
    }, {
      "name": "th-TH",
      "voiceURI": "th-TH",
      "lang": "th-TH"
    }, {
      "name": "pt-BR",
      "voiceURI": "pt-BR",
      "lang": "pt-BR"
    }, {
      "name": "sk-SK",
      "voiceURI": "sk-SK",
      "lang": "sk-SK"
    }, {
      "name": "fr-CA",
      "voiceURI": "fr-CA",
      "lang": "fr-CA"
    }, {
      "name": "ro-RO",
      "voiceURI": "ro-RO",
      "lang": "ro-RO"
    }, {
      "name": "no-NO",
      "voiceURI": "no-NO",
      "lang": "no-NO"
    }, {
      "name": "fi-FI",
      "voiceURI": "fi-FI",
      "lang": "fi-FI"
    }, {
      "name": "pl-PL",
      "voiceURI": "pl-PL",
      "lang": "pl-PL"
    }, {
      "name": "de-DE",
      "voiceURI": "de-DE",
      "lang": "de-DE"
    }, {
      "name": "nl-NL",
      "voiceURI": "nl-NL",
      "lang": "nl-NL"
    }, {
      "name": "id-ID",
      "voiceURI": "id-ID",
      "lang": "id-ID"
    }, {
      "name": "tr-TR",
      "voiceURI": "tr-TR",
      "lang": "tr-TR"
    }, {
      "name": "it-IT",
      "voiceURI": "it-IT",
      "lang": "it-IT"
    }, {
      "name": "pt-PT",
      "voiceURI": "pt-PT",
      "lang": "pt-PT"
    }, {
      "name": "fr-FR",
      "voiceURI": "fr-FR",
      "lang": "fr-FR"
    }, {
      "name": "ru-RU",
      "voiceURI": "ru-RU",
      "lang": "ru-RU"
    }, {
      "name": "es-MX",
      "voiceURI": "es-MX",
      "lang": "es-MX"
    }, {
      "name": "zh-HK",
      "voiceURI": "zh-HK",
      "lang": "zh-HK"
    }, {
      "name": "sv-SE",
      "voiceURI": "sv-SE",
      "lang": "sv-SE"
    }, {
      "name": "hu-HU",
      "voiceURI": "hu-HU",
      "lang": "hu-HU"
    }, {
      "name": "zh-TW",
      "voiceURI": "zh-TW",
      "lang": "zh-TW"
    }, {
      "name": "es-ES",
      "voiceURI": "es-ES",
      "lang": "es-ES"
    }, {
      "name": "zh-CN",
      "voiceURI": "zh-CN",
      "lang": "zh-CN"
    }, {
      "name": "nl-BE",
      "voiceURI": "nl-BE",
      "lang": "nl-BE"
    }, {
      "name": "en-GB",
      "voiceURI": "en-GB",
      "lang": "en-GB"
    }, {
      "name": "ar-SA",
      "voiceURI": "ar-SA",
      "lang": "ar-SA"
    }, {
      "name": "ko-KR",
      "voiceURI": "ko-KR",
      "lang": "ko-KR"
    }, {
      "name": "cs-CZ",
      "voiceURI": "cs-CZ",
      "lang": "cs-CZ"
    }, {
      "name": "en-ZA",
      "voiceURI": "en-ZA",
      "lang": "en-ZA"
    }, {
      "name": "en-AU",
      "voiceURI": "en-AU",
      "lang": "en-AU"
    }, {
      "name": "da-DK",
      "voiceURI": "da-DK",
      "lang": "da-DK"
    }, {
      "name": "en-US",
      "voiceURI": "en-US",
      "lang": "en-US"
    }, {
      "name": "en-IE",
      "voiceURI": "en-IE",
      "lang": "en-IE"
    }, {
      "name": "hi-IN",
      "voiceURI": "hi-IN",
      "lang": "hi-IN"
    }, {
      "name": "el-GR",
      "voiceURI": "el-GR",
      "lang": "el-GR"
    }, {
      "name": "ja-JP",
      "voiceURI": "ja-JP",
      "lang": "ja-JP"
    }];
    self.cache_ios9_voices = [{
      name: "Maged",
      voiceURI: "com.apple.ttsbundle.Maged-compact",
      lang: "ar-SA",
      localService: !0,
      "default": !0
    }, {
      name: "Zuzana",
      voiceURI: "com.apple.ttsbundle.Zuzana-compact",
      lang: "cs-CZ",
      localService: !0,
      "default": !0
    }, {
      name: "Sara",
      voiceURI: "com.apple.ttsbundle.Sara-compact",
      lang: "da-DK",
      localService: !0,
      "default": !0
    }, {
      name: "Anna",
      voiceURI: "com.apple.ttsbundle.Anna-compact",
      lang: "de-DE",
      localService: !0,
      "default": !0
    }, {
      name: "Melina",
      voiceURI: "com.apple.ttsbundle.Melina-compact",
      lang: "el-GR",
      localService: !0,
      "default": !0
    }, {
      name: "Karen",
      voiceURI: "com.apple.ttsbundle.Karen-compact",
      lang: "en-AU",
      localService: !0,
      "default": !0
    }, {
      name: "Daniel",
      voiceURI: "com.apple.ttsbundle.Daniel-compact",
      lang: "en-GB",
      localService: !0,
      "default": !0
    }, {
      name: "Moira",
      voiceURI: "com.apple.ttsbundle.Moira-compact",
      lang: "en-IE",
      localService: !0,
      "default": !0
    }, {
      name: "Samantha (Enhanced)",
      voiceURI: "com.apple.ttsbundle.Samantha-premium",
      lang: "en-US",
      localService: !0,
      "default": !0
    }, {
      name: "Samantha",
      voiceURI: "com.apple.ttsbundle.Samantha-compact",
      lang: "en-US",
      localService: !0,
      "default": !0
    }, {
      name: "Tessa",
      voiceURI: "com.apple.ttsbundle.Tessa-compact",
      lang: "en-ZA",
      localService: !0,
      "default": !0
    }, {
      name: "Monica",
      voiceURI: "com.apple.ttsbundle.Monica-compact",
      lang: "es-ES",
      localService: !0,
      "default": !0
    }, {
      name: "Paulina",
      voiceURI: "com.apple.ttsbundle.Paulina-compact",
      lang: "es-MX",
      localService: !0,
      "default": !0
    }, {
      name: "Satu",
      voiceURI: "com.apple.ttsbundle.Satu-compact",
      lang: "fi-FI",
      localService: !0,
      "default": !0
    }, {
      name: "Amelie",
      voiceURI: "com.apple.ttsbundle.Amelie-compact",
      lang: "fr-CA",
      localService: !0,
      "default": !0
    }, {
      name: "Thomas",
      voiceURI: "com.apple.ttsbundle.Thomas-compact",
      lang: "fr-FR",
      localService: !0,
      "default": !0
    }, {
      name: "Carmit",
      voiceURI: "com.apple.ttsbundle.Carmit-compact",
      lang: "he-IL",
      localService: !0,
      "default": !0
    }, {
      name: "Lekha",
      voiceURI: "com.apple.ttsbundle.Lekha-compact",
      lang: "hi-IN",
      localService: !0,
      "default": !0
    }, {
      name: "Mariska",
      voiceURI: "com.apple.ttsbundle.Mariska-compact",
      lang: "hu-HU",
      localService: !0,
      "default": !0
    }, {
      name: "Damayanti",
      voiceURI: "com.apple.ttsbundle.Damayanti-compact",
      lang: "id-ID",
      localService: !0,
      "default": !0
    }, {
      name: "Alice",
      voiceURI: "com.apple.ttsbundle.Alice-compact",
      lang: "it-IT",
      localService: !0,
      "default": !0
    }, {
      name: "Kyoko",
      voiceURI: "com.apple.ttsbundle.Kyoko-compact",
      lang: "ja-JP",
      localService: !0,
      "default": !0
    }, {
      name: "Yuna",
      voiceURI: "com.apple.ttsbundle.Yuna-compact",
      lang: "ko-KR",
      localService: !0,
      "default": !0
    }, {
      name: "Ellen",
      voiceURI: "com.apple.ttsbundle.Ellen-compact",
      lang: "nl-BE",
      localService: !0,
      "default": !0
    }, {
      name: "Xander",
      voiceURI: "com.apple.ttsbundle.Xander-compact",
      lang: "nl-NL",
      localService: !0,
      "default": !0
    }, {
      name: "Nora",
      voiceURI: "com.apple.ttsbundle.Nora-compact",
      lang: "no-NO",
      localService: !0,
      "default": !0
    }, {
      name: "Zosia",
      voiceURI: "com.apple.ttsbundle.Zosia-compact",
      lang: "pl-PL",
      localService: !0,
      "default": !0
    }, {
      name: "Luciana",
      voiceURI: "com.apple.ttsbundle.Luciana-compact",
      lang: "pt-BR",
      localService: !0,
      "default": !0
    }, {
      name: "Joana",
      voiceURI: "com.apple.ttsbundle.Joana-compact",
      lang: "pt-PT",
      localService: !0,
      "default": !0
    }, {
      name: "Ioana",
      voiceURI: "com.apple.ttsbundle.Ioana-compact",
      lang: "ro-RO",
      localService: !0,
      "default": !0
    }, {
      name: "Milena",
      voiceURI: "com.apple.ttsbundle.Milena-compact",
      lang: "ru-RU",
      localService: !0,
      "default": !0
    }, {
      name: "Laura",
      voiceURI: "com.apple.ttsbundle.Laura-compact",
      lang: "sk-SK",
      localService: !0,
      "default": !0
    }, {
      name: "Alva",
      voiceURI: "com.apple.ttsbundle.Alva-compact",
      lang: "sv-SE",
      localService: !0,
      "default": !0
    }, {
      name: "Kanya",
      voiceURI: "com.apple.ttsbundle.Kanya-compact",
      lang: "th-TH",
      localService: !0,
      "default": !0
    }, {
      name: "Yelda",
      voiceURI: "com.apple.ttsbundle.Yelda-compact",
      lang: "tr-TR",
      localService: !0,
      "default": !0
    }, {
      name: "Ting-Ting",
      voiceURI: "com.apple.ttsbundle.Ting-Ting-compact",
      lang: "zh-CN",
      localService: !0,
      "default": !0
    }, {
      name: "Sin-Ji",
      voiceURI: "com.apple.ttsbundle.Sin-Ji-compact",
      lang: "zh-HK",
      localService: !0,
      "default": !0
    }, {
      name: "Mei-Jia",
      voiceURI: "com.apple.ttsbundle.Mei-Jia-compact",
      lang: "zh-TW",
      localService: !0,
      "default": !0
    }];
    self.systemvoices = null;
    self.CHARACTER_LIMIT = 200;
    self.VOICESUPPORT_ATTEMPTLIMIT = 5;
    self.voicesupport_attempts = 0;
    self.fallbackMode = false;
    self.WORDS_PER_MINUTE = 130;
    self.fallback_parts = null;
    self.fallback_parts_urls = null;
    self.fallback_part_index = 0;
    self.fallback_audio = null;
    self.fallback_audio_url = null;
    self.fallback_playbackrate = 1;
    self.def_fallback_playbackrate = self.fallback_playbackrate;
    self.fallback_audiopool = [];
    self.fallback_audiopool_urls = [];
    self.msgparameters = null;
    self.timeoutId = null;
    self.OnLoad_callbacks = [];
    self.useTimer = false;
    self.utterances = [];
    self.tstCompiled = function(xy) {
      xy = 0;
      return eval("typeof x" + "y === 'undefined'");
    }
    self.fallbackServicePath = 'https://tts.mobymax.com/ResponsiveVoice/getvoice.php';
    self.default_rv = self.responsivevoices[0];
    self.debug = false;
    self.log = function(log) {
      if (self.debug) {
        console.log(log);
      }
    };
    self.init = function() {
      if (self.timeoutId) {
        clearTimeout(self.timeoutId);
      }
      if (self.is_android)
        self.useTimer = true;
      if (self.is_opera || typeof speechSynthesis === 'undefined') {
        console.log('RV: Voice synthesis not supported');
        self.enableFallbackMode();
      } else {
        setTimeout(function() {
          var gsvinterval = setInterval(function() {
            if (typeof window.speechSynthesis !== 'undefined' && window.speechSynthesis) {
              var v = window.speechSynthesis.getVoices();
            } else {
              var v = [];
            }
            if (v.length == 0 && (self.systemvoices == null || self.systemvoices.length == 0)) {
              console.log('Voice support NOT ready');
              self.voicesupport_attempts++;
              if (self.voicesupport_attempts > self.VOICESUPPORT_ATTEMPTLIMIT) {
                clearInterval(gsvinterval);
                if (typeof window.speechSynthesis !== 'undefined' && window.speechSynthesis != null) {
                  if (self.iOS) {
                    if (typeof window.nativeBridge != 'undefined' && window.nativeBridge.isSyncLockTablet() == true) {
                      self.log("RV: enabling fallback mode for MobyMax tablets");
                      self.enableFallbackMode();
                    } else if (self.iOS9) {
                      self.systemVoicesReady(self.cache_ios9_voices);
                    } else {
                      self.systemVoicesReady(self.cache_ios_voices);
                    }
                    console.log('RV: Voice support ready (cached)');
                  } else {
                    console.log("RV: speechSynthesis present but no system voices found");
                    self.enableFallbackMode();
                  }
                } else {
                  self.enableFallbackMode();
                }
              }
            } else {
              console.log('RV: Voice support ready');
              self.systemVoicesReady(v);
              clearInterval(gsvinterval);
            }
          }, 100);
        }, 100);
      }
      $(document).click(function() {
        this.clickEvent();
      }.bind(self));
      self.Dispatch("OnLoad");
    }
    self.systemVoicesReady = function(v) {
      self.systemvoices = v;
      self.mapRVs();
      if (self.OnVoiceReady != null)
        self.OnVoiceReady.call();
      self.Dispatch("OnReady");
      if (window.hasOwnProperty('dispatchEvent'))
        window.dispatchEvent(new Event("ResponsiveVoice_OnReady"));
    }
    self.enableFallbackMode = function() {
      self.fallbackMode = true;
      console.log('RV: Enabling fallback mode');
      self.mapRVs();
      if (self.OnVoiceReady != null)
        self.OnVoiceReady.call();
      self.Dispatch("OnReady");
      if (window.hasOwnProperty('dispatchEvent'))
        window.dispatchEvent(new Event("ResponsiveVoice_OnReady"));
    }
    self.getVoices = function() {
      var v = [];
      for (var i = 0; i < self.responsivevoices.length; i++) {
        v.push({
          name: self.responsivevoices[i].name
        });
      }
      return v;
    }
    self.splitLongText = function(text) {
      var multipartText = [];
      if (text.length > self.CHARACTER_LIMIT) {
        var tmptxt = text;
        while (tmptxt.length > self.CHARACTER_LIMIT) {
          var p = tmptxt.search(/[:!?.;]+/);
          var part = '';
          if (p == -1 || p >= self.CHARACTER_LIMIT) {
            p = tmptxt.search(/[,]+/);
          }
          if (p == -1) {
            if (tmptxt.search(' ') == -1)
              p = 99;
          }
          if (p == -1 || p >= self.CHARACTER_LIMIT) {
            var words = tmptxt.split(' ');
            for (var i = 0; i < words.length; i++) {
              if (part.length + words[i].length + 1 > self.CHARACTER_LIMIT)
                break;
              part += (i != 0 ? ' ' : '') + words[i];
            }
          } else {
            part = tmptxt.substr(0, p + 1);
          }
          tmptxt = tmptxt.substr(part.length, tmptxt.length - part.length);
          multipartText.push(part);
        }
        if (tmptxt.length > 0) {
          multipartText.push(tmptxt);
        }
      } else {
        multipartText.push(text);
      }
      return multipartText;
    }
    self.preinitTextParts = function() {}
    self.speak = function(text, voicename, parameters, doNotPlay) {
      if (app && app.labObject && app.labObject.pauseInitedSound) {
        app.labObject.pauseInitedSound();
      }
      if (app && app.labObject && app.labObject.debugInConsole) {
        app.labObject.debugInConsole('voice.js speak', [text, voicename, parameters])
      }
      if (self.isPlaying()) {
        self.log("Cancelling previous speech");
        self.cancel();
      }
      if (self.fallbackMode && self.fallback_audiopool_urls.length > 0) {
        self.clearFallbackPool();
      }
      text = text.replace(/[\"\`]/gm, "'");
      self.msgparameters = parameters || {};
      self.msgtext = text;
      self.msgvoicename = voicename;
      self.onstartFired = false;
      var multipartText = self.splitLongText(text);
      self.multipartText = multipartText;
      var rv;
      if (voicename == null) {
        rv = self.default_rv;
      } else {
        rv = self.getResponsiveVoice(voicename);
      }
      if (rv.deprecated === true) {
        console.warn("ResponsiveVoice: Voice " + rv.name + " is deprecated and will be removed in future releases");
      }
      var profile = {};
      if (rv.mappedProfile != null) {
        profile = rv.mappedProfile;
      } else {
        profile.systemvoice = self.getMatchedVoice(rv);
        profile.collectionvoice = {};
        if (profile.systemvoice == null) {
          console.log('RV: ERROR: No voice found for: ' + voicename);
          return;
        }
      }
      self.msgprofile = profile;
      self.utterances = [];
      for (var i = 0; i < multipartText.length; i++) {
        if (!self.fallbackMode) {
          self.log('Using SpeechSynthesis');
          var msg = new SpeechSynthesisUtterance();
          msg.voiceURI = profile.systemvoice.voiceURI;
          msg.volume = self.selectBest([profile.collectionvoice.volume, profile.systemvoice.volume, 1]);
          msg.rate = self.selectBest([(self.iOS9 ? 1 : null), profile.collectionvoice.rate, profile.systemvoice.rate, 1]);
          msg.pitch = self.selectBest([profile.collectionvoice.pitch, profile.systemvoice.pitch, 1]);
          msg.text = multipartText[i];
          msg.lang = self.selectBest([profile.collectionvoice.lang, profile.systemvoice.lang]);
          msg.rvIndex = i;
          msg.rvTotal = multipartText.length;
          if (i == 0) {
            msg.onstart = self.speech_onstart;
          }
          self.msgparameters.onendcalled = false;
          if (parameters != null) {
            msg.voice = typeof parameters.voice !== 'undefined' ? parameters.voice : profile.systemvoice;
            if (i < multipartText.length - 1 && multipartText.length > 1) {
              msg.onend = self.onPartEnd;
              if (msg.hasOwnProperty("addEventListener"))
                msg.addEventListener('end', self.onPartEnd);
            } else {
              msg.onend = self.speech_onend;
              if (msg.hasOwnProperty("addEventListener"))
                msg.addEventListener('end', self.speech_onend);
            }
            msg.onerror = parameters.onerror || function(e) {
              self.log('RV: Unknow Error');
              self.log(e);
            };
            msg.onpause = parameters.onpause;
            msg.onresume = parameters.onresume;
            msg.onmark = parameters.onmark;
            msg.onboundary = parameters.onboundary || self.onboundary;
            msg.pitch = parameters.pitch != null ? parameters.pitch : msg.pitch;
            if (self.iOS) {
              msg.rate = (parameters.rate != null ? (parameters.rate * parameters.rate) : 1) * msg.rate;
            } else {
              msg.rate = (parameters.rate != null ? parameters.rate : 1) * msg.rate;
            }
            msg.volume = parameters.volume != null ? parameters.volume : msg.volume;
          } else {
            self.log('No Params received for current Utterance');
            msg.voice = profile.systemvoice;;
            msg.onend = self.speech_onend;
            msg.onboundary = self.onboundary;
            msg.onerror = function(e) {
              self.log('RV: Unknow Error');
              self.log(e);
            };
          }
          self.utterances.push(msg);
          if (i == 0)
            self.currentMsg = msg;
          if (typeof doNotPlay === 'undefined' || !doNotPlay) {
            self.tts_speak(msg);
          }
        } else {
          self.fallback_playbackrate = self.def_fallback_playbackrate;
          var pitch = self.selectBest([profile.collectionvoice.pitch, profile.systemvoice.pitch, 1])
          var rate = self.selectBest([(self.iOS9 ? 1 : null), profile.collectionvoice.rate, profile.systemvoice.rate, 1]);
          var volume = self.selectBest([profile.collectionvoice.volume, profile.systemvoice.volume, 1]);
          var extraParams;
          if (parameters != null) {
            pitch = (parameters.pitch != null ? parameters.pitch : 1) * pitch;
            rate = (parameters.rate != null ? parameters.rate : 1) * rate;
            volume = (parameters.volume != null ? parameters.volume : 1) * volume;
            extraParams = parameters.extraParams || null;
          }
          pitch /= 2;
          rate /= 2;
          volume *= 2;
          pitch = Math.min(Math.max(pitch, 0), 1);
          rate = Math.min(Math.max(rate, 0), 1);
          volume = Math.min(Math.max(volume, 0), 1);
          var url = self.fallbackServicePath + '?t=' + encodeURIComponent(multipartText[i].trim()) + '&tl=' + (profile.collectionvoice.lang || profile.systemvoice.lang || 'en-US') + '&sv=' + (profile.collectionvoice.service || profile.systemvoice.service || '') + '&vn=' + (profile.collectionvoice.voicename || profile.systemvoice.voicename || '') + '&pitch=' + pitch.toString() + '&rate=' + rate.toString() + '&vol=' + volume.toString();
          if (extraParams) {
            url += "&extraParams=" + JSON.stringify(extraParams);
          }
          app.labObject.initSound(url, url);
          self.fallback_parts_urls.push(url);
          var audio = document.createElement("AUDIO");
          audio.src = url;
          audio.playbackRate = self.fallback_playbackrate;
          audio.preload = 'auto';
          audio.load();
          self.fallback_parts.push(audio);
        }
      }
      if (self.fallbackMode && (typeof doNotPlay === 'undefined' || !doNotPlay)) {
        self.fallback_part_index = 0;
        self.fallback_startPart();
      }
    }
    self.startTimeout = function(text, callback) {
      var multiplier = self.msgprofile.collectionvoice.timerSpeed;
      if (self.msgprofile.collectionvoice.timerSpeed == null)
        multiplier = 1;
      if (multiplier <= 0)
        return;
      self.timeoutId = setTimeout(callback, self.getEstimatedTimeLength(text, multiplier));
      self.log("Timeout ID: " + self.timeoutId);
    }
    self.checkAndCancelTimeout = function() {
      if (self.timeoutId != null) {
        clearTimeout(self.timeoutId);
        self.timeoutId = null;
      }
    }
    self.speech_timedout = function() {
      self.cancel();
      self.cancelled = false;
      self.speech_onend();
    }
    self.speech_onend = function() {
      self.fallback_part_index = 0;
      self.checkAndCancelTimeout();
      if (self.cancelled === true) {
        self.cancelled = false;
        return;
      }
      self.log("on end fired");
      if (self.msgparameters != null && self.msgparameters.onend != null && self.msgparameters.onendcalled != true) {
        self.log("Speech on end called  -" + self.msgtext);
        self.msgparameters.onendcalled = true;
        self.msgparameters.onend();
      }
    }
    self.speech_onstart = function() {
      if (self.onstartFired) return;
      self.onstartFired = true;
      self.log("Speech start");
      if (self.iOS || self.is_safari || self.useTimer) {
        if (!self.fallbackMode)
          self.startTimeout(self.msgtext, self.speech_timedout);
      }
      self.msgparameters.onendcalled = false;
      if (self.msgparameters != null && self.msgparameters.onstart != null) {
        self.msgparameters.onstart();
      }
    }
    self.fallback_startPart = function() {
      if (self.fallback_part_index == 0) {
        self.speech_onstart();
      }
      self.fallback_audio = self.fallback_parts[self.fallback_part_index];
      self.fallback_audio_url = self.fallback_parts_urls[self.fallback_part_index];
      if (self.fallback_audio == null || self.fallback_audio_url == null) {
        self.log("RV: Fallback Audio is not available");
      } else {
        var audio = self.fallback_audio;
        var audio_url = self.fallback_audio_url;
        self.fallback_audiopool_urls.push(audio_url);
        if (self.fallback_errors) {
          self.log("RV: Speech cancelled due to errors");
          self.speech_onend();
        }
        app.labObject.playInitedSound(self.fallback_audio_url, true, self.fallback_finishPart);
        if (self.useTimer) {
          self.startTimeout(self.multipartText[self.fallback_part_index], self.fallback_finishPart);
        }
      }
    };
    self.isFallbackAudioPlaying = function() {
      var c;
      if (app.labObject.isInitedSoundPlaying()) {
        return true;
      }
      return false;
    };
    self.fallback_finishPart = function(e) {
      if (self.isFallbackAudioPlaying()) {
        self.checkAndCancelTimeout();
        self.timeoutId = setTimeout(self.fallback_finishPart, 500);
        return;
      }
      self.checkAndCancelTimeout();
      app.labObject.uninitOneSound(self.fallback_audio_url);
      if (self.fallback_part_index < self.fallback_parts.length - 1) {
        self.fallback_part_index++;
        self.fallback_startPart();
      } else {
        self.speech_onend();
      }
    }
    self.cancel = function() {
      self.checkAndCancelTimeout();
      if (self.labObject && self.labObject.pauseInitedSound) {
        self.labObject.pauseInitedSound();
      }
      if (self.fallbackMode) {
        if (self.fallback_audio != null)
          app.labObject.pauseInitedSound();
        self.clearFallbackPool();
      } else {
        self.cancelled = true;
        if (typeof window.speechSynthesis !== 'undefined' && window.speechSynthesis) {
          window.speechSynthesis.cancel();
        }
      }
    }
    self.voiceSupport = function() {
      return ('speechSynthesis' in window);
    }
    self.OnFinishedPlaying = function(event) {
      if (self.msgparameters != null) {
        if (self.msgparameters.onend != null)
          self.msgparameters.onend();
      }
    }
    self.setDefaultVoice = function(voicename) {
      var rv = self.getResponsiveVoice(voicename);
      if (rv != null) {
        self.default_rv = rv;
      }
    }
    self.mapRVs = function() {
      for (var i = 0; i < self.responsivevoices.length; i++) {
        var rv = self.responsivevoices[i];
        for (var j = 0; j < rv.voiceIDs.length; j++) {
          var vcoll = self.voicecollection[rv.voiceIDs[j]];
          if (vcoll.fallbackvoice != true) {
            var v = self.getSystemVoice(vcoll.name);
            if (v != null) {
              rv.mappedProfile = {
                systemvoice: v,
                collectionvoice: vcoll
              };
              break;
            }
          } else {
            rv.mappedProfile = {
              systemvoice: {},
              collectionvoice: vcoll
            };
            break;
          }
        }
      }
    }
    self.getMatchedVoice = function(rv) {
      for (var i = 0; i < rv.voiceIDs.length; i++) {
        var v = self.getSystemVoice(self.voicecollection[rv.voiceIDs[i]].name);
        if (v != null)
          return v;
      }
      return null;
    }
    self.getSystemVoice = function(name) {
      var unicodeWhiteSpace = String.fromCharCode(160),
        name = name.replace(new RegExp('\\s+|' + unicodeWhiteSpace, 'g'), '');
      if (typeof self.systemvoices === 'undefined' || self.systemvoices === null) {
        return null;
      }
      for (var i = 0; i < self.systemvoices.length; i++) {
        if (0 === self.systemvoices[i].name.replace(new RegExp('\\s+|' + unicodeWhiteSpace, 'g'), '').localeCompare(name)) {
          return self.systemvoices[i];
        }
      }
      return null;
    }
    self.getResponsiveVoice = function(name) {
      for (var i = 0; i < self.responsivevoices.length; i++) {
        if (self.responsivevoices[i].name == name) {
          if (typeof(self.responsivevoices[i].mappedProfile) != "undefined" && (self.responsivevoices[i].mappedProfile.collectionvoice.fallbackvoice === true || self.fallbackMode === true)) {
            self.fallbackMode = true;
            self.fallback_parts = [];
            self.fallback_parts_urls = [];
          } else {
            self.fallbackMode = false;
          }
          return self.responsivevoices[i];
        }
      }
      return null;
    }
    self.Dispatch = function(name) {
      if (self.hasOwnProperty(name + "_callbacks") && self[name + "_callbacks"] != null && self[name + "_callbacks"].length > 0) {
        var callbacks = self[name + "_callbacks"];
        for (var i = 0; i < callbacks.length; i++) {
          callbacks[i]();
        }
        return true;
      } else {
        var timeoutName = name + "_callbacks_timeout";
        var timeoutCount = name + "_callbacks_timeoutCount";
        if (self.hasOwnProperty(timeoutName)) {} else {
          self[timeoutCount] = 10;
          self[timeoutName] = setInterval(function() {
            self[timeoutCount] = self[timeoutCount] - 1;
            if (self.Dispatch(name) || self[timeoutCount] < 0) {
              clearTimeout(self[timeoutName]);
            } else {}
          }, 50);
        }
        return false;
      }
    }
    self.AddEventListener = function(name, callback) {
      if (!self.hasOwnProperty(name + "_callbacks")) {
        self[name + "_callbacks"] = [];
      }
      self[name + "_callbacks"].push(callback);
    }
    self.addEventListener = self.AddEventListener;
    self.clickEvent = function() {
      if (self.iOS && !self.iOS_initialized) {
        self.log("Initializing iOS click event");
        var u = new SpeechSynthesisUtterance(" ");
        if (typeof window.speechSynthesis !== 'undefined' && window.speechSynthesis) {
          window.speechSynthesis.speak(u);
        }
        self.iOS_initialized = true;
      }
    }
    self.isPlaying = function() {
      if (self.fallbackMode) {
        return ((self.fallback_audio != null && !self.fallback_audio.ended && !self.fallback_audio.paused) || app.labObject.isInitedSoundPlaying())
      } else {
        if (typeof window.speechSynthesis !== 'undefined' && window.speechSynthesis) {
          return window.speechSynthesis.speaking;
        } else {
          return false;
        }
      }
    }
    self.clearFallbackPool = function() {
      for (var i = 0; i < self.fallback_audiopool_urls.length; i++) {
        if (self.fallback_audiopool_urls[i] != null) {
          app.labObject.pauseInitedSound(self.fallback_audiopool_urls[i] ? self.fallback_audiopool_urls[i] : null);
        }
      }
      self.fallback_audiopool_urls = [];
    }
    if (document.readyState === "complete" || document.readyState === "interactive") {
      self.init();
    } else {
      if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', function() {
          self.init();
        });
      } else {
        document.attachEvent('onreadystatechange', function() {
          if (document.readyState === 'complete') {
            self.init();
          }
        });
      }
    }
    self.selectBest = function(a) {
      for (var i = 0; i < a.length; i++) {
        if (a[i] != null) return a[i];
      }
      return null;
    }
    self.pause = function() {
      if (self.fallbackMode) {
        if (self.fallback_audio != null) {
          app.labObject.pauseInitedSound(self.fallback_audio.src ? self.fallback_audio.src : null);
        }
      } else {
        if (typeof window.speechSynthesis !== 'undefined' && window.speechSynthesis) {
          window.speechSynthesis.pause();
        }
      }
    }
    self.resume = function() {
      if (self.fallbackMode) {
        if (self.fallback_audio != null) {
          app.labObject.playInitedSound(self.fallback_audio.src);
        }
      } else {
        if (typeof window.speechSynthesis !== 'undefined' && window.speechSynthesis) {
          window.speechSynthesis.resume();
        }
      }
    }
    self.tts_speak = function(msg) {
      setTimeout(function() {
        self.cancelled = false;
        if (typeof window.speechSynthesis !== 'undefined' && window.speechSynthesis) {
          window.speechSynthesis.speak(msg);
        }
      }, 0.01);
    }
    self.setVolume = function(v) {
      if (self.isPlaying()) {
        if (self.fallbackMode) {
          for (var i = 0; i < self.fallback_parts.length; i++) {
            self.fallback_parts[i].volume = v;
          }
          for (var i = 0; i < self.fallback_audiopool_urls.length; i++) {
            app.labObject.setInitedSoundVolume(self.fallback_audiopool_urls[i], v);
          }
          self.fallback_audio.volume = v;
        } else {
          for (var i = 0; i < self.utterances.length; i++) {
            self.utterances[i].volume = v;
          }
        }
      }
    }
    self.onPartEnd = function(e) {
      if (self.msgparameters != null && self.msgparameters.onchuckend != null) {
        self.msgparameters.onchuckend();
      }
      self.Dispatch("OnPartEnd");
      var i = self.utterances.indexOf(e.utterance);
      self.currentMsg = self.utterances[i + 1];
    }
    self.onboundary = function(e) {
      self.log("On Boundary");
      if (self.iOS && !self.onstartFired) {
        self.speech_onstart();
      }
    }
    self.numToWords = function(n) {
      var _slicedToArray = function() {
        function sliceIterator(arr, i) {
          var _arr = [];
          var _n = true;
          var _d = false;
          var _e = undefined;
          try {
            for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {
              _arr.push(_s.value);
              if (i && _arr.length === i) break;
            }
          } catch (err) {
            _d = true;
            _e = err;
          } finally {
            try {
              if (!_n && _i["return"]) _i["return"]();
            } finally {
              if (_d) throw _e;
            }
          }
          return _arr;
        }
        return function(arr, i) {
          if (Array.isArray(arr)) {
            return arr;
          } else if (Symbol.iterator in Object(arr)) {
            return sliceIterator(arr, i);
          } else {
            throw new TypeError("Invalid attempt to destructure non-iterable instance");
          }
        };
      }();

      function _toConsumableArray(arr) {
        if (Array.isArray(arr)) {
          for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) {
            arr2[i] = arr[i];
          }
          return arr2;
        } else {
          return Array.from(arr);
        }
      }
      var arr = function arr(x) {
        return Array.from(x);
      };
      var num = function num(x) {
        return Number(x) || 0;
      };
      var isEmpty = function isEmpty(xs) {
        return xs.length === 0;
      };
      var take = function take(n) {
        return function(xs) {
          return xs.slice(0, n);
        };
      };
      var drop = function drop(n) {
        return function(xs) {
          return xs.slice(n);
        };
      };
      var reverse = function reverse(xs) {
        return xs.slice(0).reverse();
      };
      var comp = function comp(f) {
        return function(g) {
          return function(x) {
            return f(g(x));
          };
        };
      };
      var not = function not(x) {
        return !x;
      };
      var chunk = function chunk(n) {
        return function(xs) {
          return isEmpty(xs) ? [] : [take(n)(xs)].concat(_toConsumableArray(chunk(n)(drop(n)(xs))));
        };
      };
      var a = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
      var b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
      var g = ['', 'thousand', 'million', 'billion', 'trillion', 'quadrillion', 'quintillion', 'sextillion', 'septillion', 'octillion', 'nonillion'];
      var makeGroup = function makeGroup(_ref) {
        var _ref2 = _slicedToArray(_ref, 3);
        var ones = _ref2[0];
        var tens = _ref2[1];
        var huns = _ref2[2];
        return [num(huns) === 0 ? '' : a[huns] + ' hundred ', num(ones) === 0 ? b[tens] : b[tens] && b[tens] + '-' || '', a[tens + ones] || a[ones]].join('');
      };
      var thousand = function thousand(group, i) {
        return group === '' ? group : group + ' ' + g[i];
      };
      if (typeof n === 'number') return self.numToWords(String(n));
      else if (n === '0') return 'zero';
      else return comp(chunk(3))(reverse)(arr(n)).map(makeGroup).map(thousand).filter(comp(not)(isEmpty)).reverse().join(' ').trim();
    };
    self.getWords = function(text) {
      var words = text.split(/\s+/),
        match;
      for (var i = 0; i < words.length; i++) {
        if ((match = words[i].toString().match(/\d+/)) != null) {
          words.splice(i, 1);
          self.numToWords(+match[0]).split(/\s+/).map(function(word) {
            words.push(word);
          });
        }
      }
      return words;
    };
    self.getEstimatedTimeLength = function(text, multiply) {
      var words = self.getWords(text),
        charsCount = 0,
        base = self.fallbackMode ? 1300 : 700,
        multiplier = multiply || 1;
      words.map(function(word, i) {
        charsCount += (word.toString().match(/[^ ]/igm) || word).length;
      });
      var wordsCount = words.length;
      var estimatedLength = multiplier * 1000 * (60 / self.WORDS_PER_MINUTE) * wordsCount;
      if (wordsCount < 5) {
        estimatedLength = multiplier * (base + charsCount * 50);
      }
      self.log("Estimated time length: " + estimatedLength + " ms, words: [" + words + "], charsCount: " + charsCount);
      return estimatedLength;
    };
  }
  var responsiveVoice = new ResponsiveVoice();
}
if (typeof module === "object" && module.exports) {
  module.exports = responsiveVoice;
}
var FocusTimeClass = function(parentObj, timerObj, actualTimeMethod) {
  this.parentObj = parentObj;
  this.timerObj = timerObj;
  this.actualTimeMethod = actualTimeMethod.bind(this.parentObj);
  this.debug = jsVars ? jsVars.IsMobyDebug : false;
  this.focused = null;
  this.timerName = 'thrFocusTimeClass';
};
FocusTimeClass.prototype.startTimeNotFocusTimer = function(focused) {
  this.debugOut('startTimeNotFocusTimer', 'focused = ' + focused);
  this.focused = focused;
  this.timerObj.Start(this.timerName);
}
FocusTimeClass.prototype.startFlowScreenTimeNotFocusTimer = function() {
  this.startTimeNotFocusTimer(15);
}
FocusTimeClass.prototype.checkTimeNotFocusTimer = function() {
  if (typeof this.timerObj.timers[this.timerName] != 'undefined') {
    this.debugOut('checkTimeNotFocusTimer', this.timerObj.GetTime(this.timerName) + ' > ' + this.focused + '     [sessionTime > focused]');
    if (this.timerObj.GetTime(this.timerName) > this.focused)
      return this.timerObj.GetTime(this.timerName) - this.focused;
    else
      return 0;
  } else {
    this.debugOut('checkTimeNotFocusTimer', 'NO ACTIVE TIMER')
    return 0;
  }
}
FocusTimeClass.prototype.endTimeNotFocusTimer = function() {
  var TimeNotFocus = this.checkTimeNotFocusTimer();
  this.debugOut('endTimeNotFocusTimer', 'TimeNotFocus = ' + TimeNotFocus);
  this.timerObj.RemoveTimer(this.timerName);
  this.focused = null;
  return TimeNotFocus;
}
FocusTimeClass.prototype.getDbTime = function() {
  return parseInt(this.parentObj.db_Time);
}
FocusTimeClass.prototype.getDbTimeFocus = function() {
  return parseInt(this.parentObj.db_TimeFocus)
}
FocusTimeClass.prototype.getActualTime = function() {
  return parseInt(this.actualTimeMethod());
}
FocusTimeClass.prototype.getActualTotal = function() {
  var actual = this.getDbTime() + this.getActualTime();
  this.debugOut('getActualTotal', this.getDbTime() + ' + ' + this.getActualTime() + ' = ' + actual + '    [dbTime + currentTime = actual]');
  return actual;
}
FocusTimeClass.prototype.getTimeRemaining = function(assignedTime) {
  if (!assignedTime || assignedTime == 0) {
    return null;
  }
  var remainingTime = parseInt(assignedTime - parseInt(this.getActualTotal() / 60));
  return remainingTime > 0 ? remainingTime : 0;
};
FocusTimeClass.prototype.getTimeFocus = function() {
  var CurrentTimeNotFocus = this.checkTimeNotFocusTimer();
  var TimeNotFocusTotal = parseInt(this.parentObj.TimeNotFocus) + CurrentTimeNotFocus;
  var TimeFocus = this.getActualTime() - TimeNotFocusTotal;
  this.debugOut('getTimeFocus', 'currentNotFocus : ' + this.parentObj.TimeNotFocus + '+' + CurrentTimeNotFocus + ' = ' + TimeNotFocusTotal + '   [existingNotFocus + NewNotFocus]');
  this.debugOut('getTimeFocus', 'currentFocus : ' + this.getActualTime() + ' - ' +
    TimeNotFocusTotal + ' = ' + TimeFocus + '    [currentTime - TimeNotFocusTotal]');
  return TimeFocus;
}
FocusTimeClass.prototype.getTimeFocusTotal = function() {
  var CurrentTimeFocus = this.getTimeFocus();
  var focused = this.getDbTimeFocus() + CurrentTimeFocus;
  this.debugOut('getTimeFocusTotal', this.getDbTimeFocus() + ' + ' + CurrentTimeFocus + ' = ' + focused + '      [dbFocus + currentFocus = focused]')
  if (focused < 0)
    focused = 0;
  return focused;
}
FocusTimeClass.prototype.debugOut = function(methodName, mesg) {
  if (this.debug)
    console.debug('FocusTimeClass::' + methodName + ' : ' + mesg);
}
if (!Moby) {
  var Moby = {};
}
if (!Moby.App) {
  Moby.App = {};
}
Moby.App.CertificateBuilder = {
  start: function(certificateId, onCompleteCallback) {
    window.loadedFiles = window.loadedFiles || {
      css: [],
      js: []
    };
    var filesCss = ['https://fonts.googleapis.com/css?family=Dosis:400,500,700|Open+Sans:400,700', '/MM/css/lab/certificate.css'];

    function loadCss(url) {
      if (window.loadedFiles.css.indexOf(url) !== -1) {
        return;
      }
      window.loadedFiles.css.push(url);
      var oLink = document.createElement("link");
      oLink.href = url;
      oLink.rel = "stylesheet";
      oLink.type = "text/css";
      document.getElementsByTagName("head")[0].appendChild(oLink);
    }
    for (var i = 0; i < filesCss.length; i++) {
      loadCss(filesCss[i]);
    }
    var filesJs = ['/MM/js/lab/certificate/Controller.js', '/MM/js/lab/certificate/Model.js', '/MM/js/lab/certificate/View.js'];

    function loadJs(url, callback) {
      if (window.loadedFiles.js.indexOf(url) !== -1) {
        callback(url);
        return;
      }
      window.loadedFiles.js.push(url);
      var oScript = document.createElement('script');
      oScript.type = 'text/javascript';
      oScript.src = url;
      oScript.onload = function() {
        callback(url);
      };
      oScript.onreadystatechange = function() {
        if (this.readyState == 'loaded' || this.readyState == 'complete') {
          callback(url);
        }
      };
      document.getElementsByTagName("head")[0].appendChild(oScript);
    }

    function load(i) {
      loadJs(filesJs[i], function() {
        i++;
        if (filesJs.length > i) {
          load(i);
        } else {
          initialize();
        }
      });
    }
    load(0);
    if (this.stopSounds) {
      this.stopSounds();
    }

    function initialize() {
      $.get('/MM/MS/certificate/design/' + certificateId, function(d) {
        $(".certificate-wrapper").remove();
        $(".lab-footer-certificate").remove();
        $(".lab-content").append(d);
        $(".lab-content .lab-content-border").hide(0);
        $(".lab-content .lab-problem").hide(0);
        $(".lab-footer").addClass('lab-footer-certificate');
        $(".lab-footer").append('<div class="lab-certificate">\
                        <div class="lab-next lab-right" role="skip"><div><div></div></div></div>\
                        <div class="lab-click lab-right font-title" style="display: block;" role="skip">Skip.</div>\
                        </div>');
        var data = certificateData;
        Moby.App.CertificateBuilder.create(certificateId, data.certificate, data.designs, data.medals, data.subject, data.student, data.school, data.lesson, data.moduleTree, {
          onComplete: function() {
            $(".certificate-wrapper").remove();
            $(".lab-content .lab-content-border").show(0);
            $(".lab-content .lab-problem").show(0);
            $(".lab-certificate").remove();
            $(".lab-footer").removeClass('lab-footer-certificate');
            if (onCompleteCallback) {
              onCompleteCallback();
            }
          }
        });
      });
    }
  },
  create: function(certificateId, certificate, designs, medals, subject, student, school, lesson, moduleTree, options) {
    var defaults = {
      onComplete: function() {}
    };
    var settings = $.extend({}, defaults, options);
    new Moby.App.CertificateBuilder.Controller(certificateId, certificate, designs, medals, subject, student, school, lesson, moduleTree, settings);
  }
};
(function(h, g) {
  function K(sb, K) {
    function ha(b) {
      return c.preferFlash && H && !c.ignoreFlash && c.flash[b] !== g && c.flash[b]
    }

    function r(b) {
      return function(d) {
        var e = this._s;
        e && e._a ? d = b.call(this, d) : (e && e.id ? c._wD(e.id + ": Ignoring " + d.type) : c._wD("HTML5::Ignoring " + d.type), d = null);
        return d
      }
    }
    this.setupOptions = {
      url: sb || null,
      flashVersion: 8,
      debugMode: !0,
      debugFlash: !1,
      useConsole: !0,
      consoleOnly: !0,
      waitForWindowLoad: !1,
      bgColor: "#ffffff",
      useHighPerformance: !1,
      flashPollingInterval: null,
      html5PollingInterval: null,
      flashLoadTimeout: 1E3,
      wmode: null,
      allowScriptAccess: "always",
      useFlashBlock: !1,
      useHTML5Audio: !0,
      forceUseGlobalHTML5Audio: !1,
      ignoreMobileRestrictions: !1,
      html5Test: /^(probably|maybe)$/i,
      preferFlash: !1,
      noSWFCache: !1,
      idPrefix: "sound"
    };
    this.defaultOptions = {
      autoLoad: !1,
      autoPlay: !1,
      from: null,
      loops: 1,
      onid3: null,
      onload: null,
      whileloading: null,
      onplay: null,
      onpause: null,
      onresume: null,
      whileplaying: null,
      onposition: null,
      onstop: null,
      onfailure: null,
      onfinish: null,
      multiShot: !0,
      multiShotEvents: !1,
      position: null,
      pan: 0,
      stream: !0,
      to: null,
      type: null,
      usePolicyFile: !1,
      volume: 100
    };
    this.flash9Options = {
      isMovieStar: null,
      usePeakData: !1,
      useWaveformData: !1,
      useEQData: !1,
      onbufferchange: null,
      ondataerror: null
    };
    this.movieStarOptions = {
      bufferTime: 3,
      serverURL: null,
      onconnect: null,
      duration: null
    };
    this.audioFormats = {
      mp3: {
        type: ['audio/mpeg; codecs="mp3"', "audio/mpeg", "audio/mp3", "audio/MPA", "audio/mpa-robust"],
        required: !0
      },
      mp4: {
        related: ["aac", "m4a", "m4b"],
        type: ['audio/mp4; codecs="mp4a.40.2"', "audio/aac", "audio/x-m4a", "audio/MP4A-LATM", "audio/mpeg4-generic"],
        required: !1
      },
      ogg: {
        type: ["audio/ogg; codecs=vorbis"],
        required: !1
      },
      opus: {
        type: ["audio/ogg; codecs=opus", "audio/opus"],
        required: !1
      },
      wav: {
        type: ['audio/wav; codecs="1"', "audio/wav", "audio/wave", "audio/x-wav"],
        required: !1
      }
    };
    this.movieID = "sm2-container";
    this.id = K || "sm2movie";
    this.debugID = "soundmanager-debug";
    this.debugURLParam = /([#?&])debug=1/i;
    this.versionNumber = "V2.97a.20150601";
    this.altURL = this.movieURL = this.version = null;
    this.enabled = this.swfLoaded = !1;
    this.oMC = null;
    this.sounds = {};
    this.soundIDs = [];
    this.didFlashBlock = this.muted = !1;
    this.filePattern = null;
    this.filePatterns = {
      flash8: /\.mp3(\?.*)?$/i,
      flash9: /\.mp3(\?.*)?$/i
    };
    this.features = {
      buffering: !1,
      peakData: !1,
      waveformData: !1,
      eqData: !1,
      movieStar: !1
    };
    this.sandbox = {
      type: null,
      types: {
        remote: "remote (domain-based) rules",
        localWithFile: "local with file access (no internet access)",
        localWithNetwork: "local with network (internet access only, no local access)",
        localTrusted: "local, trusted (local+internet access)"
      },
      description: null,
      noRemote: null,
      noLocal: null
    };
    this.html5 = {
      usingFlash: null
    };
    this.flash = {};
    this.ignoreFlash = this.html5Only = !1;
    var W, c = this,
      Ya = null,
      l = null,
      F, v = navigator.userAgent,
      ia = h.location.href.toString(),
      m = document,
      ya, Za, za, n, I = [],
      Aa = !0,
      D, X = !1,
      Y = !1,
      q = !1,
      y = !1,
      ja = !1,
      p, tb = 0,
      Z, A, Ba, R, Ca, P, S, T, $a, Da, Ea, ka, z, la, Q, Fa, aa, ma, na, U, ab, Ga, bb = ["log", "info", "warn", "error"],
      cb, Ha, db, ba = null,
      Ia = null,
      t, Ja, V, eb, oa, pa, L, w, ca = !1,
      Ka = !1,
      fb, gb, hb, qa = 0,
      da = null,
      ra, M = [],
      ea, u = null,
      ib, sa, fa, N, ta, La, jb, x, kb = Array.prototype.slice,
      C = !1,
      Ma, H, Na, lb, J, mb, Oa, ua, nb = 0,
      Pa, Qa = v.match(/(ipad|iphone|ipod)/i),
      Ra = v.match(/android/i),
      O = v.match(/msie/i),
      ub = v.match(/webkit/i),
      va = v.match(/safari/i) && !v.match(/chrome/i),
      Sa = v.match(/opera/i),
      wa = v.match(/(mobile|pre\/|xoom)/i) || Qa || Ra,
      Ta = !ia.match(/usehtml5audio/i) && !ia.match(/sm2\-ignorebadua/i) && va && !v.match(/silk/i) && v.match(/OS X 10_6_([3-7])/i),
      Ua = h.console !== g && console.log !== g,
      Va = m.hasFocus !== g ? m.hasFocus() : null,
      xa = va && (m.hasFocus === g || !m.hasFocus()),
      ob = !xa,
      pb = /(mp3|mp4|mpa|m4a|m4b)/i,
      ga = m.location ? m.location.protocol.match(/http/i) : null,
      vb = ga ? "" : "http://",
      qb = /^\s*audio\/(?:x-)?(?:mpeg4|aac|flv|mov|mp4||m4v|m4a|m4b|mp4v|3gp|3g2)\s*(?:$|;)/i,
      rb = "mpeg4 aac flv mov mp4 m4v f4v m4a m4b mp4v 3gp 3g2".split(" "),
      wb = new RegExp("\\.(" + rb.join("|") + ")(\\?.*)?$", "i");
    this.mimePattern = /^\s*audio\/(?:x-)?(?:mp(?:eg|3))\s*(?:$|;)/i;
    this.useAltURL = !ga;
    var Wa;
    try {
      Wa = Audio !== g && (Sa && opera !== g && 10 > opera.version() ? new Audio(null) : new Audio).canPlayType !== g
    } catch (xb) {
      Wa = !1
    }
    this.hasHTML5 = Wa;
    this.setup = function(b) {
      var d = !c.url;
      b !== g && q && u && c.ok() && (b.flashVersion !== g || b.url !== g || b.html5Test !== g) && L(t("setupLate"));
      Ba(b);
      if (!C)
        if (wa) {
          if (!c.setupOptions.ignoreMobileRestrictions || c.setupOptions.forceUseGlobalHTML5Audio) M.push(z.globalHTML5), C = !0
        } else c.setupOptions.forceUseGlobalHTML5Audio && (M.push(z.globalHTML5), C = !0);
      if (!Pa && wa)
        if (c.setupOptions.ignoreMobileRestrictions) M.push(z.ignoreMobile);
        else if (c.setupOptions.useHTML5Audio && !c.setupOptions.preferFlash || c._wD(z.mobileUA), c.setupOptions.useHTML5Audio = !0, c.setupOptions.preferFlash = !1, Qa) c.ignoreFlash = !0;
      else if (Ra && !v.match(/android\s2\.3/i) || !Ra) c._wD(z.globalHTML5), C = !0;
      b && (d && aa && b.url !== g && c.beginDelayedInit(), aa || b.url === g || "complete" !== m.readyState || setTimeout(Q, 1));
      Pa = !0;
      return c
    };
    this.supported = this.ok = function() {
      return u ? q && !y : c.useHTML5Audio && c.hasHTML5
    };
    this.getMovie = function(c) {
      return F(c) || m[c] || h[c]
    };
    this.createSound = function(b, d) {
      function e() {
        f = oa(f);
        c.sounds[f.id] = new W(f);
        c.soundIDs.push(f.id);
        return c.sounds[f.id]
      }
      var a, f;
      a = null;
      a = "soundManager.createSound(): " + t(q ? "notOK" : "notReady");
      if (!q || !c.ok()) return L(a), !1;
      d !== g && (b = {
        id: b,
        url: d
      });
      f = A(b);
      f.url = ra(f.url);
      f.id === g && (f.id = c.setupOptions.idPrefix + nb++);
      f.id.toString().charAt(0).match(/^[0-9]$/) && c._wD("soundManager.createSound(): " + t("badID", f.id), 2);
      c._wD("soundManager.createSound(): " + f.id + (f.url ? " (" + f.url + ")" : ""), 1);
      if (w(f.id, !0)) return c._wD("soundManager.createSound(): " + f.id + " exists", 1), c.sounds[f.id];
      if (sa(f)) a = e(), c.html5Only || c._wD(f.id + ": Using HTML5"), a._setup_html5(f);
      else {
        if (c.html5Only) return c._wD(f.id + ": No HTML5 support for this sound, and no Flash. Exiting."), e();
        if (c.html5.usingFlash && f.url && f.url.match(/data\:/i)) return c._wD(f.id + ": data: URIs not supported via Flash. Exiting."), e();
        8 < n && (null === f.isMovieStar && (f.isMovieStar = !!(f.serverURL || f.type && f.type.match(qb) || f.url && f.url.match(wb))), f.isMovieStar && (c._wD("soundManager.createSound(): using MovieStar handling"), 1 < f.loops && p("noNSLoop")));
        f = pa(f, "soundManager.createSound(): ");
        a = e();
        8 === n ? l._createSound(f.id, f.loops || 1, f.usePolicyFile) : (l._createSound(f.id, f.url, f.usePeakData, f.useWaveformData, f.useEQData, f.isMovieStar, f.isMovieStar ? f.bufferTime : !1, f.loops || 1, f.serverURL, f.duration || null, f.autoPlay, !0, f.autoLoad, f.usePolicyFile), f.serverURL || (a.connected = !0, f.onconnect && f.onconnect.apply(a)));
        f.serverURL || !f.autoLoad && !f.autoPlay || a.load(f)
      }!f.serverURL && f.autoPlay && a.play();
      return a
    };
    this.destroySound = function(b, d) {
      if (!w(b)) return !1;
      var e = c.sounds[b],
        a;
      e.stop();
      e._iO = {};
      e.unload();
      for (a = 0; a < c.soundIDs.length; a++)
        if (c.soundIDs[a] === b) {
          c.soundIDs.splice(a, 1);
          break
        } d || e.destruct(!0);
      delete c.sounds[b];
      return !0
    };
    this.load = function(b, d) {
      return w(b) ? c.sounds[b].load(d) : !1
    };
    this.unload = function(b) {
      return w(b) ? c.sounds[b].unload() : !1
    };
    this.onposition = this.onPosition = function(b, d, e, a) {
      return w(b) ? c.sounds[b].onposition(d, e, a) : !1
    };
    this.clearOnPosition = function(b, d, e) {
      return w(b) ? c.sounds[b].clearOnPosition(d, e) : !1
    };
    this.start = this.play = function(b, d) {
      var e = null,
        a = d && !(d instanceof Object);
      if (!q || !c.ok()) return L("soundManager.play(): " + t(q ? "notOK" : "notReady")), !1;
      if (w(b, a)) a && (d = {
        url: d
      });
      else {
        if (!a) return !1;
        a && (d = {
          url: d
        });
        d && d.url && (c._wD('soundManager.play(): Attempting to create "' + b + '"', 1), d.id = b, e = c.createSound(d).play())
      }
      null === e && (e = c.sounds[b].play(d));
      return e
    };
    this.setPosition = function(b, d) {
      return w(b) ? c.sounds[b].setPosition(d) : !1
    };
    this.stop = function(b) {
      if (!w(b)) return !1;
      c._wD("soundManager.stop(" + b + ")", 1);
      return c.sounds[b].stop()
    };
    this.stopAll = function() {
      var b;
      c._wD("soundManager.stopAll()", 1);
      for (b in c.sounds) c.sounds.hasOwnProperty(b) && c.sounds[b].stop()
    };
    this.pause = function(b) {
      return w(b) ? c.sounds[b].pause() : !1
    };
    this.pauseAll = function() {
      var b;
      for (b = c.soundIDs.length - 1; 0 <= b; b--) c.sounds[c.soundIDs[b]].pause()
    };
    this.resume = function(b) {
      return w(b) ? c.sounds[b].resume() : !1
    };
    this.resumeAll = function() {
      var b;
      for (b = c.soundIDs.length - 1; 0 <= b; b--) c.sounds[c.soundIDs[b]].resume()
    };
    this.togglePause = function(b) {
      return w(b) ? c.sounds[b].togglePause() : !1
    };
    this.setPan = function(b, d) {
      return w(b) ? c.sounds[b].setPan(d) : !1
    };
    this.setVolume = function(b, d) {
      var e, a;
      if (b === g || isNaN(b) || d !== g) return w(b) ? c.sounds[b].setVolume(d) : !1;
      e = 0;
      for (a = c.soundIDs.length; e < a; e++) c.sounds[c.soundIDs[e]].setVolume(b)
    };
    this.mute = function(b) {
      var d = 0;
      b instanceof String && (b = null);
      if (b) {
        if (!w(b)) return !1;
        c._wD('soundManager.mute(): Muting "' + b + '"');
        return c.sounds[b].mute()
      }
      c._wD("soundManager.mute(): Muting all sounds");
      for (d = c.soundIDs.length - 1; 0 <= d; d--) c.sounds[c.soundIDs[d]].mute();
      return c.muted = !0
    };
    this.muteAll = function() {
      c.mute()
    };
    this.unmute = function(b) {
      b instanceof String && (b = null);
      if (b) {
        if (!w(b)) return !1;
        c._wD('soundManager.unmute(): Unmuting "' +
          b + '"');
        return c.sounds[b].unmute()
      }
      c._wD("soundManager.unmute(): Unmuting all sounds");
      for (b = c.soundIDs.length - 1; 0 <= b; b--) c.sounds[c.soundIDs[b]].unmute();
      c.muted = !1;
      return !0
    };
    this.unmuteAll = function() {
      c.unmute()
    };
    this.toggleMute = function(b) {
      return w(b) ? c.sounds[b].toggleMute() : !1
    };
    this.getMemoryUse = function() {
      var c = 0;
      l && 8 !== n && (c = parseInt(l._getMemoryUse(), 10));
      return c
    };
    this.disable = function(b) {
      var d;
      b === g && (b = !1);
      if (y) return !1;
      y = !0;
      p("shutdown", 1);
      for (d = c.soundIDs.length - 1; 0 <= d; d--) cb(c.sounds[c.soundIDs[d]]);
      Z(b);
      x.remove(h, "load", S);
      return !0
    };
    this.canPlayMIME = function(b) {
      var d;
      c.hasHTML5 && (d = fa({
        type: b
      }));
      !d && u && (d = b && c.ok() ? !!(8 < n && b.match(qb) || b.match(c.mimePattern)) : null);
      return d
    };
    this.canPlayURL = function(b) {
      var d;
      c.hasHTML5 && (d = fa({
        url: b
      }));
      !d && u && (d = b && c.ok() ? !!b.match(c.filePattern) : null);
      return d
    };
    this.canPlayLink = function(b) {
      return b.type !== g && b.type && c.canPlayMIME(b.type) ? !0 : c.canPlayURL(b.href)
    };
    this.getSoundById = function(b, d) {
      if (!b) return null;
      var e = c.sounds[b];
      e || d || c._wD('soundManager.getSoundById(): Sound "' +
        b + '" not found.', 2);
      return e
    };
    this.onready = function(b, d) {
      if ("function" === typeof b) q && c._wD(t("queue", "onready")), d || (d = h), Ca("onready", b, d), P();
      else throw t("needFunction", "onready");
      return !0
    };
    this.ontimeout = function(b, d) {
      if ("function" === typeof b) q && c._wD(t("queue", "ontimeout")), d || (d = h), Ca("ontimeout", b, d), P({
        type: "ontimeout"
      });
      else throw t("needFunction", "ontimeout");
      return !0
    };
    this._writeDebug = function(b, d) {
      var e, a;
      if (!c.setupOptions.debugMode) return !1;
      if (Ua && c.useConsole) {
        if (d && "object" === typeof d) console.log(b, d);
        else if (bb[d] !== g) console[bb[d]](b);
        else console.log(b);
        if (c.consoleOnly) return !0
      }
      e = F("soundmanager-debug");
      if (!e) return !1;
      a = m.createElement("div");
      0 === ++tb % 2 && (a.className = "sm2-alt");
      d = d === g ? 0 : parseInt(d, 10);
      a.appendChild(m.createTextNode(b));
      d && (2 <= d && (a.style.fontWeight = "bold"), 3 === d && (a.style.color = "#ff3333"));
      e.insertBefore(a, e.firstChild);
      return !0
    }; - 1 !== ia.indexOf("sm2-debug=alert") && (this._writeDebug = function(c) {
      h.alert(c)
    });
    this._wD = this._writeDebug;
    this._debug = function() {
      var b, d;
      p("currentObj", 1);
      b = 0;
      for (d = c.soundIDs.length; b < d; b++) c.sounds[c.soundIDs[b]]._debug()
    };
    this.reboot = function(b, d) {
      c.soundIDs.length && c._wD("Destroying " + c.soundIDs.length + " SMSound object" + (1 !== c.soundIDs.length ? "s" : "") + "...");
      var e, a, f;
      for (e = c.soundIDs.length - 1; 0 <= e; e--) c.sounds[c.soundIDs[e]].destruct();
      if (l) try {
        O && (Ia = l.innerHTML), ba = l.parentNode.removeChild(l)
      } catch (g) {
        p("badRemove", 2)
      }
      Ia = ba = u = l = null;
      c.enabled = aa = q = ca = Ka = X = Y = y = C = c.swfLoaded = !1;
      c.soundIDs = [];
      c.sounds = {};
      nb = 0;
      Pa = !1;
      if (b) I = [];
      else
        for (e in I)
          if (I.hasOwnProperty(e))
            for (a = 0, f = I[e].length; a < f; a++) I[e][a].fired = !1;
      d || c._wD("soundManager: Rebooting...");
      c.html5 = {
        usingFlash: null
      };
      c.flash = {};
      c.html5Only = !1;
      c.ignoreFlash = !1;
      h.setTimeout(function() {
        d || c.beginDelayedInit()
      }, 20);
      return c
    };
    this.reset = function() {
      p("reset");
      return c.reboot(!0, !0)
    };
    this.getMoviePercent = function() {
      return l && "PercentLoaded" in l ? l.PercentLoaded() : null
    };
    this.beginDelayedInit = function() {
      ja = !0;
      Q();
      setTimeout(function() {
        if (Ka) return !1;
        na();
        la();
        return Ka = !0
      }, 20);
      T()
    };
    this.destruct = function() {
      c._wD("soundManager.destruct()");
      c.disable(!0)
    };
    W = function(b) {
      var d, e, a = this,
        f, h, k, G, m, q, r = !1,
        E = [],
        v = 0,
        Xa, y, u = null,
        z;
      e = d = null;
      this.sID = this.id = b.id;
      this.url = b.url;
      this._iO = this.instanceOptions = this.options = A(b);
      this.pan = this.options.pan;
      this.volume = this.options.volume;
      this.isHTML5 = !1;
      this._a = null;
      z = this.url ? !1 : !0;
      this.id3 = {};
      this._debug = function() {
        c._wD(a.id + ": Merged options:", a.options)
      };
      this.load = function(b) {
        var d = null,
          e;
        b !== g ? a._iO = A(b, a.options) : (b = a.options, a._iO = b, u && u !== a.url && (p("manURL"), a._iO.url = a.url, a.url = null));
        a._iO.url || (a._iO.url = a.url);
        a._iO.url = ra(a._iO.url);
        e = a.instanceOptions = a._iO;
        c._wD(a.id + ": load (" + e.url + ")");
        if (!e.url && !a.url) return c._wD(a.id + ": load(): url is unassigned. Exiting.", 2), a;
        a.isHTML5 || 8 !== n || a.url || e.autoPlay || c._wD(a.id + ": Flash 8 load() limitation: Wait for onload() before calling play().", 1);
        if (e.url === a.url && 0 !== a.readyState && 2 !== a.readyState) return p("onURL", 1), 3 === a.readyState && e.onload && ua(a, function() {
          e.onload.apply(a, [!!a.duration])
        }), a;
        a.loaded = !1;
        a.readyState = 1;
        a.playState = 0;
        a.id3 = {};
        if (sa(e)) d = a._setup_html5(e), d._called_load ? c._wD(a.id + ": Ignoring request to load again") : (a._html5_canplay = !1, a.url !== e.url && (c._wD(p("manURL") + ": " + e.url), a._a.src = e.url, a.setPosition(0)), a._a.autobuffer = "auto", a._a.preload = "auto", a._a._called_load = !0);
        else {
          if (c.html5Only) return c._wD(a.id + ": No flash support. Exiting."), a;
          if (a._iO.url && a._iO.url.match(/data\:/i)) return c._wD(a.id + ": data: URIs not supported via Flash. Exiting."), a;
          try {
            a.isHTML5 = !1, a._iO = pa(oa(e)), a._iO.autoPlay && (a._iO.position || a._iO.from) && (c._wD(a.id + ": Disabling autoPlay because of non-zero offset case"), a._iO.autoPlay = !1), e = a._iO, 8 === n ? l._load(a.id, e.url, e.stream, e.autoPlay, e.usePolicyFile) : l._load(a.id, e.url, !!e.stream, !!e.autoPlay, e.loops || 1, !!e.autoLoad, e.usePolicyFile)
          } catch (f) {
            p("smError", 2), D("onload", !1), U({
              type: "SMSOUND_LOAD_JS_EXCEPTION",
              fatal: !0
            })
          }
        }
        a.url = e.url;
        return a
      };
      this.unload = function() {
        0 !== a.readyState && (c._wD(a.id + ": unload()"), a.isHTML5 ? (G(), a._a && (a._a.pause(), u = ta(a._a))) : 8 === n ? l._unload(a.id, "about:blank") : l._unload(a.id), f());
        return a
      };
      this.destruct = function(b) {
        c._wD(a.id + ": Destruct");
        a.isHTML5 ? (G(), a._a && (a._a.pause(), ta(a._a), C || k(), a._a._s = null, a._a = null)) : (a._iO.onfailure = null, l._destroySound(a.id));
        b || c.destroySound(a.id, !0)
      };
      this.start = this.play = function(b, d) {
        var e, f, k, G, h, B = !0,
          B = null;
        e = a.id + ": play(): ";
        d = d === g ? !0 : d;
        b || (b = {});
        a.url && (a._iO.url = a.url);
        a._iO = A(a._iO, a.options);
        a._iO = A(b, a._iO);
        a._iO.url = ra(a._iO.url);
        a.instanceOptions = a._iO;
        if (!a.isHTML5 && a._iO.serverURL && !a.connected) return a.getAutoPlay() || (c._wD(e + " Netstream not connected yet - setting autoPlay"), a.setAutoPlay(!0)), a;
        sa(a._iO) && (a._setup_html5(a._iO), m());
        1 !== a.playState || a.paused || ((f = a._iO.multiShot) ? c._wD(e + "Already playing (multi-shot)", 1) : (c._wD(e + "Already playing (one-shot)", 1), a.isHTML5 && a.setPosition(a._iO.position), B = a));
        if (null !== B) return B;
        b.url && b.url !== a.url && (a.readyState || a.isHTML5 || 8 !== n || !z ? a.load(a._iO) : z = !1);
        a.loaded ? c._wD(e.substr(0, e.lastIndexOf(":"))) : 0 === a.readyState ? (c._wD(e + "Attempting to load"), a.isHTML5 || c.html5Only ? a.isHTML5 ? a.load(a._iO) : (c._wD(e + "Unsupported type. Exiting."), B = a) : (a._iO.autoPlay = !0, a.load(a._iO)), a.instanceOptions = a._iO) : 2 === a.readyState ? (c._wD(e + "Could not load - exiting", 2), B = a) : c._wD(e + "Loading - attempting to play...");
        if (null !== B) return B;
        !a.isHTML5 && 9 === n && 0 < a.position && a.position === a.duration && (c._wD(e + "Sound at end, resetting to position: 0"), b.position = 0);
        if (a.paused && 0 <= a.position && (!a._iO.serverURL || 0 < a.position)) c._wD(e + "Resuming from paused state", 1), a.resume();
        else {
          a._iO = A(b, a._iO);
          if ((!a.isHTML5 && null !== a._iO.position && 0 < a._iO.position || null !== a._iO.from && 0 < a._iO.from || null !== a._iO.to) && 0 === a.instanceCount && 0 === a.playState && !a._iO.serverURL) {
            f = function() {
              a._iO = A(b, a._iO);
              a.play(a._iO)
            };
            a.isHTML5 && !a._html5_canplay ? (c._wD(e + "Beginning load for non-zero offset case"), a.load({
              _oncanplay: f
            }), B = !1) : a.isHTML5 || a.loaded || a.readyState && 2 === a.readyState || (c._wD(e + "Preloading for non-zero offset case"), a.load({
              onload: f
            }), B = !1);
            if (null !== B) return B;
            a._iO = y()
          }(!a.instanceCount || a._iO.multiShotEvents || a.isHTML5 && a._iO.multiShot && !C || !a.isHTML5 && 8 < n && !a.getAutoPlay()) && a.instanceCount++;
          a._iO.onposition && 0 === a.playState && q(a);
          a.playState = 1;
          a.paused = !1;
          a.position = a._iO.position === g || isNaN(a._iO.position) ? 0 : a._iO.position;
          a.isHTML5 || (a._iO = pa(oa(a._iO)));
          a._iO.onplay && d && (a._iO.onplay.apply(a), r = !0);
          a.setVolume(a._iO.volume, !0);
          a.setPan(a._iO.pan, !0);
          a.isHTML5 ? 2 > a.instanceCount ? (m(), e = a._setup_html5(), a.setPosition(a._iO.position), e.play()) : (c._wD(a.id + ": Cloning Audio() for instance #" +
            a.instanceCount + "..."), k = new Audio(a._iO.url), G = function() {
            x.remove(k, "ended", G);
            a._onfinish(a);
            ta(k);
            k = null
          }, h = function() {
            x.remove(k, "canplay", h);
            try {
              k.currentTime = a._iO.position / 1E3
            } catch (c) {
              L(a.id + ": multiShot play() failed to apply position of " + a._iO.position / 1E3)
            }
            k.play()
          }, x.add(k, "ended", G), a._iO.volume !== g && (k.volume = Math.max(0, Math.min(1, a._iO.volume / 100))), a.muted && (k.muted = !0), a._iO.position ? x.add(k, "canplay", h) : k.play()) : (B = l._start(a.id, a._iO.loops || 1, 9 === n ? a.position : a.position / 1E3, a._iO.multiShot || !1), 9 !== n || B || (c._wD(e + "No sound hardware, or 32-sound ceiling hit", 2), a._iO.onplayerror && a._iO.onplayerror.apply(a)))
        }
        return a
      };
      this.stop = function(b) {
        var d = a._iO;
        1 === a.playState && (c._wD(a.id + ": stop()"), a._onbufferchange(0), a._resetOnPosition(0), a.paused = !1, a.isHTML5 || (a.playState = 0), Xa(), d.to && a.clearOnPosition(d.to), a.isHTML5 ? a._a && (b = a.position, a.setPosition(0), a.position = b, a._a.pause(), a.playState = 0, a._onTimer(), G()) : (l._stop(a.id, b), d.serverURL && a.unload()), a.instanceCount = 0, a._iO = {}, d.onstop && d.onstop.apply(a));
        return a
      };
      this.setAutoPlay = function(b) {
        c._wD(a.id + ": Autoplay turned " + (b ? "on" : "off"));
        a._iO.autoPlay = b;
        a.isHTML5 || (l._setAutoPlay(a.id, b), b && !a.instanceCount && 1 === a.readyState && (a.instanceCount++, c._wD(a.id + ": Incremented instance count to " + a.instanceCount)))
      };
      this.getAutoPlay = function() {
        return a._iO.autoPlay
      };
      this.setPosition = function(b) {
        b === g && (b = 0);
        var d = a.isHTML5 ? Math.max(b, 0) : Math.min(a.duration || a._iO.duration, Math.max(b, 0));
        a.position = d;
        b = a.position / 1E3;
        a._resetOnPosition(a.position);
        a._iO.position = d;
        if (!a.isHTML5) b = 9 === n ? a.position : b, a.readyState && 2 !== a.readyState && l._setPosition(a.id, b, a.paused || !a.playState, a._iO.multiShot);
        else if (a._a) {
          if (a._html5_canplay) {
            if (a._a.currentTime !== b) {
              c._wD(a.id + ": setPosition(" + b + ")");
              try {
                a._a.currentTime = b, (0 === a.playState || a.paused) && a._a.pause()
              } catch (e) {
                c._wD(a.id + ": setPosition(" + b + ") failed: " + e.message, 2)
              }
            }
          } else if (b) return c._wD(a.id + ": setPosition(" + b + "): Cannot seek yet, sound not ready", 2), a;
          a.paused && a._onTimer(!0)
        }
        return a
      };
      this.pause = function(b) {
        if (a.paused || 0 === a.playState && 1 !== a.readyState) return a;
        c._wD(a.id + ": pause()");
        a.paused = !0;
        a.isHTML5 ? (a._setup_html5().pause(), G()) : (b || b === g) && l._pause(a.id, a._iO.multiShot);
        a._iO.onpause && a._iO.onpause.apply(a);
        return a
      };
      this.resume = function() {
        var b = a._iO;
        if (!a.paused) return a;
        c._wD(a.id + ": resume()");
        a.paused = !1;
        a.playState = 1;
        a.isHTML5 ? (a._setup_html5().play(), m()) : (b.isMovieStar && !b.serverURL && a.setPosition(a.position), l._pause(a.id, b.multiShot));
        !r && b.onplay ? (b.onplay.apply(a), r = !0) : b.onresume && b.onresume.apply(a);
        return a
      };
      this.togglePause = function() {
        c._wD(a.id + ": togglePause()");
        if (0 === a.playState) return a.play({
          position: 9 !== n || a.isHTML5 ? a.position / 1E3 : a.position
        }), a;
        a.paused ? a.resume() : a.pause();
        return a
      };
      this.setPan = function(c, b) {
        c === g && (c = 0);
        b === g && (b = !1);
        a.isHTML5 || l._setPan(a.id, c);
        a._iO.pan = c;
        b || (a.pan = c, a.options.pan = c);
        return a
      };
      this.setVolume = function(b, d) {
        b === g && (b = 100);
        d === g && (d = !1);
        a.isHTML5 ? a._a && (c.muted && !a.muted && (a.muted = !0, a._a.muted = !0), a._a.volume = Math.max(0, Math.min(1, b / 100))) : l._setVolume(a.id, c.muted && !a.muted || a.muted ? 0 : b);
        a._iO.volume = b;
        d || (a.volume = b, a.options.volume = b);
        return a
      };
      this.mute = function() {
        a.muted = !0;
        a.isHTML5 ? a._a && (a._a.muted = !0) : l._setVolume(a.id, 0);
        return a
      };
      this.unmute = function() {
        a.muted = !1;
        var b = a._iO.volume !== g;
        a.isHTML5 ? a._a && (a._a.muted = !1) : l._setVolume(a.id, b ? a._iO.volume : a.options.volume);
        return a
      };
      this.toggleMute = function() {
        return a.muted ? a.unmute() : a.mute()
      };
      this.onposition = this.onPosition = function(b, c, d) {
        E.push({
          position: parseInt(b, 10),
          method: c,
          scope: d !== g ? d : a,
          fired: !1
        });
        return a
      };
      this.clearOnPosition = function(a, b) {
        var c;
        a = parseInt(a, 10);
        if (isNaN(a)) return !1;
        for (c = 0; c < E.length; c++) a !== E[c].position || b && b !== E[c].method || (E[c].fired && v--, E.splice(c, 1))
      };
      this._processOnPosition = function() {
        var b, c;
        b = E.length;
        if (!b || !a.playState || v >= b) return !1;
        for (--b; 0 <= b; b--) c = E[b], !c.fired && a.position >= c.position && (c.fired = !0, v++, c.method.apply(c.scope, [c.position]));
        return !0
      };
      this._resetOnPosition = function(a) {
        var b, c;
        b = E.length;
        if (!b) return !1;
        for (--b; 0 <= b; b--) c = E[b], c.fired && a <= c.position && (c.fired = !1, v--);
        return !0
      };
      y = function() {
        var b = a._iO,
          d = b.from,
          e = b.to,
          f, g;
        g = function() {
          c._wD(a.id + ': "To" time of ' + e + " reached.");
          a.clearOnPosition(e, g);
          a.stop()
        };
        f = function() {
          c._wD(a.id + ': Playing "from" ' + d);
          if (null !== e && !isNaN(e)) a.onPosition(e, g)
        };
        null === d || isNaN(d) || (b.position = d, b.multiShot = !1, f());
        return b
      };
      q = function() {
        var b, c = a._iO.onposition;
        if (c)
          for (b in c)
            if (c.hasOwnProperty(b)) a.onPosition(parseInt(b, 10), c[b])
      };
      Xa = function() {
        var b, c = a._iO.onposition;
        if (c)
          for (b in c) c.hasOwnProperty(b) && a.clearOnPosition(parseInt(b, 10))
      };
      m = function() {
        a.isHTML5 && fb(a)
      };
      G = function() {
        a.isHTML5 && gb(a)
      };
      f = function(b) {
        b || (E = [], v = 0);
        r = !1;
        a._hasTimer = null;
        a._a = null;
        a._html5_canplay = !1;
        a.bytesLoaded = null;
        a.bytesTotal = null;
        a.duration = a._iO && a._iO.duration ? a._iO.duration : null;
        a.durationEstimate = null;
        a.buffered = [];
        a.eqData = [];
        a.eqData.left = [];
        a.eqData.right = [];
        a.failures = 0;
        a.isBuffering = !1;
        a.instanceOptions = {};
        a.instanceCount = 0;
        a.loaded = !1;
        a.metadata = {};
        a.readyState = 0;
        a.muted = !1;
        a.paused = !1;
        a.peakData = {
          left: 0,
          right: 0
        };
        a.waveformData = {
          left: [],
          right: []
        };
        a.playState = 0;
        a.position = null;
        a.id3 = {}
      };
      f();
      this._onTimer = function(b) {
        var c, f = !1,
          g = {};
        if (a._hasTimer || b) return a._a && (b || (0 < a.playState || 1 === a.readyState) && !a.paused) && (c = a._get_html5_duration(), c !== d && (d = c, a.duration = c, f = !0), a.durationEstimate = a.duration, c = 1E3 * a._a.currentTime || 0, c !== e && (e = c, f = !0), (f || b) && a._whileplaying(c, g, g, g, g)), f
      };
      this._get_html5_duration = function() {
        var b = a._iO;
        return (b = a._a && a._a.duration ? 1E3 * a._a.duration : b && b.duration ? b.duration : null) && !isNaN(b) && Infinity !== b ? b : null
      };
      this._apply_loop = function(a, b) {
        !a.loop && 1 < b && c._wD("Note: Native HTML5 looping is infinite.", 1);
        a.loop = 1 < b ? "loop" : ""
      };
      this._setup_html5 = function(b) {
        b = A(a._iO, b);
        var c = C ? Ya : a._a,
          d = decodeURI(b.url),
          e;
        C ? d === decodeURI(Ma) && (e = !0) : d === decodeURI(u) && (e = !0);
        if (c) {
          if (c._s)
            if (C) c._s && c._s.playState && !e && c._s.stop();
            else if (!C && d === decodeURI(u)) return a._apply_loop(c, b.loops), c;
          e || (u && f(!1), c.src = b.url, Ma = u = a.url = b.url, c._called_load = !1)
        } else b.autoLoad || b.autoPlay ? (a._a = new Audio(b.url), a._a.load()) : a._a = Sa && 10 > opera.version() ? new Audio(null) : new Audio, c = a._a, c._called_load = !1, C && (Ya = c);
        a.isHTML5 = !0;
        a._a = c;
        c._s = a;
        h();
        a._apply_loop(c, b.loops);
        b.autoLoad || b.autoPlay ? a.load() : (c.autobuffer = !1, c.preload = "auto");
        return c
      };
      h = function() {
        if (a._a._added_events) return !1;
        var b;
        a._a._added_events = !0;
        for (b in J) J.hasOwnProperty(b) && a._a && a._a.addEventListener(b, J[b], !1);
        return !0
      };
      k = function() {
        var b;
        c._wD(a.id + ": Removing event listeners");
        a._a._added_events = !1;
        for (b in J) J.hasOwnProperty(b) && a._a && a._a.removeEventListener(b, J[b], !1)
      };
      this._onload = function(b) {
        var d = !!b || !a.isHTML5 && 8 === n && a.duration;
        b = a.id + ": ";
        c._wD(b + (d ? "onload()" : "Failed to load / invalid sound?" + (a.duration ? " -" : " Zero-length duration reported.") + " (" + a.url + ")"), d ? 1 : 2);
        d || a.isHTML5 || (!0 === c.sandbox.noRemote && c._wD(b + t("noNet"), 1), !0 === c.sandbox.noLocal && c._wD(b + t("noLocal"), 1));
        a.loaded = d;
        a.readyState = d ? 3 : 2;
        a._onbufferchange(0);
        a._iO.onload && ua(a, function() {
          a._iO.onload.apply(a, [d])
        });
        return !0
      };
      this._onbufferchange = function(b) {
        if (0 === a.playState || b && a.isBuffering || !b && !a.isBuffering) return !1;
        a.isBuffering = 1 === b;
        a._iO.onbufferchange && (c._wD(a.id + ": Buffer state change: " + b), a._iO.onbufferchange.apply(a, [b]));
        return !0
      };
      this._onsuspend = function() {
        a._iO.onsuspend && (c._wD(a.id + ": Playback suspended"), a._iO.onsuspend.apply(a));
        return !0
      };
      this._onfailure = function(b, d, e) {
        a.failures++;
        c._wD(a.id + ": Failure (" + a.failures + "): " + b);
        if (a._iO.onfailure && 1 === a.failures) a._iO.onfailure(b, d, e);
        else c._wD(a.id + ": Ignoring failure")
      };
      this._onwarning = function(b, c, d) {
        if (a._iO.onwarning) a._iO.onwarning(b, c, d)
      };
      this._onfinish = function() {
        var b = a._iO.onfinish;
        a._onbufferchange(0);
        a._resetOnPosition(0);
        a.instanceCount && (a.instanceCount--, a.instanceCount || (Xa(), a.playState = 0, a.paused = !1, a.instanceCount = 0, a.instanceOptions = {}, a._iO = {}, G(), a.isHTML5 && (a.position = 0)), a.instanceCount && !a._iO.multiShotEvents || !b || (c._wD(a.id + ": onfinish()"), ua(a, function() {
          b.apply(a)
        })))
      };
      this._whileloading = function(b, c, d, e) {
        var f = a._iO;
        a.bytesLoaded = b;
        a.bytesTotal = c;
        a.duration = Math.floor(d);
        a.bufferLength = e;
        a.durationEstimate = a.isHTML5 || f.isMovieStar ? a.duration : f.duration ? a.duration > f.duration ? a.duration : f.duration : parseInt(a.bytesTotal / a.bytesLoaded * a.duration, 10);
        a.isHTML5 || (a.buffered = [{
          start: 0,
          end: a.duration
        }]);
        (3 !== a.readyState || a.isHTML5) && f.whileloading && f.whileloading.apply(a)
      };
      this._whileplaying = function(b, c, d, e, f) {
        var k = a._iO;
        if (isNaN(b) || null === b) return !1;
        a.position = Math.max(0, b);
        a._processOnPosition();
        !a.isHTML5 && 8 < n && (k.usePeakData && c !== g && c && (a.peakData = {
          left: c.leftPeak,
          right: c.rightPeak
        }), k.useWaveformData && d !== g && d && (a.waveformData = {
          left: d.split(","),
          right: e.split(",")
        }), k.useEQData && f !== g && f && f.leftEQ && (b = f.leftEQ.split(","), a.eqData = b, a.eqData.left = b, f.rightEQ !== g && f.rightEQ && (a.eqData.right = f.rightEQ.split(","))));
        1 === a.playState && (a.isHTML5 || 8 !== n || a.position || !a.isBuffering || a._onbufferchange(0), k.whileplaying && k.whileplaying.apply(a));
        return !0
      };
      this._oncaptiondata = function(b) {
        c._wD(a.id + ": Caption data received.");
        a.captiondata = b;
        a._iO.oncaptiondata && a._iO.oncaptiondata.apply(a, [b])
      };
      this._onmetadata = function(b, d) {
        c._wD(a.id + ": Metadata received.");
        var e = {},
          f, g;
        f = 0;
        for (g = b.length; f < g; f++) e[b[f]] = d[f];
        a.metadata = e;
        a._iO.onmetadata && a._iO.onmetadata.call(a, a.metadata)
      };
      this._onid3 = function(b, d) {
        c._wD(a.id + ": ID3 data received.");
        var e = [],
          f, g;
        f = 0;
        for (g = b.length; f < g; f++) e[b[f]] = d[f];
        a.id3 = A(a.id3, e);
        a._iO.onid3 && a._iO.onid3.apply(a)
      };
      this._onconnect = function(b) {
        b = 1 === b;
        c._wD(a.id + ": " + (b ? "Connected." : "Failed to connect? - " + a.url), b ? 1 : 2);
        if (a.connected = b) a.failures = 0, w(a.id) && (a.getAutoPlay() ? a.play(g, a.getAutoPlay()) : a._iO.autoLoad && a.load()), a._iO.onconnect && a._iO.onconnect.apply(a, [b])
      };
      this._ondataerror = function(b) {
        0 < a.playState && (c._wD(a.id + ": Data error: " + b), a._iO.ondataerror && a._iO.ondataerror.apply(a))
      };
      this._debug()
    };
    ma = function() {
      return m.body || m.getElementsByTagName("div")[0]
    };
    F = function(b) {
      return m.getElementById(b)
    };
    A = function(b, d) {
      var e = b || {},
        a, f;
      a = d === g ? c.defaultOptions : d;
      for (f in a) a.hasOwnProperty(f) && e[f] === g && (e[f] = "object" !== typeof a[f] || null === a[f] ? a[f] : A(e[f], a[f]));
      return e
    };
    ua = function(b, c) {
      b.isHTML5 || 8 !== n ? c() : h.setTimeout(c, 0)
    };
    R = {
      onready: 1,
      ontimeout: 1,
      defaultOptions: 1,
      flash9Options: 1,
      movieStarOptions: 1
    };
    Ba = function(b, d) {
      var e, a = !0,
        f = d !== g,
        h = c.setupOptions;
      if (b === g) {
        a = [];
        for (e in h) h.hasOwnProperty(e) && a.push(e);
        for (e in R) R.hasOwnProperty(e) && ("object" === typeof c[e] ? a.push(e + ": {...}") : c[e] instanceof Function ? a.push(e + ": function() {...}") : a.push(e));
        c._wD(t("setup", a.join(", ")));
        return !1
      }
      for (e in b)
        if (b.hasOwnProperty(e))
          if ("object" !== typeof b[e] || null === b[e] || b[e] instanceof Array || b[e] instanceof RegExp) f && R[d] !== g ? c[d][e] = b[e] : h[e] !== g ? (c.setupOptions[e] = b[e], c[e] = b[e]) : R[e] === g ? (L(t(c[e] === g ? "setupUndef" : "setupError", e), 2), a = !1) : c[e] instanceof Function ? c[e].apply(c, b[e] instanceof Array ? b[e] : [b[e]]) : c[e] = b[e];
          else if (R[e] === g) L(t(c[e] === g ? "setupUndef" : "setupError", e), 2), a = !1;
      else return Ba(b[e], e);
      return a
    };
    x = function() {
      function b(a) {
        a = kb.call(a);
        var b = a.length;
        e ? (a[1] = "on" + a[1], 3 < b && a.pop()) : 3 === b && a.push(!1);
        return a
      }

      function c(b, d) {
        var g = b.shift(),
          h = [a[d]];
        if (e) g[h](b[0], b[1]);
        else g[h].apply(g, b)
      }
      var e = h.attachEvent,
        a = {
          add: e ? "attachEvent" : "addEventListener",
          remove: e ? "detachEvent" : "removeEventListener"
        };
      return {
        add: function() {
          c(b(arguments), "add")
        },
        remove: function() {
          c(b(arguments), "remove")
        }
      }
    }();
    J = {
      abort: r(function() {
        c._wD(this._s.id + ": abort")
      }),
      canplay: r(function() {
        var b = this._s,
          d;
        if (b._html5_canplay) return !0;
        b._html5_canplay = !0;
        c._wD(b.id + ": canplay");
        b._onbufferchange(0);
        d = b._iO.position === g || isNaN(b._iO.position) ? null : b._iO.position / 1E3;
        if (this.currentTime !== d) {
          c._wD(b.id + ": canplay: Setting position to " + d);
          try {
            this.currentTime = d
          } catch (e) {
            c._wD(b.id + ": canplay: Setting position of " + d + " failed: " + e.message, 2)
          }
        }
        b._iO._oncanplay && b._iO._oncanplay()
      }),
      canplaythrough: r(function() {
        var b = this._s;
        b.loaded || (b._onbufferchange(0), b._whileloading(b.bytesLoaded, b.bytesTotal, b._get_html5_duration()), b._onload(!0))
      }),
      durationchange: r(function() {
        var b = this._s,
          d;
        d = b._get_html5_duration();
        isNaN(d) || d === b.duration || (c._wD(this._s.id + ": durationchange (" + d + ")" + (b.duration ? ", previously " + b.duration : "")), b.durationEstimate = b.duration = d)
      }),
      ended: r(function() {
        var b = this._s;
        c._wD(b.id + ": ended");
        b._onfinish()
      }),
      error: r(function() {
        c._wD(this._s.id + ": HTML5 error, code " + this.error.code);
        this._s._onload(!1)
      }),
      loadeddata: r(function() {
        var b = this._s;
        c._wD(b.id + ": loadeddata");
        b._loaded || va || (b.duration = b._get_html5_duration())
      }),
      loadedmetadata: r(function() {
        c._wD(this._s.id + ": loadedmetadata")
      }),
      loadstart: r(function() {
        c._wD(this._s.id + ": loadstart");
        this._s._onbufferchange(1)
      }),
      play: r(function() {
        this._s._onbufferchange(0)
      }),
      playing: r(function() {
        c._wD(this._s.id + ": playing " + String.fromCharCode(9835));
        this._s._onbufferchange(0)
      }),
      progress: r(function(b) {
        var d = this._s,
          e, a, f;
        e = 0;
        var g = "progress" === b.type,
          k = b.target.buffered,
          h = b.loaded || 0,
          m = b.total || 1;
        d.buffered = [];
        if (k && k.length) {
          e = 0;
          for (a = k.length; e < a; e++) d.buffered.push({
            start: 1E3 * k.start(e),
            end: 1E3 * k.end(e)
          });
          e = 1E3 * (k.end(0) - k.start(0));
          h = Math.min(1, e / (1E3 * b.target.duration));
          if (g && 1 < k.length) {
            f = [];
            a = k.length;
            for (e = 0; e < a; e++) f.push(1E3 * b.target.buffered.start(e) + "-" + 1E3 * b.target.buffered.end(e));
            c._wD(this._s.id + ": progress, timeRanges: " + f.join(", "))
          }
          g && !isNaN(h) && c._wD(this._s.id + ": progress, " + Math.floor(100 * h) + "% loaded")
        }
        isNaN(h) || (d._whileloading(h, m, d._get_html5_duration()), h && m && h === m && J.canplaythrough.call(this, b))
      }),
      ratechange: r(function() {
        c._wD(this._s.id + ": ratechange")
      }),
      suspend: r(function(b) {
        var d = this._s;
        c._wD(this._s.id + ": suspend");
        J.progress.call(this, b);
        d._onsuspend()
      }),
      stalled: r(function() {
        c._wD(this._s.id + ": stalled")
      }),
      timeupdate: r(function() {
        this._s._onTimer()
      }),
      waiting: r(function() {
        var b = this._s;
        c._wD(this._s.id + ": waiting");
        b._onbufferchange(1)
      })
    };
    sa = function(b) {
      return b && (b.type || b.url || b.serverURL) ? b.serverURL || b.type && ha(b.type) ? !1 : b.type ? fa({
        type: b.type
      }) : fa({
        url: b.url
      }) || c.html5Only || b.url.match(/data\:/i) : !1
    };
    ta = function(b) {
      var d;
      b && (d = va ? "about:blank" : c.html5.canPlayType("audio/wav") ? "data:audio/wave;base64,/UklGRiYAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQIAAAD//w==" : "about:blank", b.src = d, b._called_unload !== g && (b._called_load = !1));
      C && (Ma = null);
      return d
    };
    fa = function(b) {
      if (!c.useHTML5Audio || !c.hasHTML5) return !1;
      var d = b.url || null;
      b = b.type || null;
      var e = c.audioFormats,
        a;
      if (b && c.html5[b] !== g) return c.html5[b] && !ha(b);
      if (!N) {
        N = [];
        for (a in e) e.hasOwnProperty(a) && (N.push(a), e[a].related && (N = N.concat(e[a].related)));
        N = new RegExp("\\.(" + N.join("|") + ")(\\?.*)?$", "i")
      }(a = d ? d.toLowerCase().match(N) : null) && a.length ? a = a[1] : b && (d = b.indexOf(";"), a = (-1 !== d ? b.substr(0, d) : b).substr(6));
      a && c.html5[a] !== g ? d = c.html5[a] && !ha(a) : (b = "audio/" + a, d = c.html5.canPlayType({
        type: b
      }), d = (c.html5[a] = d) && c.html5[b] && !ha(b));
      return d
    };
    jb = function() {
      function b(a) {
        var b, e = b = !1;
        if (!d || "function" !== typeof d.canPlayType) return b;
        if (a instanceof Array) {
          k = 0;
          for (b = a.length; k < b; k++)
            if (c.html5[a[k]] || d.canPlayType(a[k]).match(c.html5Test)) e = !0, c.html5[a[k]] = !0, c.flash[a[k]] = !!a[k].match(pb);
          b = e
        } else a = d && "function" === typeof d.canPlayType ? d.canPlayType(a) : !1, b = !(!a || !a.match(c.html5Test));
        return b
      }
      if (!c.useHTML5Audio || !c.hasHTML5) return u = c.html5.usingFlash = !0, !1;
      var d = Audio !== g ? Sa && 10 > opera.version() ? new Audio(null) : new Audio : null,
        e, a, f = {},
        h, k;
      h = c.audioFormats;
      for (e in h)
        if (h.hasOwnProperty(e) && (a = "audio/" + e, f[e] = b(h[e].type), f[a] = f[e], e.match(pb) ? (c.flash[e] = !0, c.flash[a] = !0) : (c.flash[e] = !1, c.flash[a] = !1), h[e] && h[e].related))
          for (k = h[e].related.length - 1; 0 <= k; k--) f["audio/" + h[e].related[k]] = f[e], c.html5[h[e].related[k]] = f[e], c.flash[h[e].related[k]] = f[e];
      f.canPlayType = d ? b : null;
      c.html5 = A(c.html5, f);
      c.html5.usingFlash = ib();
      u = c.html5.usingFlash;
      return !0
    };
    z = {
      notReady: "Unavailable - wait until onready() has fired.",
      notOK: "Audio support is not available.",
      domError: "soundManagerexception caught while appending SWF to DOM.",
      spcWmode: "Removing wmode, preventing known SWF loading issue(s)",
      swf404: "soundManager: Verify that %s is a valid path.",
      tryDebug: "Try soundManager.debugFlash = true for more security details (output goes to SWF.)",
      checkSWF: "See SWF output for more debug info.",
      localFail: "soundManager: Non-HTTP page (" + m.location.protocol + " URL?) Review Flash player security settings for this special case:\nhttp://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html\nMay need to add/allow path, eg. c:/sm2/ or /users/me/sm2/",
      waitFocus: "soundManager: Special case: Waiting for SWF to load with window focus...",
      waitForever: "soundManager: Waiting indefinitely for Flash (will recover if unblocked)...",
      waitSWF: "soundManager: Waiting for 100% SWF load...",
      needFunction: "soundManager: Function object expected for %s",
      badID: 'Sound ID "%s" should be a string, starting with a non-numeric character',
      currentObj: "soundManager: _debug(): Current sound objects",
      waitOnload: "soundManager: Waiting for window.onload()",
      docLoaded: "soundManager: Document already loaded",
      onload: "soundManager: initComplete(): calling soundManager.onload()",
      onloadOK: "soundManager.onload() complete",
      didInit: "soundManager: init(): Already called?",
      secNote: "Flash security note: Network/internet URLs will not load due to security restrictions. Access can be configured via Flash Player Global Security Settings Page: http://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html",
      badRemove: "soundManager: Failed to remove Flash node.",
      shutdown: "soundManager.disable(): Shutting down",
      queue: "soundManager: Queueing %s handler",
      smError: "SMSound.load(): Exception: JS-Flash communication failed, or JS error.",
      fbTimeout: "No flash response, applying .swf_timedout CSS...",
      fbLoaded: "Flash loaded",
      fbHandler: "soundManager: flashBlockHandler()",
      manURL: "SMSound.load(): Using manually-assigned URL",
      onURL: "soundManager.load(): current URL already assigned.",
      badFV: 'soundManager.flashVersion must be 8 or 9. "%s" is invalid. Reverting to %s.',
      as2loop: "Note: Setting stream:false so looping can work (flash 8 limitation)",
      noNSLoop: "Note: Looping not implemented for MovieStar formats",
      needfl9: "Note: Switching to flash 9, required for MP4 formats.",
      mfTimeout: "Setting flashLoadTimeout = 0 (infinite) for off-screen, mobile flash case",
      needFlash: "soundManager: Fatal error: Flash is needed to play some required formats, but is not available.",
      gotFocus: "soundManager: Got window focus.",
      policy: "Enabling usePolicyFile for data access",
      setup: "soundManager.setup(): allowed parameters: %s",
      setupError: 'soundManager.setup(): "%s" cannot be assigned with this method.',
      setupUndef: 'soundManager.setup(): Could not find option "%s"',
      setupLate: "soundManager.setup(): url, flashVersion and html5Test property changes will not take effect until reboot().",
      noURL: "soundManager: Flash URL required. Call soundManager.setup({url:...}) to get started.",
      sm2Loaded: "SoundManager 2: Ready. " + String.fromCharCode(10003),
      reset: "soundManager.reset(): Removing event callbacks",
      mobileUA: "Mobile UA detected, preferring HTML5 by default.",
      globalHTML5: "Using singleton HTML5 Audio() pattern for this device.",
      ignoreMobile: "Ignoring mobile restrictions for this device."
    };
    t = function() {
      var b, c, e, a;
      b = kb.call(arguments);
      c = b.shift();
      if ((a = z && z[c] ? z[c] : "") && b && b.length)
        for (c = 0, e = b.length; c < e; c++) a = a.replace("%s", b[c]);
      return a
    };
    oa = function(b) {
      8 === n && 1 < b.loops && b.stream && (p("as2loop"), b.stream = !1);
      return b
    };
    pa = function(b, d) {
      b && !b.usePolicyFile && (b.onid3 || b.usePeakData || b.useWaveformData || b.useEQData) && (c._wD((d || "") + t("policy")), b.usePolicyFile = !0);
      return b
    };
    L = function(b) {
      Ua && console.warn !== g ? console.warn(b) : c._wD(b)
    };
    ya = function() {
      return !1
    };
    cb = function(b) {
      for (var c in b) b.hasOwnProperty(c) && "function" === typeof b[c] && (b[c] = ya)
    };
    Ha = function(b) {
      b === g && (b = !1);
      (y || b) && c.disable(b)
    };
    db = function(b) {
      var d = null;
      if (b)
        if (b.match(/\.swf(\?.*)?$/i)) {
          if (d = b.substr(b.toLowerCase().lastIndexOf(".swf?") + 4)) return b
        } else b.lastIndexOf("/") !== b.length - 1 && (b += "/");
      b = (b && -1 !== b.lastIndexOf("/") ? b.substr(0, b.lastIndexOf("/") + 1) : "./") + c.movieURL;
      c.noSWFCache && (b += "?ts=" + (new Date).getTime());
      return b
    };
    Ea = function() {
      n = parseInt(c.flashVersion, 10);
      8 !== n && 9 !== n && (c._wD(t("badFV", n, 8)), c.flashVersion = n = 8);
      var b = c.debugMode || c.debugFlash ? "_debug.swf" : ".swf";
      c.useHTML5Audio && !c.html5Only && c.audioFormats.mp4.required && 9 > n && (c._wD(t("needfl9")), c.flashVersion = n = 9);
      c.version = c.versionNumber + (c.html5Only ? " (HTML5-only mode)" : 9 === n ? " (AS3/Flash 9)" : " (AS2/Flash 8)");
      8 < n ? (c.defaultOptions = A(c.defaultOptions, c.flash9Options), c.features.buffering = !0, c.defaultOptions = A(c.defaultOptions, c.movieStarOptions), c.filePatterns.flash9 = new RegExp("\\.(mp3|" + rb.join("|") + ")(\\?.*)?$", "i"), c.features.movieStar = !0) : c.features.movieStar = !1;
      c.filePattern = c.filePatterns[8 !== n ? "flash9" : "flash8"];
      c.movieURL = (8 === n ? "soundmanager2.swf" : "soundmanager2_flash9.swf").replace(".swf", b);
      c.features.peakData = c.features.waveformData = c.features.eqData = 8 < n
    };
    ab = function(b, c) {
      if (!l) return !1;
      l._setPolling(b, c)
    };
    Ga = function() {
      c.debugURLParam.test(ia) && (c.setupOptions.debugMode = c.debugMode = !0);
      if (F(c.debugID)) return !1;
      var b, d, e, a;
      if (!(!c.debugMode || F(c.debugID) || Ua && c.useConsole && c.consoleOnly)) {
        b = m.createElement("div");
        b.id = c.debugID + "-toggle";
        d = {
          position: "fixed",
          bottom: "0px",
          right: "0px",
          width: "1.2em",
          height: "1.2em",
          lineHeight: "1.2em",
          margin: "2px",
          textAlign: "center",
          border: "1px solid #999",
          cursor: "pointer",
          background: "#fff",
          color: "#333",
          zIndex: 10001
        };
        b.appendChild(m.createTextNode("-"));
        b.onclick = eb;
        b.title = "Toggle SM2 debug console";
        v.match(/msie 6/i) && (b.style.position = "absolute", b.style.cursor = "hand");
        for (a in d) d.hasOwnProperty(a) && (b.style[a] = d[a]);
        d = m.createElement("div");
        d.id = c.debugID;
        d.style.display = c.debugMode ? "block" : "none";
        if (c.debugMode && !F(b.id)) {
          try {
            e = ma(), e.appendChild(b)
          } catch (f) {
            throw Error(t("domError") + " \n" + f.toString());
          }
          e.appendChild(d)
        }
      }
    };
    w = this.getSoundById;
    p = function(b, d) {
      return b ? c._wD(t(b), d) : ""
    };
    eb = function() {
      var b = F(c.debugID),
        d = F(c.debugID + "-toggle");
      if (!b) return !1;
      Aa ? (d.innerHTML = "+", b.style.display = "none") : (d.innerHTML = "-", b.style.display = "block");
      Aa = !Aa
    };
    D = function(b, c, e) {
      if (h.sm2Debugger !== g) try {
        sm2Debugger.handleEvent(b, c, e)
      } catch (a) {
        return !1
      }
      return !0
    };
    V = function() {
      var b = [];
      c.debugMode && b.push("sm2_debug");
      c.debugFlash && b.push("flash_debug");
      c.useHighPerformance && b.push("high_performance");
      return b.join(" ")
    };
    Ja = function() {
      var b = t("fbHandler"),
        d = c.getMoviePercent(),
        e = {
          type: "FLASHBLOCK"
        };
      if (c.html5Only) return !1;
      c.ok() ? (c.didFlashBlock && c._wD(b + ": Unblocked"), c.oMC && (c.oMC.className = [V(), "movieContainer", "swf_loaded" + (c.didFlashBlock ? " swf_unblocked" : "")].join(" "))) : (u && (c.oMC.className = V() + " movieContainer " + (null === d ? "swf_timedout" : "swf_error"), c._wD(b + ": " + t("fbTimeout") + (d ? " (" + t("fbLoaded") + ")" : ""))), c.didFlashBlock = !0, P({
        type: "ontimeout",
        ignoreInit: !0,
        error: e
      }), U(e))
    };
    Ca = function(b, c, e) {
      I[b] === g && (I[b] = []);
      I[b].push({
        method: c,
        scope: e || null,
        fired: !1
      })
    };
    P = function(b) {
      b || (b = {
        type: c.ok() ? "onready" : "ontimeout"
      });
      if (!q && b && !b.ignoreInit || "ontimeout" === b.type && (c.ok() || y && !b.ignoreInit)) return !1;
      var d = {
          success: b && b.ignoreInit ? c.ok() : !y
        },
        e = b && b.type ? I[b.type] || [] : [],
        a = [],
        f, d = [d],
        g = u && !c.ok();
      b.error && (d[0].error = b.error);
      b = 0;
      for (f = e.length; b < f; b++) !0 !== e[b].fired && a.push(e[b]);
      if (a.length)
        for (b = 0, f = a.length; b < f; b++) a[b].scope ? a[b].method.apply(a[b].scope, d) : a[b].method.apply(this, d), g || (a[b].fired = !0);
      return !0
    };
    S = function() {
      h.setTimeout(function() {
        c.useFlashBlock && Ja();
        P();
        "function" === typeof c.onload && (p("onload", 1), c.onload.apply(h), p("onloadOK", 1));
        c.waitForWindowLoad && x.add(h, "load", S)
      }, 1)
    };
    Na = function() {
      if (H !== g) return H;
      var b = !1,
        c = navigator,
        e = c.plugins,
        a, f = h.ActiveXObject;
      if (e && e.length)(c = c.mimeTypes) && c["application/x-shockwave-flash"] && c["application/x-shockwave-flash"].enabledPlugin && c["application/x-shockwave-flash"].enabledPlugin.description && (b = !0);
      else if (f !== g && !v.match(/MSAppHost/i)) {
        try {
          a = new f("ShockwaveFlash.ShockwaveFlash")
        } catch (m) {
          a = null
        }
        b = !!a
      }
      return H = b
    };
    ib = function() {
      var b, d, e = c.audioFormats;
      Qa && v.match(/os (1|2|3_0|3_1)\s/i) ? (c.hasHTML5 = !1, c.html5Only = !0, c.oMC && (c.oMC.style.display = "none")) : c.useHTML5Audio && (c.html5 && c.html5.canPlayType || (c._wD("SoundManager: No HTML5 Audio() support detected."), c.hasHTML5 = !1), Ta && c._wD("soundManager: Note: Buggy HTML5 Audio in Safari on this OS X release, see https://bugs.webkit.org/show_bug.cgi?id=32159 - " + (H ? "will use flash fallback for MP3/MP4, if available" : " would use flash fallback for MP3/MP4, but none detected."), 1));
      if (c.useHTML5Audio && c.hasHTML5)
        for (d in ea = !0, e) e.hasOwnProperty(d) && e[d].required && (c.html5.canPlayType(e[d].type) ? c.preferFlash && (c.flash[d] || c.flash[e[d].type]) && (b = !0) : (ea = !1, b = !0));
      c.ignoreFlash && (b = !1, ea = !0);
      c.html5Only = c.hasHTML5 && c.useHTML5Audio && !b;
      return !c.html5Only
    };
    ra = function(b) {
      var d, e, a = 0;
      if (b instanceof Array) {
        d = 0;
        for (e = b.length; d < e; d++)
          if (b[d] instanceof Object) {
            if (c.canPlayMIME(b[d].type)) {
              a = d;
              break
            }
          } else if (c.canPlayURL(b[d])) {
          a = d;
          break
        }
        b[a].url && (b[a] = b[a].url);
        b = b[a]
      }
      return b
    };
    fb = function(b) {
      b._hasTimer || (b._hasTimer = !0, !wa && c.html5PollingInterval && (null === da && 0 === qa && (da = setInterval(hb, c.html5PollingInterval)), qa++))
    };
    gb = function(b) {
      b._hasTimer && (b._hasTimer = !1, !wa && c.html5PollingInterval && qa--)
    };
    hb = function() {
      var b;
      if (null !== da && !qa) return clearInterval(da), da = null, !1;
      for (b = c.soundIDs.length - 1; 0 <= b; b--) c.sounds[c.soundIDs[b]].isHTML5 && c.sounds[c.soundIDs[b]]._hasTimer && c.sounds[c.soundIDs[b]]._onTimer()
    };
    U = function(b) {
      b = b !== g ? b : {};
      "function" === typeof c.onerror && c.onerror.apply(h, [{
        type: b.type !== g ? b.type : null
      }]);
      b.fatal !== g && b.fatal && c.disable()
    };
    lb = function() {
      if (!Ta || !Na()) return !1;
      var b = c.audioFormats,
        d, e;
      for (e in b)
        if (b.hasOwnProperty(e) && ("mp3" === e || "mp4" === e) && (c._wD("soundManager: Using flash fallback for " + e + " format"), c.html5[e] = !1, b[e] && b[e].related))
          for (d = b[e].related.length - 1; 0 <= d; d--) c.html5[b[e].related[d]] = !1
    };
    this._setSandboxType = function(b) {
      var d = c.sandbox;
      d.type = b;
      d.description = d.types[d.types[b] !== g ? b : "unknown"];
      "localWithFile" === d.type ? (d.noRemote = !0, d.noLocal = !1, p("secNote", 2)) : "localWithNetwork" === d.type ? (d.noRemote = !1, d.noLocal = !0) : "localTrusted" === d.type && (d.noRemote = !1, d.noLocal = !1)
    };
    this._externalInterfaceOK = function(b) {
      if (c.swfLoaded) return !1;
      var d;
      D("swf", !0);
      D("flashtojs", !0);
      c.swfLoaded = !0;
      xa = !1;
      Ta && lb();
      if (!b || b.replace(/\+dev/i, "") !== c.versionNumber.replace(/\+dev/i, "")) return d = 'soundManager: Fatal: JavaScript file build "' + c.versionNumber + '" does not match Flash SWF build "' +
        b + '" at ' + c.url + ". Ensure both are up-to-date.", setTimeout(function() {
          throw Error(d);
        }, 0), !1;
      setTimeout(za, O ? 100 : 1)
    };
    na = function(b, d) {
      function e() {
        var a = [],
          b, d = [];
        b = "SoundManager " + c.version + (!c.html5Only && c.useHTML5Audio ? c.hasHTML5 ? " + HTML5 audio" : ", no HTML5 audio support" : "");
        c.html5Only ? c.html5PollingInterval && a.push("html5PollingInterval (" + c.html5PollingInterval + "ms)") : (c.preferFlash && a.push("preferFlash"), c.useHighPerformance && a.push("useHighPerformance"), c.flashPollingInterval && a.push("flashPollingInterval (" +
          c.flashPollingInterval + "ms)"), c.html5PollingInterval && a.push("html5PollingInterval (" + c.html5PollingInterval + "ms)"), c.wmode && a.push("wmode (" + c.wmode + ")"), c.debugFlash && a.push("debugFlash"), c.useFlashBlock && a.push("flashBlock"));
        a.length && (d = d.concat([a.join(" + ")]));
        c._wD(b + (d.length ? " + " + d.join(", ") : ""), 1);
        mb()
      }

      function a(a, b) {
        return '<param name="' + a + '" value="' + b + '" />'
      }
      if (X && Y) return !1;
      if (c.html5Only) return Ea(), e(), c.oMC = F(c.movieID), za(), Y = X = !0, !1;
      var f = d || c.url,
        h = c.altURL || f,
        k = ma(),
        l = V(),
        n = null,
        n = m.getElementsByTagName("html")[0],
        p, r, q, n = n && n.dir && n.dir.match(/rtl/i);
      b = b === g ? c.id : b;
      Ea();
      c.url = db(ga ? f : h);
      d = c.url;
      c.wmode = !c.wmode && c.useHighPerformance ? "transparent" : c.wmode;
      null !== c.wmode && (v.match(/msie 8/i) || !O && !c.useHighPerformance) && navigator.platform.match(/win32|win64/i) && (M.push(z.spcWmode), c.wmode = null);
      k = {
        name: b,
        id: b,
        src: d,
        quality: "high",
        allowScriptAccess: c.allowScriptAccess,
        bgcolor: c.bgColor,
        pluginspage: vb + "www.macromedia.com/go/getflashplayer",
        title: "JS/Flash audio component (SoundManager 2)",
        type: "application/x-shockwave-flash",
        wmode: c.wmode,
        hasPriority: "true"
      };
      c.debugFlash && (k.FlashVars = "debug=1");
      c.wmode || delete k.wmode;
      if (O) f = m.createElement("div"), r = ['<object id="' + b + '" data="' + d + '" type="' + k.type + '" title="' + k.title + '" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0">', a("movie", d), a("AllowScriptAccess", c.allowScriptAccess), a("quality", k.quality), c.wmode ? a("wmode", c.wmode) : "", a("bgcolor", c.bgColor), a("hasPriority", "true"), c.debugFlash ? a("FlashVars", k.FlashVars) : "", "</object>"].join("");
      else
        for (p in f = m.createElement("embed"), k) k.hasOwnProperty(p) && f.setAttribute(p, k[p]);
      Ga();
      l = V();
      if (k = ma())
        if (c.oMC = F(c.movieID) || m.createElement("div"), c.oMC.id) q = c.oMC.className, c.oMC.className = (q ? q + " " : "movieContainer") + (l ? " " + l : ""), c.oMC.appendChild(f), O && (p = c.oMC.appendChild(m.createElement("div")), p.className = "sm2-object-box", p.innerHTML = r), Y = !0;
        else {
          c.oMC.id = c.movieID;
          c.oMC.className = "movieContainer " +
            l;
          p = l = null;
          c.useFlashBlock || (c.useHighPerformance ? l = {
            position: "fixed",
            width: "8px",
            height: "8px",
            bottom: "0px",
            left: "0px",
            overflow: "hidden"
          } : (l = {
            position: "absolute",
            width: "6px",
            height: "6px",
            top: "-9999px",
            left: "-9999px"
          }, n && (l.left = Math.abs(parseInt(l.left, 10)) + "px")));
          ub && (c.oMC.style.zIndex = 1E4);
          if (!c.debugFlash)
            for (q in l) l.hasOwnProperty(q) && (c.oMC.style[q] = l[q]);
          try {
            O || c.oMC.appendChild(f), k.appendChild(c.oMC), O && (p = c.oMC.appendChild(m.createElement("div")), p.className = "sm2-object-box", p.innerHTML = r), Y = !0
          } catch (u) {
            throw Error(t("domError") + " \n" + u.toString());
          }
        } X = !0;
      e();
      return !0
    };
    la = function() {
      if (c.html5Only) return na(), !1;
      if (l) return !1;
      if (!c.url) return p("noURL"), !1;
      l = c.getMovie(c.id);
      l || (ba ? (O ? c.oMC.innerHTML = Ia : c.oMC.appendChild(ba), ba = null, X = !0) : na(c.id, c.url), l = c.getMovie(c.id));
      "function" === typeof c.oninitmovie && setTimeout(c.oninitmovie, 1);
      Oa();
      return !0
    };
    T = function() {
      setTimeout($a, 1E3)
    };
    Da = function() {
      h.setTimeout(function() {
        L("soundManager: useFlashBlock is false, 100% HTML5 mode is possible. Rebooting with preferFlash: false...");
        c.setup({
          preferFlash: !1
        }).reboot();
        c.didFlashBlock = !0;
        c.beginDelayedInit()
      }, 1)
    };
    $a = function() {
      var b, d = !1;
      if (!c.url || ca) return !1;
      ca = !0;
      x.remove(h, "load", T);
      if (H && xa && !Va) return p("waitFocus"), !1;
      q || (b = c.getMoviePercent(), 0 < b && 100 > b && (d = !0));
      setTimeout(function() {
        b = c.getMoviePercent();
        if (d) return ca = !1, c._wD(t("waitSWF")), h.setTimeout(T, 1), !1;
        q || (c._wD("soundManager: No Flash response within expected time. Likely causes: " + (0 === b ? "SWF load failed, " : "") + "Flash blocked or JS-Flash security error." + (c.debugFlash ? " " + t("checkSWF") : ""), 2), !ga && b && (p("localFail", 2), c.debugFlash || p("tryDebug", 2)), 0 === b && c._wD(t("swf404", c.url), 1), D("flashtojs", !1, ": Timed out" + (ga ? " (Check flash security or flash blockers)" : " (No plugin/missing SWF?)")));
        !q && ob && (null === b ? c.useFlashBlock || 0 === c.flashLoadTimeout ? (c.useFlashBlock && Ja(), p("waitForever")) : !c.useFlashBlock && ea ? Da() : (p("waitForever"), P({
          type: "ontimeout",
          ignoreInit: !0,
          error: {
            type: "INIT_FLASHBLOCK"
          }
        })) : 0 === c.flashLoadTimeout ? p("waitForever") : !c.useFlashBlock && ea ? Da() : Ha(!0))
      }, c.flashLoadTimeout)
    };
    ka = function() {
      if (Va || !xa) return x.remove(h, "focus", ka), !0;
      Va = ob = !0;
      p("gotFocus");
      ca = !1;
      T();
      x.remove(h, "focus", ka);
      return !0
    };
    Oa = function() {
      M.length && (c._wD("SoundManager 2: " + M.join(" "), 1), M = [])
    };
    mb = function() {
      Oa();
      var b, d = [];
      if (c.useHTML5Audio && c.hasHTML5) {
        for (b in c.audioFormats) c.audioFormats.hasOwnProperty(b) && d.push(b + " = " + c.html5[b] + (!c.html5[b] && u && c.flash[b] ? " (using flash)" : c.preferFlash && c.flash[b] && u ? " (preferring flash)" : c.html5[b] ? "" : " (" + (c.audioFormats[b].required ? "required, " : "") + "and no flash support)"));
        c._wD("SoundManager 2 HTML5 support: " + d.join(", "), 1)
      }
    };
    Z = function(b) {
      if (q) return !1;
      if (c.html5Only) return p("sm2Loaded", 1), q = !0, S(), D("onload", !0), !0;
      var d = !0,
        e;
      c.useFlashBlock && c.flashLoadTimeout && !c.getMoviePercent() || (q = !0);
      e = {
        type: !H && u ? "NO_FLASH" : "INIT_TIMEOUT"
      };
      c._wD("SoundManager 2 " + (y ? "failed to load" : "loaded") + " (" + (y ? "Flash security/load error" : "OK") + ") " + String.fromCharCode(y ? 10006 : 10003), y ? 2 : 1);
      y || b ? (c.useFlashBlock && c.oMC && (c.oMC.className = V() + " " + (null === c.getMoviePercent() ? "swf_timedout" : "swf_error")), P({
        type: "ontimeout",
        error: e,
        ignoreInit: !0
      }), D("onload", !1), U(e), d = !1) : D("onload", !0);
      y || (c.waitForWindowLoad && !ja ? (p("waitOnload"), x.add(h, "load", S)) : (c.waitForWindowLoad && ja && p("docLoaded"), S()));
      return d
    };
    Za = function() {
      var b, d = c.setupOptions;
      for (b in d) d.hasOwnProperty(b) && (c[b] === g ? c[b] = d[b] : c[b] !== d[b] && (c.setupOptions[b] = c[b]))
    };
    za = function() {
      if (q) return p("didInit"), !1;
      if (c.html5Only) return q || (x.remove(h, "load", c.beginDelayedInit), c.enabled = !0, Z()), !0;
      la();
      try {
        l._externalInterfaceTest(!1), ab(!0, c.flashPollingInterval || (c.useHighPerformance ? 10 : 50)), c.debugMode || l._disableDebug(), c.enabled = !0, D("jstoflash", !0), c.html5Only || x.add(h, "unload", ya)
      } catch (b) {
        return c._wD("js/flash exception: " + b.toString()), D("jstoflash", !1), U({
          type: "JS_TO_FLASH_EXCEPTION",
          fatal: !0
        }), Ha(!0), Z(), !1
      }
      Z();
      x.remove(h, "load", c.beginDelayedInit);
      return !0
    };
    Q = function() {
      if (aa) return !1;
      aa = !0;
      Za();
      Ga();
      !H && c.hasHTML5 && (c._wD("SoundManager 2: No Flash detected" +
        (c.useHTML5Audio ? ". Trying HTML5-only mode." : ", enabling HTML5."), 1), c.setup({
        useHTML5Audio: !0,
        preferFlash: !1
      }));
      jb();
      !H && u && (M.push(z.needFlash), c.setup({
        flashLoadTimeout: 1
      }));
      m.removeEventListener && m.removeEventListener("DOMContentLoaded", Q, !1);
      la();
      return !0
    };
    La = function() {
      "complete" === m.readyState && (Q(), m.detachEvent("onreadystatechange", La));
      return !0
    };
    Fa = function() {
      ja = !0;
      Q();
      x.remove(h, "load", Fa)
    };
    Na();
    x.add(h, "focus", ka);
    x.add(h, "load", T);
    x.add(h, "load", Fa);
    m.addEventListener ? m.addEventListener("DOMContentLoaded", Q, !1) : m.attachEvent ? m.attachEvent("onreadystatechange", La) : (D("onload", !1), U({
      type: "NO_DOM2_EVENTS",
      fatal: !0
    }))
  }
  if (!h || !h.document) throw Error("SoundManager requires a browser with window and document objects.");
  var W = null;
  h.SM2_DEFER !== g && SM2_DEFER || (W = new K);
  "object" === typeof module && module && "object" === typeof module.exports ? (module.exports.SoundManager = K, module.exports.soundManager = W) : "function" === typeof define && define.amd && define(function() {
    return {
      constructor: K,
      getInstance: function(g) {
        !h.soundManager && g instanceof Function && (g = g(K), g instanceof K && (h.soundManager = g));
        return h.soundManager
      }
    }
  });
  h.SoundManager = K;
  h.soundManager = W
})(window);
var ServerClass = function(params) {
  this.lab = function() {
    return params['lab'];
  };
  this.basePath = params['basePath'];
  this.ajaxFailRetry = ('ajaxFailRetry' in params) ? params['ajaxFailRetry'] : 3;
  this.skey = ('skey' in params) ? params['skey'] : null;
  this.reqIDFields = ('reqIDFields' in params) ? params['reqIDFields'] : ['answers', 'ping', 'end', 'save', 'arrProblemAnswer'];
  this.pingInterval = ('pingInterval' in params) ? params['pingInterval'] : 600000;
  this.deferredCalls = null;
  this.callDeferred = false;
  var _this = this;
  if (this.pingInterval > 0)
    setInterval(function() {
      _this.ping();
    }, _this.pingInterval);
};
ServerClass.prototype.ajaxCall = function(url, params) {
  var _this = this;
  var ajaxParam = {
    dataType: 'json',
    cache: false,
    retryCount: 0,
    success: function(data, textStatus, jqXHR) {
      var deferred = ('deferred' in params) ? params['deferred'] : false;
      if (_this.callDeferred) deferred = false;
      _this.onDataSuccess(data, textStatus, jqXHR, deferred);
      if ('callback' in params) {
        var callbackparam = {};
        if ('callbackparam' in params) callbackparam = params['callbackparam'];
        params['callback'].call(_this.lab(), callbackparam);
      }
    },
    error: function(jqXHR, textStatus, errorThrown) {
      this.retryCount++;
      if (this.retryCount <= _this.ajaxFailRetry) {
        $.ajax(this);
        return;
      }
    }
  };
  for (p in params)
    ajaxParam[p] = params[p];
  if (!ajaxParam['data']) ajaxParam['data'] = {};
  if ((!('ping' in ajaxParam['data'])) && (!('IsReadAloudStudent' in ajaxParam['data'])) && (('deferred' in params) && params['deferred'])) {
    this.deferredCalls = null;
    this.callDeferred = false;
  }
  if (this.skey != '') ajaxParam['data']['skey'] = this.skey;
  ajaxParam['data']['callID'] = Math.floor((Math.random() * 999999) + 1);
  url = this.reqID(url, ajaxParam);
  $.ajax(this.basePath + url, ajaxParam);
};
ServerClass.prototype.reqID = function(url, params) {
  if ('type' in params) {
    if (params['type'] == 'POST') {
      url += '?_=' + Math.floor((Math.random() * 9999) + 1);
      if (this.lab().mode) url += '&mode=' + this.lab().mode;
      if (params['data']['skey']) url += '&skey=' + params['data']['skey'];
      if (params['data']['callID']) url += '&callID=' + params['data']['callID'];
      var extra = '';
      for (var i = 0; i < this.reqIDFields.length; i++)
        if (params['data'][this.reqIDFields[i]]) {
          extra += (extra.length > 0) ? '-' : '';
          extra += this.reqIDFields[i];
        }
      url += '&reqid=' + extra;
    }
  }
  return url;
};
ServerClass.prototype.onDataSuccess = function(data, textStatus, jqXHR, deferred) {
  if (data) {
    if (data['data']) {
      for (var dataindex in data['data'])
        if (this.lab().hasOwnProperty(dataindex))
          this.lab()[dataindex] = data['data'][dataindex];
    }
    if (deferred) this.deferredCalls = data['command'];
    else this.executeCommands(data['command']);
  }
};
ServerClass.prototype.executeCommands = function(commands) {
  if (!commands) return;
  var labFunc;
  for (var cmdindex in commands) {
    if (cmdindex in this.lab()) {
      if (commands[cmdindex] != null) labFunc = this.lab()[cmdindex](commands[cmdindex]);
      else labFunc = this.lab()[cmdindex]();
      delete commands[cmdindex];
      if (typeof labFunc !== 'undefined') {
        this.deferredCalls = commands;
        return;
      }
    } else delete commands[cmdindex];
  }
};
ServerClass.prototype.executeDeferred = function() {
  this.executeCommands(this.deferredCalls);
};
ServerClass.prototype.waitForDeferred = function() {
  this.callDeferred = true;
  $('#loading').hide();
  if ((this.deferredCalls) && (!$.isEmptyObject(this.deferredCalls))) this.executeDeferred();
  else $('#loading').show();
};
ServerClass.prototype.ping = function() {
  this.ajaxCall('update', {
    type: 'POST',
    data: {
      mode: this.lab().mode,
      skey: this.skey,
      ping: true
    }
  });
};
var SoundClass = function(params) {
  var _this = this;
  this.IsReadAloudTeacher = params['IsReadAloudTeacher'];
  this.IsReadAloudStudent = ('IsReadAloudStudent' in params) ? params['IsReadAloudStudent'] : 2;
  this.soundMessage = params['soundMessage'];
  this.soundStatus = -1;
  this.canPlaySound = false;
  this.soundFile = '';
  this.stoppedPlaying = false;
  this.preloadedSounds = {};
  this.onReady = (params.onReady !== undefined ? params.onReady : function() {});
  this.soundLoadedPromise = $.Deferred();
  soundManager.setup({
    debugMode: false,
    url: '/MM/css/lab/swf/',
    flashVersion: 8,
    useFlashBlock: false,
    flashLoadTimeout: 40000,
    allowScriptAccess: 'always',
    noSWFCache: true,
    preferFlash: ('msie' in $.browser),
    ontimeout: function(status) {
      if (status.type == 'NO_FLASH') _this.soundStatus = 4;
      else if (status.type == 'INIT_TIMEOUT' && FlashDetect.major < 9) _this.soundStatus = 5;
      else _this.soundStatus = 7;
      _this.soundLoadedPromise.reject();
    },
    onready: function() {
      _this.onSoundReady();
      _this.onReady();
      _this.soundLoadedPromise.resolve();
    }
  });
};
SoundClass.prototype.onSoundReady = function() {
  this.soundStatus = 0;
  this.canPlaySound = true;
  if (this.soundFile != '') this.playFile(this.soundFile);
};
SoundClass.prototype.playFile = function(url, pause) {
  var _this = this;
  if (!this.stoppedPlaying) {
    if (((this.IsReadAloudTeacher) && (this.IsReadAloudStudent > 0)) || window.EarlyLab !== undefined) {
      if (this.soundStatus == -1) this.soundFile = url;
      else {
        if (this.canPlaySound) {
          this.stopPlay();
          soundManager.createSound({
            id: 'vSound',
            url: url,
            onload: function(bSuccess) {
              _this.soundStatus = bSuccess ? 1 : 6;
            }
          });
          soundManager.play('vSound');
          if ((arguments.length > 1) && pause) soundManager.pause('vSound');
        }
      }
    }
  } else {
    this.stoppedPlaying = false;
  }
};
SoundClass.prototype.playSoundPreloaded = function(url, callback) {
  var name = url;
  if (this.preloadedSounds[name] !== undefined && this.preloadedSounds[name].loaded == true) {
    var play = function() {
      soundManager.play(name);
    };
    if (callback !== undefined) {
      var duration = soundManager.getSoundById(name).duration === undefined ? 1000 : soundManager.getSoundById(name).duration;
      duration = duration == 0 || duration === undefined || duration === null || duration < 1000 ? 1000 : duration;
      if ((typeof window.nativeBridge != 'undefined' && window.nativeBridge.isSyncLockTablet() == true) || (window.navigator.userAgent.toLowerCase().indexOf('chrome') > 0 && window.navigator.userAgent.toLowerCase().indexOf('android') > 0)) {
        duration += 2000;
      }
      callback(true, soundManager.getSoundById(name).duration, play);
    } else {
      play();
    }
  } else {
    soundManager.destroySound('dynamicSound');
    var autoLoad = (typeof app.labInit !== 'undefined' && typeof app.labInit.isMobile !== 'undefined' && app.labInit.isMobile != '') ? false : true;
    options = {
      id: 'dynamicSound',
      url: url,
      autoLoad: autoLoad,
      onload: function(ok) {
        if (this.readyState === 3) {
          var duration = this.duration == 0 || this.duration === undefined || this.duration === null || this.duration < 1000 ? 1000 : this.duration;
          if ((typeof window.nativeBridge != 'undefined' && window.nativeBridge.isSyncLockTablet() == true) || (window.navigator.userAgent.toLowerCase().indexOf('chrome') > 0 && window.navigator.userAgent.toLowerCase().indexOf('android') > 0)) {
            duration += 2000;
          }
          var play = function() {
            soundManager.play('dynamicSound');
          };
          if (callback !== undefined) {
            callback(ok, duration, play);
          } else {
            if (ok) play();
          }
        } else {
          if (callback !== undefined) {
            callback(false, 1000, function() {});
          }
        }
      }
    };
    soundManager.createSound(options);
  }
};
SoundClass.prototype.playSoundPreloadedPromise = function(mp3, fallbackTime, callback) {
  this.playSoundPreloadedPromiseDeffer = $.Deferred();
  var resolveAfter = function(timeToWait) {
    this.playSoundPreloadedPromiseTimeout = setTimeout(function() {
      this.playSoundPreloadedPromiseDeffer.resolve();
      if (typeof callback !== 'undefined') {
        callback();
      }
    }.bind(this), timeToWait);
  }.bind(this);
  if (mp3) {
    if (isIOS() || navigator.userAgent.indexOf('CriOS') > -1) {
      this.playInitedSound(mp3);
      resolveAfter(fallbackTime);
    } else {
      this.playSoundPreloaded(mp3, function(ok, duration, play) {
        if (ok) {
          play();
          resolveAfter(duration);
        } else {
          this.playInitedSound(mp3);
          resolveAfter(fallbackTime);
        }
      }.bind(this));
    }
  } else {
    resolveAfter(fallbackTime);
  }
  return this.playSoundPreloadedPromiseDeffer;
};
SoundClass.prototype.preloadSounds = function(sounds) {
  if (typeof app.labInit !== 'undefined' && typeof app.labInit.isMobile !== 'undefined' && app.labInit.isMobile != '') return;
  var loader = new PxLoader();
  var i, len, foundUnloaded = false;
  for (i = 0, len = sounds.length; i < len; i++) {
    if ((typeof this.preloadedSounds[sounds[i].name] != 'undefined') && (this.preloadedSounds[sounds[i].name].url == sounds[i].url))
      continue;
    loader.addSound(sounds[i].name, sounds[i].url);
    this.preloadedSounds[sounds[i].name] = {
      url: sounds[i].url,
      loaded: false
    };
    foundUnloaded = true;
  }
  if (foundUnloaded) {
    loader.addProgressListener(function(e) {
      if (e.timeout == true || e.error == true || e.loaded == false) {
        this.preloadedSounds[e.resource.sound.sID].loaded = false;
      } else {
        this.preloadedSounds[e.resource.sound.sID].loaded = true;
      }
    }.bind(this));
    loader.start();
  }
};
SoundClass.prototype.stopPlay = function() {
  if (typeof this.playSoundPreloadedPromiseTimeout === 'undefined') {
    this.playSoundPreloadedPromiseTimeout = null;
  }
  if (this.playSoundPreloadedPromiseTimeout) {
    clearTimeout(this.playSoundPreloadedPromiseTimeout);
    this.playSoundPreloadedPromiseTimeout = null;
  }
  if (typeof this.playSoundPreloadedPromiseDeffer === 'undefined') {
    this.playSoundPreloadedPromiseDeffer = null;
  }
  if (this.playSoundPreloadedPromiseDeffer) {
    this.playSoundPreloadedPromiseDeffer.reject();
  }
  if (this.canPlaySound) {
    this.soundFile = '';
    soundManager.stopAll();
    soundManager.destroySound('vSound');
    soundManager.destroySound('dynamicSound');
  } else {
    this.stoppedPlaying = true;
  }
};
SoundClass.prototype.setMessage = function() {
  if (this.IsReadAloudTeacher != 1) this.soundStatus = 2;
  $('#sound-settings .sound-diagnostic-fieldset .sound-diagnostic-text').html(this.soundMessage[this.soundStatus]);
  if (this.soundStatus === 2) {
    $('.sound-setting-fieldset').attr('disabled', 'disabled');
    $('.voice-section').hide();
    $('.word-highlighting-section').hide();
  }
};
var TimerClass = function(params) {
  $('body').append('<div id="lab-pause"><div class="overlay"></div><img src="https://data.mobymax.com/lab/lab/Pause.png" width="182" height="182" onclick="' + params['labName'] + '.timer.unPause();"/></div>');
  var _this = this;
  setInterval(function() {
    _this.idleTimerCallback();
  }, 1000);
  setInterval(function() {
    _this.timerCallback();
  }, 1000);
  var mouseX, mouseY;
  $(document).mousemove(function(evt) {
    if (evt.clientX != mouseX || evt.clientY != mouseY) {
      _this.idleActive();
      mouseX = evt.clientX;
      mouseY = evt.clientY;
    }
  });
  $(document).keypress(function() {
    _this.idleActive();
  });
  $(document).on("touchstart touchend", function() {
    _this.idleActive();
  });
  this.idleSeconds = ('idleSeconds' in params) ? params['idleSeconds'] : 120;
  this.studentIdle = false;
  this.canPause = true;
  this.idleTimer = 0;
  this.timerActive = true;
  this.timerCounter = 0;
  this.timers = {};
  this.callbackfunctions = {};
  this.labName = params.labName;
};
TimerClass.prototype.idleTimerCallback = function() {
  if (!this.studentIdle && this.canPause) {
    if (++this.idleTimer >= this.idleSeconds) {
      this.studentIdle = true;
      $('#lab-pause').show();
      this.timerPause();
      $(document).trigger('pause.' + this.labName);
    }
  }
};
TimerClass.prototype.timerCallback = function() {
  if (this.timerActive) {
    this.timerCounter++;
    for (var i in this.timers) {
      this.timers[i]++;
      if (typeof this.callbackfunctions[i] !== 'undefined') {
        this.callbackfunctions[i].call(this, this.timers[i]);
      }
    }
  }
};
TimerClass.prototype.idleActive = function() {
  this.idleTimer = 0;
};
TimerClass.prototype.unPause = function() {
  this.idleTimer = 0;
  if (this.studentIdle) {
    this.studentIdle = false;
    $('#lab-pause').hide();
    this.timerUnpause();
    $(document).trigger('resume.' + this.labName);
  }
};
TimerClass.prototype.Start = function(timerName) {
  var _this = this;
  var startValue = (arguments.length > 2) ? arguments[2] : 0;
  if (!timerName) this.timerCounter = startValue;
  else this.timers[timerName] = startValue;
  if (arguments.length > 1) {
    _this.callbackfunctions[timerName] = arguments[1];
  }
};
TimerClass.prototype.timerPause = function() {
  this.timerActive = false;
};
TimerClass.prototype.timerUnpause = function() {
  this.timerActive = true;
};
TimerClass.prototype.GetTime = function(timerName) {
  if (!timerName) return this.timerCounter;
  else return (timerName in this.timers) ? this.timers[timerName] : 0;
};
TimerClass.prototype.RemoveTimer = function(timerName) {
  if (typeof this.timers[timerName] !== 'undefined') {
    delete(this.timers[timerName]);
    delete(this.callbackfunctions[timerName]);
  }
};
var FlashDetect = new function() {
  var self = this;
  self.installed = false;
  self.raw = "";
  self.major = -1;
  self.minor = -1;
  self.revision = -1;
  self.revisionStr = "";
  var activeXDetectRules = [{
    "name": "ShockwaveFlash.ShockwaveFlash.7",
    "version": function(obj) {
      return getActiveXVersion(obj);
    }
  }, {
    "name": "ShockwaveFlash.ShockwaveFlash.6",
    "version": function(obj) {
      var version = "6,0,21";
      try {
        obj.AllowScriptAccess = "always";
        version = getActiveXVersion(obj);
      } catch (err) {}
      return version;
    }
  }, {
    "name": "ShockwaveFlash.ShockwaveFlash",
    "version": function(obj) {
      return getActiveXVersion(obj);
    }
  }];
  var getActiveXVersion = function(activeXObj) {
    var version = -1;
    try {
      version = activeXObj.GetVariable("$version");
    } catch (err) {}
    return version;
  };
  var getActiveXObject = function(name) {
    var obj = -1;
    try {
      obj = new ActiveXObject(name);
    } catch (err) {
      obj = {
        activeXError: true
      };
    }
    return obj;
  };
  var parseActiveXVersion = function(str) {
    var versionArray = str.split(",");
    return {
      "raw": str,
      "major": parseInt(versionArray[0].split(" ")[1], 10),
      "minor": parseInt(versionArray[1], 10),
      "revision": parseInt(versionArray[2], 10),
      "revisionStr": versionArray[2]
    };
  };
  var parseStandardVersion = function(str) {
    var descParts = str.split(/ +/);
    var majorMinor = descParts[2].split(/\./);
    var revisionStr = descParts[3];
    return {
      "raw": str,
      "major": parseInt(majorMinor[0], 10),
      "minor": parseInt(majorMinor[1], 10),
      "revisionStr": revisionStr,
      "revision": parseRevisionStrToInt(revisionStr)
    };
  };
  var parseRevisionStrToInt = function(str) {
    return parseInt(str.replace(/[a-zA-Z]/g, ""), 10) || self.revision;
  };
  self.majorAtLeast = function(version) {
    return self.major >= version;
  };
  self.minorAtLeast = function(version) {
    return self.minor >= version;
  };
  self.revisionAtLeast = function(version) {
    return self.revision >= version;
  };
  self.versionAtLeast = function(major) {
    var properties = [self.major, self.minor, self.revision];
    var len = Math.min(properties.length, arguments.length);
    for (i = 0; i < len; i++) {
      if (properties[i] >= arguments[i]) {
        if (i + 1 < len && properties[i] == arguments[i]) {
          continue;
        } else {
          return true;
        }
      } else {
        return false;
      }
    }
  };
  self.FlashDetect = function() {
    if (navigator.plugins && navigator.plugins.length > 0) {
      var type = 'application/x-shockwave-flash';
      var mimeTypes = navigator.mimeTypes;
      if (mimeTypes && mimeTypes[type] && mimeTypes[type].enabledPlugin && mimeTypes[type].enabledPlugin.description) {
        var version = mimeTypes[type].enabledPlugin.description;
        var versionObj = parseStandardVersion(version);
        self.raw = versionObj.raw;
        self.major = versionObj.major;
        self.minor = versionObj.minor;
        self.revisionStr = versionObj.revisionStr;
        self.revision = versionObj.revision;
        self.installed = true;
      }
    } else if (navigator.appVersion.indexOf("Mac") == -1 && window.execScript) {
      var version = -1;
      for (var i = 0; i < activeXDetectRules.length && version == -1; i++) {
        var obj = getActiveXObject(activeXDetectRules[i].name);
        if (!obj.activeXError) {
          self.installed = true;
          version = activeXDetectRules[i].version(obj);
          if (version != -1) {
            var versionObj = parseActiveXVersion(version);
            self.raw = versionObj.raw;
            self.major = versionObj.major;
            self.minor = versionObj.minor;
            self.revision = versionObj.revision;
            self.revisionStr = versionObj.revisionStr;
          }
        }
      }
    }
  }();
};
FlashDetect.JS_RELEASE = "1.0.4";
var isIOS = function() {
  if ((window.navigator.userAgent.toLowerCase().indexOf('ipad') > 0 || window.navigator.userAgent.toLowerCase().indexOf('iphone') > 0 || /iPad|iPhone|iPod/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) && window.navigator.userAgent.toLowerCase().indexOf('crios') < 0) {
    return true;
  }
  return false;
};
var isIOS8 = function() {
  var deviceAgent = navigator.userAgent.toLowerCase();
  return /(iphone|ipod|ipad).* os 8_/.test(deviceAgent);
};
var getIOSVersion = function() {
  if (isIOS()) {
    var extract = navigator.userAgent.match(/OS (\d+)_(\d+)_?(\d+)?/);
    if (extract && extract[1])
      return parseInt(extract[1]);
  }
  return null;
}
var isDefaultAndroid = function() {
  if (typeof window.nativeBridge != 'undefined' && window.nativeBridge.isSyncLockTablet() == true) {
    return false;
  }
  var navU = navigator.userAgent;
  var isAndroidMobile = navU.indexOf('Android') > -1 && navU.indexOf('Mozilla/5.0') > -1 && navU.indexOf('AppleWebKit') > -1;
  if (!isAndroidMobile && navU.indexOf('CriOS') > -1) {
    isAndroidMobile = true;
  }
  var regExAppleWebKit = new RegExp(/AppleWebKit\/([\d.]+)/);
  var resultAppleWebKitRegEx = regExAppleWebKit.exec(navU);
  var appleWebKitVersion = (resultAppleWebKitRegEx === null ? null : parseFloat(regExAppleWebKit.exec(navU)[1]));
  var regExChrome = new RegExp(/Chrome\/([\d.]+)/);
  var resultChromeRegEx = regExChrome.exec(navU);
  var chromeVersion = (resultChromeRegEx === null ? null : parseFloat(regExChrome.exec(navU)[1]));
  var isAndroidBrowser = isAndroidMobile && (appleWebKitVersion !== null && appleWebKitVersion < 537) || (chromeVersion !== null && chromeVersion < 37);
  return isAndroidBrowser;
};
String.prototype.hashCode = function() {
  var hash = 0,
    i, c;
  if (this.length == 0) return hash;
  for (i = 0; i < this.length; i++) {
    c = this.charCodeAt(i);
    hash = ((hash << 5) - hash) + c;
    hash = hash & hash;
  }
  return hash;
};
String.prototype.trimSpaces = function() {
  return this.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
};
Array.prototype.remove = function(from, to) {
  var rest = this.slice((to || from) + 1 || this.length);
  this.length = from < 0 ? this.length + from : from;
  return this.push.apply(this, rest);
};
Array.prototype.randomize = function() {
  var i = this.length;
  if (i == 0) return false;
  while (--i) {
    var j = Math.floor(Math.random() * (i + 1));
    var tempi = this[i];
    var tempj = this[j];
    this[i] = tempj;
    this[j] = tempi;
  }
};
if (!('format' in String.prototype)) {
  String.prototype.format = function() {
    var string = this;
    for (var i = 0; i < arguments.length; i++) {
      var regexp = new RegExp('\\{' + i + '\\}', 'gi');
      string = string.replace(regexp, arguments[i]);
    }
    return string;
  };
}
jQuery.fn.bt = function(content, options) {
  if (typeof content != 'string') {
    var contentSelect = true;
    options = content;
    content = false;
  } else {
    var contentSelect = false;
  }
  if (jQuery.fn.hoverIntent && jQuery.bt.defaults.trigger == 'hover') {
    jQuery.bt.defaults.trigger = 'hoverIntent';
  }
  return this.each(function(index) {
    var opts = jQuery.extend(false, jQuery.bt.defaults, options);
    opts.spikeLength = numb(opts.spikeLength);
    opts.spikeGirth = numb(opts.spikeGirth);
    opts.overlap = numb(opts.overlap);
    var ajaxTimeout = false;
    if (opts.killTitle) {
      $(this).find('[title]').andSelf().each(function() {
        if (!$(this).attr('bt-xTitle')) {
          $(this).attr('bt-xTitle', $(this).attr('title')).attr('title', '');
        }
      });
    }
    if (typeof opts.trigger == 'string') {
      opts.trigger = [opts.trigger];
    }
    if (opts.trigger[0] == 'hoverIntent') {
      var hoverOpts = $.extend(opts.hoverIntentOpts, {
        over: function() {
          this.btOn();
        },
        out: function() {
          this.btOff();
        }
      });
      $(this).hoverIntent(hoverOpts);
    } else if (opts.trigger[0] == 'hover') {
      $(this).hover(function() {
        this.btOn();
      }, function() {
        this.btOff();
      });
    } else if (opts.trigger[0] == 'now') {
      if ($(this).hasClass('bt-active')) {
        this.btOff();
      } else {
        this.btOn();
      }
    } else if (opts.trigger[0] == 'none') {} else if (opts.trigger.length > 1 && opts.trigger[0] != opts.trigger[1]) {
      $(this).bind(opts.trigger[0], function() {
        this.btOn();
      }).bind(opts.trigger[1], function() {
        this.btOff();
      });
    } else {
      $(this).bind(opts.trigger[0], function() {
        if ($(this).hasClass('bt-active')) {
          this.btOff();
        } else {
          this.btOn();
        }
      });
    }
    this.btOn = function() {
      if (typeof $(this).data('bt-box') == 'object') {
        this.btOff();
      }
      opts.preShow.apply(this);
      $(jQuery.bt.vars.closeWhenOpenStack).btOff();
      $(this).addClass('bt-active ' + opts.activeClass);
      if (contentSelect && opts.ajaxPath == null) {
        if (opts.killTitle) {
          $(this).attr('title', $(this).attr('bt-xTitle'));
        }
        content = eval(opts.contentSelector);
        if (opts.killTitle) {
          $(this).attr('title', '');
        }
      }
      if (opts.ajaxPath != null && content == false) {
        if (typeof opts.ajaxPath == 'object') {
          var url = eval(opts.ajaxPath[0]);
          url += opts.ajaxPath[1] ? ' ' + opts.ajaxPath[1] : '';
        } else {
          var url = opts.ajaxPath;
        }
        var off = url.indexOf(" ");
        if (off >= 0) {
          var selector = url.slice(off, url.length);
          url = url.slice(0, off);
        }
        var cacheData = opts.ajaxCache ? $(document.body).data('btCache-' + url.replace(/\./g, '')) : null;
        if (typeof cacheData == 'string') {
          content = selector ? jQuery("<div/>").append(cacheData.replace(/<script(.|\s)*?\/script>/g, "")).find(selector) : cacheData;
        } else {
          var target = this;
          var ajaxOpts = jQuery.extend(false, {
            type: opts.ajaxType,
            data: opts.ajaxData,
            cache: opts.ajaxCache,
            url: url,
            complete: function(XMLHttpRequest, textStatus) {
              if (textStatus == 'success' || textStatus == 'notmodified') {
                if (opts.ajaxCache) {
                  $(document.body).data('btCache-' + url.replace(/\./g, ''), XMLHttpRequest.responseText);
                }
                ajaxTimeout = false;
                content = selector ? jQuery("<div/>").append(XMLHttpRequest.responseText.replace(/<script(.|\s)*?\/script>/g, "")).find(selector) : XMLHttpRequest.responseText;
              } else {
                if (textStatus == 'timeout') {
                  ajaxTimeout = true;
                }
                content = opts.ajaxError.replace(/%error/g, XMLHttpRequest.statusText);
              }
              if ($(target).hasClass('bt-active')) {
                target.btOn();
              }
            }
          }, opts.ajaxData);
          $.ajax(ajaxOpts);
          content = opts.ajaxLoading;
        }
      }
      var offsetParent = $(this).offsetParent();
      var pos = $(this).btPosition();
      var top = numb(pos.top) + numb($(this).css('margin-top'));
      var left = numb(pos.left) + numb($(this).css('margin-left'));
      var width = $(this).outerWidth();
      var height = $(this).outerHeight();
      if (typeof content == 'object') {
        content = $(content).clone(true).show();
      }
      var $text = $('<div class="bt-content"></div>').append(content).css({
        padding: opts.padding,
        position: 'absolute',
        width: opts.width,
        zIndex: opts.textzIndex
      }).css(opts.cssStyles);
      var $box = $('<div class="bt-wrapper"></div>').append($text).addClass(opts.cssClass).css({
        position: 'absolute',
        width: opts.width,
        zIndex: opts.wrapperzIndex
      }).appendTo(offsetParent);
      if ($.fn.bgiframe) {
        $text.bgiframe();
        $box.bgiframe();
      }
      $(this).data('bt-box', $box);
      var scrollTop = numb($(document).scrollTop());
      var scrollLeft = numb($(document).scrollLeft());
      var docWidth = numb($(window).width());
      var docHeight = numb($(window).height());
      var winRight = scrollLeft + docWidth;
      var winBottom = scrollTop + docHeight;
      var space = new Object();
      space.top = $(this).offset().top - scrollTop;
      space.bottom = docHeight - (($(this).offset().top + height) - scrollTop);
      space.left = $(this).offset().left - scrollLeft;
      space.right = docWidth - (($(this).offset().left + width) - scrollLeft);
      var textOutHeight = numb($text.outerHeight());
      var textOutWidth = numb($text.outerWidth());
      if (opts.positions.constructor == String) {
        opts.positions = opts.positions.replace(/ /, '').split(',');
      }
      if (opts.positions[0] == 'most') {
        var position = 'top';
        for (var pig in space) {
          position = space[pig] > space[position] ? pig : position;
        }
      } else {
        for (var x in opts.positions) {
          var position = opts.positions[x];
          if ((position == 'left' || position == 'right') && space[position] > textOutWidth + opts.spikeLength) {
            break;
          } else if ((position == 'top' || position == 'bottom') && space[position] > textOutHeight + opts.spikeLength) {
            break;
          }
        }
      }
      var horiz = left + ((width - textOutWidth) * .5);
      var offsetY = opts.offsetY ? opts.offsetY : .5;
      var vert = top + ((height - textOutHeight) * offsetY);
      var animDist = opts.animate ? numb(opts.distance) : 0;
      var points = new Array();
      var textTop, textLeft, textRight, textBottom, textTopSpace, textBottomSpace, textLeftSpace, textRightSpace, crossPoint, textCenter, spikePoint;
      switch (position) {
        case 'top':
          $text.css('margin-bottom', opts.spikeLength + 'px');
          $box.css({
            top: (top - $text.outerHeight(true) - animDist) + opts.overlap,
            left: horiz
          });
          textRightSpace = (winRight - opts.windowMargin) - ($text.offset().left + $text.outerWidth(true));
          var xShift = 0;
          if (textRightSpace < 0) {
            $box.css('left', (numb($box.css('left')) + textRightSpace) + 'px');
            xShift -= textRightSpace;
          }
          textLeftSpace = ($text.offset().left + numb($text.css('margin-left'))) - (scrollLeft + opts.windowMargin);
          if (textLeftSpace < 0) {
            $box.css('left', (numb($box.css('left')) - textLeftSpace) + 'px');
            xShift += textLeftSpace;
          }
          textTop = $text.btPosition().top + numb($text.css('margin-top'));
          textLeft = $text.btPosition().left + numb($text.css('margin-left'));
          textRight = textLeft + $text.outerWidth();
          textBottom = textTop + $text.outerHeight();
          textCenter = {
            x: textLeft + ($text.outerWidth() * opts.centerPointX),
            y: textTop + ($text.outerHeight() * opts.centerPointY)
          };
          points[points.length] = spikePoint = {
            y: textBottom + opts.spikeLength,
            x: ((textRight - textLeft) * .5) + xShift,
            type: 'spike'
          };
          crossPoint = findIntersectX(spikePoint.x, spikePoint.y, textCenter.x, textCenter.y, textBottom);
          crossPoint.x = crossPoint.x < textLeft + opts.spikeGirth / 2 + opts.cornerRadius ? textLeft + opts.spikeGirth / 2 + opts.cornerRadius : crossPoint.x;
          crossPoint.x = crossPoint.x > (textRight - opts.spikeGirth / 2) - opts.cornerRadius ? (textRight - opts.spikeGirth / 2) - opts.CornerRadius : crossPoint.x;
          points[points.length] = {
            x: crossPoint.x - (opts.spikeGirth / 2),
            y: textBottom,
            type: 'join'
          };
          points[points.length] = {
            x: textLeft,
            y: textBottom,
            type: 'corner'
          };
          points[points.length] = {
            x: textLeft,
            y: textTop,
            type: 'corner'
          };
          points[points.length] = {
            x: textRight,
            y: textTop,
            type: 'corner'
          };
          points[points.length] = {
            x: textRight,
            y: textBottom,
            type: 'corner'
          };
          points[points.length] = {
            x: crossPoint.x + (opts.spikeGirth / 2),
            y: textBottom,
            type: 'join'
          };
          points[points.length] = spikePoint;
          break;
        case 'left':
          $text.css('margin-right', opts.spikeLength + 'px');
          $box.css({
            top: vert + 'px',
            left: ((left - $text.outerWidth(true) - animDist) + opts.overlap) + 'px'
          });
          textBottomSpace = (winBottom - opts.windowMargin) - ($text.offset().top + $text.outerHeight(true));
          var yShift = 0;
          if (textBottomSpace < 0) {
            $box.css('top', (numb($box.css('top')) + textBottomSpace) + 'px');
            yShift -= textBottomSpace;
          }
          textTopSpace = ($text.offset().top + numb($text.css('margin-top'))) - (scrollTop + opts.windowMargin);
          if (textTopSpace < 0) {
            $box.css('top', (numb($box.css('top')) - textTopSpace) + 'px');
            yShift += textTopSpace;
          }
          textTop = $text.btPosition().top + numb($text.css('margin-top'));
          textLeft = $text.btPosition().left + numb($text.css('margin-left'));
          textRight = textLeft + $text.outerWidth();
          textBottom = textTop + $text.outerHeight();
          textCenter = {
            x: textLeft + ($text.outerWidth() * opts.centerPointX),
            y: textTop + ($text.outerHeight() * opts.centerPointY)
          };
          points[points.length] = spikePoint = {
            x: textRight + opts.spikeLength,
            y: ((textBottom - textTop) * .5) + yShift,
            type: 'spike'
          };
          crossPoint = findIntersectY(spikePoint.x, spikePoint.y, textCenter.x, textCenter.y, textRight);
          crossPoint.y = crossPoint.y < textTop + opts.spikeGirth / 2 + opts.cornerRadius ? textTop + opts.spikeGirth / 2 + opts.cornerRadius : crossPoint.y;
          crossPoint.y = crossPoint.y > (textBottom - opts.spikeGirth / 2) - opts.cornerRadius ? (textBottom - opts.spikeGirth / 2) - opts.cornerRadius : crossPoint.y;
          points[points.length] = {
            x: textRight,
            y: crossPoint.y + opts.spikeGirth / 2,
            type: 'join'
          };
          points[points.length] = {
            x: textRight,
            y: textBottom,
            type: 'corner'
          };
          points[points.length] = {
            x: textLeft,
            y: textBottom,
            type: 'corner'
          };
          points[points.length] = {
            x: textLeft,
            y: textTop,
            type: 'corner'
          };
          points[points.length] = {
            x: textRight,
            y: textTop,
            type: 'corner'
          };
          points[points.length] = {
            x: textRight,
            y: crossPoint.y - opts.spikeGirth / 2,
            type: 'join'
          };
          points[points.length] = spikePoint;
          break;
        case 'bottom':
          $text.css('margin-top', opts.spikeLength + 'px');
          $box.css({
            top: (top + height + animDist) - opts.overlap,
            left: horiz
          });
          textRightSpace = (winRight - opts.windowMargin) - ($text.offset().left + $text.outerWidth(true));
          var xShift = 0;
          if (textRightSpace < 0) {
            $box.css('left', (numb($box.css('left')) + textRightSpace) + 'px');
            xShift -= textRightSpace;
          }
          textLeftSpace = ($text.offset().left + numb($text.css('margin-left'))) - (scrollLeft + opts.windowMargin);
          if (textLeftSpace < 0) {
            $box.css('left', (numb($box.css('left')) - textLeftSpace) + 'px');
            xShift += textLeftSpace;
          }
          textTop = $text.btPosition().top + numb($text.css('margin-top'));
          textLeft = $text.btPosition().left + numb($text.css('margin-left'));
          textRight = textLeft + $text.outerWidth();
          textBottom = textTop + $text.outerHeight();
          textCenter = {
            x: textLeft + ($text.outerWidth() * opts.centerPointX),
            y: textTop + ($text.outerHeight() * opts.centerPointY)
          };
          points[points.length] = spikePoint = {
            x: ((textRight - textLeft) * .5) + xShift,
            y: 0,
            type: 'spike'
          };
          crossPoint = findIntersectX(spikePoint.x, spikePoint.y, textCenter.x, textCenter.y, textTop);
          crossPoint.x = crossPoint.x < textLeft + opts.spikeGirth / 2 + opts.cornerRadius ? textLeft + opts.spikeGirth / 2 + opts.cornerRadius : crossPoint.x;
          crossPoint.x = crossPoint.x > (textRight - opts.spikeGirth / 2) - opts.cornerRadius ? (textRight - opts.spikeGirth / 2) - opts.cornerRadius : crossPoint.x;
          points[points.length] = {
            x: crossPoint.x + opts.spikeGirth / 2,
            y: textTop,
            type: 'join'
          };
          points[points.length] = {
            x: textRight,
            y: textTop,
            type: 'corner'
          };
          points[points.length] = {
            x: textRight,
            y: textBottom,
            type: 'corner'
          };
          points[points.length] = {
            x: textLeft,
            y: textBottom,
            type: 'corner'
          };
          points[points.length] = {
            x: textLeft,
            y: textTop,
            type: 'corner'
          };
          points[points.length] = {
            x: crossPoint.x - (opts.spikeGirth / 2),
            y: textTop,
            type: 'join'
          };
          points[points.length] = spikePoint;
          break;
        case 'right':
          $text.css('margin-left', (opts.spikeLength + 'px'));
          $box.css({
            top: vert + 'px',
            left: ((left + width + animDist) - opts.overlap) + 'px'
          });
          textBottomSpace = (winBottom - opts.windowMargin) - ($text.offset().top + $text.outerHeight(true));
          var yShift = 0;
          if (textBottomSpace < 0) {
            $box.css('top', (numb($box.css('top')) + textBottomSpace) + 'px');
            yShift -= textBottomSpace;
          }
          textTopSpace = ($text.offset().top + numb($text.css('margin-top'))) - (scrollTop + opts.windowMargin);
          if (textTopSpace < 0) {
            $box.css('top', (numb($box.css('top')) - textTopSpace) + 'px');
            yShift += textTopSpace;
          }
          textTop = $text.btPosition().top + numb($text.css('margin-top'));
          textLeft = $text.btPosition().left + numb($text.css('margin-left'));
          textRight = textLeft + $text.outerWidth();
          textBottom = textTop + $text.outerHeight();
          textCenter = {
            x: textLeft + ($text.outerWidth() * opts.centerPointX),
            y: textTop + ($text.outerHeight() * opts.centerPointY)
          };
          points[points.length] = spikePoint = {
            x: 0,
            y: ((textBottom - textTop) * .5) + yShift,
            type: 'spike'
          };
          crossPoint = findIntersectY(spikePoint.x, spikePoint.y, textCenter.x, textCenter.y, textLeft);
          crossPoint.y = crossPoint.y < textTop + opts.spikeGirth / 2 + opts.cornerRadius ? textTop + opts.spikeGirth / 2 + opts.cornerRadius : crossPoint.y;
          crossPoint.y = crossPoint.y > (textBottom - opts.spikeGirth / 2) - opts.cornerRadius ? (textBottom - opts.spikeGirth / 2) - opts.cornerRadius : crossPoint.y;
          points[points.length] = {
            x: textLeft,
            y: crossPoint.y - opts.spikeGirth / 2,
            type: 'join'
          };
          points[points.length] = {
            x: textLeft,
            y: textTop,
            type: 'corner'
          };
          points[points.length] = {
            x: textRight,
            y: textTop,
            type: 'corner'
          };
          points[points.length] = {
            x: textRight,
            y: textBottom,
            type: 'corner'
          };
          points[points.length] = {
            x: textLeft,
            y: textBottom,
            type: 'corner'
          };
          points[points.length] = {
            x: textLeft,
            y: crossPoint.y + opts.spikeGirth / 2,
            type: 'join'
          };
          points[points.length] = spikePoint;
          break;
      }
      var canvas = document.createElement('canvas');
      canvas.setAttribute("width", (numb($text.outerWidth(true)) + opts.strokeWidth * 2));
      canvas.setAttribute("height", (numb($text.outerHeight(true)) + opts.strokeWidth * 2));
      $(canvas).appendTo($box).css({
        position: 'absolute',
        top: $text.btPosition().top,
        left: $text.btPosition().left,
        zIndex: opts.boxzIndex
      }).get(0);
      if (typeof G_vmlCanvasManager != 'undefined') {
        canvas = G_vmlCanvasManager.initElement(canvas);
      }
      if (opts.cornerRadius > 0) {
        var newPoints = new Array();
        var newPoint;
        for (var i = 0; i < points.length; i++) {
          if (points[i].type == 'corner') {
            newPoint = betweenPoint(points[i], points[(i - 1) % points.length], opts.cornerRadius);
            newPoint.type = 'arcStart';
            newPoints[newPoints.length] = newPoint;
            newPoints[newPoints.length] = points[i];
            newPoint = betweenPoint(points[i], points[(i + 1) % points.length], opts.cornerRadius);
            newPoint.type = 'arcEnd';
            newPoints[newPoints.length] = newPoint;
          } else {
            newPoints[newPoints.length] = points[i];
          }
        }
        points = newPoints;
      }
      var ctx = canvas.getContext("2d");
      drawIt.apply(ctx, [points], opts.strokeWidth);
      ctx.fillStyle = opts.fill;
      if (opts.shadow) {
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.shadowBlur = 5;
        ctx.shadowColor = opts.shadowColor;
      }
      ctx.closePath();
      ctx.fill();
      if (opts.strokeWidth > 0) {
        ctx.shadowColor = 'rgba(0, 0, 0, 0)';
        ctx.lineWidth = opts.strokeWidth;
        ctx.strokeStyle = opts.strokeStyle;
        ctx.beginPath();
        drawIt.apply(ctx, [points], opts.strokeWidth);
        ctx.closePath();
        ctx.stroke();
      }
      if (opts.animate) {
        $box.css({
          opacity: 0.1
        });
      }
      $box.css({
        visibility: 'visible'
      });
      if (opts.overlay) {
        var overlay = $('<div class="bt-overlay"></div>').css({
          position: 'absolute',
          backgroundColor: 'blue',
          top: top,
          left: left,
          width: width,
          height: height,
          opacity: '.2'
        }).appendTo(offsetParent);
        $(this).data('overlay', overlay);
      }
      var animParams = {
        opacity: 1
      };
      if (opts.animate) {
        switch (position) {
          case 'top':
            animParams.top = $box.btPosition().top + opts.distance;
            break;
          case 'left':
            animParams.left = $box.btPosition().left + opts.distance;
            break;
          case 'bottom':
            animParams.top = $box.btPosition().top - opts.distance;
            break;
          case 'right':
            animParams.left = $box.btPosition().left - opts.distance;
            break;
        }
        $box.animate(animParams, {
          duration: opts.speed,
          easing: opts.easing
        });
      }
      if ((opts.ajaxPath != null && opts.ajaxCache == false) || ajaxTimeout) {
        content = false;
      }
      if (opts.clickAnywhereToClose) {
        jQuery.bt.vars.clickAnywhereStack.push(this);
        $(document).click(jQuery.bt.docClick);
      }
      if (opts.closeWhenOthersOpen) {
        jQuery.bt.vars.closeWhenOpenStack.push(this);
      }
      opts.postShow.apply(this);
    };
    this.btOff = function() {
      opts.preHide.apply(this);
      var box = $(this).data('bt-box');
      var overlay = $(this).data('bt-overlay');
      if (typeof box == 'object') {
        $(box).remove();
        $(this).removeData('bt-box');
      }
      if (typeof overlay == 'object') {
        $(overlay).remove();
        $(this).removeData('bt-overlay');
      }
      jQuery.bt.vars.clickAnywhereStack = arrayRemove(jQuery.bt.vars.clickAnywhereStack, this);
      jQuery.bt.vars.closeWhenOpenStack = arrayRemove(jQuery.bt.vars.closeWhenOpenStack, this);
      opts.postHide.apply(this);
      $(this).removeClass('bt-active ' + opts.activeClass);
    };
    var refresh = this.btRefresh = function() {
      this.btOff();
      this.btOn();
    };
  });

  function drawIt(points, strokeWidth) {
    if (!points || points.length === 0) return;
    this.moveTo(points[0].x, points[0].y);
    for (i = 1; i < points.length; i++) {
      if (points[i - 1].type == 'arcStart') {
        this.quadraticCurveTo(round5(points[i].x, strokeWidth), round5(points[i].y, strokeWidth), round5(points[(i + 1) % points.length].x, strokeWidth), round5(points[(i + 1) % points.length].y, strokeWidth));
        i++;
      } else {
        this.lineTo(round5(points[i].x, strokeWidth), round5(points[i].y, strokeWidth));
      }
    }
  };

  function round5(num, strokeWidth) {
    var ret;
    strokeWidth = numb(strokeWidth);
    if (strokeWidth % 2) {
      ret = num;
    } else {
      ret = Math.round(num - .5) + .5;
    }
    return ret;
  };

  function numb(num) {
    return parseInt(num) || 0;
  };

  function arrayRemove(arr, elem) {
    var x, newArr = new Array();
    for (x in arr) {
      if (arr[x] != elem) {
        newArr.push(arr[x]);
      }
    }
    return newArr;
  };

  function betweenPoint(point1, point2, dist) {
    var y, x;
    if (point1.x == point2.x) {
      y = point1.y < point2.y ? point1.y + dist : point1.y - dist;
      return {
        x: point1.x,
        y: y
      };
    } else if (point1.y == point2.y) {
      x = point1.x < point2.x ? point1.x + dist : point1.x - dist;
      return {
        x: x,
        y: point1.y
      };
    }
  };

  function centerPoint(arcStart, corner, arcEnd) {
    var x = corner.x == arcStart.x ? arcEnd.x : arcStart.x;
    var y = corner.y == arcStart.y ? arcEnd.y : arcStart.y;
    var startAngle, endAngle;
    if (arcStart.x < arcEnd.x) {
      if (arcStart.y > arcEnd.y) {
        startAngle = (Math.PI / 180) * 180;
        endAngle = (Math.PI / 180) * 90;
      } else {
        startAngle = (Math.PI / 180) * 90;
        endAngle = 0;
      }
    } else {
      if (arcStart.y > arcEnd.y) {
        startAngle = (Math.PI / 180) * 270;
        endAngle = (Math.PI / 180) * 180;
      } else {
        startAngle = 0;
        endAngle = (Math.PI / 180) * 270;
      }
    }
    return {
      x: x,
      y: y,
      type: 'center',
      startAngle: startAngle,
      endAngle: endAngle
    };
  };

  function findIntersect(r1x1, r1y1, r1x2, r1y2, r2x1, r2y1, r2x2, r2y2) {
    if (r2x1 == r2x2) {
      return findIntersectY(r1x1, r1y1, r1x2, r1y2, r2x1);
    }
    if (r2y1 == r2y2) {
      return findIntersectX(r1x1, r1y1, r1x2, r1y2, r2y1);
    }
    var r1m = (r1y1 - r1y2) / (r1x1 - r1x2);
    var r1b = r1y1 - (r1m * r1x1);
    var r2m = (r2y1 - r2y2) / (r2x1 - r2x2);
    var r2b = r2y1 - (r2m * r2x1);
    var x = (r2b - r1b) / (r1m - r2m);
    var y = r1m * x + r1b;
    return {
      x: x,
      y: y
    };
  };

  function findIntersectY(r1x1, r1y1, r1x2, r1y2, x) {
    if (r1y1 == r1y2) {
      return {
        x: x,
        y: r1y1
      };
    }
    var r1m = (r1y1 - r1y2) / (r1x1 - r1x2);
    var r1b = r1y1 - (r1m * r1x1);
    var y = r1m * x + r1b;
    return {
      x: x,
      y: y
    };
  };

  function findIntersectX(r1x1, r1y1, r1x2, r1y2, y) {
    if (r1x1 == r1x2) {
      return {
        x: r1x1,
        y: y
      };
    }
    var r1m = (r1y1 - r1y2) / (r1x1 - r1x2);
    var r1b = r1y1 - (r1m * r1x1);
    var x = (y - r1b) / r1m;
    return {
      x: x,
      y: y
    };
  };
};
jQuery.fn.btPosition = function() {
  function num(elem, prop) {
    return elem[0] && parseInt(jQuery(elem[0]).css(prop), 10) || 0;
  };
  var left = 0,
    top = 0,
    results;
  if (this[0]) {
    var offsetParent = this.offsetParent(),
      offset = this.offset(),
      parentOffset = /^body|html$/i.test(offsetParent[0].tagName) ? {
        top: 0,
        left: 0
      } : offsetParent.offset();
    offset.top -= num(this, 'marginTop');
    offset.left -= num(this, 'marginLeft');
    parentOffset.top += num(offsetParent, 'borderTopWidth');
    parentOffset.left += num(offsetParent, 'borderLeftWidth');
    results = {
      top: offset.top - parentOffset.top,
      left: offset.left - parentOffset.left
    };
  }
  return results;
};
jQuery.fn.btOn = function() {
  return this.each(function(index) {
    if ($.isFunction(this.btOn)) {
      this.btOn();
    }
  });
};
jQuery.fn.btOff = function() {
  return this.each(function(index) {
    if ($.isFunction(this.btOff)) {
      this.btOff();
    }
  });
};
jQuery.bt = {};
jQuery.bt.vars = {
  clickAnywhereStack: [],
  closeWhenOpenStack: []
};
jQuery.bt.docClick = function(e) {
  if (!e) {
    var e = window.event;
  };
  if (!$(e.target).parents().andSelf().filter('.bt-wrapper, .bt-active').length) {
    $(jQuery.bt.vars.clickAnywhereStack).btOff();
    $(document).unbind('click', jQuery.bt.docClick);
  }
};
jQuery.bt.defaults = {
  trigger: 'hover',
  clickAnywhereToClose: true,
  closeWhenOthersOpen: false,
  width: '200px',
  padding: '10px',
  spikeGirth: 10,
  spikeLength: 15,
  overlap: 0,
  overlay: false,
  killTitle: true,
  textzIndex: 9999,
  boxzIndex: 9998,
  wrapperzIndex: 9997,
  positions: ['most'],
  fill: "rgb(255, 255, 102)",
  windowMargin: 10,
  strokeWidth: 1,
  strokeStyle: "#000",
  cornerRadius: 5,
  centerPointX: .5,
  centerPointY: .5,
  shadow: false,
  shadowOffsetX: 2,
  shadowOffsetY: 2,
  shadowBlur: 3,
  shadowColor: "#000",
  animate: false,
  distance: 15,
  easing: 'swing',
  speed: 200,
  cssClass: '',
  cssStyles: {},
  activeClass: 'bt-active',
  contentSelector: "$(this).attr('title')",
  ajaxPath: null,
  ajaxError: '<strong>ERROR:</strong> <em>%error</em>',
  ajaxLoading: '<blink>Loading...</blink>',
  ajaxData: {},
  ajaxType: 'GET',
  ajaxCache: true,
  ajaxOpts: {},
  preShow: function() {
    return;
  },
  postShow: function() {
    return;
  },
  preHide: function() {
    return;
  },
  postHide: function() {
    return;
  },
  hoverIntentOpts: {
    interval: 300,
    timeout: 500
  },
  offsetY: 0.5
};
jQuery.fn.flash = function(color, duration) {
  var current = this.css('background-color');
  this.animate({
    backgroundColor: color
  }, duration / 2);
  this.animate({
    backgroundColor: current
  }, duration / 2);
}
Number.prototype.toDecimal = function(n) {
  n = (isNaN(n)) ? 2 : n;
  var
    nT = Math.pow(10, n);

  function pad(s) {
    s = s || '.';
    return (s.length > n) ? s : pad(s + '0');
  }
  return (isNaN(this)) ? this : (new String(parseInt(this * nT) / nT)).replace(/(\.\d*)?$/, pad);
}
if (!Array.prototype.map) {
  Array.prototype.map = function(fn) {
    var r = [];
    var l = this.length;
    for (i = 0; i < l; i++) {
      r.push(fn(this[i]));
    }
    return r;
  };
}
var jquery_images_cache = [];
(function($) {
  $.preLoadImages = function() {
    var args_len = arguments.length;
    for (var i = args_len; i--;) {
      var cacheImage = document.createElement('img');
      cacheImage.src = arguments[i];
      jquery_images_cache.push(cacheImage);
    }
  }
})(jQuery);
$.postJSON = function(url, data, callback) {
  $.post(url, data, callback, "json");
};
$.fn.HasScrollBar = function() {
  var _elm = $(this)[0];
  var _hasScrollBar = false;
  if ((_elm.clientHeight < _elm.scrollHeight) || (_elm.clientWidth < _elm.scrollWidth)) {
    _hasScrollBar = true;
  }
  return _hasScrollBar;
}

function del_cookie(name) {
  SetCookie(name, "", -1);
}

function SetCookie(cookieName, cookieValue, nDays) {
  var today = new Date();
  var expire = new Date();
  if (nDays == null || nDays == 0) nDays = 1;
  expire.setTime(today.getTime() + 3600000 * 24 * nDays);
  document.cookie = cookieName + "=" + escape(cookieValue) +
    ";expires=" + expire.toGMTString();
}

function readCookie(name) {
  var nameEQ = name + "=";
  var ca = document.cookie.split(';');
  for (var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}
$.ajaxSetup({
  cache: false
});
var FlashDetect = new function() {
  var self = this;
  self.installed = false;
  self.raw = "";
  self.major = -1;
  self.minor = -1;
  self.revision = -1;
  self.revisionStr = "";
  var activeXDetectRules = [{
    "name": "ShockwaveFlash.ShockwaveFlash.7",
    "version": function(obj) {
      return getActiveXVersion(obj);
    }
  }, {
    "name": "ShockwaveFlash.ShockwaveFlash.6",
    "version": function(obj) {
      var version = "6,0,21";
      try {
        obj.AllowScriptAccess = "always";
        version = getActiveXVersion(obj);
      } catch (err) {}
      return version;
    }
  }, {
    "name": "ShockwaveFlash.ShockwaveFlash",
    "version": function(obj) {
      return getActiveXVersion(obj);
    }
  }];
  var getActiveXVersion = function(activeXObj) {
    var version = -1;
    try {
      version = activeXObj.GetVariable("$version");
    } catch (err) {}
    return version;
  };
  var getActiveXObject = function(name) {
    var obj = -1;
    try {
      obj = new ActiveXObject(name);
    } catch (err) {
      obj = {
        activeXError: true
      };
    }
    return obj;
  };
  var parseActiveXVersion = function(str) {
    var versionArray = str.split(",");
    return {
      "raw": str,
      "major": parseInt(versionArray[0].split(" ")[1], 10),
      "minor": parseInt(versionArray[1], 10),
      "revision": parseInt(versionArray[2], 10),
      "revisionStr": versionArray[2]
    };
  };
  var parseStandardVersion = function(str) {
    var descParts = str.split(/ +/);
    var majorMinor = descParts[2].split(/\./);
    var revisionStr = descParts[3];
    return {
      "raw": str,
      "major": parseInt(majorMinor[0], 10),
      "minor": parseInt(majorMinor[1], 10),
      "revisionStr": revisionStr,
      "revision": parseRevisionStrToInt(revisionStr)
    };
  };
  var parseRevisionStrToInt = function(str) {
    return parseInt(str.replace(/[a-zA-Z]/g, ""), 10) || self.revision;
  };
  self.majorAtLeast = function(version) {
    return self.major >= version;
  };
  self.minorAtLeast = function(version) {
    return self.minor >= version;
  };
  self.revisionAtLeast = function(version) {
    return self.revision >= version;
  };
  self.versionAtLeast = function(major) {
    var properties = [self.major, self.minor, self.revision];
    var len = Math.min(properties.length, arguments.length);
    for (i = 0; i < len; i++) {
      if (properties[i] >= arguments[i]) {
        if (i + 1 < len && properties[i] == arguments[i]) {
          continue;
        } else {
          return true;
        }
      } else {
        return false;
      }
    }
  };
  self.FlashDetect = function() {
    if (navigator.plugins && navigator.plugins.length > 0) {
      var type = 'application/x-shockwave-flash';
      var mimeTypes = navigator.mimeTypes;
      if (mimeTypes && mimeTypes[type] && mimeTypes[type].enabledPlugin && mimeTypes[type].enabledPlugin.description) {
        var version = mimeTypes[type].enabledPlugin.description;
        var versionObj = parseStandardVersion(version);
        self.raw = versionObj.raw;
        self.major = versionObj.major;
        self.minor = versionObj.minor;
        self.revisionStr = versionObj.revisionStr;
        self.revision = versionObj.revision;
        self.installed = true;
      }
    } else if (navigator.appVersion.indexOf("Mac") == -1 && window.execScript) {
      var version = -1;
      for (var i = 0; i < activeXDetectRules.length && version == -1; i++) {
        var obj = getActiveXObject(activeXDetectRules[i].name);
        if (!obj.activeXError) {
          self.installed = true;
          version = activeXDetectRules[i].version(obj);
          if (version != -1) {
            var versionObj = parseActiveXVersion(version);
            self.raw = versionObj.raw;
            self.major = versionObj.major;
            self.minor = versionObj.minor;
            self.revision = versionObj.revision;
            self.revisionStr = versionObj.revisionStr;
          }
        }
      }
    }
  }();
};
FlashDetect.JS_RELEASE = "1.0.4";
$.ajaxSetup({
  cache: false
});
/*! http://mths.be/placeholder v2.0.7 by @mathias */
;
(function(window, document, $) {
  var isInputSupported = 'placeholder' in document.createElement('input'),
    isTextareaSupported = 'placeholder' in document.createElement('textarea'),
    prototype = $.fn,
    valHooks = $.valHooks,
    hooks, placeholder;
  if (typeof valHooks == 'undefined') return;
  if (isInputSupported && isTextareaSupported) {
    placeholder = prototype.placeholder = function() {
      return this;
    };
    placeholder.input = placeholder.textarea = true;
  } else {
    placeholder = prototype.placeholder = function() {
      var $this = this;
      $this.filter((isInputSupported ? 'textarea' : ':input') + '[placeholder]').not('.placeholder').bind({
        'focus.placeholder': clearPlaceholder,
        'blur.placeholder': setPlaceholder
      }).data('placeholder-enabled', true).trigger('blur.placeholder');
      return $this;
    };
    placeholder.input = isInputSupported;
    placeholder.textarea = isTextareaSupported;
    hooks = {
      'get': function(element) {
        var $element = $(element);
        return $element.data('placeholder-enabled') && $element.hasClass('placeholder') ? '' : element.value;
      },
      'set': function(element, value) {
        var $element = $(element);
        if (!$element.data('placeholder-enabled')) {
          return element.value = value;
        }
        if (value == '') {
          element.value = value;
          if (element != document.activeElement) {
            setPlaceholder.call(element);
          }
        } else if ($element.hasClass('placeholder')) {
          clearPlaceholder.call(element, true, value) || (element.value = value);
        } else {
          element.value = value;
        }
        return $element;
      }
    };
    isInputSupported || (valHooks.input = hooks);
    isTextareaSupported || (valHooks.textarea = hooks);
    $(function() {
      $(document).delegate('form', 'submit.placeholder', function() {
        var $inputs = $('.placeholder', this).each(clearPlaceholder);
        setTimeout(function() {
          $inputs.each(setPlaceholder);
        }, 10);
      });
    });
    $(window).bind('beforeunload.placeholder', function() {
      $('.placeholder').each(function() {
        this.value = '';
      });
    });
  }

  function args(elem) {
    var newAttrs = {},
      rinlinejQuery = /^jQuery\d+$/;
    $.each(elem.attributes, function(i, attr) {
      if (attr.specified && !rinlinejQuery.test(attr.name)) {
        newAttrs[attr.name] = attr.value;
      }
    });
    return newAttrs;
  }

  function clearPlaceholder(event, value) {
    var input = this,
      $input = $(input);
    if (input.value == $input.attr('placeholder') && $input.hasClass('placeholder')) {
      if ($input.data('placeholder-password')) {
        $input = $input.hide().next().show().attr('id', $input.removeAttr('id').data('placeholder-id'));
        if (event === true) {
          return $input[0].value = value;
        }
        $input.focus();
      } else {
        input.value = '';
        $input.removeClass('placeholder');
        input == document.activeElement && input.select();
      }
    }
  }

  function setPlaceholder() {
    var $replacement, input = this,
      $input = $(input),
      $origInput = $input,
      id = this.id;
    if (input.value == '') {
      if (input.type == 'password') {
        if (!$input.data('placeholder-textinput')) {
          try {
            $replacement = $input.clone().attr({
              'type': 'text'
            });
          } catch (e) {
            $replacement = $('<input>').attr($.extend(args(this), {
              'type': 'text'
            }));
          }
          $replacement.removeAttr('name').data({
            'placeholder-password': true,
            'placeholder-id': id
          }).bind('focus.placeholder', clearPlaceholder);
          $input.data({
            'placeholder-textinput': $replacement,
            'placeholder-id': id
          }).before($replacement);
        }
        $input = $input.removeAttr('id').hide().prev().attr('id', id).show();
      }
      $input.addClass('placeholder');
      $input[0].value = $input.attr('placeholder');
    } else {
      $input.removeClass('placeholder');
    }
  }
}(this, document, jQuery));
var dateFormat = function() {
  var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
    timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
    timezoneClip = /[^-+\dA-Z]/g,
    pad = function(val, len) {
      val = String(val);
      len = len || 2;
      while (val.length < len) val = "0" + val;
      return val;
    };
  return function(date, mask, utc) {
    var dF = dateFormat;
    if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
      mask = date;
      date = undefined;
    }
    date = date ? new Date(date) : new Date;
    if (isNaN(date)) throw SyntaxError("invalid date");
    mask = String(dF.masks[mask] || mask || dF.masks["default"]);
    if (mask.slice(0, 4) == "UTC:") {
      mask = mask.slice(4);
      utc = true;
    }
    var _ = utc ? "getUTC" : "get",
      d = date[_ + "Date"](),
      D = date[_ + "Day"](),
      m = date[_ + "Month"](),
      y = date[_ + "FullYear"](),
      H = date[_ + "Hours"](),
      M = date[_ + "Minutes"](),
      s = date[_ + "Seconds"](),
      L = date[_ + "Milliseconds"](),
      o = utc ? 0 : date.getTimezoneOffset(),
      flags = {
        d: d,
        dd: pad(d),
        ddd: dF.i18n.dayNames[D],
        dddd: dF.i18n.dayNames[D + 7],
        m: m + 1,
        mm: pad(m + 1),
        mmm: dF.i18n.monthNames[m],
        mmmm: dF.i18n.monthNames[m + 12],
        yy: String(y).slice(2),
        yyyy: y,
        h: H % 12 || 12,
        hh: pad(H % 12 || 12),
        H: H,
        HH: pad(H),
        M: M,
        MM: pad(M),
        s: s,
        ss: pad(s),
        l: pad(L, 3),
        L: pad(L > 99 ? Math.round(L / 10) : L),
        t: H < 12 ? "a" : "p",
        tt: H < 12 ? "am" : "pm",
        T: H < 12 ? "A" : "P",
        TT: H < 12 ? "AM" : "PM",
        Z: utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
        o: (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
        S: ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
      };
    return mask.replace(token, function($0) {
      return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
    });
  };
}();
dateFormat.masks = {
  "default": "ddd mmm dd yyyy HH:MM:ss",
  shortDate: "m/d/yy",
  mediumDate: "mmm d, yyyy",
  longDate: "mmmm d, yyyy",
  fullDate: "dddd, mmmm d, yyyy",
  shortTime: "h:MM TT",
  mediumTime: "h:MM:ss TT",
  longTime: "h:MM:ss TT Z",
  isoDate: "yyyy-mm-dd",
  isoTime: "HH:MM:ss",
  isoDateTime: "yyyy-mm-dd'T'HH:MM:ss",
  isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
};
dateFormat.i18n = {
  dayNames: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
  monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
};
Date.prototype.format = function(mask, utc) {
  return dateFormat(this, mask, utc);
};
/*!
 * jQuery idleTimer plugin
 * version 0.9.100511
 * by Paul Irish.
 *   http://github.com/paulirish/yui-misc/tree/
 * MIT license

 * adapted from YUI idle timer by nzakas:
 *   http://github.com/nzakas/yui-misc/
*/
(function($) {
  $.idleTimer = function(newTimeout, elem, opts) {
    opts = $.extend({
      startImmediately: true,
      idle: false,
      enabled: true,
      timeout: 30000,
      events: 'mousemove keydown DOMMouseScroll mousewheel mousedown touchstart touchmove'
    }, opts);
    elem = elem || document;
    var toggleIdleState = function(myelem) {
        if (typeof myelem === 'number') {
          myelem = undefined;
        }
        var obj = $.data(myelem || elem, 'idleTimerObj');
        obj.idle = !obj.idle;
        var elapsed = (+new Date()) - obj.olddate;
        obj.olddate = +new Date();
        if (obj.idle && (elapsed < opts.timeout)) {
          obj.idle = false;
          clearTimeout($.idleTimer.tId);
          if (opts.enabled)
            $.idleTimer.tId = setTimeout(toggleIdleState, opts.timeout);
          return;
        }
        var event = jQuery.Event($.data(elem, 'idleTimer', obj.idle ? "idle" : "active") + '.idleTimer');
        $(elem).trigger(event);
      },
      stop = function(elem) {
        var obj = $.data(elem, 'idleTimerObj') || {};
        obj.enabled = false;
        clearTimeout(obj.tId);
        $(elem).off('.idleTimer');
      },
      handleUserEvent = function() {
        var obj = $.data(this, 'idleTimerObj');
        clearTimeout(obj.tId);
        if (obj.enabled) {
          if (obj.idle) {
            toggleIdleState(this);
          }
          obj.tId = setTimeout(toggleIdleState, obj.timeout);
        }
      };
    var obj = $.data(elem, 'idleTimerObj') || {};
    obj.olddate = obj.olddate || +new Date();
    if (typeof newTimeout === "number") {
      opts.timeout = newTimeout;
    } else if (newTimeout === 'destroy') {
      stop(elem);
      return this;
    } else if (newTimeout === 'getElapsedTime') {
      return (+new Date()) - obj.olddate;
    }
    $(elem).on($.trim((opts.events + ' ').split(' ').join('.idleTimer ')), handleUserEvent);
    obj.idle = opts.idle;
    obj.enabled = opts.enabled;
    obj.timeout = opts.timeout;
    if (opts.startImmediately) {
      obj.tId = setTimeout(toggleIdleState, obj.timeout);
    }
    $.data(elem, 'idleTimer', "active");
    $.data(elem, 'idleTimerObj', obj);
  };
  $.fn.idleTimer = function(newTimeout, opts) {
    if (!opts) {
      opts = {};
    }
    if (this[0]) {
      $.idleTimer(newTimeout, this[0], opts);
    }
    return this;
  };
})(jQuery);

function __init_lab_pm() {
  if (G_lab.fkZATestID == -1) {
    console.log('Invalid test!');
  } else {
    $('#loading').show();
    $('.lab-next, .lab-mode').hide();
    if (!G_lab.fkZATestID) {
      MSlab.AssessmentsApi.createPMTest([G_lab.Student.Student.pkINStudentID], G_lab.TeacherID, jsVars.assessmentsApiConfig.zaCounterpart, 0, -1, -1);
    } else {
      MSlab.AssessmentsApi.getAssignments(G_lab.Student.Student.pkINStudentID, 'modules');
    }
  }
}
var G_Time;
var G_IsCorrect;
var G_PracticeCurrentProblem;
var G_TeachMePos;
var G_TeachMeStep;
var G_StudentAnswer = "";
var G_ScreenLessonWelcome = false;
var G_ScreenLessonContinue = false;
var G_ScreenStrand = false;
var G_FirstProblem = true;
var G_QuizState = false;
var G_WarmupState = false;
var G_QuizDone = false;
var G_LessonDone = false;
var G_NextPracticeSet = false;
var G_ScreenReviewStart = false;
var G_LastMode = "";
var G_CorrectAnswer;
var PracticeIgnoreNextButton = false;
var PracticeLab = {
  timer: $.timer(function() {
    PracticeLab.thrTimePracticeTotal += 1;
  }, 1000, false),
  Pause: false,
  canPause: true,
  EndStrandAttempt: 0,
  settings: {
    error_alert: "The next problem did not load. Press OK to fetch again."
  },
  thrTimePracticeTotal: 0,
  thrTimePracticeStart: new Date().getTime(),
  preloadChar: null,
  badCharacter: null,
  shortAnswerEditorContent: '',
  TimeNotFocus: 0,
  saveTime: {
    practice: 0,
    focus: 0,
  },
  getAndResetSaveTime: function() {
    var data = {
      thrTimePractice: PracticeLab.saveTime.practice,
      TimeFocus: PracticeLab.saveTime.focus,
    };
    PracticeLab.saveTime.practice = PracticeLab.getTotalSessionTime();
    PracticeLab.saveTime.focus = focusTimeObj.getTimeFocusTotal();
    return {
      thrTimePractice: PracticeLab.saveTime.practice - data.thrTimePractice,
      TimeFocus: PracticeLab.saveTime.focus - data.TimeFocus,
    };
  },
  PauseTime: setInterval(function() {
    if (PracticeLab.Pause) PracticeLab.PauseTime += 1;
  }, 1000),
  init_thrTimePractice: function() {
    this.thrTimePracticeTotal = 0;
    MSlab.TimeNotFocus = 0;
    if (!this.timer.isTimerActive())
      this.timer.play();
  },
  init_thrTimePracticeStart: function() {
    this.thrTimePracticeStart = new Date().getTime();
  },
  pause: function() {
    this.Pause = true;
    this.timer.pause();
    MSlab.timerFocus.timerPause();
  },
  resume: function() {
    this.Pause = false;
    this.timer.play();
    MSlab.timerFocus.timerUnpause();
  },
  isPaused: function() {
    if (typeof G_lab == 'undefined' || G_lab.Mode != 'Practice')
      return true;
    return !this.timer.isTimerActive();
  },
  getTotalSessionTime: function() {
    TotalSessionTime = this.thrTimePracticeTotal;
    if (TotalSessionTime < 0) TotalSessionTime = 0;
    return TotalSessionTime;
  },
  preloadCharacter: function(characterNumber) {
    if (characterNumber < 0) characterNumber = Math.floor((Math.random() * 22) + 1);
    PracticeLab.preloadChar = '/MM/img/lab/characters/' + characterNumber + '.png';
    var tmpImg = new Image();
    tmpImg.src = PracticeLab.preloadChar;
  },
  getStrandTime: function() {
    for (var i = 0; i < G_lab.LessonStrands.length; i++) {
      if (G_lab.LessonStrands[i].Strand.pkMLStrandID == G_lab.Strand) {
        return G_lab.LessonStrands[i].Strand.Time;
      }
    }
  },
  evaluateProblem: function() {
    var goodCorrectAnswer = MSlab.handleCorrectAnswer(CurrentProblem);
    if (G_IncorrectAttempt == 0) {
      G_Time = Math.ceil((new Date().getTime() - thrTimeStart) / 1000 - PracticeLab.PauseTime);
      G_IsCorrect = CurrentProblemIsCorrect;
      G_StudentAnswer = Answer;
      if (CurrentProblemIsCorrect) {
        G_IncorrectAttempt = 0;
        __updateProblemList(G_IsCorrect, 0, G_Time, G_StudentAnswer, 0, goodCorrectAnswer);
        MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
        if (MSlab.isShowAnswersCheckmarker()) {
          MSlab.showCorrectOrIncorrect(CurrentProblemIsCorrect);
        }
        if (MSlab.isShowProblemFeedback(CurrentProblemIsCorrect) && MSlab.userInteract.problemHasFeedback()) {
          MSlab.showProblemFeedback();
          G_IncorrectAttempt = 2;
        } else {
          if (MSlab.isShowAnswersCheckmarker()) {
            setTimeout(subPracticeSelectProblem, 800);
          } else {
            subPracticeSelectProblem();
          }
        }
      } else {
        G_IncorrectAttempt += 1;
        __updateProblemList(0, 0, G_Time, G_StudentAnswer, 0, goodCorrectAnswer);
        if (MSlab.isShowPartialCredit()) {
          MSlab.showPartial();
        } else {
          if (MSlab.isShowAnswersCheckmarker()) {
            MSlab.showCorrectOrIncorrect(CurrentProblemIsCorrect);
          }
          if (MSlab.isShowProblemFeedback() && MSlab.userInteract.problemHasFeedback()) {
            MSlab.showProblemFeedback();
            G_IncorrectAttempt = 2;
          } else {
            if (MSlab.isShowAnswersCheckmarker()) {
              setTimeout(subPracticeSelectProblem, 800);
            } else {
              subPracticeSelectProblem();
            }
          }
        }
      }
      $(document).trigger('labEvaluate', {
        isCorrect: CurrentProblemIsCorrect ? true : false
      });
    } else {
      if (G_IncorrectAttempt == 1 && !G_lab.isMiniPracticeSet) {
        G_IncorrectAttempt += 1;
        G_Feedback_Time = Math.ceil((new Date().getTime() - thrTimeStart) / 1000);
        __updateProblemList(0, (CurrentProblemIsCorrect ? 1 : 0), G_Time, G_StudentAnswer, G_Feedback_Time, goodCorrectAnswer);
        MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
        if (MSlab.isShowAnswersCheckmarker()) {
          MSlab.showCorrectOrIncorrect(CurrentProblemIsCorrect);
        }
        if (MSlab.isShowProblemFeedback(CurrentProblemIsCorrect) && MSlab.userInteract.problemHasFeedback()) {
          MSlab.showProblemFeedback();
        } else {
          if (MSlab.isShowAnswersCheckmarker()) {
            setTimeout(subPracticeSelectProblem, 800);
          } else {
            subPracticeSelectProblem();
          }
        }
      } else {
        G_IncorrectAttempt = 0;
        MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
        subPracticeSelectProblem();
      }
    }
  },
  evaluateShortAnswer: function() {
    G_Time = Math.ceil((new Date().getTime() - thrTimeStart) / 1000);
    MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
    if (G_lab.StudentSetting.StudentSetting.IsShortAnswerFeedbackShown == 1) {
      if ($('.problem-feedback').is(":visible")) {
        G_Feedback_Time = Math.ceil((new Date().getTime() - thrTimeStart) / 1000);
        G_IncorrectAttempt = 0;
        __updateProblemList(1, 0, G_Time, PracticeLab.shortAnswerEditorContent, G_Feedback_Time, "");
        subPracticeSelectProblem();
        $('.problem-statement').show();
      } else {
        PracticeLab.shortAnswerEditorContent = MSlab.userInteract.getAnswer();
        MSlab.showProblemFeedback();
      }
    } else {
      __updateProblemList(1, 0, G_Time, MSlab.userInteract.getAnswer(), 0, "");
      subPracticeSelectProblem();
      $('.problem-statement').show();
    }
  },
  startProblems: function() {
    MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
    if (G_lab.newLesson == 1 || G_lab.newStrand == 1) {
      var i = __getStrandIndex(G_lab.Strand, G_lab.LessonStrands);
      if (i >= 0 && (G_lab.LessonStrands[i].Strand.IsVocab == 1 || G_lab.LessonStrands[i].Strand.IsVocab === true)) {
        __showVocabStrandStart();
        return;
      }
    }
    __hideall();
    display_controls();
    __updateLessonStrand();
    __showPracticeFirstProblem();
  },
  getLiveActualSeconds: function() {
    if (G_lab.Mode == 'Practice')
      return PracticeLab.getTotalSessionTime();
    else if (G_lab.Mode == 'PM') {
      if (typeof thrTimePM == 'undefined')
        return 0;
      else
        return Math.ceil((new Date().getTime() - thrTimePM) / 1000);
    }
  },
};
var PracticeLabBackup = {
  problems: null,
  getProblems: function() {
    return jQuery.extend(true, {}, this.problems);
  },
  setProblems: function(problemList) {
    this.problems = problemList
  },
  IsValidProblemList: function(position, pkMLProblemID) {
    if (this.problems == null) return false;
    return this.problems[position].Problem.pkMLProblemID == pkMLProblemID;
  }
};

function __init_lab_practice() {
  PracticeLab.init_thrTimePractice();
  if (G_lab.callPMLab == 1) {
    if (G_lab.studentAssignmentId) {
      MSlab.redirect(MSlab.assignedlisturl, false);
    } else {
      showNoMoreLesson();
    }
    return;
  }
  if (G_lab.FirstTime == 1) {
    __showLessonWelcome();
  } else {
    __showLessonContinue();
  }
  G_FirstProblem = 1;
  PracticeLab.preloadCharacter(100);
  PracticeLab.badCharacter = PracticeLab.preloadChar;
  PracticeLab.preloadCharacter(-1);
}

function __hideall() {
  if ($('.content-wrapper').hasClass('lab-frame-keypad')) {
    $('.content-wrapper').removeClass('lab-frame-keypad');
    resizeLab();
  }
  $(".lab-problem").attr('class', 'lab-problem');
  $('.lab-menu-tm').hide();
  $('.lab-menu-multi-tm').hide();
  $(".lab-menu-toc").hide();
  $('.lab-menu-page-show').css('display', '');
  $('.lab-menu-back-shortanswer').hide();
  $('.lab-submenu-hint').hide();
  $(".problem-statement").css("visibility", "hidden");
  MSlab.hideProblemFeedback();
  $(".content-problem").hide();
  $(".lab-stars").html('').hide();
  $('.lab-game-counter').hide();
  $('.lab-game-banner').hide();
  $('#progress_bar').hide();
  $(".lab-strand").hide();
  $(".code").hide();
  $(".LessonWelcome").hide();
  $(".ReviewStart").hide();
  $(".PMPlacementWelcome").hide();
  $(".screenPlacementStart").hide();
  $('.ask-grade-div').hide();
  $(".LessonContinue").hide();
  $(".LessonStrand").hide();
  $(".QuizDone").hide();
  $(".NextPracticeSet").hide();
  $(".LessonDone").hide();
  $(".FactPlaceStart").hide();
  $('.screenStart').hide();
  $('.screenLessonStart').hide();
  $('.screenLessonDone').hide();
  $('.screenQuizDonePass').hide();
  $('.screenCongrats').hide();
  $('.screenAskGrade').hide();
  $(".lab-click").hide();
  $(".pbl-header").hide();
  $('.screenSimpleText').hide();
  $('.screenQuizDoneFail').hide();
  $('.screenNextPracticeSet').hide();
  $('.screenPrePlacementStart').hide();
  $("#loading").hide();
  G_ScreenLessonWelcome = false;
  G_ReviewStart = false;
  G_ScreenStrand = false;
  G_NextPracticeSet = false;
  G_QuizDone = false;
  G_LessonDone = false;
  G_ScreenReviewStart = false;
  G_ScreenLessonContinue = false;
  G_PMPlacementWelcome = false;
  G_ScreenPrePlacementStart = false;
  PracticeLab.canPause = true;
  if (typeof mobileKeypad !== 'undefined') {
    mobileKeypad.show(false, '.content-problem .problem-statement');
  }
  MSlab.hideScreen();
}

function __getStrandIndex(pkMLStrandID, arrStrand) {
  for (var i = 0; i < arrStrand.length; i++) {
    if (arrStrand[i].Strand.pkMLStrandID == pkMLStrandID) return i;
  }
  return -1;
}

function __showVocabStrandStart() {
  __hideall();
  G_ScreenStrand = true;
  G_lab.newLesson = 0;
  G_lab.newStrand = 0;
  var box;
  var text = 'Let\'s review the vocabulary you learned in<br>\
    this lesson to prepare for your lesson test.';
  box = MSlab.screen.showScreenSimpleText(text, 'LessonWelcome');
  MSlab.showScreen(box, '.LessonWelcome');
  $(".lab-next").show();
}

function __getFormattedStrands(strands, assignedStrands) {
  var strandArrFormatted = [];
  var currentStrandShown = false;
  for (var i = 0; i < strands.length; i++) {
    var strandName = strands[i].Strand.Title;
    var strandScore = strands[i].StudentStrand.Score;
    var highLight = false;
    var isStrandAssigned = false;
    for (var j = 0; j < assignedStrands.length; j++) {
      if (strands[i].Strand.pkMLStrandID == assignedStrands[j].Strand.pkMLStrandID) {
        isStrandAssigned = true;
        break;
      }
    }
    if (strandScore == null && !isStrandAssigned) continue;
    if (!strandScore) {
      if (strands[i].StudentStrand.DateDone) {
        strandScore = '&#10003;'
      } else {
        strandScore = '';
        if (!currentStrandShown) {
          highLight = true;
          currentStrandShown = true;
        }
      }
    } else {
      strandScore = parseInt(strandScore) + '%';
    }
    var strand = {
      name: strandName,
      value: strandScore
    };
    if (highLight) {
      strand.highlight = true;
    }
    strandArrFormatted.push(strand);
  }
  return strandArrFormatted;
}

function __showSessionRemaining() {
  if (app.jsVars.assignedTime) {
    var remaining = Math.max(0, (app.jsVars.assignedTime - Math.floor(focusTimeObj.getActualTotal() / 60)));
    $('.lab-stars').html(('<span>' + remaining + '</span>&nbsp;&nbsp;Minute' + (remaining == 1 ? '' : 's') + ' remaining')).show();
  }
}

function __showLessonStart(newLesson) {
  __hideall();
  $('.lab-next.lab-right').show();
  MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
  focusTimeObj.startFlowScreenTimeNotFocusTimer();
  if (!PracticeLab.preloadChar) PracticeLab.preloadCharacter(-1);
  G_ScreenLessonWelcome = true;
  var box;
  var animated = !newLesson || G_lab.FirstTime;
  var screenHeading = (!newLesson || G_lab.FirstTime) ? 'What you\'re learning today!' : null;
  var FirstTime = G_lab.FirstTime;
  if (newLesson) G_lab.FirstTime = 0;
  if (!FirstTime && newLesson && G_lab.LessonStrands[0] && G_lab.LessonStrands[0].Lesson && (G_lab.LessonStrands[0].Lesson.IsTest == 1 || G_lab.LessonStrands[0].Lesson.IsTest === true)) {
    var text = 'Congratulations on completing your lesson.<br>\
     Now it\'s time to show what you learned.<br>\
     Ready for your lesson test?';
    box = MSlab.screen.showScreenSimpleText(text, 'screenLessonStart');
  } else {
    var remainingTime = focusTimeObj.getTimeRemaining(MSlab.assignedTime);
    var strandArrFormatted = __getFormattedStrands(G_lab.LessonStrands, G_lab.arrStrand);
    box = MSlab.screen.showScreenLessonStart(G_lab.LessonStrands[0].Lesson.Title, strandArrFormatted, remainingTime, screenHeading, animated);
  }
  MSlab.showScreen(box, '.screenLessonStart');
  PracticeLab.preloadCharacter(-1);
  $(".next-button").show();
  __showSessionRemaining();
}

function __showLessonWelcome() {
  __showLessonStart(true);
}

function __showLessonContinue() {
  __showLessonStart(false);
}

function __showLessonDone() {
  MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
  focusTimeObj.startFlowScreenTimeNotFocusTimer();
  __hideall();
  var strandArrFormatted = __getFormattedStrands((G_lab.newLesson == 1) ? G_lab.LastLessonStrands : G_lab.LessonStrands, G_lab.arrStrand);
  html = MSlab.screen.showScreenLessonDone(G_lab.LastLessonStrands[0].Lesson.Title, Math.round(G_lab.LessonScore), strandArrFormatted, 0, 0, G_lab.studentAssignmentId ? 'assignment' : null);
  MSlab.showScreen(html, '.screenLessonDone');
  if (typeof mobileKeypad !== 'undefined') {
    mobileKeypad.show(false, '.content-problem .problem-statement');
  }
  G_LessonDone = true;
  $(".next-button").show();
  __showSessionRemaining();
}

function __showQuizDone() {
  MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
  focusTimeObj.startFlowScreenTimeNotFocusTimer();
  if (MSlab.isTestLesson(G_lab.newLesson ? G_lab.LastLessonStrands : null) || G_lab.newLesson) {
    if (G_lab.newLesson) __showLessonDone();
    else PracticeLab.startProblems();
    return;
  }
  $('.QuizDone').attr('class', 'QuizDone');
  if (!PracticeLab.preloadChar) PracticeLab.preloadCharacter(-1);
  if (!PracticeLab.badCharacter) {
    PracticeLab.preloadCharacter(100);
    PracticeLab.badCharacter = PracticeLab.preloadChar;
  }
  __hideall();
  G_QuizDone = true;
  $('.QuizDone .QuizDone-content').removeClass('QuizzFailed');
  var quizDoneScreen = '';
  var html = '';
  var strandArrFormatted = __getFormattedStrands((G_lab.newLesson == 1) ? G_lab.LastLessonStrands : G_lab.LessonStrands, G_lab.arrStrand);
  var score = (G_lab.newLesson == 1) ? Math.round(G_lab.LessonScore) : null;
  var lessonStrands = (G_lab.newLesson == 1) ? G_lab.LastLessonStrands : G_lab.LessonStrands;
  if ((G_lab.QuizScore === null) || (G_lab.QuizScore >= G_lab.PassIEPScoreMax)) {
    var quizScore = G_lab.QuizScore;
    if (quizScore !== null) {
      quizScore = Math.round(quizScore);
    }
    var heading = G_lab.studentAssignmentId ? 'You\'re starting a new assignment topic!' : null;
    html = MSlab.screen.showScreenQuizDonePass(lessonStrands[0].Lesson.Title, quizScore, score, strandArrFormatted, heading);
    quizDoneScreen = '.screenQuizDonePass';
  } else {
    var title = null;
    if (G_lab.newStrand == 1) {
      title = 'Let\'s try to improve your score in the next topic.';
    } else {
      title = 'Let\'s try to improve your score with another practice set.';
      for (var i = 0; i < strandArrFormatted.length; i++) {
        if (strandArrFormatted[i].highlight)
          strandArrFormatted[i].value = Math.round(G_lab.QuizScore) + '%';
      }
    }
    html = MSlab.screen.showScreenQuizDoneFail(lessonStrands[0].Lesson.Title, Math.round(G_lab.QuizScore), score, strandArrFormatted, title);
    quizDoneScreen = '.screenQuizDoneFail';
  }
  MSlab.showScreen(html, quizDoneScreen);
  __showSessionRemaining();
  $(".next-button").show();
}

function __showScreenCongrat() {
  __hideall();
  MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
  focusTimeObj.startFlowScreenTimeNotFocusTimer();
  if (!G_lab.ClassRewardPointsEarned) {
    G_lab.ClassRewardPointsEarned = 0;
  }
  html = MSlab.screen.showScreenCongratulations(MSlab.strandTitle, Math.round(G_lab.QuizScore), (G_lab.TimeGame + G_lab.BonusTimeGame), G_lab.BadgePoint, G_lab.BadgePoint, G_lab.ClassRewardPointsEarned);
  MSlab.showScreen(html, '.screenCongrats');
  G_QuizDone = true;
  $(".next-button").show();
}

function __showScreenBadge() {
  MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
  focusTimeObj.startFlowScreenTimeNotFocusTimer();
  $('.QuizDone').attr('class', 'QuizDone');
  var html = '';
  __hideall();
  G_QuizDone = true;
  var imgSize = '';
  if (G_lab.NewBadge.Galaxy.Width) imgSize = ' width="' + G_lab.NewBadge.Galaxy.Width + '" height="' + G_lab.NewBadge.Galaxy.Width + '"';
  var html = '<div class="lab-congrat">\
  <div class="lab-text-orange bolded centered lab-font30">YOU EARNED A NEW BADGE!</div>\
  <div class="centered"><img src="' + G_lab.config.mcFilePath + G_lab.NewBadge.Galaxy.Path + '"' + imgSize + '/></div>\
  <div class="lab-new-badge-title centered bolded">' + G_lab.NewBadge.Galaxy.Name + '</div>\
  <div class="lab-new-badge-desc">' + G_lab.NewBadge.Galaxy.Description + '</div>' +
    G_lab.NewBadge.ReadAloudHtml + '</div>';
  MSlab.screen.screenModeOn();
  $('.QuizDone .QuizDone-content').html(html);
  $(".QuizDone").show();
  $(".next-button").show();
  G_lab.NewBadge = null;
}

function __showNextPracticeSet() {
  $('.QuizDone').attr('class', 'QuizDone');
  __hideall();
  G_NextPracticeSet = true;
  $(".next-button").show();
  __showQuizDone();
  $('.lab-problem').addClass('lab-nextpracticeset');
}

function __showPracticeFirstProblem() {
  ProblemPos = 0;
  PracticeLabBackup.setProblems(jQuery.extend(true, {}, G_lab.arrProblemList));
  if (G_lab.isMiniPracticeSet == true) {
    for (i = 0; i < G_lab.arrProblemList.size; i++) {
      if (G_lab.arrProblemList[i].StudentProblem.Attempted == 1 && ProblemPos < G_lab.arrProblemList.size - 1) ProblemPos = i + 1;
    }
    if (ProblemPos > 0 && G_lab.arrProblemList[ProblemPos - 1].StudentProblem.IsCorrect == 1 && G_lab.arrProblemList[ProblemPos - 1].StudentProblem.TypeNew != 'Teach Me') {
      nextSortOrder = parseInt(G_lab.arrProblemList[ProblemPos].Problem.SortOrder) + 1;
      for (i = ProblemPos; i < G_lab.arrProblemList.size; i++) {
        if (G_lab.arrProblemList[i].Problem.SortOrder == nextSortOrder && G_lab.arrProblemList[i].Problem.PracticeSet == 1) ProblemPos = i;
      }
      if (G_lab.arrProblemList[ProblemPos].Problem.SortOrder == nextSortOrder - 1) {
        __subPracticeEndStrand();
        return;
      }
    }
  } else {
    while (ProblemPos < G_lab.arrProblemList.size && G_lab.arrProblemList[ProblemPos].StudentProblem.Attempted == 1) ProblemPos++;
  }
  if (ProblemPos >= G_lab.arrProblemList.size || typeof G_lab.arrProblemList[ProblemPos] == 'undefined') {
    __subPracticeEndStrand();
    return;
  }
  G_IncorrectAttempt = 0;
  CurrentProblem = jQuery.extend(true, {}, G_lab.arrProblemList[ProblemPos].Problem);
  __updateStars();
  __displayCurrentProblem_checkEmpty();
}

function __displayCurrentProblem_checkEmpty() {
  if (CurrentProblem.Problem == false || CurrentProblem.Problem == "" || CurrentProblem.Problem == 'false' || CurrentProblem.Problem == null) {
    subPracticeEvaluateProblem_emptyProblem();
    return;
  }
  __subPractice_preLoadImagesForNextProblems();
  __displayCurrentProblem();
}

function __subPractice_preLoadImagesForNextProblems() {
  for (next_image_index = 1; next_image_index <= 2; next_image_index++) {
    if (ProblemPos + 1 >= G_lab.arrProblemList.size)
      return;
    NextProblem = $.extend({}, G_lab.arrProblemList[ProblemPos + 1].Problem);
    images = NextProblem.Problem.match(/(src=\"(.*?)\"|src=\'(.*?)\')/g);
    if (images != null) {
      for (i = 0; i < images.length; i++) {
        image = images[i].replace(/(\"|\')/ig, "").replace(/src=/ig, "").replace(/gif\?\d.(\d*)/, 'gif');
        if (image == '/MM/img/play.gif') continue;
        jQuery.preLoadImages(image);
      }
    }
  }
}

function __isChecksum() {
  checksum = new Array()
  for (i = 0; i < G_lab.arrProblemList.size; i++) {
    checksum.push(MSlab.handleCorrectAnswer(G_lab.arrProblemList[i].Problem));
  }
  str_checksum = checksum.join("~#~");
  if (str_checksum == G_lab.arrProblemList.checksum) {
    CurrentProblem = jQuery.extend(true, {}, G_lab.arrProblemList[ProblemPos].Problem);
    $("#msajax_spinner").hide();
    return true;
  }
  return false;
}

function subValidateChecksum(count) {
  if (count == 5) return false;
  if (__isChecksum() == true) return true;
  $("#msajax_spinner").show();
  ProblemList = new Array();
  for (i = 0; i < G_lab.arrProblemList.size; i++) {
    ProblemList.push(G_lab.arrProblemList[i].StudentProblem);
  }
  count++;
  $.ajax({
    type: "POST",
    url: mmapp.sbjUrl('home/practice_get_arr_problem_list'),
    data: {
      count: count,
      pkStudentCurrentID: G_lab.StudentCurrent.StudentCurrent.pkStudentCurrentID,
      ProblemList: ProblemList
    },
    dataType: "json",
    async: false,
    success: function(data) {
      G_lab.arrProblemList = data.arrList;
    }
  });
  return subValidateChecksum(count);
}

function subPracticeEvaluateProblem_emptyProblem() {
  CurrentProblemIsCorrect = 1;
  G_Time = -1;
  G_IsCorrect = CurrentProblemIsCorrect;
  G_StudentAnswer = "N/A";
  __updateProblemList(G_IsCorrect, 0, G_Time, G_StudentAnswer, 0, '## Empty Problem ##');
  G_IncorrectAttempt = 0;
  subPracticeSelectProblem();
}

function subPracticeEvaluateProblem() {
  if (PracticeIgnoreNextButton) return;
  $(".content-header").btOff();
  if (G_ScreenLessonWelcome) {
    if (mmapp.isMobile != '') {
      imagesLoaded = true;
    }
    PracticeLab.startProblems();
    return;
  }
  if (G_ScreenReviewStart) {
    PracticeLab.startProblems();
    return;
  }
  if (G_ScreenLessonContinue) {
    if (mmapp.isMobile != '') {
      imagesLoaded = true;
    }
    PracticeLab.startProblems();
    return;
  }
  if (G_ScreenStrand) {
    PracticeLab.startProblems();
    return;
  }
  if (G_NextPracticeSet) {
    PracticeLab.startProblems();
    return;
  }
  if (G_QuizDone && G_LastMode == 'Review' && G_lab.Mode == 'Practice') {
    G_LastMode == 'Practice';
    if (G_lab.FirstTime == 1)
      __showLessonWelcome();
    else {
      __showLessonContinue();
    }
    return;
  } else if (G_QuizDone && G_LastMode == 'Review') {
    PracticeLab.startProblems();
    return;
  }
  if (MSlab.checkDisplayScreen()) {
    return;
  }
  if (G_QuizDone && G_lab.newLesson != 1) {
    PracticeLab.startProblems();
    return;
  }
  if (G_QuizDone && G_lab.newLesson == 1) {
    __showLessonDone();
    return;
  }
  if (G_LessonDone && G_lab.callPMLab != 1) {
    __showLessonWelcome();
    return;
  }
  if (G_LessonDone && G_lab.callPMLab == 1) {
    if (G_lab.studentAssignmentId) {
      MSlab.redirect(MSlab.assignedlisturl, false);
    } else {
      dialog.open('completed-lessons-dialog');
    }
    return;
  }
  if (!$('.lab-problem .content-problem').is(':visible')) {
    if ($('.lab-menu-page-tied').is(':visible')) showPageProblemMultiple(-1);
    else showPageProblem();
    return;
  }
  if (MSlab.userInteract.invalidProblem()) {
    __updateProblemList(1, 0, 0, "", '', '');
    subPracticeSelectProblem();
    return;
  }
  if (!isAnswerEntered()) return;
  if (!__getCurrentProblemFromProblemList()) return;
  try {
    CurrentProblemIsCorrect = subParseAnswer();
  } catch (e) {
    logJsError("subParseAnswer \n" + e.name + '\nLab Answer: ' + CurrentProblem.CorrectAnswer + '\nStudent Answer: ' + $(".problem-statement input[type=text]").map(function() {
      return $(this).val();
    }).get().join('|'));
    CurrentProblemIsCorrect = 1;
  }
  $('.problem-feedback').css("min-height", "70px");
  if (CurrentProblem.TypeNew == 'Short Answer') {
    PracticeLab.evaluateShortAnswer();
  } else {
    $(".problem-feedback").css('height', 'auto');
    PracticeLab.evaluateProblem();
  }
  __updateStars();
}

function __updateProblemList(IsCorrect, IsCorrectCorrected, Time, StudentAnswer, FeedbackTime, CorrectAnswer) {
  var inRealtimeParams = {
    pkMLProblemID: G_lab.arrProblemList[ProblemPos].Problem.pkMLProblemID,
    isCorrect: (!IsCorrectCorrected ? IsCorrect : false),
    Time: Time,
    studentAnswer: StudentAnswer,
    correctAnswer: CorrectAnswer,
  };
  $(document).trigger('evaluateProblem.MSLab', inRealtimeParams);
  if (typeof G_lab.arrProblemList[ProblemPos] == 'undefined') return;
  if (IsCorrect) IsCorrect = 1;
  if (IsCorrectCorrected) IsCorrectCorrected = 1;
  if (Time < 0) Time = 60;
  G_lab.arrProblemList[ProblemPos].StudentProblem.Attempted = 1;
  G_lab.arrProblemList[ProblemPos].StudentProblem.IsCorrect = IsCorrect;
  G_lab.arrProblemList[ProblemPos].StudentProblem.IsCorrectCorrected = IsCorrectCorrected;
  G_lab.arrProblemList[ProblemPos].StudentProblem.Time = Time;
  G_lab.arrProblemList[ProblemPos].StudentProblem.StudentAnswer = StudentAnswer;
  G_lab.arrProblemList[ProblemPos].StudentProblem.CorrectAnswer = CorrectAnswer;
  G_lab.arrProblemList[ProblemPos].StudentProblem.FeedbackTime = FeedbackTime;
  if (typeof G_lab.arrProblemList[ProblemPos].StudentProblem.DailyChallengeProgress == "undefined" && (IsCorrect || IsCorrectCorrected || (G_lab.arrProblemList[ProblemPos].StudentProblem.TypeNew == 'Manipulative' && typeof MSlab.userInteract.manipulative != "undefined" && (MSlab.userInteract.manipulative.isAnswerCorrect() || (MSlab.userInteract.manipulative.secondary ? MSlab.userInteract.manipulative.secondary.isAnswerCorrect() : false)))) && typeof jsVars.currentDC != 'undefined' && typeof jsVars.currentDC.DailyChallengeStudent != 'undefined') {
    jsVars.currentDC.DailyChallengeStudent.WorkAmountActual++;
    G_lab.arrProblemList[ProblemPos].StudentProblem.DailyChallengeProgress = true;
    checkDailyChallenge();
  }
  if (MSlab.localData.active) {
    var ProblemList = [];
    for (var i = 0; i < G_lab.arrProblemList.size; i++)
      ProblemList.push(G_lab.arrProblemList[i].StudentProblem);
    MSlab.localData.setData({
      localProblemList: ProblemList
    });
  }
}

function subPracticeSelectProblem() {
  if (ProblemPos + 1 < G_lab.arrProblemList.size && G_lab.Mode == 'Practice' && (ProblemPos + 1) % 5 == 0) {
    __updatePracticeProblemList();
  }
  ProblemPos += 1;
  if (G_lab.isMiniPracticeSet && CurrentProblemIsCorrect && ProblemPos < G_lab.arrProblemList.size) {
    while ((ProblemPos < G_lab.arrProblemList.size) && (G_lab.arrProblemList[ProblemPos].Problem.PracticeSet != 1)) {
      ProblemPos += 1;
    }
  }
  if (ProblemPos >= G_lab.arrProblemList.size) {
    __updateStars();
    __subPracticeEndStrand();
    return;
  }
  G_IncorrectAttempt = 0;
  CurrentProblem = $.extend({}, G_lab.arrProblemList[ProblemPos].Problem);
  __updateStars();
  __updateLessonStrand();
  __displayCurrentProblem_checkEmpty();
}

function __updatePracticeProblemList() {
  ProblemList = new Array();
  for (i = 0; i < G_lab.arrProblemList.size; i++) {
    ProblemList.push(G_lab.arrProblemList[i].StudentProblem);
  }
  MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
  var data = {
    ProblemList: ProblemList,
    UpdateStudentTime: 1,
    LessonID: G_lab.Lesson,
    pkStudentCurrentID: G_lab.StudentCurrent.StudentCurrent.pkStudentCurrentID,
    key: jsVars.key
  };
  data = Object.assign(data, PracticeLab.getAndResetSaveTime());
  if (G_lab.studentAssignmentId) {
    data.studentAssignmentId = G_lab.studentAssignmentId;
  }
  if (G_lab.StudentSequenceIdOfReassignedStrand) {
    data.StudentSequenceIdOfReassignedStrand = G_lab.StudentSequenceIdOfReassignedStrand;
  }
  MSLabAjax({
    url: mmapp.sbjUrl('home/practice_update_problem_list'),
    silent: 1,
    data: data
  });
}

function __updateStudentTime() {
  MSLabAjax({
    url: mmapp.sbjUrl('home/practice_update_student_time'),
    silent: 1,
    data: PracticeLab.getAndResetSaveTime(),
  });
}

function __updatePracticeProblemListSignOut(url) {
  G_signout = true;
  MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
  if (typeof G_lab == 'undefined' || G_lab.Mode != 'Practice' || G_ScreenReviewStart || G_ScreenLessonWelcome || G_ScreenStrand || G_QuizDone || G_LessonDone || G_ScreenLessonContinue || G_lab.arrProblemList == null) {
    var data = PracticeLab.getAndResetSaveTime();
    data = $(document).triggerHandler('labUnload', data) || data;
    if (typeof jsVars.currentDC.DailyChallengeStudent != 'undefined') {
      data.varDCWorkAmountActual = jsVars.currentDC.DailyChallengeStudent.WorkAmountActual;
    }
    MSLabAjax({
      url: mmapp.sbjUrl('home/practice_update_student_time'),
      silent: 1,
      data: data,
      success: function() {
        MSlab.redirect(url, false);
      }
    });
    return;
  }
  if (typeof CurrentProblem != 'undefined' && CurrentProblem.TypeNew == 'Short Answer')
    G_lab.arrProblemList[ProblemPos].StudentProblem.StudentAnswer = MSlab.userInteract.parseAnswer();
  if (CurrentProblem && CurrentProblem.TypeNew.indexOf('Manipulative') >= 0 && MSlab.userInteract && MSlab.userInteract.manipulative.noPoint) {
    G_Time = Math.ceil((new Date().getTime() - thrTimeStart) / 1000 - PracticeLab.PauseTime);
    __updateProblemList(0, 0, G_Time, '', 0, CurrentProblem.CorrectAnswer);
  }
  ProblemList = new Array();
  for (i = 0; i < G_lab.arrProblemList.size; i++) {
    ProblemList.push(G_lab.arrProblemList[i].StudentProblem);
  }
  var data = {
    ProblemList: ProblemList,
    UpdateStudentTime: 1,
    LessonID: G_lab.Lesson,
    pkStudentCurrentID: G_lab.StudentCurrent.StudentCurrent.pkStudentCurrentID,
    key: jsVars.key
  };
  data = Object.assign(data, PracticeLab.getAndResetSaveTime());
  if (G_lab.studentAssignmentId) {
    data.studentAssignmentId = G_lab.studentAssignmentId;
  }
  data = $(document).triggerHandler('labUnload', data) || data;
  if (typeof jsVars.currentDC.DailyChallengeStudent != 'undefined') {
    data.varDCWorkAmountActual = jsVars.currentDC.DailyChallengeStudent.WorkAmountActual;
  }
  MSLabAjax({
    url: mmapp.sbjUrl('home/practice_update_problem_list'),
    data: data,
    success: function() {
      MSlab.redirect(url, false);
    }
  });
}

function __subPracticeEndStrand(nextPracticeSet = true) {
  G_LastMode = G_lab.Mode;
  ProblemList = new Array();
  PracticeIgnoreNextButton = true;
  for (i = 0; i < G_lab.arrProblemList.size; i++) {
    ProblemList.push(G_lab.arrProblemList[i].StudentProblem);
  }
  $(document).trigger('labBackgroundAndTitle.MSLab');
  MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
  var data = {
    ProblemList: ProblemList,
    LessonID: G_lab.Lesson,
    isMiniPracticeSet: G_lab.isMiniPracticeSet,
    nextPracticeSet: nextPracticeSet ? 1 : 0,
  };
  data = Object.assign(data, PracticeLab.getAndResetSaveTime());
  if (jsVars && jsVars.studentAssignmentId) {
    data.studentAssignmentId = jsVars.studentAssignmentId;
  }
  if (jsVars && jsVars.StudentSequenceIdOfReassignedStrand) {
    data.StudentSequenceIdOfReassignedStrand = jsVars.StudentSequenceIdOfReassignedStrand;
  }
  MSLabAjax({
    url: mmapp.sbjUrl('home/practice_end_strand'),
    data: data,
    disallowInParallelRequests: true,
    success: function(lab) {
      ProblemPos = 0;
      var callback = function() {
        if (typeof lab.ListError != 'undefined' && lab.ListError == 1) {
          if (PracticeLab.EndStrandAttempt == 0) {
            PracticeLab.EndStrandAttempt = 1;
            logJsError("home/practice_end_strand failed");
            alert(PracticeLab.settings.error_alert);
          } else {
            alert(PracticeLab.settings.error_alert);
          }
          return;
        }
        PracticeIgnoreNextButton = false;
        if (typeof lab.Ignore != 'undefined' && lab.Ignore == 1) {
          return;
        }
        PracticeLab.EndStrandAttempt = 0;
        G_lab = lab;
        if (G_lab.FailStrand == 1) {
          __showNextPracticeSet();
          return;
        }
        if ((G_LastMode == 'Review' && G_lab.Mode == 'Practice') || (G_lab.newStrand == 1) || (G_lab.newLesson == 1) || (G_lab.callPMLab == 1)) {
          MSlab.ScreenCongrats = true;
          MSlab.ScreenQuizDone = true;
          G_QuizDone = true;
          if (MSlab.checkDisplayScreen()) {
            return;
          }
        }
        PracticeLab.startProblems();
      };
      if (lab.certificateId > 0) {
        Moby.App.CertificateBuilder.start(lab.certificateId, callback);
      } else {
        callback();
      }
    }
  });
}

function __updateStars() {
  var total = 0;
  var current = 0;
  var stars = [];

  function isQuiz(p) {
    return (p.Problem.TypeNew == 'Quiz' || p.Problem.TypeNew == 'Quiz Manipulative' || p.Problem.TypeNew == 'Test Manipulative' || p.Problem.TypeNew == 'Short Answer');
  }
  var problemFilter = {
    noFilter: function(p) {
      return true;
    },
    onlyQuiz: function(p) {
      return isQuiz(p);
    },
    allButQuiz: function(p) {
      return !isQuiz(p);
    }
  };
  var loopFilter = problemFilter.noFilter;
  var showProgressBar = false;
  if (G_lab.isMiniPracticeSet) {
    lab_stars.hideText = 1;
    showProgressBar = true;
    lastPracticesetAttempted = 0;
    for (var i = 0; i < G_lab.arrProblemList.size; i++) {
      if (G_lab.arrProblemList[i].Problem.PracticeSet == 1) {
        if (G_lab.arrProblemList[i].StudentProblem.Attempted == 1) {
          current++;
        }
        total++;
      }
      if (G_lab.arrProblemList[i].StudentProblem.Attempted == 1) lastPracticesetAttempted = G_lab.arrProblemList[i].Problem.PracticeSet;
    }
    if (CurrentProblemIsCorrect == 0 || CurrentProblemIsCorrect == false) {
      current--;
    }
    if (CurrentProblem.PracticeSet == 1 && lastPracticesetAttempted > 1 && (typeof CurrentProblemIsCorrect == 'undefined' || (CurrentProblemIsCorrect == 0 || CurrentProblemIsCorrect == false))) {
      current++;
    }
  } else {
    lab_stars.hideText = false;
    currentIndex = (ProblemPos >= G_lab.arrProblemList.size) ? G_lab.arrProblemList.size - 1 : ProblemPos;
    if ((typeof G_lab.arrProblemList[currentIndex] != 'undefined') && (typeof G_lab.arrProblemList[currentIndex].Problem != 'undefined') && (typeof G_lab.arrProblemList[currentIndex].Problem.TypeNew != 'undefined')) {
      if (G_lab.isTeacherMadeSkill) {
        loopFilter = problemFilter.noFilter;
        showProgressBar = true;
      } else {
        loopFilter = (isQuiz(G_lab.arrProblemList[currentIndex])) ? problemFilter.onlyQuiz : problemFilter.allButQuiz;
        showProgressBar = (!isQuiz(G_lab.arrProblemList[currentIndex]) || G_lab.showAnswersCheckmarker === false);
      }
    }
    for (var i = 0; i < G_lab.arrProblemList.size; i++) {
      if (loopFilter(G_lab.arrProblemList[i])) {
        if (i == ProblemPos) current = total;
        if ((showProgressBar) || (i != ProblemPos))
          stars.push((G_lab.arrProblemList[i].StudentProblem.Attempted == 1) ? ((G_lab.arrProblemList[i].StudentProblem.IsCorrectCorrected == 1) ? 2 : ((G_lab.arrProblemList[i].StudentProblem.IsCorrect == 1) ? 1 : 3)) : 0);
        total++;
      }
    }
  }
  $('#progress_bar').hide();
  MSlab.calcGamePoints();
  MSlab.hideGamePointBanner();
  $(".lab-strand").css('visibility', '').css('margin-top', '').show();
  lab_stars.showProgressBar = showProgressBar;
  lab_stars.update(stars, total, current);
}

function startTeachMe() {
  if (typeof G_lab.arrInstruction[0] == 'undefined') {
    return;
  }
  G_PracticeCurrentProblem = CurrentProblem;
  G_TeachMePos = 0;
  G_TeachMeStep = 1;
  G_lab.Mode = "Instruction";
  $(".lab-stars").hide();
  $(".lab-strand").hide();
  $("#teach-me").hide();
  CurrentProblem = G_lab.arrInstruction[G_TeachMePos].Problem;
  __displayCurrentProblem_checkEmpty();
}

function subInstructionEvaluateProblem() {
  CurrentProblemIsCorrect = subParseAnswer();
  G_IsCorrect = CurrentProblemIsCorrect;
  if (CurrentProblemIsCorrect) {
    showCorrectBox();
    subInstructionSelectProblem();
  } else {
    $(".content-header").html("Answer is incorrect.");
    $(".content-header").css("background-color", "red");
    $(".content-header").show();
    MSlab.showProblemFeedback();
    G_TeachMeStep = 2;
  }
}

function subInstructionEvaluateProblem_emptyProblem() {
  CurrentProblemIsCorrect = 1;
  G_IsCorrect = CurrentProblemIsCorrect;
  subInstructionSelectProblem();
}

function subInstructionSelectProblem() {
  G_TeachMeStep = 1;
  G_TeachMePos += 1;
  G_lab.Mode = "Instruction";
  if (typeof G_lab.arrInstruction[G_TeachMePos] == 'undefined') {
    G_lab.Mode = 'Practice';
    CurrentProblem = G_PracticeCurrentProblem;
    $(".content-header").css("background-color", "#DDFA92");
    $(".content-header").hide();
    $(".lab-stars").show();
    $(".lab-strand").show();
    $("#teach-me").show();
    __displayCurrentProblem_checkEmpty();
    return;
  }
  CurrentProblem = G_lab.arrInstruction[G_TeachMePos].Problem;
  __displayCurrentProblem_checkEmpty();
}

function __setTeachMeButton() {
  if (typeof G_lab.arrInstruction[0] == 'undefined')
    $("#teach-me").hide();
  else
    $("#teach-me").show();
}

function showNoMoreLesson() {
  $("#loading").hide();
  __hideall();
  $(".problem-statement").html("Please ask your teacher to assign a lesson for you.");
  $(".problem-statement").css("font-size", "16px");
  $(".problem-statement").css("font-weight", "bold");
  $(".problem-statement").css("text-align", "center");
  $(".problem-statement").css("margin-top", "150px");
  $(".problem-statement").css("visibility", "visible");
  $(".content-problem").show();
  $('.lab-frame').addClass('lab-screen');
  $('.lab-next').attr('onclick', 'MSlab.goHome();')
  return;
}

function __getCurrentProblemFromProblemList() {
  CodeArray = $(".lab-problem-id").text().split(/[\.,]/);
  parsedID = parseInt(CodeArray[CodeArray.length - 1]);
  parsedPos = parseInt(CodeArray[CodeArray.length - 2]);
  ErrorCode = 0;
  if (G_lab.arrProblemList == null || typeof G_lab.arrProblemList != 'object' || typeof G_lab.arrProblemList[parsedPos] == 'undefined')
    ErrorCode = 1;
  else if (typeof G_lab.arrProblemList[parsedPos].Problem == 'undefined' || G_lab.arrProblemList[parsedPos].Problem == null)
    ErrorCode = 2;
  else if (typeof G_lab.arrProblemList[parsedPos].Problem.pkMLProblemID == 'undefined' || G_lab.arrProblemList[parsedPos].Problem.pkMLProblemID == null || G_lab.arrProblemList[parsedPos].Problem.pkMLProblemID == '')
    ErrorCode = 3;
  else if (G_lab.arrProblemList[parsedPos].Problem.pkMLProblemID != parsedID)
    ErrorCode = 4;
  if (ErrorCode > 0) {
    if (PracticeLabBackup.IsValidProblemList(parsedPos, parsedID)) {
      G_lab.arrProblemList = PracticeLabBackup.getProblems();
      ProblemPos = parsedPos;
      logJsError("Practice Problem Mismatch fixed:" + ErrorCode + ":" + parsedPos + ":" + parsedID);
      return true;
    }
  }
  if (ErrorCode > 0) {
    logJsError("Practice Problem Mismatch:" + ErrorCode + ":" + parsedPos + ":" + ProblemPos);
    G_signout = true;
    ajaxError = true;
    alert("A server communication error has occurred. Click OK to refresh.");
    return false;
  }
  return true;
}

function checkDailyChallenge() {
  if (typeof jsVars.currentDC.DailyChallengeStudent != 'undefined' && jsVars.currentDC.DailyChallengeStudent.WorkAmountActual >= jsVars.currentDC.DailyChallengeCell.WorkAmount) {
    $.ajax({
      type: "POST",
      dataType: "json",
      url: mmapp.mcUrl('daily_challenge/reward'),
      success: function(result) {
        if (result.rewarded) {
          PracticeLab.pause();
          showDailyChallengeCompletedDialog();
          $(".close_reward_dialog").bind('click', function() {
            PracticeLab.resume();
          });
        }
        jsVars.currentDC = new Array();
      }
    });
  }
}
var G_lab;
var focusTimeObj;
var G_Strand;
var G_Domain;
var G_GradeLevel;
var G_Attempt = 0;
var G_IncorrectAttempt = 0;
var G_lab_done = false;
var CurrentProblem;
var CurrentProblemIsCorrect;
var Answer;
var G_Domain_PMStrands_Loaded;
var thrTimeStart;
var thrFeedbackTimeStart;
var ProblemPos;
var G_Interval;
var G_prefetch_lab;
var G_signout = false;
var ajaxError = false;
var enablePlay = false;
var IsSessionDone;
var G_SoundSetting = 0;
var NextDisabled = false;
var G_UpdateAudioStatus = true;
var G_UpdateLabStatus = 0;
var G_SoundStatus = 0;
var TeachMeID = 0;
var TeachMeHtml = '';
var TeachMeVoiceFile = '';
var SimpleSuccessID = 0;
var SimpleSuccessHtml = '';
var QAPreviewStep = 0;
var MAX_RETRIES = 2;
var img_retries = new Array();
var img_logged = new Array();
var Temp_ProblemHTML;
var pageTiedArr = new Array();
var isFirstNextAction = true;
soundManager.debugMode = false;
soundManager.url = '/MM/css/swf/';
soundManager.flashVersion = 8;
soundManager.useFlashBlock = false;
soundManager.useHTML5Audio = true;
soundManager.noSWFCache = true;
soundManager.flashLoadTimeout = 40000;
soundManager.allowScriptAccess = 'always';
soundManager.html5Test = /^(probably|maybe)$/i;
var imagesLoaded = false;
var soundManagerLoaded = $.Deferred();
soundManager.onload = function() {
  enablePlay = true;
  soundManagerLoaded.resolve({
    timestamp: new Date().getTime()
  });
};
soundManager.onerror = function(status) {
  if (status.type == 'NO_FLASH')
    G_SoundStatus = 4;
  else if (status.type == 'INIT_TIMEOUT' && FlashDetect.major < 9)
    G_SoundStatus = 5;
  else
    G_SoundStatus = 7;
  enablePlay = false;
  soundManagerLoaded.reject();
};
$(document).on('labUnload', function(e, data) {
  data['logout'] = 1;
  return data;
});
$.ajaxSetup({
  cache: false,
  timeout: 240000
});
$(document).on('api.assessments.placement.created', function(event, data) {
  G_lab.fkZATestID = data.studentTestIds[0];
  MSlab.AssessmentsApi.getAssignments(G_lab.Student.Student.pkINStudentID, 'modules');
});
$(document).on('api.assessments.assignments.fetched', function(event, data) {
  var conf = app.jsVars.assessmentsApiConfig;
  var testId = null;
  var moduleId = null;
  var studentTestId = G_lab.fkZATestID;
  var zaTestUrl = null;
  for (var i = 0; i < data.results.length; i++) {
    var assignment = data.results[i];
    if (assignment.studentTestId == G_lab.fkZATestID && assignment.moduleId == G_lab.currentModule.ZAPlacementModule) {
      testId = assignment.testId;
      moduleId = assignment.moduleId.toLowerCase();
      break;
    }
  }
  var pmModules = {
    'glpm': 'lab/pm/mm',
    'glpl': 'lab/pm/mg',
    'glpfr': 'lab/pm/fr',
  };
  if (typeof pmModules[moduleId] !== 'undefined') {
    moduleId = pmModules[moduleId];
  }
  zaTestUrl = conf.assessmentsLabUrl + "/" + moduleId + "/" + testId + "/" + studentTestId;
  $(document).triggerHandler('pageRedirected');
  window.location.replace(zaTestUrl);
});
var tocPreview = {};
if (__get_query_string('isTocPreview', false)) {
  function tocPreviewAutoplay() {
    MSlab.autoSound('.lab-problem', CurrentProblem, function(e) {
      MSlab.isLargeAnimatedIcon = ($(e.target).hasClass('large_play_icon') && $(e.target).siblings('.large_play_icon_animated').length == 1);
      if (MSlab.isLargeAnimatedIcon) {
        $(e.target.parentElement).addClass('playing');
      }
    }, function(e) {
      if (MSlab.isLargeAnimatedIcon) {
        $(e.target.parentElement).removeClass('playing');
      }
    });
    MSlab.userInteract = problemInteract('.lab-problem', CurrentProblem, MSlab);
    var doAutoPlay = G_SoundSetting;
    if ((!$('.lab-problem .pbl-large-sound-icon').length) && (G_lab.StudentSetting.StudentSetting.IsReadAloudTeacher == 0)) {
      doAutoPlay = -1;
    }
    var doNotAutoPlay = false;
    if (this.mode == 'preview' || this.mode == 'QAPreview' || G_lab.Mode == 'preview') {
      doNotAutoPlay = true;
      CurrentProblem.autoplaySound = false;
    }
    if (!doNotAutoPlay) {
      if (MSlab.soundManagerLoaded.state() !== 'resolved') {
        MSlab.soundManagerLoaded.done(function() {
          MSlab.autoPlayFile(doAutoPlay, CurrentProblem, mmapp.module.name);
        });
      } else {
        MSlab.autoPlayFile(doAutoPlay, CurrentProblem, mmapp.module.name);
      }
    }
    setTimeout(function() {
      __applyEventsToProblem();
    }, 200);
    setTimeout(function() {
      __addFocusToProblem();
    }, 500);
    setTimeout(function() {
      __addFocusToProblem();
    }, 1000);
    $(document).trigger('displayProblem.MSLab', CurrentProblem);
  }
  Object.defineProperty(tocPreview, 'isReady', {
    get: function() {
      return this._isReady;
    },
    set: function(value) {
      this._isReady = value;
      if (value === 3) {
        if (!(__get_query_string('isTocPreview', false) && __get_query_string('nofeedback', false))) {
          tocPreviewAutoplay();
        }
      }
    }
  });
  window.addEventListener('load', function() {
    tocPreview.isReady++;
    var overlayEl = document.createElement('div');
    overlayEl.setAttribute('style', 'position:fixed;left:0;top:0;width:100%;height:100%;z-index:9999');
    document.body.appendChild(overlayEl);
    $(document).one('click', function() {
      document.body.removeChild(overlayEl);
      tocPreview.isReady++;
    });
  });
}
tocPreview.isReady = 0;

function SetAjaxErrorCookie(cookieValue) {
  if (readCookie("CakeCookie[Ajax][error]") != null) {
    cookieValue += "###" + readCookie("AjaxError");
  }
  SetCookie("CakeCookie[Ajax][error]", cookieValue, 30);
}
var LabClass = function(objectName) {
  this.objectName = objectName;
  this.onNextClick = doNext;
  this.mode = '';
  this.askGrade = false;
  this.congratPreloadedImg = null;
  this.preloadCongratImg();
  this.keepCorrectTime = 1000;
  this.timerFocus = new TimerClass({
    labName: objectName
  });
  this.timerFocus.canPause = false;
  this.assignedTime = jsVars.assignedTime;
  this.assignedlisturl = '/MM/' + jsVars.subjectCss + '/home/index?' + Math.round((Math.random() * (999999 - 100000) + 100000));
  this.isIOS = /(iPad|iPhone|iPod)/g.test(navigator.userAgent) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
  this.mobyFriendURL = jsVars.mobyFriendURL;
  this.percentComplete = null;
  this.percentCompleteLevel = null;
  this.subject = jsVars.subjectName;
  this.subjectCss = jsVars.subjectCss;
  this.screen = new ScreenClass(this.mobyFriendURL, this.subject, null, this.percentComplete, this.percentCompleteLevel, this.subjectCss, this.onNextClick);
  this.screen.setShowStartScreenGradeLabel(false);
  this.screen.setShowProgress(false);
  this.ScreenQuizDone = false;
  this.ScreenCongrats = false;
  this.AssessmentsApi = new AssessmentsApi(jsVars.assessmentsApiConfig);
  $('#lab-pause').remove();
  this.TimeNotFocus = 0;
  this.db_Time = 0;
  this.db_TimeFocus = 0;
  this.teachMeDialogVisible = false;
  focusTimeObj = new FocusTimeClass(this, this.timerFocus, PracticeLab.getLiveActualSeconds);
  $(document).on('click', '.flowscreen.screenStart .buttonBig', (function() {
    __showLessonWelcome();
  }).bind(this));
  $(window).bind('orientationchange', function() {
    if (this.teachMeDialogVisible) {
      this.resizeImages('#problem-div .standard-dialog-blue-contents', $('#problem-div .standard-dialog-blue-contents').width());
    }
  }.bind(this));
};
LabClass.prototype.noOp = function() {}
LabClass.prototype.events = {};
LabClass.prototype.onEvent = function(eventName) {
  if (this.events.hasOwnProperty(eventName))
    this.events[eventName].apply(this, Array.prototype.splice.call(arguments, 1, arguments.length - 1));
};
LabClass.prototype.imageSuccess = function(image) {
  $(image).removeAttr('onclick');
}
LabClass.prototype.imageError = function(image, fromClick) {
  var $image = $(image);
  var retries = $image.attr('data-retries');
  if ((retries < this.imgFailRetry) || (fromClick)) {
    var src = $image.attr('src');
    $image.attr('data-retries', ++retries).attr('src', src);
  }
};
LabClass.prototype.rImage = function(url, extra, w, h) {
  var i = '<img ' + extra + ' src="' + url + '" alt="&nbsp;' + this.imgAltMsg + '" data-retries="0" ';
  if (w > 0) i += 'width="' + w + '" height="' + h + '" ';
  i += 'onclick="' + this.objectName + '.imageError(this,true);" \
  onload="' + this.objectName + '.imageSuccess(this);" \
  onerror="' + this.objectName + '.imageError(this,false);"/>';
  return i;
};
LabClass.prototype.startMode = function(mode) {
  $('.lab-frame').attr('class', 'lab-frame mode-' + mode);
  $('#lab-mode').html(mode);
  this.mode = mode;
};
LabClass.prototype.sound = {
  stopPlay: function() {}
};
LabClass.prototype.setNextMessage = function(message) {
  if (message != '') $('.lab-click').show();
  else $('.lab-click').hide();
};
LabClass.prototype.autoResizeTeachMeDialog = function() {
  labProblem.autoResizeImages('#problem-div .standard-dialog-blue-contents', '#problem-div .standard-dialog-blue-contents');
};
LabClass.prototype.problemHasGamePoints = function(Problem) {
  var problemsWithGP = ['Quiz', 'Quiz Manipulative', 'Simple Success', 'Warm up', 'Test Manipulative'];
  var manipWithGp = ['Gradable Hotspot', 'Drag and Drop', 'Explore', 'Dropdown', 'Bullet', 'Type', 'Short-Short', 'MC', 'Reposition', 'Drag and Drop 2'];
  if (jQuery.inArray(Problem.TypeNew, problemsWithGP) >= 0) return true;
  var frmt = ((typeof Problem.ProblemFormat != 'undefined') ? Problem.ProblemFormat : 'undefined');
  if ((Problem.TypeNew == 'Manipulative') && (manipWithGp.indexOf(frmt) >= 0)) return true;
  return false;
};
LabClass.prototype.getProblemGamePoints = function(Problem, StudentProblem) {
  var gp = 0;
  if ((StudentProblem.Attempted == 1) && (StudentProblem.IsCorrectCorrected != 1) && (StudentProblem.IsCorrect == 1) && (MSlab.problemHasGamePoints(Problem))) {
    gp += parseInt(G_lab.StudentSetting.StudentSetting.GameBonusConversion);
    if (typeof Problem.FlashTime != 'undefined' && Problem.FlashTime != '') {
      if (StudentProblem.Time < parseInt(Problem.FlashTime))
        gp += parseInt(G_lab.StudentSetting.StudentSetting.GameBonusConversion);
    }
    if (typeof Problem.ExtraGameTime != 'undefined' && Problem.ExtraGameTime != '')
      gp += parseInt(Problem.ExtraGameTime);
  }
  return gp;
};
LabClass.prototype.calcGamePoints = function() {
  var gp = 0;
  if (G_lab.arrProblemList && G_lab.arrProblemList.size > 0) {
    for (var i = 0; i < G_lab.arrProblemList.size; i++)
      gp += this.getProblemGamePoints(G_lab.arrProblemList[i].Problem, G_lab.arrProblemList[i].StudentProblem);
  }
  $('.lab-game-counter-time').html(gp);
  $('.lab-game-counter').show();
};
LabClass.prototype.startFlashGameCounter = function(flashTime) {
  var _this = this;
  $('#progress_bar .ui-progress-text').html('Earn Double Game Points!');
  if (flashTime > 0) {
    $('.lab-stars').hide();
    $('.lab-strand').css('visibility', 'hidden').css('margin-top', '-3px');
    $('#progress_bar').show();
    this.flashTime = flashTime;
    this.flashTimeCounter = flashTime + 1;
    this.updateFlashGameCounter();
  } else $('#progress_bar').hide();
};
LabClass.prototype.updateFlashGameCounter = function() {
  if (!$('.problem-feedback').is(':visible')) {
    var _this = this;
    if (--this.flashTimeCounter > 0) {
      var percent = Math.round((this.flashTimeCounter) * 100 / (this.flashTime));
      $('#progress_bar .ui-progress').show();
      $('#progress_bar .ui-progress').css('width', percent + '%');
      this.flashTimer = setTimeout(function() {
        _this.updateFlashGameCounter();
      }, 1000);
    } else {
      this.cancelFlashGameCounter();
      $('#progress_bar .ui-progress').hide();
      $('#progress_bar .ui-progress-text').html('Sorry, no double game points this time.');
    }
  }
};
LabClass.prototype.cancelFlashGameCounter = function() {
  if (typeof this.flashTimer != 'undefined' && this.flashTimer) {
    clearTimeout(this.flashTimer);
    this.flashTimer = null;
  }
};
LabClass.prototype.hideGamePointBanner = function() {
  $('.lab-game-banner').hide();
};
LabClass.prototype.showGamePointBanner = function(seconds) {
  $('.lab-stars, .lab-strand, #progress_bar').hide();
  $('.lab-game-banner-text div').html('Put on your thinking cap and earn ' + seconds + ' game second' + (seconds == 1 ? '' : 's') + ' for this question!');
  $('.lab-game-banner').show();
};
LabClass.prototype.preloadCongratImg = function() {
  var imgExt = '.gif';
  var imgsLen = 5;
  this.congratPreloadedImg = '/MM/img/lab/congrat/' + Math.floor((Math.random() * imgsLen) + 1) + imgExt;
  var tmpImg = new Image();
  tmpImg.src = this.congratPreloadedImg;
};
LabClass.prototype.renderDynamicHTML = function(selector, dynamicHTML) {
  if (!dynamicHTML || (dynamicHTML.length == 0)) return;
  for (var i = 0; i < dynamicHTML.length; i++) {
    if (!dynamicHTML[i].items || (dynamicHTML[i].items.length == 0)) continue;
    var html = '';
    for (var j = 0; j < dynamicHTML[i].items.length; j++)
      html += (dynamicHTML[i].template.replace(/\{\{item\}\}/g, dynamicHTML[i].items[j]));
    $(selector + ' ' + dynamicHTML[i].parentSelector).html(html);
  }
};
LabClass.prototype.searchProblem = function(arrProblemList, field, value) {
  if (arrProblemList) {
    for (var i = 0; i < arrProblemList.size; i++) {
      if (arrProblemList[i].Problem && typeof arrProblemList[i].Problem[field] != 'undefined' && arrProblemList[i].Problem[field] == value)
        return arrProblemList[i].Problem.pkMLProblemID;
    }
  }
  return 0;
};
LabClass.prototype.renderHeader = function(selector, arrProblemList, CurrentProblem, dynamicHeader) {
  var header = '';
  if (dynamicHeader) {
    if ((CurrentProblem.IsSummary == true || CurrentProblem.IsSummary == 1)) header = 'Summary';
    else
    if (CurrentProblem.TypeNew == 'Quiz' && ['SC', 'SS'].indexOf(this.subject) != -1) {
      if (this.searchProblem(arrProblemList, 'TypeNew', 'Quiz') == CurrentProblem.pkMLProblemID)
        header = 'Quiz';
    } else
    if (CurrentProblem.TypeNew == 'Manipulative') {
      if (this.searchProblem(arrProblemList, 'MCIsVocab', true) == CurrentProblem.pkMLProblemID)
        header = 'Vocabulary';
    }
  }
  if ((header == '') && typeof CurrentProblem.Header != 'undefined' && CurrentProblem.Header) {
    var headerDataSound = '1:Header';
    if (typeof CurrentProblem.HeaderTTS != 'undefined' && CurrentProblem.HeaderTTS) {
      headerDataSound = '1:HeaderTTS|' + headerDataSound;
    }
    if (typeof CurrentProblem.HeaderVoice != 'undefined' && CurrentProblem.HeaderVoice) {
      headerDataSound = '0:HeaderVoice|' + headerDataSound;
    }
    header = '<img class="play_icon auto_play_icon" data-sound="' + headerDataSound + '" src="/MM/img/play_icon_e.png"><span class="pbl-header-span">' + CurrentProblem.Header + '</span>';
  } else if (header.length != 0) {
    CurrentProblem.Header = header;
    header = '<img class="play_icon auto_play_icon" data-sound="1:Header" src="/MM/img/play_icon_e.png"><span class="pbl-header-span">' + header + '</span>';
  }
  if (header != '') {
    $(selector).prepend('<div class="pbl-header">' + header + '</div>');
  }
};
LabClass.prototype.removeHeader = function(selector) {
  $(selector + ' .pbl-header').remove();
};
LabClass.prototype.onEnterKey = function(e) {
  if (((G_lab && G_lab.Mode == 'Practice') && (!PracticeLab.Pause)) || ((G_lab && G_lab.Mode != 'Practice'))) {
    if ($('.content-problem').is(':visible') && !$('.standard-dialog-blue-overlay, .overlay').is(':visible')) {
      doNext(e);
    }
  }
};
LabClass.prototype.isTestLesson = function(strands) {
  if (strands) {
    return (strands[0] && strands[0].Lesson && strands[0].Lesson.IsTest);
  }
  return Number(G_lab && G_lab.LessonStrands && G_lab.LessonStrands[0] && G_lab.LessonStrands[0].Lesson && G_lab.LessonStrands[0].Lesson.IsTest);
};
LabClass.prototype.animateCorrectBox = function(selector, callback) {
  $(selector).fadeIn(150, function() {
    setTimeout(function() {
      if (typeof callback != 'undefined') $(selector).fadeOut(150, callback);
      else $(selector).fadeOut(150);
    }, 1000);
  });
};
LabClass.prototype.showCorrect = function() {
  this.animateCorrectBox('.correct-answer');
}
LabClass.prototype.showIncorrect = function() {
  this.animateCorrectBox('.incorrect-answer');
}
LabClass.prototype.showPartial = function() {
  this.animateCorrectBox('.partial-answer');
}
LabClass.prototype.hideProblemFeedback = function() {
  $('.lab-problem').removeClass('ms-show-feedback');
  $(".feedback-overlay").hide();
  $(".problem-feedback").hide();
  $('.problem-feedback-wrap').hide();
  $(".problem-fact-feedback").hide();
  $('.problem-feedback').html('');
  $(".problem-feedback").css("visibility", "hidden");
  $(".problem-feedback").css('height', 'auto');
  if ((typeof this.userInteract != 'undefined') && (this.userInteract.feedbackPlayTimeout))
    clearTimeout(this.userInteract.feedbackPlayTimeout);
  soundManager.destroySound('aSound');
};
LabClass.prototype.showPlayIcons = function() {
  if (!soundManager.supported()) return false;
  return ($('.lab-problem .pbl-large-sound-icon').length || (!(G_lab.StudentSetting.StudentSetting.IsReadAloudTeacher == 0) && (G_SoundSetting > 0)));
};
LabClass.prototype.checkDisplayScreen = function() {
  if (this.ScreenCongrats) {
    this.ScreenCongrats = false;
    if (G_QuizDone && (G_lab.QuizScore != null) && (G_lab.QuizScore >= G_lab.PassIEPScoreMax) && ((('TimeGame' in G_lab) && (G_lab.TimeGame > 0)) || (('BadgePoint' in G_lab) && (G_lab.BadgePoint)) || (('BonusTimeGame' in G_lab) && (G_lab.BonusTimeGame > 0)))) {
      if (typeof mobileKeypad !== 'undefined') {
        mobileKeypad.show(false, '.content-problem .problem-statement');
      }
      __showScreenCongrat();
      return true;
    }
  }
  if (G_QuizDone && ('NewBadge' in G_lab)) {
    if (G_lab.NewBadge) {
      __showScreenBadge();
      return true;
    }
  }
  if (this.ScreenQuizDone) {
    this.ScreenQuizDone = false;
    var lessonStrands = G_lab.newLesson == 1 ? G_lab.LastLessonStrands : G_lab.LessonStrands;
    if (Array.isArray(lessonStrands) && Array.isArray(G_lab.arrStrand)) {
      __showQuizDone();
      return true;
    }
  }
  if (G_lab.callPMLab == 1) {
    if (G_lab.studentAssignmentId) {
      MSlab.redirect(MSlab.assignedlisturl, false);
    } else {
      showNoMoreLesson();
    }
    return true;
  }
  return false;
};
LabClass.prototype.showProblemFeedback = function() {
  this.userInteract.showProblemFeedback({
    SoundSetting: (G_lab.StudentSetting.StudentSetting.IsReadAloudTeacher > 0 ? G_SoundSetting : -1),
    isFluencyGames: (['FG', 'MG', 'MM2'].indexOf(mmapp.module.name) != -1)
  });
  this.autoSound('.lab-problem .problem-feedback', CurrentProblem);
};
LabClass.prototype.stopSound = function() {
  this.stopSounds();
};
LabClass.prototype.showScreen = function(html, containerSelector) {
  if (containerSelector)
    $(containerSelector).remove();
  $('.lab-problem').append(html);
  this.screen.screenModeOn();
};
LabClass.prototype.hideScreen = function() {
  this.screen.screenModeOff();
};
LabClass.prototype.goHome = function() {
  $('.lab-menu .lab-menu-home').click();
};
LabClass.prototype.getProblemHTML = function(problem) {
  var html = problem.Problem.replace(/gif\?\d.(\d*)/g, 'gif');
  if (location.protocol === 'https:') {
    html = html.replace(/http\:/g, 'https:');
  }
  return html;
};
LabClass.prototype.skipProblem = function() {
  CurrentProblemIsCorrect = false;
  __updateProblemList(0, 0, 10, '', 0, '');
  subPracticeSelectProblem();
};
LabClass.prototype.ajaxAsync = function(url, data) {
  if (!window.document.documentMode && window.navigator.sendBeacon) {
    blobData = new Blob([$.param(data)], {
      type: 'application/x-www-form-urlencoded'
    });
    window.navigator.sendBeacon(url, blobData);
  } else {
    $.ajax({
      type: 'POST',
      url: url,
      data: data,
      dataType: 'json',
      async: false
    });
  }
};
LabClass.prototype.problemIsManipulative = function(problem) {
  return problem.TypeNew.indexOf('Manipulative') >= 0;
};
LabClass.prototype.showCorrectOrIncorrect = function(isCorrect) {
  if (this.problemIsManipulative(CurrentProblem)) {
    if (isCorrect) {
      this.showCorrect();
    } else {
      if (this.userInteract.selfEvaluate() || this.userInteract.evaluateCorrect) {
        this.showCorrect();
      } else {
        this.showIncorrect();
      }
    }
    return;
  }
  if (isCorrect) {
    this.showCorrect();
  } else {
    this.showIncorrect();
  }
};
LabClass.prototype.isShowAnswersCheckmarker = function() {
  if (this.problemIsManipulative(CurrentProblem)) {
    return this.userInteract.needEvaluation();
  }
  return !!G_lab.showAnswersCheckmarker;
};
LabClass.prototype.isShowProblemFeedback = function(isCorrect) {
  if (this.problemIsManipulative(CurrentProblem)) {
    return this.userInteract.alwaysFeedback() || !isCorrect;
  }
  return !isCorrect || !!G_lab.studentAssignmentId || (['SC', 'FR', 'SS', 'GP', 'MM2', 'MG'].indexOf(G_lab.subject) !== -1);
};
LabClass.prototype.isShowPartialCredit = function() {
  return !this.problemIsManipulative(CurrentProblem) && !G_lab.isMiniPracticeSet && G_lab.showPartialCredit;
};
jQuery(document).ready(function() {
  MSlab = new LabClass('MSlab');
  if (typeof app == "undefined") {
    app = {};
  }
  app.labObject = MSlab;
  MSlab.config = {
    audioServer: jsVars.ReadAloudS3Server
  };
  if (MSlab && MSlab.init) {
    MSlab.init();
  }
  MSLabAjaxInit();
  $("#gear-icon").show();
  jQuery.preLoadImages("https://data.mobymax.com/lab/lab/CustomDialog.png", "/MM/img/spinner3-black.gif");
  document.onkeydown = function(e) {
    if (!e) {
      var e = window.event;
    };
    if (e) {
      if (e.keyCode == 8) {
        var src = e.srcElement ? e.srcElement : e.target;
        var tag = src.tagName ? src.tagName.toUpperCase() : '';
        var typ = (tag == 'INPUT') ? src.type.toUpperCase() : '';
        var isTextArea = (tag == 'TEXTAREA');
        var isTextField = ((tag == 'INPUT') && (typ == 'TEXT'));
        var isText = isTextField || isTextArea;
        var disabled = isText ? src.disabled : false;
        var readOnly = isText ? src.readOnly : false;
        if (!isText || disabled || readOnly) {
          e.cancelBubble = true;
          if (e.stopPropagation) e.stopPropagation();
          e.returnValue = false;
          return false;
        }
      }
    }
  }
  $(".my-stuff-div .cross").click(function() {
    $(this).parent().parent().hide();
    $(".Overlay1").hide();
    resumeLab();
  });
  __hideall();
  $(".content-problem").show();
  setTimeout(resizeLab, 200);
  init_lab();
  $(".content-header").bt({
    trigger: 'none',
    positions: ["top"],
    width: 150,
    cssStyles: {
      fontSize: '12px',
      textAlign: 'center',
      fontFamily: 'arial,helvetica,sans-serif'
    }
  });
  $(".next-button").bt({
    contentSelector: "$(this).attr('title')",
    trigger: 'none',
    positions: ["top"],
    centerPointX: 1.0,
    spikeLength: 15,
    spikeGirth: 20,
    padding: 15,
    cornerRadius: 5,
    fill: '#FFF',
    strokeStyle: '#ABABAB',
    strokeWidth: 1,
    cssStyles: {
      fontSize: '12px',
      fontFamily: 'arial,helvetica,sans-serif'
    }
  });
  var dialogOpts = {
    modal: true,
    autoOpen: false,
    height: 280,
    width: 406,
    top: 0
  };
  $(".text-message").hide();
  $("#sign-out").show();
  window.alert = function(msg) {
    msg = " " + msg;
    $("#msg").html(msg.replace(/\n/g, "<br>"));
    if (typeof dialog !== 'undefined') {
      var zindex = dialog.zOrderDefault + dialog.zorder + 1;
      $(".Overlay1").css({
        'z-index': zindex
      });
      $("#custom_alert").css({
        'z-index': (zindex + 1)
      });
    }
    $('.Overlay1').show();
    $("#custom_alert").show();
  };
  var resizeTimer = null;
  var resizeTimerSA = null;
  $(window).bind('resize', function() {
    if (resizeTimer) clearTimeout(resizeTimer);
    resizeTimer = setTimeout(resizeLab, 100);
  });
  $(document).keyup(function(event) {
    var keycode = (event.keyCode ? event.keyCode : event.which);
    if (keycode == '13') {
      if (G_PMPlacementWelcome || G_ScreenLessonWelcome || G_ScreenStrand || G_QuizDone || G_NextPracticeSet || G_LessonDone || G_ScreenLessonContinue || $("#FactIncrease").is(":visible") || $(".problem-fact-feedback").is(":visible")) {
        doNext(event);
      }
    }
  });
  $(document).keyup(function(e) {
    if (e.keyCode == 13) MSlab.onEnterKey(e);
  });
  $(".LessonDone, .QuizDone, .LessonWelcome, .LessonContinue, .LessonStrand, .PMPlacementWelcome, .lab-click").click(function(e) {
    if ($.inArray(e.target, $('.read-aloud-badge, .read-aloud-badge *')) == -1) {
      doNext(e);
    }
  });
  if (!__get_query_string('isTocPreview', false)) {
    if (typeof G_lab != 'undefined' && G_lab.arrProblemList && typeof G_lab.arrProblemList[ProblemPos] != 'undefined' && G_lab.arrProblemList[ProblemPos].Problem) {
      if (MSlab.soundManagerLoaded.state() !== 'resolved') {
        MSlab.soundManagerLoaded.done(function() {
          loadAllProblemsSound();
        });
      } else {
        loadAllProblemsSound();
      }
    }
  }
  $(window).bind("beforeunload, pagehide", function() {
    if (G_signout || typeof G_lab == 'undefined' || (G_lab.Mode != 'Practice' && G_lab.Mode != 'PM') || (G_lab.isPreview === true) || G_ScreenReviewStart || G_ScreenLessonWelcome || G_ScreenStrand || G_QuizDone || G_LessonDone || G_ScreenLessonContinue) {
      return;
    }
    if (G_signout || typeof G_lab == 'undefined' || G_lab.Mode != 'Practice' || (G_lab.isPreview === true) || G_ScreenReviewStart || G_ScreenLessonWelcome || G_ScreenStrand || G_QuizDone || G_LessonDone || G_ScreenLessonContinue) {
      return;
    }
    if (typeof G_lab == 'undefined' || !G_lab || typeof G_lab.StudentCurrent == false || !G_lab.StudentCurrent || typeof G_lab.StudentCurrent['StudentCurrent']['pkStudentCurrentID'] == 'undefined')
      return;
    if (CurrentProblem && CurrentProblem.TypeNew.indexOf('Manipulative') >= 0 && MSlab.userInteract && MSlab.userInteract.manipulative.noPoint) {
      G_Time = Math.ceil((new Date().getTime() - thrTimeStart) / 1000 - PracticeLab.PauseTime);
      __updateProblemList(0, 0, G_Time, '', 0, MSlab.handleCorrectAnswer(CurrentProblem));
    }
    G_signout = true;
    ProblemList = new Array();
    for (i = 0; i < G_lab.arrProblemList.size; i++) {
      ProblemList.push(G_lab.arrProblemList[i].StudentProblem);
    }
    MSlab.TimeNotFocus += focusTimeObj.endTimeNotFocusTimer();
    var data = {
      ProblemList: ProblemList,
      UpdateStudentTime: 1,
      LessonID: G_lab.Lesson,
      pkStudentCurrentID: G_lab.StudentCurrent.StudentCurrent.pkStudentCurrentID,
      key: jsVars.key
    };
    data = Object.assign(data, PracticeLab.getAndResetSaveTime());
    if (G_lab.studentAssignmentId) {
      data.studentAssignmentId = G_lab.studentAssignmentId;
    }
    data = $(document).triggerHandler('labUnload', data) || data;
    MSlab.ajaxAsync(mmapp.sbjUrl('home/practice_update_problem_list'), data);
  });
  labIdleMiliSeconds = 120000;
  if (typeof(jsVars.idleSeconds) != "undefined")
    labIdleMiliSeconds = jsVars.idleSeconds * 1000;
  $.idleTimer(labIdleMiliSeconds);
  $(document).bind("idle.idleTimer", function() {
    if (G_lab && (G_lab.Mode == 'Practice' || G_lab.Mode == 'PM') && PracticeLab.Pause == false && PracticeLab.canPause && (G_lab.isPreview !== true)) {
      showPause();
      if (G_lab.Mode == 'Practice') {
        __updateStudentTime();
      }
      return;
    }
  });
});
LabClass.prototype.handleCorrectAnswer = function(problem) {
  if (typeof MSlab.userInteract != 'undefined') {
    return MSlab.userInteract.getCorrectAnswer.call({
      problem
    });
  } else if (typeof Interact != 'undefined') {
    return Interact.prototype.getCorrectAnswer.call({
      problem
    });
  }
  return problem['CorrectAnswer'];
};

function init_lab() {
  MSlab.localData.key = (mmapp.module.subject.capitalize() + '_' + jsVars.key).replace(/[^A-Za-z0-9]/g, '');
  MSlab.localData.setActive(mmapp.isMobile == 'ipad');
  if (jsVars.isOpenLab2 == 1) {
    try {
      init_lab_cb(jsVars.Lab);
    } catch (e) {
      if (typeof console == "object") console.log(e);
      logJsError("openLab2 \n" + e.name);
    }
    return;
  }
  var initData;
  if (jsVars && jsVars.studentAssignmentId) {
    initData = {
      studentAssignmentId: jsVars.studentAssignmentId
    };
    if (jsVars.StudentSequenceIdOfReassignedStrand) {
      initData.StudentSequenceIdOfReassignedStrand = jsVars.StudentSequenceIdOfReassignedStrand;
    }
  } else {
    initData = MSlab.localData.getData({});
  }
  MSLabAjax({
    url: mmapp.sbjUrl('home/load_lab'),
    max_retries: 0,
    data: initData,
    disallowInParallelRequests: true,
    success: function(lab) {
      init_lab_cb(lab, true);
    }
  });
}

function reload_Lab() {
  if (typeof jsVars != 'undefined' && typeof jsVars.key != 'undefined') {
    window.location.href = mmapp.sbjUrl('home/index2?_=' + Math.random() + '&key=' + jsVars.key);
  } else
    window.location.href = mmapp.sbjUrl('home/index2');
}

function logJsError(msg) {
  if (!G_UpdateAudioStatus && msg.indexOf('SM ') >= 0) return;
  if (!G_UpdateLabStatus > 1 && msg.indexOf('SM ') >= 0) return;
  MSLabAjax({
    url: mmapp.sbjUrl('home/log_js_error'),
    data: {
      msg: msg,
      flash: FlashVersion = (FlashDetect.installed) ? FlashDetect.major + "." + FlashDetect.minor : 0
    },
    success: null
  });
}

function init_lab_cb(lab, isAsync) {
  $("#loading").hide();
  $(".text-message").hide();
  $("#FactIncrease").hide();
  $(".content-header").css("background-color", "#DDFA92");
  G_lab = lab;
  MSlab.db_TimeFocus = G_lab.db_TimeFocus;
  MSlab.db_Time = G_lab.db_Time;
  PracticeLab.getAndResetSaveTime();
  if (!__get_query_string('isTocPreview', false)) {
    if (typeof isAsync === 'undefined' || !isAsync) {
      if (MSlab.soundManagerLoaded.state() !== 'resolved') {
        MSlab.soundManagerLoaded.done(function() {
          loadAllProblemsSound();
        });
      } else {
        loadAllProblemsSound();
      }
    }
  }
  lab_stars.init({
    selector: '.lab-stars'
  });
  $("#my-stuff").show();
  if (['GP', 'FR', 'MG'].indexOf(G_lab.subject) >= 0) {
    G_SoundSetting = 2;
    G_lab.StudentSetting.StudentSetting.IsReadAloudTeacher = 1;
    $(".sound-setting-fieldset").val(G_lab.StudentSetting.StudentSetting.IsReadAloudStudent);
    $('.sound-setting-fieldset').attr('disabled', 'disabled');
  } else {
    $(".sound-setting-fieldset").val(G_lab.StudentSetting.StudentSetting.IsReadAloudStudent);
    G_SoundSetting = G_lab.StudentSetting.StudentSetting.IsReadAloudStudent;
  }
  soundSettings.displaySoundSettingsSections(MSlab, MSlab.subjectCss);
  labBackgroundAndTitle();
  if (G_lab.Mode == "PM") {
    __init_lab_pm();
    $(".lab-menu-break").hide();
  } else if (G_lab.Mode == "Practice" || G_lab.Mode == "Review") {
    $(".lab-menu-break").hide();
    __init_lab_practice();
  } else if (G_lab.Mode == "QAPreview") {
    $(".lab-menu-break").hide();
    __init_lab_qa_preview();
  }
}

function __updateLessonStrand() {
  $(".lab-strand").css('visibility', '').css('margin-top', '').show();
  MSlab.strandTitle = G_lab.arrStrand[0].Strand.Title;
  $(".lab-strand").html(MSlab.strandTitle);
  if (G_lab.arrStrand[0].Strand.pkSkillID) {
    $('.lab-menu-toc').css('display', 'none');
  } else {
    $('.lab-menu-toc').css('display', 'inline-block');
  }
  getTeachMeID();
  getPreviousStrands();
  getSimpleSuccessID();
}

function blink($target) {
  var backgroundColor = '#F49A2B';
  var existingBgColor;
  existingBgColor = $target.css('background-color');
  $target.css('background-color', backgroundColor);
  setTimeout(function() {
    $target.css('background-color', existingBgColor);
  }, 500);
}

function showCorrectBox() {
  $(".correct-answer").fadeIn("slow");
  setTimeout(function() {
    $(".correct-answer").fadeOut("slow")
  }, 1000);
}

function showWarmupFlash() {
  $(".warmup-flash").fadeIn("slow");
  setTimeout(function() {
    $(".warmup-flash").fadeOut("slow")
  }, 1500);
}

function showQuizFlash() {
  $(".quiz-flash").fadeIn("slow");
  setTimeout(function() {
    $(".quiz-flash").fadeOut("slow")
  }, 1500);
}

function showIncorrectBox() {
  $(".incorrect-answer").fadeIn("slow");
  setTimeout(function() {
    $(".incorrect-answer").fadeOut("slow")
  }, 1000);
}
var SAlabClass = function(objectName) {
  this.objectName = objectName;
  this.editorSelector = 'SAinput';
  this.viewSelector = 'lab-view-content';
  this.assignments = [];
  this.assignment = null;
  this.score = null;
  this.selectedRating = null;
  this.prepopulate = '';
  this.editorReady = false;
};
SAlabClass.prototype.removeEditor = function() {
  if (typeof tinymce != "undefined") {
    var ed = tinymce.get(this.editorSelector);
    if (ed) {
      try {
        ed.remove();
      } catch (e) {
        delete tinymce.editors[this.editorSelector];
      }
    }
  }
  this.editorReady = false;
};
SAlabClass.prototype.displayEdit = function() {
  var _this = this;
  this.removeEditor();
  $('.lab-frame').attr('class', 'lab-frame mode-practice lab-edit-screen');
  $('#SALabEditor').html('<div class="lab-editor lab-box-sizing"><textarea id="' + this.editorSelector + '" name="SAinput" spellcheck="false" class="lab-box-sizing"></textarea></div>');
  tinymce.baseURL = '/MM/node_modules/@moby/common-student-lab/src/js/tinymce/';
  tinymce.suffix = '.min';
  var tinyOptions = {
    selector: '#' + this.editorSelector,
    plugins: ['textcolor', 'noneditable', 'mmupload', 'link', 'table', 'lists'],
    content_css: '/MM/css/elements/MW/mw_editor.css',
    statusbar: false,
    menubar: false,
    toolbar1: 'bold italic underline forecolor alignleft aligncenter alignright alignjustify cut copy paste bullist numlist outdent indent removeformat',
    toolbar2: 'styleselect fontselect fontsizeselect undo redo table link subscript superscript mmupload',
    mmupload_params: {
      pkMLProblemID: CurrentProblem.pkMLProblemID,
    },
    auto_focus: this.editorSelector,
    setup: function(editor) {
      editor.on('init', function(e) {
        _this.onEditorReady();
      });
      editor.on('change', function(e) {
        var height = $('#' + SAlab.editorSelector + '_ifr')[0].contentWindow.document.body.offsetHeight + 25;
        $('#' + SAlab.editorSelector + '_ifr').height(height);
      });
      editor.on('keydown', function(e) {
        if (e.keyCode == 9) {
          if (e.shiftKey) {
            editor.execCommand('Outdent');
          } else {
            editor.execCommand('Indent');
          }
          e.preventDefault();
          return false;
        }
      });
    }
  };
  if (screen.width < 640 || screen.height < 640 || window.nativeBridge || mmapp.isMobile == 'desktop') {
    tinyOptions.toolbar1 = 'bold italic underline forecolor alignleft aligncenter alignright alignjustify cut copy paste bullist numlist';
    tinyOptions.toolbar2 = 'styleselect fontselect fontsizeselect undo redo table';
    tinyOptions.toolbar3 = 'outdent indent removeformat link subscript superscript mmupload';
  }
  if (mmapp.isMobile == 'ipad') {
    tinyOptions.toolbar1 = tinyOptions.toolbar1.replace(' cut copy paste', '');
  }
  tinymce.init(tinyOptions);
};
SAlabClass.prototype.onEditorReady = function() {
  SAlab.editorReady = true;
  if (SAlab.prepopulate != '') SAlab.setContent(SAlab.prepopulate);
  SAlab.isMobile = G_lab.isMobile;
  SAlab.markupHoverBind('#' + SAlab.editorSelector + '_ifr', 0);
};
SAlabClass.prototype.windowResize = function() {
  titleHeight = $('.ms-pbl-shortanswer-statement').height() + 20;
  viewportHeight = $('.lab-problem').height() - titleHeight;
  editableArea = viewportHeight - 70;
  viewportHeight = viewportHeight.toString() + "px";
  editableArea = editableArea.toString() + "px";
};
SAlabClass.prototype.setContent = function(content) {
  this.prepopulate = content;
  if (this.editorReady) tinymce.get('SAinput').setContent(content);
};
SAlabClass.prototype.markupHoverBind = function(selector, markupList) {
  var _this = this;
  $(selector).contents().delegate('.mw-teacher-mark', 'click touchstart', function(e) {
    dialog.close('mw-tooltip-box');
    var $target = $(e.target);
    var editorOffset = $(selector).offset();
    editorOffset.top -= $(selector).contents().scrollTop();
    _this.markupShowTooltip('mw-tooltip-close', $target, editorOffset, markupList);
  });
  if (this.isMobile == '' || this.isMobile == 'desktop') {
    $(selector).contents().delegate('.mw-teacher-mark', 'mouseover', function(e) {
      var $target = $(e.target);
      var editorOffset = $(selector).offset();
      editorOffset.top -= $(selector).contents().scrollTop();
      _this.markupShowTooltip('mw-tooltip-box', $target, editorOffset, markupList);
    });
  }
  $(selector).contents().delegate('.mw-teacher-mark', 'mouseout', function(e) {
    if (MSlab && MSlab.pauseInitedSound) {
      MSlab.pauseInitedSound();
    }
    dialog.close('mw-tooltip-box');
  });
};
SAlabClass.prototype.markupShowTooltip = function(tooltipID, $target, offset, markupList) {
  var targetOffset = $target.offset();
  var p = {
    x: offset.left + targetOffset.left,
    y: offset.top + targetOffset.top
  };
  $('#' + tooltipID + ' .mw-tooltip-box-title span').html($target.attr('data-title'));
  $('#' + tooltipID + ' .mw-tooltip-box-content').html($target.attr('data-description'));
  if (MSlab && MSlab.pauseInitedSound) {
    MSlab.pauseInitedSound();
  }
  dialog.open(tooltipID);
  if (markupList == 0) {
    $('#' + tooltipID).css({
      top: Math.max(p.y - $('#' + tooltipID).outerHeight(), 10),
      left: p.x + $target.outerWidth() / 2 - $('#' + tooltipID).outerWidth() / 2
    });
  } else {
    $('#' + tooltipID).css({
      top: Math.max(p.y - $('#' + tooltipID).outerHeight(), 10)
    });
  }
};

function __displayCurrentProblem() {
  if (MSlab && MSlab.pauseInitedSound) {
    MSlab.pauseInitedSound();
  }
  $('.screenLessonStart').hide();
  if (ProblemPos == 0) {
    $('.lab-menu-page-show').css('display', '');
    $('.lab-menu-page-tied').css('display', '');
  }
  PracticeLab.PauseTime = 0;
  PracticeLab.canPause = (CurrentProblem.TypeNew != 'Teach Me');
  if (CurrentProblem.TypeNew == 'Teach Me') {
    $('.lab-submenu-hint').hide();
  } else {
    if (SimpleSuccessID > 0) $('.lab-submenu-hint').show();
    else $('.lab-submenu-hint').hide();
  }
  if (CurrentProblem.TypeNew != "Page") __setPageMenu();
  if (typeof G_lab.LessonShortAnswers != 'undefined' && G_lab.LessonShortAnswers && G_lab.LessonShortAnswers != '') {
    $('.lab-menu-page-show').css('display', '');
    $('.lab-menu-page-tied').css('display', '');
    $('.lab-menu-back-shortanswer').css('display', 'inline-block');
  } else $('.lab-menu-back-shortanswer').hide();
  $(".content-header").hide();
  MSlab.hideProblemFeedback();
  $(".content-problem").show();
  if (typeof CurrentProblem.TypeNew != 'undefined') {
    var typeNew = (CurrentProblem.TypeNew.indexOf('Manipulative') >= 0) ? 'Manipulative' : CurrentProblem.TypeNew;
    $('.lab-problem').attr('class', 'lab-problem ms-pbl-type-' + typeNew.replace(' ', '-') +
      ((typeof G_lab.subject != 'undefined') ? (' lab-subject-' + G_lab.subject) : ''));
  }
  $('.problem-statement').css("visibility", "visible");
  if (typeof CurrentProblem.ProblemFormat != 'undefined') {
    if (CurrentProblem.ProblemFormat != 'Flash Card') {
      $('.problem-statement').css("height", "auto");
    }
  }
  if (G_lab.Mode == 'Practice') {
    if (!subValidateChecksum(0)) {
      reload_Lab();
      return;
    }
  }
  $('.problem-statement').html(MSlab.getProblemHTML(CurrentProblem));
  MSlab.removeHeader('.lab-problem');
  __adjustImages();
  $(".problem-statement :input").keyup(function(e) {
    var key = (e.which) ? e.which : e.keyCode;
    if (key == 13) {
      e.stopPropagation();
      e.preventDefault();
      if ($("#msg").is(":visible") && document.getElementById("msg").style.display != 'none' && !ajaxError) {
        $(".Overlay1").hide();
        $("#custom_alert").hide();
      } else {
        if (typeof BLLab !== 'undefined') {
          BLLab.next();
        } else {
          doNext(e);
        }
      }
    }
  });
  $('.problem-statement').css("visibility", "visible");
  if (jsVars.isOpenLab2 == 1 && G_lab.Mode != 'QAPreview') {
    jsVars.isOpenLab2 = 0;
  }
  $('#progress_bar').hide();
  MSlab.hideGamePointBanner();
  MSlab.cancelFlashGameCounter();
  if (typeof CurrentProblem.FlashTime != 'undefined' && CurrentProblem.FlashTime != '' && parseInt(CurrentProblem.FlashTime) > 0) {
    MSlab.startFlashGameCounter(parseInt(CurrentProblem.FlashTime));
  } else
  if (typeof CurrentProblem.ExtraGameTime != 'undefined' && CurrentProblem.ExtraGameTime != '' && parseInt(CurrentProblem.ExtraGameTime) > 0) {
    MSlab.showGamePointBanner(parseInt(CurrentProblem.ExtraGameTime) + G_lab.StudentSetting.StudentSetting.GameBonusConversion);
  } else {
    if (lab_stars.showProgressBar)
      $('#progress_bar').show();
  }
  thrTimeStart = new Date().getTime();
  if (G_lab.Mode == "Practice") {
    if (CurrentProblem.TypeNew == 'Manipulative')
      focusTimeObj.startTimeNotFocusTimer(60);
    else if (CurrentProblem.TypeNew == 'Short Answer')
      focusTimeObj.startTimeNotFocusTimer(240);
    else if (CurrentProblem.TypeNew == 'Teach Me');
    else
      focusTimeObj.startTimeNotFocusTimer(PracticeLab.getStrandTime());
    $(".left-code").html(ProblemPos + '.' + CurrentProblem.pkMLProblemID);
  } else if (G_lab.Mode == "PM") {
    focusTimeObj.startTimeNotFocusTimer(120);
    $(".left-code").html('0.' + CurrentProblem.pkMLProblemID);
  } else {
    $(".right-code").html("");
    $(".left-code").html("");
  }
  if ((mmapp.isMobile == '' || mmapp.isMobile == 'desktop') && !(navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {
    $(".code").show();
  } else {
    $(".code").hide();
    var inputs = $('.problem-statement :input[type="text"]');
    var goodCorrectAnswer = MSlab.handleCorrectAnswer(CurrentProblem)
    var showKeypad = ((CurrentProblem.TypeNew != 'Page') && ((CurrentProblem.ProblemType == 'Template') || ((CurrentProblem.ProblemType == 'Blank') && (goodCorrectAnswer != '') && (!CurrentProblem.BlankFieldType || CurrentProblem.BlankFieldType == '' || CurrentProblem.BlankFieldType.indexOf('t') < 0))) && goodCorrectAnswer !== null && !goodCorrectAnswer.match(/[A-Za-z]/)) || (mmapp.module.subject === 'math' && CurrentProblem.ProblemType == 'Draw' && ['Drag and Drop', 'Drag and Drop 2'].indexOf(CurrentProblem.ProblemFormat) > -1 && inputs.length > 0 && goodCorrectAnswer !== null && !goodCorrectAnswer.match(/[A-Za-z]/)) || ((CurrentProblem.BlankFieldType && CurrentProblem.BlankFieldType.indexOf('n') > -1) && !CurrentProblem.ProblemType && inputs.length > 0 && goodCorrectAnswer !== null && !goodCorrectAnswer.match(/[A-Za-z]/));
    if (showKeypad) {
      mobileKeypad.show(true, '.content-problem .problem-statement', CurrentProblem, inputs);
      setTimeout(resizeLab, 50);
      $('.content-wrapper').addClass('lab-frame-keypad');
    } else {
      mobileKeypad.show(false, '.content-problem .problem-statement');
      if ($('.content-wrapper').hasClass('lab-frame-keypad')) {
        $('.content-wrapper').removeClass('lab-frame-keypad');
        setTimeout(resizeLab, 50);
      }
    }
    mobileLab.autoZoom('.content-problem', '.content-problem .problem-statement');
  }
  $(".problem-statement :input").attr("data-type", "numeric");
  code = '';
  if (typeof CurrentProblem.TypeNew != 'undefined' && CurrentProblem.TypeNew == 'Short Answer') {
    $('#show-hint').hide();
    $('.content-lesson-strand').hide();
    $('.problem-statement').wrapInner('<div class="ms-pbl-shortanswer-statement"></div>');
    $('.problem-statement').append('<div id="SALabEditor"></div>');
    SAlab = new SAlabClass('SAlab');
    SAlab.displayEdit();
    SAlab.windowResize();
    $(window).bind('resize', function() {
      resizeTimerSA = null;
      if (resizeTimerSA) clearTimeout(resizeTimerSA);
      resizeTimerSA = setTimeout("SAlab.windowResize()", 100);
    });
    $(".left-code").html(ProblemPos + '.' + CurrentProblem.pkMLProblemID);
    if (G_lab.arrProblemList && typeof G_lab.arrProblemList[ProblemPos] != 'undefined' && G_lab.arrProblemList[ProblemPos].StudentProblem && G_lab.arrProblemList[ProblemPos].StudentProblem.StudentAnswer != '') {
      SAlab.setContent(G_lab.arrProblemList[ProblemPos].StudentProblem.StudentAnswer);
    } else
    if (typeof G_lab.PrepopulateShortAnswers != 'undefined' && G_lab.PrepopulateShortAnswers && G_lab.PrepopulateShortAnswers != '') {
      SAlab.setContent(G_lab.PrepopulateShortAnswers);
    }
    thrTimeStart = new Date().getTime();
  }
  if (typeof pad != 'undefined') pad.clear();
  labProblem.renderDynamicHTML('.lab-problem', CurrentProblem.DynamicHTML);
  if (!MSlab.isTestLesson())
    MSlab.renderHeader('.lab-problem', G_lab.arrProblemList, CurrentProblem, (['SC', 'SS', 'GP', 'FR'].indexOf(G_lab.subject) >= 0));
  if (MSlab.showPlayIcons()) labProblem.showPlayIcons();
  else {
    $('.lab-problem').addClass('ms-pbl-nosound');
    labProblem.hidePlayIcons();
  }
  if (!__get_query_string('isTocPreview', false)) {
    MSlab.autoSound('.lab-problem', CurrentProblem, function(e) {
      MSlab.isLargeAnimatedIcon = ($(e.target).hasClass('large_play_icon') && $(e.target).siblings('.large_play_icon_animated').length == 1);
      if (MSlab.isLargeAnimatedIcon) {
        $(e.target.parentElement).addClass('playing');
      }
    }, function(e) {
      if (MSlab.isLargeAnimatedIcon) {
        $(e.target.parentElement).removeClass('playing');
      }
    });
    MSlab.userInteract = problemInteract('.lab-problem', CurrentProblem, MSlab);
    var doAutoPlay = G_SoundSetting;
    if ((!$('.lab-problem .pbl-large-sound-icon').length) && (G_lab.StudentSetting.StudentSetting.IsReadAloudTeacher == 0)) {
      doAutoPlay = -1;
    }
    var doNotAutoPlay = false;
    if (this.mode == 'preview' || this.mode == 'QAPreview' || G_lab.Mode == 'preview') {
      doNotAutoPlay = true;
      CurrentProblem.autoplaySound = false;
    }
    if (!doNotAutoPlay) {
      if (MSlab.soundManagerLoaded.state() !== 'resolved') {
        MSlab.soundManagerLoaded.done(function() {
          MSlab.autoPlayFile(doAutoPlay, CurrentProblem, mmapp.module.name);
        });
      } else {
        MSlab.autoPlayFile(doAutoPlay, CurrentProblem, mmapp.module.name);
      }
    }
    setTimeout(function() {
      __applyEventsToProblem();
    }, 200);
    setTimeout(function() {
      __addFocusToProblem();
    }, 500);
    setTimeout(function() {
      __addFocusToProblem();
    }, 1000);
    $(document).trigger('displayProblem.MSLab', CurrentProblem);
  } else {
    tocPreview.isReady++;
  }
  if (CurrentProblem.IsDragDropNoGrayArea != null && CurrentProblem.IsDragDropNoGrayArea != '' && CurrentProblem.IsDragDropNoGrayArea > 0) {
    if (CurrentProblem.IsDragDropNoGrayArea == 1)
      $('.lab-problem').addClass('pbl-nobackground');
    else
    if (CurrentProblem.IsDragDropNoGrayArea == 2)
      $('.lab-problem').addClass('pbl-bottombackground ms-pbl-format-DragAndDrop');
    else
    if (CurrentProblem.IsDragDropNoGrayArea > 2 && typeof CurrentProblem.DragDropGrayAreaWidth != 'undefined' && CurrentProblem.DragDropGrayAreaWidth > 0)
      $('.lab-problem').addClass('pbl-leftbackground');
  }
  if (CurrentProblem.IsDragDropNoGrayArea == null && typeof CurrentProblem.ProblemFormat != 'undefined' && CurrentProblem.ProblemFormat == 'Drag and Drop') {
    $('.lab-problem').addClass('ms-pbl-format-DragAndDrop ms-pbl-format-MC DragAndDropNoExpand');
  }
}

function loadAllProblemsSound() {
  var soundPath = '';
  var currId = (CurrentProblem && CurrentProblem.pkMLProblemID) ? CurrentProblem.pkMLProblemID : (this.problemIndex ? G_lab.arrProblemList[this.problemIndex].pkMLProblemID : 0);
  if (currId === 0) {
    if (G_lab && G_lab.arrProblemList) {
      for (var key in G_lab.arrProblemList) {
        if (G_lab.arrProblemList.hasOwnProperty(key)) {
          var oneProb = G_lab.arrProblemList[key];
          if (oneProb['StudentProblem'] && (!oneProb['StudentProblem']['Attempted'] || !oneProb['StudentProblem']['Attempted'].length)) {
            if (oneProb['Problem'] && oneProb['Problem'].pkMLProblemID) {
              currId = oneProb['Problem'].pkMLProblemID
              break;
            }
          }
        }
      }
    }
  }
  if (G_lab && G_lab.config) {
    var path = G_lab.config.ReadAloudS3Server ? G_lab.config['ReadAloudS3Server'] : G_lab.config['read_aloud_url'];
    soundPath = path + "problems/" + Math.floor(currId / 1000);
  }
  if (G_lab && G_lab.arrProblemList) {
    var arrKeys = Object.keys(G_lab.arrProblemList);
    if (G_lab.arrProblemList[arrKeys[0]] && G_lab.arrProblemList[arrKeys[0]]['VoiceFile']) {
      var vf = G_lab.arrProblemList[arrKeys[0]]['VoiceFile'];
      soundPath = vf.substring(0, vf.lastIndexOf("/"));
      soundPath = soundPath.substring(0, soundPath.lastIndexOf("/"));
    }
  }
  if (CurrentProblem && CurrentProblem['VoiceFile']) {
    soundPath = CurrentProblem['VoiceFile'].substring(0, CurrentProblem['VoiceFile'].lastIndexOf("/"));
    soundPath = soundPath.substring(0, soundPath.lastIndexOf("/"));
  }
  var problemsList = (G_lab && typeof G_lab === 'object' && G_lab.arrProblemList) ? G_lab.arrProblemList : null;
  var problemsArr = [];
  if (problemsList && typeof problemsList === 'object' && Object.keys(problemsList).length) {
    Object.keys(problemsList).forEach(function(k, i) {
      if (typeof problemsList[i] === 'object') {
        if (problemsList[i].Problem.ProblemFormat === 'Intro' && Array.isArray(problemsList[i].Problem.DynamicHTML) && problemsList[i].Problem.DynamicHTML.length > 0) {
          problemsList[i].Problem.IntroFakeText = labProblem.parseDynamicHTML(problemsList[i].Problem.DynamicHTML);
        }
        problemsArr.push(problemsList[i]);
      }
    });
  } else if (problemsList && typeof problemsList === 'array') {
    problemsArr = problemsList;
  }
  var audioSrv = (G_lab && G_lab.config && G_lab.config.ReadAloudS3Server) ? G_lab.config.ReadAloudS3Server : '';
  var startingFromProblem = 0;
  if (problemsArr && Array.isArray(problemsArr) && problemsArr.length) {
    var problemIndex = 0;
    problemsArr.forEach(function(prob, i) {
      if (prob && prob['Problem'] && prob['Problem'].pkMLProblemID == currId) {
        problemIndex = i;
        startingFromProblem = prob['Problem'].pkMLProblemID;
      }
    });
    problemsArr.forEach(function(prob, i) {
      if (prob && prob['Problem'] && i < problemIndex) {
        if (MSlab && MSlab.uninitSound) {
          MSlab.uninitSound(prob['Problem'].pkMLProblemID);
        }
      }
    });
    MSlab.initProblemsSoundsPart(problemsArr, 'Problem', problemIndex, audioSrv);
  }
}

function __setPageMenu() {
  $('.lab-menu-page-show').css('display', '');
  $('.lab-menu-page-tied').css('display', '');
  $('.PageProblem').css('display', '').html('');
  $('#multiplePages-menu').html('')
  if ((G_lab.Mode == 'Practice') && (typeof G_lab.arrProblemList != 'undefined')) {
    var i = (typeof ProblemPos != 'undefined') ? ProblemPos : 0;
    var multiplePagesIndex = 0;
    var z = i;
    while (z >= 0) {
      if (G_lab.arrProblemList[z--].Problem.TypeNew == 'Page') {
        multiplePagesIndex++;
      }
    }
    while (--i >= 0) {
      if (G_lab.arrProblemList[i].Problem.TypeNew == 'Page') {
        $('.PageProblem').html(G_lab.arrProblemList[i].Problem.Problem);
        $('.PageProblem').attr('data-problemID', i);
        $(".lab-menu-page-show").attr("onclick", "showPageProblem()");
        $('.lab-menu-page-show').css('display', 'inline-block');
        if (parseInt(G_lab.arrProblemList[i].Problem.IsPageTied) == 1) {
          $('.lab-menu-page-show').css('display', '');
          $('.lab-menu-page-hide').css('display', '');
          $('.lab-menu-page-tied').css('display', 'inline-block');
          var j = i;
          while (j >= 0) {
            if (G_lab.arrProblemList[j].Problem.TypeNew == 'Page' && parseInt(G_lab.arrProblemList[j].Problem.IsPageTied) == 1) {
              $('#multiplePages-menu').prepend('<div class="lab-submenu-item lab-submenu-page' + j + '" onclick="showPageProblemMultiple(' + j + ')"><a href="javascript:void(0)">Page ' + multiplePagesIndex + '</a></div>');
              multiplePagesIndex--;
            }
            j--;
          }
          $('#multiplePages-menu').append('<div class="lab-submenu-item lab-submenu-pages submenu-pages-problemLink" style="display:none;" onclick="showPageProblemMultiple(-1)"><a href="javascript:void(0)">Problem</a></div>');
          $(".lab-menu-page-tied").attr("onclick", "showPageProblemMultipleMenu()");
        }
        break;
      }
    }
  }
}
var oldProblem = null;

function showPageProblem() {
  if ($('.lab-problem .content-problem').is(':visible')) {
    pageSlider.slide('.lab-problem .PageProblem', '.lab-problem .content-problem', true);
    oldProblem = CurrentProblem;
    if (typeof $('.PageProblem').attr('data-problemID') != 'undefined') {
      var i = parseInt($('.PageProblem').attr('data-problemID'), 10);
      CurrentProblem = G_lab.arrProblemList[i].Problem;
      MSlab.CurrentProblem = G_lab.arrProblemList[i].Problem;
    }
    $('.lab-frame').addClass('problem-page');
    $('.lab-menu-page-show').css('display', 'none');
  } else {
    pageSlider.slide('.lab-problem .content-problem', '.lab-problem .PageProblem', false);
    if (oldProblem) {
      CurrentProblem = oldProblem;
      MSlab.CurrentProblem = oldProblem;
      oldProblem = null;
    }
    $('.lab-frame').removeClass('problem-page');
    $('.lab-menu-page-show').css('display', 'inline-block');
  }
}

function showPageProblemMultipleMenu() {
  $('#multiplePages-menu').css('display', 'inline');
  $('#multiplePages-menu').show()
}

function showPageProblemMultiple(arrOrd) {
  $('#multiplePages-menu').css('display', '');
  $('#multiplePages-menu').hide();
  if (arrOrd < 0) {
    pageSlider.slide('.lab-problem .content-problem', '.lab-problem .PageProblem', true);
    CurrentProblem = oldProblem;
    MSlab.CurrentProblem = oldProblem;
    oldProblem = null;
    $('.submenu-pages-problemLink').hide();
    return;
  } else {
    oldProblem = CurrentProblem;
    CurrentProblem = G_lab.arrProblemList[arrOrd].Problem;
    MSlab.CurrentProblem = G_lab.arrProblemList[arrOrd].Problem;
  }
  $('.PageProblem').html(G_lab.arrProblemList[arrOrd].Problem.Problem);
  pageSlider.slide('.lab-problem .PageProblem', '.lab-problem .content-problem', false);
  $('.submenu-pages-problemLink').show();
}

function showBackShortAnswer() {
  var viewSelector = 'lessonShortAnswers-frame';
  $('#lessonShortAnswers-content-html').html('<iframe id="' + viewSelector + '" class="lab-box-sizing" src="about:blank" frameBorder="0"></iframe>');
  var priorFrame = document.getElementById(viewSelector).contentWindow;
  var priorCss = '<link rel="stylesheet" type="text/css" href="/MM/css/elements/MW/mw_editor.css" />';
  var priorHtml = '<!DOCTYPE html><html><head>' + priorCss + '</head><body></body></html>';
  priorFrame.document.open();
  priorFrame.document.write(priorHtml);
  priorFrame.document.write("");
  priorFrame.document.close();
  $('#' + viewSelector).contents().find('body').html(G_lab.LessonShortAnswers);
  dialog.open('lessonShortAnswers');
}

function __applyEventsToProblem() {
  __addFocusToProblem();
}

function __addFocusToProblem() {
  if ($(".problem-statement .focusable").length) {
    $(".problem-statement .focusable input").keypress(function(event) {
      var key = (event.which) ? event.which : event.keyCode;
      if (key != 37 && key != 38 && key != 39 && key != 40 && key != 8 && key != 46 && key != 9) {
        if ($(this).val().length >= 1 && !__isTextSelected(this)) return false;
      }
    });
    $(".problem-statement .focusable input").keyup(function(event) {
      var key = (event.which) ? event.which : event.keyCode;
      if (key != 37 && key != 38 && key != 39 && key != 40 && key != 8 && key != 46 && key != 9) {
        __moveProblemFocus(this);
      }
    });
    __moveProblemFocus(null);
  } else {
    $(document.querySelector(".problem-statement input, .problem-statement textarea, .problem-statement select")).blur().focus();
  }
  $('.lab-problem').scrollTop(0);
}

function __isTextSelected(input) {
  if (typeof input.selectionStart == "number") {
    return input.selectionStart == 0 && input.selectionEnd == input.value.length;
  } else if (typeof document.selection != "undefined") {
    input.focus();
    return document.selection.createRange().text == input.value;
  }
}

function __moveProblemFocus(elem) {
  var __focusedInputNr = 0;
  if (elem) {
    if ($(elem).parent().length) {
      var classList = $(elem).parent().attr("class").split(/\s+/);
      $.each(classList, function(index, item) {
        if (item.match(/focus-/)) {
          var focusArr = item.split(/-/);
          __focusedInputNr = focusArr[1];
        }
      });
    }
  }
  $focusableInput = false;
  var maxInputs = 30;
  $focusableInput = $(".problem-statement .focusable").filter(".focus-" + (__focusedInputNr - 1)).find("input");
  if (!$focusableInput.length) {
    $focusableInput = $(".problem-statement .focusable").filter(".focus-" + (__focusedInputNr - 2)).find("input");
  }
  if (!$focusableInput || $focusableInput.val() != "") $focusableInput = false;
  while (!$focusableInput && __focusedInputNr < maxInputs) {
    __focusedInputNr++;
    $focusableInput = $(".problem-statement .focusable").filter(".focus-" + __focusedInputNr).find("input");
    if (!$focusableInput.length || $focusableInput.val() != "") $focusableInput = false;
  }
  if ($focusableInput.length) {
    $focusableInput.blur().focus();
  }
}

function doGetCaretPosition(ctrl) {
  var CaretPos = 0;
  if (document.selection) {
    ctrl.focus();
    var Sel = document.selection.createRange();
    Sel.moveStart('character', -ctrl.value.length);
    CaretPos = Sel.text.length;
  } else if (ctrl.selectionStart || ctrl.selectionStart == '0')
    CaretPos = ctrl.selectionStart;
  return (CaretPos);
}

function setCaretPosition(ctrl, pos) {
  if (ctrl.setSelectionRange) {
    ctrl.focus();
    ctrl.setSelectionRange(pos, pos);
  } else if (ctrl.createTextRange) {
    var range = ctrl.createTextRange();
    range.collapse(true);
    range.moveEnd('character', pos);
    range.moveStart('character', pos);
    range.select();
  }
}

function display_controls() {
  if (G_lab.showNext)
    $(".next-button").show();
  else
    $(".next-button").hide();
  if (G_lab.showProgressBar)
    $(".lab-stars").show();
  else
    $(".lab-stars").hide();
}

function closeCleanScratchPad() {
  $("#scratchpad-wrapper").hide();
  $("#scratchtoolbox").hide();
  if (window.pad)
    pad.clear();
}

function doNext(e) {
  var event = e || window.event;
  try {
    if (!__get_query_string('isTocPreview', false) && typeof event !== 'undefined' && (event.target || event.srcElement)) {
      this.loadAllProblemsSound();
    }
  } catch (ignored) {}
  if (MSlab && MSlab.stopSound) {
    MSlab.stopSound();
  }
  if (PracticeLab.Pause) {
    hidePause();
    return;
  }
  if (typeof BLLab !== 'undefined') {
    BLLab.next();
    return
  }
  if (NextDisabled) return;
  disableNext();
  setTimeout(enableNext, 800);
  $(".next-button").btOff();
  MSlab.stopSound();
  if (isFirstNextAction && !(G_lab.Mode == 'Practice' || G_lab.Mode == 'Review')) {
    isFirstNextAction = false;
    setTimeout(function() {
      doNextRun();
    }, 1500);
  } else {
    isFirstNextAction = false;
    doNextRun();
  }
}

function doNextRun() {
  if (G_lab.Mode == 'PM') {
    if (!jsVars.assessmentsApiConfig.zaCounterpart || G_lab.fkZATestID == -1) {
      subNewPMEvaluateProblem();
      return;
    }
  } else if (G_lab.Mode == 'Practice' || G_lab.Mode == 'Review') {
    subPracticeEvaluateProblem();
  } else if (G_lab.Mode == 'Instruction') {
    if (G_TeachMeStep == 1) {
      subInstructionEvaluateProblem();
    } else {
      subInstructionSelectProblem();
    }
  } else if (G_lab.Mode == 'QAPreview') {
    __qa_preview_do_next();
  }
  $("input, textarea, select").blur();
}

function isAnswerEntered() {
  if (MSlab.userInteract.isAnswerEntered() == false) {
    if (G_lab.Mode != 'PM') {
      MSlab.userInteract.showEnterAnswer();
    } else {
      if (confirm("Are you sure you wish to leave the answer blank?")) {
        return true;
      }
    }
    __addFocusToProblem();
    return false;
  }
  return true;
}

function subParseAnswer() {
  if (typeof CurrentProblem == 'undefined') return -1;
  Answer = MSlab.userInteract.parseAnswer();
  return MSlab.userInteract.isAnswerCorrect();
}
$.fn.cycle = function(timeout) {
  var $all_elem = $(this)
  show_cycle_elem = function(index) {
    if (index == $all_elem.length) return;
    $all_elem.hide().eq(index).fadeIn()
    setTimeout(function() {
      show_cycle_elem(++index)
    }, timeout);
  }
  show_cycle_elem(0);
}

function roundNumber(num, dec) {
  var result = Math.round(num * Math.pow(10, dec)) / Math.pow(10, dec);
  return result;
}

function sign_out(url) {
  if (!url.includes('logout')) {
    $(document).triggerHandler('pageRedirected');
  }
  $('#loading').show();
  $('.lab-menu-item').prop("onclick", null).off("click");
  MSlab.responsiveVoice.stop();
  if (typeof(LiveMessage.presence) !== "undefined" && LiveMessage.presence && typeof(LiveMessage.presence.data.teacher_ids) !== "undefined") {
    LiveMessage.close();
  }
  if (typeof G_lab == 'undefined') {
    MSlab.redirect(url, false);
    return;
  }
  if (G_lab.Mode == 'QAPreview') {
    window.close();
    return;
  }
  if (G_lab.Mode == "PM" && (typeof G_lab.MaxPublishedGrade === 'undefined' || G_lab.MaxPublishedGrade < 0)) {
    if (!jsVars.assessmentsApiConfig.zaCounterpart || G_lab.fkZATestID == -1) {
      __subUpdateArrListAndSignOut(url);
      return;
    }
    MSlab.redirect(url, false);
  } else if (G_lab.Mode == "Practice") {
    __updatePracticeProblemListSignOut(url);
  } else {
    MSlab.redirect(url, false);
  }
}

function hideStartNew() {
  $('.Overlay1').hide();
  $("#start-fact").hide();
}

function hideFactAnimation() {
  $('.Overlay1').hide();
  $("#FactAnimation").hide();
  $("#start-fact").hide();
}

function hideTakeSprint() {
  enableNext();
  $('.Overlay1').hide();
  $("#TakeSprint").hide();
  $("#start-fact").hide();
}

function showPause() {
  pauseLab();
  if ($('#lab-pause').length <= 0)
    $('body').append('<div id="lab-pause"><div class="overlay"></div><img src="https://data.mobymax.com/lab/lab/Pause.png" width="182" height="182" onclick="doNext();"/></div>');
  $('#lab-pause').show();
}

function hidePause() {
  resumeLab();
  $('#lab-pause').hide();
}

function pauseLab() {
  $(document).trigger('pause.MSLab');
  if (G_lab && (G_lab.Mode == 'Practice' || G_lab.Mode == 'PM')) {
    PracticeLab.pause();
    $(document).trigger('pause.MSLab');
    return;
  }
}

function resumeLab() {
  $(document).trigger('resume.MSLab');
  if (G_lab && (G_lab.Mode == 'Practice' || G_lab.Mode == 'PM')) {
    PracticeLab.resume();
    $(document).trigger('resume.MSLab');
    return;
  }
}

function showMyStuff() {
  SoundStatus = G_SoundStatus;
  if (!jsVars.hiddenReadAloudSettingsModule) {
    if (G_lab.StudentSetting.StudentSetting.IsReadAloudTeacher != 1) {
      SoundStatus = 2;
    } else if (G_lab.StudentSetting.StudentSetting.IsReadAloudStudent == 0) {
      SoundStatus = 3;
    }
  } else if (jsVars.hiddenPollySettingsModule && jsVars.hiddenReadAloudSettingsModule) {
    SoundStatus = 9;
  } else if (parseInt(jsVars.isVoiceSelectable, 10) === 0 && parseInt(jsVars.isSpeechHighlightSelectable, 10) === 0) {
    SoundStatus = 8;
  }
  switch (SoundStatus) {
    case 1:
      $(".sound-diagnostic-fieldset").hide();
      break;
    case 2:
      $(".sound-diagnostic-fieldset").show();
      $(".sound-diagnostic-text").html("Your teacher has turned off sound in the teacher's module.");
      $('.sound-setting-fieldset').attr('disabled', 'disabled');
      $('.voice-section').hide();
      $('.word-highlighting-section').hide();
      $('#sound-settings-content-html .save-button').hide();
      break;
    case 3:
      $(".sound-diagnostic-fieldset").show();
      $(".sound-diagnostic-text").html("You have turned off your sound in the setting above.");
      break;
    case 4:
      $(".sound-diagnostic-fieldset").show();
      $(".sound-diagnostic-text").html("To hear the read aloud sound, you need to either install <a href='http://get.adobe.com/flashplayer/'>Adobe Flash</a> or use Microsoft Internet Explorer 9.0 or Google Chrome as your browser.");
      break;
    case 5:
      $(".sound-diagnostic-fieldset").show();
      $(".sound-diagnostic-text").html("A newer version of Adobe Flash is required. To hear the read aloud sound, you need to either download Adobe Flash or use Microsoft Internet Explorer 9.0 or Google Chrome as your browser.");
      break;
    case 6:
      $(".sound-diagnostic-fieldset").show();
      $(".sound-diagnostic-text").html("The sound files could not be downloaded. Please have your IT department contact us to allow you to receive our sound files.");
      break;
    case 7:
      $(".sound-diagnostic-fieldset").show();
      $(".sound-diagnostic-text").html("Sound Manager was unable to be downloaded. Please have your IT department contact us.");
      break;
    case 8:
      $(".sound-diagnostic-fieldset").show();
      $(".sound-diagnostic-text").html("Teacher has disabled voice settings in the teacher's module.");
      $('#sound-settings-content-html .save-button').hide();
      break;
    case 9:
      $(".sound-diagnostic-fieldset").show();
      $(".sound-diagnostic-text").html("Your sound settings are correct.");
      $('#sound-settings-content-html .save-button').hide();
      break;
    default:
      $(".sound-diagnostic-fieldset").hide();
      break;
  }
}

function hideMyStuff() {
  $('.Overlay1').hide();
  $("#my-stuff-div").hide();
}

function __showTakeSprint() {
  window.location = "/MM/SI/sign_in/logout";
  return;
}

function closeSoundSettingsDialog() {
  if (MSlab && MSlab.stopSounds && soundSettings.soundIsPlaying) {
    MSlab.stopSounds();
    soundSettings.soundIsPlaying = false;
  }
  resumeLab();
  dialog.close('sound-settings');
}

function set_sound_settings() {
  var requestParams = {
    fkINStudentID: G_lab.Student.Student.pkINStudentID,
  };
  var readAloudSetting = $('select[name=SSIsReadAloudStudent]').val();
  requestParams['isReadAloudStudent'] = readAloudSetting;
  var isSpeechHighlight = null;
  var voiceSpeed = null;
  var voiceName = null;
  if ($('input[name=speech-highlight]').length > 0) {
    var isSpeechHighlight = $('input[name=speech-highlight]').prop('checked');
    requestParams['isSpeechHighlight'] = Number(isSpeechHighlight);
  }
  if ($('input[name=voice-speed]').length > 0) {
    var voiceSpeed = $('input[name=voice-speed]:checked').val();
    requestParams['voiceSpeed'] = voiceSpeed;
  }
  if ($('div.voice').length > 0) {
    var voiceName = $('div.voice.selected').attr('data-id');
    requestParams['voiceName'] = voiceName;
  }
  G_SoundSetting = readAloudSetting;
  G_lab.StudentSetting.StudentSetting.IsReadAloudStudent = readAloudSetting;
  if (voiceName && voiceSpeed) {
    MSlab.responsiveVoice.setVoiceValues(voiceName, voiceSpeed, this.MSlab.initedSounds);
  }
  jsVars.isSpeechHighlight = isSpeechHighlight;
  $.getJSON(mmapp.sbjUrl('home/set_student_sound_settings'), requestParams, null);
  showMyStuff();
  if (MSlab && MSlab.stopSounds) {
    MSlab.stopSounds();
    soundSettings.soundIsPlaying = false;
  }
  resumeLab();
  dialog.close('sound-settings');
}

function play(id) {
  if (!soundManager.supported()) {
    console.error('SoundManager not supported', id);
    return;
  }
  if (soundManagerLoaded.state() !== 'resolved') {
    soundManagerLoaded.done(function() {
      play(id)
    });
    return;
  }
  soundManager.pauseAll();
  MSlab.stopSounds();
  if (id && typeof id !== 'undefined' && id.substring(id.length - 3).toLowerCase() == 'tts') {
    playTTS(id);
    return;
  }
  if (enablePlay == false) {
    setTimeout(function() {
      play(id);
    }, 100);
    return;
  }
  if (soundManager.supported()) {
    if (id.indexOf('empty.mp3') > 0) {
      soundManager.destroySound('aSound');
      var mySound = soundManager.createSound({
        id: 'aSound',
        url: (id.indexOf('/') > 0 && id.indexOf('.mp3') > 0) ? id : MSlab.getSoundFilename(CurrentProblem.pkMLProblemID, id),
        onload: function(bSuccess) {
          if (!bSuccess)
            G_SoundStatus = 6;
          else
            G_SoundStatus = 1;
        }
      });
      mySound.play();
      return;
    }
    if (id && typeof id !== 'undefined') {
      if (MSlab.isInitedSound(id) && typeof MSlab.isInitedSound(id) !== 'undefined') {
        sUrl = id;
      } else if (CurrentProblem && CurrentProblem.pkMLProblemID && MSlab.isInitedSound(id + '-' + CurrentProblem.pkMLProblemID) && typeof MSlab.isInitedSound(id + '-' + CurrentProblem.pkMLProblemID) !== 'undefined') {
        sUrl = id + '-' + CurrentProblem.pkMLProblemID;
      } else {
        var sUrl = (id.indexOf('/') > 0 && id.indexOf('.mp3') > 0) ? id : MSlab.getSoundFilename(CurrentProblem.pkMLProblemID, id);
        if (!MSlab.isInitedSound(sUrl) || typeof MSlab.isInitedSound(sUrl) === 'undefined') {
          MSlab.initSound(sUrl, sUrl);
        }
      }
      setTimeout(function() {
        MSlab.playInitedSound(sUrl, true);
      }, 1000);
    }
  } else {
    labProblem.hidePlayIcons();
  }
}

function preloadSound(id) {
  return MSlab.preloadSound(CurrentProblem.pkMLProblemID, id);
}

function playFile(file) {
  play(file);
}

function resizeLab() {}

function disableNext() {
  NextDisabled = true
}

function enableNext() {
  NextDisabled = false
}

function labBackgroundAndTitle() {
  var isInitialPMTest = false;
  $(".scratch-pad-link").hide();
  if (G_lab.StudentPMCurrent) {
    if (G_lab.StudentPMCurrent.StudentPMCurrent) {
      if (G_lab.StudentPMCurrent.StudentPMCurrent.FirstPlaceTest == 1) isInitialPMTest = true;
    }
  }
  var mode = 'practice';
  labTitle = mmapp.module.subject.capitalize();
  if (G_lab.Mode == 'Practice') {
    if (mmapp.module.name == 'MM') $(".scratch-pad-link").show();
  } else
  if (G_lab.Mode == 'Review') {
    mode = 'review';
    labTitle = mmapp.module.subject.capitalize() + ' Review';
  } else
  if (G_lab.Mode == 'PM') {
    mode = 'placement';
    if (G_lab.subject != 'RL' && G_lab.subject != 'RI') {
      labTitle = mmapp.module.subject.capitalize();
    }
  } else if (G_lab.Mode == "QAPreview") {
    mode = 'preview';
    labTitle = mmapp.module.subject.capitalize() + ' Preview';
  }
  labTitle = labTitle.replace('And', 'and');
  $('.lab-frame').attr('class', 'lab-frame mode-' + mode);
  $('.lab-frame .lab-title').html(labTitle);
  $('.lab-submenu').attr('class', 'lab-submenu mode-' + mode);
  $(document).trigger('labBackgroundAndTitle.MSLab', labTitle);
}

function addNoCache(data) {
  return data.replace(/(img src=['"][^'"]+)/gi, "$1?" + Math.random());
}

function showProblemHtml(problemID, problemHtml, problemVoiceFile, title, problemType) {
  if (title == "Hint") $('#see-previous-link').hide();
  if (!problemID) return;
  MSlab.stopSounds();
  $('#problem-div .standard-dialog-blue-title').html(title);
  MSlab.teachMeDialogVisible = true;
  if (problemHtml != '') {
    $('.Overlay1').show();
    $('#problem-div .problem-statement-d').css("visibility", "hidden");
    if (problemHtml.indexOf('data:image') != -1)
      var data = addNoCache(problemHtml);
    else
      var data = problemHtml;
    $('#problem-div .problem-statement-d').html(data);
    $('#problem-div').show();
    MSlab.autoResizeTeachMeDialog();
    if ((G_SoundSetting > 0) && (problemType != 'SS' && problemVoiceFile.length > 0)) {
      playFile(problemVoiceFile);
    } else if ($('#problem-div .problem-statement-d iframe.mobyPlayer').length > 0) {
      if ($('.lab-problem iframe.mobyPlayer').length != 0) {
        $('.lab-problem iframe.mobyPlayer').mobyVideo('sendMessage', {
          'mediaelement.pause': true
        });
      }
      $('#problem-div .problem-statement-d iframe.mobyPlayer').load(function() {
        $('#problem-div .problem-statement-d iframe.mobyPlayer').mobyVideo({
          'onInitSuccess': function() {
            $('#problem-div .problem-statement-d iframe.mobyPlayer').mobyVideo('sendMessage', {
              'mediaelement.play': true
            });
          }
        });
      });
    }
  } else {
    $('#loading').show();
    $('.Overlay1').show();
    $.get(mmapp.sbjUrl('home/getProblemHtml/' + problemID + '?' + Math.random()), function(data) {
      if (problemType == 'SS') {
        ssImage = data.match(/(<img src=['|"][^>]+ProblemImg\.gif)[^'"]*([^>]+>)/);
        if (ssImage) {
          if (ssImage.length > 1)
            data = ssImage[1] + ssImage[2];
        }
      }
      data = addNoCache(data);
      $('#problem-div .problem-statement-d').html(data);
      $('#problem-div .problem-statement-d').css("visibility", "hidden");
      if ((G_SoundSetting > 0) && (problemType != 'SS')) {
        $.get(mmapp.sbjUrl('home/getProblemVoiceFile/' + problemID), function(data) {
          $('#loading').hide();
          $('#problem-div').show();
          MSlab.autoResizeTeachMeDialog();
          if (data.length > 0) {
            playFile(data);
          }
        }, 'html');
      } else {
        $('#loading').hide();
        $('#problem-div').show();
        MSlab.autoResizeTeachMeDialog();
      }
      if ($('#problem-div .problem-statement-d iframe.mobyPlayer').length > 0) {
        if ($('.lab-problem iframe.mobyPlayer').length != 0) {
          $('.lab-problem iframe.mobyPlayer').mobyVideo('sendMessage', {
            'mediaelement.pause': true
          });
        }
        $('#problem-div .problem-statement-d iframe.mobyPlayer').load(function() {
          $('#problem-div .problem-statement-d iframe.mobyPlayer').mobyVideo({
            'onInitSuccess': function() {
              $('#problem-div .problem-statement-d iframe.mobyPlayer').mobyVideo('sendMessage', {
                'mediaelement.play': true
              });
            }
          });
        });
      }
    }, 'html');
  }
}

function refreshTMimg() {
  var d = new Date();
  var n = d.getTime();
  $('.problem-statement-d img').each(function() {
    $(this).attr("src", $(this).attr("src").indexOf('?') < 0 ? $(this).attr("src") + '?v=' + n : $(this).attr("src") + '&v=' + n);
  });
}

function getTeachMeID() {
  TeachMeID = new Array();
  TeachMeVoiceFile = new Array();
  TeachMeHtml = new Array();
  $('#teachMe-menu').html('');
  $('.lab-menu-tm').hide();
  $('.lab-menu-multi-tm').hide();
  var _this = this;
  for (var tm in G_lab.teachMEs) {
    if (!G_lab.teachMEs.hasOwnProperty(tm)) continue;
    if (typeof(G_lab.teachMEs[tm].Problem) != 'undefined' && G_lab.teachMEs[tm].Problem != null) {
      TeachMeID.push(G_lab.teachMEs[tm].Problem.pkMLProblemID);
      TeachMeVoiceFile.push(G_lab.teachMEs[tm].Problem.VoiceFile);
      TeachMeHtml.push(G_lab.teachMEs[tm].Problem.Problem);
    }
  }
  if (TeachMeID.length == 0) {
    for (var i = 0; i < G_lab.LessonStrands.length; i++) {
      if (G_lab.LessonStrands[i].Strand.pkMLStrandID == G_lab.Strand) {
        if ($.inArray(G_lab.LessonStrands[i].Strand.rkTeachMeID, TeachMeID < 0)) {
          if (G_lab.LessonStrands[i].Strand.rkTeachMeID != null && G_lab.rkProblemHtml.html != null) {
            TeachMeID.push(G_lab.LessonStrands[i].Strand.rkTeachMeID);
            TeachMeHtml.push(G_lab.rkProblemHtml.html);
            TeachMeVoiceFile.push(G_lab.rkProblemHtml.voice);
          }
        }
      }
    }
  }
  if (TeachMeID.length > 0 && TeachMeID[0] != null) {
    if (TeachMeID.length == 1) {
      $('.lab-menu-tm').css('display', 'inline-block');
    } else {
      for (var i = 0; i < TeachMeID.length; i++) {
        displayTutorialValue = i + 1;
        $('#teachMe-menu').append('<div class="lab-submenu-item" onclick="showProblemHtml(TeachMeID[' + i + '], TeachMeHtml[' + i + '], TeachMeVoiceFile[' + i + '], \'Tutorial ' + displayTutorialValue + '\', \'TM\');refreshTMimg(); return false;"><a href="javascript:void(0);">Tutorial ' + displayTutorialValue + '</a></div>');
      }
      $('.lab-menu-multi-tm').css('display', 'inline-block');
    }
  }
}

function getPreviousStrands() {
  $('#see-previous-links-content').html("");
  if (typeof(G_lab.seePrevious) == 'undefined' || G_lab.seePrevious == null || G_lab.seePrevious.length < 1) {
    $('#see-previous-link').hide();
    return;
  }
  var strandClasses = new Array();
  for (var i = 0; i < G_lab.seePrevious.length; i++) {
    strandClassName = 'strand' + G_lab.seePrevious[i].MLStrand.pkMLStrandID;
    if ($.inArray(strandClassName, strandClasses) < 0) {
      strandClasses.push(strandClassName);
    }
    $('#see-previous-links-content').prepend("<span onclick=\"showProblemHtml(G_lab.seePrevious[" + i + "].Problem.pkMLProblemID, G_lab.seePrevious[" + i + "].Problem.ProblemHtml, G_lab.seePrevious[" + i + "].Problem.VoiceFile,     \'Tutorial \', \'TM\');refreshTMimg();\" class='" + strandClassName + "'>" + G_lab.seePrevious[i].MLStrand.Title + "</span><div class='clear-both'></div>");
  }
  for (i = 0; i < strandClasses.length; i++) {
    displayOrder = 1;
    if ($('.' + strandClasses[i]).length > 1) {
      $('.' + strandClasses[i]).each(function() {
        $(this).html($(this).html() + " " + displayOrder);
        displayOrder++;
      });
    }
  }
}

function getSimpleSuccessID() {
  SimpleSuccessID = 0;
  SimpleSuccessHtml = '';
  for (var i = G_lab.arrProblemList.size; i > 0; i--) {
    if ((G_lab.arrProblemList[i - 1].Problem.TypeNew) == 'Simple Success') {
      SimpleSuccessID = G_lab.arrProblemList[i - 1].Problem.pkMLProblemID;
      var ssImage = G_lab.arrProblemList[i - 1].Problem.Problem.match(/(<img src="[^>]+(ProblemImg\.gif){1}[^>]+>)/);
      if (ssImage) {
        if (ssImage.length > 1)
          SimpleSuccessHtml = ssImage[1];
      }
      break;
    }
  }
  if (SimpleSuccessID == 0) {
    for (var i = 0; i < G_lab.LessonStrands.length; i++) {
      if (G_lab.LessonStrands[i].Strand.pkMLStrandID == G_lab.Strand) {
        SimpleSuccessID = G_lab.LessonStrands[i].Strand.rkSimpleSuccessID;
        break;
      }
    }
  }
  if (SimpleSuccessID > 0) $('.lab-submenu-hint').show();
  else $('.lab-submenu-hint').hide();
}

function closeProblemDialog() {
  soundManager.destroySound('aSound');
  soundManager.pauseAll();
  if (MSlab && MSlab.pauseInitedSound) {
    MSlab.pauseInitedSound();
  }
  $('#problem-div .problem-statement-d').html('');
  $('#problem-div').hide();
  $('.Overlay1').hide();
  MSlab.teachMeDialogVisible = false;
}
var TMCloseTimer = 0;
var SeePreviousCloseTimer = 0;

function __init_lab_qa_preview() {
  CurrentProblem = G_lab.QAProblem.Problem;
  if (!__get_query_string('isTocPreview', false)) {
    if (MSlab.soundManagerLoaded.state() !== 'resolved') {
      MSlab.soundManagerLoaded.done(function() {
        loadAllProblemsSound();
      });
    } else {
      loadAllProblemsSound();
    }
  }
  $(".next-button").show();
  $('.lab-menu img').hide();
  $('.lab-menu .lab-menu-signout').css('display', 'inline-block');
  QAPreviewStep = 0;
  if (typeof G_lab.QAProblem.arrProblemList != "undefined") {
    G_lab.arrProblemList = G_lab.QAProblem.arrProblemList;
  } else {
    G_lab.arrProblemList = {
      0: {
        Problem: CurrentProblem
      },
      size: 1
    };
  }
  MSlab.userInteract = new Interact('.lab-problem', CurrentProblem, MSlab);
  CurrentProblem.autoplaySound = true;
  if (MSlab.userInteract.problemHasFeedback()) {
    var willShowFeedback = !(__get_query_string('nofeedback', false) || !!__get_query_string('isTocPreview', false));
    var oldSoundSetting = G_SoundSetting;
    if (willShowFeedback) {
      G_SoundSetting = 1;
      CurrentProblem.autoplaySound = false;
      __displayCurrentProblem();
      MSlab.showProblemFeedback();
      MSlab.userInteract.resetAnswer();
      if (typeof jsVars.studentAnswer != 'undefined') {
        MSlab.userInteract.showAnswer(jsVars.studentAnswer);
      }
      G_SoundSetting = oldSoundSetting;
    } else {
      __displayCurrentProblem();
      QAPreviewStep++;
    }
  } else {
    __displayCurrentProblem();
    QAPreviewStep = (MSlab.userInteract.needEvaluation()) ? 1 : 0;
  }
  if (__get_query_string('isTocPreview', false)) {
    $(".problem-statement input").prop('disabled', true);
  }
}

function __qa_preview_do_next() {
  CurrentProblem = G_lab.QAProblem.Problem;
  if (!__get_query_string('isTocPreview', false)) {
    if (MSlab.soundManagerLoaded.state() !== 'resolved') {
      MSlab.soundManagerLoaded.done(function() {
        loadAllProblemsSound();
      });
    } else {
      loadAllProblemsSound();
    }
  }
  if (MSlab.userInteract.needEvaluation()) {
    if (QAPreviewStep == 0) {
      QAPreviewStep++;
      __hideall();
      CurrentProblem.autoplaySound = true;
      __displayCurrentProblem();
    } else {
      if (!isAnswerEntered()) return;
      QAPreviewStep = 0;
      showFeedback = true;
      if (__get_query_string('nofeedback', false) && mmapp.module.name != 'SC' && mmapp.module.name != 'FR' && mmapp.module.name != 'SS' && mmapp.module.name != 'GP') showFeedback = false;
      if (MSlab.userInteract.needEvaluation() && showFeedback) {
        CurrentProblemIsCorrect = subParseAnswer();
        if (CurrentProblemIsCorrect) {
          MSlab.showCorrect();
        } else {
          if (MSlab.userInteract.selfEvaluate() || MSlab.userInteract.evaluateCorrect) {
            MSlab.showCorrect();
          } else {
            MSlab.showIncorrect();
          }
        }
      }
      if (MSlab.userInteract.problemHasFeedback() && showFeedback)
        MSlab.showProblemFeedback();
      else __qa_preview_do_next();
    }
  } else {
    if (QAPreviewStep == 0) {
      QAPreviewStep++;
      __hideall();
      CurrentProblem.autoplaySound = true;
      __displayCurrentProblem();
    } else {
      QAPreviewStep = 0;
      if (MSlab.userInteract.problemHasFeedback())
        MSlab.showProblemFeedback();
      else __qa_preview_do_next();
    }
  }
}

function __adjustImages() {
  img_retries = new Array();
  img_logged = new Array();
  $(".problem-statement img").each(function() {
    if ($(this).attr("src") == "/MM/img/play.gif" || $(this).attr("src").indexOf("/MM/img/") != -1)
      return;
    img_logged[$(".problem-statement").index($(this))] = 0;
    $(this).error(function() {
      __retry_fetch_image($(this));
    });
  });
}

function __retry_fetch_image(img_obj) {
  img_obj.unbind("error");
  src = img_obj.attr("src");
  if (src.indexOf("?") != -1)
    src = src.substr(0, src.indexOf("?")) + "?" + Math.floor((Math.random() * 999) + 1);
  else
    src = src + "?" + Math.floor((Math.random() * 999) + 1);
  img_obj.wrap('<a href="#" onclick="__fetch_image(this); return false;" class="fetch_image_href"></a>');
  img_obj.attr("src", src);
  img_obj.attr("alt", "Click here to fetch image");
}

function __fetch_image(a_obj) {
  img_element = $(a_obj).children("img:first");
  src = img_element.attr("src");
  if (src.indexOf("?") != -1)
    src = src.substr(0, src.indexOf("?")) + "?" + Math.floor((Math.random() * 999) + 1);
  else
    src = src + "?" + Math.floor((Math.random() * 999) + 1);
  img_element.attr("src", src);
  if (img_logged[$(".problem-statement").index(img_element)] == 0) {
    img_logged[$(".problem-statement").index(img_element)] = 1;
    logJsError("fetch image" + src);
  }
}

function __get_query_string(key, default_) {
  if (default_ == null) default_ = "";
  key = key.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
  var regex = new RegExp("[\\?&]" + key + "=([^&#]*)");
  var qs = regex.exec(window.location.href);
  if (qs == null)
    return default_;
  else
    return qs[1];
}
String.prototype.capitalize = function() {
  return this.replace(/(?:^|\s)\S/g, function(a) {
    return a.toUpperCase();
  });
};
if (!('format' in String.prototype)) {
  String.prototype.format = function() {
    var string = this;
    for (var i = 0; i < arguments.length; i++) {
      var regexp = new RegExp('\\{' + i + '\\}', 'gi');
      string = string.replace(regexp, arguments[i]);
    }
    return string;
  };
}
window.addEventListener("DOMContentLoaded", (event) => {
  var allowedDomains = ["mobymax.com", "testmoby.com", "ably.io", "devmoby.com"]
  var getDomain = function(string) {
    var parts = string.split('.');
    return parts[parts.length - 2].toLowerCase() + '.' + parts[parts.length - 1].toLowerCase();
  };
  var proxiedOpen = window.XMLHttpRequest.prototype.open;
  window.XMLHttpRequest.prototype.open = function() {
    var theUrl = new URL(arguments[1]);
    var domain = getDomain(theUrl.hostname);
    if (allowedDomains.indexOf(domain) > -1) {
      proxiedOpen.apply(this, [].slice.call(arguments));
    }
  };
  var proxiedFetch = window.fetch;
  window.fetch = async (...args) => {
    let [resource, config] = args;
    var theUrl = new URL(resource);
    var domain = getDomain(theUrl.hostname);
    if (allowedDomains.indexOf(domain) > -1) {
      return await proxiedFetch(resource, config);
    }
    return Promise.reject("Not allowed");
  };
  var proxiedSetElement = Element.prototype.setAttribute;
  Element.prototype.setAttribute = function(name, value) {
    if (this.nodeName.toLowerCase() == 'script') {
      if (name.toLowerCase() == 'src') {
        var theUrl = new URL(value);
        var domain = getDomain(theUrl.hostname);
        if (allowedDomains.indexOf(domain) === -1) {
          return undefined;
        }
      }
    }
    return proxiedSetElement.apply(this, [].slice.call(arguments));
  };
});
/*!
 * Raphael 1.5.2 - JavaScript Vector Library
 *
 * Copyright (c) 2010 Dmitry Baranovskiy (http://raphaeljs.com)
 * Licensed under the MIT (http://raphaeljs.com/license.html) license.
 */
(function() {
  function R() {
    if (R.is(arguments[0], array)) {
      var a = arguments[0],
        cnv = create[apply](R, a.splice(0, 3 + R.is(a[0], nu))),
        res = cnv.set();
      for (var i = 0, ii = a[length]; i < ii; i++) {
        var j = a[i] || {};
        elements[has](j.type) && res[push](cnv[j.type]().attr(j));
      }
      return res;
    }
    return create[apply](R, arguments);
  }
  R.version = "1.5.2";
  var separator = /[, ]+/,
    elements = {
      circle: 1,
      rect: 1,
      path: 1,
      ellipse: 1,
      text: 1,
      image: 1
    },
    formatrg = /\{(\d+)\}/g,
    proto = "prototype",
    has = "hasOwnProperty",
    doc = document,
    win = window,
    oldRaphael = {
      was: Object[proto][has].call(win, "Raphael"),
      is: win.Raphael
    },
    Paper = function() {
      this.customAttributes = {};
    },
    paperproto, appendChild = "appendChild",
    apply = "apply",
    concat = "concat",
    supportsTouch = "createTouch" in doc,
    E = "",
    S = " ",
    Str = String,
    split = "split",
    events = "click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend orientationchange touchcancel gesturestart gesturechange gestureend" [split](S),
    touchMap = {
      mousedown: "touchstart",
      mousemove: "touchmove",
      mouseup: "touchend"
    },
    join = "join",
    length = "length",
    lowerCase = Str[proto].toLowerCase,
    math = Math,
    mmax = math.max,
    mmin = math.min,
    abs = math.abs,
    pow = math.pow,
    PI = math.PI,
    nu = "number",
    string = "string",
    array = "array",
    toString = "toString",
    fillString = "fill",
    objectToString = Object[proto][toString],
    paper = {},
    push = "push",
    ISURL = /^url\(['"]?([^\)]+?)['"]?\)$/i,
    colourRegExp = /^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i,
    isnan = {
      "NaN": 1,
      "Infinity": 1,
      "-Infinity": 1
    },
    bezierrg = /^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,
    round = math.round,
    setAttribute = "setAttribute",
    toFloat = parseFloat,
    toInt = parseInt,
    ms = " progid:DXImageTransform.Microsoft",
    upperCase = Str[proto].toUpperCase,
    availableAttrs = {
      blur: 0,
      "clip-rect": "0 0 1e9 1e9",
      cursor: "default",
      cx: 0,
      cy: 0,
      fill: "#fff",
      "fill-opacity": 1,
      font: '10px "Arial"',
      "font-family": '"Arial"',
      "font-size": "10",
      "font-style": "normal",
      "font-weight": 400,
      gradient: 0,
      height: 0,
      href: "http://raphaeljs.com/",
      opacity: 1,
      path: "M0,0",
      r: 0,
      rotation: 0,
      rx: 0,
      ry: 0,
      scale: "1 1",
      src: "",
      stroke: "#000",
      "stroke-dasharray": "",
      "stroke-linecap": "butt",
      "stroke-linejoin": "butt",
      "stroke-miterlimit": 0,
      "stroke-opacity": 1,
      "stroke-width": 1,
      target: "_blank",
      "text-anchor": "middle",
      title: "Raphael",
      translation: "0 0",
      width: 0,
      x: 0,
      y: 0
    },
    availableAnimAttrs = {
      along: "along",
      blur: nu,
      "clip-rect": "csv",
      cx: nu,
      cy: nu,
      fill: "colour",
      "fill-opacity": nu,
      "font-size": nu,
      height: nu,
      opacity: nu,
      path: "path",
      r: nu,
      rotation: "csv",
      rx: nu,
      ry: nu,
      scale: "csv",
      stroke: "colour",
      "stroke-opacity": nu,
      "stroke-width": nu,
      translation: "csv",
      width: nu,
      x: nu,
      y: nu
    },
    rp = "replace",
    animKeyFrames = /^(from|to|\d+%?)$/,
    commaSpaces = /\s*,\s*/,
    hsrg = {
      hs: 1,
      rg: 1
    },
    p2s = /,?([achlmqrstvxz]),?/gi,
    pathCommand = /([achlmqstvz])[\s,]*((-?\d*\.?\d*(?:e[-+]?\d+)?\s*,?\s*)+)/ig,
    pathValues = /(-?\d*\.?\d*(?:e[-+]?\d+)?)\s*,?\s*/ig,
    radial_gradient = /^r(?:\(([^,]+?)\s*,\s*([^\)]+?)\))?/,
    sortByKey = function(a, b) {
      return a.key - b.key;
    };
  R.type = (win.SVGAngle || doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure", "1.1") ? "SVG" : "VML");
  if (R.type == "VML") {
    var d = doc.createElement("div"),
      b;
    d.innerHTML = '<v:shape adj="1"/>';
    b = d.firstChild;
    b.style.behavior = "url(#default#VML)";
    if (!(b && typeof b.adj == "object")) {
      return R.type = null;
    }
    d = null;
  }
  R.svg = !(R.vml = R.type == "VML");
  Paper[proto] = R[proto];
  paperproto = Paper[proto];
  R._id = 0;
  R._oid = 0;
  R.fn = {};
  R.is = function(o, type) {
    type = lowerCase.call(type);
    if (type == "finite") {
      return !isnan[has](+o);
    }
    return (type == "null" && o === null) || (type == typeof o) || (type == "object" && o === Object(o)) || (type == "array" && Array.isArray && Array.isArray(o)) || objectToString.call(o).slice(8, -1).toLowerCase() == type;
  };
  R.angle = function(x1, y1, x2, y2, x3, y3) {
    if (x3 == null) {
      var x = x1 - x2,
        y = y1 - y2;
      if (!x && !y) {
        return 0;
      }
      return ((x < 0) * 180 + math.atan(-y / -x) * 180 / PI + 360) % 360;
    } else {
      return R.angle(x1, y1, x3, y3) - R.angle(x2, y2, x3, y3);
    }
  };
  R.rad = function(deg) {
    return deg % 360 * PI / 180;
  };
  R.deg = function(rad) {
    return rad * 180 / PI % 360;
  };
  R.snapTo = function(values, value, tolerance) {
    tolerance = R.is(tolerance, "finite") ? tolerance : 10;
    if (R.is(values, array)) {
      var i = values.length;
      while (i--)
        if (abs(values[i] - value) <= tolerance) {
          return values[i];
        }
    } else {
      values = +values;
      var rem = value % values;
      if (rem < tolerance) {
        return value - rem;
      }
      if (rem > values - tolerance) {
        return value - rem + values;
      }
    }
    return value;
  };

  function createUUID() {
    var s = [],
      i = 0;
    for (; i < 32; i++) {
      s[i] = (~~(math.random() * 16))[toString](16);
    }
    s[12] = 4;
    s[16] = ((s[16] & 3) | 8)[toString](16);
    return "r-" + s[join]("");
  }
  R.setWindow = function(newwin) {
    win = newwin;
    doc = win.document;
  };
  var toHex = function(color) {
      if (R.vml) {
        var trim = /^\s+|\s+$/g;
        var bod;
        try {
          var docum = new ActiveXObject("htmlfile");
          docum.write("<body>");
          docum.close();
          bod = docum.body;
        } catch (e) {
          bod = createPopup().document.body;
        }
        var range = bod.createTextRange();
        toHex = cacher(function(color) {
          try {
            bod.style.color = Str(color)[rp](trim, E);
            var value = range.queryCommandValue("ForeColor");
            value = ((value & 255) << 16) | (value & 65280) | ((value & 16711680) >>> 16);
            return "#" + ("000000" + value[toString](16)).slice(-6);
          } catch (e) {
            return "none";
          }
        });
      } else {
        var i = doc.createElement("i");
        i.title = "Rapha\xebl Colour Picker";
        i.style.display = "none";
        doc.body[appendChild](i);
        toHex = cacher(function(color) {
          i.style.color = color;
          return doc.defaultView.getComputedStyle(i, E).getPropertyValue("color");
        });
      }
      return toHex(color);
    },
    hsbtoString = function() {
      return "hsb(" + [this.h, this.s, this.b] + ")";
    },
    hsltoString = function() {
      return "hsl(" + [this.h, this.s, this.l] + ")";
    },
    rgbtoString = function() {
      return this.hex;
    };
  R.hsb2rgb = function(h, s, b, o) {
    if (R.is(h, "object") && "h" in h && "s" in h && "b" in h) {
      b = h.b;
      s = h.s;
      h = h.h;
      o = h.o;
    }
    return R.hsl2rgb(h, s, b / 2, o);
  };
  R.hsl2rgb = function(h, s, l, o) {
    if (R.is(h, "object") && "h" in h && "s" in h && "l" in h) {
      l = h.l;
      s = h.s;
      h = h.h;
    }
    if (h > 1 || s > 1 || l > 1) {
      h /= 360;
      s /= 100;
      l /= 100;
    }
    var rgb = {},
      channels = ["r", "g", "b"],
      t2, t1, t3, r, g, b;
    if (!s) {
      rgb = {
        r: l,
        g: l,
        b: l
      };
    } else {
      if (l < .5) {
        t2 = l * (1 + s);
      } else {
        t2 = l + s - l * s;
      }
      t1 = 2 * l - t2;
      for (var i = 0; i < 3; i++) {
        t3 = h + 1 / 3 * -(i - 1);
        t3 < 0 && t3++;
        t3 > 1 && t3--;
        if (t3 * 6 < 1) {
          rgb[channels[i]] = t1 + (t2 - t1) * 6 * t3;
        } else if (t3 * 2 < 1) {
          rgb[channels[i]] = t2;
        } else if (t3 * 3 < 2) {
          rgb[channels[i]] = t1 + (t2 - t1) * (2 / 3 - t3) * 6;
        } else {
          rgb[channels[i]] = t1;
        }
      }
    }
    rgb.r *= 255;
    rgb.g *= 255;
    rgb.b *= 255;
    rgb.hex = "#" + (16777216 | rgb.b | (rgb.g << 8) | (rgb.r << 16)).toString(16).slice(1);
    R.is(o, "finite") && (rgb.opacity = o);
    rgb.toString = rgbtoString;
    return rgb;
  };
  R.rgb2hsb = function(red, green, blue) {
    if (green == null && R.is(red, "object") && "r" in red && "g" in red && "b" in red) {
      blue = red.b;
      green = red.g;
      red = red.r;
    }
    if (green == null && R.is(red, string)) {
      var clr = R.getRGB(red);
      red = clr.r;
      green = clr.g;
      blue = clr.b;
    }
    if (red > 1 || green > 1 || blue > 1) {
      red /= 255;
      green /= 255;
      blue /= 255;
    }
    var max = mmax(red, green, blue),
      min = mmin(red, green, blue),
      hue, saturation, brightness = max;
    if (min == max) {
      return {
        h: 0,
        s: 0,
        b: max,
        toString: hsbtoString
      };
    } else {
      var delta = (max - min);
      saturation = delta / max;
      if (red == max) {
        hue = (green - blue) / delta;
      } else if (green == max) {
        hue = 2 + ((blue - red) / delta);
      } else {
        hue = 4 + ((red - green) / delta);
      }
      hue /= 6;
      hue < 0 && hue++;
      hue > 1 && hue--;
    }
    return {
      h: hue,
      s: saturation,
      b: brightness,
      toString: hsbtoString
    };
  };
  R.rgb2hsl = function(red, green, blue) {
    if (green == null && R.is(red, "object") && "r" in red && "g" in red && "b" in red) {
      blue = red.b;
      green = red.g;
      red = red.r;
    }
    if (green == null && R.is(red, string)) {
      var clr = R.getRGB(red);
      red = clr.r;
      green = clr.g;
      blue = clr.b;
    }
    if (red > 1 || green > 1 || blue > 1) {
      red /= 255;
      green /= 255;
      blue /= 255;
    }
    var max = mmax(red, green, blue),
      min = mmin(red, green, blue),
      h, s, l = (max + min) / 2,
      hsl;
    if (min == max) {
      hsl = {
        h: 0,
        s: 0,
        l: l
      };
    } else {
      var delta = max - min;
      s = l < .5 ? delta / (max + min) : delta / (2 - max - min);
      if (red == max) {
        h = (green - blue) / delta;
      } else if (green == max) {
        h = 2 + (blue - red) / delta;
      } else {
        h = 4 + (red - green) / delta;
      }
      h /= 6;
      h < 0 && h++;
      h > 1 && h--;
      hsl = {
        h: h,
        s: s,
        l: l
      };
    }
    hsl.toString = hsltoString;
    return hsl;
  };
  R._path2string = function() {
    return this.join(",")[rp](p2s, "$1");
  };

  function cacher(f, scope, postprocessor) {
    function newf() {
      var arg = Array[proto].slice.call(arguments, 0),
        args = arg[join]("\u25ba"),
        cache = newf.cache = newf.cache || {},
        count = newf.count = newf.count || [];
      if (cache[has](args)) {
        return postprocessor ? postprocessor(cache[args]) : cache[args];
      }
      count[length] >= 1e3 && delete cache[count.shift()];
      count[push](args);
      cache[args] = f[apply](scope, arg);
      return postprocessor ? postprocessor(cache[args]) : cache[args];
    }
    return newf;
  }
  R.getRGB = cacher(function(colour) {
    if (!colour || !!((colour = Str(colour)).indexOf("-") + 1)) {
      return {
        r: -1,
        g: -1,
        b: -1,
        hex: "none",
        error: 1
      };
    }
    if (colour == "none") {
      return {
        r: -1,
        g: -1,
        b: -1,
        hex: "none"
      };
    }!(hsrg[has](colour.toLowerCase().substring(0, 2)) || colour.charAt() == "#") && (colour = toHex(colour));
    var res, red, green, blue, opacity, t, values, rgb = colour.match(colourRegExp);
    if (rgb) {
      if (rgb[2]) {
        blue = toInt(rgb[2].substring(5), 16);
        green = toInt(rgb[2].substring(3, 5), 16);
        red = toInt(rgb[2].substring(1, 3), 16);
      }
      if (rgb[3]) {
        blue = toInt((t = rgb[3].charAt(3)) + t, 16);
        green = toInt((t = rgb[3].charAt(2)) + t, 16);
        red = toInt((t = rgb[3].charAt(1)) + t, 16);
      }
      if (rgb[4]) {
        values = rgb[4][split](commaSpaces);
        red = toFloat(values[0]);
        values[0].slice(-1) == "%" && (red *= 2.55);
        green = toFloat(values[1]);
        values[1].slice(-1) == "%" && (green *= 2.55);
        blue = toFloat(values[2]);
        values[2].slice(-1) == "%" && (blue *= 2.55);
        rgb[1].toLowerCase().slice(0, 4) == "rgba" && (opacity = toFloat(values[3]));
        values[3] && values[3].slice(-1) == "%" && (opacity /= 100);
      }
      if (rgb[5]) {
        values = rgb[5][split](commaSpaces);
        red = toFloat(values[0]);
        values[0].slice(-1) == "%" && (red *= 2.55);
        green = toFloat(values[1]);
        values[1].slice(-1) == "%" && (green *= 2.55);
        blue = toFloat(values[2]);
        values[2].slice(-1) == "%" && (blue *= 2.55);
        (values[0].slice(-3) == "deg" || values[0].slice(-1) == "\xb0") && (red /= 360);
        rgb[1].toLowerCase().slice(0, 4) == "hsba" && (opacity = toFloat(values[3]));
        values[3] && values[3].slice(-1) == "%" && (opacity /= 100);
        return R.hsb2rgb(red, green, blue, opacity);
      }
      if (rgb[6]) {
        values = rgb[6][split](commaSpaces);
        red = toFloat(values[0]);
        values[0].slice(-1) == "%" && (red *= 2.55);
        green = toFloat(values[1]);
        values[1].slice(-1) == "%" && (green *= 2.55);
        blue = toFloat(values[2]);
        values[2].slice(-1) == "%" && (blue *= 2.55);
        (values[0].slice(-3) == "deg" || values[0].slice(-1) == "\xb0") && (red /= 360);
        rgb[1].toLowerCase().slice(0, 4) == "hsla" && (opacity = toFloat(values[3]));
        values[3] && values[3].slice(-1) == "%" && (opacity /= 100);
        return R.hsl2rgb(red, green, blue, opacity);
      }
      rgb = {
        r: red,
        g: green,
        b: blue
      };
      rgb.hex = "#" + (16777216 | blue | (green << 8) | (red << 16)).toString(16).slice(1);
      R.is(opacity, "finite") && (rgb.opacity = opacity);
      return rgb;
    }
    return {
      r: -1,
      g: -1,
      b: -1,
      hex: "none",
      error: 1
    };
  }, R);
  R.getColor = function(value) {
    var start = this.getColor.start = this.getColor.start || {
        h: 0,
        s: 1,
        b: value || .75
      },
      rgb = this.hsb2rgb(start.h, start.s, start.b);
    start.h += .075;
    if (start.h > 1) {
      start.h = 0;
      start.s -= .2;
      start.s <= 0 && (this.getColor.start = {
        h: 0,
        s: 1,
        b: start.b
      });
    }
    return rgb.hex;
  };
  R.getColor.reset = function() {
    delete this.start;
  };
  R.parsePathString = cacher(function(pathString) {
    if (!pathString) {
      return null;
    }
    var paramCounts = {
        a: 7,
        c: 6,
        h: 1,
        l: 2,
        m: 2,
        q: 4,
        s: 4,
        t: 2,
        v: 1,
        z: 0
      },
      data = [];
    if (R.is(pathString, array) && R.is(pathString[0], array)) {
      data = pathClone(pathString);
    }
    if (!data[length]) {
      Str(pathString)[rp](pathCommand, function(a, b, c) {
        var params = [],
          name = lowerCase.call(b);
        c[rp](pathValues, function(a, b) {
          b && params[push](+b);
        });
        if (name == "m" && params[length] > 2) {
          data[push]([b][concat](params.splice(0, 2)));
          name = "l";
          b = b == "m" ? "l" : "L";
        }
        while (params[length] >= paramCounts[name]) {
          data[push]([b][concat](params.splice(0, paramCounts[name])));
          if (!paramCounts[name]) {
            break;
          }
        }
      });
    }
    data[toString] = R._path2string;
    return data;
  });
  R.findDotsAtSegment = function(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t) {
    var t1 = 1 - t,
      x = pow(t1, 3) * p1x + pow(t1, 2) * 3 * t * c1x + t1 * 3 * t * t * c2x + pow(t, 3) * p2x,
      y = pow(t1, 3) * p1y + pow(t1, 2) * 3 * t * c1y + t1 * 3 * t * t * c2y + pow(t, 3) * p2y,
      mx = p1x + 2 * t * (c1x - p1x) + t * t * (c2x - 2 * c1x + p1x),
      my = p1y + 2 * t * (c1y - p1y) + t * t * (c2y - 2 * c1y + p1y),
      nx = c1x + 2 * t * (c2x - c1x) + t * t * (p2x - 2 * c2x + c1x),
      ny = c1y + 2 * t * (c2y - c1y) + t * t * (p2y - 2 * c2y + c1y),
      ax = (1 - t) * p1x + t * c1x,
      ay = (1 - t) * p1y + t * c1y,
      cx = (1 - t) * c2x + t * p2x,
      cy = (1 - t) * c2y + t * p2y,
      alpha = (90 - math.atan((mx - nx) / (my - ny)) * 180 / PI);
    (mx > nx || my < ny) && (alpha += 180);
    return {
      x: x,
      y: y,
      m: {
        x: mx,
        y: my
      },
      n: {
        x: nx,
        y: ny
      },
      start: {
        x: ax,
        y: ay
      },
      end: {
        x: cx,
        y: cy
      },
      alpha: alpha
    };
  };
  var pathDimensions = cacher(function(path) {
      if (!path) {
        return {
          x: 0,
          y: 0,
          width: 0,
          height: 0
        };
      }
      path = path2curve(path);
      var x = 0,
        y = 0,
        X = [],
        Y = [],
        p;
      for (var i = 0, ii = path[length]; i < ii; i++) {
        p = path[i];
        if (p[0] == "M") {
          x = p[1];
          y = p[2];
          X[push](x);
          Y[push](y);
        } else {
          var dim = curveDim(x, y, p[1], p[2], p[3], p[4], p[5], p[6]);
          X = X[concat](dim.min.x, dim.max.x);
          Y = Y[concat](dim.min.y, dim.max.y);
          x = p[5];
          y = p[6];
        }
      }
      var xmin = mmin[apply](0, X),
        ymin = mmin[apply](0, Y);
      return {
        x: xmin,
        y: ymin,
        width: mmax[apply](0, X) - xmin,
        height: mmax[apply](0, Y) - ymin
      };
    }),
    pathClone = function(pathArray) {
      var res = [];
      if (!R.is(pathArray, array) || !R.is(pathArray && pathArray[0], array)) {
        pathArray = R.parsePathString(pathArray);
      }
      for (var i = 0, ii = pathArray[length]; i < ii; i++) {
        res[i] = [];
        for (var j = 0, jj = pathArray[i][length]; j < jj; j++) {
          res[i][j] = pathArray[i][j];
        }
      }
      res[toString] = R._path2string;
      return res;
    },
    pathToRelative = cacher(function(pathArray) {
      if (!R.is(pathArray, array) || !R.is(pathArray && pathArray[0], array)) {
        pathArray = R.parsePathString(pathArray);
      }
      var res = [],
        x = 0,
        y = 0,
        mx = 0,
        my = 0,
        start = 0;
      if (pathArray[0][0] == "M") {
        x = pathArray[0][1];
        y = pathArray[0][2];
        mx = x;
        my = y;
        start++;
        res[push](["M", x, y]);
      }
      for (var i = start, ii = pathArray[length]; i < ii; i++) {
        var r = res[i] = [],
          pa = pathArray[i];
        if (pa[0] != lowerCase.call(pa[0])) {
          r[0] = lowerCase.call(pa[0]);
          switch (r[0]) {
            case "a":
              r[1] = pa[1];
              r[2] = pa[2];
              r[3] = pa[3];
              r[4] = pa[4];
              r[5] = pa[5];
              r[6] = +(pa[6] - x).toFixed(3);
              r[7] = +(pa[7] - y).toFixed(3);
              break;
            case "v":
              r[1] = +(pa[1] - y).toFixed(3);
              break;
            case "m":
              mx = pa[1];
              my = pa[2];
            default:
              for (var j = 1, jj = pa[length]; j < jj; j++) {
                r[j] = +(pa[j] - ((j % 2) ? x : y)).toFixed(3);
              }
          }
        } else {
          r = res[i] = [];
          if (pa[0] == "m") {
            mx = pa[1] + x;
            my = pa[2] + y;
          }
          for (var k = 0, kk = pa[length]; k < kk; k++) {
            res[i][k] = pa[k];
          }
        }
        var len = res[i][length];
        switch (res[i][0]) {
          case "z":
            x = mx;
            y = my;
            break;
          case "h":
            x += +res[i][len - 1];
            break;
          case "v":
            y += +res[i][len - 1];
            break;
          default:
            x += +res[i][len - 2];
            y += +res[i][len - 1];
        }
      }
      res[toString] = R._path2string;
      return res;
    }, 0, pathClone),
    pathToAbsolute = cacher(function(pathArray) {
      if (!R.is(pathArray, array) || !R.is(pathArray && pathArray[0], array)) {
        pathArray = R.parsePathString(pathArray);
      }
      var res = [],
        x = 0,
        y = 0,
        mx = 0,
        my = 0,
        start = 0;
      if (pathArray[0][0] == "M") {
        x = +pathArray[0][1];
        y = +pathArray[0][2];
        mx = x;
        my = y;
        start++;
        res[0] = ["M", x, y];
      }
      for (var i = start, ii = pathArray[length]; i < ii; i++) {
        var r = res[i] = [],
          pa = pathArray[i];
        if (pa[0] != upperCase.call(pa[0])) {
          r[0] = upperCase.call(pa[0]);
          switch (r[0]) {
            case "A":
              r[1] = pa[1];
              r[2] = pa[2];
              r[3] = pa[3];
              r[4] = pa[4];
              r[5] = pa[5];
              r[6] = +(pa[6] + x);
              r[7] = +(pa[7] + y);
              break;
            case "V":
              r[1] = +pa[1] + y;
              break;
            case "H":
              r[1] = +pa[1] + x;
              break;
            case "M":
              mx = +pa[1] + x;
              my = +pa[2] + y;
            default:
              for (var j = 1, jj = pa[length]; j < jj; j++) {
                r[j] = +pa[j] + ((j % 2) ? x : y);
              }
          }
        } else {
          for (var k = 0, kk = pa[length]; k < kk; k++) {
            res[i][k] = pa[k];
          }
        }
        switch (r[0]) {
          case "Z":
            x = mx;
            y = my;
            break;
          case "H":
            x = r[1];
            break;
          case "V":
            y = r[1];
            break;
          case "M":
            mx = res[i][res[i][length] - 2];
            my = res[i][res[i][length] - 1];
          default:
            x = res[i][res[i][length] - 2];
            y = res[i][res[i][length] - 1];
        }
      }
      res[toString] = R._path2string;
      return res;
    }, null, pathClone),
    l2c = function(x1, y1, x2, y2) {
      return [x1, y1, x2, y2, x2, y2];
    },
    q2c = function(x1, y1, ax, ay, x2, y2) {
      var _13 = 1 / 3,
        _23 = 2 / 3;
      return [_13 * x1 + _23 * ax, _13 * y1 + _23 * ay, _13 * x2 + _23 * ax, _13 * y2 + _23 * ay, x2, y2];
    },
    a2c = function(x1, y1, rx, ry, angle, large_arc_flag, sweep_flag, x2, y2, recursive) {
      var _120 = PI * 120 / 180,
        rad = PI / 180 * (+angle || 0),
        res = [],
        xy, rotate = cacher(function(x, y, rad) {
          var X = x * math.cos(rad) - y * math.sin(rad),
            Y = x * math.sin(rad) + y * math.cos(rad);
          return {
            x: X,
            y: Y
          };
        });
      if (!recursive) {
        xy = rotate(x1, y1, -rad);
        x1 = xy.x;
        y1 = xy.y;
        xy = rotate(x2, y2, -rad);
        x2 = xy.x;
        y2 = xy.y;
        var cos = math.cos(PI / 180 * angle),
          sin = math.sin(PI / 180 * angle),
          x = (x1 - x2) / 2,
          y = (y1 - y2) / 2;
        var h = (x * x) / (rx * rx) + (y * y) / (ry * ry);
        if (h > 1) {
          h = math.sqrt(h);
          rx = h * rx;
          ry = h * ry;
        }
        var rx2 = rx * rx,
          ry2 = ry * ry,
          k = (large_arc_flag == sweep_flag ? -1 : 1) * math.sqrt(abs((rx2 * ry2 - rx2 * y * y - ry2 * x * x) / (rx2 * y * y + ry2 * x * x))),
          cx = k * rx * y / ry + (x1 + x2) / 2,
          cy = k * -ry * x / rx + (y1 + y2) / 2,
          f1 = math.asin(((y1 - cy) / ry).toFixed(9)),
          f2 = math.asin(((y2 - cy) / ry).toFixed(9));
        f1 = x1 < cx ? PI - f1 : f1;
        f2 = x2 < cx ? PI - f2 : f2;
        f1 < 0 && (f1 = PI * 2 + f1);
        f2 < 0 && (f2 = PI * 2 + f2);
        if (sweep_flag && f1 > f2) {
          f1 = f1 - PI * 2;
        }
        if (!sweep_flag && f2 > f1) {
          f2 = f2 - PI * 2;
        }
      } else {
        f1 = recursive[0];
        f2 = recursive[1];
        cx = recursive[2];
        cy = recursive[3];
      }
      var df = f2 - f1;
      if (abs(df) > _120) {
        var f2old = f2,
          x2old = x2,
          y2old = y2;
        f2 = f1 + _120 * (sweep_flag && f2 > f1 ? 1 : -1);
        x2 = cx + rx * math.cos(f2);
        y2 = cy + ry * math.sin(f2);
        res = a2c(x2, y2, rx, ry, angle, 0, sweep_flag, x2old, y2old, [f2, f2old, cx, cy]);
      }
      df = f2 - f1;
      var c1 = math.cos(f1),
        s1 = math.sin(f1),
        c2 = math.cos(f2),
        s2 = math.sin(f2),
        t = math.tan(df / 4),
        hx = 4 / 3 * rx * t,
        hy = 4 / 3 * ry * t,
        m1 = [x1, y1],
        m2 = [x1 + hx * s1, y1 - hy * c1],
        m3 = [x2 + hx * s2, y2 - hy * c2],
        m4 = [x2, y2];
      m2[0] = 2 * m1[0] - m2[0];
      m2[1] = 2 * m1[1] - m2[1];
      if (recursive) {
        return [m2, m3, m4][concat](res);
      } else {
        res = [m2, m3, m4][concat](res)[join]()[split](",");
        var newres = [];
        for (var i = 0, ii = res[length]; i < ii; i++) {
          newres[i] = i % 2 ? rotate(res[i - 1], res[i], rad).y : rotate(res[i], res[i + 1], rad).x;
        }
        return newres;
      }
    },
    findDotAtSegment = function(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t) {
      var t1 = 1 - t;
      return {
        x: pow(t1, 3) * p1x + pow(t1, 2) * 3 * t * c1x + t1 * 3 * t * t * c2x + pow(t, 3) * p2x,
        y: pow(t1, 3) * p1y + pow(t1, 2) * 3 * t * c1y + t1 * 3 * t * t * c2y + pow(t, 3) * p2y
      };
    },
    curveDim = cacher(function(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y) {
      var a = (c2x - 2 * c1x + p1x) - (p2x - 2 * c2x + c1x),
        b = 2 * (c1x - p1x) - 2 * (c2x - c1x),
        c = p1x - c1x,
        t1 = (-b + math.sqrt(b * b - 4 * a * c)) / 2 / a,
        t2 = (-b - math.sqrt(b * b - 4 * a * c)) / 2 / a,
        y = [p1y, p2y],
        x = [p1x, p2x],
        dot;
      abs(t1) > "1e12" && (t1 = .5);
      abs(t2) > "1e12" && (t2 = .5);
      if (t1 > 0 && t1 < 1) {
        dot = findDotAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t1);
        x[push](dot.x);
        y[push](dot.y);
      }
      if (t2 > 0 && t2 < 1) {
        dot = findDotAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t2);
        x[push](dot.x);
        y[push](dot.y);
      }
      a = (c2y - 2 * c1y + p1y) - (p2y - 2 * c2y + c1y);
      b = 2 * (c1y - p1y) - 2 * (c2y - c1y);
      c = p1y - c1y;
      t1 = (-b + math.sqrt(b * b - 4 * a * c)) / 2 / a;
      t2 = (-b - math.sqrt(b * b - 4 * a * c)) / 2 / a;
      abs(t1) > "1e12" && (t1 = .5);
      abs(t2) > "1e12" && (t2 = .5);
      if (t1 > 0 && t1 < 1) {
        dot = findDotAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t1);
        x[push](dot.x);
        y[push](dot.y);
      }
      if (t2 > 0 && t2 < 1) {
        dot = findDotAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t2);
        x[push](dot.x);
        y[push](dot.y);
      }
      return {
        min: {
          x: mmin[apply](0, x),
          y: mmin[apply](0, y)
        },
        max: {
          x: mmax[apply](0, x),
          y: mmax[apply](0, y)
        }
      };
    }),
    path2curve = cacher(function(path, path2) {
      var p = pathToAbsolute(path),
        p2 = path2 && pathToAbsolute(path2),
        attrs = {
          x: 0,
          y: 0,
          bx: 0,
          by: 0,
          X: 0,
          Y: 0,
          qx: null,
          qy: null
        },
        attrs2 = {
          x: 0,
          y: 0,
          bx: 0,
          by: 0,
          X: 0,
          Y: 0,
          qx: null,
          qy: null
        },
        processPath = function(path, d) {
          var nx, ny;
          if (!path) {
            return ["C", d.x, d.y, d.x, d.y, d.x, d.y];
          }!(path[0] in {
            T: 1,
            Q: 1
          }) && (d.qx = d.qy = null);
          switch (path[0]) {
            case "M":
              d.X = path[1];
              d.Y = path[2];
              break;
            case "A":
              path = ["C"][concat](a2c[apply](0, [d.x, d.y][concat](path.slice(1))));
              break;
            case "S":
              nx = d.x + (d.x - (d.bx || d.x));
              ny = d.y + (d.y - (d.by || d.y));
              path = ["C", nx, ny][concat](path.slice(1));
              break;
            case "T":
              d.qx = d.x + (d.x - (d.qx || d.x));
              d.qy = d.y + (d.y - (d.qy || d.y));
              path = ["C"][concat](q2c(d.x, d.y, d.qx, d.qy, path[1], path[2]));
              break;
            case "Q":
              d.qx = path[1];
              d.qy = path[2];
              path = ["C"][concat](q2c(d.x, d.y, path[1], path[2], path[3], path[4]));
              break;
            case "L":
              path = ["C"][concat](l2c(d.x, d.y, path[1], path[2]));
              break;
            case "H":
              path = ["C"][concat](l2c(d.x, d.y, path[1], d.y));
              break;
            case "V":
              path = ["C"][concat](l2c(d.x, d.y, d.x, path[1]));
              break;
            case "Z":
              path = ["C"][concat](l2c(d.x, d.y, d.X, d.Y));
              break;
          }
          return path;
        },
        fixArc = function(pp, i) {
          if (pp[i][length] > 7) {
            pp[i].shift();
            var pi = pp[i];
            while (pi[length]) {
              pp.splice(i++, 0, ["C"][concat](pi.splice(0, 6)));
            }
            pp.splice(i, 1);
            ii = mmax(p[length], p2 && p2[length] || 0);
          }
        },
        fixM = function(path1, path2, a1, a2, i) {
          if (path1 && path2 && path1[i][0] == "M" && path2[i][0] != "M") {
            path2.splice(i, 0, ["M", a2.x, a2.y]);
            a1.bx = 0;
            a1.by = 0;
            a1.x = path1[i][1];
            a1.y = path1[i][2];
            ii = mmax(p[length], p2 && p2[length] || 0);
          }
        };
      for (var i = 0, ii = mmax(p[length], p2 && p2[length] || 0); i < ii; i++) {
        p[i] = processPath(p[i], attrs);
        fixArc(p, i);
        p2 && (p2[i] = processPath(p2[i], attrs2));
        p2 && fixArc(p2, i);
        fixM(p, p2, attrs, attrs2, i);
        fixM(p2, p, attrs2, attrs, i);
        var seg = p[i],
          seg2 = p2 && p2[i],
          seglen = seg[length],
          seg2len = p2 && seg2[length];
        attrs.x = seg[seglen - 2];
        attrs.y = seg[seglen - 1];
        attrs.bx = toFloat(seg[seglen - 4]) || attrs.x;
        attrs.by = toFloat(seg[seglen - 3]) || attrs.y;
        attrs2.bx = p2 && (toFloat(seg2[seg2len - 4]) || attrs2.x);
        attrs2.by = p2 && (toFloat(seg2[seg2len - 3]) || attrs2.y);
        attrs2.x = p2 && seg2[seg2len - 2];
        attrs2.y = p2 && seg2[seg2len - 1];
      }
      return p2 ? [p, p2] : p;
    }, null, pathClone),
    parseDots = cacher(function(gradient) {
      var dots = [];
      for (var i = 0, ii = gradient[length]; i < ii; i++) {
        var dot = {},
          par = gradient[i].match(/^([^:]*):?([\d\.]*)/);
        dot.color = R.getRGB(par[1]);
        if (dot.color.error) {
          return null;
        }
        dot.color = dot.color.hex;
        par[2] && (dot.offset = par[2] + "%");
        dots[push](dot);
      }
      for (i = 1, ii = dots[length] - 1; i < ii; i++) {
        if (!dots[i].offset) {
          var start = toFloat(dots[i - 1].offset || 0),
            end = 0;
          for (var j = i + 1; j < ii; j++) {
            if (dots[j].offset) {
              end = dots[j].offset;
              break;
            }
          }
          if (!end) {
            end = 100;
            j = ii;
          }
          end = toFloat(end);
          var d = (end - start) / (j - i + 1);
          for (; i < j; i++) {
            start += d;
            dots[i].offset = start + "%";
          }
        }
      }
      return dots;
    }),
    getContainer = function(x, y, w, h) {
      var container;
      if (R.is(x, string) || R.is(x, "object")) {
        container = R.is(x, string) ? doc.getElementById(x) : x;
        if (container.tagName) {
          if (y == null) {
            return {
              container: container,
              width: container.style.pixelWidth || container.offsetWidth,
              height: container.style.pixelHeight || container.offsetHeight
            };
          } else {
            return {
              container: container,
              width: y,
              height: w
            };
          }
        }
      } else {
        return {
          container: 1,
          x: x,
          y: y,
          width: w,
          height: h
        };
      }
    },
    plugins = function(con, add) {
      var that = this;
      for (var prop in add) {
        if (add[has](prop) && !(prop in con)) {
          switch (typeof add[prop]) {
            case "function":
              (function(f) {
                con[prop] = con === that ? f : function() {
                  return f[apply](that, arguments);
                };
              })(add[prop]);
              break;
            case "object":
              con[prop] = con[prop] || {};
              plugins.call(this, con[prop], add[prop]);
              break;
            default:
              con[prop] = add[prop];
              break;
          }
        }
      }
    },
    tear = function(el, paper) {
      el == paper.top && (paper.top = el.prev);
      el == paper.bottom && (paper.bottom = el.next);
      el.next && (el.next.prev = el.prev);
      el.prev && (el.prev.next = el.next);
    },
    tofront = function(el, paper) {
      if (paper.top === el) {
        return;
      }
      tear(el, paper);
      el.next = null;
      el.prev = paper.top;
      paper.top.next = el;
      paper.top = el;
    },
    toback = function(el, paper) {
      if (paper.bottom === el) {
        return;
      }
      tear(el, paper);
      el.next = paper.bottom;
      el.prev = null;
      paper.bottom.prev = el;
      paper.bottom = el;
    },
    insertafter = function(el, el2, paper) {
      tear(el, paper);
      el2 == paper.top && (paper.top = el);
      el2.next && (el2.next.prev = el);
      el.next = el2.next;
      el.prev = el2;
      el2.next = el;
    },
    insertbefore = function(el, el2, paper) {
      tear(el, paper);
      el2 == paper.bottom && (paper.bottom = el);
      el2.prev && (el2.prev.next = el);
      el.prev = el2.prev;
      el2.prev = el;
      el.next = el2;
    },
    removed = function(methodname) {
      return function() {
        throw new Error("Rapha\xebl: you are calling to method \u201c" + methodname + "\u201d of removed object");
      };
    };
  R.pathToRelative = pathToRelative;
  if (R.svg) {
    paperproto.svgns = "http://www.w3.org/2000/svg";
    paperproto.xlink = "http://www.w3.org/1999/xlink";
    round = function(num) {
      return +num + (~~num === num) * .5;
    };
    var $ = function(el, attr) {
      if (attr) {
        for (var key in attr) {
          if (attr[has](key)) {
            el[setAttribute](key, Str(attr[key]));
          }
        }
      } else {
        el = doc.createElementNS(paperproto.svgns, el);
        el.style.webkitTapHighlightColor = "rgba(0,0,0,0)";
        return el;
      }
    };
    R[toString] = function() {
      return "Your browser supports SVG.\nYou are running Rapha\xebl " + this.version;
    };
    var thePath = function(pathString, SVG) {
      var el = $("path");
      SVG.canvas && SVG.canvas[appendChild](el);
      var p = new Element(el, SVG);
      p.type = "path";
      setFillAndStroke(p, {
        fill: "none",
        stroke: "#000",
        path: pathString
      });
      return p;
    };
    var addGradientFill = function(o, gradient, SVG) {
      var type = "linear",
        fx = .5,
        fy = .5,
        s = o.style;
      gradient = Str(gradient)[rp](radial_gradient, function(all, _fx, _fy) {
        type = "radial";
        if (_fx && _fy) {
          fx = toFloat(_fx);
          fy = toFloat(_fy);
          var dir = ((fy > .5) * 2 - 1);
          pow(fx - .5, 2) + pow(fy - .5, 2) > .25 && (fy = math.sqrt(.25 - pow(fx - .5, 2)) * dir + .5) && fy != .5 && (fy = fy.toFixed(5) - 1e-5 * dir);
        }
        return E;
      });
      gradient = gradient[split](/\s*\-\s*/);
      if (type == "linear") {
        var angle = gradient.shift();
        angle = -toFloat(angle);
        if (isNaN(angle)) {
          return null;
        }
        var vector = [0, 0, math.cos(angle * PI / 180), math.sin(angle * PI / 180)],
          max = 1 / (mmax(abs(vector[2]), abs(vector[3])) || 1);
        vector[2] *= max;
        vector[3] *= max;
        if (vector[2] < 0) {
          vector[0] = -vector[2];
          vector[2] = 0;
        }
        if (vector[3] < 0) {
          vector[1] = -vector[3];
          vector[3] = 0;
        }
      }
      var dots = parseDots(gradient);
      if (!dots) {
        return null;
      }
      var id = o.getAttribute(fillString);
      id = id.match(/^url\(#(.*)\)$/);
      id && SVG.defs.removeChild(doc.getElementById(id[1]));
      var el = $(type + "Gradient");
      el.id = createUUID();
      $(el, type == "radial" ? {
        fx: fx,
        fy: fy
      } : {
        x1: vector[0],
        y1: vector[1],
        x2: vector[2],
        y2: vector[3]
      });
      SVG.defs[appendChild](el);
      for (var i = 0, ii = dots[length]; i < ii; i++) {
        var stop = $("stop");
        $(stop, {
          offset: dots[i].offset ? dots[i].offset : !i ? "0%" : "100%",
          "stop-color": dots[i].color || "#fff"
        });
        el[appendChild](stop);
      }
      $(o, {
        fill: "url(#" + el.id + ")",
        opacity: 1,
        "fill-opacity": 1
      });
      s.fill = E;
      s.opacity = 1;
      s.fillOpacity = 1;
      return 1;
    };
    var updatePosition = function(o) {
      var bbox = o.getBBox();
      $(o.pattern, {
        patternTransform: R.format("translate({0},{1})", bbox.x, bbox.y)
      });
    };
    var setFillAndStroke = function(o, params) {
      var dasharray = {
          "": [0],
          "none": [0],
          "-": [3, 1],
          ".": [1, 1],
          "-.": [3, 1, 1, 1],
          "-..": [3, 1, 1, 1, 1, 1],
          ". ": [1, 3],
          "- ": [4, 3],
          "--": [8, 3],
          "- .": [4, 3, 1, 3],
          "--.": [8, 3, 1, 3],
          "--..": [8, 3, 1, 3, 1, 3]
        },
        node = o.node,
        attrs = o.attrs,
        rot = o.rotate(),
        addDashes = function(o, value) {
          value = dasharray[lowerCase.call(value)];
          if (value) {
            var width = o.attrs["stroke-width"] || "1",
              butt = {
                round: width,
                square: width,
                butt: 0
              } [o.attrs["stroke-linecap"] || params["stroke-linecap"]] || 0,
              dashes = [];
            var i = value[length];
            while (i--) {
              dashes[i] = value[i] * width + ((i % 2) ? 1 : -1) * butt;
            }
            $(node, {
              "stroke-dasharray": dashes[join](",")
            });
          }
        };
      params[has]("rotation") && (rot = params.rotation);
      var rotxy = Str(rot)[split](separator);
      if (!(rotxy.length - 1)) {
        rotxy = null;
      } else {
        rotxy[1] = +rotxy[1];
        rotxy[2] = +rotxy[2];
      }
      toFloat(rot) && o.rotate(0, true);
      for (var att in params) {
        if (params[has](att)) {
          if (!availableAttrs[has](att)) {
            continue;
          }
          var value = params[att];
          attrs[att] = value;
          switch (att) {
            case "blur":
              o.blur(value);
              break;
            case "rotation":
              o.rotate(value, true);
              break;
            case "href":
            case "title":
            case "target":
              var pn = node.parentNode;
              if (lowerCase.call(pn.tagName) != "a") {
                var hl = $("a");
                pn.insertBefore(hl, node);
                hl[appendChild](node);
                pn = hl;
              }
              if (att == "target" && value == "blank") {
                pn.setAttributeNS(o.paper.xlink, "show", "new");
              } else {
                pn.setAttributeNS(o.paper.xlink, att, value);
              }
              break;
            case "cursor":
              node.style.cursor = value;
              break;
            case "clip-rect":
              var rect = Str(value)[split](separator);
              if (rect[length] == 4) {
                o.clip && o.clip.parentNode.parentNode.removeChild(o.clip.parentNode);
                var el = $("clipPath"),
                  rc = $("rect");
                el.id = createUUID();
                $(rc, {
                  x: rect[0],
                  y: rect[1],
                  width: rect[2],
                  height: rect[3]
                });
                el[appendChild](rc);
                o.paper.defs[appendChild](el);
                $(node, {
                  "clip-path": "url(#" + el.id + ")"
                });
                o.clip = rc;
              }
              if (!value) {
                var clip = doc.getElementById(node.getAttribute("clip-path")[rp](/(^url\(#|\)$)/g, E));
                clip && clip.parentNode.removeChild(clip);
                $(node, {
                  "clip-path": E
                });
                delete o.clip;
              }
              break;
            case "path":
              if (o.type == "path") {
                $(node, {
                  d: value ? attrs.path = pathToAbsolute(value) : "M0,0"
                });
              }
              break;
            case "width":
              node[setAttribute](att, value);
              if (attrs.fx) {
                att = "x";
                value = attrs.x;
              } else {
                break;
              }
              case "x":
                if (attrs.fx) {
                  value = -attrs.x - (attrs.width || 0);
                }
                case "rx":
                  if (att == "rx" && o.type == "rect") {
                    break;
                  }
                  case "cx":
                    rotxy && (att == "x" || att == "cx") && (rotxy[1] += value - attrs[att]);
                    node[setAttribute](att, value);
                    o.pattern && updatePosition(o);
                    break;
                  case "height":
                    node[setAttribute](att, value);
                    if (attrs.fy) {
                      att = "y";
                      value = attrs.y;
                    } else {
                      break;
                    }
                    case "y":
                      if (attrs.fy) {
                        value = -attrs.y - (attrs.height || 0);
                      }
                      case "ry":
                        if (att == "ry" && o.type == "rect") {
                          break;
                        }
                        case "cy":
                          rotxy && (att == "y" || att == "cy") && (rotxy[2] += value - attrs[att]);
                          node[setAttribute](att, value);
                          o.pattern && updatePosition(o);
                          break;
                        case "r":
                          if (o.type == "rect") {
                            $(node, {
                              rx: value,
                              ry: value
                            });
                          } else {
                            node[setAttribute](att, value);
                          }
                          break;
                        case "src":
                          if (o.type == "image") {
                            node.setAttributeNS(o.paper.xlink, "href", value);
                          }
                          break;
                        case "stroke-width":
                          node.style.strokeWidth = value;
                          node[setAttribute](att, value);
                          if (attrs["stroke-dasharray"]) {
                            addDashes(o, attrs["stroke-dasharray"]);
                          }
                          break;
                        case "stroke-dasharray":
                          addDashes(o, value);
                          break;
                        case "translation":
                          var xy = Str(value)[split](separator);
                          xy[0] = +xy[0] || 0;
                          xy[1] = +xy[1] || 0;
                          if (rotxy) {
                            rotxy[1] += xy[0];
                            rotxy[2] += xy[1];
                          }
                          translate.call(o, xy[0], xy[1]);
                          break;
                        case "scale":
                          xy = Str(value)[split](separator);
                          o.scale(+xy[0] || 1, +xy[1] || +xy[0] || 1, isNaN(toFloat(xy[2])) ? null : +xy[2], isNaN(toFloat(xy[3])) ? null : +xy[3]);
                          break;
                        case fillString:
                          var isURL = Str(value).match(ISURL);
                          if (isURL) {
                            el = $("pattern");
                            var ig = $("image");
                            el.id = createUUID();
                            $(el, {
                              x: 0,
                              y: 0,
                              patternUnits: "userSpaceOnUse",
                              height: 1,
                              width: 1
                            });
                            $(ig, {
                              x: 0,
                              y: 0
                            });
                            ig.setAttributeNS(o.paper.xlink, "href", isURL[1]);
                            el[appendChild](ig);
                            var img = doc.createElement("img");
                            img.style.cssText = "position:absolute;left:-9999em;top-9999em";
                            img.onload = function() {
                              $(el, {
                                width: this.offsetWidth,
                                height: this.offsetHeight
                              });
                              $(ig, {
                                width: this.offsetWidth,
                                height: this.offsetHeight
                              });
                              doc.body.removeChild(this);
                              o.paper.safari();
                            };
                            doc.body[appendChild](img);
                            img.src = isURL[1];
                            o.paper.defs[appendChild](el);
                            node.style.fill = "url(#" + el.id + ")";
                            $(node, {
                              fill: "url(#" + el.id + ")"
                            });
                            o.pattern = el;
                            o.pattern && updatePosition(o);
                            break;
                          }
                          var clr = R.getRGB(value);
                          if (!clr.error) {
                            delete params.gradient;
                            delete attrs.gradient;
                            !R.is(attrs.opacity, "undefined") && R.is(params.opacity, "undefined") && $(node, {
                              opacity: attrs.opacity
                            });
                            !R.is(attrs["fill-opacity"], "undefined") && R.is(params["fill-opacity"], "undefined") && $(node, {
                              "fill-opacity": attrs["fill-opacity"]
                            });
                          } else if ((({
                              circle: 1,
                              ellipse: 1
                            })[has](o.type) || Str(value).charAt() != "r") && addGradientFill(node, value, o.paper)) {
                            attrs.gradient = value;
                            attrs.fill = "none";
                            break;
                          }
                          clr[has]("opacity") && $(node, {
                            "fill-opacity": clr.opacity > 1 ? clr.opacity / 100 : clr.opacity
                          });
                        case "stroke":
                          clr = R.getRGB(value);
                          node[setAttribute](att, clr.hex);
                          att == "stroke" && clr[has]("opacity") && $(node, {
                            "stroke-opacity": clr.opacity > 1 ? clr.opacity / 100 : clr.opacity
                          });
                          break;
                        case "gradient":
                          (({
                            circle: 1,
                            ellipse: 1
                          })[has](o.type) || Str(value).charAt() != "r") && addGradientFill(node, value, o.paper);
                          break;
                        case "opacity":
                          if (attrs.gradient && !attrs[has]("stroke-opacity")) {
                            $(node, {
                              "stroke-opacity": value > 1 ? value / 100 : value
                            });
                          }
                          case "fill-opacity":
                            if (attrs.gradient) {
                              var gradient = doc.getElementById(node.getAttribute(fillString)[rp](/^url\(#|\)$/g, E));
                              if (gradient) {
                                var stops = gradient.getElementsByTagName("stop");
                                stops[stops[length] - 1][setAttribute]("stop-opacity", value);
                              }
                              break;
                            }
                            default:
                              att == "font-size" && (value = toInt(value, 10) + "px");
                              var cssrule = att[rp](/(\-.)/g, function(w) {
                                return upperCase.call(w.substring(1));
                              });
                              node.style[cssrule] = value;
                              node[setAttribute](att, value);
                              break;
          }
        }
      }
      tuneText(o, params);
      if (rotxy) {
        o.rotate(rotxy.join(S));
      } else {
        toFloat(rot) && o.rotate(rot, true);
      }
    };
    var leading = 1.2,
      tuneText = function(el, params) {
        if (el.type != "text" || !(params[has]("text") || params[has]("font") || params[has]("font-size") || params[has]("x") || params[has]("y"))) {
          return;
        }
        var a = el.attrs,
          node = el.node,
          fontSize = node.firstChild ? toInt(doc.defaultView.getComputedStyle(node.firstChild, E).getPropertyValue("font-size"), 10) : 10;
        if (params[has]("text")) {
          a.text = params.text;
          while (node.firstChild) {
            node.removeChild(node.firstChild);
          }
          var texts = Str(params.text)[split]("\n");
          for (var i = 0, ii = texts[length]; i < ii; i++)
            if (texts[i]) {
              var tspan = $("tspan");
              i && $(tspan, {
                dy: fontSize * leading,
                x: a.x
              });
              tspan[appendChild](doc.createTextNode(texts[i]));
              node[appendChild](tspan);
            }
        } else {
          texts = node.getElementsByTagName("tspan");
          for (i = 0, ii = texts[length]; i < ii; i++) {
            i && $(texts[i], {
              dy: fontSize * leading,
              x: a.x
            });
          }
        }
        $(node, {
          y: a.y
        });
        var bb = el.getBBox(),
          dif = a.y - (bb.y + bb.height / 2);
        dif && R.is(dif, "finite") && $(node, {
          y: a.y + dif
        });
      },
      Element = function(node, svg) {
        var X = 0,
          Y = 0;
        this[0] = node;
        this.id = R._oid++;
        this.node = node;
        node.raphael = this;
        this.paper = svg;
        this.attrs = this.attrs || {};
        this.transformations = [];
        this._ = {
          tx: 0,
          ty: 0,
          rt: {
            deg: 0,
            cx: 0,
            cy: 0
          },
          sx: 1,
          sy: 1
        };
        !svg.bottom && (svg.bottom = this);
        this.prev = svg.top;
        svg.top && (svg.top.next = this);
        svg.top = this;
        this.next = null;
      };
    var elproto = Element[proto];
    Element[proto].rotate = function(deg, cx, cy) {
      if (this.removed) {
        return this;
      }
      if (deg == null) {
        if (this._.rt.cx) {
          return [this._.rt.deg, this._.rt.cx, this._.rt.cy][join](S);
        }
        return this._.rt.deg;
      }
      var bbox = this.getBBox();
      deg = Str(deg)[split](separator);
      if (deg[length] - 1) {
        cx = toFloat(deg[1]);
        cy = toFloat(deg[2]);
      }
      deg = toFloat(deg[0]);
      if (cx != null && cx !== false) {
        this._.rt.deg = deg;
      } else {
        this._.rt.deg += deg;
      }
      (cy == null) && (cx = null);
      this._.rt.cx = cx;
      this._.rt.cy = cy;
      cx = cx == null ? bbox.x + bbox.width / 2 : cx;
      cy = cy == null ? bbox.y + bbox.height / 2 : cy;
      if (this._.rt.deg) {
        this.transformations[0] = R.format("rotate({0} {1} {2})", this._.rt.deg, cx, cy);
        this.clip && $(this.clip, {
          transform: R.format("rotate({0} {1} {2})", -this._.rt.deg, cx, cy)
        });
      } else {
        this.transformations[0] = E;
        this.clip && $(this.clip, {
          transform: E
        });
      }
      $(this.node, {
        transform: this.transformations[join](S)
      });
      return this;
    };
    Element[proto].hide = function() {
      !this.removed && (this.node.style.display = "none");
      return this;
    };
    Element[proto].show = function() {
      !this.removed && (this.node.style.display = "");
      return this;
    };
    Element[proto].remove = function() {
      if (this.removed) {
        return;
      }
      tear(this, this.paper);
      this.node.parentNode.removeChild(this.node);
      for (var i in this) {
        delete this[i];
      }
      this.removed = true;
    };
    Element[proto].getBBox = function() {
      if (this.removed) {
        return this;
      }
      if (this.type == "path") {
        return pathDimensions(this.attrs.path);
      }
      if (this.node.style.display == "none") {
        this.show();
        var hide = true;
      }
      var bbox = {};
      try {
        bbox = this.node.getBBox();
      } catch (e) {} finally {
        bbox = bbox || {};
      }
      if (this.type == "text") {
        bbox = {
          x: bbox.x,
          y: Infinity,
          width: 0,
          height: 0
        };
        for (var i = 0, ii = this.node.getNumberOfChars(); i < ii; i++) {
          var bb = this.node.getExtentOfChar(i);
          (bb.y < bbox.y) && (bbox.y = bb.y);
          (bb.y + bb.height - bbox.y > bbox.height) && (bbox.height = bb.y + bb.height - bbox.y);
          (bb.x + bb.width - bbox.x > bbox.width) && (bbox.width = bb.x + bb.width - bbox.x);
        }
      }
      hide && this.hide();
      return bbox;
    };
    Element[proto].attr = function(name, value) {
      if (this.removed) {
        return this;
      }
      if (name == null) {
        var res = {};
        for (var i in this.attrs)
          if (this.attrs[has](i)) {
            res[i] = this.attrs[i];
          }
        this._.rt.deg && (res.rotation = this.rotate());
        (this._.sx != 1 || this._.sy != 1) && (res.scale = this.scale());
        res.gradient && res.fill == "none" && (res.fill = res.gradient) && delete res.gradient;
        return res;
      }
      if (value == null && R.is(name, string)) {
        if (name == "translation") {
          return translate.call(this);
        }
        if (name == "rotation") {
          return this.rotate();
        }
        if (name == "scale") {
          return this.scale();
        }
        if (name == fillString && this.attrs.fill == "none" && this.attrs.gradient) {
          return this.attrs.gradient;
        }
        return this.attrs[name];
      }
      if (value == null && R.is(name, array)) {
        var values = {};
        for (var j = 0, jj = name.length; j < jj; j++) {
          values[name[j]] = this.attr(name[j]);
        }
        return values;
      }
      if (value != null) {
        var params = {};
        params[name] = value;
      } else if (name != null && R.is(name, "object")) {
        params = name;
      }
      for (var key in this.paper.customAttributes)
        if (this.paper.customAttributes[has](key) && params[has](key) && R.is(this.paper.customAttributes[key], "function")) {
          var par = this.paper.customAttributes[key].apply(this, [][concat](params[key]));
          this.attrs[key] = params[key];
          for (var subkey in par)
            if (par[has](subkey)) {
              params[subkey] = par[subkey];
            }
        }
      setFillAndStroke(this, params);
      return this;
    };
    Element[proto].toFront = function() {
      if (this.removed) {
        return this;
      }
      this.node.parentNode[appendChild](this.node);
      var svg = this.paper;
      svg.top != this && tofront(this, svg);
      return this;
    };
    Element[proto].toBack = function() {
      if (this.removed) {
        return this;
      }
      if (this.node.parentNode.firstChild != this.node) {
        this.node.parentNode.insertBefore(this.node, this.node.parentNode.firstChild);
        toback(this, this.paper);
        var svg = this.paper;
      }
      return this;
    };
    Element[proto].insertAfter = function(element) {
      if (this.removed) {
        return this;
      }
      var node = element.node || element[element.length - 1].node;
      if (node.nextSibling) {
        node.parentNode.insertBefore(this.node, node.nextSibling);
      } else {
        node.parentNode[appendChild](this.node);
      }
      insertafter(this, element, this.paper);
      return this;
    };
    Element[proto].insertBefore = function(element) {
      if (this.removed) {
        return this;
      }
      var node = element.node || element[0].node;
      node.parentNode.insertBefore(this.node, node);
      insertbefore(this, element, this.paper);
      return this;
    };
    Element[proto].blur = function(size) {
      var t = this;
      if (+size !== 0) {
        var fltr = $("filter"),
          blur = $("feGaussianBlur");
        t.attrs.blur = size;
        fltr.id = createUUID();
        $(blur, {
          stdDeviation: +size || 1.5
        });
        fltr.appendChild(blur);
        t.paper.defs.appendChild(fltr);
        t._blur = fltr;
        $(t.node, {
          filter: "url(#" + fltr.id + ")"
        });
      } else {
        if (t._blur) {
          t._blur.parentNode.removeChild(t._blur);
          delete t._blur;
          delete t.attrs.blur;
        }
        t.node.removeAttribute("filter");
      }
    };
    var theCircle = function(svg, x, y, r) {
        var el = $("circle");
        svg.canvas && svg.canvas[appendChild](el);
        var res = new Element(el, svg);
        res.attrs = {
          cx: x,
          cy: y,
          r: r,
          fill: "none",
          stroke: "#000"
        };
        res.type = "circle";
        $(el, res.attrs);
        return res;
      },
      theRect = function(svg, x, y, w, h, r) {
        var el = $("rect");
        svg.canvas && svg.canvas[appendChild](el);
        var res = new Element(el, svg);
        res.attrs = {
          x: x,
          y: y,
          width: w,
          height: h,
          r: r || 0,
          rx: r || 0,
          ry: r || 0,
          fill: "none",
          stroke: "#000"
        };
        res.type = "rect";
        $(el, res.attrs);
        return res;
      },
      theEllipse = function(svg, x, y, rx, ry) {
        var el = $("ellipse");
        svg.canvas && svg.canvas[appendChild](el);
        var res = new Element(el, svg);
        res.attrs = {
          cx: x,
          cy: y,
          rx: rx,
          ry: ry,
          fill: "none",
          stroke: "#000"
        };
        res.type = "ellipse";
        $(el, res.attrs);
        return res;
      },
      theImage = function(svg, src, x, y, w, h) {
        var el = $("image");
        $(el, {
          x: x,
          y: y,
          width: w,
          height: h,
          preserveAspectRatio: "none"
        });
        el.setAttributeNS(svg.xlink, "href", src);
        svg.canvas && svg.canvas[appendChild](el);
        var res = new Element(el, svg);
        res.attrs = {
          x: x,
          y: y,
          width: w,
          height: h,
          src: src
        };
        res.type = "image";
        return res;
      },
      theText = function(svg, x, y, text) {
        var el = $("text");
        $(el, {
          x: x,
          y: y,
          "text-anchor": "middle"
        });
        svg.canvas && svg.canvas[appendChild](el);
        var res = new Element(el, svg);
        res.attrs = {
          x: x,
          y: y,
          "text-anchor": "middle",
          text: text,
          font: availableAttrs.font,
          stroke: "none",
          fill: "#000"
        };
        res.type = "text";
        setFillAndStroke(res, res.attrs);
        return res;
      },
      setSize = function(width, height) {
        this.width = width || this.width;
        this.height = height || this.height;
        this.canvas[setAttribute]("width", this.width);
        this.canvas[setAttribute]("height", this.height);
        return this;
      },
      create = function() {
        var con = getContainer[apply](0, arguments),
          container = con && con.container,
          x = con.x,
          y = con.y,
          width = con.width,
          height = con.height;
        if (!container) {
          throw new Error("SVG container not found.");
        }
        var cnvs = $("svg");
        x = x || 0;
        y = y || 0;
        width = width || 512;
        height = height || 342;
        $(cnvs, {
          xmlns: "http://www.w3.org/2000/svg",
          version: 1.1,
          width: width,
          height: height
        });
        if (container == 1) {
          cnvs.style.cssText = "position:absolute;left:" + x + "px;top:" + y + "px";
          doc.body[appendChild](cnvs);
        } else {
          if (container.firstChild) {
            container.insertBefore(cnvs, container.firstChild);
          } else {
            container[appendChild](cnvs);
          }
        }
        container = new Paper;
        container.width = width;
        container.height = height;
        container.canvas = cnvs;
        plugins.call(container, container, R.fn);
        container.clear();
        return container;
      };
    paperproto.clear = function() {
      var c = this.canvas;
      while (c.firstChild) {
        c.removeChild(c.firstChild);
      }
      this.bottom = this.top = null;
      (this.desc = $("desc"))[appendChild](doc.createTextNode("Created with Rapha\xebl"));
      c[appendChild](this.desc);
      c[appendChild](this.defs = $("defs"));
    };
    paperproto.remove = function() {
      this.canvas.parentNode && this.canvas.parentNode.removeChild(this.canvas);
      for (var i in this) {
        this[i] = removed(i);
      }
    };
  }
  if (R.vml) {
    var map = {
        M: "m",
        L: "l",
        C: "c",
        Z: "x",
        m: "t",
        l: "r",
        c: "v",
        z: "x"
      },
      bites = /([clmz]),?([^clmz]*)/gi,
      blurregexp = / progid:\S+Blur\([^\)]+\)/g,
      val = /-?[^,\s-]+/g,
      coordsize = 1e3 + S + 1e3,
      zoom = 10,
      pathlike = {
        path: 1,
        rect: 1
      },
      path2vml = function(path) {
        var total = /[ahqstv]/ig,
          command = pathToAbsolute;
        Str(path).match(total) && (command = path2curve);
        total = /[clmz]/g;
        if (command == pathToAbsolute && !Str(path).match(total)) {
          var res = Str(path)[rp](bites, function(all, command, args) {
            var vals = [],
              isMove = lowerCase.call(command) == "m",
              res = map[command];
            args[rp](val, function(value) {
              if (isMove && vals[length] == 2) {
                res += vals + map[command == "m" ? "l" : "L"];
                vals = [];
              }
              vals[push](round(value * zoom));
            });
            return res + vals;
          });
          return res;
        }
        var pa = command(path),
          p, r;
        res = [];
        for (var i = 0, ii = pa[length]; i < ii; i++) {
          p = pa[i];
          r = lowerCase.call(pa[i][0]);
          r == "z" && (r = "x");
          for (var j = 1, jj = p[length]; j < jj; j++) {
            r += round(p[j] * zoom) + (j != jj - 1 ? "," : E);
          }
          res[push](r);
        }
        return res[join](S);
      };
    R[toString] = function() {
      return "Your browser doesn\u2019t support SVG. Falling down to VML.\nYou are running Rapha\xebl " + this.version;
    };
    thePath = function(pathString, vml) {
      var g = createNode("group");
      g.style.cssText = "position:absolute;left:0;top:0;width:" + vml.width + "px;height:" + vml.height + "px";
      g.coordsize = vml.coordsize;
      g.coordorigin = vml.coordorigin;
      var el = createNode("shape"),
        ol = el.style;
      ol.width = vml.width + "px";
      ol.height = vml.height + "px";
      el.coordsize = coordsize;
      el.coordorigin = vml.coordorigin;
      g[appendChild](el);
      var p = new Element(el, g, vml),
        attr = {
          fill: "none",
          stroke: "#000"
        };
      pathString && (attr.path = pathString);
      p.type = "path";
      p.path = [];
      p.Path = E;
      setFillAndStroke(p, attr);
      vml.canvas[appendChild](g);
      return p;
    };
    setFillAndStroke = function(o, params) {
      o.attrs = o.attrs || {};
      var node = o.node,
        a = o.attrs,
        xy, newpath = (params.x != a.x || params.y != a.y || params.width != a.width || params.height != a.height || params.r != a.r) && o.type == "rect",
        res = o;
      for (var par in params)
        if (params[has](par)) {
          a[par] = params[par];
        }
      if (newpath) {
        a.path = rectPath(a.x, a.y, a.width, a.height, a.r);
        o.X = a.x;
        o.Y = a.y;
        o.W = a.width;
        o.H = a.height;
      }
      params.href && (node.href = params.href);
      params.title && (node.title = params.title);
      params.target && (node.target = params.target);
      params.cursor && (s.cursor = params.cursor);
      "blur" in params && o.blur(params.blur);
      if (params.path && o.type == "path" || newpath) {
        node.path = path2vml(a.path);
      }
      if (params.rotation != null) {
        o.rotate(params.rotation, true);
      }
      if (params.translation) {
        xy = Str(params.translation)[split](separator);
        translate.call(o, xy[0], xy[1]);
        if (o._.rt.cx != null) {
          o._.rt.cx += +xy[0];
          o._.rt.cy += +xy[1];
          o.setBox(o.attrs, xy[0], xy[1]);
        }
      }
      if (params.scale) {
        xy = Str(params.scale)[split](separator);
        o.scale(+xy[0] || 1, +xy[1] || +xy[0] || 1, +xy[2] || null, +xy[3] || null);
      }
      if ("clip-rect" in params) {
        var rect = Str(params["clip-rect"])[split](separator);
        if (rect[length] == 4) {
          rect[2] = +rect[2] + (+rect[0]);
          rect[3] = +rect[3] + (+rect[1]);
          var div = node.clipRect || doc.createElement("div"),
            dstyle = div.style,
            group = node.parentNode;
          dstyle.clip = R.format("rect({1}px {2}px {3}px {0}px)", rect);
          if (!node.clipRect) {
            dstyle.position = "absolute";
            dstyle.top = 0;
            dstyle.left = 0;
            dstyle.width = o.paper.width + "px";
            dstyle.height = o.paper.height + "px";
            group.parentNode.insertBefore(div, group);
            div[appendChild](group);
            node.clipRect = div;
          }
        }
        if (!params["clip-rect"]) {
          node.clipRect && (node.clipRect.style.clip = E);
        }
      }
      if (o.type == "image" && params.src) {
        node.src = params.src;
      }
      if (o.type == "image" && params.opacity) {
        node.filterOpacity = ms + ".Alpha(opacity=" + (params.opacity * 100) + ")";
        s.filter = (node.filterMatrix || E) + (node.filterOpacity || E);
      }
      params.font && (s.font = params.font);
      params["font-family"] && (s.fontFamily = '"' + params["font-family"][split](",")[0][rp](/^['"]+|['"]+$/g, E) + '"');
      params["font-size"] && (s.fontSize = params["font-size"]);
      params["font-weight"] && (s.fontWeight = params["font-weight"]);
      params["font-style"] && (s.fontStyle = params["font-style"]);
      if (params.opacity != null || params["stroke-width"] != null || params.fill != null || params.stroke != null || params["stroke-width"] != null || params["stroke-opacity"] != null || params["fill-opacity"] != null || params["stroke-dasharray"] != null || params["stroke-miterlimit"] != null || params["stroke-linejoin"] != null || params["stroke-linecap"] != null) {
        node = o.shape || node;
        var fill = (node.getElementsByTagName(fillString) && node.getElementsByTagName(fillString)[0]),
          newfill = false;
        !fill && (newfill = fill = createNode(fillString));
        if ("fill-opacity" in params || "opacity" in params) {
          var opacity = ((+a["fill-opacity"] + 1 || 2) - 1) * ((+a.opacity + 1 || 2) - 1) * ((+R.getRGB(params.fill).o + 1 || 2) - 1);
          opacity = mmin(mmax(opacity, 0), 1);
          fill.opacity = opacity;
        }
        params.fill && (fill.on = true);
        if (fill.on == null || params.fill == "none") {
          fill.on = false;
        }
        if (fill.on && params.fill) {
          var isURL = params.fill.match(ISURL);
          if (isURL) {
            fill.src = isURL[1];
            fill.type = "tile";
          } else {
            fill.color = R.getRGB(params.fill).hex;
            fill.src = E;
            fill.type = "solid";
            if (R.getRGB(params.fill).error && (res.type in {
                circle: 1,
                ellipse: 1
              } || Str(params.fill).charAt() != "r") && addGradientFill(res, params.fill)) {
              a.fill = "none";
              a.gradient = params.fill;
            }
          }
        }
        newfill && node[appendChild](fill);
        var stroke = (node.getElementsByTagName("stroke") && node.getElementsByTagName("stroke")[0]),
          newstroke = false;
        !stroke && (newstroke = stroke = createNode("stroke"));
        if ((params.stroke && params.stroke != "none") || params["stroke-width"] || params["stroke-opacity"] != null || params["stroke-dasharray"] || params["stroke-miterlimit"] || params["stroke-linejoin"] || params["stroke-linecap"]) {
          stroke.on = true;
        }
        (params.stroke == "none" || stroke.on == null || params.stroke == 0 || params["stroke-width"] == 0) && (stroke.on = false);
        var strokeColor = R.getRGB(params.stroke);
        stroke.on && params.stroke && (stroke.color = strokeColor.hex);
        opacity = ((+a["stroke-opacity"] + 1 || 2) - 1) * ((+a.opacity + 1 || 2) - 1) * ((+strokeColor.o + 1 || 2) - 1);
        var width = (toFloat(params["stroke-width"]) || 1) * .75;
        opacity = mmin(mmax(opacity, 0), 1);
        params["stroke-width"] == null && (width = a["stroke-width"]);
        params["stroke-width"] && (stroke.weight = width);
        width && width < 1 && (opacity *= width) && (stroke.weight = 1);
        stroke.opacity = opacity;
        params["stroke-linejoin"] && (stroke.joinstyle = params["stroke-linejoin"] || "miter");
        stroke.miterlimit = params["stroke-miterlimit"] || 8;
        params["stroke-linecap"] && (stroke.endcap = params["stroke-linecap"] == "butt" ? "flat" : params["stroke-linecap"] == "square" ? "square" : "round");
        if (params["stroke-dasharray"]) {
          var dasharray = {
            "-": "shortdash",
            ".": "shortdot",
            "-.": "shortdashdot",
            "-..": "shortdashdotdot",
            ". ": "dot",
            "- ": "dash",
            "--": "longdash",
            "- .": "dashdot",
            "--.": "longdashdot",
            "--..": "longdashdotdot"
          };
          stroke.dashstyle = dasharray[has](params["stroke-dasharray"]) ? dasharray[params["stroke-dasharray"]] : E;
        }
        newstroke && node[appendChild](stroke);
      }
      if (res.type == "text") {
        s = res.paper.span.style;
        a.font && (s.font = a.font);
        a["font-family"] && (s.fontFamily = a["font-family"]);
        a["font-size"] && (s.fontSize = a["font-size"]);
        a["font-weight"] && (s.fontWeight = a["font-weight"]);
        a["font-style"] && (s.fontStyle = a["font-style"]);
        res.node.string && (res.paper.span.innerHTML = Str(res.node.string)[rp](/</g, "&#60;")[rp](/&/g, "&#38;")[rp](/\n/g, "<br>"));
        res.W = a.w = res.paper.span.offsetWidth;
        res.H = a.h = res.paper.span.offsetHeight;
        res.X = a.x;
        res.Y = a.y + round(res.H / 2);
        switch (a["text-anchor"]) {
          case "start":
            res.node.style["v-text-align"] = "left";
            res.bbx = round(res.W / 2);
            break;
          case "end":
            res.node.style["v-text-align"] = "right";
            res.bbx = -round(res.W / 2);
            break;
          default:
            res.node.style["v-text-align"] = "center";
            break;
        }
      }
    };
    addGradientFill = function(o, gradient) {
      o.attrs = o.attrs || {};
      var attrs = o.attrs,
        fill, type = "linear",
        fxfy = ".5 .5";
      o.attrs.gradient = gradient;
      gradient = Str(gradient)[rp](radial_gradient, function(all, fx, fy) {
        type = "radial";
        if (fx && fy) {
          fx = toFloat(fx);
          fy = toFloat(fy);
          pow(fx - .5, 2) + pow(fy - .5, 2) > .25 && (fy = math.sqrt(.25 - pow(fx - .5, 2)) * ((fy > .5) * 2 - 1) + .5);
          fxfy = fx + S + fy;
        }
        return E;
      });
      gradient = gradient[split](/\s*\-\s*/);
      if (type == "linear") {
        var angle = gradient.shift();
        angle = -toFloat(angle);
        if (isNaN(angle)) {
          return null;
        }
      }
      var dots = parseDots(gradient);
      if (!dots) {
        return null;
      }
      o = o.shape || o.node;
      fill = o.getElementsByTagName(fillString)[0] || createNode(fillString);
      !fill.parentNode && o.appendChild(fill);
      if (dots[length]) {
        fill.on = true;
        fill.method = "none";
        fill.color = dots[0].color;
        fill.color2 = dots[dots[length] - 1].color;
        var clrs = [];
        for (var i = 0, ii = dots[length]; i < ii; i++) {
          dots[i].offset && clrs[push](dots[i].offset + S + dots[i].color);
        }
        fill.colors && (fill.colors.value = clrs[length] ? clrs[join]() : "0% " + fill.color);
        if (type == "radial") {
          fill.type = "gradientradial";
          fill.focus = "100%";
          fill.focussize = fxfy;
          fill.focusposition = fxfy;
        } else {
          fill.type = "gradient";
          fill.angle = (270 - angle) % 360;
        }
      }
      return 1;
    };
    Element = function(node, group, vml) {
      var Rotation = 0,
        RotX = 0,
        RotY = 0,
        Scale = 1;
      this[0] = node;
      this.id = R._oid++;
      this.node = node;
      node.raphael = this;
      this.X = 0;
      this.Y = 0;
      this.attrs = {};
      this.Group = group;
      this.paper = vml;
      this._ = {
        tx: 0,
        ty: 0,
        rt: {
          deg: 0
        },
        sx: 1,
        sy: 1
      };
      !vml.bottom && (vml.bottom = this);
      this.prev = vml.top;
      vml.top && (vml.top.next = this);
      vml.top = this;
      this.next = null;
    };
    elproto = Element[proto];
    elproto.rotate = function(deg, cx, cy) {
      if (this.removed) {
        return this;
      }
      if (deg == null) {
        if (this._.rt.cx) {
          return [this._.rt.deg, this._.rt.cx, this._.rt.cy][join](S);
        }
        return this._.rt.deg;
      }
      deg = Str(deg)[split](separator);
      if (deg[length] - 1) {
        cx = toFloat(deg[1]);
        cy = toFloat(deg[2]);
      }
      deg = toFloat(deg[0]);
      if (cx != null) {
        this._.rt.deg = deg;
      } else {
        this._.rt.deg += deg;
      }
      cy == null && (cx = null);
      this._.rt.cx = cx;
      this._.rt.cy = cy;
      this.setBox(this.attrs, cx, cy);
      this.Group.style.rotation = this._.rt.deg;
      return this;
    };
    elproto.setBox = function(params, cx, cy) {
      if (this.removed) {
        return this;
      }
      var gs = this.Group.style,
        os = (this.shape && this.shape.style) || this.node.style;
      params = params || {};
      for (var i in params)
        if (params[has](i)) {
          this.attrs[i] = params[i];
        }
      cx = cx || this._.rt.cx;
      cy = cy || this._.rt.cy;
      var attr = this.attrs,
        x, y, w, h;
      switch (this.type) {
        case "circle":
          x = attr.cx - attr.r;
          y = attr.cy - attr.r;
          w = h = attr.r * 2;
          break;
        case "ellipse":
          x = attr.cx - attr.rx;
          y = attr.cy - attr.ry;
          w = attr.rx * 2;
          h = attr.ry * 2;
          break;
        case "image":
          x = +attr.x;
          y = +attr.y;
          w = attr.width || 0;
          h = attr.height || 0;
          break;
        case "text":
          this.textpath.v = ["m", round(attr.x), ", ", round(attr.y - 2), "l", round(attr.x) + 1, ", ", round(attr.y - 2)][join](E);
          x = attr.x - round(this.W / 2);
          y = attr.y - this.H / 2;
          w = this.W;
          h = this.H;
          break;
        case "rect":
        case "path":
          if (!this.attrs.path) {
            x = 0;
            y = 0;
            w = this.paper.width;
            h = this.paper.height;
          } else {
            var dim = pathDimensions(this.attrs.path);
            x = dim.x;
            y = dim.y;
            w = dim.width;
            h = dim.height;
          }
          break;
        default:
          x = 0;
          y = 0;
          w = this.paper.width;
          h = this.paper.height;
          break;
      }
      cx = (cx == null) ? x + w / 2 : cx;
      cy = (cy == null) ? y + h / 2 : cy;
      var left = cx - this.paper.width / 2,
        top = cy - this.paper.height / 2,
        t;
      gs.left != (t = left + "px") && (gs.left = t);
      gs.top != (t = top + "px") && (gs.top = t);
      this.X = pathlike[has](this.type) ? -left : x;
      this.Y = pathlike[has](this.type) ? -top : y;
      this.W = w;
      this.H = h;
      if (pathlike[has](this.type)) {
        os.left != (t = -left * zoom + "px") && (os.left = t);
        os.top != (t = -top * zoom + "px") && (os.top = t);
      } else if (this.type == "text") {
        os.left != (t = -left + "px") && (os.left = t);
        os.top != (t = -top + "px") && (os.top = t);
      } else {
        gs.width != (t = this.paper.width + "px") && (gs.width = t);
        gs.height != (t = this.paper.height + "px") && (gs.height = t);
        os.left != (t = x - left + "px") && (os.left = t);
        os.top != (t = y - top + "px") && (os.top = t);
        os.width != (t = w + "px") && (os.width = t);
        os.height != (t = h + "px") && (os.height = t);
      }
    };
    elproto.hide = function() {
      !this.removed && (this.Group.style.display = "none");
      return this;
    };
    elproto.show = function() {
      !this.removed && (this.Group.style.display = "block");
      return this;
    };
    elproto.getBBox = function() {
      if (this.removed) {
        return this;
      }
      if (pathlike[has](this.type)) {
        return pathDimensions(this.attrs.path);
      }
      return {
        x: this.X + (this.bbx || 0),
        y: this.Y,
        width: this.W,
        height: this.H
      };
    };
    elproto.remove = function() {
      if (this.removed) {
        return;
      }
      tear(this, this.paper);
      this.node.parentNode.removeChild(this.node);
      this.Group.parentNode.removeChild(this.Group);
      this.shape && this.shape.parentNode.removeChild(this.shape);
      for (var i in this) {
        delete this[i];
      }
      this.removed = true;
    };
    elproto.attr = function(name, value) {
      if (this.removed) {
        return this;
      }
      if (name == null) {
        var res = {};
        for (var i in this.attrs)
          if (this.attrs[has](i)) {
            res[i] = this.attrs[i];
          }
        this._.rt.deg && (res.rotation = this.rotate());
        (this._.sx != 1 || this._.sy != 1) && (res.scale = this.scale());
        res.gradient && res.fill == "none" && (res.fill = res.gradient) && delete res.gradient;
        return res;
      }
      if (value == null && R.is(name, "string")) {
        if (name == "translation") {
          return translate.call(this);
        }
        if (name == "rotation") {
          return this.rotate();
        }
        if (name == "scale") {
          return this.scale();
        }
        if (name == fillString && this.attrs.fill == "none" && this.attrs.gradient) {
          return this.attrs.gradient;
        }
        return this.attrs[name];
      }
      if (this.attrs && value == null && R.is(name, array)) {
        var ii, values = {};
        for (i = 0, ii = name[length]; i < ii; i++) {
          values[name[i]] = this.attr(name[i]);
        }
        return values;
      }
      var params;
      if (value != null) {
        params = {};
        params[name] = value;
      }
      value == null && R.is(name, "object") && (params = name);
      if (params) {
        for (var key in this.paper.customAttributes)
          if (this.paper.customAttributes[has](key) && params[has](key) && R.is(this.paper.customAttributes[key], "function")) {
            var par = this.paper.customAttributes[key].apply(this, [][concat](params[key]));
            this.attrs[key] = params[key];
            for (var subkey in par)
              if (par[has](subkey)) {
                params[subkey] = par[subkey];
              }
          }
        if (params.text && this.type == "text") {
          this.node.string = params.text;
        }
        setFillAndStroke(this, params);
        if (params.gradient && (({
            circle: 1,
            ellipse: 1
          })[has](this.type) || Str(params.gradient).charAt() != "r")) {
          addGradientFill(this, params.gradient);
        }
        (!pathlike[has](this.type) || this._.rt.deg) && this.setBox(this.attrs);
      }
      return this;
    };
    elproto.toFront = function() {
      !this.removed && this.Group.parentNode[appendChild](this.Group);
      this.paper.top != this && tofront(this, this.paper);
      return this;
    };
    elproto.toBack = function() {
      if (this.removed) {
        return this;
      }
      if (this.Group.parentNode.firstChild != this.Group) {
        this.Group.parentNode.insertBefore(this.Group, this.Group.parentNode.firstChild);
        toback(this, this.paper);
      }
      return this;
    };
    elproto.insertAfter = function(element) {
      if (this.removed) {
        return this;
      }
      if (element.constructor == Set) {
        element = element[element.length - 1];
      }
      if (element.Group.nextSibling) {
        element.Group.parentNode.insertBefore(this.Group, element.Group.nextSibling);
      } else {
        element.Group.parentNode[appendChild](this.Group);
      }
      insertafter(this, element, this.paper);
      return this;
    };
    elproto.insertBefore = function(element) {
      if (this.removed) {
        return this;
      }
      if (element.constructor == Set) {
        element = element[0];
      }
      element.Group.parentNode.insertBefore(this.Group, element.Group);
      insertbefore(this, element, this.paper);
      return this;
    };
    elproto.blur = function(size) {
      var s = this.node.runtimeStyle,
        f = s.filter;
      f = f.replace(blurregexp, E);
      if (+size !== 0) {
        this.attrs.blur = size;
        s.filter = f + S + ms + ".Blur(pixelradius=" + (+size || 1.5) + ")";
        s.margin = R.format("-{0}px 0 0 -{0}px", round(+size || 1.5));
      } else {
        s.filter = f;
        s.margin = 0;
        delete this.attrs.blur;
      }
    };
    theCircle = function(vml, x, y, r) {
      var g = createNode("group"),
        o = createNode("oval"),
        ol = o.style;
      g.style.cssText = "position:absolute;left:0;top:0;width:" + vml.width + "px;height:" + vml.height + "px";
      g.coordsize = coordsize;
      g.coordorigin = vml.coordorigin;
      g[appendChild](o);
      var res = new Element(o, g, vml);
      res.type = "circle";
      setFillAndStroke(res, {
        stroke: "#000",
        fill: "none"
      });
      res.attrs.cx = x;
      res.attrs.cy = y;
      res.attrs.r = r;
      res.setBox({
        x: x - r,
        y: y - r,
        width: r * 2,
        height: r * 2
      });
      vml.canvas[appendChild](g);
      return res;
    };

    function rectPath(x, y, w, h, r) {
      if (r) {
        return R.format("M{0},{1}l{2},0a{3},{3},0,0,1,{3},{3}l0,{5}a{3},{3},0,0,1,{4},{3}l{6},0a{3},{3},0,0,1,{4},{4}l0,{7}a{3},{3},0,0,1,{3},{4}z", x + r, y, w - r * 2, r, -r, h - r * 2, r * 2 - w, r * 2 - h);
      } else {
        return R.format("M{0},{1}l{2},0,0,{3},{4},0z", x, y, w, h, -w);
      }
    }
    theRect = function(vml, x, y, w, h, r) {
      var path = rectPath(x, y, w, h, r),
        res = vml.path(path),
        a = res.attrs;
      res.X = a.x = x;
      res.Y = a.y = y;
      res.W = a.width = w;
      res.H = a.height = h;
      a.r = r;
      a.path = path;
      res.type = "rect";
      return res;
    };
    theEllipse = function(vml, x, y, rx, ry) {
      var g = createNode("group"),
        o = createNode("oval"),
        ol = o.style;
      g.style.cssText = "position:absolute;left:0;top:0;width:" + vml.width + "px;height:" + vml.height + "px";
      g.coordsize = coordsize;
      g.coordorigin = vml.coordorigin;
      g[appendChild](o);
      var res = new Element(o, g, vml);
      res.type = "ellipse";
      setFillAndStroke(res, {
        stroke: "#000"
      });
      res.attrs.cx = x;
      res.attrs.cy = y;
      res.attrs.rx = rx;
      res.attrs.ry = ry;
      res.setBox({
        x: x - rx,
        y: y - ry,
        width: rx * 2,
        height: ry * 2
      });
      vml.canvas[appendChild](g);
      return res;
    };
    theImage = function(vml, src, x, y, w, h) {
      var g = createNode("group"),
        o = createNode("image");
      g.style.cssText = "position:absolute;left:0;top:0;width:" + vml.width + "px;height:" + vml.height + "px";
      g.coordsize = coordsize;
      g.coordorigin = vml.coordorigin;
      o.src = src;
      g[appendChild](o);
      var res = new Element(o, g, vml);
      res.type = "image";
      res.attrs.src = src;
      res.attrs.x = x;
      res.attrs.y = y;
      res.attrs.w = w;
      res.attrs.h = h;
      res.setBox({
        x: x,
        y: y,
        width: w,
        height: h
      });
      vml.canvas[appendChild](g);
      return res;
    };
    theText = function(vml, x, y, text) {
      var g = createNode("group"),
        el = createNode("shape"),
        ol = el.style,
        path = createNode("path"),
        ps = path.style,
        o = createNode("textpath");
      g.style.cssText = "position:absolute;left:0;top:0;width:" + vml.width + "px;height:" + vml.height + "px";
      g.coordsize = coordsize;
      g.coordorigin = vml.coordorigin;
      path.v = R.format("m{0},{1}l{2},{1}", round(x * 10), round(y * 10), round(x * 10) + 1);
      path.textpathok = true;
      ol.width = vml.width;
      ol.height = vml.height;
      o.string = Str(text);
      o.on = true;
      el[appendChild](o);
      el[appendChild](path);
      g[appendChild](el);
      var res = new Element(o, g, vml);
      res.shape = el;
      res.textpath = path;
      res.type = "text";
      res.attrs.text = text;
      res.attrs.x = x;
      res.attrs.y = y;
      res.attrs.w = 1;
      res.attrs.h = 1;
      setFillAndStroke(res, {
        font: availableAttrs.font,
        stroke: "none",
        fill: "#000"
      });
      res.setBox();
      vml.canvas[appendChild](g);
      return res;
    };
    setSize = function(width, height) {
      var cs = this.canvas.style;
      width == +width && (width += "px");
      height == +height && (height += "px");
      cs.width = width;
      cs.height = height;
      cs.clip = "rect(0 " + width + " " + height + " 0)";
      return this;
    };
    var createNode;
    doc.createStyleSheet().addRule(".rvml", "behavior:url(#default#VML)");
    try {
      !doc.namespaces.rvml && doc.namespaces.add("rvml", "urn:schemas-microsoft-com:vml");
      createNode = function(tagName) {
        return doc.createElement('<rvml:' + tagName + ' class="rvml">');
      };
    } catch (e) {
      createNode = function(tagName) {
        return doc.createElement('<' + tagName + ' xmlns="urn:schemas-microsoft.com:vml" class="rvml">');
      };
    }
    create = function() {
      var con = getContainer[apply](0, arguments),
        container = con.container,
        height = con.height,
        s, width = con.width,
        x = con.x,
        y = con.y;
      if (!container) {
        throw new Error("VML container not found.");
      }
      var res = new Paper,
        c = res.canvas = doc.createElement("div"),
        cs = c.style;
      x = x || 0;
      y = y || 0;
      width = width || 512;
      height = height || 342;
      width == +width && (width += "px");
      height == +height && (height += "px");
      res.width = 1e3;
      res.height = 1e3;
      res.coordsize = zoom * 1e3 + S + zoom * 1e3;
      res.coordorigin = "0 0";
      res.span = doc.createElement("span");
      res.span.style.cssText = "position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;";
      c[appendChild](res.span);
      cs.cssText = R.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden", width, height);
      if (container == 1) {
        doc.body[appendChild](c);
        cs.left = x + "px";
        cs.top = y + "px";
        cs.position = "absolute";
      } else {
        if (container.firstChild) {
          container.insertBefore(c, container.firstChild);
        } else {
          container[appendChild](c);
        }
      }
      plugins.call(res, res, R.fn);
      return res;
    };
    paperproto.clear = function() {
      this.canvas.innerHTML = E;
      this.span = doc.createElement("span");
      this.span.style.cssText = "position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;";
      this.canvas[appendChild](this.span);
      this.bottom = this.top = null;
    };
    paperproto.remove = function() {
      this.canvas.parentNode.removeChild(this.canvas);
      for (var i in this) {
        this[i] = removed(i);
      }
      return true;
    };
  }
  var version = navigator.userAgent.match(/Version\/(.*?)\s/);
  if ((navigator.vendor == "Apple Computer, Inc.") && (version && version[1] < 4 || navigator.platform.slice(0, 2) == "iP")) {
    paperproto.safari = function() {
      var rect = this.rect(-99, -99, this.width + 99, this.height + 99).attr({
        stroke: "none"
      });
      win.setTimeout(function() {
        rect.remove();
      });
    };
  } else {
    paperproto.safari = function() {};
  }
  var preventDefault = function() {
      this.returnValue = false;
    },
    preventTouch = function() {
      return this.originalEvent.preventDefault();
    },
    stopPropagation = function() {
      this.cancelBubble = true;
    },
    stopTouch = function() {
      return this.originalEvent.stopPropagation();
    },
    addEvent = (function() {
      if (doc.addEventListener) {
        return function(obj, type, fn, element) {
          var realName = supportsTouch && touchMap[type] ? touchMap[type] : type;
          var f = function(e) {
            if (supportsTouch && touchMap[has](type)) {
              for (var i = 0, ii = e.targetTouches && e.targetTouches.length; i < ii; i++) {
                if (e.targetTouches[i].target == obj) {
                  var olde = e;
                  e = e.targetTouches[i];
                  e.originalEvent = olde;
                  e.preventDefault = preventTouch;
                  e.stopPropagation = stopTouch;
                  break;
                }
              }
            }
            return fn.call(element, e);
          };
          obj.addEventListener(realName, f, false);
          return function() {
            obj.removeEventListener(realName, f, false);
            return true;
          };
        };
      } else if (doc.attachEvent) {
        return function(obj, type, fn, element) {
          var f = function(e) {
            e = e || win.event;
            e.preventDefault = e.preventDefault || preventDefault;
            e.stopPropagation = e.stopPropagation || stopPropagation;
            return fn.call(element, e);
          };
          obj.attachEvent("on" + type, f);
          var detacher = function() {
            obj.detachEvent("on" + type, f);
            return true;
          };
          return detacher;
        };
      }
    })(),
    drag = [],
    dragMove = function(e) {
      var x = e.clientX,
        y = e.clientY,
        scrollY = doc.documentElement.scrollTop || doc.body.scrollTop,
        scrollX = doc.documentElement.scrollLeft || doc.body.scrollLeft,
        dragi, j = drag.length;
      while (j--) {
        dragi = drag[j];
        if (supportsTouch) {
          var i = e.touches.length,
            touch;
          while (i--) {
            touch = e.touches[i];
            if (touch.identifier == dragi.el._drag.id) {
              x = touch.clientX;
              y = touch.clientY;
              (e.originalEvent ? e.originalEvent : e).preventDefault();
              break;
            }
          }
        } else {
          e.preventDefault();
        }
        x += scrollX;
        y += scrollY;
        dragi.move && dragi.move.call(dragi.move_scope || dragi.el, x - dragi.el._drag.x, y - dragi.el._drag.y, x, y, e);
      }
    },
    dragUp = function(e) {
      R.unmousemove(dragMove).unmouseup(dragUp);
      var i = drag.length,
        dragi;
      while (i--) {
        dragi = drag[i];
        dragi.el._drag = {};
        dragi.end && dragi.end.call(dragi.end_scope || dragi.start_scope || dragi.move_scope || dragi.el, e);
      }
      drag = [];
    };
  for (var i = events[length]; i--;) {
    (function(eventName) {
      R[eventName] = Element[proto][eventName] = function(fn, scope) {
        if (R.is(fn, "function")) {
          this.events = this.events || [];
          this.events.push({
            name: eventName,
            f: fn,
            unbind: addEvent(this.shape || this.node || doc, eventName, fn, scope || this)
          });
        }
        return this;
      };
      R["un" + eventName] = Element[proto]["un" + eventName] = function(fn) {
        var events = this.events,
          l = events[length];
        while (l--)
          if (events[l].name == eventName && events[l].f == fn) {
            events[l].unbind();
            events.splice(l, 1);
            !events.length && delete this.events;
            return this;
          }
        return this;
      };
    })(events[i]);
  }
  elproto.hover = function(f_in, f_out, scope_in, scope_out) {
    return this.mouseover(f_in, scope_in).mouseout(f_out, scope_out || scope_in);
  };
  elproto.unhover = function(f_in, f_out) {
    return this.unmouseover(f_in).unmouseout(f_out);
  };
  elproto.drag = function(onmove, onstart, onend, move_scope, start_scope, end_scope) {
    this._drag = {};
    this.mousedown(function(e) {
      (e.originalEvent || e).preventDefault();
      var scrollY = doc.documentElement.scrollTop || doc.body.scrollTop,
        scrollX = doc.documentElement.scrollLeft || doc.body.scrollLeft;
      this._drag.x = e.clientX + scrollX;
      this._drag.y = e.clientY + scrollY;
      this._drag.id = e.identifier;
      onstart && onstart.call(start_scope || move_scope || this, e.clientX + scrollX, e.clientY + scrollY, e);
      !drag.length && R.mousemove(dragMove).mouseup(dragUp);
      drag.push({
        el: this,
        move: onmove,
        end: onend,
        move_scope: move_scope,
        start_scope: start_scope,
        end_scope: end_scope
      });
    });
    return this;
  };
  elproto.undrag = function(onmove, onstart, onend) {
    var i = drag.length;
    while (i--) {
      drag[i].el == this && (drag[i].move == onmove && drag[i].end == onend) && drag.splice(i++, 1);
    }!drag.length && R.unmousemove(dragMove).unmouseup(dragUp);
  };
  paperproto.circle = function(x, y, r) {
    return theCircle(this, x || 0, y || 0, r || 0);
  };
  paperproto.rect = function(x, y, w, h, r) {
    return theRect(this, x || 0, y || 0, w || 0, h || 0, r || 0);
  };
  paperproto.ellipse = function(x, y, rx, ry) {
    return theEllipse(this, x || 0, y || 0, rx || 0, ry || 0);
  };
  paperproto.path = function(pathString) {
    pathString && !R.is(pathString, string) && !R.is(pathString[0], array) && (pathString += E);
    return thePath(R.format[apply](R, arguments), this);
  };
  paperproto.image = function(src, x, y, w, h) {
    return theImage(this, src || "about:blank", x || 0, y || 0, w || 0, h || 0);
  };
  paperproto.text = function(x, y, text) {
    return theText(this, x || 0, y || 0, Str(text));
  };
  paperproto.set = function(itemsArray) {
    arguments[length] > 1 && (itemsArray = Array[proto].splice.call(arguments, 0, arguments[length]));
    return new Set(itemsArray);
  };
  paperproto.setSize = setSize;
  paperproto.top = paperproto.bottom = null;
  paperproto.raphael = R;

  function x_y() {
    return this.x + S + this.y;
  }
  elproto.resetScale = function() {
    if (this.removed) {
      return this;
    }
    this._.sx = 1;
    this._.sy = 1;
    this.attrs.scale = "1 1";
  };
  elproto.scale = function(x, y, cx, cy) {
    if (this.removed) {
      return this;
    }
    if (x == null && y == null) {
      return {
        x: this._.sx,
        y: this._.sy,
        toString: x_y
      };
    }
    y = y || x;
    !+y && (y = x);
    var dx, dy, dcx, dcy, a = this.attrs;
    if (x != 0) {
      var bb = this.getBBox(),
        rcx = bb.x + bb.width / 2,
        rcy = bb.y + bb.height / 2,
        kx = abs(x / this._.sx),
        ky = abs(y / this._.sy);
      cx = (+cx || cx == 0) ? cx : rcx;
      cy = (+cy || cy == 0) ? cy : rcy;
      var posx = this._.sx > 0,
        posy = this._.sy > 0,
        dirx = ~~(x / abs(x)),
        diry = ~~(y / abs(y)),
        dkx = kx * dirx,
        dky = ky * diry,
        s = this.node.style,
        ncx = cx + abs(rcx - cx) * dkx * (rcx > cx == posx ? 1 : -1),
        ncy = cy + abs(rcy - cy) * dky * (rcy > cy == posy ? 1 : -1),
        fr = (x * dirx > y * diry ? ky : kx);
      switch (this.type) {
        case "rect":
        case "image":
          var neww = a.width * kx,
            newh = a.height * ky;
          this.attr({
            height: newh,
            r: a.r * fr,
            width: neww,
            x: ncx - neww / 2,
            y: ncy - newh / 2
          });
          break;
        case "circle":
        case "ellipse":
          this.attr({
            rx: a.rx * kx,
            ry: a.ry * ky,
            r: a.r * fr,
            cx: ncx,
            cy: ncy
          });
          break;
        case "text":
          this.attr({
            x: ncx,
            y: ncy
          });
          break;
        case "path":
          var path = pathToRelative(a.path),
            skip = true,
            fx = posx ? dkx : kx,
            fy = posy ? dky : ky;
          for (var i = 0, ii = path[length]; i < ii; i++) {
            var p = path[i],
              P0 = upperCase.call(p[0]);
            if (P0 == "M" && skip) {
              continue;
            } else {
              skip = false;
            }
            if (P0 == "A") {
              p[path[i][length] - 2] *= fx;
              p[path[i][length] - 1] *= fy;
              p[1] *= kx;
              p[2] *= ky;
              p[5] = +(dirx + diry ? !!+p[5] : !+p[5]);
            } else if (P0 == "H") {
              for (var j = 1, jj = p[length]; j < jj; j++) {
                p[j] *= fx;
              }
            } else if (P0 == "V") {
              for (j = 1, jj = p[length]; j < jj; j++) {
                p[j] *= fy;
              }
            } else {
              for (j = 1, jj = p[length]; j < jj; j++) {
                p[j] *= (j % 2) ? fx : fy;
              }
            }
          }
          var dim2 = pathDimensions(path);
          dx = ncx - dim2.x - dim2.width / 2;
          dy = ncy - dim2.y - dim2.height / 2;
          path[0][1] += dx;
          path[0][2] += dy;
          this.attr({
            path: path
          });
          break;
      }
      if (this.type in {
          text: 1,
          image: 1
        } && (dirx != 1 || diry != 1)) {
        if (this.transformations) {
          this.transformations[2] = "scale(" [concat](dirx, ",", diry, ")");
          this.node[setAttribute]("transform", this.transformations[join](S));
          dx = (dirx == -1) ? -a.x - (neww || 0) : a.x;
          dy = (diry == -1) ? -a.y - (newh || 0) : a.y;
          this.attr({
            x: dx,
            y: dy
          });
          a.fx = dirx - 1;
          a.fy = diry - 1;
        } else {
          this.node.filterMatrix = ms + ".Matrix(M11=" [concat](dirx, ", M12=0, M21=0, M22=", diry, ", Dx=0, Dy=0, sizingmethod='auto expand', filtertype='bilinear')");
          s.filter = (this.node.filterMatrix || E) + (this.node.filterOpacity || E);
        }
      } else {
        if (this.transformations) {
          this.transformations[2] = E;
          this.node[setAttribute]("transform", this.transformations[join](S));
          a.fx = 0;
          a.fy = 0;
        } else {
          this.node.filterMatrix = E;
          s.filter = (this.node.filterMatrix || E) + (this.node.filterOpacity || E);
        }
      }
      a.scale = [x, y, cx, cy][join](S);
      this._.sx = x;
      this._.sy = y;
    }
    return this;
  };
  elproto.clone = function() {
    if (this.removed) {
      return null;
    }
    var attr = this.attr();
    delete attr.scale;
    delete attr.translation;
    return this.paper[this.type]().attr(attr);
  };
  var curveslengths = {},
    getPointAtSegmentLength = function(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, length) {
      if (p1x === c1x && p1y === c1y && c2x === p2x && c2y == p2y) {
        var dx = p2x - p1x,
          dy = p2y - p1y;
        var totalLength = Math.sqrt(dx * dx + dy * dy);
        if (length == null) {
          return totalLength;
        } else {
          var fract = length / totalLength;
          return {
            start: {
              x: p1x,
              y: p1y
            },
            m: {
              x: p1x,
              y: p1y
            },
            n: {
              x: p2x,
              y: p2y
            },
            end: {
              x: p2x,
              y: p2y
            },
            x: p1x + fract * dx,
            y: p1y + fract * dy,
            alpha: (90 - math.atan(dx / dy) * 180 / PI)
          };
        }
      }
      var len = 0,
        precision = 100,
        name = [p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y].join(),
        cache = curveslengths[name],
        old, dot;
      !cache && (curveslengths[name] = cache = {
        data: []
      });
      cache.timer && clearTimeout(cache.timer);
      cache.timer = setTimeout(function() {
        delete curveslengths[name];
      }, 2000);
      if (length != null) {
        var total = getPointAtSegmentLength(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y);
        precision = ~~total * 10;
      }
      for (var i = 0; i < precision + 1; i++) {
        if (cache.data[length] > i) {
          dot = cache.data[i * precision];
        } else {
          dot = R.findDotsAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, i / precision);
          cache.data[i] = dot;
        }
        i && (len += pow(pow(old.x - dot.x, 2) + pow(old.y - dot.y, 2), .5));
        if (length != null && len >= length) {
          return dot;
        }
        old = dot;
      }
      if (length == null) {
        return len;
      }
    },
    getLengthFactory = function(istotal, subpath) {
      return function(path, length, onlystart) {
        path = path2curve(path);
        var x, y, p, l, sp = "",
          subpaths = {},
          point, len = 0;
        for (var i = 0, ii = path.length; i < ii; i++) {
          p = path[i];
          if (p[0] == "M") {
            x = +p[1];
            y = +p[2];
          } else {
            l = getPointAtSegmentLength(x, y, p[1], p[2], p[3], p[4], p[5], p[6]);
            if (len + l > length) {
              if (subpath && !subpaths.start) {
                point = getPointAtSegmentLength(x, y, p[1], p[2], p[3], p[4], p[5], p[6], length - len);
                sp += ["C", point.start.x, point.start.y, point.m.x, point.m.y, point.x, point.y];
                if (onlystart) {
                  return sp;
                }
                subpaths.start = sp;
                sp = ["M", point.x, point.y + "C", point.n.x, point.n.y, point.end.x, point.end.y, p[5], p[6]][join]();
                len += l;
                x = +p[5];
                y = +p[6];
                continue;
              }
              if (!istotal && !subpath) {
                point = getPointAtSegmentLength(x, y, p[1], p[2], p[3], p[4], p[5], p[6], length - len);
                return {
                  x: point.x,
                  y: point.y,
                  alpha: point.alpha
                };
              }
            }
            len += l;
            x = +p[5];
            y = +p[6];
          }
          sp += p;
        }
        subpaths.end = sp;
        point = istotal ? len : subpath ? subpaths : R.findDotsAtSegment(x, y, p[1], p[2], p[3], p[4], p[5], p[6], 1);
        point.alpha && (point = {
          x: point.x,
          y: point.y,
          alpha: point.alpha
        });
        return point;
      };
    };
  var getTotalLength = getLengthFactory(1),
    getPointAtLength = getLengthFactory(),
    getSubpathsAtLength = getLengthFactory(0, 1);
  elproto.getTotalLength = function() {
    if (this.type != "path") {
      return;
    }
    if (this.node.getTotalLength) {
      return this.node.getTotalLength();
    }
    return getTotalLength(this.attrs.path);
  };
  elproto.getPointAtLength = function(length) {
    if (this.type != "path") {
      return;
    }
    return getPointAtLength(this.attrs.path, length);
  };
  elproto.getSubpath = function(from, to) {
    if (this.type != "path") {
      return;
    }
    if (abs(this.getTotalLength() - to) < "1e-6") {
      return getSubpathsAtLength(this.attrs.path, from).end;
    }
    var a = getSubpathsAtLength(this.attrs.path, to, 1);
    return from ? getSubpathsAtLength(a, from).end : a;
  };
  R.easing_formulas = {
    linear: function(n) {
      return n;
    },
    "<": function(n) {
      return pow(n, 3);
    },
    ">": function(n) {
      return pow(n - 1, 3) + 1;
    },
    "<>": function(n) {
      n = n * 2;
      if (n < 1) {
        return pow(n, 3) / 2;
      }
      n -= 2;
      return (pow(n, 3) + 2) / 2;
    },
    backIn: function(n) {
      var s = 1.70158;
      return n * n * ((s + 1) * n - s);
    },
    backOut: function(n) {
      n = n - 1;
      var s = 1.70158;
      return n * n * ((s + 1) * n + s) + 1;
    },
    elastic: function(n) {
      if (n == 0 || n == 1) {
        return n;
      }
      var p = .3,
        s = p / 4;
      return pow(2, -10 * n) * math.sin((n - s) * (2 * PI) / p) + 1;
    },
    bounce: function(n) {
      var s = 7.5625,
        p = 2.75,
        l;
      if (n < (1 / p)) {
        l = s * n * n;
      } else {
        if (n < (2 / p)) {
          n -= (1.5 / p);
          l = s * n * n + .75;
        } else {
          if (n < (2.5 / p)) {
            n -= (2.25 / p);
            l = s * n * n + .9375;
          } else {
            n -= (2.625 / p);
            l = s * n * n + .984375;
          }
        }
      }
      return l;
    }
  };
  var animationElements = [],
    animation = function() {
      var Now = +new Date;
      for (var l = 0; l < animationElements[length]; l++) {
        var e = animationElements[l];
        if (e.stop || e.el.removed) {
          continue;
        }
        var time = Now - e.start,
          ms = e.ms,
          easing = e.easing,
          from = e.from,
          diff = e.diff,
          to = e.to,
          t = e.t,
          that = e.el,
          set = {},
          now;
        if (time < ms) {
          var pos = easing(time / ms);
          for (var attr in from)
            if (from[has](attr)) {
              switch (availableAnimAttrs[attr]) {
                case "along":
                  now = pos * ms * diff[attr];
                  to.back && (now = to.len - now);
                  var point = getPointAtLength(to[attr], now);
                  that.translate(diff.sx - diff.x || 0, diff.sy - diff.y || 0);
                  diff.x = point.x;
                  diff.y = point.y;
                  that.translate(point.x - diff.sx, point.y - diff.sy);
                  to.rot && that.rotate(diff.r + point.alpha, point.x, point.y);
                  break;
                case nu:
                  now = +from[attr] + pos * ms * diff[attr];
                  break;
                case "colour":
                  now = "rgb(" + [upto255(round(from[attr].r + pos * ms * diff[attr].r)), upto255(round(from[attr].g + pos * ms * diff[attr].g)), upto255(round(from[attr].b + pos * ms * diff[attr].b))][join](",") + ")";
                  break;
                case "path":
                  now = [];
                  for (var i = 0, ii = from[attr][length]; i < ii; i++) {
                    now[i] = [from[attr][i][0]];
                    for (var j = 1, jj = from[attr][i][length]; j < jj; j++) {
                      now[i][j] = +from[attr][i][j] + pos * ms * diff[attr][i][j];
                    }
                    now[i] = now[i][join](S);
                  }
                  now = now[join](S);
                  break;
                case "csv":
                  switch (attr) {
                    case "translation":
                      var x = pos * ms * diff[attr][0] - t.x,
                        y = pos * ms * diff[attr][1] - t.y;
                      t.x += x;
                      t.y += y;
                      now = x + S + y;
                      break;
                    case "rotation":
                      now = +from[attr][0] + pos * ms * diff[attr][0];
                      from[attr][1] && (now += "," + from[attr][1] + "," + from[attr][2]);
                      break;
                    case "scale":
                      now = [+from[attr][0] + pos * ms * diff[attr][0], +from[attr][1] + pos * ms * diff[attr][1], (2 in to[attr] ? to[attr][2] : E), (3 in to[attr] ? to[attr][3] : E)][join](S);
                      break;
                    case "clip-rect":
                      now = [];
                      i = 4;
                      while (i--) {
                        now[i] = +from[attr][i] + pos * ms * diff[attr][i];
                      }
                      break;
                  }
                  break;
                default:
                  var from2 = [].concat(from[attr]);
                  now = [];
                  i = that.paper.customAttributes[attr].length;
                  while (i--) {
                    now[i] = +from2[i] + pos * ms * diff[attr][i];
                  }
                  break;
              }
              set[attr] = now;
            }
          that.attr(set);
          that._run && that._run.call(that);
        } else {
          if (to.along) {
            point = getPointAtLength(to.along, to.len * !to.back);
            that.translate(diff.sx - (diff.x || 0) + point.x - diff.sx, diff.sy - (diff.y || 0) + point.y - diff.sy);
            to.rot && that.rotate(diff.r + point.alpha, point.x, point.y);
          }
          (t.x || t.y) && that.translate(-t.x, -t.y);
          to.scale && (to.scale += E);
          that.attr(to);
          animationElements.splice(l--, 1);
        }
      }
      R.svg && that && that.paper && that.paper.safari();
      animationElements[length] && setTimeout(animation);
    },
    keyframesRun = function(attr, element, time, prev, prevcallback) {
      var dif = time - prev;
      element.timeouts.push(setTimeout(function() {
        R.is(prevcallback, "function") && prevcallback.call(element);
        element.animate(attr, dif, attr.easing);
      }, prev));
    },
    upto255 = function(color) {
      return mmax(mmin(color, 255), 0);
    },
    translate = function(x, y) {
      if (x == null) {
        return {
          x: this._.tx,
          y: this._.ty,
          toString: x_y
        };
      }
      this._.tx += +x;
      this._.ty += +y;
      switch (this.type) {
        case "circle":
        case "ellipse":
          this.attr({
            cx: +x + this.attrs.cx,
            cy: +y + this.attrs.cy
          });
          break;
        case "rect":
        case "image":
        case "text":
          this.attr({
            x: +x + this.attrs.x,
            y: +y + this.attrs.y
          });
          break;
        case "path":
          var path = pathToRelative(this.attrs.path);
          path[0][1] += +x;
          path[0][2] += +y;
          this.attr({
            path: path
          });
          break;
      }
      return this;
    };
  elproto.animateWith = function(element, params, ms, easing, callback) {
    for (var i = 0, ii = animationElements.length; i < ii; i++) {
      if (animationElements[i].el.id == element.id) {
        params.start = animationElements[i].start;
      }
    }
    return this.animate(params, ms, easing, callback);
  };
  elproto.animateAlong = along();
  elproto.animateAlongBack = along(1);

  function along(isBack) {
    return function(path, ms, rotate, callback) {
      var params = {
        back: isBack
      };
      R.is(rotate, "function") ? (callback = rotate) : (params.rot = rotate);
      path && path.constructor == Element && (path = path.attrs.path);
      path && (params.along = path);
      return this.animate(params, ms, callback);
    };
  }

  function CubicBezierAtTime(t, p1x, p1y, p2x, p2y, duration) {
    var cx = 3 * p1x,
      bx = 3 * (p2x - p1x) - cx,
      ax = 1 - cx - bx,
      cy = 3 * p1y,
      by = 3 * (p2y - p1y) - cy,
      ay = 1 - cy - by;

    function sampleCurveX(t) {
      return ((ax * t + bx) * t + cx) * t;
    }

    function solve(x, epsilon) {
      var t = solveCurveX(x, epsilon);
      return ((ay * t + by) * t + cy) * t;
    }

    function solveCurveX(x, epsilon) {
      var t0, t1, t2, x2, d2, i;
      for (t2 = x, i = 0; i < 8; i++) {
        x2 = sampleCurveX(t2) - x;
        if (abs(x2) < epsilon) {
          return t2;
        }
        d2 = (3 * ax * t2 + 2 * bx) * t2 + cx;
        if (abs(d2) < 1e-6) {
          break;
        }
        t2 = t2 - x2 / d2;
      }
      t0 = 0;
      t1 = 1;
      t2 = x;
      if (t2 < t0) {
        return t0;
      }
      if (t2 > t1) {
        return t1;
      }
      while (t0 < t1) {
        x2 = sampleCurveX(t2);
        if (abs(x2 - x) < epsilon) {
          return t2;
        }
        if (x > x2) {
          t0 = t2;
        } else {
          t1 = t2;
        }
        t2 = (t1 - t0) / 2 + t0;
      }
      return t2;
    }
    return solve(t, 1 / (200 * duration));
  }
  elproto.onAnimation = function(f) {
    this._run = f || 0;
    return this;
  };
  elproto.animate = function(params, ms, easing, callback) {
    var element = this;
    element.timeouts = element.timeouts || [];
    if (R.is(easing, "function") || !easing) {
      callback = easing || null;
    }
    if (element.removed) {
      callback && callback.call(element);
      return element;
    }
    var from = {},
      to = {},
      animateable = false,
      diff = {};
    for (var attr in params)
      if (params[has](attr)) {
        if (availableAnimAttrs[has](attr) || element.paper.customAttributes[has](attr)) {
          animateable = true;
          from[attr] = element.attr(attr);
          (from[attr] == null) && (from[attr] = availableAttrs[attr]);
          to[attr] = params[attr];
          switch (availableAnimAttrs[attr]) {
            case "along":
              var len = getTotalLength(params[attr]);
              var point = getPointAtLength(params[attr], len * !!params.back);
              var bb = element.getBBox();
              diff[attr] = len / ms;
              diff.tx = bb.x;
              diff.ty = bb.y;
              diff.sx = point.x;
              diff.sy = point.y;
              to.rot = params.rot;
              to.back = params.back;
              to.len = len;
              params.rot && (diff.r = toFloat(element.rotate()) || 0);
              break;
            case nu:
              diff[attr] = (to[attr] - from[attr]) / ms;
              break;
            case "colour":
              from[attr] = R.getRGB(from[attr]);
              var toColour = R.getRGB(to[attr]);
              diff[attr] = {
                r: (toColour.r - from[attr].r) / ms,
                g: (toColour.g - from[attr].g) / ms,
                b: (toColour.b - from[attr].b) / ms
              };
              break;
            case "path":
              var pathes = path2curve(from[attr], to[attr]);
              from[attr] = pathes[0];
              var toPath = pathes[1];
              diff[attr] = [];
              for (var i = 0, ii = from[attr][length]; i < ii; i++) {
                diff[attr][i] = [0];
                for (var j = 1, jj = from[attr][i][length]; j < jj; j++) {
                  diff[attr][i][j] = (toPath[i][j] - from[attr][i][j]) / ms;
                }
              }
              break;
            case "csv":
              var values = Str(params[attr])[split](separator),
                from2 = Str(from[attr])[split](separator);
              switch (attr) {
                case "translation":
                  from[attr] = [0, 0];
                  diff[attr] = [values[0] / ms, values[1] / ms];
                  break;
                case "rotation":
                  from[attr] = (from2[1] == values[1] && from2[2] == values[2]) ? from2 : [0, values[1], values[2]];
                  diff[attr] = [(values[0] - from[attr][0]) / ms, 0, 0];
                  break;
                case "scale":
                  params[attr] = values;
                  from[attr] = Str(from[attr])[split](separator);
                  diff[attr] = [(values[0] - from[attr][0]) / ms, (values[1] - from[attr][1]) / ms, 0, 0];
                  break;
                case "clip-rect":
                  from[attr] = Str(from[attr])[split](separator);
                  diff[attr] = [];
                  i = 4;
                  while (i--) {
                    diff[attr][i] = (values[i] - from[attr][i]) / ms;
                  }
                  break;
              }
              to[attr] = values;
              break;
            default:
              values = [].concat(params[attr]);
              from2 = [].concat(from[attr]);
              diff[attr] = [];
              i = element.paper.customAttributes[attr][length];
              while (i--) {
                diff[attr][i] = ((values[i] || 0) - (from2[i] || 0)) / ms;
              }
              break;
          }
        }
      }
    if (!animateable) {
      var attrs = [],
        lastcall;
      for (var key in params)
        if (params[has](key) && animKeyFrames.test(key)) {
          attr = {
            value: params[key]
          };
          key == "from" && (key = 0);
          key == "to" && (key = 100);
          attr.key = toInt(key, 10);
          attrs.push(attr);
        }
      attrs.sort(sortByKey);
      if (attrs[0].key) {
        attrs.unshift({
          key: 0,
          value: element.attrs
        });
      }
      for (i = 0, ii = attrs[length]; i < ii; i++) {
        keyframesRun(attrs[i].value, element, ms / 100 * attrs[i].key, ms / 100 * (attrs[i - 1] && attrs[i - 1].key || 0), attrs[i - 1] && attrs[i - 1].value.callback);
      }
      lastcall = attrs[attrs[length] - 1].value.callback;
      if (lastcall) {
        element.timeouts.push(setTimeout(function() {
          lastcall.call(element);
        }, ms));
      }
    } else {
      var easyeasy = R.easing_formulas[easing];
      if (!easyeasy) {
        easyeasy = Str(easing).match(bezierrg);
        if (easyeasy && easyeasy[length] == 5) {
          var curve = easyeasy;
          easyeasy = function(t) {
            return CubicBezierAtTime(t, +curve[1], +curve[2], +curve[3], +curve[4], ms);
          };
        } else {
          easyeasy = function(t) {
            return t;
          };
        }
      }
      animationElements.push({
        start: params.start || +new Date,
        ms: ms,
        easing: easyeasy,
        from: from,
        diff: diff,
        to: to,
        el: element,
        t: {
          x: 0,
          y: 0
        }
      });
      R.is(callback, "function") && (element._ac = setTimeout(function() {
        callback.call(element);
      }, ms));
      animationElements[length] == 1 && setTimeout(animation);
    }
    return this;
  };
  elproto.stop = function() {
    for (var i = 0; i < animationElements.length; i++) {
      animationElements[i].el.id == this.id && animationElements.splice(i--, 1);
    }
    for (i = 0, ii = this.timeouts && this.timeouts.length; i < ii; i++) {
      clearTimeout(this.timeouts[i]);
    }
    this.timeouts = [];
    clearTimeout(this._ac);
    delete this._ac;
    return this;
  };
  elproto.translate = function(x, y) {
    return this.attr({
      translation: x + " " + y
    });
  };
  elproto[toString] = function() {
    return "Rapha\xebl\u2019s object";
  };
  R.ae = animationElements;
  var Set = function(items) {
    this.items = [];
    this[length] = 0;
    this.type = "set";
    if (items) {
      for (var i = 0, ii = items[length]; i < ii; i++) {
        if (items[i] && (items[i].constructor == Element || items[i].constructor == Set)) {
          this[this.items[length]] = this.items[this.items[length]] = items[i];
          this[length]++;
        }
      }
    }
  };
  Set[proto][push] = function() {
    var item, len;
    for (var i = 0, ii = arguments[length]; i < ii; i++) {
      item = arguments[i];
      if (item && (item.constructor == Element || item.constructor == Set)) {
        len = this.items[length];
        this[len] = this.items[len] = item;
        this[length]++;
      }
    }
    return this;
  };
  Set[proto].pop = function() {
    delete this[this[length]--];
    return this.items.pop();
  };
  for (var method in elproto)
    if (elproto[has](method)) {
      Set[proto][method] = (function(methodname) {
        return function() {
          for (var i = 0, ii = this.items[length]; i < ii; i++) {
            this.items[i][methodname][apply](this.items[i], arguments);
          }
          return this;
        };
      })(method);
    }
  Set[proto].attr = function(name, value) {
    if (name && R.is(name, array) && R.is(name[0], "object")) {
      for (var j = 0, jj = name[length]; j < jj; j++) {
        this.items[j].attr(name[j]);
      }
    } else {
      for (var i = 0, ii = this.items[length]; i < ii; i++) {
        this.items[i].attr(name, value);
      }
    }
    return this;
  };
  Set[proto].animate = function(params, ms, easing, callback) {
    (R.is(easing, "function") || !easing) && (callback = easing || null);
    var len = this.items[length],
      i = len,
      item, set = this,
      collector;
    callback && (collector = function() {
      !--len && callback.call(set);
    });
    easing = R.is(easing, string) ? easing : collector;
    item = this.items[--i].animate(params, ms, easing, collector);
    while (i--) {
      this.items[i] && !this.items[i].removed && this.items[i].animateWith(item, params, ms, easing, collector);
    }
    return this;
  };
  Set[proto].insertAfter = function(el) {
    var i = this.items[length];
    while (i--) {
      this.items[i].insertAfter(el);
    }
    return this;
  };
  Set[proto].getBBox = function() {
    var x = [],
      y = [],
      w = [],
      h = [];
    for (var i = this.items[length]; i--;) {
      var box = this.items[i].getBBox();
      x[push](box.x);
      y[push](box.y);
      w[push](box.x + box.width);
      h[push](box.y + box.height);
    }
    x = mmin[apply](0, x);
    y = mmin[apply](0, y);
    return {
      x: x,
      y: y,
      width: mmax[apply](0, w) - x,
      height: mmax[apply](0, h) - y
    };
  };
  Set[proto].clone = function(s) {
    s = new Set;
    for (var i = 0, ii = this.items[length]; i < ii; i++) {
      s[push](this.items[i].clone());
    }
    return s;
  };
  R.registerFont = function(font) {
    if (!font.face) {
      return font;
    }
    this.fonts = this.fonts || {};
    var fontcopy = {
        w: font.w,
        face: {},
        glyphs: {}
      },
      family = font.face["font-family"];
    for (var prop in font.face)
      if (font.face[has](prop)) {
        fontcopy.face[prop] = font.face[prop];
      }
    if (this.fonts[family]) {
      this.fonts[family][push](fontcopy);
    } else {
      this.fonts[family] = [fontcopy];
    }
    if (!font.svg) {
      fontcopy.face["units-per-em"] = toInt(font.face["units-per-em"], 10);
      for (var glyph in font.glyphs)
        if (font.glyphs[has](glyph)) {
          var path = font.glyphs[glyph];
          fontcopy.glyphs[glyph] = {
            w: path.w,
            k: {},
            d: path.d && "M" + path.d[rp](/[mlcxtrv]/g, function(command) {
              return {
                l: "L",
                c: "C",
                x: "z",
                t: "m",
                r: "l",
                v: "c"
              } [command] || "M";
            }) + "z"
          };
          if (path.k) {
            for (var k in path.k)
              if (path[has](k)) {
                fontcopy.glyphs[glyph].k[k] = path.k[k];
              }
          }
        }
    }
    return font;
  };
  paperproto.getFont = function(family, weight, style, stretch) {
    stretch = stretch || "normal";
    style = style || "normal";
    weight = +weight || {
      normal: 400,
      bold: 700,
      lighter: 300,
      bolder: 800
    } [weight] || 400;
    if (!R.fonts) {
      return;
    }
    var font = R.fonts[family];
    if (!font) {
      var name = new RegExp("(^|\\s)" + family[rp](/[^\w\d\s+!~.:_-]/g, E) + "(\\s|$)", "i");
      for (var fontName in R.fonts)
        if (R.fonts[has](fontName)) {
          if (name.test(fontName)) {
            font = R.fonts[fontName];
            break;
          }
        }
    }
    var thefont;
    if (font) {
      for (var i = 0, ii = font[length]; i < ii; i++) {
        thefont = font[i];
        if (thefont.face["font-weight"] == weight && (thefont.face["font-style"] == style || !thefont.face["font-style"]) && thefont.face["font-stretch"] == stretch) {
          break;
        }
      }
    }
    return thefont;
  };
  paperproto.print = function(x, y, string, font, size, origin, letter_spacing) {
    origin = origin || "middle";
    letter_spacing = mmax(mmin(letter_spacing || 0, 1), -1);
    var out = this.set(),
      letters = Str(string)[split](E),
      shift = 0,
      path = E,
      scale;
    R.is(font, string) && (font = this.getFont(font));
    if (font) {
      scale = (size || 16) / font.face["units-per-em"];
      var bb = font.face.bbox.split(separator),
        top = +bb[0],
        height = +bb[1] + (origin == "baseline" ? bb[3] - bb[1] + (+font.face.descent) : (bb[3] - bb[1]) / 2);
      for (var i = 0, ii = letters[length]; i < ii; i++) {
        var prev = i && font.glyphs[letters[i - 1]] || {},
          curr = font.glyphs[letters[i]];
        shift += i ? (prev.w || font.w) + (prev.k && prev.k[letters[i]] || 0) + (font.w * letter_spacing) : 0;
        curr && curr.d && out[push](this.path(curr.d).attr({
          fill: "#000",
          stroke: "none",
          translation: [shift, 0]
        }));
      }
      out.scale(scale, scale, top, height).translate(x - top, y - height);
    }
    return out;
  };
  R.format = function(token, params) {
    var args = R.is(params, array) ? [0][concat](params) : arguments;
    token && R.is(token, string) && args[length] - 1 && (token = token[rp](formatrg, function(str, i) {
      return args[++i] == null ? E : args[i];
    }));
    return token || E;
  };
  R.ninja = function() {
    oldRaphael.was ? (win.Raphael = oldRaphael.is) : delete Raphael;
    return R;
  };
  R.el = elproto;
  R.st = Set[proto];
  oldRaphael.was ? (win.Raphael = R) : (Raphael = R);
})();
$(document).ready(function() {
  $("#scratchpad-show").click(function(e) {
    e.preventDefault();
    $("#scratchpad-wrapper").show();
    $("#scratchpad").show();
    $("#scratchtoolbox").show();
    $(".next-button").css("visibility", 'hidden');
    $(".content-progess").css("visibility", 'hidden');
    $(".content-lesson").css("visibility", 'hidden');
    $(".continue").css("visibility", 'hidden');
    $('.vl-gear-menu').hide();
    $('#vl-gear-icon').removeClass('gear-menu-active');
    if (!$("#scratchpad div").children().length) {
      pad = new DrawingScratchpad($("#scratchpad div")[0]);
    }
  });
  $(".mt-dialog-fancy-cross, .scratchpad-cross").click(function() {
    $(this).parents('.mt-dialog-fancy').hide();
    $("#scratchtoolbox").hide();
    $(".next-button").css("visibility", 'visible');
    $(".content-progess").css("visibility", 'visible');
    $(".content-lesson").css("visibility", 'visible');
    $(".continue").css("visibility", 'visible');
  });
});

function showScratchpad() {
  $("#scratchpad-wrapper").show();
  $("#scratchpad").show();
  $("#scratchtoolbox").show();
  $(".next-button").css("visibility", 'hidden');
  $(".content-progess").css("visibility", 'hidden');
  $(".content-lesson").css("visibility", 'hidden');
  $(".continue").css("visibility", 'hidden');
  if (!$("#scratchpad div").children().length) {
    pad = new DrawingScratchpad($("#scratchpad div")[0]);
  }
}

function DrawingScratchpad(elem) {
  var pen = "M25.31,2.872l-3.384-2.127c-0.854-0.536-1.979-0.278-2.517,0.576l-1.334,2.123l6.474,4.066l1.335-2.122C26.42,4.533,26.164,3.407,25.31,2.872zM6.555,21.786l6.474,4.066L23.581,9.054l-6.477-4.067L6.555,21.786zM5.566,26.952l-0.143,3.819l3.379-1.787l3.14-1.658l-6.246-3.925L5.566,26.952z";
  var clear = "M23.024,5.673c-1.744-1.694-3.625-3.051-5.168-3.236c-0.084-0.012-0.171-0.019-0.263-0.021H7.438c-0.162,0-0.322,0.063-0.436,0.18C6.889,2.71,6.822,2.87,6.822,3.033v25.75c0,0.162,0.063,0.317,0.18,0.435c0.117,0.116,0.271,0.179,0.436,0.179h18.364c0.162,0,0.317-0.062,0.434-0.179c0.117-0.117,0.182-0.272,0.182-0.435V11.648C26.382,9.659,24.824,7.49,23.024,5.673zM22.157,6.545c0.805,0.786,1.529,1.676,2.069,2.534c-0.468-0.185-0.959-0.322-1.42-0.431c-1.015-0.228-2.008-0.32-2.625-0.357c0.003-0.133,0.004-0.283,0.004-0.446c0-0.869-0.055-2.108-0.356-3.2c-0.003-0.01-0.005-0.02-0.009-0.03C20.584,5.119,21.416,5.788,22.157,6.545zM25.184,28.164H8.052V3.646h9.542v0.002c0.416-0.025,0.775,0.386,1.05,1.326c0.25,0.895,0.313,2.062,0.312,2.871c0.002,0.593-0.027,0.991-0.027,0.991l-0.049,0.652l0.656,0.007c0.003,0,1.516,0.018,3,0.355c1.426,0.308,2.541,0.922,2.645,1.617c0.004,0.062,0.005,0.124,0.004,0.182V28.164z";
  var erase = "M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248";
  var undo = "M12.981,9.073V6.817l-12.106,6.99l12.106,6.99v-2.422c3.285-0.002,9.052,0.28,9.052,2.269c0,2.78-6.023,4.263-6.023,4.263v2.132c0,0,13.53,0.463,13.53-9.823C29.54,9.134,17.952,8.831,12.981,9.073z";
  var accept = "M2.379,14.729 5.208,11.899 12.958,19.648 25.877,6.733 28.707,9.561 12.958,25.308";
  var mobilesafari = /AppleWebKit.*Mobile/.test(navigator.userAgent);
  var container = $(elem);
  var pad = Raphael(container[0], container.width(), container.height());
  this.resize = function() {
    pad.setSize(container.width(), container.height());
  };
  $("body").bind("selectstart", function(e) {
    return false;
  });
  var palette = pad.set(),
    stroke = "#000000",
    colors = ["#000000", "#3f3f3f", "#7f7f7f", "#bfbfbf", "#ff0000", "#ff7f00", "#ffff00", "#00ff00", "#00ffff", "#007fff", "#0000ff", "#7f00ff"];
  for (var i = 0; i < colors.length; i++) {
    (function(color) {
      var setcolor = function(e) {
        stroke = color;
        palette.animate({
          y: 7
        }, 100);
        this.animate({
          y: 15
        }, 100);
        penclick();
      };
      palette.push(pad.rect(90 + i * 24, 7, 24, 24).attr({
        fill: color,
        stroke: ""
      }).touchstart(setcolor).click(setcolor));
    })(colors[i]);
  }
  palette[0].attr({
    y: 15
  });
  var selected = pad.rect(2, 2, 30, 30).attr({
    r: 5,
    stroke: "",
    fill: "rgba(30, 157, 186, 0.5)"
  });
  var line_default = {
    "stroke-width": 2,
    "stroke-linecap": "round",
    "stroke-linejoin": "round"
  };
  var shapes = pad.set();
  var undoHistory = [
    []
  ];

  function saveState() {
    for (var i = 0, state = []; i < shapes.length; i++) {
      if (!shapes[i].removed) {
        if (shapes[i].type == "path") {
          state.push({
            path: shapes[i].attr("path").toString(),
            stroke: shapes[i].attr("stroke"),
            type: "path"
          });
        }
      }
    }
    undoHistory.push(state);
  }

  function loadState(state) {
    shapes.remove();
    for (var i = 0; i < state.length; i++) {
      if (state[i].type == "path") {
        shapes.push(pad.path(state[i].path).attr(line_default).attr("stroke", state[i].stroke));
      }
    }
  }
  var tools = pad.set();
  tools.push(pad.path(pen).scale(0.8).translate(0, 0));
  tools.push(pad.path(erase).translate(30, 0));
  tools.push(pad.path(undo).scale(0.7).translate(60, 1));
  var tool = "draw";

  function penclick() {
    selected.animate({
      x: 2
    }, 100);
    tool = "draw";
  }
  pad.rect(2, 2, 30, 30).attr({
    stroke: "",
    fill: "black",
    "fill-opacity": 0
  }).click(penclick).touchstart(penclick);

  function eraseclick() {
    selected.animate({
      x: 2 + 30
    }, 100);
    tool = "erase";
  }
  pad.rect(2 + 30, 2, 30, 30).attr({
    stroke: "",
    fill: "black",
    "fill-opacity": 0
  }).click(eraseclick).touchstart(eraseclick);

  function undoclick() {
    if (undoHistory.length) {
      loadState(undoHistory.pop());
    }
  }
  pad.rect(2 + 30 * 2, 2, 30, 30).attr({
    stroke: "",
    fill: "black",
    "fill-opacity": 0
  }).click(undoclick).touchstart(undoclick);
  tools.attr({
    fill: "#000",
    stroke: "none"
  });
  var path = null,
    pathstr = "";
  var eraser = null;

  function mousedown(X, Y, e) {
    if (!X || !Y || !e) return;
    if (eraser) {
      eraser.remove();
      eraser = null;
    }
    saveState();
    var startlen = shapes.length;
    if (Y > 40) {
      if (tool == "draw") {
        startPen(X, Y);
      } else if (tool == "erase") {
        eraser = pad.rect(X, Y, 0, 0).attr({
          "fill-opacity": 0.15,
          "stroke-opacity": 0.5,
          "fill": "#ff0000",
          "stroke": "#ff0000"
        });
        eraser.sx = X;
        eraser.sy = Y;
      }
    }
    if (shapes.length == startlen) {
      undoHistory.pop();
    }
  }

  function startPen(x, y) {
    path = pad.path("M" + x + "," + y).attr(line_default).attr({
      stroke: stroke
    });
    pathstr = path.attr("path");
    shapes.push(path);
  }

  function rectsIntersect(r1, r2) {
    return r2.x < (r1.x + r1.width) && (r2.x + r2.width) > r1.x && r2.y < (r1.y + r1.height) && (r2.y + r2.height) > r1.y;
  }

  function smoothPath(str) {
    var parts = str.toString().split("L");
    var start = parts[0].substr(1).split(",");
    var lastx = +start[0],
      lasty = +start[1];
    var np = parts[0];
    var lastdist = 0;
    for (var i = 1; i < parts.length; i++) {
      var p = parts[i].split(",");
      var dist = (Math.pow(+p[0] - lastx, 2) + Math.pow(+p[1] - lasty, 2));
      if (dist > 10 || dist < lastdist || i == parts.length - 1) {
        np += "L" + parts[i];
        lasty = p[1];
        lastx = p[0];
      }
      lastdist = dist;
    }
    return np;
  }

  function mouseup() {
    if (path) {
      path.attr("path", smoothPath(pathstr));
    }
    path = null;
    if (tool == "erase" && eraser) {
      saveState();
      var ebox = eraser.getBBox();
      for (var i = 0; i < shapes.length; i++) {
        if (rectsIntersect(ebox, shapes[i].getBBox())) {
          shapes[i].remove();
        }
      }
      eraser.animate({
        "fill-opacity": 0
      }, 100, function() {
        eraser.remove();
        eraser = null;
      });
    }
  }

  function mousemove(X, Y) {
    if (Y <= 40) return;
    if (path && tool == "draw") {
      pathstr += "L" + X + "," + Y;
      path.attr("path", pathstr);
    } else if (tool == "erase" && eraser) {
      var x1 = Math.min(X, eraser.sx),
        y1 = Math.min(Y, eraser.sy),
        x2 = Math.max(X, eraser.sx),
        y2 = Math.max(Y, eraser.sy);
      eraser.attr({
        x: x1,
        y: y1,
        width: x2 - x1,
        height: y2 - y1
      });
    }
  }
  container.mousemove(function(e) {
    var offset = $(container).offset();
    mousemove(e.pageX - offset.left, e.pageY - offset.top);
    e.preventDefault();
  });
  container.mousedown(function(e) {
    var offset = $(container).offset();
    mousedown(e.pageX - offset.left, e.pageY - offset.top, e);
    e.preventDefault();
    $(document).one("mouseup", function(e) {
      mouseup();
      e.preventDefault();
    });
  });
  container.bind("touchstart", function(e) {
    var offset = $(container).offset();
    var zoom = parseFloat($('html').css('zoom'));
    mousedown(e.originalEvent.touches[0].pageX / zoom - offset.left, e.originalEvent.touches[0].pageY / zoom - offset.top, e.originalEvent);
    e.preventDefault();
  });
  container.bind("touchmove", function(e) {
    var offset = $(container).offset();
    var zoom = parseFloat($('html').css('zoom'));
    mousemove(e.originalEvent.touches[0].pageX / zoom - offset.left, e.originalEvent.touches[0].pageY / zoom - offset.top);
    e.preventDefault();
  });
  container.bind("touchend", function(e) {
    mouseup();
    e.preventDefault();
  });
  this.clear = function() {
    shapes.remove();
    undoHistory = [
      []
    ];
  }
}
var dialogBoxZIndex = 100;

function ajaxDialog(title, ajaxurl, param) {
  if (param.hasOwnProperty('zIndex')) {
    dialogBoxZIndex = parseInt(param.zIndex);
  } else if (dialogBoxZIndex < (window['dialog'].zOrderDefault + window['dialog'].zorder)) {
    dialogBoxZIndex = parseInt(window['dialog'].zOrderDefault) + parseInt(window['dialog'].zorder);
  }
  window['dialog'].zorder += 2;
  var classFromTitle = (title.replace(/ /g, '-')).toLowerCase();
  if (classFromTitle.length > 0) classFromTitle += '-frame';
  var whereToPutElement = '';
  var innerWidth = 770;
  var dialog_class = '';
  if (param.hasOwnProperty('calledFrom')) {
    if (param.calledFrom == 'teacher') {
      whereToPutElement = 'body';
      innerWidth = 770;
      dialog_class = 'teacher-side-dialog';
    } else if (param.calledFrom == 'student') {
      whereToPutElement = 'body';
      innerWidth = $(window).width();
      dialog_class = 'student-side-dialog';
    } else if (param.calledFrom == 'parent') {
      whereToPutElement = 'body';
      innerWidth = 772;
      dialog_class = 'teacher-side-dialog';
    }
  }
  var screenHider = jQuery('<div id="' + classFromTitle + '-overlay" class="screenHiderX' + dialogBoxZIndex + '"></div>');
  screenHider.css({
    'display': 'none',
    'position': 'fixed',
    'left': '0',
    'top': '0',
    'background': 'none repeat scroll 0% 0% rgb(0, 0, 0)',
    'display': 'block',
    'opacity': '0.5',
    'width': '100%',
    'height': '100%',
    'z-index': dialogBoxZIndex + 1
  });
  var dialog = jQuery('\
 <div class="standard-dialog-blue ' + dialog_class + ' ' + classFromTitle + '">\
  <div class="standard-dialog-blue-wrapper">\
   <div class="standard-dialog-blue-header theme-background">\
    <div class="standard-dialog-blue-title">' + title + '</div>\
    <div class="print printButton" style="display:none"><img src="/MM/img/MT/ex-Print.gif"/></div>\
    <div class="standard-dialog-blue-cross cross"><span>&#x2715;</span><span>&nbsp;</span></div>\
      </div>\
   <div class="standard-dialog-blue-contents dialogBoxContents">\
    Please wait...\
   </div>\
  </div>\
 </div>');
  dialog.css({
    'display': 'none',
    'z-index': dialogBoxZIndex + 2
  });
  if (dialog_class == 'student-side-dialog') {
    dialog.css({
      'marginLeft': 0
    });
  }
  dialog.find('.standard-dialog-blue-contents').css({
    'overflow-y': 'auto'
  });
  if (param.hasOwnProperty('width')) {
    if (param.width == 'max') param.width = '746px';
    var left = ((innerWidth - (parseInt(param.width) + 4)) / 2) + 14;
    dialog.css({
      'width': param.width,
      'left': left + 'px',
    });
  }
  if (param.hasOwnProperty('top')) {
    dialog.css({
      'top': param.top
    });
  }
  var printFrame = null;
  if (param.hasOwnProperty('print')) {
    jQuery('.standard-dialog-blue.' + classFromTitle + ' .printButton', dialog).show();
    jQuery('.standard-dialog-blue.' + classFromTitle + ' .printButton', dialog).bind('click', {
      content: jQuery('.dialogBoxContents', dialog),
      print: param.print
    }, onPrintClick);
    printFrame = jQuery('<iframe id="printiframeX" src="about:blank" style="height: 0px; width: 0px;position: absolute; top: -1000px; left: -1000px"/>');
    printFrame.appendTo(whereToPutElement);
  }
  if (param.hasOwnProperty('printCustom')) {
    jQuery('.standard-dialog-blue.' + classFromTitle + ' .printButton', dialog).show();
    jQuery('.standard-dialog-blue.' + classFromTitle + ' .printButton', dialog).bind('click', param.printCustom);
  }
  dialog.css({
    'position': 'absolute'
  });
  screenHider.appendTo(whereToPutElement);
  dialog.appendTo(whereToPutElement);
  jQuery("#loading").css({
    'z-index': dialogBoxZIndex + 2
  });
  dialogBoxZIndex += 2;
  jQuery('.cross', dialog).css({
    'margin': '0'
  });
  jQuery('.cross', dialog).bind('click', function(event) {
    if (printFrame) printFrame.remove();
    dialog.remove();
    $('.screenHiderX' + dialogBoxZIndex).remove();
    screenHider.remove();
    dialogBoxZIndex -= 2;
    if (param.hasOwnProperty('onCloseCallback')) {
      param.onCloseCallback();
    }
  });
  jQuery("#loading").show();
  var doAjaxCall = true;
  if (param.hasOwnProperty('ajax')) {
    doAjaxCall = param.ajax;
  }
  if (doAjaxCall) {
    jQuery.ajax({
      url: ajaxurl,
      type: 'GET',
      success: function(data, textStatus, jqXHR) {
        jQuery('.dialogBoxContents', dialog).html(data);
        if (param.beforeShow) {
          param.beforeShow();
        }
        jQuery("#loading").hide();
        screenHider.show();
        dialog.show();
        if (param.after) {
          param.after();
        }
      },
      error: function(jqXHR, textStatus, errorThrown) {
        jQuery("#loading").hide();
      }
    });
  } else {
    jQuery('.dialogBoxContents', dialog).html(ajaxurl);
    jQuery("#loading").hide();
    screenHider.show();
    dialog.show();
  }
}

function showScreenHider(calledFrom, onClickClose) {
  var whereToPutElement = '';
  if (calledFrom == 'teacher') {
    whereToPutElement = 'body > .wrapper > .inner-wrapper';
  } else if (calledFrom == 'student') {
    whereToPutElement = 'body';
  } else if (calledFrom == 'parent') {
    whereToPutElement = 'body';
  }
  if (dialogBoxZIndex < (window['dialog'].zOrderDefault + window['dialog'].zorder)) {
    dialogBoxZIndex = window['dialog'].zOrderDefault + window['dialog'].zorder;
  }
  var screenHider = jQuery('<div></div>');
  screenHider.css({
    'display': 'none',
    'position': 'fixed',
    'left': '0',
    'top': '0',
    'background': 'none repeat scroll 0% 0% rgb(0, 0, 0)',
    'display': 'block',
    'opacity': '0.5',
    'width': '100%',
    'height': '100%',
    'z-index': dialogBoxZIndex + 1
  });
  screenHider.appendTo(whereToPutElement);
  dialogBoxZIndex += 1;
  jQuery(onClickClose).bind('click', function(event) {
    screenHider.remove();
    dialogBoxZIndex -= 1;
    jQuery(onClickClose).unbind('click', arguments.callee);
  });
}

function onPrintClick(event) {
  var content = event.data.content.html();
  var css = '<link rel="stylesheet" type="text/css" href="' + event.data.print.css + '"/>';
  var printFrameContentWindow = document.getElementById("printiframeX").contentWindow;
  printFrameContentWindow.document.open();
  printFrameContentWindow.document.write(css + content);
  printFrameContentWindow.document.write("");
  printFrameContentWindow.document.close();
  printFrameContentWindow.focus();
  window.pp = printFrameContentWindow;
  setTimeout("window.pp.print();", 10);
  $(".overlay").hide();
  $("#loading").hide();
}
var params;
var rawHtml;
var shouldPrint;

function mmInitPrint(printParams) {
  $("#loading").show();
  rawHtml = "";
  params = printParams;
  var style = "";
  var noExport = "";
  var noPrint = "";
  var noClose = "";
  var customClass = "";
  var customToolbar = '';
  if ("useCenter" in params) {
    style = ' style="left:50%; margin-left: -330px;"';
  }
  if ("noExport" in params) {
    noExport = ' hide';
  }
  if ("noPrint" in params) {
    noPrint = ' hide';
  }
  if ("noClose" in params) {
    noClose = ' hide';
  }
  if ("customClass" in params) {
    customClass = ' ' + params.customClass;
  }
  if (params.customToolbar) {
    customToolbar = params.customToolbar;
  }
  $("body").append('<div id="print-overlay"></div>');
  $("body").append('<div id="print-preview-dialog" class="standard-dialog-blue' + customClass + '" ' + style + '>' + '<link rel="stylesheet" href="/MM/css/generic/buttons.css" >' + '<div class="standard-dialog-blue-wrapper print-preview-wrapper">' + '<div class="standard-dialog-blue-header theme-background">' + '<div class="standard-dialog-blue-title">Print Preview</div>' + '<div class="standard-dialog-blue-cross" onclick="mmDestructPrint();"><span>&#x2715;</span><span>&nbsp;</span></div>' + '</div>' + '<div id="print-preview-content" class="standard-dialog-blue-contents">' + '<div id="print-preview-toolbar">' + '<a href="#" id="print-preview-print-button-print" class="button gray size100 margin print-preview-print-button' + noPrint + '" onclick="printClicked(); return false">Print</a>' + '<a href="#" id="print-preview-print-button-pdf" class="button gray size100 margin print-preview-print-button" onclick="pdfClicked(); return false">Create PDF</a>' + '<a href="#" id="print-preview-print-button-csv" class="button gray size100 margin print-preview-print-button' + noExport + '" onclick="exportClicked(); return false">Export</a>' + '<a href="#" id="print-preview-print-button-q" class="button gray size100 margin print-preview-print-button' + noClose + '" onclick="printCloseClicked(); return false">Close</a>' +
    customToolbar + '</div>' + '<div id="print-report-wrapper">' + '<div id="print-preview-print-header"><span id="print-preview-print-title"></span><span id="print-preview-print-desc"></span><span class="print-preview-clear"></span></div>' + '<div class="print-preview-clear"></div>' + '<div id="print-preview-print-before-content-wrapper"></div>' + '<div class="print-preview-clear"></div>' + '<div id="print-preview-print-content-wrapper"></div>' + '<div class="print-preview-clear"></div>' + '<div id="print-preview-print-after-content-wrapper"></div>' + '<div class="print-preview-clear"></div>' + '</div>' + '</div>' + '</div>' + '</div>');
  $("body").append('<iframe id="printiframe" src="about:blank" style="height: 0px; width: 0px; position: absolute;top:-10px;left:-10px;"/>');
  $(".print-preview-print-button").mouseover(function() {
    $("#print-preview-dialog").css("cursor", "pointer");
  });
  $(".print-preview-print-button").mouseout(function() {
    $("#print-preview-dialog").css("cursor", "default");
  });
  $("#print-preview-print-title").html(params.title);
  $("#print-preview-print-desc").html(params.desc);
  if ("data" in params) {
    showReport();
  } else {
    if ("dataSource" in params) {
      if (typeOf(params.dataSource) == "function") {
        params.data = params.dataSource();
        showReport();
      } else if (typeOf(params.dataSource) == "string") {
        $.ajax({
          url: params.dataSource,
          async: true,
          dataType: params.dataType || 'json',
          success: function(data) {
            params.data = data;
            showReport();
          }
        });
      }
    } else {
      showReport();
    }
  }
}

function showReport() {
  if ("customRender" in params) {
    rawHtml = params.customRender(params, renderer);
  } else if (params.mobyBox) {
    rawHtml = rendererMobyBox(params, renderer);
  } else {
    rawHtml = renderer();
  }
  rawHtml = $(rawHtml).outerHtml();
  $("#print-preview-print-content-wrapper").html(rawHtml);
  if ("headerHTML" in params) {
    $("#print-preview-print-before-content-wrapper").html(params.headerHTML);
  }
  if ("footerHTML" in params) {
    $("#print-preview-print-after-content-wrapper").html(params.footerHTML);
  }
  $("#loading").hide();
  $("#print-preview-dialog").show();
  if ("doneShowing" in params) {
    params.doneShowing();
  }
}

function renderer() {
  if ("defaultDecimals" in params) {} else {
    params.defaultDecimals = 2;
  }
  if ("beforeRender" in params) {
    params.beforeRender(params.data, params.headers);
  }
  html = "<table id='pp-data-table'>";
  html += "<thead>";
  html += "<tr class='pp-header-row'>";
  for (var i = 0; i < params.headers.length; i++) {
    cssClass = "pp-data-header pp-data-header-" + i;
    if (i == 0) {
      cssClass += " pp-h-first";
    } else if (i == params.headers.length - 1) {
      cssClass += " pp-h-last";
    } else {
      cssClass += " pp-h-rest";
    }
    html += "<th class='" + cssClass + "'>" + params.headers[i] + "</th>";
  }
  html += "</tr>";
  html += "</thead>";
  html += "</tbody>";
  for (var i = 0; i < params.data.length; i++) {
    cssClass = "pp-data-row pp-data-row-" + i;
    if (i == 0) {
      cssClass += " pp-r-first";
    } else if (i == params.data.length - 1) {
      cssClass += " pp-r-last";
    } else {
      cssClass += " pp-r-rest";
    }
    html += "<tr class='" + cssClass + "'>";
    for (var j = 0; j < params.headers.length; j++) {
      cssClass = "pp-data-column pp-data-column-" + j;
      if (j == 0) {
        cssClass += " pp-c-first";
      } else if (j == params.headers.length - 1) {
        cssClass += " pp-c-last";
      } else {
        cssClass += " pp-c-rest";
      }
      var valueToDisplay;
      if (params.data[i].Item[j] == null) {
        valueToDisplay = "-";
      } else if (isNaN(params.data[i].Item[j]) == false) {
        if (params.dontRound) {
          valueToDisplay = params.data[i].Item[j];
        } else {
          number = new Number(params.data[i].Item[j]);
          valueToDisplay = number.toFixed(params.defaultDecimals);
        }
      } else {
        valueToDisplay = params.data[i].Item[j];
      }
      var titleToDisplay = valueToDisplay;
      if (params.noTitle && params.noTitle.hasOwnProperty('col_' + j) && params.noTitle['col_' + j] === true) {
        titleToDisplay = "";
      }
      if (j == 0) {
        html += "<td class='" + cssClass + "' title='" + titleToDisplay + "'><span class='value-text value-text-" + j + "'>" + valueToDisplay + "</span></td>";
      } else {
        html += "<td class='" + cssClass + "' title='" + titleToDisplay + "'>" + valueToDisplay + "</td>";
      }
    }
    html += "</tr>";
  }
  html += "</tbody>";
  html += "</table>";
  if ("afterRender" in params) {
    html = params.afterRender(params.data, params.headers, html, $(html));
  }
  rawHtml = html;
  return rawHtml;
}

function rendererMobyBox(params, renderer) {
  'use strict';
  var mobyBox = params.mobyBox;
  var box_class = null;
  if (params.beforeRender) {
    params.beforeRender(params.data, beforeRender.headers);
  }
  var style_html = '<style>@import "/MM/css/lib/print-mobybox.css";</style>';
  if (!params.docType) {
    params.docType = '<!DOCTYPE html>';
  }
  params.wrapHtml = true;
  params.margin = [10 + 5, 10, 10, 10 + 8];
  switch (mobyBox.style) {
    case 'green':
    default:
      box_class = 'green-box';
  }
  var origin = location.origin || (location.protocol + "//" + location.host);
  var base = '<base href="{0}">'.format(origin);
  var table = $('<div class="mobybox">');
  var imgwbg = $('<img class="mobybox-bg" alt="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAMSURBVBhXY/j//z8ABf4C/qc1gYQAAAAASUVORK5CYII=" />');
  var header = $(('<div class="mobybox-cell mobybox-header {0}"><div class="mobybox-title-wrap"></div></div>').format(box_class));
  if (mobyBox.header) {
    var header_wrap = header.find('.mobybox-title-wrap');
    header_wrap.append(imgwbg.clone());
    $('<span class="mobybox-title"></span>').text(mobyBox.header).appendTo(header_wrap);
    header_wrap.css('width', '{0}em'.format(mobyBox.header.length))
  }
  header.appendTo(table);
  var data = params.data;
  var call_default_renderer = (typeof data != 'string');
  if (call_default_renderer) {
    data = renderer(params);
  }
  var body = $('<div class="mobybox-cell mobybox-body {0}"></div>'.format(box_class));
  body.html(data);
  body.appendTo(table);
  var footer = $(('<div class="mobybox-cell mobybox-footer {0}"><div class="mobybox-logo">' + '<div><img class="logo-img" src="/MM/img/print/mobymax_logo.png" alt="" /></div>' + '</div></div>').format(box_class));
  var footer_wrap = footer.find('.mobybox-logo');
  footer_wrap.prepend(imgwbg);
  footer.appendTo(table);
  var base_style = base + style_html;
  var spacer = '<div class="mobybox-header-spacer">&nbsp;</div>';
  var page_height = params.landscape ? 673 : 908;
  var height_property = params.landscape ? 'scrollWidth' : 'scrollHeight';
  var repeat_height = params.mobyBox.repeatHeight || 0;
  params.headerHtml = base_style + spacer + header.prop('outerHTML');
  params.footerHtml = base_style + footer.prop('outerHTML');
  params.beforePDF = function(data, headers, rawHtml) {
    var adjust_body = ('<script>' + 'window.onload = function(){' + 'var body = document.getElementsByClassName("mobybox-body")[0];' + 'var PAGE_HEIGHT = {0}; ' + 'var REPEAT_HEIGHT = {1}; ' + 'var height = body.{2};' + 'var comp_style = window.getComputedStyle(body, null);' + 'var padding = parseInt(comp_style.getPropertyValue("padding-top"));' + 'padding += parseInt(comp_style.getPropertyValue("padding-bottom"));' + 'var pages = ~~((height + PAGE_HEIGHT) / PAGE_HEIGHT);' + 'height = PAGE_HEIGHT + ((pages - 1) * (PAGE_HEIGHT - REPEAT_HEIGHT));' + 'height -= padding;' + 'body.style.height = "" + height + "px";' + '}' + '</script>').format(page_height, repeat_height, height_property);
    return base_style + body.prop('outerHTML') + adjust_body;
  };
  var table_html = table.prop('outerHTML');
  if (!call_default_renderer && params.afterRender) {
    table_html = params.afterRender(params.data, params.headers, table_html, table);
  }
  return base_style + table_html;
}

function mmAddCss(params, css_name) {
  'use strict';
  var otherCSS = params.otherCSS || [];
  if (!(otherCSS instanceof Array)) {
    otherCSS = [otherCSS];
  }
  otherCSS.push(css_name);
  params.otherCSS = otherCSS;
  var href = '/MM/css/{0}.css'.format(css_name);
  if (!$('link[href="{0}"]'.format(href)).length) {
    alert('Stylesheet {0} is missing for print preview.'.format(href));
  }
}

function mmDestructPrint() {
  $("#print-preview-dialog").html("").remove();
  $("#print-overlay").remove();
  $("#printiframe").remove();
}

function printCloseClicked() {
  mmDestructPrint();
  if ("afterClose" in params) {
    params.afterClose();
  }
}

function printClicked() {
  rawHtml = $("#print-report-wrapper").html().replace(/hideme/g, '');
  if ("customPrinter" in params) {
    params.customPrinter(params.data, params.headers, rawHtml, print);
  } else if (params.mobyBox) {
    printPDF();
  } else {
    print();
  }
}

function printIframe(id) {
  var iframe = document.getElementById(id);
  if (navigator.userAgent.toLowerCase().indexOf("msie") !== -1 || navigator.userAgent.toLowerCase().indexOf("mozilla") !== -1) {
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
  } else {
    iframe.contentWindow.document.execCommand('print', false, null);
  }
  return false;
}

function printIframeContentOnLoad(id, cb) {
  var iframe = document.getElementById(id);
  var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
  var links = iframeDoc.styleSheets;
  var images = $(iframeDoc).find('img');
  var interval = null;
  var timeout = null;
  if (links.length > 0 || images.length > 0) {
    timeout = window.setTimeout(function() {
      if (interval !== null) window.clearInterval(interval);
      cb();
    }, 1000);
    interval = window.setInterval(function() {
      var loadedStyleSheetLength = 0;
      for (var i = 0; i < links.length; i++) {
        if (links[i].cssRules.length > 0) {
          loadedStyleSheetLength++;
        }
      }
      var loadedImagesLength = images.filter(function(i, el) {
        return el.complete;
      }).length;
      if (loadedStyleSheetLength === links.length && loadedImagesLength === images.length) {
        window.clearTimeout(timeout);
        window.clearInterval(interval);
        cb();
      }
    }, 200);
  } else {
    cb();
  }
}

function print() {
  $("#loading").show();
  if ("beforePrint" in params) {
    rawHtml = params.beforePrint(rawHtml);
  }
  printCSS = "";
  if ("printSheet" in params) {
    printCSS = params.printSheet;
  } else {
    printCSS = "fixedRows";
  }
  printFile = "media_print_single";
  if (printCSS == "fixedRows") {
    printFile = "media_print_single";
  } else if (printCSS == "autoRows") {
    printFile = "media_print_multiple";
  }
  if ("otherCSS" in params) {
    if (params.otherCSS instanceof Array) {
      for (var ii = 0; ii < params.otherCSS.length; ii++)
        rawHtml = "<link href=\"/MM/css/" + params.otherCSS[ii] + ".css\" type=\"text/css\" rel=\"stylesheet\">" + rawHtml;
    } else {
      rawHtml = "<link href=\"/MM/css/" + params.otherCSS + ".css\" type=\"text/css\" rel=\"stylesheet\">" + rawHtml;
    }
  }
  rawHtml = "<link href=\"/MM/css/" + printFile + ".css\" type=\"text/css\" rel=\"stylesheet\">" + rawHtml;
  if ("landscape" in params) rawHtml += '<style type="text/css">@page {size:landscape;}</style>';
  rawHtml += '<script>window.parent.$(document).ready(function () { window.parent.printFrameOnload(); });</script>';
  if (params.wrapHtml) {
    rawHtml = '<html moznomarginboxes mozdisallowselectionprint>' + rawHtml + '</html>';
  }
  if ("docType" in params) rawHtml = params.docType + rawHtml;
  window.printFrameOnload = function() {
    printIframeContentOnLoad('printiframe', function() {
      printIframe('printiframe');
      if ("afterPrint" in params) {
        params.afterPrint();
      }
    });
  };
  var printFrameContentWindow = document.getElementById("printiframe").contentWindow;
  printFrameContentWindow.document.open();
  printFrameContentWindow.document.write(rawHtml);
  printFrameContentWindow.document.write("");
  printFrameContentWindow.document.close();
  printFrameContentWindow.focus();
  window.pp = printFrameContentWindow;
  $("#loading").hide();
}

function printPDF() {
  $("#loading").show();
  getPDFFile(printFromURL);
}

function printFromURL(link) {
  $("#loading").hide();

  function closePrint() {
    document.body.removeChild(this.__container__);
  }

  function setPrint() {
    this.contentWindow.__container__ = this;
    this.contentWindow.onbeforeunload = closePrint;
    this.contentWindow.onafterprint = closePrint;
    this.contentWindow.focus();
    this.contentWindow.print();
  }

  function printPage(sURL) {
    var oHiddFrame = document.createElement("iframe");
    oHiddFrame.onload = setPrint;
    oHiddFrame.style.visibility = "hidden";
    oHiddFrame.style.position = "fixed";
    oHiddFrame.style.right = "0";
    oHiddFrame.style.bottom = "0";
    oHiddFrame.src = sURL;
    document.body.appendChild(oHiddFrame);
  }
  printPage(link);
}

function exportClicked() {
  if ("customCSVGetter" in params) {
    params.customCSVGetter();
  } else {
    if ("customExporter" in params) {
      params.customExporter(params.data, params.headers, mmExport);
    } else {
      mmExport();
    }
  }
  $('#print-download-dialog .standard-dialog-blue-title').html('Export');
}

function mmExport() {
  $("#loading").show();
  showProgressDialog();
  var data = params.data;
  if ("beforeExport" in params) {
    data = params.beforeExport(params.data);
  }
  var exportAsString = [];
  if ("exportColsAsString" in params) {
    exportAsString = params.exportColsAsString;
  }
  exporter = "default";
  if ("customServerSideExporter" in params) {
    exporter = params.customServerSideExporter;
  }
  $.post('/MM/print/export-csv.php', {
    title: params.title,
    desc: params.desc,
    noTitleOutput: params.noTitleOutput === undefined ? true : params.noTitleOutput,
    headers: params.headers,
    data: data,
    customOutputer: exporter,
    exportAsString: exportAsString,
  }, function(link) {
    showDownloadDialog(link);
  });
  if ("afterExport" in params) {
    params.afterExport();
  }
  $("#loading").hide();
}

function pdfClicked() {
  if ("customPDFGetter" in params) {
    params.customPDFGetter();
  } else {
    showProgressDialog();
    getPDFFile(showDownloadDialog);
  }
  $('#print-download-dialog .standard-dialog-blue-title').html('PDF Download');
}

function getPDFFile(callback) {
  rawHtml = $("#print-report-wrapper").html();
  if ("customPDFPrinter" in params) {
    rawHtml = params.customPDFPrinter(params.data, params.headers, rawHtml, mmPDFPrinter);
  } else {
    rawHtml = mmPDFPrinter();
  }
  if ("docType" in params) rawHtml = params.docType + rawHtml;
  var postData = {
    data: rawHtml
  };
  if ('zoom' in params) {
    postData.zoom = params.zoom;
  }
  if (params.landscape) {
    postData.orientation = 'landscape';
  }
  if (params.headerHtml) {
    postData.header_html = params.headerHtml;
  }
  if (params.footerHtml) {
    postData.footer_html = params.footerHtml;
  }
  if (params.margin) {
    postData.margin = params.margin;
  }
  $.post('/MM/print/export-pdf.php', postData, callback);
}

function mmPDFPrinter() {
  if ("beforePDF" in params) {
    rawHtml = params.beforePDF(params.data, params.headers, rawHtml);
  }
  printCSS = "";
  if ("printSheet" in params) {
    printCSS = params.printSheet;
  } else {
    printCSS = "fixedRows";
  }
  printFile = "media_print_single";
  if (printCSS == "fixedRows") {
    printFile = "media_print_single";
  } else if (printCSS == "autoRows") {
    printFile = "media_print_multiple";
  }
  if ("otherCSS" in params) {
    if (params.otherCSS instanceof Array) {
      for (var ii = 0; ii < params.otherCSS.length; ii++)
        rawHtml = "<link href=\"https://" + getCSSURL() + "/MM/css/" + params.otherCSS[ii] + ".css\" type=\"text/css\" rel=\"stylesheet\">" + rawHtml;
    } else {
      rawHtml = "<link href=\"https://" + getCSSURL() + "/MM/css/" + params.otherCSS + ".css\" type=\"text/css\" rel=\"stylesheet\">" + rawHtml;
    }
  }
  rawHtml = "<link href=\"https://" + getCSSURL() + "/MM/css/" + printFile + ".css\" type=\"text/css\" rel=\"stylesheet\">" + rawHtml;
  if ("afterPDF" in params) {
    rawHtml = params.afterPDF(rawHtml);
  }
  return rawHtml;
}

function showDownloadDialog(link) {
  $("#download-export-img").hide();
  $("#creating-download-word").hide();
  $("#print-download-content br").remove();
  $("#print-download-content").append("<span style='padding-top:5px;'>Report is ready. Please <a href='" + link + "' download target='_blank' onclick='mmCloseDownload();'>click here</a> to download to your computer.</span>");
}

function mmCloseDownload() {
  $("#print-download-dialog").remove();
  $("#download-overlay").remove();
}

function showProgressDialog() {
  $("body").append('<div id="download-overlay"></div>');
  var dialogClass = $('#print-preview-dialog').attr('class') || 'standard-dialog-blue teacher-side-dialog';
  $("body").append('<div id="print-download-dialog" class="' + dialogClass + '">' + '<div class="standard-dialog-blue-wrapper print-preview-wrapper">' + '<div class="standard-dialog-blue-header theme-background">' + '<div class="standard-dialog-blue-title">Export</div>' + '<div class="standard-dialog-blue-cross" onclick="mmCloseDownload();"><span>&#x2715;</span><span>&nbsp;</span></div>' + '</div>' + '<div class="standard-dialog-blue-contents">' + '<div id="print-download-content" class="standard-dialog-blue-content-html ">' + '</div>' + '</div>' + '</div>' + '</div>');
  $("#print-download-dialog").show();
  $("#download-overlay").show();
  img = "<img id='download-export-img' src='/MM/img/spinner3-black.gif'/><br/>";
  text = "<span id='creating-download-word'>Creating report...</span><br/>"
  $("#print-download-content").html(img + text);
}

function getCSSURL() {
  url = window.location.href
  url = url.split('/');
  return url[2];
}

function typeOf(obj) {
  var type = typeof obj;
  if (type !== 'object') {
    return type;
  } else if (Object.prototype.toString.call(obj) === '[object Array]') {
    return 'array';
  } else if (obj === null) {
    return 'null';
  } else {
    return 'object';
  }
}
jQuery.fn.extend({
  outerHtml: function(replacement) {
    if (replacement) {
      return this.each(function() {
        $(this).replaceWith(replacement);
      });
    }
    var tmp_clone = this.clone();
    tmp_clone = tmp_clone.map(function(i, el) {
      return $(el).is('script') ? null : el;
    });
    tmp_clone.find('script').remove();
    var tmp_node = $("<div></div>").append(tmp_clone);
    var markup = tmp_node.html();
    tmp_node.remove();
    return markup;
  }
});
var MSLabAjaxInit = function() {
  var spinnerDiv = jQuery('<div id="msajax_spinner"></div>');
  spinnerDiv.css({
    'background': 'url("/MM/img/spinner3-black.gif") no-repeat scroll center center transparent',
    'height': '30px',
    'left': '50%',
    'margin-left': '-15px',
    'overflow': 'auto',
    'position': 'fixed',
    'top': '50%',
    'width': '30px',
    'z-index': '30',
    'display': 'none'
  });
  var tryingDiv = jQuery('<div id="msajax_trying_dialog">Your internet connection has been lost. Let\'s wait just a moment to see if it will come back.</div>');
  tryingDiv.css({
    'background-color': '#F9EDBE',
    'background-image': 'url("/MM/img/spinner3-black.gif")',
    'background-position': '96% 50%',
    'background-repeat': 'no-repeat',
    'border': '1px solid #F0C36D',
    'border-radius': '5px 5px 5px 5px',
    'color': 'gray',
    'display': 'none',
    'font-family': 'Arial',
    'font-size': '18px',
    'font-weight': 'bold',
    'margin': '10px auto',
    'padding': '15px 55px 15px 15px',
    'text-align': 'left',
    'width': '400px',
    'position': 'fixed',
    'left': '50%',
    'margin-left': '-230px',
    'top': '120px',
    'z-index': '22'
  });
  spinnerDiv.appendTo('body');
  tryingDiv.appendTo('body');
}
var MSLabAjaxInProgressRequests = [];
var MSLabAjax = (function($) {
  return (function(params) {
    var retries = 0;
    var ajax_id = Math.floor((Math.random() * 99999) + 1);
    var settings = $.extend({
      url: "",
      max_retries: 5,
      spinner: '#msajax_spinner',
      trying_dialog: '#msajax_trying_dialog',
      disconnect_alert: "Sorry, your internet is still not available.",
      error_alert: "The next problem did not load. Press OK to fetch again.",
      dataType: "json",
      silent: 0,
      data: "",
      type: "POST",
      cache: false,
      disallowInParallelRequests: false,
      success: function() {}
    }, params);
    c = new Image();
    c.src = "/MM/img/ajax-loader.gif";

    function requestIsInProgress(url) {
      return MSLabAjaxInProgressRequests.indexOf(url) !== -1;
    }

    function removeInProggressRequest(url) {
      if (requestIsInProgress(url)) {
        MSLabAjaxInProgressRequests = MSLabAjaxInProgressRequests.filter(function(item) {
          return item != url
        });
      }
    }

    function addInProgressRequest(url) {
      if (!requestIsInProgress(url)) {
        MSLabAjaxInProgressRequests.push(url);
      }
    }

    function ajaxRequest() {
      if (typeof jsVars != 'undefined' && typeof jsVars.key != 'undefined') {
        settings.data.key = jsVars.key;
      }
      if (settings.disallowInParallelRequests) {
        if (requestIsInProgress(settings.url)) {
          return;
        } else {
          addInProgressRequest(settings.url);
        }
      }
      $.ajax({
        beforeSend: function() {
          if (retries > 0) {
            $(".Overlay1").show();
            $(settings.spinner).hide();
            $(settings.trying_dialog).show();
          } else if (settings.silent == 0)
            $(settings.spinner).show();
        },
        url: settings.url + "?_=" + ajax_id,
        dataType: settings.dataType,
        type: settings.type,
        data: settings.data,
        cache: false,
        success: function(response, status_text, xhr) {
          if (settings.disallowInParallelRequests) {
            removeInProggressRequest(settings.url);
          }
          if (retries > 0) {
            $(".Overlay1").hide();
            $(settings.trying_dialog).hide();
          }
          if (settings.success != null) {
            settings.success(response);
            settings.success = null;
          }
        },
        complete: function() {
          if (settings.disallowInParallelRequests) {
            removeInProggressRequest(settings.url);
          }
          $(settings.spinner).hide();
        },
        error: function(xhr, tStatus, err) {
          if (settings.disallowInParallelRequests) {
            removeInProggressRequest(settings.url);
          }
          $(settings.spinner).hide();
          if (tStatus == 'parsererror' || tStatus == 'abort' || tStatus == 'timeout') {
            ajaxError = true;
            alert(settings.error_alert);
            return;
          } else if (xhr.status != 200) {
            if (retries++ < settings.max_retries) {
              setTimeout(ajaxRequest, (retries == 1) ? 1000 : 10000);
              return;
            }
          }
          if (retries > settings.max_retries) {
            $(".Overlay1").hide();
            $(settings.trying_dialog).hide();
            ajaxError = true;
            alert(settings.disconnect_alert);
          }
        }
      });
    };
    ajaxRequest();
  });
})(jQuery);
! function() {
  var b = {},
    a = b.util = b.util || {};

  function c(b) {
    if (this.data = "", this.read = 0, "string" == typeof b) this.data = b;
    else if (a.isArrayBuffer(b) || a.isArrayBufferView(b)) {
      var d = new Uint8Array(b);
      try {
        this.data = String.fromCharCode.apply(null, d)
      } catch (f) {
        for (var e = 0; e < d.length; ++e) this.putByte(d[e])
      }
    } else(b instanceof c || "object" == typeof b && "string" == typeof b.data && "number" == typeof b.read) && (this.data = b.data, this.read = b.read);
    this._constructedStringLength = 0
  }
  a.isArrayBuffer = function(a) {
    return "undefined" != typeof ArrayBuffer && a instanceof ArrayBuffer
  }, a.isArrayBufferView = function(b) {
    return b && a.isArrayBuffer(b.buffer) && void 0 !== b.byteLength
  }, a.ByteBuffer = c, a.ByteStringBuffer = c, a.ByteStringBuffer.prototype._optimizeConstructedString = function(a) {
    this._constructedStringLength += a, this._constructedStringLength > 4096 && (this.data.substr(0, 1), this._constructedStringLength = 0)
  }, a.ByteStringBuffer.prototype.length = function() {
    return this.data.length - this.read
  }, a.ByteStringBuffer.prototype.isEmpty = function() {
    return 0 >= this.length()
  }, a.ByteStringBuffer.prototype.putByte = function(a) {
    return this.putBytes(String.fromCharCode(a))
  }, a.ByteStringBuffer.prototype.fillWithByte = function(a, b) {
    a = String.fromCharCode(a);
    for (var c = this.data; b > 0;) 1 & b && (c += a), (b >>>= 1) > 0 && (a += a);
    return this.data = c, this._optimizeConstructedString(b), this
  }, a.ByteStringBuffer.prototype.putBytes = function(a) {
    return this.data += a, this._optimizeConstructedString(a.length), this
  }, a.ByteStringBuffer.prototype.putString = function(b) {
    return this.putBytes(a.encodeUtf8(b))
  }, a.ByteStringBuffer.prototype.putInt16 = function(a) {
    return this.putBytes(String.fromCharCode(a >> 8 & 255) + String.fromCharCode(255 & a))
  }, a.ByteStringBuffer.prototype.putInt24 = function(a) {
    return this.putBytes(String.fromCharCode(a >> 16 & 255) + String.fromCharCode(a >> 8 & 255) + String.fromCharCode(255 & a))
  }, a.ByteStringBuffer.prototype.putInt32 = function(a) {
    return this.putBytes(String.fromCharCode(a >> 24 & 255) + String.fromCharCode(a >> 16 & 255) + String.fromCharCode(a >> 8 & 255) + String.fromCharCode(255 & a))
  }, a.ByteStringBuffer.prototype.putInt16Le = function(a) {
    return this.putBytes(String.fromCharCode(255 & a) + String.fromCharCode(a >> 8 & 255))
  }, a.ByteStringBuffer.prototype.putInt24Le = function(a) {
    return this.putBytes(String.fromCharCode(255 & a) + String.fromCharCode(a >> 8 & 255) + String.fromCharCode(a >> 16 & 255))
  }, a.ByteStringBuffer.prototype.putInt32Le = function(a) {
    return this.putBytes(String.fromCharCode(255 & a) + String.fromCharCode(a >> 8 & 255) + String.fromCharCode(a >> 16 & 255) + String.fromCharCode(a >> 24 & 255))
  }, a.ByteStringBuffer.prototype.putInt = function(c, a) {
    var b = "";
    do a -= 8, b += String.fromCharCode(c >> a & 255); while (a > 0) return this.putBytes(b)
  }, a.ByteStringBuffer.prototype.putSignedInt = function(a, b) {
    return a < 0 && (a += 2 << b - 1), this.putInt(a, b)
  }, a.ByteStringBuffer.prototype.putBuffer = function(a) {
    return this.putBytes(a.getBytes())
  }, a.ByteStringBuffer.prototype.getByte = function() {
    return this.data.charCodeAt(this.read++)
  }, a.ByteStringBuffer.prototype.getInt16 = function() {
    var a = this.data.charCodeAt(this.read) << 8 ^ this.data.charCodeAt(this.read + 1);
    return this.read += 2, a
  }, a.ByteStringBuffer.prototype.getInt24 = function() {
    var a = this.data.charCodeAt(this.read) << 16 ^ this.data.charCodeAt(this.read + 1) << 8 ^ this.data.charCodeAt(this.read + 2);
    return this.read += 3, a
  }, a.ByteStringBuffer.prototype.getInt32 = function() {
    var a = this.data.charCodeAt(this.read) << 24 ^ this.data.charCodeAt(this.read + 1) << 16 ^ this.data.charCodeAt(this.read + 2) << 8 ^ this.data.charCodeAt(this.read + 3);
    return this.read += 4, a
  }, a.ByteStringBuffer.prototype.getInt16Le = function() {
    var a = this.data.charCodeAt(this.read) ^ this.data.charCodeAt(this.read + 1) << 8;
    return this.read += 2, a
  }, a.ByteStringBuffer.prototype.getInt24Le = function() {
    var a = this.data.charCodeAt(this.read) ^ this.data.charCodeAt(this.read + 1) << 8 ^ this.data.charCodeAt(this.read + 2) << 16;
    return this.read += 3, a
  }, a.ByteStringBuffer.prototype.getInt32Le = function() {
    var a = this.data.charCodeAt(this.read) ^ this.data.charCodeAt(this.read + 1) << 8 ^ this.data.charCodeAt(this.read + 2) << 16 ^ this.data.charCodeAt(this.read + 3) << 24;
    return this.read += 4, a
  }, a.ByteStringBuffer.prototype.getInt = function(b) {
    var a = 0;
    do a = (a << 8) + this.data.charCodeAt(this.read++), b -= 8; while (b > 0) return a
  }, a.ByteStringBuffer.prototype.getSignedInt = function(b) {
    var a = this.getInt(b),
      c = 2 << b - 2;
    return a >= c && (a -= c << 1), a
  }, a.ByteStringBuffer.prototype.getBytes = function(a) {
    var b;
    return a ? (a = Math.min(this.length(), a), b = this.data.slice(this.read, this.read + a), this.read += a) : 0 === a ? b = "" : (b = 0 === this.read ? this.data : this.data.slice(this.read), this.clear()), b
  }, a.ByteStringBuffer.prototype.bytes = function(a) {
    return void 0 === a ? this.data.slice(this.read) : this.data.slice(this.read, this.read + a)
  }, a.ByteStringBuffer.prototype.at = function(a) {
    return this.data.charCodeAt(this.read + a)
  }, a.ByteStringBuffer.prototype.setAt = function(a, b) {
    return this.data = this.data.substr(0, this.read + a) + String.fromCharCode(b) + this.data.substr(this.read + a + 1), this
  }, a.ByteStringBuffer.prototype.last = function() {
    return this.data.charCodeAt(this.data.length - 1)
  }, a.ByteStringBuffer.prototype.copy = function() {
    var b = a.createBuffer(this.data);
    return b.read = this.read, b
  }, a.ByteStringBuffer.prototype.compact = function() {
    return this.read > 0 && (this.data = this.data.slice(this.read), this.read = 0), this
  }, a.ByteStringBuffer.prototype.clear = function() {
    return this.data = "", this.read = 0, this
  }, a.ByteStringBuffer.prototype.truncate = function(a) {
    var b = Math.max(0, this.length() - a);
    return this.data = this.data.substr(this.read, b), this.read = 0, this
  }, a.ByteStringBuffer.prototype.toHex = function() {
    for (var a = "", b = this.read; b < this.data.length; ++b) {
      var c = this.data.charCodeAt(b);
      c < 16 && (a += "0"), a += c.toString(16)
    }
    return a
  }, a.ByteStringBuffer.prototype.toString = function() {
    return a.decodeUtf8(this.bytes())
  }, a.createBuffer = function(b, c) {
    return c = c || "raw", void 0 !== b && "utf8" === c && (b = a.encodeUtf8(b)), new a.ByteBuffer(b)
  }, a.fillString = function(a, b) {
    for (var c = ""; b > 0;) 1 & b && (c += a), (b >>>= 1) > 0 && (a += a);
    return c
  }, a.encodeUtf8 = function(a) {
    return unescape(encodeURIComponent(a))
  }, a.decodeUtf8 = function(a) {
    return decodeURIComponent(escape(a))
  };
  var d = b.sha256 = b.sha256 || {};
  b.md = b.md || {}, b.md.algorithms = b.md.algorithms || {}, b.md.sha256 = b.md.algorithms.sha256 = d, d.create = function() {
    f || h();
    var c = null,
      d = b.util.createBuffer(),
      g = new Array(64),
      a = {
        algorithm: "sha256",
        blockLength: 64,
        digestLength: 32,
        messageLength: 0,
        messageLength64: [0, 0]
      };
    return a.start = function() {
      return a.messageLength = 0, a.messageLength64 = [0, 0], d = b.util.createBuffer(), c = {
        h0: 1779033703,
        h1: 3144134277,
        h2: 1013904242,
        h3: 2773480762,
        h4: 1359893119,
        h5: 2600822924,
        h6: 528734635,
        h7: 1541459225
      }, a
    }, a.start(), a.update = function(e, f) {
      return "utf8" === f && (e = b.util.encodeUtf8(e)), a.messageLength += e.length, a.messageLength64[0] += e.length / 4294967296 >>> 0, a.messageLength64[1] += e.length >>> 0, d.putBytes(e), i(c, g, d), (d.read > 2048 || 0 === d.length()) && d.compact(), a
    }, a.digest = function() {
      var j = b.util.createBuffer();
      j.putBytes(d.bytes()), j.putBytes(e.substr(0, 64 - (a.messageLength64[1] + 8 & 63))), j.putInt32(a.messageLength64[0] << 3 | a.messageLength64[0] >>> 28), j.putInt32(a.messageLength64[1] << 3);
      var f = {
        h0: c.h0,
        h1: c.h1,
        h2: c.h2,
        h3: c.h3,
        h4: c.h4,
        h5: c.h5,
        h6: c.h6,
        h7: c.h7
      };
      i(f, g, j);
      var h = b.util.createBuffer();
      return h.putInt32(f.h0), h.putInt32(f.h1), h.putInt32(f.h2), h.putInt32(f.h3), h.putInt32(f.h4), h.putInt32(f.h5), h.putInt32(f.h6), h.putInt32(f.h7), h
    }, a
  };
  var e = null,
    f = !1,
    g = null;

  function h() {
    e = "\x80", e += b.util.fillString("\0", 64), g = [1116352408, 1899447441, 3049323471, 3921009573, 961987163, 1508970993, 2453635748, 2870763221, 3624381080, 310598401, 607225278, 1426881987, 1925078388, 2162078206, 2614888103, 3248222580, 3835390401, 4022224774, 264347078, 604807628, 770255983, 1249150122, 1555081692, 1996064986, 2554220882, 2821834349, 2952996808, 3210313671, 3336571891, 3584528711, 113926993, 338241895, 666307205, 773529912, 1294757372, 1396182291, 1695183700, 1986661051, 2177026350, 2456956037, 2730485921, 2820302411, 3259730800, 3345764771, 3516065817, 3600352804, 4094571909, 275423344, 430227734, 506948616, 659060556, 883997877, 958139571, 1322822218, 1537002063, 1747873779, 1955562222, 2024104815, 2227730452, 2361852424, 2428436474, 2756734187, 3204031479, 3329325298], f = !0
  }

  function i(a, h, o) {
    for (var e, f, p, q, r, s, b, c, i, k, m, d, l, j, n, t = o.length(); t >= 64;) {
      for (b = 0; b < 16; ++b) h[b] = o.getInt32();
      for (; b < 64; ++b) e = ((e = h[b - 2]) >>> 17 | e << 15) ^ (e >>> 19 | e << 13) ^ e >>> 10, f = h[b - 15], f = (f >>> 7 | f << 25) ^ (f >>> 18 | f << 14) ^ f >>> 3, h[b] = e + h[b - 7] + f + h[b - 16] | 0;
      for (b = 0, c = a.h0, i = a.h1, k = a.h2, m = a.h3, d = a.h4, l = a.h5, j = a.h6, n = a.h7; b < 64; ++b) q = (d >>> 6 | d << 26) ^ (d >>> 11 | d << 21) ^ (d >>> 25 | d << 7), r = j ^ d & (l ^ j), p = (c >>> 2 | c << 30) ^ (c >>> 13 | c << 19) ^ (c >>> 22 | c << 10), s = c & i | k & (c ^ i), e = n + q + r + g[b] + h[b], f = p + s, n = j, j = l, l = d, d = m + e | 0, m = k, k = i, i = c, c = e + f | 0;
      a.h0 = a.h0 + c | 0, a.h1 = a.h1 + i | 0, a.h2 = a.h2 + k | 0, a.h3 = a.h3 + m | 0, a.h4 = a.h4 + d | 0, a.h5 = a.h5 + l | 0, a.h6 = a.h6 + j | 0, a.h7 = a.h7 + n | 0, t -= 64
    }
  }
  a.hasWideChar = function(b) {
    for (var a = 0; a < b.length; a++)
      if (b.charCodeAt(a) >>> 8) return !0;
    return !1
  }, window.forge_sha256 = function(c) {
    "TextEncoder" in window || alert("Sorry, this browser does not support TextEncoder...");
    var e = new TextEncoder().encode(c),
      d = b.md.sha256.create(),
      f = String.fromCharCode.apply(null, e);
    return d.update(f, a.hasWideChar(c) ? "utf8" : void 0), d.digest().toHex()
  }
}()
if (typeof module === "object" && module.exports) {
  LabClass = function() {};
  module.exports = LabClass;
}
LabClass.prototype.responsiveVoice = {
  needInit: true,
  defaultType: 'fallback',
  isRequestLive: false,
  moduleId: 'mc',
  defaultSpeakParams: {
    'fallback': {
      voice: 'US English Female',
      pitch: 0.5,
      rate: 0.375,
      vol: 1
    },
    'polly': {
      voice: 'joanna',
      speed: 'medium',
      requestType: 'mp3',
      isSpeechHighlight: null
    }
  },
  voiceURL: '',
  voiceURLdefault: '/ResponsiveVoice/getvoice.php',
  responsiveVoiceReady: $.Deferred(),
  voiceReadyCalledOnResponsiveVoiceInit: false,
  voicesData: {
    mappedNames: [{
      id: 0,
      awsValue: 'joanna',
      frontendValue: 'Joon',
    }, {
      id: 1,
      awsValue: 'salli',
      frontendValue: 'Santana',
    }, {
      id: 2,
      awsValue: 'kimberly',
      frontendValue: 'Kameron',
    }, {
      id: 3,
      awsValue: 'kendra',
      frontendValue: 'Imani',
    }, {
      id: 4,
      awsValue: 'matthew',
      frontendValue: 'Casey',
    }, {
      id: 5,
      awsValue: 'kevin',
      frontendValue: 'Amari',
    }, {
      id: 6,
      awsValue: 'joey',
      frontendValue: 'Ezra',
    }, {
      id: 7,
      awsValue: 'justin',
      frontendValue: 'Haruka',
    }, ],
    mappedSpeeds: [{
      id: 0,
      awsValue: 'slow',
      frontendValue: 'Slower',
    }, {
      id: 1,
      awsValue: 'medium',
      frontendValue: 'Faster',
    }, ],
    styles: {
      Joon: 'linear-gradient(180deg, #775679 0%, #44334D 100%)',
      Santana: 'linear-gradient(180deg, #56795E 0%, #374D33 100%)',
      Kameron: 'linear-gradient(180deg, #956F4C 0%, #624822 100%)',
      Imani: 'linear-gradient(180deg, #76BAC4 0%, #457278 100%)',
      Casey: 'linear-gradient(180deg, #AB4A4A 0%, #5A1D1D 100%)',
      Amari: 'linear-gradient(180deg, #4E6B7B 0%, #3D505A 100%)',
      Ezra: 'linear-gradient(180deg, #A3A552 0%, #555613 100%)',
      Haruka: 'linear-gradient(180deg, #CB79C8 0%, #5F3E60 100%)',
    },
  },
  pollySettingsModules: {
    'mr': 4,
    'glpl': 108,
    'ws': 7,
    'gll': 77,
    'ri': 6,
    'tp-ri': 33,
    'fgl': 111,
    'fgrtl': 115,
    'fgbl': 118,
    'atl': 75,
    'vl': 3,
    'es': 11,
    'sr': 45,
    'sc': 8,
    'qt': 124,
    'ss': 9,
    'mm2': 9999,
    'rl': 5,
    'tp-rl': 32,
    'mm': 1,
    'tp-mm': 30,
    'mg': 2,
    'tp-mg': 31,
  },
  hiddenReadAloudSettingsModules: ['atfr', 'atl', 'fgbfr', 'fgbl', 'fgrtfr', 'fgrtl', 'glfr', 'gll', 'glpfr', 'glpl', 'fr', 'mg', 'mr', 'vl', 'sr', ],
  hiddenSettingsModules: ['fm', 'sp1', 'sp2', 'sp3', ],
  actualModuleId: {
    113: 109,
    114: 110,
    115: 111,
    118: 111,
    30: 1,
    31: 2,
    32: 5,
    33: 6,
  },
  isIOS: function() {
    if (window.navigator.userAgent.toLowerCase().indexOf('ipad') > 0 || window.navigator.userAgent.toLowerCase().indexOf('iphone') > 0 || /iPad|iPhone|iPod/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {
      return true;
    }
    return false;
  },
  isIOS8: function() {
    var deviceAgent = navigator.userAgent.toLowerCase();
    return /(iphone|ipod|ipad).* os 8_/.test(deviceAgent);
  },
  isDefaultAndroid: function() {
    if (typeof window.nativeBridge != 'undefined' && window.nativeBridge.isSyncLockTablet() == true) {
      return false;
    }
    var navU = navigator.userAgent;
    var isAndroidMobile = navU.indexOf('Android') > -1 && navU.indexOf('Mozilla/5.0') > -1 && navU.indexOf('AppleWebKit') > -1;
    if (!isAndroidMobile && navU.indexOf('CriOS') > -1) {
      isAndroidMobile = true;
    }
    var regExAppleWebKit = new RegExp(/AppleWebKit\/([\d.]+)/);
    var resultAppleWebKitRegEx = regExAppleWebKit.exec(navU);
    var appleWebKitVersion = (resultAppleWebKitRegEx === null ? null : parseFloat(regExAppleWebKit.exec(navU)[1]));
    var regExChrome = new RegExp(/Chrome\/([\d.]+)/);
    var resultChromeRegEx = regExChrome.exec(navU);
    var chromeVersion = (resultChromeRegEx === null ? null : parseFloat(regExChrome.exec(navU)[1]));
    var isAndroidBrowser = isAndroidMobile && (appleWebKitVersion !== null && appleWebKitVersion < 537) || (chromeVersion !== null && chromeVersion < 37);
    return isAndroidBrowser;
  },
  onVoiceReady: function() {
    if (!this.voiceReadyCalledOnResponsiveVoiceInit) {
      this.voiceReadyCalledOnResponsiveVoiceInit = true;
    }
    this.responsiveVoiceReady.resolve();
  },
  init: function() {
    var _this = this;
    responsiveVoice.OnVoiceReady = function() {
      _this.onVoiceReady();
    };
    if (typeof app != 'undefined' && typeof app.jsVars != 'undefined') {
      if (typeof app.jsVars.moduleId != 'undefined' && Object.values(this.pollySettingsModules).indexOf(parseInt(app.jsVars.moduleId)) !== -1) {
        this.moduleId = app.jsVars.moduleId;
        this.defaultType = 'polly';
      }
    } else if (typeof jsVars != 'undefined') {
      if (typeof jsVars.moduleId != 'undefined' && Object.values(this.pollySettingsModules).indexOf(parseInt(jsVars.moduleId)) !== -1) {
        this.moduleId = jsVars.moduleId;
        this.defaultType = 'polly';
      }
    }
    if (typeof jsVars != 'undefined' && typeof jsVars.voiceURL != 'undefined') {
      this.voiceURL = jsVars.voiceURL;
      responsiveVoice.fallbackServicePath = jsVars.voiceURL;
    } else if (this.voiceURL) {
      responsiveVoice.fallbackServicePath = this.voiceURL;
    }
    if (typeof jsVars != 'undefined') {
      if (typeof jsVars.voiceType != 'undefined') {
        this.defaultType = jsVars.voiceType;
      }
      if (this.defaultType == 'polly' && typeof jsVars.voiceName != 'undefined') {
        this.defaultSpeakParams.polly.voice = this.getTextVoiceName(jsVars.voiceName);
      }
      if (this.defaultType == 'polly' && typeof jsVars.voiceSpeed != 'undefined') {
        this.defaultSpeakParams.polly.speed = this.getTextVoiceSpeed(jsVars.voiceSpeed);
      }
    }
    this.needInit = false;
  },
  checkParamChanges: function() {
    if (typeof jsVars != 'undefined' && ((typeof jsVars.voiceType != 'undefined' && this.defaultType !== jsVars.voiceType) || (this.defaultType == 'polly' && typeof jsVars.voiceName != 'undefined' && this.defaultSpeakParams.polly.voice != this.getTextVoiceName(jsVars.voiceName)) || (this.defaultType == 'polly' && typeof jsVars.voiceSpeed != 'undefined' && this.defaultSpeakParams.polly.speed != this.getTextVoiceSpeed(jsVars.voiceSpeed)))) {
      this.needInit = true;
    }
  },
  enableFallbackMode: function() {
    responsiveVoice.enableFallbackMode();
  },
  playURL: function(url, options) {
    options = (typeof options === 'undefined') ? {} : options;
    if (soundManager.supported()) {
      soundManager.destroySound('aSound');
      var onloadFunction = function(bSuccess) {};
      var noSpeechMark = false;
      if (typeof options['events'] != 'undefined' && typeof options['events']['onload'] != 'undefined') {
        onloadFunction = options['events']['onload'];
      }
      if (this.defaultType == 'polly') {
        if (typeof options['noSpeechMark'] != 'undefined') {
          noSpeechMark = options['noSpeechMark'];
        }
        var originalDefaultType = this.defaultType;
        var onplay = function() {};
        var onfinish = function() {
          app.labObject.responsiveVoice.defaultType = originalDefaultType;
        };
        var onstop = function() {
          app.labObject.responsiveVoice.defaultType = originalDefaultType;
        };
        var onerror = function() {};
        if (typeof options['onplay'] != 'undefined') {
          onplay = options['onplay'];
        }
        if (typeof options['onfinish'] != 'undefined') {
          onfinish = function() {
            options['onfinish']();
            app.labObject.responsiveVoice.defaultType = originalDefaultType;
          };
        }
        if (typeof options['onerror'] != 'undefined') {
          onerror = options['onerror'];
        }
        var s3Url = url;
        if (!this.isRequestLive) {
          s3Url = this.getS3Hash(url);
        }
        var soundProperties = {
          id: 'aSound',
          url: s3Url,
          onload: onloadFunction,
          autoLoad: true,
          onplay: onplay,
          onfinish: onfinish,
          onerror: onerror,
          onstop: onstop
        };
        var mySound = soundManager.createSound(soundProperties);
        var retry = false;
        var checkPromise = new Promise(function(resolve, reject) {
          var checkResponseInterval = setInterval(function() {
            if (mySound.readyState == 2) {
              if (retry) {
                clearInterval(checkResponseInterval);
                reject(false);
              }
              app.labObject.responsiveVoice.defaultType = 'fallback';
              noSpeechMark = true;
              mySound.url = url;
              mySound.load();
              retry = true;
            } else if (mySound.readyState >= 3) {
              clearInterval(checkResponseInterval);
              resolve(true);
            }
          }, 10);
        });
        Promise.allSettled([checkPromise]).then(function() {
          if (retry) {
            noSpeechMark = true;
          }
          if (this.isIOS()) {
            if (noSpeechMark) {
              mySound.play();
            } else {
              var tmpCheck = setInterval(function() {
                if (typeof options['text'] == 'undefined' || (typeof options['text'] != 'undefined' && typeof app.labObject.initedSoundsSpeechmarks[this.getSpeechMarkID(options['text'])] != 'undefined')) {
                  clearInterval(tmpCheck);
                  mySound.play();
                }
              }.bind(this), 10);
            }
          } else {
            var tmpCheck = setInterval(function() {
              if (mySound.readyState >= 2 && (noSpeechMark || typeof options['text'] == 'undefined' || (typeof options['text'] != 'undefined' && typeof app.labObject.initedSoundsSpeechmarks[this.getSpeechMarkID(options['text'])] != 'undefined'))) {
                clearInterval(tmpCheck);
                mySound.play();
              }
            }.bind(this), 10);
          }
        }.bind(this));
      } else {
        var mySound = soundManager.createSound({
          id: 'aSound',
          url: url,
          onload: onloadFunction
        });
        mySound.play();
      }
    }
  },
  getSpeakSoundUrl: function(text, options) {
    if (!text) {
      return;
    }
    var soundURL = '';
    if (this.defaultType == 'fallback') {
      if (!responsiveVoice.fallbackServicePath) {
        responsiveVoice.fallbackServicePath = this.voiceURLdefault;
      }
      soundURL = responsiveVoice.fallbackServicePath + '?t=' + encodeURIComponent(text.trim()) + "&tl=en-US&sv=&vn=&pitch=" + this.defaultSpeakParams.fallback.pitch + "&rate=" + this.defaultSpeakParams.fallback.rate + "&vol=" + this.defaultSpeakParams.fallback.vol;
    } else if (this.defaultType == 'polly') {
      soundURL = responsiveVoice.fallbackServicePath + '?t=' + encodeURIComponent(text.trim()) + "&voice=" + this.defaultSpeakParams.polly.voice + "&speed=" + this.defaultSpeakParams.polly.speed + '&moduleId=' + this.getActualModuleId(this.moduleId);
      if (this.isRequestLive) {
        soundURL += '&apiType=polly&live=true';
      }
    }
    soundURL += '&apiType=' + this.defaultType;
    return soundURL;
  },
  getSpeechMarkUrl: function(text) {
    var speechMarkUrl = '';
    if (this.defaultType == 'polly' && text.length <= 3000) {
      if (this.isRequestLive) {
        speechMarkUrl = responsiveVoice.fallbackServicePath + '?t=' + encodeURIComponent(text.trim()) + "&voice=" + this.defaultSpeakParams.polly.voice + "&speed=" + this.defaultSpeakParams.polly.speed + '&moduleId=' + this.getActualModuleId(this.moduleId) + '&apiType=polly&type=json&live=true';
      } else {
        speechMarkUrl = this.checkPollyFile('json', this.defaultSpeakParams.polly.voice, this.defaultSpeakParams.polly.speed, text.trim(), this.getActualModuleId(this.moduleId));
      }
    }
    return speechMarkUrl;
  },
  getSpeechMarkID: function(text) {
    return text + '_' + this.defaultSpeakParams.polly.voice + '_' + this.defaultSpeakParams.polly.speed;
  },
  capitalizeFirstLetter: function(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  },
  checkPollyFile: function(type, voice, speed, text, moduleId) {
    var hashFile = forge_sha256(this.capitalizeFirstLetter(voice) + '_' + speed + '_' + text.trim() + '_' + type) + '.' + type;
    var firstFolder = hashFile.substring(0, 2);
    var secondFolder = hashFile.substring(2, 4);
    var vars = {};
    if (typeof jsVars !== 'undefined') {
      vars = jsVars;
    } else if (typeof app.jsVars !== 'undefined') {
      vars = app.jsVars;
    }
    var pathToFile = '';
    if (typeof vars.bucketURL === 'undefined') {
      console.error('Missing javascript variable for the S3 bucket.');
    } else {
      var bucketUrl = vars.bucketURL;
      if (!bucketUrl.endsWith('/')) {
        bucketUrl += '/';
      }
      var moduleFolder = (moduleId) ? moduleId : this.moduleId;
      moduleFolder = this.getActualModuleId(moduleFolder);
      pathToFile = bucketUrl + 'tts/' + moduleFolder + '/' + firstFolder + '/' + secondFolder + '/' + hashFile;
    }
    return pathToFile;
  },
  getS3Hash: function(url) {
    var soundUrl = new URL(url);
    if (this.defaultType == 'polly' && soundUrl.pathname.indexOf('ResponsiveVoice/getvoice.php') !== -1) {
      var type = soundUrl.searchParams.get('type') || 'mp3';
      var text = soundUrl.searchParams.get('t');
      var voice = soundUrl.searchParams.get('voice');
      var speed = soundUrl.searchParams.get('speed');
      var moduleId = soundUrl.searchParams.get('moduleId') || this.moduleId;
      if (text.length <= 3000) {
        moduleId = this.getActualModuleId(moduleId);
        var pollyResponse = this.checkPollyFile(type, voice, speed, text, moduleId);
        if (pollyResponse.length > 0) {
          return pollyResponse;
        }
      }
    }
    return url;
  },
  speak: function(text, options) {
    this.checkParamChanges();
    if (this.needInit) this.init();
    var optionsFinal = (typeof options === 'undefined') ? {} : ((typeof options[this.defaultType] === 'undefined') ? {} : Object.assign({}, options[this.defaultType]));
    var speakOptions = $.extend({}, this.defaultSpeakParams[this.defaultType], optionsFinal);
    var finalText = encodeURIComponent(text.trim());
    var currentDefaultType = this.defaultType;
    if (this.defaultType == 'polly' && finalText.length > 3000) {
      this.defaultType = 'fallback';
    }
    var soundURL = '';
    if (this.defaultType == 'polly') {
      var currentModuleId = this.getActualModuleId(this.moduleId);
      if (typeof speakOptions.moduleId != 'undefined') {
        currentModuleId = speakOptions.moduleId;
      }
      soundURL = responsiveVoice.fallbackServicePath + '?t=' + finalText + "&voice=" + speakOptions.voice + "&speed=" + speakOptions.speed + "&apiType=" + this.defaultType + '&moduleId=' + currentModuleId;
      if (this.isRequestLive) {
        soundURL += '&live=true';
      }
      if (typeof soundManagerLoaded != 'undefined') {
        var _this = this;
        $.when(soundManagerLoaded.promise()).done(function(sm) {
          _this.playURL(soundURL, optionsFinal);
        });
      } else {
        this.playURL(soundURL, optionsFinal);
      }
    } else if (this.defaultType == 'fallback') {
      if (!responsiveVoice.fallbackServicePath) {
        responsiveVoice.fallbackServicePath = this.voiceURLdefault;
      }
      if (!text.trim().endsWith('.')) {
        text += '. ';
      }
      if (typeof optionsFinal['events'] === 'undefined') {
        optionsFinal['events'] = {};
      }
      if (typeof optionsFinal['events']['onload'] !== 'undefined') {
        delete optionsFinal['events']['onload'];
      }
      var currentActualDefaultType = this.defaultType;
      optionsFinal['events']['onload'] = function(success) {
        if (typeof options !== 'undefined' && typeof options[currentActualDefaultType] !== 'undefined' && typeof options[currentActualDefaultType]['events'] !== 'undefined' && typeof options[currentActualDefaultType]['events']['onload'] !== 'undefined') {
          options[currentActualDefaultType]['events']['onload'](success);
        }
        if (!success) {
          var tmpOptions = {
            'rate': 0.75
          };
          responsiveVoice.speak(text, this.defaultSpeakParams.fallback.voice, tmpOptions);
        }
      }.bind(this);
      soundURL = responsiveVoice.fallbackServicePath + '?t=' + finalText + "&tl=en-US&sv=&vn=&pitch=" + this.defaultSpeakParams.fallback.pitch + "&rate=" + this.defaultSpeakParams.fallback.rate + "&vol=" + this.defaultSpeakParams.fallback.vol + "&apiType=" + this.defaultType;
      if (typeof soundManagerLoaded != 'undefined') {
        var _this = this;
        $.when(soundManagerLoaded.promise()).done(function(sm) {
          _this.playURL(soundURL, optionsFinal);
        });
      } else {
        this.playURL(soundURL, optionsFinal);
      }
    }
    this.defaultType = currentDefaultType;
  },
  stop: function() {
    if (!!responsiveVoice && typeof responsiveVoice.cancel === 'function')
      responsiveVoice.cancel();
    if (!!responsiveVoice && typeof responsiveVoice.checkAndCancelTimeout === 'function') {
      responsiveVoice.checkAndCancelTimeout();
    }
  },
  isPlaying: function() {
    var soundManagerSoundPlaying = (soundManager.sounds.hasOwnProperty('aSound') ? (soundManager.sounds['aSound'].playState && soundManager.sounds['aSound'].readyState != 2) : false);
    return (soundManagerSoundPlaying || (!!responsiveVoice && typeof responsiveVoice.isPlaying === 'function' && responsiveVoice.isPlaying())) ? true : false;
  },
  findMappedVoiceData: function(id, type) {
    return this.voicesData[type].filter(function(element) {
      return parseInt(element.id) === parseInt(id);
    });
  },
  getTextFrontendVoiceName: function(id) {
    return this.findMappedVoiceData(id, 'mappedNames')[0].frontendValue;
  },
  getTextVoiceName: function(id) {
    return this.findMappedVoiceData(id, 'mappedNames')[0].awsValue;
  },
  getTextVoiceSpeed: function(id) {
    return this.findMappedVoiceData(id, 'mappedSpeeds')[0].awsValue;
  },
  setVoiceValues: function(name, speed, initedSounds) {
    var voiceName = this.getTextVoiceName(name);
    var voiceSpeed = this.getTextVoiceSpeed(speed);
    if (initedSounds) {
      this.reloadAllSounds(voiceName, voiceSpeed, initedSounds)
    }
    if (typeof jsVars != 'undefined') {
      jsVars.voiceName = name;
      jsVars.voiceSpeed = speed;
    }
    this.defaultSpeakParams.polly.voice = voiceName;
    this.defaultSpeakParams.polly.speed = voiceSpeed;
  },
  getSpeechHighlight: function() {
    return this.defaultSpeakParams.polly.isSpeechHighlight !== null ? this.defaultSpeakParams.polly.isSpeechHighlight : (typeof jsVars == 'undefined' || (typeof jsVars != 'undefined' && (typeof jsVars.isSpeechHighlight == 'undefined' || (typeof jsVars.isSpeechHighlight != 'undefined' && jsVars.isSpeechHighlight > 0))));
  },
  setSpeechHighlight: function(isSpeechHighlight) {
    if (typeof jsVars != 'undefined') {
      jsVars.isSpeechHighlight = isSpeechHighlight;
    }
    this.defaultSpeakParams.polly.isSpeechHighlight = isSpeechHighlight;
  },
  reloadAllSounds: function(voice, speed, initedSounds) {
    if ((voice !== this.defaultSpeakParams.polly.voice || speed !== this.defaultSpeakParams.polly.speed) && Object.values(initedSounds).length > 0) {
      Object.keys(initedSounds).forEach(function(key) {
        soundManager.destroySound(key);
        var item = initedSounds[key].options;
        item.url = item.url.replace(/\&voice=([A-z]+)(&|$)/, '&voice=' + voice + '$2').replace(/\&speed=([A-z]+)(&|$)/, '&speed=' + speed + '$2');
        initedSounds[key] = soundManager.createSound(item).load();
      });
    }
  },
  getActualModuleId: function(moduleId) {
    if (this.actualModuleId.hasOwnProperty(moduleId)) {
      return this.actualModuleId[moduleId];
    }
    return moduleId;
  }
};;
(function($, window, document, undefined) {
  "use strict";
  var pluginName = 'mobyVideo';
  var dataKey = 'plugin_' + pluginName;
  var idx = 1;

  function Plugin(element, options) {
    var base = this;
    var el = element;
    var $el = $(element);
    var childPath = '';
    var iframe = $el[0].contentWindow;
    options = $.extend({}, $.fn[pluginName].defaults, options);

    function init() {
      var title = 'mobyPlayer' + (idx++);
      $el.attr('id', title);
      $el.attr('name', title);
      var parser = document.createElement('a');
      parser.href = $el.attr('src');
      childPath = parser.protocol + '//' + parser.hostname;
      $(window).on("message onmessage", dispatcher);
    }

    function dispatcher(e) {
      if (e.originalEvent.origin !== childPath) {
        return;
      }
      var messageData = JSON.parse(e.originalEvent.data);
      if (messageData["act"]) {
        if (messageData["act"] != 'onIframeReady') {
          if (typeof options[messageData["act"]] == 'function') {
            if (messageData["data"]) {
              var data = JSON.parse(messageData["data"]);
              hook(messageData["act"], data);
            } else {
              hook(messageData["act"]);
            }
            return;
          }
        } else {
          var msg_toSend = {};
          if (options.playerFeatures) {
            msg_toSend['playerFeatures'] = options.playerFeatures;
          }
          if (options.responsive) {
            var el = (options.fallbackContainerEl && $el.width() > $(options.fallbackContainerEl).width() && $el.width() > $(window).width()) ? $(options.legacyContainerEl) : $el;
            msg_toSend['playerSize'] = {
              'height': el.height(),
              'width': el.width()
            };
          }
          sendMessage(msg_toSend);
        }
      }
    }

    function sendMessage(data) {
      var dataToSend = JSON.stringify(data);
      iframe.postMessage(dataToSend, childPath);
    }

    function option(key, val) {
      if (val) {
        options[key] = val;
      } else {
        return options[key];
      }
    }

    function hook(hookName) {
      var args = arguments;
      if (options[hookName] !== undefined) {
        options[hookName].apply(el, Array.prototype.slice.call(args, 1));
      }
    }
    init();
    return {
      'option': option,
      'sendMessage': sendMessage
    };
  }
  $.fn[pluginName] = function(options) {
    if (typeof arguments[0] === 'string') {
      var methodName = arguments[0];
      var args = Array.prototype.slice.call(arguments, 1);
      var returnVal;
      this.each(function() {
        if ($.data(this, dataKey) && typeof $.data(this, dataKey)[methodName] === 'function') {
          returnVal = $.data(this, dataKey)[methodName].apply(this, args);
        } else {
          throw new Error('Method ' + methodName + ' does not exist on jQuery.' + pluginName);
        }
      });
      if (returnVal !== undefined) {
        return returnVal;
      } else {
        return this;
      }
    } else if (typeof options === "object" || !options) {
      return this.each(function() {
        if (!$.data(this, dataKey)) {
          $.data(this, dataKey, new Plugin(this, options));
        }
      });
    }
  };
  $.fn[pluginName].defaults = {
    playerFeatures: null,
    responsive: true,
    onInitSuccess: function() {},
    onInitError: function() {},
    onPlay: function(e) {},
    onPause: function(e) {},
    onLoadedMetadata: function(e) {},
    onSeeked: function(e) {},
    onVideoEnded: function(e) {},
    onVideoPlaying: function(e) {},
    onVideoSuspended: function(e) {},
    onVideoSeeking: function(e) {},
    onVideoStalled: function(e) {},
    onVideoWaiting: function(e) {}
  };
})(jQuery, window, document);
const TextFinder = function(options) {
  var t = this;
  if (typeof options['identifier'] == 'undefined') {
    throw new Error('Missing identifier');
  }
  for (var opt in options) {
    t[opt] = options[opt];
  }
  t.skipTagsRegex = new RegExp('^(' + t.skipTags.join('|') + ')$', 'i');
  t.skipClassesRegex = new RegExp('(' + t.skipClasses.join('|') + ')', 'i');
}
var repeatedWords = [];
var repeatedCounts = {};
TextFinder.prototype = {
  foundTagName: 'div',
  foundTagClass: 'aligned-word',
  skipTags: [],
  skipClasses: [],
  root: null,
  currentDepth: -1,
  currentNode: null,
  lastSuccessfulNode: null,
  lastSuccessfulDepth: -1,
  currentText: '',
  active: true,
  identifier: null,
  reset: function() {
    this.lastSuccessfulNode = null;
    this.lastSuccessfulDepth = -1;
  },
  next: function(text) {
    var _this = this;
    _this.currentText = text;
    var pos = repeatedWords[_this.identifier].indexOf(text);
    if (pos > -1) {
      repeatedCounts[_this.identifier][text]++;
    }
    if (_this.lastSuccessfulNode == null) {
      _this.currentNode = _this.root.childNodes[0];
      _this.currentDepth = 1;
    } else {
      _this.currentNode = _this.lastSuccessfulNode;
      _this.currentDepth = _this.lastSuccessfulDepth;
    }
    if (repeatedCounts[_this.identifier][text] > 1 && _this.lastSuccessfulNode != null && _this.lastSuccessfulNode.childNodes.length > 0) {
      _this.currentNode = _this.lastSuccessfulNode.nextSibling;
    }
    return _this._searchNodes.call(_this);
  },
  _searchNodes: function() {
    var _this = this;
    var foundNode = null;
    while (_this.currentNode && _this.currentDepth > 0 && foundNode == null) {
      switch (_this.currentNode.nodeType) {
        case 1:
          var conditionals = !_this.skipTagsRegex.test(_this.currentNode.tagName.toLowerCase()) && _this.currentNode.childNodes.length > 0;
          if (typeof _this.currentNode.className === 'string') {
            conditionals = conditionals && !_this.skipClassesRegex.test(_this.currentNode.className.toLowerCase());
          }
          if (conditionals) {
            _this.currentNode = _this.currentNode.childNodes[0];
            _this.currentDepth++;
            continue;
          }
          break;
        case 3:
        case 4:
          foundNode = _this._findTextInNode.call(_this);
          if (foundNode != null) {
            _this.lastSuccessfulNode = foundNode.nextSibling;
            _this.lastSuccessfulDepth = _this.currentDepth;
            _this.currentNode = null;
            _this.currentDepth = -1;
            return foundNode;
          }
          break;
      }
      if (_this.currentNode.nextSibling) {
        _this.currentNode = _this.currentNode.nextSibling;
      } else {
        while (_this.currentDepth > 0) {
          _this.currentNode = _this.currentNode.parentNode;
          _this.currentDepth--;
          if (_this.currentNode.nextSibling) {
            _this.currentNode = _this.currentNode.nextSibling;
            break;
          }
        }
      }
    }
    return null;
  },
  escapeString: function(string) {
    return string.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&');
  },
  _findTextInNode: function() {
    var _this = this;
    var currentTextAlternativeQuotes = _this.currentText.replace("'", "’");
    var usedExpression = '\\b(' + _this.currentText + '|' + _this.escapeString(currentTextAlternativeQuotes) + ')';
    if (_this.currentText.length != _this.escapeString(_this.currentText).length || !/^[a-z0-9']+$/i.test(_this.currentText)) {
      usedExpression = _this.escapeString(_this.currentText);
    }
    var matchWordExpression = new RegExp(usedExpression);
    var wordIndex = _this.currentNode.data.search(matchWordExpression);
    if (wordIndex > -1) {
      var targetNode = (_this.currentNode.nodeType == 1) ? _this.currentNode.firstChild : _this.currentNode;
      var wordNode = targetNode.splitText(wordIndex);
      var afterWord = wordNode.splitText(_this.currentText.length);
      var beforeWord = targetNode;
      highlightedWord = wordNode.ownerDocument.createElement(_this.foundTagName);
      highlightedWord.style.display = "initial";
      wordNode.parentNode.replaceChild(highlightedWord, wordNode);
      highlightedWord.setAttribute('class', _this.foundTagClass);
      highlightedWord.appendChild(wordNode);
      return highlightedWord;
    }
    return null;
  }
};

function InteractiveVoice() {
  this.currentWordClass = 'current-speechmark';
  this.timingData = {};
  this.isLoaded = $.Deferred();
}
InteractiveVoice.prototype = new InteractiveVoice();
InteractiveVoice.prototype.constructor = InteractiveVoice;
InteractiveVoice.prototype.disable = function(identifier) {
  if (typeof this.timingData[identifier] != 'undefined') {
    this.timingData[identifier].textFinder.active = false;
  }
};
InteractiveVoice.prototype.doHighlight = function(_this, i, identifier) {
  if (!_this.timingData[identifier].textFinder.active) {
    return;
  }
  const currentData = _this.timingData[identifier];
  if (currentData.words[i][0] === '__disabled__') {
    _this.highlightWord(_this, ++i, identifier);
    return;
  }
  _this.selectWord(identifier, i);
  if (i == (_this.timingData[identifier].words.length - 1)) {
    setTimeout(function() {
      _this.cleanUpNodes(identifier);
    }.bind(_this), currentData.words[i][2] - currentData.words[i][1]);
  }
  if (i < _this.timingData[identifier].words.length - 1) {
    _this.highlightWord(_this, ++i, identifier);
  }
}
InteractiveVoice.prototype.highlightWord = function(_this, i, identifier) {
  const currentData = _this.timingData[identifier];
  setTimeout(function() {
    _this.doHighlight(_this, i, identifier);
  }, currentData.words[i][2] - currentData.words[i][1] - 10);
}
InteractiveVoice.prototype.cleanUpNodes = function(previousSpeechmarkInstance) {
  $('.' + TextFinder.prototype.foundTagClass).each(function() {
    $(this).replaceWith($(this).text());
  });
};
InteractiveVoice.prototype.preload = function(identifier) {
  if (typeof identifier == 'undefined') {
    throw new Error('Missing identifier');
  }
  repeatedWords[identifier] = [];
  repeatedCounts[identifier] = {};
  const currentData = this.timingData[identifier];
  for (var i = 0; i < currentData.words.length; i++) {
    if (currentData.words[i][0] === '__disabled__') {
      continue;
    }
    if (currentData.words[i + 1] && currentData.words[i + 1][0] && currentData.words[i][0] == currentData.words[i + 1][0]) {
      var word = currentData.words[i][0];
      repeatedWords[identifier].push(word);
      repeatedCounts[identifier][word] = 0;
    }
    var node = currentData.textFinder.next(currentData.words[i][0]);
    if (node != null) {
      this.timingData[identifier].words[i][3] = node;
    }
  }
  this.isLoaded.resolve({
    identifier
  });
};
InteractiveVoice.prototype.add = function(fieldName, targetClass, speechMarks, identifier) {
  if (typeof identifier == 'undefined') {
    throw new Error('Missing identifier');
  }
  var audioElement = null;
  if (typeof soundManager.getSoundById(fieldName) != 'undefined') {
    audioElement = soundManager.getSoundById(fieldName);
  } else {
    audioElement = soundManager.getSoundById('aSound');
  }
  this.timingData[identifier] = {
    target: targetClass[0],
    audio: audioElement,
    words: (speechMarks ? speechMarks : []),
    textFinder: null,
  };
  const skipClasses = ['cf', 'note', 'v-num'];
  this.timingData[identifier].textFinder = new TextFinder({
    root: this.timingData[identifier].target,
    skipTags: ['exclude', 'h1', 'h2', 'h3'],
    skipClasses,
    identifier
  });
};
InteractiveVoice.prototype.play = function(identifier) {
  if (this.timingData[identifier].words.length) {
    var _this = this;
    const currentData = this.timingData[identifier];
    var node = currentData.words[0][3];
    if (typeof node == 'undefined') {
      if (currentData.words[i + 1] && currentData.words[i + 1][0] && currentData.words[i][0] == currentData.words[i + 1][0]) {
        var word = currentData.words[i][0];
        repeatedWords.push(word);
        repeatedCounts[word] = 0;
      }
      node = currentData.textFinder.next(currentData.words[0][0]);
      if (node != null) {
        _this.timingData[identifier].words[0][3] = node;
      }
    }
    this.selectWord(identifier, 0);
    if (typeof currentData.words[1] != 'undefined') {
      setTimeout(function() {
        _this.highlightWord(_this, 1, identifier);
      }, currentData.words[0][2] - currentData.words[0][1]);
    } else {
      setTimeout(function() {
        _this.cleanUpNodes(identifier);
      }, currentData.words[0][2] - currentData.words[0][1]);
    }
  }
  this.timingData[identifier].textFinder.reset();
};
InteractiveVoice.prototype.clearCurrentWord = function(target) {
  if ($(target).find('.' + this.currentWordClass).length) {
    $(target).find('.' + this.currentWordClass).removeClass(this.currentWordClass);
  }
};
InteractiveVoice.prototype.selectWord = function(fieldName, wordIndex) {
  var currentData = this.timingData[fieldName];
  if (typeof currentData != 'undefined') {
    this.clearCurrentWord(currentData.target);
    var node = currentData.words[wordIndex][3];
    if (typeof node != 'undefined') {
      node.className += ' ' + this.currentWordClass;
      node.focus();
    }
  }
};
InteractiveVoice.prototype.determineElement = function(event, isEventNull) {
  var defaultElement = (!$('.lab-problem').hasClass('ms-show-feedback')) ? $('.lab-problem .problem-statement') : $('.lab-problem .problem-feedback');
  if (!isEventNull && typeof event.target != 'undefined' && !$(event.target).hasClass('pbl-game-mc-answer')) {
    var defaultElement = $(event.target).parent();
    if (defaultElement.hasClass('ms-pbl-statement-sound-paragraph') || defaultElement.hasClass('ms-pbl-statement') || (defaultElement[0] && defaultElement[0].tagName === 'P' && defaultElement[0] && defaultElement[0].className === '')) {
      defaultElement = defaultElement.parent();
    } else if (defaultElement.hasClass('pbl-hotspot')) {
      defaultElement = $(defaultElement).next();
    } else if (defaultElement.hasClass('pbl-fluency-game-wrapper') && !$(event.target).hasClass('pbl-fluency-game-element-image')) {
      defaultElement = $(event.target);
    }
    if (defaultElement.siblings('.check-all').length) {
      defaultElement = $(defaultElement).parent();
    } else if (defaultElement.text().length == 0 && defaultElement.find('img:not(.play_icon)').length > 0) {
      defaultElement = $(defaultElement).parent();
    }
  } else if (!isEventNull && $(event.target).hasClass('pbl-game-mc-answer')) {
    defaultElement = $(event.target);
  }
  return defaultElement;
}
if (typeof module === "object" && module.exports) {
  module.exports = InteractiveVoice;
}
if (typeof module === "object" && module.exports) {
  var LabClass = function() {};
  module.exports = LabClass;
  var LabResponsiveVoice = require('./responsiveVoice');
  for (var m in LabResponsiveVoice.prototype)
    LabClass.prototype[m] = LabResponsiveVoice.prototype[m];
  var labProblem = require('../labProblem');
  var PxLoader = require('./PxLoader');
  var InteractiveVoice = require('./interactiveVoice');
  require('../mobyVideo');
  require('../forge-sha256.min');
}

function parseString(str) {
  return str.replace(/<\/?[^>]+(>|$)/g, '');
}
LabClass.prototype.init = function() {
  this.soundManagerLoaded = $.Deferred();
  this.soundStatus = 0;
  this.responsiveVoice.init();
  this.hasAnySoundPlayed = false;
  this.initedSounds = {};
  this.initedSoundsReady = {};
  this.initedSoundPlaying = false;
  this.initedSoundCurrently = null;
  this.initedSoundLast = null;
  this.initedSoundPlayingRetryTimer = {}
  this.initedSoundPlayingRetryCount = {};
  this.initedSoundSecureTimer = null;
  this.initedSoundPlayCallbackTimers = {};
  this.initedSoundPlayFinishedTimers = {};
  this.initedSoundInitCallbackTimers = {};
  this.initedSoundPromiseTimer = {};
  this.initedSoundPromiseLoadedTimer = {};
  this.initedSoundPromises = {};
  this.initedSoundPlayPromises = {};
  this.initedSoundPlayPromisesTimers = {};
  this.onLoadSoundFailed = function(id, url, sound) {};
  this.initedSoundsSpeechmarks = {};
  this.interactiveVoice = new InteractiveVoice();
  this.previousSpeechmarkInstance;
  this.isAutosoundTriggered = false;
  this.mp3FieldNames = ['VoiceFile', 'VoiceAndMusicFile', 'StatementVoice', 'IntroFakeText', 'ProblemReadText'];
  this.onEndSoundEventWrapper = function() {
    if (typeof window.app.labObject.soundSetting !== 'undefined' && window.app.labObject.soundSetting == 0) return;
    if (window.app.labObject.CurrentProblem && window.app.labObject.CurrentProblem.TypeNew && window.app.labObject.CurrentProblem.TypeNew.indexOf('Manipulative') >= 0 && window.app.labObject.CurrentProblem.ProblemFormat == 'Game MC') {
      if ($('.ms-pbl-statement-sound-paragraph').find('.auto_play_icon').length == 1 && (this.soundTriggerEvent == null || (typeof this.soundTriggerEvent == 'object' && $(this.soundTriggerEvent.target).parent().hasClass('ms-pbl-statement-sound-paragraph')))) {
        var tmpEvent = {
          target: $('.ms-pbl-statement-sound-paragraph').find('.auto_play_icon')[0]
        };
        $(document).trigger('MSLab.soundDonePlaying', tmpEvent);
      } else {
        var passedEvent = (this.soundTriggerEvent) ? this.soundTriggerEvent : {};
        $(document).trigger('MSLab.soundDonePlaying', passedEvent);
      }
    }
  };
  this.autoSoundPlayTTSEvent = null;
  this.soundTriggerEvent = null;
  this.resetSoundTriggerEvent = function() {
    this.soundTriggerEvent = null;
  };
  soundManager.setup({
    debugMode: false,
    flashVersion: 8,
    useFlashBlock: false,
    flashLoadTimeout: 40000,
    allowScriptAccess: 'always',
    noSWFCache: true,
    preferFlash: false,
    url: location.protocol + '//mobymax.com/MM/css/swf/',
    html5Test: /^(probably|maybe)$/i,
    ignoreMobileRestrictions: true,
    ontimeout: function(status) {
      if (status.type == 'NO_FLASH') this.soundStatus = 4;
      else if (status.type == 'INIT_TIMEOUT') this.soundStatus = 5;
      else this.soundStatus = 7;
      this.soundManagerLoaded.reject();
    }.bind(this),
    onready: function() {
      this.soundManagerLoaded.resolve();
    }.bind(this)
  });
  soundManager.onready(function() {
    this.soundManagerLoaded.resolve();
  }.bind(this));
};
LabClass.prototype.isSoundPlaying = function() {
  var soundManagerSoundPlaying = false;
  for (oSound in soundManager.sounds) {
    if (soundManager.sounds.hasOwnProperty(oSound)) {
      soundManagerSoundPlaying = soundManagerSoundPlaying || (soundManager.sounds[oSound].playState == 1 && soundManager.sounds[oSound].readyState != 2);
      if (soundManagerSoundPlaying) {
        break;
      }
    }
  }
  return (this.responsiveVoice.isPlaying() || soundManagerSoundPlaying);
};
LabClass.prototype.autoSoundParseField = function(objIn, fields) {
  var result = '';
  if (fields == 'all') {
    $('.lab-problem .problem-statement *:not(:has(*))').each(function() {
      var t = $(this).text().trim();
      if (t != '') result = result + t + '. ';
    });
    return result;
  }
  var fieldArr = fields.split('+');
  for (var fi = 0; fi < fieldArr.length; fi++) {
    var obj = objIn;
    field = fieldArr[fi];
    field = field.replace(/\[(\w+)\]/g, '.$1');
    field = field.replace(/^\./, '');
    var a = field.split('.');
    var found = true;
    for (var i = 0, n = a.length; i < n; ++i) {
      var k = a[i];
      if (typeof obj === 'object' && k in obj) {
        obj = obj[k];
      } else {
        found = false;
        break;
      }
    }
    if (found && obj !== null && obj != '') {
      if (result != '') result += '. ';
      result += obj;
    }
  }
  return result;
};
LabClass.prototype.noOp = function() {};
LabClass.prototype.autoSound = function(selector, problem) {
  var _this = this;
  this.autoSoundList = [];
  this.onStartSoundEvent = (arguments.length > 2) ? arguments[2] : this.noOp;
  this.onEndSoundEvent = (arguments.length > 3) ? arguments[3] : this.noOp;
  this.CurrentProblem = problem;
  this.hasAnySoundPlayed = false;
  var playIcons = $('.play_icon, .play_icon_mc, .play_icon_img, .play_icon_caption', '.lab-problem .problem-statement');
  playIcons.each(function() {
    if ($(this).attr('onclick')) {
      var playFields = $(this).attr('onclick').match(/['|"](.+)['|"]/)[1];
      $(this).removeAttr('onclick').unbind('click').bind('click', function(e) {
        _this.stopSounds();
        window.app.labObject.play(playFields);
      });
    }
  });
  $(selector + ' .auto_play_icon').on('click', function(e) {
    _this.autoSoundClick(e, problem);
  });
  $(selector + ' .pbl-hotspot-invisible-sound-icon').on('click', function(e) {
    _this.autoSoundClick(e, problem);
    $(this).hide();
    $(document.elementFromPoint(e.clientX, e.clientY)).trigger("click");
    $(this).show();
  });
};
LabClass.prototype.cleanSoundText = function(s, fieldTypeBasedCleanup) {
  function replaceUnicode(s) {
    var charMap = {
      '‘': '\'',
      '’': '\'',
      '“': '"',
      '”': '"',
      '…': '...',
      '&#133;': '...',
      '—': '-',
      'é': 'e'
    };
    return s.replace('\u200b', '').replace(/[^\x00-\x80]|&#?[a-z0-9]{1,6};/g, function(c) {
      return charMap[c] ? charMap[c] : c;
    });
  }
  var cleanText = replaceUnicode(s);
  if (typeof fieldTypeBasedCleanup == 'function') {
    cleanText = fieldTypeBasedCleanup(cleanText);
  }
  cleanText = cleanText.trim();
  cleanText = cleanText.replace(/^<br\s*\/?>|<br\s*\/?>$/gm, '');
  cleanText = cleanText.replace(/_{2,}/gm, ' blank ');
  cleanText = cleanText.replace(/<input type=['" ]*text(?:.|\n)*?>/gm, ' blank ');
  cleanText = cleanText.replace(/\[ *?"(?:.|\n)*?\]/gm, ' blank ');
  cleanText = cleanText.replace(/&#?[a-z0-9]{1,6};/gm, ' ');
  cleanText = cleanText.replace(/[\?]\./gm, '?');
  cleanText = cleanText.replace(/(\.)([a-z|<])/gmi, '$1 $2');
  cleanText = cleanText.replace(/( )*(\r?\n|<br>|<br\/>)+/gm, '\n');
  cleanText = cleanText.replace(/<\/?\w*\b[^>]*>/gm, '');
  cleanText = cleanText.replace(/\s+\n/g, '\n');
  cleanText = cleanText.replace(/([.?!][\\\s]?"\s*)\n/g, '$1 ');
  cleanText = cleanText.replace(/(\w|")\n/g, '$1. ');
  cleanText = cleanText.replace(/(\."\.)/g, '." ');
  cleanText = cleanText.replace(/\n\./g, '.');
  cleanText = cleanText.replace(/([.?!,;:–\-\]\)]'?)\s*\n+/g, '$1 ');
  cleanText = cleanText.replace(/^\s+|\s+$/gm, ' ');
  cleanText = cleanText.replace(/ +/g, ' ');
  cleanText = cleanText.trim();
  return cleanText;
};
LabClass.prototype.autoSoundCleanup = function(s, field, problem) {
  if (typeof field != 'undefined' && field.indexOf(".") != -1) {
    fieldArray = field.split(".");
    if (fieldArray[0] == "ProblemPage" && typeof fieldArray[1] != 'undefined' && typeof fieldArray[2] != 'undefined' && fieldArray[1] == 0) {
      field = fieldArray[2];
    }
  }
  var fieldTypeBasedCleanup = null;
  if (field && ['StatementText', 'Feedback'].indexOf(field) >= 0 && typeof problem != 'undefined') {
    var cleanupField = {
      'StatementText': function(fieldValue, fieldName, problem) {
        if (problem && problem.TypeNew && problem.TypeNew == 'Quiz' && problem.ProblemType == 'MC' && problem.IsChoiceRadio != 1 && (problem.DontShowMCCheckAllText == '' || problem.DontShowMCCheckAllText == null || problem.DontShowMCCheckAllText == 0)) {
          fieldValue += ((fieldValue.trim() != '' && ([".", "?", "!"].indexOf(fieldValue.trim().slice(-1)) == -1)) ? '. ' : '') + ' Check all that are true.';
        }
        if (problem && problem.TypeNew && problem.TypeNew.indexOf('Manipulative') >= 0 && problem.ProblemFormat == 'Short-Short') {
          fieldValue = fieldValue.replace(/\[ *?"(?:.|\n)*?\]/gm, ' ');
        }
        return fieldValue;
      },
      'Feedback': function(fieldValue, fieldName, problem) {
        return fieldValue.replace(/<caption(?:.|[\r\n])*?<\/caption>/gmi, '').replace(/([.?!,;:]?)<ul.*?>(.*)<\/ul>/gmi, '$1. $2').replace(/(\.\.|\?\.|!\.|,\.|;\.|:\.])/gmi, '.').replace(/<li[^>]*>([^<]*)<\/li>/gmi, '$1. ').replace(/<\s*div[^>]*><\s*div[^>]*>&bull;<\s*\/\s*div><\s*div[^>]*><b>(.*?)<\s*\/\s*b><\s*\/\s*div><\s*\/\s*div>/gmi, '$1. ');
      }
    };
    fieldTypeBasedCleanup = function(s) {
      return cleanupField[field](s, field, problem);
    };
  }
  s = this.cleanSoundText(s, fieldTypeBasedCleanup);
  return s;
};
LabClass.prototype.preInitSounds = function(elements) {
  var _this = this;
  var loadedSoundsKeys = [];
  elements.forEach(function(e) {
    if (typeof e === 'object') {
      var snd = e.attr('data-sound');
      var sndPriority = snd ? snd.replace(/http:/gm, 'http/').replace(/https:/gm, 'https/').split('|') : [];
      for (var i = 0; i < sndPriority.length; i++) {
        var sndTypeAndVal = sndPriority[i].split(':');
        if (sndTypeAndVal.length > 1) {
          var sndType = parseInt(sndTypeAndVal[0]);
          var sndVal = sndTypeAndVal.splice(1).join().replace(/http\//gm, 'http:').replace(/https\//gm, 'https:');
          if ((sndType & 15) == 0) {
            var sndField = ((sndType >> 4) == 0) ? _this.autoSoundParseField(this.CurrentProblem, sndVal) : sndVal;
            if (sndField) {
              var soundUrl = _this.getSoundFilename(_this.CurrentProblem.pkMLProblemID, sndField.trim());
              _this.initSound(sndField.trim() + '-' + _this.CurrentProblem.pkMLProblemID, soundUrl);
              loadedSoundsKeys.push(sndField.trim() + '-' + _this.CurrentProblem.pkMLProblemID);
              return;
            }
          }
        }
      }
    }
    if (typeof e === 'string') {
      _this.initSound(e, e);
      loadedSoundsKeys.push(e);
    }
  });
  return loadedSoundsKeys;
};
LabClass.prototype.initProblemsSoundsPart = function(problems, problemKey, currentProblem, audioServer) {
  var _this = this;
  if (problems && Array.isArray(problems) && problems.length > 0) {
    var countBack = 1;
    var countForward = 3;
    var startFrom = ((currentProblem - countBack) >= 0) ? currentProblem - countBack : 0;
    var endOn = ((currentProblem + countForward) <= problems.length - 1) ? (currentProblem + countForward) : (problems.length - 1);
    var problemsPart = problems.slice(startFrom, endOn + 1);
    problemsPart.forEach(function(p) {
      if (p && p[problemKey] && typeof p[problemKey] === 'object') {
        var problem = p[problemKey];
        var problemID = p[problemKey]['pkMLProblemID'] ? p[problemKey]['pkMLProblemID'] : 0;
        _this.initOneProblemSounds(problem, audioServer + _this.getProblemPath(problemID));
      }
    });
  }
};
LabClass.prototype.initOneProblemSounds = function(problem, soundPath) {
  if (!problem || typeof problem !== 'object') {
    return false;
  }
  var problemId = problem.pkMLProblemID ? problem.pkMLProblemID : (problem.id ? problem.id : 0);
  var _this = this;
  soundPath = soundPath.replace(/\/$/, '');
  var files = this.getFileNamesToInit();
  var ttsSoundsFields = files.ttsSoundsFields;
  var fullPathSoundFields = files.fullPathSoundFields;
  var fileNameSoundFields = files.fileNameSoundFields;
  fullPathSoundFields.forEach(function(fieldName) {
    if (problem[fieldName] && typeof problem[fieldName] == 'string' && problem[fieldName].length && problem[fieldName].indexOf('http') > -1) {
      _this.initSound(problem[fieldName], problem[fieldName]);
    }
  });
  fileNameSoundFields.forEach(function(fieldName) {
    if (problem[fieldName] && typeof problem[fieldName] == 'string' && problem[fieldName].length && problem[fieldName].indexOf('http') === -1) {
      if ((problem[fieldName].indexOf('mp3') > -1 || problem[fieldName].indexOf('wav') > -1) && problem[fieldName].indexOf('http') < 0) {
        _this.initSound(problem[fieldName] + '-' + problemId, soundPath + "/" + problem[fieldName]);
      } else {
        _this.initSound(fieldName + '-' + problemId, soundPath + '/' + fieldName + '.mp3');
      }
    }
  });
  ttsSoundsFields.forEach(function(fieldName) {
    if (problem[fieldName] && typeof problem[fieldName] == 'string' && problem[fieldName].length) {
      var textToSpeak = problem[fieldName];
      textToSpeak = _this.autoSoundCleanup(textToSpeak, 'StatementText', problem);
      if (textToSpeak && textToSpeak.length && _this.responsiveVoice.isIOS()) {
        _this.initSound(textToSpeak, textToSpeak);
      }
    }
  });
  if ((problem['hasReadText'] && problem['hasReadText'] == 1) || (problem['ReadText'] && problem['ReadTextFeedback'])) {
    _this.initSound('ProblemReadText' + '-' + problemId, soundPath + "/" + "ProblemReadText.mp3");
    _this.initSound('ProblemReadTextFeedback' + '-' + problemId, soundPath + "/" + "ProblemReadTextFeedback.mp3");
  }
  if (problem['ProblemType'] == 'MC' && problem['Type'] == 'Quiz' && problem['VoiceFile'] == "") {
    _this.initSound(soundPath + "/" + "ProblemReadText.mp3", soundPath + "/" + "ProblemReadText.mp3");
    _this.initSound(soundPath + "/" + "ProblemReadTextFeedback.mp3", soundPath + "/" + "ProblemReadTextFeedback.mp3");
    for (i = 1; i <= 4; i++) {
      if (problem["ReadTextMC" + i] != null && problem["ReadTextMC" + i].length > 0) {
        _this.initSound(soundPath + "/" + "ReadTextMC" + String(i) + ".mp3", soundPath + "/" + "ReadTextMC" + String(i) + ".mp3");
      }
    }
  }
  if (problem['ProblemChartElement'] && problem['ProblemChartElement'].length) {
    problem['ProblemChartElement'].forEach(function(p, i) {
      if (p['Voice'] && p['Voice'].length) {
        _this.initSound(p['Voice'] + '-' + problemId, soundPath + "/" + p['Voice']);
      }
      if (p['TTS'] && p['TTS'].length && _this.responsiveVoice.isIOS()) {
        _this.initSound(p['TTS'], p['TTS']);
      }
      if (p['XLabel'] && p['XLabel'].length && _this.responsiveVoice.isIOS()) {
        _this.initSound(p['XLabel'], p['XLabel']);
      }
      if (p['YLabel'] && p['YLabel'].length && _this.responsiveVoice.isIOS()) {
        _this.initSound(p['YLabel'], p['YLabel']);
      }
    });
  }
  if (problem['CaptionVoice'] && problem['CaptionVoice'].length) {
    _this.initSound('CaptionVoice.mp3-' + problemId, soundPath + "/" + 'CaptionVoice.mp3');
  }
  if (problem['ProblemPage'] && Array.isArray(problem['ProblemPage'])) {
    problem['ProblemPage'].forEach(function(p, i) {
      if (p['Caption'] && p['Caption'].length && p['CaptionVoice'] && p['CaptionVoice'].length) {
        var toRead = _this.autoSoundCleanup(p['Caption'], 'ProblemPage', problem);
        _this.initSound(toRead, toRead);
      }
      if (p['CaptionVoice'] && p['CaptionVoice'].length) {
        _this.initSound('CaptionVoice' + (i + 1) + '.mp3-' + problemId, soundPath + "/" + 'CaptionVoice' + (i + 1) + '.mp3');
      }
      if (p['StatementVoice'] && p['StatementVoice'].length) {
        _this.initSound(p['StatementVoice'] + '-' + problemId, soundPath + "/" + p['StatementVoice']);
      }
      if (p['StatementTextTTS'] && p['StatementTextTTS'].length) {
        _this.initSound(p['StatementTextTTS'], p['StatementTextTTS']);
      } else if (p['StatementText'] && p['StatementText'].length) {
        _this.initSound(p['StatementText'], p['StatementText']);
      }
    });
  }
  if (problem['ProblemHotAnswer'] && Array.isArray(problem['ProblemHotAnswer'])) {
    problem['ProblemHotAnswer'].forEach(function(e) {
      if (e['Sound']) {
        _this.initSound(e['Sound'] + '-' + problemId, soundPath + "/" + e['Sound']);
      }
    });
  }
  if (problem['ProblemHot'] && Array.isArray(problem['ProblemHot'])) {
    problem['ProblemHot'].forEach(function(e) {
      if (e['Sound']) {
        _this.initSound(e['Sound'] + '-' + problemId, soundPath + "/" + e['Sound']);
      }
      if (e['HotspotTTS'] && e['HotspotTTS'] && _this.responsiveVoice.isIOS()) {
        var toRead = _this.autoSoundCleanup(e['HotspotTTS'], 'ProblemHot', problem);
        _this.initSound(toRead, toRead);
      }
    });
  }
  if (problem['IntroFakeText']) {
    _this.initSound(problem['IntroFakeText'], problem['IntroFakeText']);
  }
};
LabClass.prototype.uninitOneProblemSounds = function(problem, soundPath) {
  if (!problem || typeof problem !== 'object') {
    return false;
  }
  var problemId = problem.pkMLProblemID ? problem.pkMLProblemID : (problem.id ? problem.id : 0);
  var _this = this;
  soundPath = soundPath.replace(/\/$/, '');
  var files = this.getFileNamesToInit();
  var ttsSoundsFields = files.ttsSoundsFields;
  var fullPathSoundFields = files.fullPathSoundFields;
  var fileNameSoundFields = files.fileNameSoundFields;
  fullPathSoundFields.forEach(function(fieldName) {
    if (problem[fieldName] && typeof problem[fieldName] == 'string' && problem[fieldName].length && problem[fieldName].indexOf('http') > -1) {
      _this.uninitOneSound(problem[fieldName]);
    }
  });
  fileNameSoundFields.forEach(function(fieldName) {
    if (problem[fieldName] && typeof problem[fieldName] == 'string' && problem[fieldName].length && problem[fieldName].indexOf('http') === -1) {
      if ((problem[fieldName].indexOf('mp3') > -1 || problem[fieldName].indexOf('wav') > -1) && problem[fieldName].indexOf('http') < 0) {
        _this.uninitOneSound(problem[fieldName] + '-' + problemId);
      }
    }
  });
  ttsSoundsFields.forEach(function(fieldName) {
    if (problem[fieldName] && typeof problem[fieldName] == 'string' && problem[fieldName].length) {
      var textToSpeak = problem[fieldName];
      textToSpeak = _this.autoSoundCleanup(textToSpeak, 'StatementText', problem);
      if (textToSpeak && textToSpeak.length && _this.responsiveVoice.isIOS()) {
        _this.uninitOneSound(textToSpeak);
      }
    }
  });
  if ((problem['hasReadText'] && problem['hasReadText'] == 1) || (problem['ReadText'] && problem['ReadTextFeedback'])) {
    _this.uninitOneSound('ProblemReadText' + '-' + problemId);
    _this.uninitOneSound('ProblemReadTextFeedback' + '-' + problemId);
  }
  if (problem['ProblemType'] == 'MC' && problem['Type'] == 'Quiz' && problem['VoiceFile'] == "") {
    _this.uninitOneSound(soundPath + "/" + "ProblemReadText.mp3");
    _this.uninitOneSound(soundPath + "/" + "ProblemReadText.mp3");
    _this.uninitOneSound(soundPath + "/" + "ProblemReadTextFeedback.mp3");
    for (i = 1; i <= 6; i++) {
      _this.uninitOneSound(soundPath + "/" + "ReadTextMC" + String(i) + ".mp3");
    }
  }
  if (problem['CaptionVoice'] && problem['CaptionVoice'].length) {
    _this.uninitOneSound('CaptionVoice.mp3-' + problemId);
  }
  if (problem['BlankField'] && problem['BlankField'].length) {
    _this.uninitOneSound('BlankFieldVoice.mp3-' + problemId);
  }
  if (problem['ProblemPage'] && Array.isArray(problem['ProblemPage'])) {
    problem['ProblemPage'].forEach(function(p, i) {
      if (p['Caption'] && p['Caption'].length && p['CaptionVoice'] && p['CaptionVoice'].length) {
        var toRead = _this.autoSoundCleanup(p['Caption'], 'ProblemPage', problem);
        _this.uninitOneSound(toRead);
      }
      if (p['CaptionVoice'] && p['CaptionVoice'].length) {
        _this.uninitOneSound('CaptionVoice' + (i + 1) + '.mp3-' + problemId);
      }
      if (p['StatementVoice'] && p['StatementVoice'].length) {
        _this.uninitOneSound(p['StatementVoice'] + '-' + problemId);
      }
    });
  }
  if (problem['ProblemHotAnswer'] && Array.isArray(problem['ProblemHotAnswer'])) {
    problem['ProblemHotAnswer'].forEach(function(e) {
      if (e['Sound']) {
        _this.uninitOneSound(e['Sound'] + '-' + problemId);
      }
    });
  }
  if (problem['ProblemHot'] && Array.isArray(problem['ProblemHot'])) {
    problem['ProblemHot'].forEach(function(e) {
      if (e['Sound']) {
        _this.uninitOneSound(e['Sound'] + '-' + problemId);
      }
      if (e['HotspotTTS'] && e['HotspotTTS']) {
        var toRead = _this.autoSoundCleanup(e['HotspotTTS'], 'ProblemHot', problem);
        _this.uninitOneSound(toRead);
      }
    });
  }
};
LabClass.prototype.getFileNamesToInit = function() {
  var ttsSoundsFields = ['StatementText', 'ReadTextTTS', 'MC{i}TTS', 'HeaderTTS', 'ProblemSoundTTS', 'ReadText', 'ReadTextFeedback', 'ReadTextTTS', 'FeedbackTTS', 'ChoiceText{i}', 'ReadTextMC{i}', 'ReadTextMCF', 'BlankField', 'Caption', 'IntroFakeText', 'TitleTTS', 'Feedback', 'FeedbackText', ];
  var fullPathSoundFields = ['VoiceFile', 'StatementVoice', 'FeedbackVoice', 'placementAudioFile', 'sessionAudioFile'];
  var fileNameSoundFields = ['FeedbackVoice', 'StatementVoice', 'DAAMCStatementVoice', 'VoiceAndMusicFile', 'DAAMCCaptionVoice', 'FeedbackCaptionVoice', 'ProblemSound', 'VoiceMC{i}', 'ReadTextMC{i}', 'ReadTextMCF', 'VoiceAndMusicFile', 'ProblemReadTextFeedback', 'ProblemReadText', 'MCVoice{i}', 'BlankFieldVoice', 'HeaderVoice', 'TitleVoice', ];
  ttsSoundsFields.forEach(function(fieldName, key) {
    if (fieldName.indexOf('{i}') > -1) {
      delete ttsSoundsFields[key];
      for (i = 1; i < 9; i++) {
        ttsSoundsFields.push(fieldName.replace('{i}', String(i)));
      }
    }
  });
  fileNameSoundFields.forEach(function(fieldName, key) {
    if (fieldName.indexOf('{i}') > -1) {
      delete fileNameSoundFields[key];
      for (i = 1; i < 9; i++) {
        fileNameSoundFields.push(fieldName.replace('{i}', String(i)));
      }
    }
  });
  return {
    'ttsSoundsFields': ttsSoundsFields,
    'fullPathSoundFields': fullPathSoundFields,
    'fileNameSoundFields': fileNameSoundFields
  };
};
LabClass.prototype.isURLValid = function(url) {
  try {
    decodeURI(url);
    return true;
  } catch (ex) {
    return false;
  }
}
LabClass.prototype.uninitSound = function(id) {
  for (var iSound in this.initedSounds) {
    if (this.initedSounds.hasOwnProperty(iSound)) {
      var toFind = '-' + id;
      if (iSound.lastIndexOf(toFind) === iSound.length - toFind.length) {
        this.uninitOneSound(iSound);
      }
    }
  }
};
LabClass.prototype.uninitOneSound = function(id) {
  if (this.initedSounds && this.initedSounds[id] && typeof this.initedSounds[id] === 'object') {
    this.initedSounds[id].stop();
    this.initedSounds[id].unload();
    delete this.initedSounds[id];
  }
};
LabClass.prototype.initSound = function(id, url, callback) {
  if (!id || typeof id === 'undefined' || id === '') {
    return;
  }
  if (!url || typeof url === 'undefined' || url === '') {
    return;
  }
  var isResponsiveVoice = false;
  id = String(id);
  url = String(url);
  if (this.soundManagerLoaded.state() !== 'resolved') {
    this.soundManagerLoaded.done(function() {
      this.initSound(id, url, callback);
    }.bind(this));
    return;
  }
  if (url && !(/(https?):\/\/(www.)?(.*?)\.(mp3)/gm.test(url))) {
    id = this.autoSoundCleanup(id);
    url = this.responsiveVoice.getSpeakSoundUrl(this.rvPrepareText(id));
    isResponsiveVoice = true;
  } else {
    if (id.indexOf('?') > -1 && id.indexOf('getvoice') === -1) {
      id = id.substring(0, id.indexOf('?'));
    } else {
      id = parseString(id);
    }
    if (url.indexOf('?') > -1 && url.indexOf('getvoice') === -1) {
      url = url.substring(0, url.indexOf('?'));
    } else {
      url = parseString(url);
    }
    if (id.indexOf('getvoice') > -1 || url.indexOf('getvoice') > -1) {
      isResponsiveVoice = true;
    }
  }
  if (this && this.initedSoundsReady && !this.initedSoundsReady[id]) {
    this.initedSoundsReady[id] = false;
  }
  if (!id || typeof id === 'undefined' || id === '') {
    return;
  }
  if (!url || typeof url === 'undefined' || url === '') {
    return;
  }
  var cleanUrl = url.substring(0, url.indexOf('?'));
  if ((this.initedSounds[id] && isResponsiveVoice) || (this.initedSounds[id] && typeof this.initedSounds[id] !== 'undefined' && this.initedSounds[id].url && (this.initedSounds[id].url == url || this.initedSounds[id].url == cleanUrl))) {
    return false;
  }
  if (!this.isURLValid(url)) {
    return;
  }
  if (this.initedSounds[id]) {
    this.initedSounds[id] = null;
  }
  var _this = this;
  soundManager.pauseAll();
  this.doNewSoundInstance.call(this, {
    autoLoad: true,
    id: id,
    url: url,
    whileloading: function() {},
    whileplaying: function() {
      if (this.duration && this.position && this.position >= this.duration - 50) {
        _this.speakerAnimate(false);
        _this.setInitedSoundPlayStatus(false, null);
      } else {
        _this.speakerAnimate(true);
      }
      if (_this.initedSoundInitCallbackTimers[id]) {
        clearTimeout(_this.initedSoundInitCallbackTimers[id]);
      }
      _this.initedSoundInitCallbackTimers[id] = setTimeout(function() {
        _this.speakerAnimate(false);
        _this.setInitedSoundPlayStatus(false, null);
        if (callback !== undefined && typeof callback == 'function') {
          callback(id, function() {});
        }
        clearTimeout(_this.initedSoundInitCallbackTimers[id]);
      }, 1700);
    },
    onload: function(success) {
      if (this && this.initedSoundsReady) {
        this.initedSoundsReady[id] = true;
      }
      if (typeof success === 'undefined' || !success) {
        _this.onLoadSoundFailed(id, url, this);
      }
    },
    onfinish: function() {
      _this.speakerAnimate(false);
      _this.onEndSoundEventWrapper();
      this.play();
      this.pause();
      _this.resetSoundTriggerEvent();
    },
    onpause: function() {
      _this.speakerAnimate(false);
      _this.setInitedSoundPlayStatus(false, null);
    },
    onstop: function() {
      _this.speakerAnimate(false);
      if (_this.initedSoundInitCallbackTimers[id]) {
        clearTimeout(_this.initedSoundInitCallbackTimers[id]);
      }
      _this.setInitedSoundPlayStatus(false, null);
    },
    onerror: function(code, description) {
      if (this.loaded) {
        this.stop();
      } else {
        if (_this.initedSounds[id] && typeof _this.initedSounds[id] !== 'undefined') {
          delete _this.initedSounds[id];
        }
        if (_this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)] && typeof _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)] !== 'undefined') {
          delete _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)];
        }
      }
      _this.resetSoundTriggerEvent();
    }
  }, function(mySound) {
    _this.initedSounds[id] = mySound;
  });
  return true;
};
LabClass.prototype.initSoundPromise = function(id, url, callback) {
  if (!id || typeof id === 'undefined' || id === '') {
    return;
  }
  if (!url || typeof url === 'undefined' || url === '') {
    return;
  }
  var _this = this;
  if (!id || id === '') {
    var result = $.Deferred();
    setTimeout(function() {
      result.reject();
    }, 1000);
    return result;
  }
  if (this.soundManagerLoaded.state() !== 'resolved') {
    this.soundManagerLoaded.done(function() {
      this.initSound(id, url, callback);
    }.bind(this));
    return;
  }
  if (!this.initedSoundPromises || typeof this.initedSoundPromises === 'undefined') {
    this.initedSoundPromises = {};
  }
  if (!this.initedSoundPromises[id]) {
    this.initedSoundPromises[id] = $.Deferred();
  }
  var isResponsiveVoice = false;
  id = String(id);
  url = String(url);
  if (url && url.indexOf('http') === -1 && url.indexOf('https') === -1) {
    id = this.autoSoundCleanup(id);
    url = this.responsiveVoice.getSpeakSoundUrl(this.rvPrepareText(id));
    isResponsiveVoice = true;
  } else {
    if (id.indexOf('?') > -1 && id.indexOf('getvoice') === -1) {
      id = id.substring(0, id.indexOf('?'));
    }
    if (url.indexOf('?') > -1 && url.indexOf('getvoice') === -1) {
      url = url.substring(0, url.indexOf('?'));
    }
    if (id.indexOf('getvoice') > -1 || url.indexOf('getvoice') > -1) {
      isResponsiveVoice = true;
    }
  }
  if (!id || typeof id === 'undefined' || id === '') {
    return;
  }
  if (!url || typeof url === 'undefined' || url === '') {
    return;
  }
  var cleanUrl = url.substring(0, url.indexOf('?'));
  if (!this.isURLValid(url)) {
    return;
  }
  if ((this.initedSounds[id] && isResponsiveVoice) || (this.initedSounds[id] && typeof this.initedSounds[id] !== 'undefined' && this.initedSounds[id].url && (this.initedSounds[id].url == url || this.initedSounds[id].url == cleanUrl))) {
    if (!_this.initedSoundPromiseTimer[id]) {
      _this.initedSoundPromiseLoadedTimer[id] = setTimeout(function() {
        if (_this.initedSoundPromises && _this.initedSoundPromises[id]) {
          _this.initedSoundPromises[id].resolve(_this.initedSounds[id]);
        }
        clearTimeout(_this.initedSoundPromiseTimer[id]);
        delete _this.initedSoundPromiseTimer[id];
      }, 1500);
    }
    return _this.initedSoundPromises[id];
  }
  if (this.initedSounds[id]) {
    this.initedSounds[id] = null;
  }
  soundManager.pauseAll();
  this.doNewSoundInstance.call(this, {
    autoLoad: true,
    id: id,
    url: url,
    whileloading: function() {
      if (_this.initedSoundPromiseTimer[id]) {
        clearTimeout(_this.initedSoundPromiseTimer[id]);
      }
      _this.initedSoundPromiseTimer[id] = setTimeout(function() {
        if (_this.initedSoundPromises && _this.initedSoundPromises[id]) {
          _this.initedSoundPromises[id].resolve(this);
        }
        clearTimeout(_this.initedSoundPromiseTimer[id]);
        delete _this.initedSoundPromiseTimer[id];
      }, 1500);
    },
    whileplaying: function() {
      if (this.duration && this.position && this.position >= this.duration - 50) {
        _this.speakerAnimate(false);
        _this.setInitedSoundPlayStatus(false, null);
      } else {
        _this.setInitedSoundPlayStatus(true, id);
        _this.speakerAnimate(true);
      }
      if (_this.initedSoundInitCallbackTimers[id]) {
        clearTimeout(_this.initedSoundInitCallbackTimers[id]);
      }
      _this.initedSoundInitCallbackTimers[id] = setTimeout(function() {
        _this.speakerAnimate(false);
        _this.setInitedSoundPlayStatus(false, null);
        if (callback !== undefined && typeof callback == 'function') {
          callback(id, function() {});
        }
        clearTimeout(_this.initedSoundInitCallbackTimers[id]);
      }, 1700);
    },
    onload: function(success) {
      if (typeof success === 'undefined' || !success) {
        _this.onLoadSoundFailed(id, url, this);
      }
      if (_this.initedSoundPromiseTimer[id]) {
        clearTimeout(_this.initedSoundPromiseTimer[id]);
      }
      _this.initedSoundPromiseTimer[id] = setTimeout(function() {
        _this.initedSoundPromises[id].resolve(this);
      }, 1500);
    },
    onfinish: function() {
      _this.speakerAnimate(false);
      if (_this.initedSoundPromises[id].state() !== 'resolved') {
        _this.initedSoundPromises[id].resolve(this);
      }
      if (this.play) {
        this.play();
      }
      if (this.pause) {
        this.pause();
      }
      _this.resetSoundTriggerEvent();
    },
    onpause: function() {
      if (_this.initedSoundPromises[id].state() !== 'resolved') {
        _this.initedSoundPromises[id].resolve(this);
      }
      _this.speakerAnimate(false);
      _this.setInitedSoundPlayStatus(false, null);
    },
    onstop: function() {
      if (_this.initedSoundPromises[id].state() !== 'resolved') {
        _this.initedSoundPromises[id].resolve(this);
      }
      _this.setInitedSoundPlayStatus(false, null);
      _this.speakerAnimate(false);
    }
  }, function(mySound) {
    _this.initedSounds[id] = mySound;
  });
  setTimeout(function() {
    if (_this.initedSoundPromises[id].state() !== 'resolved') {
      _this.initedSoundPromises[id].resolve(_this.initedSounds[id]);
    }
  }, 5000);
  return this.initedSoundPromises[id];
};
LabClass.prototype.allSoundsInitedPromise = function() {
  var allInited = $.Deferred();
  var allInitedTimeout = null;
  var promises = [];
  var _this = this;
  Object.keys(this.initedSoundPromises).forEach(function(pKey) {
    if (_this.initedSoundPromises && _this.initedSoundPromises[pKey] && typeof _this.initedSoundPromises[pKey] === 'object') {
      promises.push(_this.initedSoundPromises[pKey].promise());
    }
  });
  $.when.apply($, promises).done(function() {
    if (allInitedTimeout) {
      clearTimeout(allInitedTimeout);
    }
    allInited.resolve(true);
  });
  allInitedTimeout = setTimeout(function() {
    allInited.resolve(true);
  }, 5000);
  return allInited;
};
LabClass.prototype.speakerAnimate = function(status) {
  var soundIcons = $('.pbl-large-sound-icon, .lab-spell-speaker');
  var alSoundIcon = $('.lab-screen-speaker-static');
  var isFeedbackVisible = $('.problem-feedback:visible').size() > 0;
  if (status) {
    if (!isFeedbackVisible) {
      soundIcons.addClass('playing');
    }
    alSoundIcon.addClass('lab-screen-speaker-animate');
  } else {
    $('.lab-problem .playing').removeClass('playing');
    soundIcons.removeClass('playing');
    alSoundIcon.removeClass('lab-screen-speaker-animate');
  }
};
LabClass.prototype.rvPrepareText = function(id) {
  var tmpElement = $('<div />');
  var cleanedText = tmpElement.html(id).text().replace(/\%/g, '%25');
  var detectTags = /(\[([^\]]+)\])/ig;
  tmpElement.remove();
  return cleanedText;
};
LabClass.prototype.initedSoundClean = function() {
  soundManager.pauseAll();
  this.initedSounds = {};
  this.setInitedSoundPlayStatus(false, null);
  return true;
};
LabClass.prototype.playInitedSound = function(id, force, callback, onStart, ignoreOngoing, ignoreCurrentPlayStatus) {
  'use strict';
  var _this = this;
  if (!id || typeof id === 'undefined' || id === '') {
    return;
  }
  var isResponsiveVoice = false;
  id = String(id);
  if (id && id.indexOf('.mp3') === -1 && id.indexOf('http') === -1 && id.indexOf('https') === -1) {
    id = this.autoSoundCleanup(id);
    isResponsiveVoice = true;
  } else {
    if (id.indexOf('?') > -1 && id.indexOf('getvoice') === -1) {
      id = id.substring(0, id.indexOf('?'));
    }
  }
  if (!id || typeof id === 'undefined' || id === '') {
    return;
  }
  if (id.indexOf('?') > -1 && (!this.initedSounds[id] || typeof this.initedSounds[id] === 'undefined') && id.indexOf('getvoice') === -1) {
    id = id.substring(0, id.indexOf('?'));
  }
  if (isResponsiveVoice && this.initedSounds[id] && this.initedSounds[id].url.indexOf('getvoice') === -1) {
    isResponsiveVoice = false;
  }
  if (this.soundManagerLoaded.state() !== 'resolved') {
    if (this.initedSoundPlayingRetryTimer[id]) {
      clearTimeout(this.initedSoundPlayingRetryTimer[id]);
    }
    this.initedSoundPlayingRetryTimer[id] = setTimeout(function() {
      _this.playInitedSound(id, force, callback, onStart, ignoreOngoing);
    }, 1000);
  }
  if (this.initedSoundPlaying && (typeof ignoreOngoing === 'undefined' || !ignoreOngoing)) {
    if (typeof force !== 'undefined' && force) {
      _this.initedSounds[this.initedSoundCurrently].pause();
      _this.stopSounds();
      _this.setInitedSoundPlayStatus(false, null);
      _this.playInitedSound(id, force, callback, onStart, ignoreOngoing);
      return false;
    }
    if (this.initedSoundPlayingRetryTimer[id]) {
      clearTimeout(this.initedSoundPlayingRetryTimer[id]);
    }
    if (!this.initedSoundPlayingRetryCount[id]) {
      this.initedSoundPlayingRetryCount[id] = 0;
    }
    this.initedSoundPlayingRetryCount[id]++;
    this.initedSoundPlayingRetryTimer[id] = setTimeout(function() {
      _this.playInitedSound(id, _this.initedSoundPlayingRetryCount[id] >= 15 ? true : force, callback);
    }, 1500);
    if (this.initedSoundPlayingRetryCount[id] > 15) {
      this.initedSoundPlayingRetryCount[id] = 0;
    }
    if (typeof ignoreCurrentPlayStatus === 'undefined' || ignoreCurrentPlayStatus === false) {
      return false;
    }
  }
  if (this.initedSoundPlayingRetryTimer[id]) {
    clearTimeout(this.initedSoundPlayingRetryTimer[id]);
  }
  var cleanedId = id.trim();
  if (this.initedSounds[cleanedId] && typeof this.initedSounds[cleanedId] === 'object') {
    id = cleanedId;
  }
  if ((!this.initedSounds[id] || typeof this.initedSounds[id] === 'undefined') && (typeof ignoreCurrentPlayStatus === 'undefined' || ignoreCurrentPlayStatus === false)) {
    return false;
  }
  if (this.stoppedPlaying) {
    this.stoppedPlaying = false;
    return false;
  }
  if (!this.initedSounds[id].url && id.startsWith('http')) {
    this.initedSounds[id].url = id;
  }
  var duration = this.initedSounds[id].duration === undefined ? 1000 : this.initedSounds[id].duration;
  var playSound = false;
  if (isResponsiveVoice && this.responsiveVoice.defaultType == 'polly') {
    var promises = [];
    if (typeof _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)] === 'undefined' || (typeof _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)] !== 'undefined' && _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)].length == 0)) {
      var speechMarkUrl = _this.responsiveVoice.getSpeechMarkUrl(id);
      if (speechMarkUrl.length > 0) {
        promises.push($.getJSON(speechMarkUrl, function(response) {
          _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)] = response;
        }).promise());
      }
    }
    if (promises.length == 0 && typeof _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)] != 'undefined') {
      playSound = true;
    } else {
      $.when.apply($, promises).then(function() {
        _this.playInitedSound(id, force, callback, onStart, ignoreOngoing);
      }, function(response) {
        if (response.status != 200) {
          _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)] = [];
        }
        _this.playInitedSound(id, force, callback, onStart, ignoreOngoing);
      });
    }
  } else {
    playSound = true;
  }
  if (playSound) {
    var highlightPromises = [];
    var identifier = null;
    if (_this.responsiveVoice.defaultType == 'polly' && typeof _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)] != 'undefined' && _this.initedSounds[id].url.includes('/tts/') && _this.responsiveVoice.getSpeechHighlight()) {
      var isEventNull = (typeof _this.autoSoundPlayTTSEvent !== "undefined" && (typeof _this.autoSoundPlayTTSEvent !== "object" || !_this.autoSoundPlayTTSEvent));
      var defaultElement = _this.interactiveVoice.determineElement(_this.autoSoundPlayTTSEvent, isEventNull);
      if (defaultElement.length > 0) {
        identifier = Math.random();
        _this.autoSoundPlayTTSEvent = null;
        _this.interactiveVoice.add(id, defaultElement, _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)], identifier);
        _this.interactiveVoice.preload(identifier);
        highlightPromises.push(_this.interactiveVoice.isLoaded);
        _this.previousSpeechmarkInstance = identifier;
      }
    }
    $.when.apply($, highlightPromises).then(function() {
      _this.setInitedSoundPlayStatus(true, id);
      _this.initedSounds[id].setPosition(0);
      _this.initedSounds[id].play({
        autoLoad: true,
        autoPlay: false,
        from: 0,
        onplay: function() {
          _this.speakerAnimate(true);
          if (_this.responsiveVoice.defaultType == 'polly' && typeof _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(id)] != 'undefined' && _this.initedSounds[id].url.includes('/tts/')) {
            this.onPosition(0, function() {
              if (_this.responsiveVoice.getSpeechHighlight()) {
                var isEventNull = (typeof _this.autoSoundPlayTTSEvent !== "undefined" && (typeof _this.autoSoundPlayTTSEvent !== "object" || !_this.autoSoundPlayTTSEvent));
                var defaultElement = _this.interactiveVoice.determineElement(_this.autoSoundPlayTTSEvent, isEventNull);
                if (defaultElement.length > 0 && identifier !== null) {
                  _this.interactiveVoice.play(identifier);
                }
              }
            });
          } else {
            if (onStart !== undefined && typeof onStart == 'function') {
              this.onPosition(0, onStart);
            }
          }
        },
        whileplaying: function() {
          _this.setInitedSoundPlayStatus(true, id);
          _this.speakerAnimate(true);
          if (_this.initedSoundPlayCallbackTimers[id]) {
            clearTimeout(_this.initedSoundPlayCallbackTimers[id]);
          }
          _this.initedSoundPlayCallbackTimers[id] = setTimeout(function() {
            _this.speakerAnimate(false);
            _this.playAnimatedLargeIcon = false;
            _this.setInitedSoundPlayStatus(false, null);
            _this.onEndSoundEventWrapper();
            if (callback !== undefined && typeof callback == 'function') {
              callback(id, function() {});
            }
            if (['ipad', 'iphone', 'crios'].indexOf(navigator.userAgent.toLowerCase()) > -1) {
              _this.onEndSoundEventWrapper();
              _this.resetSoundTriggerEvent();
            }
            clearTimeout(_this.initedSoundPlayCallbackTimers[id]);
          }, 1600);
        },
        onstop: function() {
          _this.speakerAnimate(false);
          _this.setInitedSoundPlayStatus(false, null);
          if (['ipad', 'iphone', 'crios'].indexOf(navigator.userAgent.toLowerCase()) == -1) {
            _this.resetSoundTriggerEvent();
          }
        },
        onfinish: function() {
          _this.speakerAnimate(false);
          _this.playAnimatedLargeIcon = false;
          _this.setInitedSoundPlayStatus(false, null);
          _this.onEndSoundEventWrapper();
          if (['ipad', 'iphone', 'crios'].indexOf(navigator.userAgent.toLowerCase()) == -1) {
            _this.resetSoundTriggerEvent();
          }
        }
      });
      _this.initedSoundSecureTimer = setTimeout(function() {
        _this.setInitedSoundPlayStatus(false, null);
      }, 20000);
    });
  }
  return duration ? duration : 1;
};
LabClass.prototype.playInitedSoundPromise = function(id, fallbackTime, callback) {
  this.stopSounds();
  var _this = this;
  this.initedSoundPlayPromises[id] = $.Deferred();
  var resolveAfter = function(timeToWait) {
    this.initedSoundPlayPromisesTimers[id] = setTimeout(function() {
      this.initedSoundPlayPromises[id].resolve();
      if (typeof callback !== 'undefined') {
        callback();
      }
    }.bind(this), timeToWait);
  }.bind(this);
  if (id) {
    this.playInitedSound(id, true, function() {
      if (_this.initedSoundPlayPromises[id]) {
        _this.initedSoundPlayPromises[id].resolve();
        if (typeof callback !== 'undefined') {
          callback();
        }
      }
    });
  } else {
    resolveAfter(fallbackTime);
  }
  return this.initedSoundPlayPromises[id];
};
LabClass.prototype.pauseInitedSound = function(id) {
  this.cancelAllInitedCallbackTimers();
  this.setInitedSoundPlayStatus(false, null);
  if (this.responsiveVoice.defaultType == 'polly') {
    if (this.previousSpeechmarkInstance) {
      this.interactiveVoice.disable(this.previousSpeechmarkInstance);
      this.interactiveVoice.cleanUpNodes(this.previousSpeechmarkInstance);
    }
  }
  if (typeof id === 'undefined' || !id || typeof id !== 'string') {
    soundManager.pauseAll();
  } else {
    id = String(id);
    if (id.indexOf('?') > -1 && id.indexOf('getvoice') === -1) {
      id = id.substring(0, id.indexOf('?'));
    }
    for (var sId in this.initedSounds) {
      if (sId && sId.indexOf(id) > -1) {
        if (this.initedSounds[sId] && this.initedSounds[sId].pause) {
          this.initedSounds[sId].pause();
        }
      }
    }
  }
};
LabClass.prototype.setInitedSoundVolume = function(id, volume) {
  if (typeof id === 'undefined' || !id || typeof id !== 'string') {
    return;
  }
  id = String(id);
  if (id.indexOf('?') > -1 && id.indexOf('getvoice') === -1) {
    id = id.substring(0, id.indexOf('?'));
  }
  if (!this.isInitedSound(id)) {
    return;
  }
  this.initedSounds[id].setVolume(parseInt(volume, 10));
};
LabClass.prototype.setInitedSoundPlayStatus = function(isPlaying, id) {
  'use strict';
  this.initedSoundPlaying = isPlaying;
  this.initedSoundCurrently = id;
  if (isPlaying === false && this.initedSoundSecureTimer) {
    clearTimeout(this.initedSoundSecureTimer);
  }
  if (typeof id !== 'undefined' && id !== null) {
    this.initedSoundLast = id;
  }
};
LabClass.prototype.isInitedSound = function(id) {
  if (typeof id === 'undefined' || !id || typeof id !== 'string') {
    return false;
  }
  id = String(id);
  var idCleaned = "" + id + "";
  if (id.indexOf('?') > -1) {
    idCleaned = id.substring(0, id.indexOf('?'));
  }
  var trimmedId = id.trim();
  var cleanedupId = this.autoSoundCleanup(id);
  idCleaned = idCleaned.trim();
  var isIdDefined = (this.initedSounds && this.initedSounds[id] && typeof this.initedSounds[id] === 'object');
  var isIdCleanedDefined = (this.initedSounds && this.initedSounds[idCleaned] && typeof this.initedSounds[idCleaned] === 'object');
  var isTrimmedId = (this.initedSounds && this.initedSounds[trimmedId] && typeof this.initedSounds[trimmedId] === 'object');
  var isCleanedupId = (this.initedSounds && this.initedSounds[cleanedupId] && typeof this.initedSounds[cleanedupId] === 'object');
  return isIdDefined || isIdCleanedDefined || isTrimmedId || isCleanedupId;
};
LabClass.prototype.isInitedSoundPlaying = function(id) {
  if (typeof id === 'undefined' && this.initedSoundPlaying) {
    return true;
  }
  if (this.initedSoundCurrently === id) {
    return true;
  }
  if (this.initedSounds && this.initedSounds[id] && this.initedSounds[id].playState == 1) {
    return true;
  }
  return false;
};
LabClass.prototype.findInitedIdByUrl = function(url) {
  var _this = this;
  for (var soundId in this.initedSounds) {
    var oneSound = _this.initedSounds[soundId];
    if (oneSound && typeof oneSound === 'object' && oneSound.url && oneSound.url.length) {
      if (oneSound.url == url) {
        return soundId;
      }
    }
  }
  return false;
};
LabClass.prototype.cancelAllInitedCallbackTimers = function() {
  var _this = this;
  for (var soundId in _this.initedSoundPlayCallbackTimers) {
    if (_this.initedSoundPlayCallbackTimers[soundId]) {
      clearTimeout(_this.initedSoundPlayCallbackTimers[soundId]);
    }
  }
  _this.initedSoundPlayCallbackTimers = {};
};
LabClass.prototype.autoSoundClickAction = function(sndTarget, e, problem) {
  if (!this.isAutosoundTriggered) {
    this.soundTriggerEvent = e;
  }
  var problemId = (problem && typeof problem === 'object') ? (problem.pkMLProblemID ? problem.pkMLProblemID : (this.CurrentProblem.id ? this.CurrentProblem.id : 0)) : (this.CurrentProblem.id ? this.CurrentProblem.id : 0);
  var snd = sndTarget.attr('data-sound');
  var sndPriority = snd ? snd.replace(/http:/gm, 'http/').replace(/https:/gm, 'https/').split('|') : [];
  if (sndPriority.length) {
    $('.lab-problem .playing').removeClass('playing');
  }
  this.pauseInitedSound();
  this.stopSounds();
  for (var i = 0; i < sndPriority.length; i++) {
    var sndTypeAndVal = sndPriority[i].split(':');
    if (sndTypeAndVal.length > 1) {
      var sndType = parseInt(sndTypeAndVal[0]);
      var sndVal = sndTypeAndVal.splice(1).join().replace(/http\//gm, 'http:').replace(/https\//gm, 'https:');
      if ((sndType & 15) == 0) {
        var sndField = ((sndType >> 4) == 0) ? this.autoSoundParseField(this.CurrentProblem, sndVal) : sndVal;
        if (sndField) {
          sndField = sndField.trim();
          var sndFieldCleaned = this.autoSoundCleanup(sndField, sndVal, this.CurrentProblem);
          if (this.isInitedSound(sndField + '-' + problemId)) {
            this.playInitedSound(sndField + '-' + problemId, true);
          } else if (sndFieldCleaned) {
            var findSoundId = this.findInitedIdByUrl(sndFieldCleaned);
            if (this.isInitedSound(sndFieldCleaned + '-' + problemId)) {
              this.playInitedSound(sndFieldCleaned + '-' + problemId, true);
            } else if (this.isInitedSound(findSoundId)) {
              this.playInitedSound(findSoundId, true);
            } else if (this.isInitedSound(sndFieldCleaned)) {
              this.playInitedSound(sndFieldCleaned, true);
            } else {
              this.autoSoundPlayMP3(sndField, e);
            }
          } else {
            this.autoSoundPlayMP3(sndField, e);
          }
          return;
        }
      } else {
        var sndField = ((sndType >> 4) == 0) ? this.autoSoundParseField(this.CurrentProblem, sndVal) : sndVal;
        if (sndField) {
          this.autoSoundPlayTTS(this.autoSoundCleanup(sndField, sndVal, this.CurrentProblem), e);
          return;
        }
      }
    }
  }
};
LabClass.prototype.autoSoundClick = function(e, problem) {
  var sndTarget = (typeof $(e.target).attr('data-sound') == 'undefined') ? $(e.target.parentElement) : $(e.target);
  this.autoSoundClickAction(sndTarget, e, problem);
};
LabClass.prototype.autoSoundTrigger = function(element, e, problem) {
  this.isAutosoundTriggered = true;
  this.autoSoundClickAction(element, e, problem);
};
LabClass.prototype.autoSoundClickElement = function(element, e, problem) {
  this.autoSoundClickAction($(element), e, problem);
};
LabClass.prototype.autoSoundPlayMultiple = function(autoSoundList) {
  this.autoSoundList = autoSoundList;
  if (Array.isArray(autoSoundList)) {
    this.preInitSounds(autoSoundList);
  } else {
    this.preInitSounds([autoSoundList]);
  }
  this.autoSoundPlayMultipleNext();
};
LabClass.prototype.autoSoundPlayMultipleNext = function() {
  var tmp;
  if (this.autoSoundList.length > 0) {
    if (Array.isArray(this.autoSoundList)) {
      tmp = this.autoSoundList.shift();
    } else {
      tmp = this.autoSoundList;
      this.autoSoundList = [];
    }
    this.autoSoundTrigger(tmp, {
      target: tmp
    }, this.CurrentProblem);
  }
};
LabClass.prototype.autoSoundPlayTTS = function(s) {
  if (typeof this.soundSetting !== 'undefined' && this.soundSetting == 0) return;
  if (s == 'notts') return;
  var _this = this;
  var e = (arguments.length > 1) ? arguments[1] : null;
  var isEventNull = (typeof e !== "undefined" && (typeof e !== "object" || !e));
  var onStartSoundEvent = this.noOp;
  var onEndSoundEvent = this.noOp;
  if (e) {
    _this.autoSoundPlayTTSEvent = e;
    onStartSoundEvent = function() {
      _this.speakerAnimate(true);
      _this.onStartSoundEvent.call(this, e);
    };
    onEndSoundEvent = function(code, description) {
      _this.speakerAnimate(false);
      _this.onEndSoundEvent.call(this, e);
      _this.autoSoundPlayMultipleNext();
      _this.hasAnySoundPlayed = true;
      _this.resetSoundTriggerEvent();
    };
  }
  var tmpElement = $('<div />');
  var cleanedText = tmpElement.html(s).text();
  tmpElement.remove();
  if (this.responsiveVoice.isIOS() && this.isInitedSound(cleanedText)) {
    this.playInitedSound(cleanedText, true);
    return;
  } else {
    this.autoSoundPlayTTSEvent = null;
  }
  this.responsiveVoice.responsiveVoiceReady.promise().then(function() {
    _this.stopSounds();
    var parameters = {
      'polly': {},
      'fallback': {}
    };
    var currentDefaultType = _this.responsiveVoice.defaultType;
    if (currentDefaultType.length > 3000) {
      _this.responsiveVoice.defaultType = 'fallback';
    }
    if (_this.responsiveVoice.defaultType == 'polly') {
      var defaultTarget;
      var defaultTargetWithoutText = false;
      if (!isEventNull) {
        defaultTarget = e.target;
        var parent = $(e.target).parent();
        if (parent.hasClass('ms-pbl-statement-sound-paragraph') || parent.hasClass('ms-pbl-statement') || (parent[0] && parent[0].tagName === 'P' && parent[0] && parent[0].className === '')) {
          defaultTarget = parent.parent();
        } else if (parent.hasClass('pbl-hotspot-bullet')) {
          var currentDataSound = parseInt(parent.attr('data-status'));
          defaultTarget = parent.parent().find('.pbl-hotspot-bullet-feedback[data-status=' + currentDataSound + ']');
        } else if (parent.hasClass('ms-pbl-mc-standard-column')) {
          defaultTarget = parent.parent();
        }
      } else {
        var targets = $('.lab-problem .problem-statement .ms-pbl-content *:not(.pbl-dragdrop-answers-wrapper)');
        var targetHasText = true;
        $.each(targets, function(index) {
          var currentTarget = targets[index];
          targetHasText = targetHasText && ($(currentTarget).text().length != 0 || $(currentTarget).parent().text().length != 0);
          if (targetHasText) {
            return false;
          }
        });
        defaultTargetWithoutText = !targetHasText;
      }
      var noSpeechMarkValue = defaultTargetWithoutText ? true : false;
      parameters['polly'] = {
        'text': cleanedText,
        'noSpeechMark': (isEventNull ? noSpeechMarkValue : ($(e.target).attr('class').indexOf('pbl-dragdrop-answer') != -1) || ($(defaultTarget).text().length == 0 && $(defaultTarget).parent().text().length == 0)),
        onplay: onStartSoundEvent,
        onfinish: onEndSoundEvent,
        onerror: onEndSoundEvent
      };
      if (isEventNull || (!isEventNull && $(e.target).attr('class').indexOf('pbl-dragdrop-answer') == -1 && ($(defaultTarget).text().length > 0 || $(defaultTarget).parent().text().length > 0))) {
        parameters['polly']['events'] = {
          onload: function(success) {
            if (success && (isEventNull || (!isEventNull && $(e.target).attr('class').indexOf('pbl-dragdrop-answer') == -1))) {
              var promises = [];
              if (parameters['polly']['noSpeechMark'] === false && (typeof _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(cleanedText)] === 'undefined' || (typeof _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(cleanedText)] !== 'undefined' && _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(cleanedText)].length == 0))) {
                var speechMarkUrl = _this.responsiveVoice.getSpeechMarkUrl(cleanedText);
                if (speechMarkUrl.length > 0) {
                  promises.push($.getJSON(speechMarkUrl, function(response) {
                    _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(cleanedText)] = response;
                  }).promise());
                }
              }
              $.when.apply($, promises).then(function(response) {
                if (_this.responsiveVoice.getSpeechHighlight()) {
                  var highlightPromises = [];
                  var identifier = null;
                  var defaultElement = _this.interactiveVoice.determineElement(e, isEventNull);
                  if (defaultElement.length > 0) {
                    identifier = Math.random();
                    _this.interactiveVoice.add(cleanedText, defaultElement, _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(cleanedText)], identifier);
                    _this.interactiveVoice.preload(identifier);
                    highlightPromises.push(_this.interactiveVoice.isLoaded);
                    $.when.apply($, highlightPromises).then(function(response) {
                      _this.interactiveVoice.play(identifier);
                    });
                    _this.previousSpeechmarkInstance = identifier;
                  }
                }
              }, function(response) {
                if (response.status != 200) {
                  _this.initedSoundsSpeechmarks[_this.responsiveVoice.getSpeechMarkID(cleanedText)] = [];
                }
              });
            }
          }
        };
      }
    } else {
      parameters['fallback'] = {
        onstart: onStartSoundEvent,
        onend: onEndSoundEvent,
        onerror: onEndSoundEvent
      };
    }
    _this.responsiveVoice.speak(cleanedText, parameters);
    _this.responsiveVoice.defaultType = currentDefaultType;
  });
};
LabClass.prototype.autoSoundPlayMP3 = function(s) {
  if (this.soundManagerLoaded.state() !== 'resolved') {
    this.soundManagerLoaded.done(function() {
      this.autoSoundPlayMP3(s);
    }.bind(this));
    return;
  }
  if (typeof this.soundSetting !== 'undefined' && this.soundSetting == 0) return;
  var _this = this;
  var e = (arguments.length > 1) ? arguments[1] : null;
  var onStartSoundEvent = this.noOp;
  var onEndSoundEvent = this.noOp;
  var soundUrl = this.getSoundFilename(this.CurrentProblem.pkMLProblemID, s.trim());
  if (!this.isURLValid(soundUrl)) {
    return;
  }
  if (e) {
    onStartSoundEvent = function() {
      _this.onStartSoundEvent.call(this, e);
    };
    onEndSoundEvent = function() {
      _this.onEndSoundEvent.call(this, e);
      _this.autoSoundPlayMultipleNext();
      _this.hasAnySoundPlayed = true;
      _this.resetSoundTriggerEvent();
    };
  }
  if (navigator.userAgent.indexOf('CriOS') > -1) {
    onStartSoundEvent();
    _this.playFile(soundUrl);
    setTimeout(function() {
      onEndSoundEvent();
    }, 1000);
  } else {
    if (soundManager.supported()) {
      if (_this.isInitedSound(s.trim())) {
        _this.playInitedSound(s.trim(), true);
      } else {
        soundManager.destroySound('aSound');
        soundManager.createSound({
          id: 'aSound',
          url: soundUrl,
          onplay: onStartSoundEvent,
          onfinish: onEndSoundEvent,
          onerror: onEndSoundEvent
        });
        soundManager.play('aSound');
      }
    }
  }
};
LabClass.prototype.getSoundFilename = function(pkMLProblemID, id) {
  if (id.indexOf('.mp3') < 0) id += '.mp3';
  if (id.indexOf('/') < 0) {
    var FolderId = parseInt(pkMLProblemID / 1000);
    id = this.config.audioServer + 'problems/' + FolderId + '/' + pkMLProblemID + '/' + id;
  } else {
    id += '?' + Math.random();
  }
  return id;
};
LabClass.prototype.preloadSound = function(pkMLProblemID, id) {
  var d = $.Deferred();
  this.soundManagerLoaded.done(function() {
    if (soundManager.supported()) {
      soundManager.destroySound('aSound');
      var mySound = soundManager.createSound({
        id: 'aSound',
        autoLoad: true,
        url: this.getSoundFilename(pkMLProblemID, id),
        onload: function(bSuccess) {
          if (!bSuccess) {
            this.soundStatus = 6;
            d.reject();
          } else {
            this.soundStatus = 1;
            mySound.timestamp = new Date().getTime();
            d.resolve(mySound);
          }
        }.bind(this)
      });
      if ((navigator.userAgent.toLowerCase().indexOf('ipad') > -1) || (navigator.userAgent.toLowerCase().indexOf('iphone') > -1) || (navigator.userAgent.toLowerCase().indexOf('crios') > -1)) {
        mySound.timestamp = new Date().getTime();
        d.resolve(mySound);
      }
    } else {
      d.reject();
    }
  }.bind(this)).fail(d.reject);
  return d.promise();
};
LabClass.prototype.autoPlayFile = function(SoundSetting, CurrentProblem, subject) {
  var result = {
    playFile: false,
    readTTS: false,
    playVideo: false
  };
  var allSubjects = ['MM', 'MG', 'SC', 'SS', 'ATM', 'SR', 'GLM', 'FR', 'ATA', 'GLA', 'GLR', 'ATEM', 'MM2', 'FGSC', 'ATFA', 'ATFS', 'ATFM', 'ATFD', 'GLPM', 'GLPL', 'FGM', 'FGL', 'FGFR', 'FGRTM', 'FGRTL', 'FGRTFR', 'FGBM', 'FGBL', 'FGBFR', 'QT'];
  var chunkSubjects = ['MR', 'MG', 'GP', 'FR', 'ATFR', 'GLFR', 'GLL', 'ATEM', 'ATFA', 'ATFS', 'ATFM', 'ATFD', 'ATEL', 'GLPFR', 'FGM', 'FGL', 'FGFR', 'FGRTM', 'FGRTL', 'FGRTFR', 'FGBM', 'FGBL', 'FGBFR', 'QT'];
  var arrLargeIcons = $('.lab-problem .pbl-large-sound-icon, .lab-problem .pbl-large-sound-icon .large_play_icon');
  var currentSoundType = '';
  var _this = this;
  this.soundSetting = SoundSetting;
  if ((SoundSetting == 1 && CurrentProblem.TypeNew == 'Teach Me') || (SoundSetting == 2 && (chunkSubjects.indexOf(subject) < 0 || arrLargeIcons.length == 0 || CurrentProblem.TypeNew == 'Teach Me'))) {
    if (CurrentProblem.VoiceFile != null && CurrentProblem.VoiceFile != '') {
      currentSoundType = 'VoiceFile';
      result.playFile = CurrentProblem.VoiceFile;
    } else if (CurrentProblem.VoiceAndMusicFile != null && CurrentProblem.VoiceAndMusicFile != '') {
      currentSoundType = 'VoiceAndMusicFile';
      result.playFile = CurrentProblem.VoiceAndMusicFile;
    } else if (CurrentProblem.StatementVoice != null && CurrentProblem.StatementVoice != '') {
      currentSoundType = 'StatementVoice';
      result.playFile = CurrentProblem.StatementVoice;
    } else if (CurrentProblem.IntroFakeText != null && CurrentProblem.IntroFakeText != '') {
      currentSoundType = 'IntroFakeText';
      result.readTTS = this.autoSoundCleanup(CurrentProblem.IntroFakeText, 'IntroFakeText', CurrentProblem);
    } else if ((CurrentProblem.hasReadText == 1) || (typeof CurrentProblem.Problem != 'undefined' && CurrentProblem.Problem.indexOf("play(\"ProblemReadText\")") > 0)) {
      currentSoundType = 'ProblemReadText';
      result.playFile = 'ProblemReadText';
    } else if (allSubjects.indexOf(subject) >= 0 || arrLargeIcons.length == 0) {
      if (CurrentProblem.ReadTextTTS != null && CurrentProblem.ReadTextTTS != '') {
        result.readTTS = this.autoSoundCleanup(CurrentProblem.ReadTextTTS, 'ReadTextTTS', CurrentProblem);
      } else {
        arrLargeIcons.each(function() {
          var s = $(this).attr('data-sound');
          if (s) {
            result.readTTS = $(this);
            return false;
          }
        });
      }
      if (!result.readTTS) {
        result.readTTS = [];
        $('.lab-problem .auto_play_icon').each(function() {
          var s = $(this).attr('data-sound');
          if (s && (s.indexOf('StatementText') >= 0 || s.indexOf('StatementVoice') >= 0 || s.indexOf('BlankField') >= 0 || s.indexOf('ProblemReadText') >= 0 || s.indexOf('Header') >= 0)) {
            result.readTTS.push($(this));
          }
        });
        if (result.readTTS.length == 0) {
          $('.lab-problem .auto_play_icon').each(function() {
            var s = $(this).attr('data-sound');
            if (s && s.indexOf('HotspotTTS') >= 0) {
              result.readTTS.push($(this));
            }
          });
          if (result.readTTS.length > 0) {
            result.readTTS = [result.readTTS[0]];
          }
        }
        if (result.readTTS.length == 0)
          result.readTTS = false;
      }
    }
  } else if (chunkSubjects.indexOf(subject) >= 0) {
    arrLargeIcons.each(function() {
      var s = $(this).attr('data-sound');
      if (s) {
        result.readTTS = $(this);
        return false;
      }
    });
  }
  if (!result.playFile && !result.readTTS) {
    if ($('.lab-problem iframe.mobyPlayer').length > 0) {
      result.playVideo = true;
    }
  }
  if (result.playFile != false) {
    app.labObject.onEvent('beforeAutoplay', result.playFile);
    var soundName = this.isInitedSound(result.playFile) ? result.playFile : result.playFile + '-' + CurrentProblem.pkMLProblemID;
    var imagesPromise = (typeof labProblem == 'undefined') ? $.Deferred().resolve() : labProblem.imagesLoaded('.lab-problem .problem-statement');
    var soundPromise = this.initSoundPromise(soundName, this.getSoundFilename(CurrentProblem.pkMLProblemID, result.playFile));
    var soundManagerPromise = this.soundManagerLoaded.promise();
    if (this.soundManagerLoaded.state() !== 'resolved') {
      setTimeout(function() {
        _this.soundManagerLoaded.resolve();
      }, 1000);
    }
    $.when(imagesPromise, soundManagerPromise, soundPromise).done(function(totalImages, sm, loadedSound) {
      app.labObject.onEvent('afterAutoplay', sm, totalImages, loadedSound);
      if ((SoundSetting > 0 && CurrentProblem.TypeNew == 'Teach Me') || chunkSubjects.indexOf(subject) < 0 || (chunkSubjects.indexOf(subject) >= 0 && !$('.lab-problem').hasClass('ms-show-feedback'))) {
        var callback = function(id) {};
        var onstart = function() {
          var animatedImages = document.getElementsByClassName('pbl-animated-image');
          for (let i = 0; i < animatedImages.length; i++) {
            var image = animatedImages[i];
            if (image.src.includes('AnimatedGif')) {
              var imageUrl = image.src;
              image.src = "";
              image.src = imageUrl
            }
          }
        };
        if (currentSoundType.length && $(".auto_play_icon[data-sound*='" + currentSoundType + "']").length == 1) {
          var element = $(".auto_play_icon[data-sound*='" + currentSoundType + "']");
          if (loadedSound && loadedSound.url && loadedSound.id && this.isInitedSound(loadedSound.id)) {
            this.playInitedSound(loadedSound.id, true, callback, onstart);
          } else {
            this.autoSoundTrigger(element, null, CurrentProblem);
          }
        } else {
          this.playInitedSound(soundName, true, callback, onstart);
        }
      }
    }.bind(this));
  } else if (result.readTTS != false) {
    app.labObject.onEvent('beforeAutoplay', result.readTTS);
    var soundsToBeLoaded = [];
    if (Array.isArray(result.readTTS)) {
      var soundsSentToBeInitialized = this.preInitSounds(result.readTTS ? result.readTTS : []);
      soundsToBeLoaded.push(soundsSentToBeInitialized[0]);
    } else {
      if (result.readTTS != 'notts') {
        soundsToBeLoaded = this.preInitSounds(result.readTTS ? [result.readTTS] : []);
      }
    }
    var checkIfSoundLoaded = new Promise(function(resolve, reject) {
      (function waitForSoundToBeLoaded() {
        var allLoaded = true;
        for (var i = 0; i < soundsToBeLoaded.length; i++) {
          if (typeof app.labObject.initedSounds[soundsToBeLoaded[i]] == 'undefined') {
            allLoaded = false;
            break;
          }
        }
        if (allLoaded) {
          return resolve();
        }
        setTimeout(waitForSoundToBeLoaded, 300);
      })();
    });
    $.when(labProblem.imagesLoaded('.lab-problem .problem-statement'), this.responsiveVoice.responsiveVoiceReady.promise(), checkIfSoundLoaded).done(function(totalImages, rv) {
      app.labObject.onEvent('afterAutoplay', rv, totalImages);
      if ((SoundSetting > 0 && CurrentProblem.TypeNew == 'Teach Me') || chunkSubjects.indexOf(subject) < 0 || (chunkSubjects.indexOf(subject) >= 0 && !$('.lab-problem').hasClass('ms-show-feedback'))) {
        if (typeof result.readTTS == 'string')
          this.autoSoundPlayTTS(result.readTTS);
        else
          this.autoSoundPlayMultiple(result.readTTS);
      }
    }.bind(this));
  } else if (result.playVideo != false) {
    $('.lab-problem iframe.mobyPlayer').load(function() {
      $('.lab-problem iframe.mobyPlayer').mobyVideo({
        fallbackContainerEl: $('.ms-pbl-content')[0],
        'onInitSuccess': function() {
          $('.lab-problem iframe.mobyPlayer').mobyVideo('sendMessage', {
            'mediaelement.play': true
          });
        }
      });
    });
  } else {
    labProblem.imagesLoaded('.lab-problem .problem-statement');
  }
};
LabClass.prototype.stopSounds = function() {
  this.pauseInitedSound();
  $('.lab-problem .playing').removeClass('playing');
  $.when(this.soundManagerLoaded.promise()).done(function(sm) {
    soundManager.destroySound('aSound');
  });
  if (!this.isAutosoundTriggered) {
    this.autoSoundList = [];
  }
  this.responsiveVoice.stop();
  this.cancelAllInitedCallbackTimers();
  this.setInitedSoundPlayStatus(false);
  if (this.responsiveVoice.defaultType == 'polly') {
    if (this.previousSpeechmarkInstance) {
      this.interactiveVoice.disable(this.previousSpeechmarkInstance);
      this.interactiveVoice.cleanUpNodes(this.previousSpeechmarkInstance);
    }
  }
};
LabClass.prototype.playTTS = function(id) {
  if (typeof id === 'undefined' || !id || typeof id !== 'string') {
    return;
  }
  var readThis = id;
  if (id.substring(id.length - 3).toLowerCase() == 'tts' && typeof this.CurrentProblem !== 'undefined' && typeof this.CurrentProblem[id] !== 'undefined') {
    readThis = this.CurrentProblem[id];
  } else {
    if (id.indexOf(':') !== -1) {
      var tmp = id.split(':');
      if (tmp.length == 2) {
        readThis = this.autoSoundParseField(this.CurrentProblem, tmp[1]);
      }
    }
  }
  this.responsiveVoice.responsiveVoiceReady.promise().then(function() {
    this.responsiveVoice.speak(readThis);
  }.bind(this));
};
LabClass.prototype.play = function(id, onEndCallback) {
  var _this = this;
  if (typeof id === 'undefined' || !id || typeof id !== 'string') {
    return;
  }
  if (id.substring(id.length - 3).toLowerCase() == 'tts') {
    this.playTTS(id);
    return;
  }
  if (this.soundManagerLoaded.state() !== 'resolved') {
    this.soundManagerLoaded.done(function() {
      this.play(id, onEndCallback);
    }.bind(this));
    return;
  }
  if (soundManager.supported()) {
    soundManager.destroySound('aSound');
    var mp3FilePath = '';
    if ((id.indexOf('/') > 0 && id.indexOf('.mp3') > 0) || id.indexOf('http://') == 0 || id.indexOf('https://') == 0) {
      mp3FilePath = id;
    } else {
      var problemId = typeof CurrentProblem !== 'undefined' ? CurrentProblem.pkMLProblemID : window.app.labObject.CurrentProblem.pkMLProblemID;
      var tmpId = id;
      if (id.indexOf(':') !== -1) {
        var tmp = id.split(':');
        if (tmp.length == 2) {
          tmpId = tmp[1];
        }
      }
      mp3FilePath = this.getSoundFilename(problemId, tmpId);
    }
    if (!this.isURLValid(mp3FilePath)) {
      return;
    }
    var mySound = soundManager.createSound({
      id: 'aSound',
      url: mp3FilePath,
      onload: function(bSuccess) {
        if (!bSuccess)
          this.soundStatus = 6;
        else
          this.soundStatus = 1;
      }.bind(this),
      onfinish: function() {
        if (typeof onEndCallback == 'function') {
          onEndCallback();
        }
        _this.resetSoundTriggerEvent();
      },
      onerror: function() {
        if (typeof onEndCallback == 'function') {
          onEndCallback();
        }
        _this.resetSoundTriggerEvent();
      }
    });
    mySound.play();
  } else {
    labProblem.hidePlayIcons();
  }
};
LabClass.prototype.getProblemPath = function(id) {
  return (id > 0) ? 'problems/' + Math.floor(id / 1000) + '/' + id + '/' : '';
};
LabClass.prototype.playFile = function(file, onEndCallback) {
  this.play(file, onEndCallback);
};
LabClass.prototype.playEmptyAudioFile = function() {
  this.play('https://data.mobymax.com/er/words/audio/empty.mp3');
};
LabClass.prototype.hasProblemSoundPlayed = function() {
  return this.hasAnySoundPlayed;
};
LabClass.prototype.preloadSounds = function(sounds) {
  if ((navigator.userAgent.toLowerCase().indexOf('ipad') > -1) || (navigator.userAgent.toLowerCase().indexOf('iphone') > -1) || (navigator.userAgent.toLowerCase().indexOf('crios') > -1)) {
    return;
  }
  this.soundManagerLoaded.done(function() {
    this.preloadedSounds = this.preloadedSounds || {};
    var loader = new PxLoader();
    var i, len, foundUnloaded = false;
    for (i = 0, len = sounds.length; i < len; i++) {
      if ((typeof this.preloadedSounds[sounds[i]] !== 'undefined') && (this.preloadedSounds[sounds[i]].url == sounds[i])) {
        continue;
      }
      loader.addSound(sounds[i], sounds[i]);
      this.preloadedSounds[sounds[i]] = {
        url: sounds[i],
        loaded: false
      };
      foundUnloaded = true;
    }
    if (foundUnloaded) {
      loader.addProgressListener(function(e) {
        if (e.timeout == true || e.error == true || e.loaded == false) {
          this.preloadedSounds[e.resource.sound.sID].loaded = false;
        } else {
          this.preloadedSounds[e.resource.sound.sID].loaded = true;
        }
      }.bind(this));
      loader.start();
    }
  }.bind(this));
};
LabClass.prototype.playSoundPreloaded = function(name) {
  if (!this.isURLValid(name)) {
    return;
  }
  this.soundManagerLoaded.done(function() {
    this.preloadedSounds = this.preloadedSounds || {};
    if (typeof this.preloadedSounds[name] !== 'undefined' && this.preloadedSounds[name].loaded == true) {
      soundManager.play(name);
    } else {
      this.soundManagerLoaded.done(function() {
        var mySound = soundManager.createSound({
          id: 'dynamicSound',
          url: name,
          onload: function(bSuccess) {}
        });
        mySound.play();
      }.bind(this));
    }
  }.bind(this));
};
LabClass.prototype.setMessage = function() {
  if (this.IsReadAloudTeacher && this.IsReadAloudTeacher !== 1) {
    this.soundStatus = 2;
  }
  $('#sound-settings .sound-diagnostic-fieldset .sound-diagnostic-text').html((this.soundMessage && this.soundMessage[this.soundStatus]) ? this.soundMessage[this.soundStatus] : '');
};
LabClass.prototype.doNewSoundInstance = function(params, callback) {
  var proceed = true;
  var soundProperties = JSON.parse(JSON.stringify(params));
  var soundUrl = new URL(soundProperties.url);
  if (this.responsiveVoice.defaultType == 'polly' && soundUrl.pathname.indexOf('ResponsiveVoice/getvoice.php') !== -1) {
    var text = soundUrl.searchParams.get('t');
    if (text.length > 3000) {
      proceed = false;
    }
  } else {
    proceed = false;
  }
  var mySound = soundManager.createSound(soundProperties);
  if (proceed) {
    if (!this.responsiveVoice.isRequestLive) {
      mySound.url = this.responsiveVoice.getS3Hash(soundProperties.url);
    }
    var retry = false;
    var checkPromise = new Promise(function(resolve, reject) {
      var checkResponseInterval = setInterval(function() {
        if (mySound.readyState == 2) {
          if (retry) {
            clearInterval(checkResponseInterval);
            reject(false);
          }
          mySound.url = params.url;
          mySound.load();
          retry = true;
        } else if (mySound.readyState >= 3) {
          clearInterval(checkResponseInterval);
          resolve(true);
        }
      }, 10);
    });
    Promise.allSettled([checkPromise]).then(function() {
      callback(mySound);
    });
  } else {
    callback(mySound);
  }
};

function UndoRedo() {
  var data = (arguments.length > 0) ? arguments[0] : {};
  this.data = $.extend({
    'currentState': [],
    'stack': [],
    'redoStack': [],
    'drawFunction': this.noOp
  }, data);
  this.doCommand = function(action, currentState) {
    var stateFlag = {
      'undo_active': false,
      'redo_active': false
    };
    if (action == 'add') {
      this.data.redoStack = [];
      this.data.stack.push(this.data.currentState);
      this.setCurrentState(currentState);
    } else if (action == 'redo') {
      this.data.stack.push(currentState);
      var newCurrentState = this.data.redoStack.pop();
      if (newCurrentState != null || newCurrentState !== undefined) {
        this.setCurrentState(newCurrentState);
      }
    } else if (action == 'undo') {
      this.data.redoStack.push(currentState);
      var newCurrentState = this.data.stack.pop();
      if (newCurrentState != null || newCurrentState !== undefined) {
        this.setCurrentState(newCurrentState);
      }
    } else if (action == 'reset') {
      var newCurrentState = this.data.stack.shift();
      if (newCurrentState != null || newCurrentState !== undefined) {
        this.setCurrentState(newCurrentState);
      }
      this.data.stack = [];
      this.data.redoStack = [];
    }
    stateFlag['undo_active'] = this.data.stack.length > 0 ? true : false;
    stateFlag['redo_active'] = this.data.redoStack.length > 0 ? true : false;
    this.data.drawFunction.call(this, action, this.data.currentState, stateFlag);
  };
};
UndoRedo.prototype.setCurrentState = function(currentState) {
  if (typeof currentState === 'object') {
    this.data.currentState = currentState;
  }
};
UndoRedo.prototype.addCommand = function(currentState) {
  if (typeof currentState === 'object') {
    this.doCommand('add', currentState);
  }
};
UndoRedo.prototype.undoCommand = function() {
  if (this.data.currentState != null || this.data.currentState !== undefined) {
    this.doCommand('undo', this.data.currentState);
  }
};
UndoRedo.prototype.redoCommand = function() {
  if (this.data.currentState != null || this.data.currentState !== undefined) {
    this.doCommand('redo', this.data.currentState);
  }
};
UndoRedo.prototype.resetCommand = function() {
  if (this.data.currentState != null || this.data.currentState !== undefined) {
    this.doCommand('reset', this.data.currentState);
  }
};
UndoRedo.prototype.noOp = function() {
  console.error('Add a drawFunction for callbacks...');
};
UndoRedo.prototype.printStack = function() {
  console.log(this.data);
};
if (typeof module === "object" && module.exports) {
  module.exports = UndoRedo;
}
LabClass.prototype.localData = {
  active: false,
  key: '',
  store: function(key, value) {
    if (this.active)
      localStorage.setItem(key, (typeof value == 'object') ? JSON.stringify(value) : value);
  },
  read: function(key, defaultValue) {
    if (this.active) {
      var value = localStorage.getItem(key);
      return (value == null) ? defaultValue : ((typeof defaultValue == 'object') ? JSON.parse(value) : value);
    }
    return defaultValue;
  },
  setActive: function(active) {
    if ('localStorage' in window && window['localStorage'] !== null) {
      try {
        localStorage.setItem('testItem', 1);
        localStorage.removeItem('testItem');
        this.active = active;
      } catch (e) {
        this.active = false;
      }
    }
  },
  setData: function(value) {
    this.store(this.key, value);
  },
  getData: function(defaultValue) {
    return this.read(this.key, defaultValue);
  },
  clear: function() {
    if (this.active)
      localStorage.removeItem(this.key);
  }
};
LabClass.prototype.deleteLocalData = function() {
  this.localData.clear();
};
var pageSlider = {
  slide: function(selectorIn, selectorOut, leftToRight) {
    var $in = $(selectorIn);
    var $out = $(selectorOut);
    var $parent = $(selectorOut).parent();
    var originalWidth = $parent.width() + 'px';
    $parent.css({
      'position': 'relative',
      'overflow': 'hidden'
    });
    $out.css({
      'position': 'absolute',
      'left': 0,
      'width': originalWidth
    });
    $out.animate({
      'left': (leftToRight ? '' : '-') + originalWidth
    }, 300, 'linear');
    $in.css({
      'position': 'absolute',
      'left': (leftToRight ? '-' : '') + originalWidth,
      'width': originalWidth
    }).show();
    $in.animate({
      'left': 0
    }, 300, 'linear', function() {
      $out.css({
        'position': '',
        'left': '',
        'width': ''
      }).hide();
      $in.css({
        'position': '',
        'left': '',
        'width': ''
      });
      $parent.css({
        'position': '',
        'overflow': ''
      });
    });
  }
};
var lab_stars = {
  starTypes: ['ex-s-EmptyStar.png', 'ex-s-CorrectStar.png', 'ex-s-HalfStar.png', 'ex-s-IncorrectStar.png'],
  rectTypes: ['lab-star-empty', 'lab-star-correct', 'lab-star-correct', 'lab-star-correct'],
  selector: '',
  starWidth: 19,
  rectWidth: 16,
  showhide: true,
  showRectangles: false,
  hideText: false,
  showProgressBar: false,
  progressBarSelector: '#progress_bar',
  progressBarClass: 'ui-progress-bar ui-container',
  init: function(params) {
    $.extend(this, params);
  },
  show: function() {
    $(this.selector).show();
  },
  hide: function() {
    $(this.selector).hide();
  },
  getItem: function(itemIndex) {
    return (this.showRectangles ? ('<div class="' + this.rectTypes[itemIndex] + '"></div>') : ('<img src="/MM/img/MS/' + this.starTypes[itemIndex] + '" width="' + this.starWidth + '"/>'));
  },
  update: function(stars, total, current) {
    if (this.showProgressBar) {
      this.updateProgressBar(stars, total, current);
    } else {
      var html = '';
      if (this.showRectangles) {
        if (!$(this.selector).hasClass('lab-stars-rect'))
          $(this.selector).addClass('lab-stars-rect');
      } else {
        $(this.selector).removeClass('lab-stars-rect');
      }
      if (!$(this.selector).is(':visible') && this.showhide) this.show();
      var perRow = Math.floor($(this.selector).width() / (this.showRectangles ? this.rectWidth : this.starWidth));
      var start = Math.max((Math.floor(current / perRow) - (this.showRectangles ? 1 : 0)), 0) * perRow;
      var displayCount = perRow * (this.showRectangles ? 2 : 1);
      for (var i = start; i < Math.min((start + displayCount), total); i++)
        html += this.getItem((i < stars.length) ? stars[i] : 0);
      $(this.selector).html('<div>' + html + '</div>');
    }
  },
  updateProgressBar: function(stars, total, current) {
    if (((current + 1) == total) && (current < stars.length) && (stars[current] != 0))
      current = total;
    var percent = Math.min((current * 100) / (total > 0 ? total : 1), 100);
    this.hide();
    $(this.progressBarSelector).attr('class', this.progressBarClass + ' problem-progress');
    $(this.progressBarSelector).show();
    $(this.progressBarSelector + ' .ui-progress').show();
    $(this.progressBarSelector + ' .ui-progress').css('width', percent + '%');
    var progressBarText = this.hideText ? '' : ('Problem ' + Math.min((current + 1), total) + ' of ' + total);
    $(this.progressBarSelector + ' .ui-progress-text').html(progressBarText);
  }
};
/*! flip - v1.1.2 - 2016-10-20
 * https://github.com/nnattawat/flip
 * Copyright (c) 2016 Nattawat Nonsung; Licensed MIT */
(function($) {
  var whichTransitionEvent = function() {
    var t, el = document.createElement("fakeelement"),
      transitions = {
        "transition": "transitionend",
        "OTransition": "oTransitionEnd",
        "MozTransition": "transitionend",
        "WebkitTransition": "webkitTransitionEnd"
      };
    for (t in transitions) {
      if (el.style[t] !== undefined) {
        return transitions[t];
      }
    }
  };
  var Flip = function($el, options, callback) {
    this.setting = {
      axis: "y",
      reverse: false,
      trigger: "click",
      speed: 500,
      forceHeight: false,
      forceWidth: false,
      autoSize: true,
      front: '.front',
      back: '.back'
    };
    this.setting = $.extend(this.setting, options);
    if (typeof options.axis === 'string' && (options.axis.toLowerCase() === 'x' || options.axis.toLowerCase() === 'y')) {
      this.setting.axis = options.axis.toLowerCase();
    }
    if (typeof options.reverse === "boolean") {
      this.setting.reverse = options.reverse;
    }
    if (typeof options.trigger === 'string') {
      this.setting.trigger = options.trigger.toLowerCase();
    }
    var speed = parseInt(options.speed);
    if (!isNaN(speed)) {
      this.setting.speed = speed;
    }
    if (typeof options.forceHeight === "boolean") {
      this.setting.forceHeight = options.forceHeight;
    }
    if (typeof options.forceWidth === "boolean") {
      this.setting.forceWidth = options.forceWidth;
    }
    if (typeof options.autoSize === "boolean") {
      this.setting.autoSize = options.autoSize;
    }
    if (typeof options.front === 'string' || options.front instanceof $) {
      this.setting.front = options.front;
    }
    if (typeof options.back === 'string' || options.back instanceof $) {
      this.setting.back = options.back;
    }
    this.element = $el;
    this.frontElement = this.getFrontElement();
    this.backElement = this.getBackElement();
    this.isFlipped = false;
    this.init(callback);
  };
  $.extend(Flip.prototype, {
    flipDone: function(callback) {
      var self = this;
      self.element.one(whichTransitionEvent(), function() {
        self.element.trigger('flip:done');
        if (typeof callback === 'function') {
          callback.call(self.element);
        }
      });
    },
    flip: function(callback) {
      if (this.isFlipped) {
        return;
      }
      this.isFlipped = true;
      var rotateAxis = "rotate" + this.setting.axis;
      this.frontElement.css({
        transform: rotateAxis + (this.setting.reverse ? "(-180deg)" : "(180deg)"),
        "z-index": "0"
      });
      this.backElement.css({
        transform: rotateAxis + "(0deg)",
        "z-index": "1"
      });
      this.flipDone(callback);
    },
    unflip: function(callback) {
      if (!this.isFlipped) {
        return;
      }
      this.isFlipped = false;
      var rotateAxis = "rotate" + this.setting.axis;
      this.frontElement.css({
        transform: rotateAxis + "(0deg)",
        "z-index": "1"
      });
      this.backElement.css({
        transform: rotateAxis + (this.setting.reverse ? "(180deg)" : "(-180deg)"),
        "z-index": "0"
      });
      this.flipDone(callback);
    },
    getFrontElement: function() {
      if (this.setting.front instanceof $) {
        return this.setting.front;
      } else {
        return this.element.find(this.setting.front);
      }
    },
    getBackElement: function() {
      if (this.setting.back instanceof $) {
        return this.setting.back;
      } else {
        return this.element.find(this.setting.back);
      }
    },
    init: function(callback) {
      var self = this;
      var faces = self.frontElement.add(self.backElement);
      var rotateAxis = "rotate" + self.setting.axis;
      var perspective = self.element["outer" + (rotateAxis === "rotatex" ? "Height" : "Width")]() * 2;
      var elementCss = {
        'perspective': perspective,
        'position': 'relative'
      };
      var backElementCss = {
        "transform": rotateAxis + "(" + (self.setting.reverse ? "180deg" : "-180deg") + ")",
        "z-index": "0",
        "position": "relative"
      };
      var faceElementCss = {
        "backface-visibility": "hidden",
        "transform-style": "preserve-3d",
        "position": "absolute",
        "z-index": "1"
      };
      if (self.setting.forceHeight) {
        faces.outerHeight(self.element.height());
      } else if (self.setting.autoSize) {
        faceElementCss.height = '100%';
      }
      if (self.setting.forceWidth) {
        faces.outerWidth(self.element.width());
      } else if (self.setting.autoSize) {
        faceElementCss.width = '100%';
      }
      if ((window.chrome || (window.Intl && Intl.v8BreakIterator)) && 'CSS' in window) {
        elementCss["-webkit-transform-style"] = "preserve-3d";
      }
      faces.css(faceElementCss).find('*').css({
        "backface-visibility": "hidden"
      });
      self.element.css(elementCss);
      self.backElement.css(backElementCss);
      setTimeout(function() {
        var speedInSec = self.setting.speed / 1000 || 0.5;
        faces.css({
          "transition": "all " + speedInSec + "s ease-out"
        });
        if (typeof callback === 'function') {
          callback.call(self.element);
        }
      }, 20);
      self.attachEvents();
    },
    clickHandler: function(event) {
      if (!event) {
        event = window.event;
      }
      if (this.element.find($(event.target).closest('button, a, input[type="submit"]')).length) {
        return;
      }
      if (this.isFlipped) {
        this.unflip();
      } else {
        this.flip();
      }
    },
    hoverHandler: function() {
      var self = this;
      self.element.off('mouseleave.flip');
      self.flip();
      setTimeout(function() {
        self.element.on('mouseleave.flip', $.proxy(self.unflip, self));
        if (!self.element.is(":hover")) {
          self.unflip();
        }
      }, (self.setting.speed + 150));
    },
    attachEvents: function() {
      var self = this;
      if (self.setting.trigger === "click") {
        self.element.on($.fn.tap ? "tap.flip" : "click.flip", $.proxy(self.clickHandler, self));
      } else if (self.setting.trigger === "hover") {
        self.element.on('mouseenter.flip', $.proxy(self.hoverHandler, self));
        self.element.on('mouseleave.flip', $.proxy(self.unflip, self));
      }
    },
    flipChanged: function(callback) {
      this.element.trigger('flip:change');
      if (typeof callback === 'function') {
        callback.call(this.element);
      }
    },
    changeSettings: function(options, callback) {
      var self = this;
      var changeNeeded = false;
      if (options.axis !== undefined && self.setting.axis !== options.axis.toLowerCase()) {
        self.setting.axis = options.axis.toLowerCase();
        changeNeeded = true;
      }
      if (options.reverse !== undefined && self.setting.reverse !== options.reverse) {
        self.setting.reverse = options.reverse;
        changeNeeded = true;
      }
      if (changeNeeded) {
        var faces = self.frontElement.add(self.backElement);
        var savedTrans = faces.css(["transition-property", "transition-timing-function", "transition-duration", "transition-delay"]);
        faces.css({
          transition: "none"
        });
        var rotateAxis = "rotate" + self.setting.axis;
        if (self.isFlipped) {
          self.frontElement.css({
            transform: rotateAxis + (self.setting.reverse ? "(-180deg)" : "(180deg)"),
            "z-index": "0"
          });
        } else {
          self.backElement.css({
            transform: rotateAxis + (self.setting.reverse ? "(180deg)" : "(-180deg)"),
            "z-index": "0"
          });
        }
        setTimeout(function() {
          faces.css(savedTrans);
          self.flipChanged(callback);
        }, 0);
      } else {
        self.flipChanged(callback);
      }
    }
  });
  $.fn.flip = function(options, callback) {
    if (typeof options === 'function') {
      callback = options;
    }
    if (typeof options === "string" || typeof options === "boolean") {
      this.each(function() {
        var flip = $(this).data('flip-model');
        if (options === "toggle") {
          options = !flip.isFlipped;
        }
        if (options) {
          flip.flip(callback);
        } else {
          flip.unflip(callback);
        }
      });
    } else {
      this.each(function() {
        if ($(this).data('flip-model')) {
          var flip = $(this).data('flip-model');
          if (options && (options.axis !== undefined || options.reverse !== undefined)) {
            flip.changeSettings(options, callback);
          }
        } else {
          $(this).data('flip-model', new Flip($(this), (options || {}), callback));
        }
      });
    }
    return this;
  };
}(jQuery));;
(function($, window, document, undefined) {
  "use strict";
  $.fn.mobyResizable = function(options) {
    var settings = $.extend({
      direction: 'vertical',
      type: null,
      startStep: 0,
      minStep: 0,
      maxStep: 0,
      stepSpeed: 0.1,
      minVal: 0,
      maxVal: 10,
      availableHeight: 300,
      draggingClass: 'dragging',
      setDataIncrement: true,
      onCreate: function(element) {},
      onStart: function(element) {},
      onResize: function(element) {},
      onStop: function(element) {}
    }, options);
    var functions = {
      getValueFromPosition: function(pos) {
        var value = parseFloat(settings.minVal) + (parseFloat(pos / settings.availableHeight) * parseFloat(settings.maxVal - settings.minVal));
        var precision = functions.countDecimals(settings.stepSpeed);
        return (precision != 0) ? parseFloat(value).toFixed(precision) : parseInt(Math.round(value));
      },
      cap: function(pos, min, max) {
        if (pos < min) {
          return min;
        }
        if (pos > max) {
          return max;
        }
        return pos;
      },
      isInt: function(value) {
        if ((parseFloat(value) == parseInt(value)) && !isNaN(value)) {
          return true;
        } else {
          return false;
        }
      },
      countDecimals: function(value) {
        if (Math.floor(value) === value) return 0;
        return value.toString().split(".")[1].length || 0;
      },
      setPosition: function(element, element_height, resize, initialY, pageY, setDefault) {
        if (settings.direction == 'vertical') {
          if (settings.type === null || settings.type === 'plot') {
            var finalHeight = 0;
            var stepConverted = (setDefault) ? settings.startStep * settings.stepSpeed : (pageY - (Math.round((pageY - initialY) / settings.stepSpeed) * settings.stepSpeed));
            var currentValue = element_height + stepConverted - pageY;
            if (currentValue < (settings.stepSpeed * settings.minStep)) {
              finalHeight = settings.stepSpeed * settings.minStep;
            } else if (currentValue > (settings.stepSpeed * settings.maxStep)) {
              finalHeight = settings.stepSpeed * settings.maxStep;
            } else {
              finalHeight = currentValue;
            }
            element.height(finalHeight);
            if (settings.setDataIncrement) {
              var precision = functions.countDecimals(settings.stepSpeed);
              if (precision != 0) {
                element.attr('data-increments', parseFloat(finalHeight / settings.stepSpeed).toFixed(precision));
              } else {
                element.attr('data-increments', parseInt(finalHeight / settings.stepSpeed));
              }
            }
          } else if (settings.type === 'bar') {
            var stepHeight = parseFloat((settings.stepSpeed / (settings.maxVal - settings.minVal)) * settings.availableHeight);
            var tmp = (setDefault) ? (settings.startStep * stepHeight) : parseFloat(pageY - (Math.round(pageY - initialY)));
            var tmpHeight = parseFloat(element_height) + (Math.round((tmp - pageY) / parseFloat(stepHeight)) * parseFloat(stepHeight));
            var finalHeight = functions.cap(tmpHeight, 0, settings.availableHeight);
            element.height(finalHeight);
            if (settings.setDataIncrement) {
              var incrementValue = functions.getValueFromPosition(finalHeight);
              element.attr('data-increments', incrementValue);
            }
          }
        }
      }
    };
    settings.startStep = parseFloat(settings.startStep);
    settings.minStep = parseFloat(settings.minStep);
    settings.maxStep = parseFloat(settings.maxStep);
    if (functions.isInt(settings.stepSpeed)) {
      settings.stepSpeed = parseInt(settings.stepSpeed);
    } else {
      var precision = functions.countDecimals(settings.stepSpeed);
      settings.stepSpeed = parseFloat(settings.stepSpeed).toFixed(precision);
    }
    if (functions.isInt(settings.minVal)) {
      settings.minVal = parseInt(settings.minVal);
    } else {
      settings.minVal = parseFloat(settings.minVal).toFixed(2);
    }
    if (functions.isInt(settings.maxVal)) {
      settings.maxVal = parseInt(settings.maxVal);
    } else {
      settings.maxVal = parseFloat(settings.maxVal).toFixed(2);
    }
    if (functions.isInt(settings.availableHeight)) {
      settings.availableHeight = parseInt(settings.availableHeight);
    } else {
      settings.availableHeight = parseFloat(settings.availableHeight).toFixed(2);
    }
    var current = null;
    return this.each(function() {
      var element = $(this);
      var resize = false;
      var element_height = 0;
      var initial = {};
      var handles = {};
      element.addClass('pbl-moby-resizable');
      if (typeof settings.direction == 'string') {
        if (['vertical'].indexOf(settings.direction) != -1) {
          handles.top = $('<div />').addClass('resizable-handle resizable-t').html('<div class="resizable-handle-wrapper"><div class="resizable-handle-filling"></div></div>').appendTo(element);
        } else if (['horizontal'].indexOf(settings.direction) != -1) {
          handles.right = $('<div />').addClass('resizable-handle resizable-r').html('<div class="resizable-handle-wrapper"><div class="resizable-handle-filling"></div></div>').appendTo(element);
        }
      }
      functions.setPosition(element, element[0].getBoundingClientRect().height, 0, 0, 0, true);
      element_height = element[0].getBoundingClientRect().height;
      $(document).bind('mouseup.resizable touchend.resizable', function(event) {
        resize = false;
        element_height = element[0].getBoundingClientRect().height;
        element.removeClass(settings.draggingClass);
        $(document).unbind('mousemove.resizable touchmove.resizable');
        if (current != null && typeof settings.onStop === 'function') {
          settings.onStop.call(this, current);
        }
        current = null;
      }.bind(this));
      $(this).children('.resizable-t, .resizable-r').bind('mousedown.resizable touchstart.resizable', function(event) {
        current = $(this).parent();
        var currentEvent = (event.pageY) ? event : (event.originalEvent.touches ? event.originalEvent.touches[0] : event);
        initial = {
          x: currentEvent.pageX,
          y: currentEvent.clientY,
        };
        resize = currentEvent.pageY || 0;
        element.addClass(settings.draggingClass);
        if (typeof element.attr('data-moved') == 'undefined') {
          element.attr('data-moved', true);
        }
        if (current != null && typeof settings.onStart === 'function') {
          settings.onStart.call(this, current);
        }
        $(document).bind('mousemove.resizable touchmove.resizable', function(event) {
          event.stopPropagation();
          var localPageY = event.pageY || (event.originalEvent.touches ? event.originalEvent.touches[0].pageY : 0);
          if (resize) {
            functions.setPosition(element, element_height, initial.y, resize, localPageY, false);
            if (current != null && typeof settings.onResize === 'function') {
              settings.onResize.call(this, current);
            }
          }
        }.bind(this));
      }.bind(this));
      if (typeof settings.onCreate === 'function') {
        settings.onCreate.call(this, $(this));
      }
    });
  }
})(jQuery, window, document);
jQuery.curCSS = function(element, prop, val) {
  return jQuery(element).css(prop, val);
};
jQuery.fn.bt = function(content, options) {
  if (typeof content != "string") {
    var contentSelect = true;
    options = content;
    content = false
  } else {
    var contentSelect = false
  }
  if (jQuery.fn.hoverIntent && jQuery.bt.defaults.trigger == "hover") {
    jQuery.bt.defaults.trigger = "hoverIntent"
  }
  return this.each(function(index) {
    var opts = jQuery.extend(false, jQuery.bt.defaults, options);
    opts.spikeLength = numb(opts.spikeLength);
    opts.spikeGirth = numb(opts.spikeGirth);
    opts.overlap = numb(opts.overlap);
    var ajaxTimeout = false;
    if (opts.killTitle) {
      $(this).find("[title]").andSelf().each(function() {
        if (!$(this).attr("bt-xTitle")) {
          $(this).attr("bt-xTitle", $(this).attr("title")).attr("title", "")
        }
      })
    }
    if (typeof opts.trigger == "string") {
      opts.trigger = [opts.trigger]
    }
    if (opts.trigger[0] == "hoverIntent") {
      var hoverOpts = $.extend(opts.hoverIntentOpts, {
        over: function() {
          this.btOn()
        },
        out: function() {
          this.btOff()
        }
      });
      $(this).hoverIntent(hoverOpts)
    } else {
      if (opts.trigger[0] == "hover") {
        $(this).hover(function() {
          this.btOn()
        }, function() {
          this.btOff()
        })
      } else {
        if (opts.trigger[0] == "now") {
          if ($(this).hasClass("bt-active")) {
            this.btOff()
          } else {
            this.btOn()
          }
        } else {
          if (opts.trigger[0] == "none") {} else {
            if (opts.trigger.length > 1 && opts.trigger[0] != opts.trigger[1]) {
              $(this).bind(opts.trigger[0], function() {
                this.btOn()
              }).bind(opts.trigger[1], function() {
                this.btOff()
              })
            } else {
              $(this).bind(opts.trigger[0], function() {
                if ($(this).hasClass("bt-active")) {
                  this.btOff()
                } else {
                  this.btOn()
                }
              })
            }
          }
        }
      }
    }
    this.btOn = function() {
      if (typeof $(this).data("bt-box") == "object") {
        this.btOff()
      }
      opts.preShow.apply(this);
      $(jQuery.bt.vars.closeWhenOpenStack).btOff();
      $(this).addClass("bt-active " + opts.activeClass);
      if (contentSelect && opts.ajaxPath == null) {
        if (opts.killTitle) {
          $(this).attr("title", $(this).attr("bt-xTitle"))
        }
        content = eval(opts.contentSelector);
        if (opts.killTitle) {
          $(this).attr("title", "")
        }
      }
      if (opts.ajaxPath != null && content == false) {
        if (typeof opts.ajaxPath == "object") {
          var url = eval(opts.ajaxPath[0]);
          url += opts.ajaxPath[1] ? " " + opts.ajaxPath[1] : ""
        } else {
          var url = opts.ajaxPath
        }
        var off = url.indexOf(" ");
        if (off >= 0) {
          var selector = url.slice(off, url.length);
          url = url.slice(0, off)
        }
        var cacheData = opts.ajaxCache ? $(document.body).data("btCache-" + url.replace(/\./g, "")) : null;
        if (typeof cacheData == "string") {
          content = selector ? jQuery("<div/>").append(cacheData.replace(/<script(.|\s)*?\/script>/g, "")).find(selector) : cacheData
        } else {
          var target = this;
          var ajaxOpts = jQuery.extend(false, {
            type: opts.ajaxType,
            data: opts.ajaxData,
            cache: opts.ajaxCache,
            url: url,
            complete: function(XMLHttpRequest, textStatus) {
              if (textStatus == "success" || textStatus == "notmodified") {
                if (opts.ajaxCache) {
                  $(document.body).data("btCache-" + url.replace(/\./g, ""), XMLHttpRequest.responseText)
                }
                ajaxTimeout = false;
                content = selector ? jQuery("<div/>").append(XMLHttpRequest.responseText.replace(/<script(.|\s)*?\/script>/g, "")).find(selector) : XMLHttpRequest.responseText
              } else {
                if (textStatus == "timeout") {
                  ajaxTimeout = true
                }
                content = opts.ajaxError.replace(/%error/g, XMLHttpRequest.statusText)
              }
              if ($(target).hasClass("bt-active")) {
                target.btOn()
              }
            }
          }, opts.ajaxData);
          $.ajax(ajaxOpts);
          content = opts.ajaxLoading
        }
      }
      var offsetParent = $(this).offsetParent();
      var pos = $(this).btPosition();
      var top = numb(pos.top) + numb($(this).css("margin-top"));
      var left = numb(pos.left) + numb($(this).css("margin-left"));
      var width = $(this).outerWidth();
      var height = $(this).outerHeight();
      if (typeof content == "object") {
        content = $(content).clone(true).show()
      }
      var $text = $('<div class="bt-content"></div>').append(content).css({
        padding: opts.padding,
        position: "absolute",
        width: opts.width,
        zIndex: opts.textzIndex
      }).css(opts.cssStyles);
      var $box = $('<div class="bt-wrapper"></div>').append($text).addClass(opts.cssClass).css({
        position: "absolute",
        width: opts.width,
        zIndex: opts.wrapperzIndex
      }).appendTo(offsetParent);
      if ($.fn.bgiframe) {
        $text.bgiframe();
        $box.bgiframe()
      }
      $(this).data("bt-box", $box);
      var scrollTop = numb($(document).scrollTop());
      var scrollLeft = numb($(document).scrollLeft());
      var docWidth = numb($(window).width());
      var docHeight = numb($(window).height());
      var winRight = scrollLeft + docWidth;
      var winBottom = scrollTop + docHeight;
      var space = new Object();
      space.top = $(this).offset().top - scrollTop;
      space.bottom = docHeight - (($(this).offset().top + height) - scrollTop);
      space.left = $(this).offset().left - scrollLeft;
      space.right = docWidth - (($(this).offset().left + width) - scrollLeft);
      var textOutHeight = numb($text.outerHeight());
      var textOutWidth = numb($text.outerWidth());
      if (opts.positions.constructor == String) {
        opts.positions = opts.positions.replace(/ /, "").split(",")
      }
      if (opts.positions[0] == "most") {
        var position = "top";
        for (var pig in space) {
          position = space[pig] > space[position] ? pig : position
        }
      } else {
        for (var x in opts.positions) {
          var position = opts.positions[x];
          if ((position == "left" || position == "right") && space[position] > textOutWidth + opts.spikeLength) {
            break
          } else {
            if ((position == "top" || position == "bottom") && space[position] > textOutHeight + opts.spikeLength) {
              break
            }
          }
        }
      }
      var horiz = left + ((width - textOutWidth) * 0.5);
      var vert = top + ((height - textOutHeight) * 0.5);
      var animDist = opts.animate ? numb(opts.distance) : 0;
      var points = new Array();
      var textTop, textLeft, textRight, textBottom, textTopSpace, textBottomSpace, textLeftSpace, textRightSpace, crossPoint, textCenter, spikePoint;
      switch (position) {
        case "top":
          $text.css("margin-bottom", opts.spikeLength + "px");
          $box.css({
            top: (top - $text.outerHeight(true) - animDist) + opts.overlap,
            left: horiz
          });
          textRightSpace = (winRight - opts.windowMargin) - ($text.offset().left + $text.outerWidth(true));
          var xShift = 0;
          if (textRightSpace < 0) {
            $box.css("left", (numb($box.css("left")) + textRightSpace) + "px");
            xShift -= textRightSpace
          }
          textLeftSpace = ($text.offset().left + numb($text.css("margin-left"))) - (scrollLeft + opts.windowMargin);
          if (textLeftSpace < 0) {
            $box.css("left", (numb($box.css("left")) - textLeftSpace) + "px");
            xShift += textLeftSpace
          }
          textTop = $text.btPosition().top + numb($text.css("margin-top"));
          textLeft = $text.btPosition().left + numb($text.css("margin-left"));
          textRight = textLeft + $text.outerWidth();
          textBottom = textTop + $text.outerHeight();
          textCenter = {
            x: textLeft + ($text.outerWidth() * opts.centerPointX),
            y: textTop + ($text.outerHeight() * opts.centerPointY)
          };
          points[points.length] = spikePoint = {
            y: textBottom + opts.spikeLength,
            x: ((textRight - textLeft) * 0.5) + xShift,
            type: "spike"
          };
          crossPoint = findIntersectX(spikePoint.x, spikePoint.y, textCenter.x, textCenter.y, textBottom);
          crossPoint.x = crossPoint.x < textLeft + opts.spikeGirth / 2 + opts.cornerRadius ? textLeft + opts.spikeGirth / 2 + opts.cornerRadius : crossPoint.x;
          crossPoint.x = crossPoint.x > (textRight - opts.spikeGirth / 2) - opts.cornerRadius ? (textRight - opts.spikeGirth / 2) - opts.CornerRadius : crossPoint.x;
          points[points.length] = {
            x: crossPoint.x - (opts.spikeGirth / 2),
            y: textBottom,
            type: "join"
          };
          points[points.length] = {
            x: textLeft,
            y: textBottom,
            type: "corner"
          };
          points[points.length] = {
            x: textLeft,
            y: textTop,
            type: "corner"
          };
          points[points.length] = {
            x: textRight,
            y: textTop,
            type: "corner"
          };
          points[points.length] = {
            x: textRight,
            y: textBottom,
            type: "corner"
          };
          points[points.length] = {
            x: crossPoint.x + (opts.spikeGirth / 2),
            y: textBottom,
            type: "join"
          };
          points[points.length] = spikePoint;
          break;
        case "left":
          $text.css("margin-right", opts.spikeLength + "px");
          $box.css({
            top: vert + "px",
            left: ((left - $text.outerWidth(true) - animDist) + opts.overlap) + "px"
          });
          textBottomSpace = (winBottom - opts.windowMargin) - ($text.offset().top + $text.outerHeight(true));
          var yShift = 0;
          if (textBottomSpace < 0) {
            $box.css("top", (numb($box.css("top")) + textBottomSpace) + "px");
            yShift -= textBottomSpace
          }
          textTopSpace = ($text.offset().top + numb($text.css("margin-top"))) - (scrollTop + opts.windowMargin);
          if (textTopSpace < 0) {
            $box.css("top", (numb($box.css("top")) - textTopSpace) + "px");
            yShift += textTopSpace
          }
          textTop = $text.btPosition().top + numb($text.css("margin-top"));
          textLeft = $text.btPosition().left + numb($text.css("margin-left"));
          textRight = textLeft + $text.outerWidth();
          textBottom = textTop + $text.outerHeight();
          textCenter = {
            x: textLeft + ($text.outerWidth() * opts.centerPointX),
            y: textTop + ($text.outerHeight() * opts.centerPointY)
          };
          points[points.length] = spikePoint = {
            x: textRight + opts.spikeLength,
            y: ((textBottom - textTop) * 0.5) + yShift,
            type: "spike"
          };
          crossPoint = findIntersectY(spikePoint.x, spikePoint.y, textCenter.x, textCenter.y, textRight);
          crossPoint.y = crossPoint.y < textTop + opts.spikeGirth / 2 + opts.cornerRadius ? textTop + opts.spikeGirth / 2 + opts.cornerRadius : crossPoint.y;
          crossPoint.y = crossPoint.y > (textBottom - opts.spikeGirth / 2) - opts.cornerRadius ? (textBottom - opts.spikeGirth / 2) - opts.cornerRadius : crossPoint.y;
          points[points.length] = {
            x: textRight,
            y: crossPoint.y + opts.spikeGirth / 2,
            type: "join"
          };
          points[points.length] = {
            x: textRight,
            y: textBottom,
            type: "corner"
          };
          points[points.length] = {
            x: textLeft,
            y: textBottom,
            type: "corner"
          };
          points[points.length] = {
            x: textLeft,
            y: textTop,
            type: "corner"
          };
          points[points.length] = {
            x: textRight,
            y: textTop,
            type: "corner"
          };
          points[points.length] = {
            x: textRight,
            y: crossPoint.y - opts.spikeGirth / 2,
            type: "join"
          };
          points[points.length] = spikePoint;
          break;
        case "bottom":
          $text.css("margin-top", opts.spikeLength + "px");
          $box.css({
            top: (top + height + animDist) - opts.overlap,
            left: horiz
          });
          textRightSpace = (winRight - opts.windowMargin) - ($text.offset().left + $text.outerWidth(true));
          var xShift = 0;
          if (textRightSpace < 0) {
            $box.css("left", (numb($box.css("left")) + textRightSpace) + "px");
            xShift -= textRightSpace
          }
          textLeftSpace = ($text.offset().left + numb($text.css("margin-left"))) - (scrollLeft + opts.windowMargin);
          if (textLeftSpace < 0) {
            $box.css("left", (numb($box.css("left")) - textLeftSpace) + "px");
            xShift += textLeftSpace
          }
          textTop = $text.btPosition().top + numb($text.css("margin-top"));
          textLeft = $text.btPosition().left + numb($text.css("margin-left"));
          textRight = textLeft + $text.outerWidth();
          textBottom = textTop + $text.outerHeight();
          textCenter = {
            x: textLeft + ($text.outerWidth() * opts.centerPointX),
            y: textTop + ($text.outerHeight() * opts.centerPointY)
          };
          points[points.length] = spikePoint = {
            x: ((textRight - textLeft) * 0.5) + xShift,
            y: 0,
            type: "spike"
          };
          crossPoint = findIntersectX(spikePoint.x, spikePoint.y, textCenter.x, textCenter.y, textTop);
          crossPoint.x = crossPoint.x < textLeft + opts.spikeGirth / 2 + opts.cornerRadius ? textLeft + opts.spikeGirth / 2 + opts.cornerRadius : crossPoint.x;
          crossPoint.x = crossPoint.x > (textRight - opts.spikeGirth / 2) - opts.cornerRadius ? (textRight - opts.spikeGirth / 2) - opts.cornerRadius : crossPoint.x;
          points[points.length] = {
            x: crossPoint.x + opts.spikeGirth / 2,
            y: textTop,
            type: "join"
          };
          points[points.length] = {
            x: textRight,
            y: textTop,
            type: "corner"
          };
          points[points.length] = {
            x: textRight,
            y: textBottom,
            type: "corner"
          };
          points[points.length] = {
            x: textLeft,
            y: textBottom,
            type: "corner"
          };
          points[points.length] = {
            x: textLeft,
            y: textTop,
            type: "corner"
          };
          points[points.length] = {
            x: crossPoint.x - (opts.spikeGirth / 2),
            y: textTop,
            type: "join"
          };
          points[points.length] = spikePoint;
          break;
        case "right":
          $text.css("margin-left", (opts.spikeLength + "px"));
          $box.css({
            top: vert + "px",
            left: ((left + width + animDist) - opts.overlap) + "px"
          });
          textBottomSpace = (winBottom - opts.windowMargin) - ($text.offset().top + $text.outerHeight(true));
          var yShift = 0;
          if (textBottomSpace < 0) {
            $box.css("top", (numb($box.css("top")) + textBottomSpace) + "px");
            yShift -= textBottomSpace
          }
          textTopSpace = ($text.offset().top + numb($text.css("margin-top"))) - (scrollTop + opts.windowMargin);
          if (textTopSpace < 0) {
            $box.css("top", (numb($box.css("top")) - textTopSpace) + "px");
            yShift += textTopSpace
          }
          textTop = $text.btPosition().top + numb($text.css("margin-top"));
          textLeft = $text.btPosition().left + numb($text.css("margin-left"));
          textRight = textLeft + $text.outerWidth();
          textBottom = textTop + $text.outerHeight();
          textCenter = {
            x: textLeft + ($text.outerWidth() * opts.centerPointX),
            y: textTop + ($text.outerHeight() * opts.centerPointY)
          };
          points[points.length] = spikePoint = {
            x: 0,
            y: ((textBottom - textTop) * 0.5) + yShift,
            type: "spike"
          };
          crossPoint = findIntersectY(spikePoint.x, spikePoint.y, textCenter.x, textCenter.y, textLeft);
          crossPoint.y = crossPoint.y < textTop + opts.spikeGirth / 2 + opts.cornerRadius ? textTop + opts.spikeGirth / 2 + opts.cornerRadius : crossPoint.y;
          crossPoint.y = crossPoint.y > (textBottom - opts.spikeGirth / 2) - opts.cornerRadius ? (textBottom - opts.spikeGirth / 2) - opts.cornerRadius : crossPoint.y;
          points[points.length] = {
            x: textLeft,
            y: crossPoint.y - opts.spikeGirth / 2,
            type: "join"
          };
          points[points.length] = {
            x: textLeft,
            y: textTop,
            type: "corner"
          };
          points[points.length] = {
            x: textRight,
            y: textTop,
            type: "corner"
          };
          points[points.length] = {
            x: textRight,
            y: textBottom,
            type: "corner"
          };
          points[points.length] = {
            x: textLeft,
            y: textBottom,
            type: "corner"
          };
          points[points.length] = {
            x: textLeft,
            y: crossPoint.y + opts.spikeGirth / 2,
            type: "join"
          };
          points[points.length] = spikePoint;
          break
      }
      var canvas = $('<canvas width="' + (numb($text.outerWidth(true)) + opts.strokeWidth * 2) + '" height="' + (numb($text.outerHeight(true)) + opts.strokeWidth * 2) + '"></canvas>').appendTo($box).css({
        position: "absolute",
        top: $text.btPosition().top,
        left: $text.btPosition().left,
        zIndex: opts.boxzIndex
      }).get(0);
      if (typeof G_vmlCanvasManager != "undefined") {
        canvas = G_vmlCanvasManager.initElement(canvas)
      }
      if (opts.cornerRadius > 0) {
        var newPoints = new Array();
        var newPoint;
        for (var i = 0; i < points.length; i++) {
          if (points[i].type == "corner") {
            newPoint = betweenPoint(points[i], points[(i - 1) % points.length], opts.cornerRadius);
            newPoint.type = "arcStart";
            newPoints[newPoints.length] = newPoint;
            newPoints[newPoints.length] = points[i];
            newPoint = betweenPoint(points[i], points[(i + 1) % points.length], opts.cornerRadius);
            newPoint.type = "arcEnd";
            newPoints[newPoints.length] = newPoint
          } else {
            newPoints[newPoints.length] = points[i]
          }
        }
        points = newPoints
      }
      var ctx = canvas.getContext("2d");
      drawIt.apply(ctx, [points], opts.strokeWidth);
      ctx.fillStyle = opts.fill;
      if (opts.shadow) {
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.shadowBlur = 5;
        ctx.shadowColor = opts.shadowColor
      }
      ctx.closePath();
      ctx.fill();
      if (opts.strokeWidth > 0) {
        ctx.shadowColor = "rgba(0, 0, 0, 0)";
        ctx.lineWidth = opts.strokeWidth;
        ctx.strokeStyle = opts.strokeStyle;
        ctx.beginPath();
        drawIt.apply(ctx, [points], opts.strokeWidth);
        ctx.closePath();
        ctx.stroke()
      }
      if (opts.animate) {
        $box.css({
          opacity: 0.1
        })
      }
      $box.css({
        visibility: "visible"
      });
      if (opts.overlay) {
        var overlay = $('<div class="bt-overlay"></div>').css({
          position: "absolute",
          backgroundColor: "blue",
          top: top,
          left: left,
          width: width,
          height: height,
          opacity: ".2"
        }).appendTo(offsetParent);
        $(this).data("overlay", overlay)
      }
      var animParams = {
        opacity: 1
      };
      if (opts.animate) {
        switch (position) {
          case "top":
            animParams.top = $box.btPosition().top + opts.distance;
            break;
          case "left":
            animParams.left = $box.btPosition().left + opts.distance;
            break;
          case "bottom":
            animParams.top = $box.btPosition().top - opts.distance;
            break;
          case "right":
            animParams.left = $box.btPosition().left - opts.distance;
            break
        }
        $box.animate(animParams, {
          duration: opts.speed,
          easing: opts.easing
        })
      }
      if ((opts.ajaxPath != null && opts.ajaxCache == false) || ajaxTimeout) {
        content = false
      }
      if (opts.clickAnywhereToClose) {
        jQuery.bt.vars.clickAnywhereStack.push(this);
        $(document).click(jQuery.bt.docClick)
      }
      if (opts.closeWhenOthersOpen) {
        jQuery.bt.vars.closeWhenOpenStack.push(this)
      }
      opts.postShow.apply(this)
    };
    this.btOff = function() {
      opts.preHide.apply(this);
      var box = $(this).data("bt-box");
      var overlay = $(this).data("bt-overlay");
      if (typeof box == "object") {
        $(box).remove();
        $(this).removeData("bt-box")
      }
      if (typeof overlay == "object") {
        $(overlay).remove();
        $(this).removeData("bt-overlay")
      }
      jQuery.bt.vars.clickAnywhereStack = arrayRemove(jQuery.bt.vars.clickAnywhereStack, this);
      jQuery.bt.vars.closeWhenOpenStack = arrayRemove(jQuery.bt.vars.closeWhenOpenStack, this);
      opts.postHide.apply(this);
      $(this).removeClass("bt-active " + opts.activeClass)
    };
    var refresh = this.btRefresh = function() {
      this.btOff();
      this.btOn()
    }
  });

  function drawIt(points, strokeWidth) {
    this.moveTo(points[0].x, points[0].y);
    for (i = 1; i < points.length; i++) {
      if (points[i - 1].type == "arcStart") {
        this.quadraticCurveTo(round5(points[i].x, strokeWidth), round5(points[i].y, strokeWidth), round5(points[(i + 1) % points.length].x, strokeWidth), round5(points[(i + 1) % points.length].y, strokeWidth));
        i++
      } else {
        this.lineTo(round5(points[i].x, strokeWidth), round5(points[i].y, strokeWidth))
      }
    }
  }

  function round5(num, strokeWidth) {
    var ret;
    strokeWidth = numb(strokeWidth);
    if (strokeWidth % 2) {
      ret = num
    } else {
      ret = Math.round(num - 0.5) + 0.5
    }
    return ret
  }

  function numb(num) {
    return parseInt(num) || 0
  }

  function arrayRemove(arr, elem) {
    var x, newArr = new Array();
    for (x in arr) {
      if (arr[x] != elem) {
        newArr.push(arr[x])
      }
    }
    return newArr
  }

  function betweenPoint(point1, point2, dist) {
    var y, x;
    if (point1.x == point2.x) {
      y = point1.y < point2.y ? point1.y + dist : point1.y - dist;
      return {
        x: point1.x,
        y: y
      }
    } else {
      if (point1.y == point2.y) {
        x = point1.x < point2.x ? point1.x + dist : point1.x - dist;
        return {
          x: x,
          y: point1.y
        }
      }
    }
  }

  function centerPoint(arcStart, corner, arcEnd) {
    var x = corner.x == arcStart.x ? arcEnd.x : arcStart.x;
    var y = corner.y == arcStart.y ? arcEnd.y : arcStart.y;
    var startAngle, endAngle;
    if (arcStart.x < arcEnd.x) {
      if (arcStart.y > arcEnd.y) {
        startAngle = (Math.PI / 180) * 180;
        endAngle = (Math.PI / 180) * 90
      } else {
        startAngle = (Math.PI / 180) * 90;
        endAngle = 0
      }
    } else {
      if (arcStart.y > arcEnd.y) {
        startAngle = (Math.PI / 180) * 270;
        endAngle = (Math.PI / 180) * 180
      } else {
        startAngle = 0;
        endAngle = (Math.PI / 180) * 270
      }
    }
    return {
      x: x,
      y: y,
      type: "center",
      startAngle: startAngle,
      endAngle: endAngle
    }
  }

  function findIntersect(r1x1, r1y1, r1x2, r1y2, r2x1, r2y1, r2x2, r2y2) {
    if (r2x1 == r2x2) {
      return findIntersectY(r1x1, r1y1, r1x2, r1y2, r2x1)
    }
    if (r2y1 == r2y2) {
      return findIntersectX(r1x1, r1y1, r1x2, r1y2, r2y1)
    }
    var r1m = (r1y1 - r1y2) / (r1x1 - r1x2);
    var r1b = r1y1 - (r1m * r1x1);
    var r2m = (r2y1 - r2y2) / (r2x1 - r2x2);
    var r2b = r2y1 - (r2m * r2x1);
    var x = (r2b - r1b) / (r1m - r2m);
    var y = r1m * x + r1b;
    return {
      x: x,
      y: y
    }
  }

  function findIntersectY(r1x1, r1y1, r1x2, r1y2, x) {
    if (r1y1 == r1y2) {
      return {
        x: x,
        y: r1y1
      }
    }
    var r1m = (r1y1 - r1y2) / (r1x1 - r1x2);
    var r1b = r1y1 - (r1m * r1x1);
    var y = r1m * x + r1b;
    return {
      x: x,
      y: y
    }
  }

  function findIntersectX(r1x1, r1y1, r1x2, r1y2, y) {
    if (r1x1 == r1x2) {
      return {
        x: r1x1,
        y: y
      }
    }
    var r1m = (r1y1 - r1y2) / (r1x1 - r1x2);
    var r1b = r1y1 - (r1m * r1x1);
    var x = (y - r1b) / r1m;
    return {
      x: x,
      y: y
    }
  }
};
jQuery.fn.btPosition = function() {
  function num(elem, prop) {
    return elem[0] && parseInt(jQuery.curCSS(elem[0], prop, true), 10) || 0
  }
  var left = 0,
    top = 0,
    results;
  if (this[0]) {
    var offsetParent = this.offsetParent(),
      offset = this.offset(),
      parentOffset = /^body|html$/i.test(offsetParent[0].tagName) ? {
        top: 0,
        left: 0
      } : offsetParent.offset();
    offset.top -= num(this, "marginTop");
    offset.left -= num(this, "marginLeft");
    parentOffset.top += num(offsetParent, "borderTopWidth");
    parentOffset.left += num(offsetParent, "borderLeftWidth");
    results = {
      top: offset.top - parentOffset.top,
      left: offset.left - parentOffset.left
    }
  }
  return results
};
jQuery.fn.btOn = function() {
  return this.each(function(index) {
    if ($.isFunction(this.btOn)) {
      this.btOn()
    }
  })
};
jQuery.fn.btOff = function() {
  return this.each(function(index) {
    if ($.isFunction(this.btOff)) {
      this.btOff()
    }
  })
};
jQuery.bt = {};
jQuery.bt.vars = {
  clickAnywhereStack: [],
  closeWhenOpenStack: []
};
jQuery.bt.docClick = function(e) {
  if (!e) {
    var e = window.event
  }
  if (!$(e.target).parents().andSelf().filter(".bt-wrapper, .bt-active").length) {
    $(jQuery.bt.vars.clickAnywhereStack).btOff();
    $(document).unbind("click", jQuery.bt.docClick)
  }
};
jQuery.bt.defaults = {
  trigger: "hover",
  clickAnywhereToClose: true,
  closeWhenOthersOpen: false,
  width: "200px",
  padding: "10px",
  spikeGirth: 10,
  spikeLength: 15,
  overlap: 0,
  overlay: false,
  killTitle: true,
  textzIndex: 9999,
  boxzIndex: 9998,
  wrapperzIndex: 9997,
  positions: ["most"],
  fill: "rgb(255, 255, 102)",
  windowMargin: 10,
  strokeWidth: 1,
  strokeStyle: "#000",
  cornerRadius: 5,
  centerPointX: 0.5,
  centerPointY: 0.5,
  shadow: false,
  shadowOffsetX: 2,
  shadowOffsetY: 2,
  shadowBlur: 3,
  shadowColor: "#000",
  animate: false,
  distance: 15,
  easing: "swing",
  speed: 200,
  cssClass: "",
  cssStyles: {},
  activeClass: "bt-active",
  contentSelector: "$(this).attr('title')",
  ajaxPath: null,
  ajaxError: "<strong>ERROR:</strong> <em>%error</em>",
  ajaxLoading: "<blink>Loading...</blink>",
  ajaxData: {},
  ajaxType: "GET",
  ajaxCache: true,
  ajaxOpts: {},
  preShow: function() {
    return
  },
  postShow: function() {
    return
  },
  preHide: function() {
    return
  },
  postHide: function() {
    return
  },
  hoverIntentOpts: {
    interval: 300,
    timeout: 500
  }
};
'use strict';

function GraphEditor(id, options) {
  this.defaults = {
    mode: 'editor',
    isPEPreview: false,
    elements: [],
    type: '',
    x_max: 10,
    x_min: 0,
    y_max: 10,
    y_min: 0,
    x_tick_distance: 1,
    y_tick_distance: 1,
    x_grid_distance: 1,
    y_grid_distance: 1,
    x_axis_label: false,
    y_axis_label: false,
    is_view: false,
    notBoard: false,
    elementMoveEvent: null,
    tool_point: false,
    tool_line: false,
    tool_segment: false,
    tool_ray: false,
    tool_vector: false,
    tool_circle: false,
    tool_polygon: false,
    tool_parabola: false,
    types: {
      'point': 811,
      'vector': 812,
      'line': 813,
      'circle': 814,
      'segment': 815,
      'polygon': 816,
      'ray': 817,
      'parabola': 818
    },
    buttonDisabledClass: 'graph-button-disabled',
    color: '#3498DB',
    strokeColor: '#3498DB',
    highlightStrokeColor: '#c3d9ff'
  };
  this.settings = $.extend({}, this.defaults, options);
  this.id = id;
  this.executer = new this.constructor.Executer();
  this.graph = new this.constructor.Graph();
  this.graph.setEditor(this);
  this.graph.render();
  this.select = new this.constructor.Select();
  this.select.setEditor(this);
  this.select.addListeners();
  this.buttonUndo = new this.constructor.Undo();
  this.buttonUndo.setEditor(this);
  this.buttonUndo.addListeners();
  this.buttonRedo = new this.constructor.Redo();
  this.buttonRedo.setEditor(this);
  this.buttonRedo.addListeners();
  this.buttonReset = new this.constructor.Reset();
  this.buttonReset.setEditor(this);
  this.buttonReset.addListeners();
  if (this.settings.elements.length > 0) {
    this.settings.elements.forEach(function(element) {
      this.constructor.AddElement(element.type, element.points, this.graph, this);
    }.bind(this));
  }
  this.createHtmlSelect();
  this.buttonUndo.isDisabled();
  this.buttonRedo.isDisabled();
  this.buttonReset.isDisabled();
}
GraphEditor.prototype.toggleOption = function(optionValue, show) {
  if (!this.settings.is_view) {
    if (show) {
      $('#' + this.id).find('.graph-buttons-left select > option[value="' + optionValue + '"]').show();
    } else {
      $('#' + this.id).find('.graph-buttons-left select > option[value="' + optionValue + '"]').hide();
    }
  } else {
    if (!show) {
      $('#' + this.id).find('.graph-buttons-left select > option[value="' + optionValue + '"]').remove();
    }
  }
};
GraphEditor.prototype.createHtmlSelect = function() {
  this.toggleOption('point', this.getSetting('tool_point'));
  this.toggleOption('line', this.getSetting('tool_line'));
  this.toggleOption('ray', this.getSetting('tool_ray'));
  this.toggleOption('segment', this.getSetting('tool_segment'));
  this.toggleOption('vector', this.getSetting('tool_vector'));
  this.toggleOption('circle', this.getSetting('tool_circle'));
  this.toggleOption('polygon', this.getSetting('tool_polygon'));
  this.toggleOption('parabola', this.getSetting('tool_parabola'));
  var visibleItems = $('#' + this.id).find(".graph-buttons-left select option").filter(function() {
    return $(this).css('display') != 'none';
  });
  var defaultSelectedValue = $(visibleItems[0]).val();
  if (typeof defaultSelectedValue != 'undefined' && defaultSelectedValue.length > 0) {
    $('#' + this.id).find('.graph-buttons-left select').val(defaultSelectedValue);
    this.select.element.trigger('change');
  } else {
    defaultSelectedValue = '';
    $('#' + this.id).find('.graph-buttons-left select').val(defaultSelectedValue);
    this.select.element.trigger('change');
  }
};
GraphEditor.prototype.getListOfTypes = function() {
  var ret = [];
  if (this.getSetting('tool_point', false)) {
    ret.push('point');
  }
  if (this.getSetting('tool_line', false)) {
    ret.push('line');
  }
  if (this.getSetting('tool_ray', false)) {
    ret.push('ray');
  }
  if (this.getSetting('tool_potool_segmentint', false)) {
    ret.push('segment');
  }
  if (this.getSetting('tool_vector', false)) {
    ret.push('vector');
  }
  if (this.getSetting('tool_circle', false)) {
    ret.push('circle');
  }
  if (this.getSetting('tool_polygon', false)) {
    ret.push('polygon');
  }
  if (this.getSetting('tool_parabola', false)) {
    ret.push('parabola');
  }
  return ret;
};
GraphEditor.prototype.getAnswer = function() {
  var elements = this.getGraph().getElements();
  var ret = [];
  var types = this.getSetting('types');
  elements.forEach(function(element) {
    ret.push({
      'type': types[Object.getPrototypeOf(element).type],
      'points': element.points
    });
  });
  return ret;
};
GraphEditor.prototype.getGraph = function() {
  return this.graph;
};
GraphEditor.prototype.getExecuter = function() {
  return this.executer;
};
GraphEditor.prototype.getEditorId = function() {
  return this.id;
};
GraphEditor.prototype.getSetting = function(setting, def) {
  return (this.settings[setting] !== undefined) ? this.settings[setting] : def;
};
GraphEditor.prototype.setSettings = function(settings) {
  for (var key in this.settings) {
    if (settings.hasOwnProperty(key)) {
      this.settings[key] = settings[key];
    }
  }
  this.getGraph().resetElements();
  this.getGraph().render();
  if (this.settings.elements.length > 0) {
    this.settings.elements.forEach(function(element) {
      this.constructor.AddElement(element.type, element.points, this.getGraph(), this);
    }.bind(this));
  }
  this.createHtmlSelect();
  return this;
};
GraphEditor.prototype.setSetting = function(setting, value) {
  this.settings[setting] = value;
  this.getGraph().render();
  return this;
};
GraphEditor.prototype.setSettingFlag = function(setting, value) {
  this.settings[setting] = value;
};
GraphEditor.prototype.refreshEditor = function() {
  this.getGraph().render();
  var resetSelect = (arguments.length > 0) ? arguments[0] : false;
  var resetCommands = (arguments.length > 1) ? arguments[1] : true;
  if (resetSelect) {
    this.createHtmlSelect();
  }
  this.select.element.trigger('change');
  if (resetCommands) {
    this.getExecuter().commandIndex = 0;
    this.getExecuter().commands = [];
  }
  return this;
};
GraphEditor.prototype.stringify = function() {
  var elements = [];
  this.getGraph().getElements().forEach(function(element) {
    elements.push({
      type: Object.getPrototypeOf(element).type,
      points: element.points
    });
  });
  return JSON.stringify(elements, null);
};
GraphEditor.prototype.arePointsCollinear = function(A, B, C) {
  return ((A.x * B.y * 1) + (1 * B.x * C.y) + (A.y * 1 * C.x) - (1 * B.y * C.x) - (A.y * B.x * 1) - (A.x * 1 * C.y)) == 0;
}
GraphEditor.prototype.recursivePolyClean = function(i, next, tmpPoints, points) {
  var toBeRemoved = (arguments.length > 4) ? arguments[4] : [];
  if (i <= tmpPoints.length - 1) {
    var last = next + 1;
    if (tmpPoints.length - 1 >= last) {
      if (this.arePointsCollinear(tmpPoints[next], tmpPoints[i], tmpPoints[last])) {
        toBeRemoved.push(next);
        this.recursivePolyClean(i, last, tmpPoints, points, toBeRemoved);
      } else {
        this.recursivePolyClean(next, last, tmpPoints, points, toBeRemoved);
      }
    } else if (tmpPoints.length - 1 >= next && tmpPoints.length - 1 <= last) {
      if (this.arePointsCollinear(tmpPoints[next], tmpPoints[i], tmpPoints[0])) {
        toBeRemoved.push(next);
      }
    }
  }
  return toBeRemoved;
};
GraphEditor.prototype.cleanPolygon = function(points) {
  var tmpPoints = points;
  var i = 0;
  var next = i + 1;
  var toBeRemoved = this.recursivePolyClean(i, next, tmpPoints, points);
  return points.filter(function(element, index) {
    return (toBeRemoved.indexOf(index) == -1) ? true : false;
  });
};
(function(editor) {
  const TYPE = {
    POINT: 'point',
    LINE: 'line',
    RAY: 'ray',
    SEGMENT: 'segment',
    VECTOR: 'vector',
    CIRCLE: 'circle',
    POLYGON: 'polygon',
    PARABOLA: 'parabola'
  };

  function Executer() {
    this.commands = [];
    this.commandIndex = 0;
  }
  Executer.prototype.dispatch = function(command) {
    if (this.commandIndex !== this.commands.length) {
      this.commands.splice(this.commandIndex, this.commands.length - this.commandIndex);
    }
    this.commands.push(command);
    this.commandIndex = this.commands.length;
    command.action();
    this.emit('dispatch');
  };
  Executer.prototype.undo = function() {
    if (this.commandIndex === 0 || this.commands.length === 0) {
      return null;
    }
    this.commands[this.commandIndex - 1].actionUndo();
    this.commandIndex = this.commandIndex - 1;
    this.emit('undo');
  };
  Executer.prototype.redo = function() {
    if (this.commandIndex === this.commands.length || this.commands.length === 0) {
      return null;
    }
    this.commands[this.commandIndex].action();
    this.commandIndex = this.commandIndex + 1;
    this.emit('redo');
  };
  Executer.prototype.redraw = function() {
    if (this.commands.length === 0) {
      return null;
    }
    this.commands.forEach(function(command) {
      command.action();
    });
    this.emit('redraw');
  };
  Executer.prototype.canUndo = function() {
    return this.commandIndex > 0;
  };
  Executer.prototype.canRedo = function() {
    return this.commandIndex < this.commands.length;
  };
  Executer.prototype.events = {};
  Executer.prototype.on = function(tag, callback) {
    if (!this.events[tag]) {
      this.events[tag] = [];
    }
    this.events[tag].push(callback);
  };
  Executer.prototype.emit = function(tag) {
    if (this.events[tag]) {
      this.events[tag].forEach(function(event) {
        event();
      });
    }
  };

  function Command(action) {
    this.action = action;
    this.actionUndo = (arguments.length > 1) ? arguments[1] : function() {};
  }

  function CommandAddElement(graph, element) {
    if (graph.editor.settings.isPEPreview) return;
    var currentElementIndex = graph.getElements().length;
    return new Command(function() {
      graph.createElement(element);
    }, function() {
      graph.removeElement(currentElementIndex);
    });
  }

  function CommandReset(graph) {
    var elements = graph.getElements();
    return new Command(function() {
      graph.resetElements();
    });
  }

  function CommandMoveElement(element, points) {
    var currentElementPoints = element.getPoints();
    return new Command(function() {
      element.setPoints(points);
    }, function() {
      element.setPoints(currentElementPoints);
    });
  }

  function CommandMovePoint(element, pointIndex, x, y) {
    var point = element.getPoints()[pointIndex];
    var currentElementPointX = point.x;
    var currentElementPointY = point.y;
    return new Command(function() {
      element.setPointCoords(pointIndex, x, y);
    }, function() {
      element.setPointCoords(pointIndex, currentElementPointX, currentElementPointY);
    });
  }

  function Element() {
    this.specificAttributes = {
      'vector': {
        'color': 'none',
        'strokeColor': 'none',
        'fillColor': 'none',
        'highlightstrokeColor': 'none',
        'highlightFillColor': 'none'
      }
    };
  }
  Element.prototype.numberOfPoints = 1;
  Element.prototype.points = [];
  Element.prototype.tempPoints = [];
  Element.prototype.setEditor = function(editor) {
    this.editor = editor;
  };
  Element.prototype.rendered = null;
  Element.prototype.renderedPoints = [];
  Element.prototype.clearRendered = function() {
    var board = this.editor.getGraph().getBoard();
    if (this.rendered !== null) {
      this.rendered.off('mouseup');
      this.rendered.remove();
      this.rendered = null;
      this.renderedPoints.forEach(function(renderedPoint) {
        board.removeObject(renderedPoint);
      });
      this.renderedPoints = [];
    }
  };
  Element.prototype.render = function() {};
  Element.prototype.createGraphPoints = function() {
    var _this = this;
    this.renderedPoints = [];
    this.points.forEach(function(point, pointIndex) {
      var pointAttributes = {
        name: '',
        size: 3,
        snapToGrid: true,
        color: this.editor.settings.color
      };
      if (_this.type == 'vector' && pointIndex == 1) {
        pointAttributes = $.extend(true, pointAttributes, _this.specificAttributes[_this.type]);
      }
      var point = this.editor.getGraph().getBoard().create('point', [point.x, point.y], pointAttributes);
      point.on('down', function(e) {
        _this.editor.setSettingFlag('notBoard', true);
      });
      point.on('up', function(e) {
        _this.editor.setSettingFlag('notBoard', false);
      });
      this.renderedPoints.push(point);
    }, this);
    return this.renderedPoints;
  };
  Element.prototype.setPointCoords = function(pointIndex, x, y) {
    this.points[pointIndex].x = x;
    this.points[pointIndex].y = y;
    this.render();
  };
  Element.prototype.setPoints = function(points) {
    this.points = points;
    this.render();
  };
  Element.prototype.getPoints = function(points) {
    return this.points;
  };
  Element.prototype.getTempPoints = function() {
    return this.tempPoints.length;
  };
  Element.prototype.selectPoints = function(callback) {
    var _this = this;
    var total = this.numberOfPoints;
    var points = [];
    var graph = this.editor.getGraph();
    var board = this.editor.getGraph().getBoard();
    var editor = this.editor;
    var getMouseCoords = function(e, i) {
      var cPos = board.getCoordsTopLeftCorner(e, i),
        absPos = JXG.getPosition(e, i),
        dx = absPos[0] - cPos[0],
        dy = absPos[1] - cPos[1];
      return new JXG.Coords(JXG.COORDS_BY_SCREEN, [dx, dy], board);
    };
    var endSelection = function() {
      board.off('down');
      if (_this.type == 'polygon') {
        points = editor.cleanPolygon(points);
      }
      callback(points);
      createdLines.forEach(function(createdLine) {
        createdLine.remove();
      });
      createdLines = [];
      _this.tempPoints.forEach(function(createdPoint) {
        createdPoint.remove();
      });
      _this.tempPoints = [];
    };
    _this.tempPoints = [];
    var createdLines = [];
    board.off('down');
    board.on('down', function(e) {
      var _this = this;
      var coords = getMouseCoords(e, e[JXG.touchProperty] ? 0 : null);
      if (this.type == 'polygon' && points.length > 0 && JXG.Math.Geometry.distance(coords.usrCoords, [1, points[0].x, points[0].y]) <= Math.min(JXG.Options.point.snapSizeX, JXG.Options.point.snapSizeY)) {
        this.tempPoints[0].trigger(['mousedown', 'down'], []);
        return false;
      }
      if (!editor.getSetting('notBoard')) {
        var pointColor = (points.length == 0) ? 'orange' : editor.settings.strokeColor;
        var point = board.create('point', [coords.usrCoords[1], coords.usrCoords[2]], {
          name: '',
          size: 3,
          snapToGrid: true,
          color: pointColor
        });
        if (points.length > 0) {
          point.on('down', function(e) {
            _this.editor.setSettingFlag('notBoard', true);
          }).on('up', function(e) {
            _this.editor.setSettingFlag('notBoard', false);
          });
          point.coords.on('update', function(ou, os) {
            var xCoord = Math.round(this.usrCoords[1]);
            var yCoord = Math.round(this.usrCoords[2]);
            if (JXG.Math.Geometry.distance(this.usrCoords, [1, points[0].x, points[0].y]) < Math.min(JXG.Options.point.snapSizeX, JXG.Options.point.snapSizeY)) {
              if (Math.abs(ou[1] - this.usrCoords[1]) > 0) {
                xCoord += Math.abs(ou[1] - this.usrCoords[1]);
              }
              if (Math.abs(ou[2] - this.usrCoords[2]) > 0) {
                yCoord += Math.abs(ou[2] - this.usrCoords[2]);
              }
            }
            this.usrCoords = [1, xCoord, yCoord];
            this.usr2screen();
          });
        }
        this.tempPoints.push(point);
        points.push({
          x: parseFloat(parseFloat(point.X()).toFixed(2)),
          y: parseFloat(parseFloat(point.Y()).toFixed(2))
        });
        if (this.type == 'polygon' && points.length > 1) {
          var tmp = editor.getGraph().getBoard().create('segment', [this.tempPoints[points.length - 2], this.tempPoints[points.length - 1]], {
            name: '',
            straightFirst: false,
            straightLast: false,
            strokeWidth: 2,
            strokeColor: this.editor.settings.strokeColor,
            highlightStrokeColor: this.editor.settings.highlightStrokeColor
          });
          tmp.on('down', function(e) {
            _this.editor.setSettingFlag('notBoard', true);
          }).on('up', function(e) {
            _this.editor.setSettingFlag('notBoard', false);
          });
          createdLines.push(tmp);
        }
        if (points.length > 0) {
          this.editor.buttonUndo.isDisabled(false);
          this.editor.buttonReset.isDisabled(false);
        }
        if (total === -1 && points.length === 1) {
          this.tempPoints[0].off('down').on('down', function(e) {
            editor.setSettingFlag('notBoard', true);
            _this.tempPoints[0].off('down').on('down', function(e) {
              editor.setSettingFlag('notBoard', true);
            });
            endSelection();
          });
          this.tempPoints[0].on('up', function(e) {
            editor.setSettingFlag('notBoard', false);
          });
        }
        if (total === points.length) {
          endSelection();
        }
      }
    }.bind(this));
    $(document).off('keyup.graphEditor').on('keyup.graphEditor', function(e) {
      if (e.keyCode === 27) {
        $("#" + this.editor.getEditorId() + "-select").val('');
        board.off('down');
        this.tempPoints.forEach(function(createdPoint) {
          createdPoint.remove();
        });
        this.tempPoints = [];
        $(document).off('keyup.graphEditor');
        graph.render();
      }
    }.bind(this));
    $("#" + this.editor.getEditorId() + "-select").off('click').on('click', function() {
      this.tempPoints.forEach(function(createdPoint) {
        createdPoint.remove();
      });
      this.tempPoints = [];
      $(document).off('keyup.graphEditor');
    }.bind(this));
  };
  Element.prototype.setOnMoveListener = function() {
    this.rendered.off('mouseup').on('mouseup', function() {
      var points = [];
      this.renderedPoints.forEach(function(renderedPoint) {
        points.push({
          x: parseFloat(parseFloat(renderedPoint.X()).toFixed(2)),
          y: parseFloat(parseFloat(renderedPoint.Y()).toFixed(2))
        });
      });
      this.editor.getExecuter().dispatch(CommandMoveElement(this, points));
      if (this.editor.settings.elementMoveEvent != null) {
        $(document).trigger(this.editor.settings.elementMoveEvent);
      }
    }.bind(this));
  };

  function Point() {}
  Point.prototype = new Element();
  Point.prototype.numberOfPoints = 1;
  Point.prototype.type = 'point';
  Point.prototype.setOnMoveListener = function() {
    this.rendered.off('mouseup').on('up', function(e) {
      this.editor.getExecuter().dispatch(CommandMovePoint(this, 0, this.rendered.X(), this.rendered.Y()));
    }.bind(this));
  };
  Point.prototype.render = function() {
    this.clearRendered();
    this.rendered = this.createGraphPoints()[0];
    this.setOnMoveListener();
  };

  function Line() {}
  Line.prototype = new Element();
  Line.prototype.numberOfPoints = 2;
  Line.prototype.type = 'line';
  Line.prototype.render = function() {
    this.clearRendered();
    this.rendered = this.editor.getGraph().getBoard().create('line', this.createGraphPoints(), {
      name: '',
      straightFirst: true,
      straightLast: true,
      strokeWidth: 2,
      strokeColor: this.editor.settings.strokeColor,
      highlightStrokeColor: this.editor.settings.highlightStrokeColor,
      firstArrow: {
        type: 1,
        size: 6
      },
      lastArrow: {
        type: 1,
        size: 6
      }
    });
    var _this = this;
    this.rendered.on('down', function(e) {
      _this.editor.setSettingFlag('notBoard', true);
    }).on('up', function(e) {
      _this.editor.setSettingFlag('notBoard', false);
    });
    this.setOnMoveListener();
  };

  function Ray() {}
  Ray.prototype = new Element();
  Ray.prototype.numberOfPoints = 2;
  Ray.prototype.type = 'ray';
  Ray.prototype.render = function() {
    this.clearRendered();
    this.rendered = this.editor.getGraph().getBoard().create('line', this.createGraphPoints(), {
      name: '',
      straightFirst: false,
      straightLast: true,
      strokeWidth: 2,
      strokeColor: this.editor.settings.strokeColor,
      highlightStrokeColor: this.editor.settings.highlightStrokeColor,
      lastArrow: {
        type: 1,
        size: 6
      }
    });
    var _this = this;
    this.rendered.on('down', function(e) {
      _this.editor.setSettingFlag('notBoard', true);
    }).on('up', function(e) {
      _this.editor.setSettingFlag('notBoard', false);
    });
    this.setOnMoveListener();
  };

  function Segment() {}
  Segment.prototype = new Element();
  Segment.prototype.numberOfPoints = 2;
  Segment.prototype.type = 'segment';
  Segment.prototype.render = function() {
    this.clearRendered();
    this.rendered = this.editor.getGraph().getBoard().create('line', this.createGraphPoints(), {
      name: '',
      straightFirst: false,
      straightLast: false,
      strokeWidth: 2,
      strokeColor: this.editor.settings.strokeColor,
      highlightStrokeColor: this.editor.settings.highlightStrokeColor
    });
    var _this = this;
    this.rendered.on('down', function(e) {
      _this.editor.setSettingFlag('notBoard', true);
    }).on('up', function(e) {
      _this.editor.setSettingFlag('notBoard', false);
    });
    this.setOnMoveListener();
  };

  function Vector() {}
  Vector.prototype = new Element();
  Vector.prototype.numberOfPoints = 2;
  Vector.prototype.type = 'vector';
  Vector.prototype.render = function() {
    this.clearRendered();
    var points = this.createGraphPoints();
    this.rendered = this.editor.getGraph().getBoard().create('segment', points, {
      name: '',
      strokeWidth: 2,
      strokeColor: this.editor.settings.strokeColor,
      highlightStrokeColor: this.editor.settings.highlightStrokeColor,
      lastArrow: {
        type: 1,
        size: 6
      }
    });
    var _this = this;
    this.rendered.on('down', function(e) {
      _this.editor.setSettingFlag('notBoard', true);
    }).on('up', function(e) {
      _this.editor.setSettingFlag('notBoard', false);
    });
    this.setOnMoveListener();
  };

  function Parabola() {}
  Parabola.prototype = new Element();
  Parabola.prototype.numberOfPoints = 2;
  Parabola.prototype.type = 'parabola';
  Parabola.prototype.render = function() {
    this.clearRendered();
    var points = this.createGraphPoints();
    var p1 = points[0];
    var p2 = points[1];
    this.rendered = this.editor.getGraph().getBoard().create('functiongraph', [function(x) {
      var p1x = p1.X();
      var p1y = p1.Y();
      var p2x = p2.X();
      var p2y = p2.Y();
      return (p2y - p1y) / Math.pow(p2x - p1x, 2) * (x - p1x) * (x - p1x) + p1y
    }], {
      name: '',
      fixed: true,
      strokeWidth: 2,
      strokeColor: this.editor.settings.strokeColor,
      highlightStrokeColor: this.editor.settings.strokeColor
    });
    var _this = this;
    this.rendered.on('down', function(e) {
      _this.editor.setSettingFlag('notBoard', true);
    }).on('up', function(e) {
      _this.editor.setSettingFlag('notBoard', false);
    });
    this.setOnMoveListener();
  };

  function Circle() {}
  Circle.prototype = new Element();
  Circle.prototype.numberOfPoints = 2;
  Circle.prototype.type = 'circle';
  Circle.prototype.render = function() {
    this.clearRendered();
    this.rendered = this.editor.getGraph().getBoard().create('circle', this.createGraphPoints(), {
      name: '',
      strokeWidth: 2,
      strokeColor: this.editor.settings.strokeColor,
      highlightStrokeColor: this.editor.settings.highlightStrokeColor
    });
    var _this = this;
    this.rendered.on('down', function(e) {
      _this.editor.setSettingFlag('notBoard', true);
    }).on('up', function(e) {
      _this.editor.setSettingFlag('notBoard', false);
    });
    this.setOnMoveListener();
  };

  function Polygon() {}
  Polygon.prototype = new Element();
  Polygon.prototype.numberOfPoints = -1;
  Polygon.prototype.type = 'polygon';
  Polygon.prototype.render = function() {
    this.clearRendered();
    this.rendered = this.editor.getGraph().getBoard().create('polygon', this.createGraphPoints(), {
      name: '',
      strokeWidth: 2,
      strokeColor: this.editor.settings.strokeColor,
      highlightStrokeColor: this.editor.settings.highlightStrokeColor
    });
    var _this = this;
    this.rendered.on('down', function(e) {
      _this.editor.setSettingFlag('notBoard', true);
    }).on('up', function(e) {
      _this.editor.setSettingFlag('notBoard', false);
    });
    this.setOnMoveListener();
  };
  var ElementFactory = function(elementName) {
    var element;
    switch (elementName) {
      case TYPE.LINE:
        element = new Line();
        break;
      case TYPE.PARABOLA:
        element = new Parabola();
        break;
      case TYPE.POINT:
        element = new Point();
        break;
      case TYPE.POLYGON:
        element = new Polygon();
        break;
      case TYPE.RAY:
        element = new Ray();
        break;
      case TYPE.SEGMENT:
        element = new Segment();
        break;
      case TYPE.VECTOR:
        element = new Vector();
        break;
      case TYPE.CIRCLE:
        element = new Circle();
        break;
      default:
        throw new Error('Element type is not supported.');
    }
    return element;
  };
  var currentElement = null;
  var CreateElement = function(type, graph, editor) {
    if (typeof type != 'undefined' && type && !editor.settings.isPEPreview) {
      currentElement = ElementFactory(type);
      currentElement.setEditor(editor);
      currentElement.selectPoints(function(points) {
        currentElement.points = points;
        editor.getExecuter().dispatch(CommandAddElement(graph, currentElement));
        if ($("#" + editor.getEditorId() + "-select").val() !== '') {
          CreateElement(type, graph, editor);
        }
      }.bind(this));
    }
  };
  var AddElement = function(type, points, graph, editor) {
    currentElement = ElementFactory(type);
    currentElement.setEditor(editor);
    currentElement.points = points;
    graph.createElement(currentElement);
  };

  function Graph() {
    this.elements = [];
  }
  Graph.prototype.board = null;
  Graph.prototype.elements = [];
  Graph.prototype.render = function() {
    if (this.board) {
      this.elements.forEach(function(element, i) {
        element.clearRendered();
      }, this);
      JXG.JSXGraph.freeBoard(this.board);
      delete this.board;
    }
    var xMax = (this.editor.getSetting('type') == 'firstQuadrant') ? parseFloat(this.editor.getSetting('x_max')) : parseInt(this.editor.getSetting('x_max'));
    var xMin = (this.editor.getSetting('type') == 'firstQuadrant') ? parseFloat(this.editor.getSetting('x_min')) : parseInt(this.editor.getSetting('x_min'));
    var yMax = (this.editor.getSetting('type') == 'firstQuadrant') ? parseFloat(this.editor.getSetting('y_max')) : parseInt(this.editor.getSetting('y_max'));
    var yMin = (this.editor.getSetting('type') == 'firstQuadrant') ? parseFloat(this.editor.getSetting('y_min')) : parseInt(this.editor.getSetting('y_min'));
    if (this.editor.getSetting('type') == 'coordinatePlane') {
      xMax += 0.9;
      xMin -= 0.9;
      yMax += 0.9;
      yMin -= 0.9;
    }
    var xAxisLabel = this.editor.getSetting('x_axis_label');
    var yAxisLabel = this.editor.getSetting('y_axis_label');
    JXG.Options.grid.gridX = this.editor.getSetting('x_grid_distance');
    JXG.Options.grid.gridY = this.editor.getSetting('y_grid_distance');
    JXG.Options.point.snapToGrid = true;
    JXG.Options.point.showInfobox = false;
    JXG.Options.point.snapSizeX = (this.editor.getSetting('x_tick_distance') > this.editor.getSetting('x_grid_distance')) ? this.editor.getSetting('x_grid_distance') : this.editor.getSetting('x_tick_distance');
    JXG.Options.point.snapSizeY = (this.editor.getSetting('y_tick_distance') > this.editor.getSetting('y_grid_distance')) ? this.editor.getSetting('y_grid_distance') : this.editor.getSetting('y_tick_distance');
    this.board = JXG.JSXGraph.initBoard(this.editor.getEditorId() + '-graph', {
      boundingBox: [xMin, yMax, xMax, yMin],
      grid: true,
      showNavigation: false,
      showCopyRight: false,
      keepAspectRatio: false,
      zoom: {
        factorX: 1.25,
        factorY: 1.25,
        wheel: false,
        needshift: true,
        eps: 0.1
      },
      pan: {
        enabled: false
      }
    });
    var type;
    var labelOffsetX;
    var labelOffsetY;
    var drawXZero = true;
    var xTicksLabelProp = {};
    var yTicksLabelProp = {};
    if (this.editor.getSetting('type') == 'firstQuadrant') {
      type = 'firstQuadrant';
      drawXZero = false;
      labelOffsetX = [0, -14];
      labelOffsetY = [-8, 0];
      xTicksLabelProp['anchorX'] = 'middle';
      xTicksLabelProp['offset'] = labelOffsetX;
      yTicksLabelProp['anchorX'] = 'right';
      yTicksLabelProp['offset'] = labelOffsetY;
    } else {
      type = 'coordinatePlane';
      labelOffsetX = [0, -12];
      labelOffsetY = [-8, 0];
      xTicksLabelProp['anchorX'] = 'middle';
      xTicksLabelProp['offset'] = labelOffsetX;
      xTicksLabelProp['anchorY'] = 'middle';
      yTicksLabelProp['offset'] = labelOffsetY;
      yTicksLabelProp['anchorX'] = 'right';
    }
    var xaxis = this.board.create('axis', [
      [0, 0],
      [1, 0]
    ], {
      firstArrow: {
        type: 1,
        size: 8
      },
      lastArrow: {
        type: 1,
        size: 8
      },
      withLabel: xAxisLabel ? true : false,
      name: xAxisLabel ? xAxisLabel : "",
      label: {
        position: 'rt',
        anchorX: 'right',
        anchorY: 'middle'
      }
    });
    xaxis.removeAllTicks();
    this.board.create('ticks', [xaxis, this.editor.getSetting('x_tick_distance')], {
      strokeColor: '#666666',
      majorHeight: 4,
      drawLabels: true,
      label: xTicksLabelProp,
      minorTicks: 0,
      drawZero: drawXZero,
      insertTicks: false,
      needsRegularUpdate: false,
    });
    var yaxis = this.board.create('axis', [
      [0, 0],
      [0, 1]
    ], {
      firstArrow: {
        type: 1,
        size: 8
      },
      lastArrow: {
        type: 1,
        size: 8
      },
      withLabel: yAxisLabel ? true : false,
      name: yAxisLabel ? yAxisLabel : "",
      label: {
        position: 'rt',
        offset: [10, 15],
        anchorX: 'left',
        anchorY: 'top'
      }
    });
    yaxis.removeAllTicks();
    this.board.create('ticks', [yaxis, this.editor.getSetting('y_tick_distance')], {
      strokeColor: '#666666',
      majorHeight: 4,
      drawLabels: true,
      label: yTicksLabelProp,
      minorTicks: 0,
      drawZero: false,
      insertTicks: false,
      needsRegularUpdate: false,
      maxLabelLength: 5,
      precision: 4
    });
    if (!drawXZero && this.board) {
      var zeroLabelX = (0 - 10) / this.board.unitX;
      var zeroLabelY = (0 - 13) / this.board.unitY;
      var zeroLabel = this.board.create("text", [zeroLabelX, zeroLabelY, '0'], {
        display: 'internal',
        parse: false,
        isLabel: true,
        layer: this.board.options.layer.line,
        strokeColor: this.board.options.ticks.strokeColor,
        strokeOpacity: this.board.options.ticks.strokeOpacity,
        strokeWidth: this.board.options.ticks.strokeWidth,
        highlightStrokeColor: this.board.options.ticks.highlightStrokeColor,
        anchorX: "middle",
        anchorY: "middle",
        needsRegularUpdate: false
      });
      zeroLabel.isDraggable = false;
    }
    this.elements.forEach(function(element, i) {
      element.render();
    }, this);
  };
  Graph.prototype.removeMissingTypes = function() {
    var types = this.editor.getListOfTypes();
    var resetSelect = (arguments.length > 1) ? arguments[1] : false;
    var tmpElements = [];
    if (types.length > 0) {
      this.elements.forEach(function(element, index) {
        if (types.indexOf(Object.getPrototypeOf(element).type) != -1) {
          tmpElements.push(element);
        } else {
          element.clearRendered();
        }
      });
    }
    this.elements = tmpElements;
  };
  Graph.prototype.resetElements = function() {
    var resetSelect = (arguments.length > 0) ? arguments[0] : false;
    this.elements.forEach(function(element) {
      element.clearRendered();
    });
    this.elements = [];
    this.editor.refreshEditor(resetSelect);
  };
  Graph.prototype.setElements = function(elements) {
    this.elements = elements;
    this.render();
  };
  Graph.prototype.getElement = function(elementIndex) {
    return this.elements[elementIndex];
  };
  Graph.prototype.getElements = function() {
    return this.elements;
  };
  Graph.prototype.createElement = function(element) {
    if (this.editor.settings.isPEPreview) return;
    this.elements.push(element);
    element.render();
  };
  Graph.prototype.removeElement = function(index) {
    this.elements[index].clearRendered();
    if (index > -1) {
      this.elements.splice(index, 1);
    }
  };
  Graph.prototype.getBoard = function() {
    return this.board;
  };
  Graph.prototype.setEditor = function(editor) {
    this.editor = editor;
  };

  function Button() {}
  Button.prototype.setEditor = function(editor) {
    this.editor = editor;
  };
  Button.prototype.addListeners = function() {
    this.element = $('#' + this.editor.getEditorId() + '-' + this.id);
    this.element.click(function() {
      this.click();
    }.bind(this));
    this.editor.getExecuter().on('dispatch', function() {
      this.isDisabled();
    }.bind(this));
    this.editor.getExecuter().on('undo', function() {
      this.isDisabled();
    }.bind(this));
    this.editor.getExecuter().on('redo', function() {
      this.isDisabled();
    }.bind(this));
  };
  Button.prototype.isDisabled = function() {};
  Button.prototype.getDisabledClass = function() {
    return (typeof this.editor.settings.buttonDisabledClass != 'undefined') ? this.editor.settings.buttonDisabledClass : 'graph-button-disabled';
  };
  Button.prototype.toggleButtonClass = function() {
    if (this.disabled) {
      this.element.addClass(this.getDisabledClass());
    } else {
      this.element.removeClass(this.getDisabledClass());
    }
  };

  function Undo() {
    this.disabled = true;
  }
  Undo.prototype = new Button();
  Undo.prototype.id = 'button-undo';
  Undo.prototype.click = function() {
    if (currentElement.getTempPoints() > 0) {
      this.editor.getGraph().elements.forEach(function(element) {
        element.clearRendered();
      });
      this.editor.refreshEditor(false, false);
      this.editor.getExecuter().redraw();
      currentElement.tempPoints = [];
    } else {
      this.editor.getExecuter().undo();
    }
  };
  Undo.prototype.isDisabled = function() {
    var forceValue = (arguments.length > 0) ? arguments[0] : null;
    if (forceValue !== null) {
      this.disabled = forceValue;
    } else {
      this.disabled = !this.editor.getExecuter().canUndo();
    }
    this.toggleButtonClass();
  };

  function Redo() {
    this.disabled = true;
  }
  Redo.prototype = new Button();
  Redo.prototype.id = 'button-redo';
  Redo.prototype.click = function() {
    this.editor.getExecuter().redo();
  };
  Redo.prototype.isDisabled = function() {
    this.disabled = !this.editor.getExecuter().canRedo();
    this.toggleButtonClass();
  };

  function Reset() {
    this.disabled = false;
  }
  Reset.prototype = new Button();
  Reset.prototype.id = 'button-reset';
  Reset.prototype.click = function() {
    this.editor.getExecuter().dispatch(CommandReset(this.editor.getGraph()));
  };
  Reset.prototype.isDisabled = function() {
    var forceValue = (arguments.length > 0) ? arguments[0] : null;
    if (forceValue !== null) {
      this.disabled = forceValue;
    } else {
      this.disabled = this.editor.getGraph().getElements().length === 0;
    }
    this.toggleButtonClass();
  };

  function Select() {}
  Select.prototype.id = 'select';
  Select.prototype.setEditor = function(editor) {
    this.editor = editor;
  };
  Select.prototype.addListeners = function() {
    this.element = $('#' + this.editor.getEditorId() + '-' + this.id);
    this.element.change(function() {
      if (this.element.val() !== '') {
        CreateElement(this.element.val(), this.editor.getGraph(), this.editor);
      }
    }.bind(this));
  };
  editor.Graph = Graph;
  editor.Executer = Executer;
  editor.Select = Select;
  editor.Undo = Undo;
  editor.Redo = Redo;
  editor.Reset = Reset;
  editor.AddElement = AddElement;
})(GraphEditor);
if (typeof module === "object" && module.exports) {
  module.exports = GraphEditor;
}
'use strict';

function LineChartEditor(id, options) {
  this.defaults = {
    isPEPreview: false,
    is_view: false,
    startAtZero: false,
    elements: [],
    labels: [],
    x_max: 10,
    x_min: 0,
    y_max: 10,
    y_min: 0,
    step: 1,
    maxVerticalLines: 10,
    numberOfPoints: 7,
    gridStep: 1,
    xTicks: [],
    elementMoveEvent: null,
    limits: [{
      left: 0,
      right: 0
    }, {
      left: 0,
      right: 0
    }, {
      left: -0.5392857142857143,
      right: 2.6392867142857144
    }, {
      left: -0.5264285714285714,
      right: 3.6264295714285717
    }, {
      left: -0.4535714285714285,
      right: 4.553572428571428
    }, {
      left: -0.4107142857142857,
      right: 5.510715285714285
    }, {
      left: -0.678571428571428,
      right: 6.487858142857143
    }, {
      left: -0.325,
      right: 7.425001
    }],
    highlightstrokeColor: '#3498DB',
    gridLineAttributes: {
      straightFirst: false,
      straightLast: false,
      color: '#cccccc',
      strokeColor: '#cccccc',
      fillColor: '#cccccc',
      highlightStrokeColor: '#cccccc',
      highlightFillColor: '#cccccc',
      strokeWidth: 1,
      highlightStrokeWidth: 1,
      highlight: false,
      needsRegularUpdate: false,
      scalable: false,
      withLabel: false,
      withTicks: false,
      fixed: true,
      point1: {
        needsRegularUpdate: false
      },
      point2: {
        needsRegularUpdate: false
      }
    },
    gridPointAttributes: {
      name: '',
      showInfobox: false,
      fixed: true,
      color: 'none',
      strokeColor: 'none',
      fillColor: 'none',
      highlightstrokeColor: 'none',
      highlightFillColor: 'none'
    },
    tickAttributes: {
      strokeColor: 'none',
      majorHeight: -1,
      drawLabels: false,
      minorTicks: 0,
      drawZero: false,
      insertTicks: false,
      includeBoundaries: true,
      needsRegularUpdate: false
    }
  };
  this.settings = $.extend({}, this.defaults, options);
  this.id = id;
  if ((this.settings['y_max'] - this.settings['y_min']) > 10 && (this.settings['y_max'] - this.settings['y_min']) < 51) {
    this.settings['step'] = 5;
  } else if ((this.settings['y_max'] - this.settings['y_min']) > 50) {
    this.settings['step'] = 10;
  }
  this.settings['y_min'] = this.roundToNearest(this.settings['y_min'], this.settings['step'], -1);
  this.settings['y_max'] = this.roundToNearest(this.settings['y_max'], this.settings['step'], 1);
  if (this.settings['step'] == 10) {
    this.settings['step'] = this.roundToNearest(((this.settings['y_max'] - this.settings['y_min']) / this.settings['step']), this.settings['step'], 1);
    this.settings['y_max'] = this.settings['y_max'] - this.settings['y_min'];
  }
  this.graph = new this.constructor.Graph();
  this.graph.setEditor(this);
  this.graph.render();
  if (this.settings.elements.length == 0) {
    var test = [];
    var points = [];
    if (this.settings.startAtZero) {
      for (var idx = 0; idx < this.settings.numberOfPoints; idx++) {
        points.push({
          x: idx,
          y: this.settings['y_min'],
          label: ''
        });
      }
    } else {
      for (var idx = 1; idx <= this.settings.numberOfPoints; idx++) {
        points.push({
          x: idx,
          y: this.settings['y_min'],
          label: ''
        });
      }
    }
    this.settings.elements.push({
      'type': 'cline',
      'points': points
    });
  }
  if (this.settings.elements.length > 0) {
    this.settings.elements.forEach(function(element) {
      this.constructor.AddElement(element.type, element.points, this.graph, this);
    }.bind(this));
  }
}
LineChartEditor.prototype.getGraph = function() {
  return this.graph;
};
LineChartEditor.prototype.getEditorId = function() {
  return this.id;
};
LineChartEditor.prototype.getSetting = function(setting, def) {
  return (this.settings[setting] !== undefined) ? this.settings[setting] : def;
};
LineChartEditor.prototype.getYMax = function() {
  var ret = this.settings['y_max'];
  if (this.settings['y_min'] > 0) {
    ret = (((this.settings['y_max'] - this.settings['y_min']) % this.settings['maxVerticalLines']) != 0) ? ((Math.floor((this.settings['y_max'] - this.settings['y_min']) / this.settings['maxVerticalLines']) + 1) * this.settings['maxVerticalLines']) : this.settings['y_max'];
  }
  return ret;
};
LineChartEditor.prototype.doLabelsFitLeft = function() {
  return ((this.settings['numberOfPoints'] < 6 && this.getYMax() < 10000) || (this.settings['numberOfPoints'] >= 6 && this.getYMax() < 100));
};
LineChartEditor.prototype.roundToNearest = function(number, divident, direction) {
  var i = number;
  while (i % divident != 0) {
    if (direction < 0) {
      i--;
    } else if (direction >= 0) {
      i++;
    }
  }
  return i;
};
LineChartEditor.prototype.setSettings = function(settings) {
  for (var key in this.settings) {
    if (settings.hasOwnProperty(key)) {
      this.settings[key] = settings[key];
    }
  }
  this.getGraph().render();
  return this;
};
LineChartEditor.prototype.setSetting = function(setting, value) {
  this.settings[setting] = value;
  this.getGraph().render();
  return this;
};
LineChartEditor.prototype.setSettingFlag = function(setting, value) {
  this.settings[setting] = value;
};
LineChartEditor.prototype.refreshEditor = function() {
  this.getGraph().render();
  return this;
};
LineChartEditor.prototype.stringify = function() {
  var elements = [];
  this.getGraph().getElements().forEach(function(element) {
    elements.push({
      type: element.type,
      points: element.points
    });
  });
  return JSON.stringify(elements, null);
};
LineChartEditor.prototype.getAnswer = function() {
  var elements = this.getGraph().getElements();
  var ret = [];
  elements.forEach(function(element) {
    element.points.forEach(function(point) {
      ret.push({
        x: point.x,
        y: point.y
      })
    });
  });
  return ret;
};
(function(editor) {
  var TYPE = {
    POINT: 'point',
    CLINE: 'cline'
  };

  function Element() {}
  Element.prototype.numberOfPoints = 1;
  Element.prototype.points = [];
  Element.prototype.setEditor = function(editor) {
    this.editor = editor;
  };
  Element.prototype.rendered = null;
  Element.prototype.renderedPoints = [];
  Element.prototype.clearRendered = function() {
    var board = this.editor.getGraph().getBoard();
    if (this.rendered !== null) {
      this.renderedPoints.forEach(function(renderedPoint) {
        board.removeObject(renderedPoint);
      });
      this.renderedPoints = [];
      this.rendered = null;
    }
  };
  Element.prototype.render = function() {};
  Element.prototype.createGraphPoints = function() {
    var _this = this;
    this.renderedPoints = [];
    var lastPoint = null;
    this.points.forEach(function(point, pointIndex) {
      var pointAttributes = {
        name: '',
        size: 3,
        snapToGrid: true,
        snapSizeY: this.editor.getSetting('gridStep'),
        color: this.editor.settings.highlightstrokeColor,
        showInfobox: true,
        fixed: (this.editor.settings.isPEPreview) ? true : false
      };
      var drawnPoint = this.editor.getGraph().getBoard().create('point', [point.x, point.y], pointAttributes);
      this.renderedPoints.push(drawnPoint);
      if (lastPoint != null) {
        this.editor.getGraph().getBoard().create('segment', [lastPoint, drawnPoint], {
          fixed: true,
          straightFirst: false,
          straightLast: false,
          strokeWidth: 2,
          strokeColor: this.editor.settings.highlightstrokeColor,
          highlightstrokeColor: this.editor.settings.highlightstrokeColor
        });
      }
      lastPoint = drawnPoint;
    }, this);
    return this.renderedPoints;
  };
  Element.prototype.setPoints = function(points) {
    this.points = points;
    this.render();
  };
  Element.prototype.getPoints = function(points) {
    return this.points;
  };
  Element.prototype.setOnMoveListener = function() {};

  function ContinuousLine(points) {
    this.numberOfPoints = points;
  }
  ContinuousLine.prototype = new Element();
  ContinuousLine.prototype.numberOfPoints = -1;
  ContinuousLine.prototype.type = 'cline';
  ContinuousLine.prototype.setOnMoveListener = function() {
    var globalPoints = this.points;
    var element = this.editor.getGraph().getElement(0);
    var board = this.editor.getGraph().getBoard();
    var settings = this.editor.settings;
    var editor = this.editor;
    settings['y_max'] = this.editor.getYMax();
    var elementPoints = element.getPoints();
    this.renderedPoints.forEach(function(point, index) {
      point.on('drag', function(e) {
        if (this.Y() >= settings['y_min'] && this.Y() <= settings['y_max']) {
          if (this.X() != globalPoints[index]['x']) {
            board.showInfobox(false);
          } else {
            board.showInfobox(true);
          }
          this.moveTo([globalPoints[index]['x'], this.Y()]);
          elementPoints[index] = {
            x: globalPoints[index]['x'],
            y: this.Y()
          };
        } else {
          board.showInfobox(false);
          this.moveTo([globalPoints[index]['x'], globalPoints[index]['y']]);
        }
        if (editor.settings.elementMoveEvent != null) {
          $(document).trigger(editor.settings.elementMoveEvent);
        }
      });
    });
    element.points = elementPoints;
  };
  ContinuousLine.prototype.render = function() {
    this.clearRendered();
    this.rendered = this.createGraphPoints();
    this.setOnMoveListener();
  };
  var ElementFactory = function(elementName, numberOfPoints) {
    var element;
    switch (elementName) {
      case TYPE.CLINE:
        element = new ContinuousLine(numberOfPoints);
        break;
      default:
        throw new Error('Element type is not supported.');
    }
    return element;
  };
  var AddElement = function(type, points, graph, editor) {
    var element = ElementFactory(type, editor.settings.numberOfPoints);
    element.setEditor(editor);
    element.points = points;
    graph.createElement(element);
  };

  function Graph() {
    this.elements = [];
  }
  Graph.prototype.board = null;
  Graph.prototype.elements = [];
  Graph.prototype.render = function() {
    if (this.board) {
      this.elements.forEach(function(element, i) {
        element.clearRendered();
      }, this);
      JXG.JSXGraph.freeBoard(this.board);
      delete this.board;
    }
    var stepy = (this.editor.getSetting('y_max') - this.editor.getSetting('y_min')) / this.editor.settings['maxVerticalLines'];
    var numberOfPoints = (this.editor.settings['startAtZero']) ? (this.editor.settings['numberOfPoints'] - 1) : this.editor.settings['numberOfPoints'];
    var margin = 0.6;
    var lrm = (margin + (0.05 + (((7 - this.editor.getSetting('x_max')) / 7) * margin))) / 2;
    var left = this.editor.settings['limits'][numberOfPoints]['left'];
    var top = this.editor.getSetting('y_max') + (stepy * margin);
    var right = this.editor.settings['limits'][numberOfPoints]['right'];
    var bottom = this.editor.getSetting('y_min') - (stepy * margin);
    JXG.Options.point.infoboxDigits = 1;
    this.board = JXG.JSXGraph.initBoard(this.editor.getEditorId() + '-graph', {
      boundingBox: [left, top, right, bottom],
      axis: false,
      grid: false,
      showNavigation: false,
      showCopyRight: false,
      keepAspectRatio: false,
      zoom: {
        factorX: 1,
        factorY: 1,
        wheel: false,
        needshift: true,
        pinchHorizontal: false,
        pinchVertical: false,
        eps: 0.1
      },
      pan: {
        enabled: false
      }
    });
    this.board.infobox.distanceX = -25;
    this.board.infobox.distanceY = 15;
    this.board.highlightInfobox = function(x, y, el) {
      this.infobox.setText('<span style="color:#000000; font-size: 11px;">' + y + '</span>');
      this.infobox.rendNode.style.border = 'solid #999999 1px';
      this.infobox.rendNode.style.padding = '0px 15px';
      this.infobox.rendNode.style.backgroundColor = 'white';
    };
    var yaxis = this.board.create('line', [
      [0, this.editor.getSetting('y_min')],
      [0, this.editor.getSetting('y_max')]
    ], this.editor.settings['gridLineAttributes']);
    yaxis.type = JXG.OBJECT_TYPE_AXIS;
    var labelsData = [];
    for (var i = this.editor.getSetting('y_min'); i <= this.editor.getSetting('y_max'); i += this.editor.getSetting('step')) {
      labelsData.push(i);
    }
    var xaxis = null;
    labelsData.forEach(function(step, index) {
      var p1 = this.board.create('point', [this.editor.settings['x_min'], step], this.editor.settings['gridPointAttributes']);
      var p2 = this.board.create('point', [this.editor.settings['x_max'], step], this.editor.settings['gridPointAttributes']);
      if (index != 0) {
        this.board.create('line', [p1, p2], this.editor.settings['gridLineAttributes']);
      } else {
        xaxis = this.board.create('line', [p1, p2], this.editor.settings['gridLineAttributes']);
      }
    }.bind(this));
    if (this.editor.settings['startAtZero']) {
      for (var idx = 0; idx < this.editor.settings.numberOfPoints; idx++) {
        var p1 = this.board.create('point', [idx, this.editor.getSetting('y_min')], this.editor.settings['gridPointAttributes']);
        var p2 = this.board.create('point', [idx, this.editor.getSetting('y_max')], this.editor.settings['gridPointAttributes']);
        this.board.create('line', [p1, p2], this.editor.settings['gridLineAttributes']);
      }
    } else {
      for (var idx = 1; idx <= this.editor.settings.numberOfPoints; idx++) {
        var p1 = this.board.create('point', [idx, this.editor.getSetting('y_min')], this.editor.settings['gridPointAttributes']);
        var p2 = this.board.create('point', [idx, this.editor.getSetting('y_max')], this.editor.settings['gridPointAttributes']);
        this.board.create('line', [p1, p2], this.editor.settings['gridLineAttributes']);
      }
    }
    var yAxisTicksProp = $.extend({}, this.editor.settings['tickAttributes']);
    yAxisTicksProp = $.extend(true, yAxisTicksProp, {
      labels: labelsData,
      drawLabels: true,
      drawZero: true
    });
    if (this.editor.doLabelsFitLeft()) {
      yAxisTicksProp = $.extend(true, yAxisTicksProp, {
        label: {
          anchorX: 'right',
          anchorY: 'middle',
          offset: [-3, -1]
        }
      });
    }
    this.board.create('ticks', [yaxis, labelsData], yAxisTicksProp);
    var xAxisTicksProp = $.extend({}, this.editor.settings['tickAttributes']);
    this.editor.settings.xTicks = this.board.create('ticks', [xaxis, 1], xAxisTicksProp);
    if ((this.editor.settings.is_view || this.editor.settings.isPEPreview)) {
      if (this.editor.settings['startAtZero']) {
        for (var idx = 0; idx < this.editor.settings.numberOfPoints; idx++) {
          this.board.create('text', [idx, -0.5, this.editor.settings.labels[idx]], {
            isLabel: true,
            fixed: true,
            anchorX: 'middle',
            anchorY: 'bottom',
            needsRegularUpdate: false
          });
        }
      } else {
        for (var idx = 0; idx <= this.editor.settings.numberOfPoints; idx++) {
          this.board.create('text', [idx, -0.5, this.editor.settings.labels[idx]], {
            isLabel: true,
            fixed: true,
            anchorX: 'middle',
            anchorY: 'bottom',
            needsRegularUpdate: false
          });
        }
      }
    }
    this.elements.forEach(function(element, i) {
      element.render();
    }, this);
  };
  Graph.prototype.resetElements = function() {
    this.elements.forEach(function(element) {
      element.clearRendered();
    });
    this.elements = [];
    this.editor.refreshEditor();
  };
  Graph.prototype.setElements = function(elements) {
    this.elements = elements;
    this.render();
  };
  Graph.prototype.getElement = function(elementIndex) {
    return this.elements[elementIndex];
  };
  Graph.prototype.getElements = function() {
    return this.elements;
  };
  Graph.prototype.createElement = function(element) {
    this.elements.push(element);
    element.render();
  };
  Graph.prototype.removeElement = function(index) {
    this.elements[index].clearRendered();
    if (index > -1) {
      this.elements.splice(index, 1);
    }
  };
  Graph.prototype.getBoard = function() {
    return this.board;
  };
  Graph.prototype.setEditor = function(editor) {
    this.editor = editor;
  };
  editor.Graph = Graph;
  editor.AddElement = AddElement;
})(LineChartEditor);
if (typeof module === "object" && module.exports) {
  module.exports = LineChartEditor;
}

function NumberLineEditor(selector) {
  this.selector = selector;
  this.parentElement = $(this.selector).parent();
  var defaultConfig = {
    selectorID: 'number-line-element',
    isPEPreview: false,
    elements: [],
    elementSelector: '.charts-element-tool .charts-element-type',
    elementSelectorDefault: 'point',
    min: 0,
    max: 10,
    majorTickDensity: 1,
    minorTicksDensity: 1,
    notBoard: false,
    vertical: false,
    isStacked: false,
    numberOfStacks: 1,
    elementsPerStack: 1,
    elementsNextStackNo: 1,
    majorTicksArr: [],
    majorTicksArrLabels: [],
    minorTicksArr: [],
    allTicksArr: [],
    tickMultiplier: 0,
    isPE: false,
    selectedFontSize: 14,
    stackHeight: 74,
    tickHeight: 16,
    tickSpacing: 30,
    labels: {
      show: true,
      show_min: true,
      show_max: true
    },
    line: {
      min: 0,
      max: 10,
      left_arrow: true,
      right_arrow: true
    },
    layout: {
      line_position: 0,
      height: 74,
      min_height: 1,
      min_width: 440,
      max_height: 460,
      number_line_margin: 5,
      spacing: 30,
      total_elements: 1,
      width: 440
    },
    ticks: {
      show: true
    },
    elementAddEvent: null
  };
  this.defaultColors = {
    base: "#3498DB",
    highlight: "#c3d9ff",
    hollow: "#ffffff",
    empty: "none"
  };
  this.defaults = {
    point: {
      snapToGrid: true,
      showInfobox: false,
      id: '',
      size: 3,
      strokeWidth: 3,
      name: "",
      strokeOpacity: true,
      fillOpacity: true,
      withLabel: true,
      highlight: false
    },
    line: {
      straightFirst: false,
      straightLast: false,
      name: "",
      needsRegularUpdate: false,
      strokeWidth: 2,
      scalable: false,
      withLabel: false,
      withTicks: false,
      fixed: true,
      point1: {
        needsRegularUpdate: false
      },
      point2: {
        needsRegularUpdate: false
      }
    },
    tick: {
      drawLabels: true,
      includeBoundaries: true,
      insertTicks: false,
      label: {
        strokeColor: "black",
        highlightStrokeColor: "black",
        cssClass: "nl_labeltext",
        highlightCssClass: "nl_labeltext"
      },
      minorTicks: 0,
      majorHeight: 10,
      needsRegularUpdate: false
    }
  };
  this.styles = {
    point: {
      color: this.defaultColors.base,
      strokeColor: this.defaultColors.base,
      fillColor: this.defaultColors.base,
      highlightstrokeColor: this.defaultColors.highlight,
      highlightFillColor: this.defaultColors.highlight
    },
    emptyPoint: {
      color: this.defaultColors.empty,
      strokeColor: this.defaultColors.empty,
      fillColor: this.defaultColors.empty,
      highlightstrokeColor: this.defaultColors.empty,
      highlightFillColor: this.defaultColors.empty
    },
    hollowPoint: {
      strokeColor: this.defaultColors.base,
      fillColor: this.defaultColors.hollow,
      highlightstrokeColor: this.defaultColors.highlight,
      highlightFillColor: this.defaultColors.hollow,
    },
    segment: {
      fillColor: this.defaultColors.base,
      strokeColor: this.defaultColors.base,
      highlightstrokeColor: this.defaultColors.base,
      highlightFillColor: this.defaultColors.base
    },
    leftRay: {
      scalable: false,
      withLabel: false,
      withTicks: false,
      fixed: true,
      fillColor: this.defaultColors.base,
      strokeColor: this.defaultColors.base,
      highlightstrokeColor: this.defaultColors.base,
      highlightFillColor: this.defaultColors.base,
      straightFirst: false,
      straightLast: false,
      firstArrow: {
        type: 1,
        size: 6
      },
      lastArrow: false
    },
    rightRay: {
      scalable: false,
      withLabel: false,
      withTicks: false,
      fixed: true,
      fillColor: this.defaultColors.base,
      strokeColor: this.defaultColors.base,
      highlightstrokeColor: this.defaultColors.base,
      highlightFillColor: this.defaultColors.base,
      straightFirst: false,
      straightLast: false,
      firstArrow: false,
      lastArrow: {
        type: 1,
        size: 6
      }
    }
  };
  var params = (arguments.length > 1) ? arguments[1] : {};
  this.settings = $.extend({}, defaultConfig, params);
  this.elementType = '';
  if (this.parentElement && this.isVertical()) {
    this.parentElement.addClass('vertical');
  }
  if (this.isStacked()) {
    this.settings.numberOfStacks++;
  }
  this.graph = new this.constructor.Graph();
  this.graph.setEditor(this);
  this.graph.render();
  this.select = new this.constructor.Select();
  this.select.setEditor(this);
  this.select.addListeners();
  this.select.setSelectedValue(-1);
  if (this.settings.elements.length > 0) {
    this.settings.elements.forEach(function(element) {
      this.constructor.AddElement(element.type, element.points, this.graph, this);
    }.bind(this));
  }
};
NumberLineEditor.prototype.constructor = NumberLineEditor;
NumberLineEditor.prototype.isVertical = function() {
  return this.settings.vertical;
};
NumberLineEditor.prototype.isStacked = function() {
  return this.settings.isStacked;
};
NumberLineEditor.prototype.getGraph = function() {
  return this.graph;
};
NumberLineEditor.prototype.getSetting = function(setting, def) {
  return (this.settings[setting] !== undefined) ? this.settings[setting] : def;
};
NumberLineEditor.prototype.setSettings = function(settings) {
  for (var key in this.settings) {
    if (settings.hasOwnProperty(key)) {
      this.settings[key] = settings[key];
    }
  }
  this.getGraph().render();
  return this;
};
NumberLineEditor.prototype.setSetting = function(setting, value) {
  this.settings[setting] = value;
  this.getGraph().render();
  return this;
};
NumberLineEditor.prototype.setSettingFlag = function(setting, value) {
  this.settings[setting] = value;
};
NumberLineEditor.prototype.stringify = function() {
  var elements = [];
  this.getGraph().getElements().forEach(function(element) {
    elements.push({
      type: element.type,
      points: element.points
    });
  });
  return JSON.stringify(elements, null);
};
NumberLineEditor.prototype.getAnswer = function() {
  var elements = [];
  this.getGraph().getElements().forEach(function(element) {
    elements.push({
      type: element.type,
      points: element.points
    });
  });
  return elements;
};
NumberLineEditor.prototype.refreshEditor = function() {
  this.getGraph().render();
  return this;
};
NumberLineEditor.prototype.pointOnSegment = function(point, segmentPoints) {
  firstX = (segmentPoints[0].x < segmentPoints[1].x) ? segmentPoints[0].x : segmentPoints[1].x;
  lastX = (segmentPoints[0].x < segmentPoints[1].x) ? segmentPoints[1].x : segmentPoints[0].x;
  firstY = (segmentPoints[0].y < segmentPoints[1].y) ? segmentPoints[0].y : segmentPoints[1].y;
  lastY = (segmentPoints[0].y < segmentPoints[1].y) ? segmentPoints[1].y : segmentPoints[0].y;
  if ((!this.isVertical() && firstX <= point.x && point.x <= lastX && point.y == firstY) || (this.isVertical() && firstY <= point.y && point.y <= lastY && point.x == firstX)) {
    return true;
  } else {
    return false;
  }
};
NumberLineEditor.prototype.onSegment = function(point1, point2, point3) {
  if (point2.x <= Math.max(point1.x, point3.x) && point2.x >= Math.min(point1.x, point3.x) && point2.y <= Math.max(point1.y, point3.y) && point2.y >= Math.min(point1.y, point3.y)) {
    return true;
  }
  return false;
};
NumberLineEditor.prototype.orientation = function(point1, point2, point3) {
  var val = (point2.y - point1.y) * (point3.x - point2.x) - (point2.x - point1.x) * (point3.y - point2.y);
  if (val == 0) {
    return 0;
  }
  return (val > 0) ? 1 : 2;
};
NumberLineEditor.prototype.segmentOnSegment = function(points, segmentPoints) {
  var o1 = this.orientation(points[0], points[1], segmentPoints[0]);
  var o2 = this.orientation(points[0], points[1], segmentPoints[1]);
  var o3 = this.orientation(segmentPoints[0], segmentPoints[1], points[0]);
  var o4 = this.orientation(segmentPoints[0], segmentPoints[1], points[1]);
  if (o1 != o2 && o3 != o4) {
    return true;
  }
  if (o1 == 0 && this.onSegment(points[0], segmentPoints[0], points[1])) {
    return true;
  } else if (o2 == 0 && this.onSegment(points[0], segmentPoints[1], points[1])) {
    return true;
  } else if (o3 == 0 && this.onSegment(segmentPoints[0], points[0], segmentPoints[1])) {
    return true;
  } else if (o4 == 0 && this.onSegment(segmentPoints[0], points[1], segmentPoints[1])) {
    return true;
  }
  return false;
};
NumberLineEditor.prototype.getRayDirection = function(type) {
  if (['first_arrow_line', 'first_arrow_empty'].indexOf(type) != -1) {
    if (this.isVertical()) {
      return 1;
    } else {
      return -1;
    }
  }
  if (['second_arrow_line', 'second_arrow_empty'].indexOf(type) != -1) {
    if (this.isVertical()) {
      return -1;
    } else {
      return 1;
    }
  }
};
NumberLineEditor.prototype.pointOnRay = function(point, rayPoints, elementType) {
  var dirVariable = (this.getRayDirection(elementType) > 0);
  return ((!this.isVertical() && ((dirVariable && rayPoints[0].x <= point.x) || (!dirVariable && rayPoints[0].x >= point.x)) && rayPoints[0].y == point.y) || (this.isVertical() && ((dirVariable && rayPoints[0].y <= point.y) || (!dirVariable && rayPoints[0].y >= point.y)) && rayPoints[0].x == point.x));
};
NumberLineEditor.prototype.segmentOnRay = function(points, rayPoints, elementType) {
  return this.pointOnRay(points[0], rayPoints, elementType) || this.pointOnRay(points[1], rayPoints, elementType);
};
NumberLineEditor.prototype.sortTicks = function(a, b) {
  return a - b;
};
NumberLineEditor.prototype.coordinatesOnTick = function(coordinates) {
  var found = false;
  var tmp = (this.settings.majorTickDensity / (this.settings.minorTicksDensity + 2)) * Math.pow(10, (this.settings.maxTickDecimals - 1));
  var coordinatesIndex = (!this.isVertical()) ? 0 : 1;
  for (var idx = 0; idx < this.settings.allTicksArr.length; idx++) {
    if ((this.settings.maxTickDecimals > 1 && (this.settings.allTicksArr[idx] == coordinates[coordinatesIndex] || ([0, 1].indexOf(Math.sign(this.settings.allTicksArr[idx])) != -1 && (tmp >= Math.abs(this.settings.allTicksArr[idx] - coordinates[coordinatesIndex]))) || (Math.sign(this.settings.allTicksArr[idx]) == -1 && (tmp >= Math.abs(this.settings.allTicksArr[idx] - coordinates[coordinatesIndex]))))) || (this.settings.maxTickDecimals <= 1 && this.settings.allTicksArr[idx] == coordinates[coordinatesIndex])) {
      found = this.settings.allTicksArr[idx];
      break;
    }
  }
  return found;
};
NumberLineEditor.prototype.isPositionEmpty = function(coordinates, elementType, currentElementPoints, pointIndex) {
  var ret = true;
  var elements = this.getGraph().elements.filter(function(element, elementIndex) {
    if (['point', 'first_arrow_line', 'second_arrow_line', 'first_arrow_empty', 'second_arrow_empty'].indexOf(element.type) == -1) {
      var ret = element.points[0].y == coordinates[1] && element.points[1].y == coordinates[1];
      if (this.isVertical()) {
        ret = element.points[0].x == coordinates[0] && element.points[1].x == coordinates[0];
      }
      if (typeof currentElementPoints != 'undefined' && (element.points.length == currentElementPoints.length && element.type == elementType && ((element.points[0].x == currentElementPoints[0].x && element.points[0].y == currentElementPoints[0].y) && (element.points[1].x == currentElementPoints[1].x && element.points[1].y == currentElementPoints[1].y)))) {
        ret = false;
      }
    } else {
      var ret = element.points[0].y == coordinates[1];
      if (this.isVertical()) {
        ret = element.points[0].x == coordinates[0];
      }
      if (typeof currentElementPoints != 'undefined' && (element.points.length == currentElementPoints.length && element.type == elementType && element.points[0].x == currentElementPoints[0].x && element.points[0].y == currentElementPoints[0].y)) {
        ret = false;
      }
    }
    return ret;
  }.bind(this));
  for (var idx = 0; idx < elements.length; idx++) {
    var element = elements[idx];
    if (element.type == 'point') {
      if (typeof currentElementPoints != 'undefined') {
        if (currentElementPoints.length == 1 && elementType == 'point') {
          if (element.points[0].x == coordinates[0] && element.points[0].y == coordinates[1]) {
            ret = false;
            break;
          }
        } else if (currentElementPoints.length == 1 && ['first_arrow_line', 'second_arrow_line', 'first_arrow_empty', 'second_arrow_empty'].indexOf(elementType) != -1) {
          if (this.pointOnRay(element.points[0], [{
              x: coordinates[0],
              y: coordinates[1]
            }], elementType)) {
            ret = false;
            break;
          }
        } else if (currentElementPoints.length == 2) {
          var newCurrentElementPoints = currentElementPoints;
          newCurrentElementPoints[pointIndex].x = coordinates[0];
          newCurrentElementPoints[pointIndex].y = coordinates[1];
          if (this.pointOnSegment(element.points[0], newCurrentElementPoints)) {
            ret = false;
            break;
          }
        }
      } else {
        if (element.points[0].x == coordinates[0] && element.points[0].y == coordinates[1]) {
          ret = false;
          break;
        }
      }
    } else if (['line', 'first_empty_line', 'second_empty_line', 'both_empty_line'].indexOf(element.type) != -1) {
      if (typeof currentElementPoints != 'undefined') {
        if (currentElementPoints.length == 1 && elementType == 'point') {
          if (this.pointOnSegment({
              x: coordinates[0],
              y: coordinates[1]
            }, element.points)) {
            ret = false;
            break;
          }
        } else if (currentElementPoints.length == 1 && ['first_arrow_line', 'second_arrow_line', 'first_arrow_empty', 'second_arrow_empty'].indexOf(elementType) != -1) {
          var newCurrentElementPoints = currentElementPoints;
          newCurrentElementPoints[pointIndex].x = coordinates[0];
          newCurrentElementPoints[pointIndex].y = coordinates[1];
          if (this.segmentOnRay(element.points, newCurrentElementPoints, elementType)) {
            ret = false;
            break;
          }
        } else if (currentElementPoints.length == 2) {
          var newCurrentElementPoints = currentElementPoints;
          newCurrentElementPoints[pointIndex].x = coordinates[0];
          newCurrentElementPoints[pointIndex].y = coordinates[1];
          if (this.segmentOnSegment(newCurrentElementPoints, element.points)) {
            ret = false;
            break;
          }
        }
      } else {
        if (this.pointOnSegment({
            x: coordinates[0],
            y: coordinates[1]
          }, element.points)) {
          ret = false;
          break;
        }
      }
    } else if (['first_arrow_line', 'second_arrow_line', 'first_arrow_empty', 'second_arrow_empty'].indexOf(element.type) != -1) {
      if (typeof currentElementPoints != 'undefined') {
        if (currentElementPoints.length == 1 && elementType == 'point') {
          if (this.pointOnRay({
              x: coordinates[0],
              y: coordinates[1]
            }, element.points, element.type)) {
            ret = false;
            break;
          }
        } else if (currentElementPoints.length == 1 && ['first_arrow_line', 'second_arrow_line', 'first_arrow_empty', 'second_arrow_empty'].indexOf(elementType) != -1) {
          if (this.pointOnRay(element.points[0], [{
              x: coordinates[0],
              y: coordinates[1]
            }], elementType)) {
            ret = false;
            break;
          }
        } else if (currentElementPoints.length == 2) {
          var newCurrentElementPoints = currentElementPoints;
          newCurrentElementPoints[pointIndex].x = coordinates[0];
          newCurrentElementPoints[pointIndex].y = coordinates[1];
          if (this.segmentOnRay(newCurrentElementPoints, element.points, element.type)) {
            ret = false;
            break;
          }
        }
      } else {
        if (elementType == 'point' && this.pointOnRay({
            x: coordinates[0],
            y: coordinates[1]
          }, element.points, element.type)) {
          ret = false;
          break;
        } else if (['first_arrow_line', 'second_arrow_line', 'first_arrow_empty', 'second_arrow_empty'].indexOf(elementType) != -1 && (this.pointOnRay({
            x: coordinates[0],
            y: coordinates[1]
          }, element.points, element.type) || this.pointOnRay(element.points[0], [{
            x: coordinates[0],
            y: coordinates[1]
          }], elementType))) {
          ret = false;
          break;
        }
      }
    }
  }
  if (ret) {
    var found = this.coordinatesOnTick(coordinates);
    if (found === false) {
      ret = false;
    }
  }
  return ret;
};
(function(editor) {
  var TYPE = {
    POINT: 'point',
    LINE: 'line',
    FIRST_EMPTY_LINE: 'first_empty_line',
    SECOND_EMPTY_LINE: 'second_empty_line',
    BOTH_EMPTY_LINE: 'both_empty_line',
    FIRST_ARROW_LINE: 'first_arrow_line',
    SECOND_ARROW_LINE: 'second_arrow_line',
    FIRST_ARROW_EMPTY: 'first_arrow_empty',
    SECOND_ARROW_EMPTY: 'second_arrow_empty'
  };

  function Element() {};
  Element.prototype.numberOfPoints = 1;
  Element.prototype.editor = null;
  Element.prototype.rendered = null;
  Element.prototype.points = [];
  Element.prototype.renderedPoints = [];
  Element.prototype.elementStyles = {};
  Element.prototype.setEditor = function(editor) {
    this.editor = editor;
  };
  Element.prototype.render = function() {};
  Element.prototype.setStyles = function() {};
  Element.prototype.createGraphPoints = function() {
    var _this = this;
    this.renderedPoints = [];
    this.points.forEach(function(pointCoords, pointIndex) {
      var pointAttributes = {
        name: '',
        size: 3,
        snapToGrid: true,
        showInfobox: false,
        snapSizeY: parseFloat(this.editor.settings.layout.spacing / (this.editor.settings.minorTicksDensity + 1)).toFixed(this.editor.settings.maxTickDecimals)
      };
      if (this.editor.isVertical()) {
        pointAttributes = $.extend(true, pointAttributes, {
          snapSizeY: 1,
          snapSizeX: parseFloat(this.editor.settings.layout.spacing / (this.editor.settings.minorTicksDensity + 1)).toFixed(this.editor.settings.maxTickDecimals)
        });
      }
      var pointKey = 'point';
      if (_this.numberOfPoints > 1) {
        pointKey = (pointIndex == 0) ? 'first_point' : 'second_point';
      }
      pointAttributes = $.extend(true, pointAttributes, _this.elementStyles[pointKey]);
      var point = this.editor.getGraph().getBoard().create('point', [pointCoords.x, pointCoords.y], pointAttributes);
      point.on('down', function(e) {
        _this.editor.setSettingFlag('notBoard', true);
      });
      point.on('up', function(e) {
        _this.editor.setSettingFlag('notBoard', false);
        _this.points[pointIndex].x = this.X();
        _this.points[pointIndex].y = this.Y();
      });
      point.coords.on('update', function(ou, os) {
        var xCoord = Math.round(this.usrCoords[1]);
        var yCoord = Math.round(this.usrCoords[2]);
        if (!_this.editor.isVertical()) {
          if (this.usrCoords[1] < _this.editor.settings.allTicksArr[0]) {
            xCoord = _this.editor.settings.allTicksArr[0];
          } else if (this.usrCoords[1] > _this.editor.settings.allTicksArr[_this.editor.settings.allTicksArr.length - 1]) {
            xCoord = _this.editor.settings.allTicksArr[_this.editor.settings.allTicksArr.length - 1];
          }
          for (var i = 0; i < _this.points.length; i++) {
            if (yCoord != _this.points[i].y) {
              yCoord = _this.points[i].y;
              break;
            }
          }
        } else {
          if (this.usrCoords[2] < _this.editor.settings.allTicksArr[0]) {
            yCoord = _this.editor.settings.allTicksArr[0];
          } else if (this.usrCoords[2] > _this.editor.settings.allTicksArr[_this.editor.settings.allTicksArr.length - 1]) {
            yCoord = _this.editor.settings.allTicksArr[_this.editor.settings.allTicksArr.length - 1];
          }
          for (var i = 0; i < _this.points.length; i++) {
            if (xCoord != _this.points[i].x) {
              xCoord = _this.points[i].x;
              break;
            }
          }
        }
        positionGood = _this.editor.isPositionEmpty([xCoord, yCoord], _this.type, _this.points, pointIndex);
        var tmp = _this.editor.coordinatesOnTick([xCoord, yCoord]);
        if (tmp !== false) {
          if (!_this.editor.isVertical()) {
            xCoord = tmp;
          } else {
            yCoord = tmp;
          }
        }
        if (_this.type == TYPE.POINT && !positionGood) {
          xCoord = ou[1];
          yCoord = ou[2];
        } else if (_this.type != TYPE.POINT) {
          var direction = (_this.editor.isVertical()) ? (_this.points[pointIndex].y - yCoord) : (_this.points[pointIndex].x - xCoord);
          var otherPointIndex = (pointIndex != 0) ? 0 : 1;
          if ([TYPE.LINE, TYPE.BOTH_EMPTY_LINE].indexOf(_this.type) != -1 && xCoord == _this.points[otherPointIndex].x && yCoord == _this.points[otherPointIndex].y) {
            if (!_this.editor.isVertical()) {
              xCoord = (direction > 0) ? _this.editor.getGraph().findNextTick(xCoord) : _this.editor.getGraph().findPrevTick(xCoord);
            } else {
              yCoord = (direction > 0) ? _this.editor.getGraph().findPrevTick(yCoord) : _this.editor.getGraph().findNextTick(yCoord);
            }
            newPositionGood = _this.editor.isPositionEmpty([xCoord, yCoord], _this.type, _this.points, pointIndex);
            if (!newPositionGood) {
              xCoord = ou[1];
              yCoord = ou[2];
            }
          } else if ([TYPE.FIRST_EMPTY_LINE, TYPE.SECOND_EMPTY_LINE].indexOf(_this.type) != -1) {
            if (!_this.editor.isVertical() && ((TYPE.FIRST_EMPTY_LINE == _this.type && ((pointIndex == 0 && xCoord >= _this.points[otherPointIndex].x && yCoord == _this.points[otherPointIndex].y) || (pointIndex == 1 && xCoord <= _this.points[otherPointIndex].x && yCoord == _this.points[otherPointIndex].y))) || (TYPE.SECOND_EMPTY_LINE == _this.type && ((pointIndex == 0 && xCoord >= _this.points[otherPointIndex].x && yCoord == _this.points[otherPointIndex].y) || (pointIndex == 1 && xCoord <= _this.points[otherPointIndex].x && yCoord == _this.points[otherPointIndex].y))))) {
              xCoord = ou[1];
            } else if (_this.editor.isVertical() && ((TYPE.FIRST_EMPTY_LINE == _this.type && ((pointIndex == 0 && xCoord == _this.points[otherPointIndex].x && yCoord <= _this.points[otherPointIndex].y) || (pointIndex == 1 && xCoord == _this.points[otherPointIndex].x && yCoord >= _this.points[otherPointIndex].y))) || (TYPE.SECOND_EMPTY_LINE == _this.type && ((pointIndex == 0 && xCoord == _this.points[otherPointIndex].x && yCoord <= _this.points[otherPointIndex].y) || (pointIndex == 1 && xCoord == _this.points[otherPointIndex].x && yCoord >= _this.points[otherPointIndex].y))))) {
              yCoord = ou[2];
            }
            newPositionGood = _this.editor.isPositionEmpty([xCoord, yCoord], _this.type, _this.points, pointIndex);
            if (!newPositionGood) {
              xCoord = ou[1];
              yCoord = ou[2];
            }
          } else if (!positionGood) {
            xCoord = ou[1];
            yCoord = ou[2];
          }
        }
        this.usrCoords = [1, xCoord, yCoord];
        this.usr2screen();
      });
      this.renderedPoints.push(point);
    }, this);
    return this.renderedPoints;
  };
  Element.prototype.clearRendered = function() {
    var board = this.editor.getGraph().getBoard();
    if (this.rendered !== null) {
      this.rendered.off('mouseup');
      this.rendered.remove();
      this.rendered = null;
      this.renderedPoints.forEach(function(renderedPoint) {
        board.removeObject(renderedPoint);
      });
      this.renderedPoints = [];
    }
  };

  function Point() {};
  Point.prototype = new Element();
  Point.prototype.numberOfPoints = 1;
  Point.prototype.type = TYPE.POINT;
  Point.prototype.setStyles = function() {
    this.elementStyles = {
      point: this.editor.styles['point']
    };
  };
  Point.prototype.render = function() {
    this.setStyles();
    this.clearRendered();
    this.rendered = this.createGraphPoints()[0];
  };

  function Line() {};
  Line.prototype = new Element();
  Line.prototype.numberOfPoints = 2;
  Line.prototype.type = TYPE.LINE;
  Line.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['point'],
      second_point: this.editor.styles['point'],
      segment: this.editor.styles['segment']
    };
  };
  Line.prototype.render = function() {
    this.setStyles();
    this.clearRendered();
    var segmentAttributes = $.extend(true, {
      fixed: true
    }, this.elementStyles['segment']);
    this.renderedPoints = this.createGraphPoints();
    this.rendered = this.editor.getGraph().getBoard().create('segment', this.renderedPoints, segmentAttributes);
    this.rendered.on('down', function(e) {
      this.editor.setSettingFlag('notBoard', true);
    }.bind(this)).on('up', function(e) {
      this.editor.setSettingFlag('notBoard', false);
    }.bind(this));
  };

  function FirstEmptyLine() {};
  FirstEmptyLine.prototype = new Line();
  FirstEmptyLine.prototype.type = 'first_empty_line';
  FirstEmptyLine.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['hollowPoint'],
      second_point: this.editor.styles['point'],
      segment: this.editor.styles['segment']
    };
  };

  function SecondEmptyLine() {};
  SecondEmptyLine.prototype = new Line();
  SecondEmptyLine.prototype.type = 'second_empty_line';
  SecondEmptyLine.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['point'],
      second_point: this.editor.styles['hollowPoint'],
      segment: this.editor.styles['segment']
    };
  };

  function BothEmptyLine() {};
  BothEmptyLine.prototype = new Line();
  BothEmptyLine.prototype.type = 'both_empty_line';
  BothEmptyLine.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['hollowPoint'],
      second_point: this.editor.styles['hollowPoint'],
      segment: this.editor.styles['segment']
    };
  };

  function RayFirst() {};
  RayFirst.prototype = new Element();
  RayFirst.prototype.numberOfPoints = 2;
  RayFirst.prototype.type = TYPE.LINE;
  RayFirst.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['point'],
      second_point: this.editor.styles['point'],
      ray: this.editor.styles['leftRay']
    };
  };
  RayFirst.prototype.render = function() {
    this.setStyles();
    this.clearRendered();
    var rayAttributes = $.extend(true, {
      fixed: true
    }, this.elementStyles['ray']);
    this.renderedPoints = this.createGraphPoints();
    this.rendered = this.editor.getGraph().getBoard().create('line', [function() {
      var direction = (this.editor.isVertical()) ? 1 : -1;
      return (this.editor.isVertical() ? [this.renderedPoints[0].X(), (direction > 0) ? this.editor.getGraph().lineLimits.max : this.editor.getGraph().lineLimits.min] : [(direction > 0) ? this.editor.getGraph().lineLimits.max : this.editor.getGraph().lineLimits.min, this.renderedPoints[0].Y()]);
    }.bind(this), this.renderedPoints[0]], rayAttributes);
    this.rendered.on('down', function(e) {
      this.editor.setSettingFlag('notBoard', true);
    }.bind(this)).on('up', function(e) {
      this.editor.setSettingFlag('notBoard', false);
    }.bind(this));
  };

  function RaySecond() {};
  RaySecond.prototype = new Element();
  RaySecond.prototype.numberOfPoints = 2;
  RaySecond.prototype.type = TYPE.LINE;
  RaySecond.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['point'],
      second_point: this.editor.styles['point'],
      ray: this.editor.styles['rightRay']
    };
  };
  RaySecond.prototype.render = function() {
    this.setStyles();
    this.clearRendered();
    var rayAttributes = $.extend(true, {
      fixed: true
    }, this.elementStyles['ray']);
    this.renderedPoints = this.createGraphPoints();
    this.rendered = this.editor.getGraph().getBoard().create('line', [this.renderedPoints[0], function() {
      var direction = (this.editor.isVertical()) ? -1 : 1;
      return (this.editor.isVertical() ? [this.renderedPoints[0].X(), (direction > 0) ? this.editor.getGraph().lineLimits.max : this.editor.getGraph().lineLimits.min] : [(direction > 0) ? this.editor.getGraph().lineLimits.max : this.editor.getGraph().lineLimits.min, this.renderedPoints[0].Y()]);
    }.bind(this)], rayAttributes);
    this.rendered.on('down', function(e) {
      this.editor.setSettingFlag('notBoard', true);
    }.bind(this)).on('up', function(e) {
      this.editor.setSettingFlag('notBoard', false);
    }.bind(this));
  };

  function FirstArrowLine() {};
  FirstArrowLine.prototype = new RayFirst();
  FirstArrowLine.prototype.type = 'first_arrow_line';
  FirstArrowLine.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['point'],
      second_point: this.editor.styles['emptyPoint'],
      ray: this.editor.styles['leftRay']
    };
  };

  function SecondArrowLine() {};
  SecondArrowLine.prototype = new RaySecond();
  SecondArrowLine.prototype.type = 'second_arrow_line';
  SecondArrowLine.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['point'],
      second_point: this.editor.styles['emptyPoint'],
      ray: this.editor.styles['rightRay']
    };
  };

  function FirstArrowEmpty() {};
  FirstArrowEmpty.prototype = new RayFirst();
  FirstArrowEmpty.prototype.type = 'first_arrow_empty';
  FirstArrowEmpty.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['hollowPoint'],
      second_point: this.editor.styles['emptyPoint'],
      ray: this.editor.styles['leftRay']
    };
  };

  function SecondArrowEmpty() {};
  SecondArrowEmpty.prototype = new RaySecond();
  SecondArrowEmpty.prototype.type = 'second_arrow_empty';
  SecondArrowEmpty.prototype.setStyles = function() {
    this.elementStyles = {
      first_point: this.editor.styles['hollowPoint'],
      second_point: this.editor.styles['emptyPoint'],
      ray: this.editor.styles['rightRay']
    };
  };
  var ElementFactory = function(elementName) {
    var element;
    switch (elementName) {
      case TYPE.POINT:
        element = new Point();
        break;
      case TYPE.LINE:
        element = new Line();
        break;
      case TYPE.FIRST_EMPTY_LINE:
        element = new FirstEmptyLine();
        break;
      case TYPE.SECOND_EMPTY_LINE:
        element = new SecondEmptyLine();
        break;
      case TYPE.BOTH_EMPTY_LINE:
        element = new BothEmptyLine();
        break;
      case TYPE.FIRST_ARROW_LINE:
        element = new FirstArrowLine();
        break;
      case TYPE.SECOND_ARROW_LINE:
        element = new SecondArrowLine();
        break;
      case TYPE.FIRST_ARROW_EMPTY:
        element = new FirstArrowEmpty();
        break;
      case TYPE.SECOND_ARROW_EMPTY:
        element = new SecondArrowEmpty();
        break;
      default:
        throw new Error('Element type is not supported.');
    }
    return element;
  };
  var AddElement = function(type, points, graph, editor) {
    if (type.length > 0) {
      var element = ElementFactory(type);
      element.setEditor(editor);
      element.points = points;
      graph.createElement(element);
    }
  };

  function Graph() {
    this.elements = [];
  };
  Graph.prototype.board = null;
  Graph.prototype.elements = [];
  Graph.prototype.resetElements = function() {
    this.elements.forEach(function(element) {
      element.clearRendered();
    });
    this.elements = [];
    this.editor.refreshEditor();
  };
  Graph.prototype.isFloat = function(n) {
    return Number(n) === n && n % 1 !== 0;
  };
  Graph.prototype.countDecimals = function(value) {
    if (Math.floor(value) === value) return 0;
    if (parseInt(value) == parseFloat(value)) return 0;
    return value.toString().split(".")[1].length || 0;
  };
  Graph.prototype.countAllCharacters = function(value) {
    return value.toString().length - (value.toString().indexOf('.') === -1 ? 0 : 1);
  };
  Graph.prototype.generateLabels = function() {
    var majorTicksArr = [],
      majorTicksArrLabels = [],
      minorTicksArr = [];
    var tickMultiplier = 1;
    var minValue = parseInt(this.editor.settings.min);
    var maxValue = parseInt(this.editor.settings.max);
    var majorTickDensity = parseInt(this.editor.settings.majorTickDensity);
    if (this.isFloat(this.editor.settings.min) || this.isFloat(this.editor.settings.max) || this.isFloat(this.editor.settings.majorTickDensity)) {
      minValue = parseFloat(this.editor.settings.min);
      maxValue = parseFloat(this.editor.settings.max);
      majorTickDensity = parseFloat(this.editor.settings.majorTickDensity);
      var decimalsArr = [this.countDecimals(minValue), this.countDecimals(maxValue), this.countDecimals(majorTickDensity)]
      var multiplierPower = decimalsArr.reduce(function(a, b) {
        return Math.max(a, b);
      });
      tickMultiplier = Math.pow(10, multiplierPower);
      minValue = parseInt(minValue * tickMultiplier);
      maxValue = parseInt(maxValue * tickMultiplier);
      majorTickDensity = parseInt(majorTickDensity * tickMultiplier);
    }
    var difference = parseInt(maxValue - minValue);
    var majorTicks = parseInt(difference / majorTickDensity) + 1;
    var minorTicks = parseInt(this.editor.settings.minorTicksDensity);
    var totalMinorTicks = (minorTicks != 0) ? parseInt(majorTicks * minorTicks) - 1 : 0;
    var majorTickID = minValue;
    var minorTicksCreated = 0;
    var minorTickTick = (minorTicks != 0) ? (majorTickDensity / (minorTicks + 1)) : 0;
    for (var i = minValue; i <= maxValue; i += majorTickDensity) {
      majorTicksArrLabels.push(majorTickID / tickMultiplier);
      majorTicksArr.push(Number(majorTickID));
      if (minorTicks && (i + majorTickDensity) <= maxValue) {
        var tickID = majorTickID;
        for (var x = 0; x < minorTicks; x++) {
          if (minorTicksCreated < totalMinorTicks) {
            tickID += parseFloat(parseFloat(majorTickDensity / (minorTicks + 1)).toFixed(3));
            minorTicksArr.push(Number(parseFloat(tickID).toFixed(3)));
            minorTicksCreated++;
          }
        }
      }
      majorTickID += majorTickDensity;
    }
    if (difference % majorTickDensity != 0) {
      majorTicksArrLabels.push(maxValue / tickMultiplier);
      majorTicksArr.push(Number(maxValue));
    }
    this.editor.settings.majorTicksArr = majorTicksArr;
    this.editor.settings.majorTicksArrLabels = majorTicksArrLabels;
    this.editor.settings.minorTicksArr = minorTicksArr;
    this.editor.settings.allTicksArr = this.editor.settings.majorTicksArr.concat(this.editor.settings.minorTicksArr);
    this.editor.settings.allTicksArr.sort(this.editor.sortTicks);
    this.editor.settings.maxTickDecimals = 0;
    for (var j = 0; j < this.editor.settings.allTicksArr.length; j++) {
      var currentDecimalCount = this.countDecimals(this.editor.settings.allTicksArr[j]);
      if (currentDecimalCount > this.editor.settings.maxTickDecimals) {
        this.editor.settings.maxTickDecimals = currentDecimalCount;
      }
    }
    this.editor.settings.tickMultiplier = Math.pow(10, ((this.editor.settings.maxTickDecimals) != 0 ? Math.min(this.editor.settings.maxTickDecimals, 2) : 0));
    this.editor.settings.allTicksArr = this.editor.settings.allTicksArr.map(function(element) {
      return Math.round(element * this.editor.settings.tickMultiplier);
    }.bind(this));
    this.editor.settings.majorTicksArr = this.editor.settings.majorTicksArr.map(function(element) {
      return Math.round(element * this.editor.settings.tickMultiplier);
    }.bind(this));
    this.editor.settings.minorTicksArr = this.editor.settings.minorTicksArr.map(function(element) {
      return Math.round(element * this.editor.settings.tickMultiplier);
    }.bind(this));
  };
  Graph.prototype.calculateLineLimits = function() {
    this.generateLabels();
    var template = {
      minArrowPadding: false,
      maxArrowPadding: false,
      arrowPadding: 0
    };
    template.min = this.editor.settings.allTicksArr[0];
    template.max = this.editor.settings.allTicksArr[this.editor.settings.allTicksArr.length - 1];
    template.arrowPadding = ((this.editor.isVertical()) ? 8 : 25) * (template.max - template.min);
    if (this.editor.isVertical()) {
      template.arrowPadding /= this.editor.settings.layout.height;
    } else {
      template.arrowPadding /= this.editor.settings.layout.width;
    }
    template.min = template.min - template.arrowPadding;
    template.minArrowPadding = true;
    template.max = template.max + template.arrowPadding;
    template.maxArrowPadding = true;
    this.lineLimits = template;
  };
  Graph.prototype.setupTicks = function() {
    if (this.editor.isVertical()) {
      this.editor.defaults.tick.label.anchorX = "right";
      this.editor.defaults.tick.label.anchorY = "middle";
    } else {
      this.editor.defaults.tick.label.anchorX = "middle";
      this.editor.defaults.tick.label.anchorY = "top";
    }
    if (this.editor.isStacked()) {
      this.editor.defaults.tickHeight = 10;
      if (this.editor.isVertical()) {
        this.editor.defaults.tick.label.offset = [-10, 0];
      } else {
        if (this.editor.settings.isPE) {
          this.editor.defaults.tick.label.offset = [0, -8];
        } else {
          this.editor.defaults.tick.label.offset = [0, -4];
        }
      }
    } else {
      this.editor.defaults.tickHeight = 16;
      if (this.editor.isVertical()) {
        this.editor.defaults.tick.label.offset = [-10, 0]
      } else {
        if (this.editor.settings.isPE) {
          this.editor.defaults.tick.label.offset = [0, -8];
        } else {
          this.editor.defaults.tick.label.offset = [0, -4];
        }
      }
    }
    this.editor.defaults.tick.majorHeight = this.editor.defaults.tickHeight;
  };
  Graph.prototype.createLine = function() {
    var _this = this;
    var points = [
      [this.lineLimits.min, 0],
      [this.lineLimits.max, 0]
    ];
    if (this.editor.isVertical()) {
      points = [
        [0, this.lineLimits.min],
        [0, this.lineLimits.max]
      ];
    }
    line = this.board.create('line', points, $.extend(true, {}, this.editor.defaults.line, {
      strokeColor: "#666666",
      highlightStrokeWidth: 2,
      highlightStrokeColor: "#666666",
      firstArrow: {
        type: 1,
        size: 6
      },
      lastArrow: {
        type: 1,
        size: 6
      }
    }));
    line.type = JXG.OBJECT_TYPE_AXIS;
    return line;
  };
  Graph.prototype.createTicks = function() {
    this.majorTicks = this.board.create('ticks', [this.line, this.editor.settings.majorTicksArr], $.extend(true, {}, this.editor.defaults.tick, {
      labels: this.editor.settings.majorTicksArrLabels,
      majorHeight: this.editor.settings.ticks.show ? this.editor.settings.tickHeight : 0,
      drawLabels: this.editor.settings.ticks.show && this.editor.settings.labels.show
    }));
    this.minorTicks = this.board.create('ticks', [this.line, this.editor.settings.minorTicksArr], $.extend(true, {}, this.editor.defaults.tick, {
      majorHeight: this.editor.settings.ticks.show ? this.editor.settings.tickHeight / 2 : 0,
      drawLabels: false
    }));
  };
  Graph.prototype.isNumber = function(x) {
    return typeof x == "number" || Object.prototype.toString.call(x) == "[Object Number]";
  };
  Graph.prototype.getBoardBoundingBox = function() {
    var ratio = (this.editor.settings.layout.number_line_margin * ((this.lineLimits.max - this.lineLimits.min) / 100));
    var left, top, right, bottom;
    if (this.editor.isVertical()) {
      left = -this.editor.settings.layout.spacing - ((Math.min(this.countAllCharacters(this.editor.settings.maxValue - this.editor.settings.minValue), 5) / 5) * this.editor.settings.layout.spacing);
      top = this.lineLimits.max + ratio;
      right = ((this.editor.settings.numberOfStacks * this.editor.settings.layout.spacing) + (!this.editor.isStacked() ? (this.editor.settings.layout.spacing + this.editor.settings.selectedFontSize) : this.editor.settings.selectedFontSize)) + ((Math.min(this.countAllCharacters(this.editor.settings.maxValue - this.editor.settings.minValue), 5) / 5) * this.editor.settings.layout.spacing);
      bottom = this.lineLimits.min - ratio;
    } else {
      left = this.lineLimits.min - ratio;
      top = (this.editor.settings.numberOfStacks * this.editor.settings.layout.spacing) + (!this.editor.isStacked() ? (this.editor.settings.layout.spacing + this.editor.settings.selectedFontSize) : this.editor.settings.selectedFontSize);
      right = this.lineLimits.max + ratio;
      bottom = -this.editor.settings.layout.spacing;
    }
    this.editor.settings.layout.heightInUnits = top - bottom;
    this.editor.settings.layout.widthInUnits = right - left;
    this.boardBoundingBox = [left, top, right, bottom];
  };
  Graph.prototype.areCoordsInPlane = function(xCoord, yCoord) {
    var ret = true;
    var stacks = (this.editor.isStacked()) ? this.editor.settings.numberOfStacks : 1;
    var firstStack = (this.editor.isStacked()) ? 1 : 0;
    var lower = ((firstStack * this.editor.settings.layout.spacing) - ((this.editor.isStacked()) ? 0 : Math.floor(this.editor.settings.layout.spacing / 2)));
    var higher = ((stacks * this.editor.settings.layout.spacing) - ((this.editor.isStacked()) ? 0 : Math.floor(this.editor.settings.layout.spacing / 2)));
    if ((!this.editor.isVertical() && (yCoord < lower || yCoord > higher)) || (this.editor.isVertical() && (xCoord < lower || xCoord > higher))) {
      ret = false;
    }
    if (ret && this.editor.isStacked()) {
      var elements = this.elements.filter(function(element, elementIndex) {
        var ret = element.points[0].y == yCoord;
        if (this.editor.isVertical()) {
          ret = element.points[0].x == xCoord;
        }
        return ret;
      }.bind(this));
      if (this.editor.settings.elementsPerStack != 0 && elements.length == this.editor.settings.elementsPerStack) {
        ret = false;
      }
    }
    return ret;
  };
  Graph.prototype.filterCoordsInPlane = function(xCoord, yCoord) {
    var newXCoord = xCoord,
      newYCoord = yCoord;
    if (!this.editor.isVertical()) {
      var stacks = (this.editor.isStacked()) ? this.editor.settings.numberOfStacks : 0;
      for (var i = ((this.editor.isStacked()) ? 1 : 0); i <= stacks; i++) {
        if (yCoord > ((i * this.editor.settings.layout.spacing) - Math.floor(this.editor.settings.layout.spacing / 2)) && yCoord < (((i + 1) * this.editor.settings.layout.spacing) - Math.floor(this.editor.settings.layout.spacing / 2))) {
          newYCoord = i * this.editor.settings.layout.spacing;
          break;
        }
      }
      if (xCoord < this.editor.settings.allTicksArr[0]) {
        newXCoord = this.editor.settings.allTicksArr[0];
      } else if (xCoord > this.editor.settings.allTicksArr[this.editor.settings.allTicksArr.length - 1]) {
        newXCoord = this.editor.settings.allTicksArr[this.editor.settings.allTicksArr.length - 1];
      }
    } else {
      var stacks = (this.editor.isStacked()) ? this.editor.settings.numberOfStacks : 0;
      for (var i = ((this.editor.isStacked()) ? 1 : 0); i <= stacks; i++) {
        if (xCoord > ((i * this.editor.settings.layout.spacing) - Math.floor(this.editor.settings.layout.spacing / 2)) && xCoord < (((i + 1) * this.editor.settings.layout.spacing) - Math.floor(this.editor.settings.layout.spacing / 2))) {
          newXCoord = i * this.editor.settings.layout.spacing;
          break;
        }
      }
      if (yCoord < this.editor.settings.allTicksArr[0]) {
        newYCoord = this.editor.settings.allTicksArr[0];
      } else if (yCoord > this.editor.settings.allTicksArr[this.editor.settings.allTicksArr.length - 1]) {
        newYCoord = this.editor.settings.allTicksArr[this.editor.settings.allTicksArr.length - 1];
      }
    }
    return {
      'xCoord': newXCoord,
      'yCoord': newYCoord
    };
  };
  Graph.prototype.getNextStackedCoords = function(coord) {
    var coord2 = this.editor.settings.elementsNextStackNo * this.editor.settings.layout.spacing;
    if (this.editor.settings.elementsNextStackNo <= this.editor.settings.numberOfStacks) {
      this.editor.settings.elementsNextStackNo++;
    } else {
      return false;
    }
    if (!this.editor.isVertical()) {
      return {
        'xCoord': coord,
        'yCoord': coord2
      }
    } else {
      return {
        'xCoord': coord2,
        'yCoord': coord
      }
    }
  };
  Graph.prototype.getClosestTick = function(coord) {
    var closest = Math.abs(this.editor.settings.allTicksArr[0] - coord);
    var closestValue = this.editor.settings.allTicksArr[0];
    for (var closestIdx = 0; closestIdx < this.editor.settings.allTicksArr.length; closestIdx++) {
      if (Math.abs(this.editor.settings.allTicksArr[closestIdx] - coord) < closest) {
        closest = Math.abs(this.editor.settings.allTicksArr[closestIdx] - coord);
        closestValue = this.editor.settings.allTicksArr[closestIdx];
      }
    }
    return closestValue;
  };
  Graph.prototype.findNextTick = function(coord) {
    var nextTickValue = coord;
    var closest = this.getClosestTick(coord);
    for (var closestIdx = 0; closestIdx < this.editor.settings.allTicksArr.length; closestIdx++) {
      if (this.editor.settings.allTicksArr[closestIdx] == closest && (closestIdx + 1) < this.editor.settings.allTicksArr.length) {
        nextTickValue = this.editor.settings.allTicksArr[(closestIdx + 1)];
        break;
      }
    }
    return nextTickValue;
  };
  Graph.prototype.findPrevTick = function(coord) {
    var nextTickValue = coord;
    var closest = this.getClosestTick(coord);
    for (var closestIdx = 0; closestIdx < this.editor.settings.allTicksArr.length; closestIdx++) {
      if (this.editor.settings.allTicksArr[closestIdx] == closest && (closestIdx - 1) >= 0) {
        nextTickValue = this.editor.settings.allTicksArr[(closestIdx - 1)];
        break;
      }
    }
    return nextTickValue;
  };
  Graph.prototype.render = function() {
    if (this.board) {
      this.elements.forEach(function(element, i) {
        element.clearRendered();
      }, this);
      JXG.JSXGraph.freeBoard(this.board);
    }
    this.calculateLineLimits();
    this.getBoardBoundingBox();
    if (this.editor.isVertical()) {
      this.editor.settings.height = this.editor.settings.layout.max_height;
      this.editor.settings.width = this.boardBoundingBox[2] - this.boardBoundingBox[0];
      $(this.editor.selector).width(this.editor.settings.width);
      $(this.editor.selector).height(this.editor.settings.height);
      this.editor.parentElement.height(this.editor.settings.height);
    } else {
      this.editor.settings.height = this.boardBoundingBox[1] - this.boardBoundingBox[3];
      $(this.editor.selector).height(this.editor.settings.height);
    }
    this.board = JXG.JSXGraph.initBoard(this.editor.settings.selectorID, {
      axis: false,
      grid: false,
      boundingbox: this.boardBoundingBox,
      showcopyright: false,
      shownavigation: false,
      keepaspectratio: false,
      pan: {
        enabled: false
      },
      zoom: false
    });
    this.board.on('down', function(e) {
      var getMouseCoords = function(e, i) {
        var cPos = this.board.getCoordsTopLeftCorner(e, i),
          absPos = JXG.getPosition(e, i),
          dx = absPos[0] - cPos[0],
          dy = absPos[1] - cPos[1];
        return new JXG.Coords(JXG.COORDS_BY_SCREEN, [dx, dy], this.board);
      }.bind(this);
      var coordinates = getMouseCoords(e, (e, e[JXG.touchProperty] ? 0 : null));
      var xCoord = Math.round(coordinates.usrCoords[1]);
      var yCoord = Math.round(coordinates.usrCoords[2]);
      if (!this.editor.settings.notBoard) {
        var points = [];
        var goFurther = true;
        if (this.editor.isStacked()) {
          if (!this.editor.isVertical()) {
            var filteredCoords = this.getNextStackedCoords(xCoord);
          } else {
            var filteredCoords = this.getNextStackedCoords(yCoord);
          }
          if (filteredCoords) {
            newXCoord = filteredCoords.xCoord;
            newYCoord = filteredCoords.yCoord;
            if (this.areCoordsInPlane(newXCoord, newYCoord)) {
              xCoord = newXCoord;
              yCoord = newYCoord;
            } else {
              goFurther = false;
            }
          } else {
            goFurther = false;
          }
        } else if (!this.areCoordsInPlane(xCoord, yCoord)) {
          goFurther = false;
        }
        if (!this.editor.isVertical()) {
          xCoord = this.getClosestTick(xCoord);
        } else {
          yCoord = this.getClosestTick(yCoord);
        }
        var filteredCoords = this.filterCoordsInPlane(xCoord, yCoord);
        xCoord = filteredCoords.xCoord;
        yCoord = filteredCoords.yCoord;
        if (goFurther && this.editor.isPositionEmpty([xCoord, yCoord], this.editor.elementType)) {
          if ([TYPE.POINT, TYPE.FIRST_ARROW_LINE, TYPE.SECOND_ARROW_LINE, TYPE.FIRST_ARROW_EMPTY, TYPE.SECOND_ARROW_EMPTY].indexOf(this.editor.elementType) == -1) {
            if (!this.editor.isVertical()) {
              var nextPointFilteredCoords = this.filterCoordsInPlane(this.findNextTick(xCoord), yCoord);
              var prevPointFilteredCoords = this.filterCoordsInPlane(this.findPrevTick(xCoord), yCoord);
              if (filteredCoords.xCoord != nextPointFilteredCoords.xCoord && this.editor.isPositionEmpty([nextPointFilteredCoords.xCoord, nextPointFilteredCoords.yCoord], this.editor.elementType)) {
                points.push({
                  x: xCoord,
                  y: yCoord
                });
                points.push({
                  x: nextPointFilteredCoords.xCoord,
                  y: nextPointFilteredCoords.yCoord
                });
              } else if (filteredCoords.xCoord != prevPointFilteredCoords.xCoord && this.editor.isPositionEmpty([prevPointFilteredCoords.xCoord, prevPointFilteredCoords.yCoord], this.editor.elementType)) {
                points.push({
                  x: prevPointFilteredCoords.xCoord,
                  y: prevPointFilteredCoords.yCoord
                });
                points.push({
                  x: xCoord,
                  y: yCoord
                });
              }
            } else if (this.editor.isVertical()) {
              var prevPointFilteredCoords = this.filterCoordsInPlane(xCoord, this.findPrevTick(yCoord));
              var nextPointFilteredCoords = this.filterCoordsInPlane(xCoord, this.findNextTick(yCoord));
              if (filteredCoords.yCoord != prevPointFilteredCoords.yCoord && this.editor.isPositionEmpty([prevPointFilteredCoords.xCoord, prevPointFilteredCoords.yCoord], this.editor.elementType)) {
                points.push({
                  x: xCoord,
                  y: yCoord
                });
                points.push({
                  x: prevPointFilteredCoords.xCoord,
                  y: prevPointFilteredCoords.yCoord
                });
              } else if (filteredCoords.yCoord != nextPointFilteredCoords.yCoord && this.editor.isPositionEmpty([nextPointFilteredCoords.xCoord, nextPointFilteredCoords.yCoord], this.editor.elementType)) {
                points.push({
                  x: nextPointFilteredCoords.xCoord,
                  y: nextPointFilteredCoords.yCoord
                });
                points.push({
                  x: xCoord,
                  y: yCoord
                });
              }
            }
          } else {
            points.push({
              x: xCoord,
              y: yCoord
            });
          }
        }
        if (points.length > 0 && !this.editor.settings.isPEPreview) {
          this.editor.constructor.AddElement(this.editor.elementType, points, this, this.editor);
          if (this.editor.settings.elementAddEvent != null) {
            $(document).trigger(this.editor.settings.elementAddEvent);
          }
        }
      }
    }.bind(this));
    this.setupTicks();
    this.line = this.createLine();
    this.createTicks();
    this.elements.forEach(function(element, i) {
      element.render();
    }, this);
  };
  Graph.prototype.setEditor = function(editor) {
    this.editor = editor;
  };
  Graph.prototype.createElement = function(element) {
    this.elements.push(element);
    element.render();
  };
  Graph.prototype.removeElement = function(index) {
    this.elements[index].clearRendered();
    if (index > -1) {
      this.elements.splice(index, 1);
    }
  };
  Graph.prototype.getBoard = function() {
    return this.board;
  };
  Graph.prototype.setEditor = function(editor) {
    this.editor = editor;
  };
  Graph.prototype.getElements = function() {
    return this.elements;
  };

  function Select() {}
  Select.prototype.setEditor = function(editor) {
    this.editor = editor;
  };
  Select.prototype.setSelectedValue = function(defaultValue) {
    if (!this.editor.settings.isPEPreview) {
      var currentDefaultValue = (defaultValue == -1) ? $(this.editor.settings.elementSelector + ':visible:eq(0)').attr('data-element-type') : defaultValue;
      if (currentDefaultValue != 'delete') {
        this.elements.removeClass('active');
        $(this.editor.settings.elementSelector + '[data-element-type="' + currentDefaultValue + '"]').addClass('active');
        this.editor.elementType = currentDefaultValue;
      }
    }
  };
  Select.prototype.addListeners = function() {
    if (!this.editor.settings.isPEPreview) {
      this.elements = $(this.editor.settings.elementSelector);
      if (typeof $.fn.dragdrop !== 'undefined') {
        var editor = this.editor;
        var didMove = false;
        $(this.elements).dragdrop({
          makeClone: true,
          appendDraggedTo: $('body'),
          parentClass: editor.settings.selectorID,
          dragClass: 'dragged',
          canDrop: function($dst) {
            return ($dst.hasClass(editor.settings.selectorID) || ($dst.parents('.' + editor.settings.selectorID).size()) > 0);
          },
          onMove: function(e, $src) {
            didMove = true;
          },
          didDrop: function($src, $dst, e) {
            if (didMove) {
              alert('Click on the number line to place your point, line segment, or line.');
            }
          },
          afterDrop: function($src, $dst, e) {
            if (!didMove) {
              var currentTarget = $src;
              if ($(currentTarget).attr('data-element-type') == 'delete') {
                editor.getGraph().resetElements();
                editor.settings.elementsNextStackNo = 1;
                currentTarget = $(editor.settings.elementSelector + ':visible:eq(0)');
              }
              if (currentTarget.length > 0) {
                $(editor.settings.elementSelector).removeClass('active');
                currentTarget.addClass('active');
                editor.elementType = currentTarget.attr('data-element-type');
              }
            }
            didMove = false;
          }
        });
      } else {
        this.elements.off('click').on('click', function(e) {
          var currentTarget = $(e.currentTarget);
          if ($(e.currentTarget).attr('data-element-type') == 'delete') {
            this.editor.getGraph().resetElements();
            this.editor.settings.elementsNextStackNo = 1;
            currentTarget = $(this.editor.settings.elementSelector + ':visible:eq(0)');
          }
          if (currentTarget.length > 0) {
            this.elements.removeClass('active');
            currentTarget.addClass('active');
            this.editor.elementType = currentTarget.attr('data-element-type');
          }
        }.bind(this));
      }
    }
  };
  editor.Graph = Graph;
  editor.Select = Select;
  editor.AddElement = AddElement;
})(NumberLineEditor);
if (typeof module === "object" && module.exports) {
  module.exports = NumberLineEditor;
}
'use strict';
var MathToolbarClass = function(options) {
  this.defaults = {
    containerClassName: 'mathformula_holder',
    alphabet: 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ∞°$π'.split(''),
    maxVariables: 100,
    testCycles: 5,
  };
  this.settings = $.extend({}, this.defaults, options);
  var toolbarTop;
  var toolbarLeft;
  var down = false;
  var selectionStartX;
  var selectionStartY;
  var prevMoveEvent = null;
  var selectionDirection = null;
  var cursorElemLeft;
  var cursorElemRight;
  var commandCounter = 0;
  var cursorAnimationId;
  var variablesUnique;
  this.buttonsHtml = "<div class='lrn_input_ui'>\
      <div class='keyboard_menu'>\
        <div id='mathformula_nav'>\
          <button type='button' class='math_nav_button active' id='basic_type' title='Basic'>Basic</button>\
          <button type='button' class='math_nav_button' id='algebra_type' title='Algebra'>x</button>\
          <button type='button' class='math_nav_button' id='comparison_type' title='Comparison'><</button>\
          <button type='button' class='math_nav_button' id='geometry_type' title='Geometry'>∠</button>\
        </div>\
        <div id='response_icon'>\
          <div>r</div>\
        </div>\
      </div>\
      <div id='editor_buttons'>\
        <div id='fixed_buttons'>\
          <button type='button' class='yellow_button' id='7_button'>7</button>\
          <button type='button' class='yellow_button' id='8_button'>8</button>\
          <button type='button' class='yellow_button' id='9_button'>9</button>\
          <button type='button' class='grey_button' id='div_button'>÷</button>\
          <button type='button' class='yellow_button' id='4_button'>4</button>\
          <button type='button' class='yellow_button' id='5_button'>5</button>\
          <button type='button' class='yellow_button' id='6_button'>6</button>\
          <button type='button' class='grey_button' id='or_button'>×</button>\
          <button type='button' class='yellow_button' id='1_button'>1</button>\
          <button type='button' class='yellow_button' id='2_button'>2</button>\
          <button type='button' class='yellow_button' id='3_button'>3</button>\
          <button type='button' class='grey_button' id='minus_button'>-</button>\
          <button type='button' class='yellow_button' id='0_button'>0</button>\
          <button type='button' class='simple_button' id='dot_button'>.</button>\
          <button type='button' class='simple_button' id='comma_button'>,</button>\
          <button type='button' class='grey_button' id='plus_button'>+</button>\
          <button type='button' class='blue_button' id='left_button'>&#9664;</button>\
          <button type='button' class='blue_button' id='right_button'>&#9654;</button>\
          <button type='button' class='blue_button' id='backspace_button'>&#9003;</button>\
          <button type='button' class='grey_button' id='equal_button'>=</button>\
        </div>\
        <div id='tab_buttons'>\
          <button type='button' class='blue_button basic_type algebra_type non_symbola_font' id='x_button' title='x'>x</button>\
          <button type='button' class='blue_button basic_type algebra_type non_symbola_font' id='y_button' title='y'>y</button>\
          <button type='button' class='blue_button basic_type algebra_type non_symbola_font' id='square' title='Square'>x<sup>2</sup></button>\
          <button type='button' class='blue_button basic_type algebra_type non_symbola_font' id='square_root' title='Square root'>\
            <span class='sqrt_prefix'>√</span>\
            <span class='sqrt_stem'>\
              <span class='sqrt_box'></span>\
            </span>\
          </button>\
          <button type='button' class='blue_button basic_type algebra_type non_symbola_font' id='fraction_prev' title='Fraction using previous expression as numerator'>\
            <span class='numerator1'>x</span>\
            <span class='denominator1'></span>\
          </button>\
          <button type='button' class='blue_button basic_type algebra_type non_symbola_font' id='fraction' title='Fraction'>\
            x\
            <span class='numerator_box_holder'>\
              <span class='numerator_box'></span>\
            </span>\
            <span class='denominator_box'></span>\
          </button>\
          <button type='button' class='blue_button basic_type algebra_type non_symbola_font' id='exponent' title='Exponent'>\
            x\
            <span class='square_box'></span>\
          </button>\
          <button type='button' class='blue_button algebra_type hidden' id='nth_root' title='Nth root'>\
            <span class='nth_root'></span>\
            <span class='sqrt_prefix'>√</span>\
            <span class='sqrt_stem'>\
              <span class='sqrt_box'></span>\
            </span>\
          </button>\
          <button type='button' class='blue_button basic_type algebra_type non_symbola_font' id='subscript' title='Subscript'>\
            x\
            <span class='index_box'></span>\
          </button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' title='Perpendicular to'>⊥</button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' title='Parallel to'>∥</button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' title='Not parallel to'>∦</button>\
          <button type='button' class='blue_button geometry_type hidden' id='vector' title='Vector'>\
            <span class='vector_box'></span>\
            <span class='vector_under'>~</span>\
          </button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' title='Angle'>∠</button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' title='Measure of angle'>m∠</button>\
          <button type='button' class='blue_button geometry_type binary-operator-button hidden' title='Similar to'>~</button>\
          <button type='button' class='blue_button geometry_type binary-operator-button hidden' title='Congruent to'>≅</button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' title='Triangle'>△</button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' title='Circle'>⊙</button>\
          <button type='button' class='blue_button comparison_type binary-operator-button hidden' title='Not equal to'>≠</button>\
          <button type='button' class='blue_button comparison_type binary-operator-button hidden' title='Approximately equal to'>≈</button>\
          <button type='button' class='blue_button basic_type algebra_type comparison_type binary-operator-button' id='less_than' title='Less than'><</button>\
          <button type='button' class='blue_button basic_type algebra_type comparison_type binary-operator-button' id='greater_than' title='Greater than'>></button>\
          <button type='button' class='blue_button comparison_type binary-operator-button hidden' title='Less than or equal to'>≤</button>\
          <button type='button' class='blue_button comparison_type binary-operator-button hidden' title='Greater than or equal to'>≥</button>\
          <button type='button' class='blue_button comparison_type negatecomparison hidden' title='Not greater than'>≯</button>\
          <button type='button' class='blue_button comparison_type negatecomparison hidden' title='Not less than'>≮</button>\
          <button type='button' class='blue_button basic_type algebra_type binary-operator-button' title='Plus or minus'>±</button>\
          <button type='button' class='blue_button basic_type simple_button' id='dollar_sign' title='Dollars'>$</button>\
          <button type='button' class='blue_button basic_type simple_button' id='percentage' title='Percentage'>%</button>\
          <button type='button' class='blue_button basic_type geometry_type simple_button' title='Degree symbol'>°</button>\
          <button type='button' class='blue_button basic_type simple_button' title='Ratio'>:</button>\
          <button type='button' class='blue_button basic_type algebra_type' id='parentheses' title='Group in parentheses'>\
            <span class='parentheses'>(</span><span class='single_dotted_box'></span><span class='parentheses'>)</span>\
          </button>\
          <button type='button' class='blue_button basic_type algebra_type' id='absolute_value' title='Absolute value'>\
            <span class='modulus_box_holder'><span class='modulus_box'></span></span>\
          </button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' id='arcminute' title='Prime/Arcminute'>′</button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' id='arcsecond' title='Double Prime/Arcsecond'>″</button>\
          <button type='button' class='blue_button basic_type algebra_type geometry_type non_symbola_font non_symbola_button' title='Pi'>π</button>\
          <button type='button' class='blue_button geometry_type hidden' id='overline' title='Line segment'>\
            <span class='line_segment_holder'>\
              <span class='line_segment'></span>\
            </span>\
          </button>\
          <button type='button' class='blue_button geometry_type hidden' id='overarrow' title='Ray'>\
            <span class='top_arrow'>➡</span>\
            <span class='line_segment_relative'></span>\
          </button>\
          <button type='button' class='blue_button geometry_type hidden' id='overleftright' title='Line'>\
            <span class='top_arrow_bold'>&#10231;</span>\
            <span class='line_segment_relative'></span>\
          </button>\
          <button type='button' class='blue_button geometry_type simple_button hidden' title='Square'>⬜</button>\
          <button type='button' class='blue_button basic_type symbola_font non_symbola_button' id='infinity' title='Infinity'>∞</button>\
          <button type='button' class='blue_button basic_type algebra_type binary-operator-button' id='dot_multiplier' title='Dot multiplier'>·</button>\
          <button type='button' class='blue_button algebra_type hidden' id='brackets' title='Group in brackets'>\
            <span class='parentheses'>[</span><span class='single_dotted_box'></span><span class='parentheses'>]</span>\
          </button>\
        </div>\
      </div>\
    </div>";
  this.toolbarHtml = "<div class='" + this.settings.containerClassName + " lrn_clearfix'>\
      <div class='lrn_response_wrapper'>\
        <div class='lrn_response'>\
          <div class='lrn_response_input_wrapper'>\
            <div class='lrn_response_input lrn_response_math lrn_response_font_boost'>\
              <span class='lrn_math_editable mq-editable-field mq-math-mode'>\
                <span class='mq-root-block mq-empty'></span>\
              </span>\
            </div>" +
    this.buttonsHtml + "</div>\
        </div>\
      </div>\
    </div>";
  this.dropSelection = function() {
    if (selectionDirection == 'left') {
      $('<span class="fake_blinking_cursor">&#8203;</span>').insertBefore($(".lrn_focused .mq-selection"));
    } else {
      $('<span class="fake_blinking_cursor">&#8203;</span>').insertAfter($(".lrn_focused .mq-selection"));
    }
    $(".lrn_focused .mq-selection").remove();
    selectionDirection = null;
  };
  this.createResponse = function() {
    var responseLeft = '<span class="response_left"><span>r</span></span>';
    var responseRight = '<span class="response_right">Response</span>';
    return '<span class="response_command" id="command-' + (++commandCounter) + '">' + responseLeft + responseRight + '<span style="clear:both"></span></span>';
  };
  this.insertBeforeCursor = function(formulaHtml) {
    if ($($(".lrn_focused .fake_blinking_cursor").prevAll().slice(0, 5).get().reverse()).text() == '\\sqrt') {
      $(".lrn_focused .fake_blinking_cursor").prevAll().slice(0, 5).remove();
      $("." + this.settings.containerClassName + " #square_root").trigger('click');
    }
    $(formulaHtml).insertBefore($(".lrn_focused .fake_blinking_cursor"));
    $(".lrn_focused .fake_blinking_cursor").parent().removeClass('mq-empty');
  };
  this.reScale = function() {
    $($('.lrn_focused .mq-sqrt-stem').get().reverse()).each(function() {
      var sqrtElem = $(this).parent();
      var currentPrefixHeight = sqrtElem.find('> .mq-sqrt-prefix').height();
      var requiredPrefixHeight = sqrtElem.find('> .mq-sqrt-stem').height();
      var topNthRoot;
      var scaleY = requiredPrefixHeight / currentPrefixHeight;
      var top;
      if (requiredPrefixHeight > 21) {
        topNthRoot = -5 + scaleY;
        var top = 0.2 + scaleY / 100;
      } else {
        topNthRoot = -3 + scaleY;
        var top = 0.1 + scaleY / 100;
      }
      sqrtElem.find('> .mq-sqrt-prefix').css('transform', 'scale(1, ' + scaleY + ')');
    });
    $('.lrn_focused .mq-paren').each(function() {
      var currentparenthesesHeight = $(this).height();
      var requiredparenthesesHeight = $(this).parent().children(':nth-child(2)').height();
      if (currentparenthesesHeight != requiredparenthesesHeight) {
        var scaleY = requiredparenthesesHeight / currentparenthesesHeight;
        $(this).css('transform', 'scale(1, ' + scaleY + ')');
      }
    });
  };
  this.createSimpleCommandBlock = function(command) {
    return '<span class="simple_command" id="command-' + (++commandCounter) + '">' + command + '</span>';
  };
  this.createScalarBlock = function(scalar) {
    return '<span id="command-' + (++commandCounter) + '" class="scalar_value">' + scalar + '</span>';
  };
  this.createBinaryOperatorBlock = function(operator) {
    return '<span id="command-' + (++commandCounter) + '" class="mq-binary-operator">' + operator + '</span>';
  };
  this.moveCursor = function(elem, func) {
    var cursorElem = $(".lrn_focused .fake_blinking_cursor");
    if (cursorElem.length) {
      if (cursorElem.parent().children().length == 1 && (cursorElem.parent().hasClass('mq-empty-box') || cursorElem.parent().prev().hasClass('mq-paren') || cursorElem.parent().hasClass('mq-font') || cursorElem.parent().hasClass('mq-root-block'))) {
        cursorElem.parent().addClass('mq-empty');
      }
      cursorElem.remove();
    }
    cursorElem = $('<span class="fake_blinking_cursor">&#8203;</span>');
    $("." + this.settings.containerClassName + " mq-hasCursor").removeClass(".mq-hasCursor");
    switch (func) {
      case 'prepend':
        elem.prepend(cursorElem);
        cursorElem.parent().removeClass('mq-empty').addClass('mq-hasCursor');
        cursorElem.closest('.lrn_bordered_mathinput').addClass('lrn_focused');
        break;
      case 'append':
        elem.append(cursorElem);
        cursorElem.parent().removeClass('mq-empty').addClass('mq-hasCursor');
        cursorElem.closest('.lrn_bordered_mathinput').addClass('lrn_focused');
        break;
      case 'insertBefore':
        cursorElem.insertBefore(elem);
        cursorElem.parent().removeClass('mq-empty').addClass('mq-hasCursor');
        cursorElem.closest('.lrn_bordered_mathinput').addClass('lrn_focused');
        break;
      case 'insertAfter':
        cursorElem.insertAfter(elem);
        cursorElem.parent().removeClass('mq-empty').addClass('mq-hasCursor');
        cursorElem.closest('.lrn_bordered_mathinput').addClass('lrn_focused');
        break;
      case 'remove':
        cursorElem.remove();
        break;
    }
  };
  this.backspaceSqrt = function(sqrtBlock) {
    sqrtBlock.find('> .mq-sqrt-prefix').remove();
    if (sqrtBlock.prev().hasClass('mq-nthroot')) {
      this.unwrapOrRemove(sqrtBlock.prev().find('> .mq-empty-box'));
      this.unwrapOrRemove(sqrtBlock.prev());
    }
    this.unwrapOrRemove(sqrtBlock.find('> .mq-sqrt-stem > .mq-empty-box'));
    this.unwrapOrRemove(sqrtBlock.find('> .mq-sqrt-stem'));
    this.moveCursor(sqrtBlock, 'insertBefore');
    this.unwrapOrRemove(sqrtBlock);
  };
  this.unwrapOrRemove = function(elem) {
    if (elem.children().length) {
      elem.children().unwrap();
    } else {
      elem.remove();
    }
  };
  this.createVarBlock = function(char) {
    return '<var id="command-' + (++commandCounter) + '">' + char + '</var>';
  };
  this.createNewExponent = function(exponent) {
    var mq_empty = exponent == '' ? ' mq-empty' : '';
    return '<span id="command-' + (++commandCounter) + '" class="mq-supsub mq-sup-only mq-non-leaf"><span class="mq-sup"><span class="mq-empty-box' + mq_empty + '">' + exponent + '</span><span style="display:inline-block;width:0">&#8203;</span></span></span>';
  };
  this.createNewNthRoot = function(nthRoot) {
    var mq_empty = nthRoot == '' ? ' mq-empty' : '';
    return '<span id="command-' + (++commandCounter) + '" class="mq-non-leaf"><span class="mq-scaled mq-sqrt-prefix">√</span><span class="mq-non-leaf mq-sqrt-stem"><span class="mq-empty-box' + mq_empty + '">' + nthRoot + '</span></span></span>';
  };
  this.createNewNthRootSup = function(sup) {
    var mq_empty = sup == '' ? ' mq-empty' : '';
    return '<sup id="command-' + (++commandCounter) + '" class="mq-nthroot mq-non-leaf"><span class="mq-empty-box ' + mq_empty + '">' + sup + '</span></sup>';
  };
  this.createNewFraction = function(numerator, denominator) {
    var mq_empty = denominator == '' ? ' mq-empty' : '';
    var numeratorContainerHtml = "<span class='mq-numerator'><span class='mq-empty-box'>" + numerator + "</span></span>";
    var denominatorContainerHtml = "<span class='mq-denominator'><span class='mq-empty-box" + mq_empty + "'>" + denominator + "</span></span><span style='display:inline-block;width:0'>&#8203;</span>";
    var newFraction = "<span id='command-" + (++commandCounter) + "' class='mq-fraction mq-non-leaf'>" + numeratorContainerHtml + denominatorContainerHtml + "</span>";
    return newFraction;
  };
  this.createNewsubscript = function(subscript) {
    var mq_empty = subscript == '' ? ' mq-empty' : '';
    return '<span id="command-' + (++commandCounter) + '" class="mq-supsub mq-non-leaf"><span class="mq-sub"><span class="mq-empty-box' + mq_empty + '">' + subscript + '</span></span><span style="display:inline-block;width:0">&#8203;</span>';
  };
  this.createNegateComparison = function(comp) {
    return '<span class="mq-non-leaf" id="command-' + (++commandCounter) + '"><span class="mq-negatecomparison">' + comp + '</span></span>';
  };
  this.createEnclosed = function(open, enclosed) {
    var close;
    if (open == '(')
      close = ')';
    else if (open == '[')
      close = ']';
    else if (open == '{')
      close = '}';
    var mq_empty = enclosed == '' ? ' mq-empty' : '';
    var parenthesesLeft = '<span class="mq-scaled mq-paren">' + open + '</span>';
    var parenthesesRight = '<span class="mq-scaled mq-paren">' + close + '</span>';
    var parenthesesCore = '<span class="mq-non-leaf' + mq_empty + '">' + enclosed + '</span>';
    return '<span id="command-' + (++commandCounter) + '" class="mq-non-leaf">' + parenthesesLeft + parenthesesCore + parenthesesRight + '</span>';
  };
  this.createAbs = function(value) {
    var mq_empty = value == '' ? ' mq-empty' : '';
    return '<span id="command-' + (++commandCounter) + '" class="mq-abs mq-non-leaf"><span class="mq-empty-box' + mq_empty + '">' + value + '</span></span>';
  };
  this.createNewUnderset = function(under, over) {
    var mq_empty_under = under == '' ? ' mq-empty' : '';
    var mq_empty_over = over == '' ? ' mq-empty' : '';
    return '<span id="command-' + (++commandCounter) + '" class="mq-underset mq-overunder mq-non-leaf"><span class="mq-over"><b class="mq-font' + mq_empty_over + '" id="command-' + (++commandCounter) + '">' + over + '</b></span><span class="mq-under' + mq_empty_under + '"><span class="mq-binary-operator" id="command-' + (++commandCounter) + '">' + under + '</span></span></span>';
  };
  this.createNewParallelogram = function() {
    return '<span class="mq-non-leaf mq-parallelogram" id="command-' + (++commandCounter) + '"><span class="mq-parallelogram-inner">▱</span></span>';
  };
  this.createNewOverline = function(content) {
    var mq_empty = content == '' ? ' mq-empty' : '';
    return '<span class="mq-non-leaf mq-overline" id="command-' + (++commandCounter) + '"><span class="mq-overline-inner"><span class="mq-overline-inner-right">g</span><span class="mq-overline-inner-left">h</span><span class="mq-empty-box' + mq_empty + '">' + content + '</span></span></span>';
  };
  this.createNewOverArrow = function(content) {
    var mq_empty = content == '' ? ' mq-empty' : '';
    return '<span class="mq-non-leaf mq-overarrow mq-arrow-right" id="command-' + (++commandCounter) + '"><span class="mq-overarrow-inner"><span class="mq-overarrow-inner-right">g</span><span class="mq-overarrow-inner-left">h</span><span class="mq-empty-box' + mq_empty + '">' + content + '</span></span></span>';
  };
  this.createNewOverLeftRight = function(content) {
    var mq_empty = content == '' ? ' mq-empty' : '';
    return '<span class="mq-non-leaf mq-overleftrightarrow" id="command-' + (++commandCounter) + '"><span class="mq-overleftrightarrow-inner"><span class="mq-overleftrightarrow-inner-right">g</span><span class="mq-overleftrightarrow-inner-left">h</span><span class="mq-empty-box' + mq_empty + '">' + content + '</span></span></span>';
  };
  this.cancelSelection = function() {
    if (selectionDirection == 'left') {
      $('<span class="fake_blinking_cursor">&#8203;</span>').insertBefore($(".lrn_focused .mq-selection"));
    } else {
      $('<span class="fake_blinking_cursor">&#8203;</span>').insertAfter($(".lrn_focused .mq-selection"));
    }
    this.unwrapOrRemove($(".lrn_focused .mq-selection"));
    selectionDirection = null;
  };
  this.contractSelection = function(e) {
    switch (e.keyCode) {
      case 35:
        selectionDirection = 'right';
        this.cancelSelection();
        this.handleHomeEndKeyEvents(e);
        break;
      case 36:
        selectionDirection = 'left';
        this.cancelSelection();
        this.handleHomeEndKeyEvents(e);
        break;
      case 37:
        $(".lrn_focused .mq-selection").children(':last-child').insertAfter($(".lrn_focused .mq-selection"));
        if ($(".lrn_focused .mq-selection").children(':last-child').hasClass('mq-nthroot')) {
          $(".lrn_focused .mq-selection").children(':last-child').insertAfter($(".lrn_focused .mq-selection"));
        }
        break;
      case 39:
        $(".lrn_focused .mq-selection").children(':first-child').insertBefore($(".lrn_focused .mq-selection"));
        if ($(".lrn_focused .mq-selection").children(':first-child').hasClass('mq-nthroot')) {
          $(".lrn_focused .mq-selection").children(':first-child').insertBefore($(".lrn_focused .mq-selection"));
        }
        break;
    }
    if (!$(".lrn_focused .mq-selection").children().length) {
      $('<span class="fake_blinking_cursor">&#8203;</span>').insertAfter($(".lrn_focused .mq-selection"));
      $(".lrn_focused .mq-selection").remove();
    }
  };
  this.expandSelectionToParent = function() {
    var parentElement;
    if ($(".lrn_focused .mq-selection").parent().parent().parent().is('.mq-fraction, .mq-supsub') || $(".lrn_focused .mq-selection").parent().parent().is('.mq-sqrt-stem, .mq-nthroot')) {
      parentElement = $(".lrn_focused .mq-selection").parent().parent().parent();
      this.unwrapOrRemove($(".lrn_focused .mq-selection"));
      parentElement.wrap('<span class="mq-selection"></span>');
      if ($(".lrn_focused .mq-selection").prev().hasClass('mq-nthroot')) {
        $(".lrn_focused .mq-selection").prepend($(".lrn_focused .mq-selection").prev());
      } else if ($(".lrn_focused .mq-selection").next().hasClass('mq-nthroot')) {
        $(".lrn_focused .mq-selection").append($(".lrn_focused .mq-selection").next());
      }
    }
  };
  this.expandSelection = function(e) {
    switch (e.keyCode) {
      case 35:
        if ($(".lrn_focused .mq-selection").next().length) {
          var firstElem = $(".lrn_focused .mq-selection").children(':first-child');
          this.unwrapOrRemove($(".lrn_focused .mq-selection"));
          firstElem.nextAll().andSelf().wrapAll('<span class="mq-selection"></span>');
        }
        selectionDirection = 'right';
        break;
      case 36:
        if ($(".lrn_focused .mq-selection").prev().length) {
          var lastElem = $(".lrn_focused .mq-selection").children(':last-child');
          this.unwrapOrRemove($(".lrn_focused .mq-selection"));
          lastElem.prevAll().andSelf().wrapAll('<span class="mq-selection"></span>');
        }
        selectionDirection = 'left';
        break;
      case 37:
        if ($(".lrn_focused .mq-selection").prev().length) {
          $(".lrn_focused .mq-selection").prepend($(".lrn_focused .mq-selection").prev());
          if ($(".lrn_focused .mq-selection").prev().hasClass('mq-nthroot')) {
            $(".lrn_focused .mq-selection").prepend($(".lrn_focused .mq-selection").prev());
          }
        } else {
          this.expandSelectionToParent();
        }
        selectionDirection = 'left';
        break;
      case 39:
        if ($(".lrn_focused .mq-selection").next().length) {
          $(".lrn_focused .mq-selection").append($(".lrn_focused .mq-selection").next());
          if ($(".lrn_focused .mq-selection").children(':last-child').hasClass('mq-nthroot')) {
            $(".lrn_focused .mq-selection").append($(".lrn_focused .mq-selection").next());
          }
        } else {
          this.expandSelectionToParent();
        }
        selectionDirection = 'right';
        break;
    }
  };
  this.contractSelection = function(e) {
    switch (e.keyCode) {
      case 35:
        selectionDirection = 'right';
        this.cancelSelection();
        this.handleHomeEndKeyEvents(e);
        break;
      case 36:
        selectionDirection = 'left';
        this.cancelSelection();
        this.handleHomeEndKeyEvents(e);
        break;
      case 37:
        $(".lrn_focused .mq-selection").children(':last-child').insertAfter($(".lrn_focused .mq-selection"));
        if ($(".lrn_focused .mq-selection").children(':last-child').hasClass('mq-nthroot')) {
          $(".lrn_focused .mq-selection").children(':last-child').insertAfter($(".lrn_focused .mq-selection"));
        }
        break;
      case 39:
        $(".lrn_focused .mq-selection").children(':first-child').insertBefore($(".lrn_focused .mq-selection"));
        if ($(".lrn_focused .mq-selection").children(':first-child').hasClass('mq-nthroot')) {
          $(".lrn_focused .mq-selection").children(':first-child').insertBefore($(".lrn_focused .mq-selection"));
        }
        break;
    }
    if (!$(".lrn_focused .mq-selection").children().length) {
      $('<span class="fake_blinking_cursor">&#8203;</span>').insertAfter($(".lrn_focused .mq-selection"));
      $(".lrn_focused .mq-selection").remove();
    }
  };
  this.startSelection = function(e) {
    var startElement;
    var startSelectionDirection;
    var nthRootSup = null;
    var nthRootStem = null;
    switch (e.keyCode) {
      case 35:
        startElement = $(".lrn_focused .fake_blinking_cursor").next();
        startSelectionDirection = 'right';
        break;
      case 36:
        startElement = $(".lrn_focused .fake_blinking_cursor").prev();
        startSelectionDirection = 'left';
        break;
      case 37:
        startElement = $(".lrn_focused .fake_blinking_cursor").prev();
        startSelectionDirection = 'left';
        if (startElement.prev().hasClass('mq-nthroot')) {
          nthRootSup = startElement.prev();
        }
        break;
      case 39:
        startElement = $(".lrn_focused .fake_blinking_cursor").next();
        startSelectionDirection = 'right';
        if (startElement.hasClass('mq-nthroot')) {
          nthRootStem = startElement.next();
        }
        break;
    }
    if (startElement.length) {
      switch (e.keyCode) {
        case 35:
          startElement.nextAll().andSelf().wrapAll('<span class="mq-selection"></span>');
          break;
        case 36:
          startElement.prevAll().andSelf().wrapAll('<span class="mq-selection"></span>');
          break;
        case 37:
        case 39:
          startElement.wrap('<span class="mq-selection"></span>');
          if (nthRootSup) {
            $(".lrn_focused .mq-selection").prepend(nthRootSup);
          } else if (nthRootStem) {
            $(".lrn_focused .mq-selection").append(nthRootStem);
          }
          break;
      }
      selectionDirection = startSelectionDirection;
      $(".lrn_focused .fake_blinking_cursor").remove();
    }
  };
  this.moveCursorLeftRight = function(e) {
    var destElem;
    var cursorPosAction;
    var cursorPosActionJump;
    var canJumpInFraction;
    var jumpSrc;
    var jumpDest;
    var newCursorContainer;
    if (e.keyCode == 37) {
      destElem = $(".lrn_focused .fake_blinking_cursor").prev();
      cursorPosAction = 'insertBefore';
      cursorPosActionJump = 'append';
      jumpSrc = 'mq-denominator';
      jumpDest = 'mq-numerator';
    } else if (e.keyCode == 39) {
      destElem = $(".lrn_focused .fake_blinking_cursor").next();
      cursorPosAction = 'insertAfter';
      cursorPosActionJump = 'prepend';
      jumpSrc = 'mq-numerator';
      jumpDest = 'mq-denominator';
    }
    if (destElem.length) {
      if (destElem.find('> .mq-denominator > .mq-empty-box').length) {
        destElem = destElem.find('> .mq-denominator > .mq-empty-box');
      } else if (destElem.hasClass('mq-supsub')) {
        destElem = destElem.children(':first-child').find('> .mq-empty-box');
      } else if (destElem.children(':nth-child(2)').hasClass('mq-sqrt-stem')) {
        destElem = destElem.children(':nth-child(2)').find('> .mq-empty-box');
      } else if (destElem.find('> .mq-paren').length) {
        destElem = destElem.children(':nth-child(2)');
      } else if (destElem.is('.mq-abs, .mq-nthroot')) {
        destElem = destElem.find('> .mq-empty-box');
      } else if (destElem.hasClass('mq-overunder')) {
        destElem = destElem.find('> .mq-over > .mq-font');
      } else if (destElem.hasClass('mq-overline')) {
        destElem = destElem.find('> .mq-overline-inner > .mq-empty-box');
      } else if (destElem.hasClass('mq-overarrow')) {
        destElem = destElem.find('> .mq-overarrow-inner > .mq-empty-box');
      } else if (destElem.hasClass('mq-overleftrightarrow')) {
        destElem = destElem.find('> .mq-overleftrightarrow-inner > .mq-empty-box');
      }
      if (destElem.is('.mq-empty-box, .mq-font') || destElem.prev().hasClass('mq-paren')) {
        this.moveCursor(destElem, cursorPosActionJump);
      } else {
        this.moveCursor(destElem, cursorPosAction);
      }
    } else {
      var elemType = this.getElemType();
      switch (elemType) {
        case 'fraction':
          var canJumpInFraction = $(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass(jumpSrc) ? true : false;
          if (canJumpInFraction) {
            newCursorContainer = $(".lrn_focused .fake_blinking_cursor").closest('.mq-fraction').find('> .' + jumpDest + ' > .mq-empty-box');
            if (e.keyCode == 37) {
              cursorPosAction = 'append';
            } else if (e.keyCode == 39) {
              cursorPosAction = 'prepend';
            }
          } else {
            newCursorContainer = $(".lrn_focused .fake_blinking_cursor").closest('.mq-fraction');
          }
          break;
        case 'expOrSub':
          newCursorContainer = $(".lrn_focused .fake_blinking_cursor").closest('.mq-supsub');
          break;
        case 'squareRoot':
          if (e.keyCode == 37 && $(".lrn_focused .fake_blinking_cursor").closest('.mq-sqrt-stem').parent().prev().hasClass('mq-nthroot')) {
            newCursorContainer = $(".lrn_focused .fake_blinking_cursor").closest('.mq-sqrt-stem').parent().prev().find('> .mq-empty-box');
            cursorPosAction = 'append';
          } else {
            newCursorContainer = $(".lrn_focused .fake_blinking_cursor").closest('.mq-sqrt-stem').parent();
          }
          break;
        case 'parenthesesGroup':
          newCursorContainer = $(".lrn_focused .fake_blinking_cursor").parent().parent();
          break;
        case 'abs':
          newCursorContainer = $(".lrn_focused .fake_blinking_cursor").parent().parent();
          break;
        case 'nthRoot':
          if (e.keyCode == 37) {
            newCursorContainer = $(".lrn_focused .fake_blinking_cursor").parent().parent();
          } else if (e.keyCode == 39) {
            newCursorContainer = $(".lrn_focused .fake_blinking_cursor").parent().parent().next().find('> .mq-sqrt-stem > .mq-empty-box');
            cursorPosAction = 'prepend';
          }
          break;
        case 'vector':
          if ($(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-over')) {
            newCursorContainer = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
          } else if ($(".lrn_focused .fake_blinking_cursor").parent().hasClass('mq-under')) {
            newCursorContainer = $(".lrn_focused .fake_blinking_cursor").parent().parent().find('> .mq-over > .mq-font');
            cursorPosAction = 'prepend';
          }
          break;
        case 'overline':
          newCursorContainer = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
          break;
        case 'overarrow':
          newCursorContainer = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
          break;
        case 'overleftrightarrow':
          newCursorContainer = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
          break;
      }
      if (typeof elemType !== 'undefined') {
        this.moveCursor(newCursorContainer, cursorPosAction);
      }
    }
  };
  this.handleLeftRightArrowKeyEvents = function(e) {
    if (e.shiftKey) {
      var contractSelectionDirection;
      if (e.keyCode == 37) {
        contractSelectionDirection = 'right';
      } else if (e.keyCode == 39) {
        contractSelectionDirection = 'left';
      }
      if ($(".lrn_focused .mq-selection").length) {
        if (selectionDirection == contractSelectionDirection) {
          this.contractSelection(e);
        } else {
          this.expandSelection(e);
        }
      } else {
        this.startSelection(e);
      }
    } else {
      if ($(".lrn_focused .mq-selection").length) {
        if (e.keyCode == 37) {
          selectionDirection = 'left';
        } else if (e.keyCode == 39) {
          selectionDirection = 'right';
        }
        this.cancelSelection();
      } else {
        this.moveCursorLeftRight(e);
      }
    }
  };
  this.handleUpDownArrowKeyEvents = function(e) {
    e.preventDefault();
    if (e.shiftKey) {} else {
      this.getCursorDestElement(e);
    }
  };
  this.handleHomeEndKeyEvents = function(e) {
    if (e.shiftKey) {
      var contractSelectionDirection;
      if (e.keyCode == 35) {
        contractSelectionDirection = 'left';
      } else if (e.keyCode == 36) {
        contractSelectionDirection = 'right';
      }
      if ($(".lrn_focused .mq-selection").length) {
        if (selectionDirection == contractSelectionDirection) {
          this.contractSelection(e);
        } else {
          this.expandSelection(e);
        }
      } else {
        this.startSelection(e);
      }
    } else {
      if ($(".lrn_focused .mq-selection").length) {
        if (e.keyCode == 35) {
          selectionDirection = 'right';
        } else if (e.keyCode == 36) {
          selectionDirection = 'left';
        }
        this.cancelSelection();
      } else {
        if (e.keyCode == 35) {
          this.moveCursor($(".lrn_focused .fake_blinking_cursor").parent(), 'append');
        } else if (e.keyCode == 36) {
          this.moveCursor($(".lrn_focused .fake_blinking_cursor").parent(), 'prepend');
        }
      }
    }
  };
  this.getElemType = function() {
    if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-fraction'))
      return 'fraction';
    if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-supsub'))
      return 'expOrSub';
    if ($(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-sqrt-stem'))
      return 'squareRoot';
    if ($(".lrn_focused .fake_blinking_cursor").parent().next().hasClass('mq-paren'))
      return 'parenthesesGroup';
    if ($(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-abs'))
      return 'abs';
    if ($(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-nthroot'))
      return 'nthRoot';
    if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overunder') || $(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-overunder'))
      return 'vector';
    if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overline'))
      return 'overline';
    if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overarrow'))
      return 'overarrow';
    if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overleftrightarrow'))
      return 'overleftrightarrow';
  };
  this.getElemByX = function(rootBlock, mouseX) {
    var elem = null;
    rootBlock.find('*').each(function() {
      if ($(this).is('var, .mq-fraction, .scalar_value')) {
        if ($(this).offset().left <= mouseX && $(this).offset().left + $(this)[0].getBoundingClientRect().width > mouseX) {
          elem = $(this);
          return false;
        }
      }
    });
    return elem;
  };
  this.getLeafDestChild = function(newCursorContainer, orientation) {
    var cursorOffsetLeft = $(".lrn_focused .fake_blinking_cursor").offset().left;
    var cursorDestElementChild;
    if (newCursorContainer.hasClass('mq-fraction')) {
      if (orientation == 'up') {
        newCursorContainer = newCursorContainer.find('> .mq-denominator > .mq-empty-box');
      } else {
        newCursorContainer = newCursorContainer.find('> .mq-numerator > .mq-empty-box');
      }
    } else if (newCursorContainer.hasClass('mq-overunder')) {
      if (orientation == 'up') {
        newCursorContainer = newCursorContainer.find('> .mq-under');
      } else {
        newCursorContainer = newCursorContainer.find('> .mq-over > .mq-font');
      }
    } else if (newCursorContainer.hasClass('mq-overline')) {
      newCursorContainer = newCursorContainer.find('> .mq-overline-inner > .mq-empty-box');
    } else if (newCursorContainer.hasClass('mq-overarrow')) {
      newCursorContainer = newCursorContainer.find('> .mq-overarrow-inner > .mq-empty-box');
    } else if (newCursorContainer.hasClass('mq-overleftrightarrow')) {
      newCursorContainer = newCursorContainer.find('> .mq-overleftrightarrow-inner > .mq-empty-box');
    }
    if (newCursorContainer.hasClass('mq-empty')) {
      return newCursorContainer;
    } else if (newCursorContainer.children(':first-child').offset().left > cursorOffsetLeft) {
      return newCursorContainer.find('*').not(':has(*)').first();
    } else {
      newCursorContainer.children().each(function(i) {
        if ($(this).offset().left <= cursorOffsetLeft && $(this).offset().left + $(this)[0].getBoundingClientRect().width >= cursorOffsetLeft) {
          if ($(this).children().length == 0) {
            cursorDestElementChild = $(this);
          } else {
            cursorDestElementChild = this.getLeafDestChild($(this), orientation);
          }
          return false;
        }
        if (newCursorContainer.children().length == i + 1) {
          cursorDestElementChild = $(this);
        }
      });
      if (cursorDestElementChild.hasClass('mq-sqrt-prefix')) {
        cursorDestElementChild = this.getLeafDestChild(cursorDestElementChild.next(), orientation);
      }
      return cursorDestElementChild;
    }
  };
  this.moveCursorUpDown = function(newCursorContainer, orientation) {
    if (newCursorContainer.children().length == 0) {
      this.moveCursor(newCursorContainer, 'append');
    } else {
      var cursorOffsetLeft = $(".lrn_focused .fake_blinking_cursor").offset().left;
      if (newCursorContainer.offset().left >= cursorOffsetLeft) {
        this.moveCursor(newCursorContainer, 'prepend');
      } else if (newCursorContainer.offset().left + newCursorContainer[0].getBoundingClientRect().width <= cursorOffsetLeft) {
        this.moveCursor(newCursorContainer, 'append');
      } else {
        var cursorDestElementChild = this.getLeafDestChild(newCursorContainer, orientation);
        if (cursorDestElementChild.hasClass('mq-empty-box')) {
          this.moveCursor(cursorDestElementChild, 'append');
        } else {
          if (cursorOffsetLeft <= cursorDestElementChild.offset().left + cursorDestElementChild[0].getBoundingClientRect().width / 2) {
            this.moveCursor(cursorDestElementChild, 'insertBefore');
          } else {
            this.moveCursor(cursorDestElementChild, 'insertAfter');
          }
        }
      }
    }
  };
  this.jumpCursorUpDownParent = function(e) {
    var mainFractionElem = $(".lrn_focused .fake_blinking_cursor");
    if (e.keyCode == 38) {
      while (!mainFractionElem.is('.mq-denominator, .mq-under') && !mainFractionElem.hasClass('mq-root-block')) {
        mainFractionElem = mainFractionElem.parent();
      }
      if (mainFractionElem.is('.mq-denominator, .mq-under')) {
        var jumpElem = mainFractionElem.prev();
        this.moveCursorUpDown(jumpElem, 'up');
      }
    } else if (e.keyCode == 40) {
      while (!mainFractionElem.is('.mq-numerator, .mq-over') && !mainFractionElem.hasClass('mq-root-block')) {
        mainFractionElem = mainFractionElem.parent();
      }
      if (mainFractionElem.is('.mq-numerator, .mq-over')) {
        var jumpElem = mainFractionElem.next();
        this.moveCursorUpDown(jumpElem, 'down');
      }
    }
  };
  this.getCursorDestElement = function(e) {
    if ($(".lrn_focused .mq-selection").length) {
      this.cancelSelection();
    }
    if ($(".lrn_focused .fake_blinking_cursor").next().hasClass('mq-fraction')) {
      var elem;
      if (e.keyCode == 38) {
        elem = $(".lrn_focused .fake_blinking_cursor").next().find('> .mq-numerator > .mq-empty-box');
      } else if (e.keyCode == 40) {
        elem = $(".lrn_focused .fake_blinking_cursor").next().find('> .mq-denominator > .mq-empty-box');
      }
      this.moveCursor(elem, 'prepend');
    } else if ($(".lrn_focused .fake_blinking_cursor").prev().hasClass('mq-fraction')) {
      var elem;
      if (e.keyCode == 38) {
        elem = $(".lrn_focused .fake_blinking_cursor").prev().find('> .mq-numerator > .mq-empty-box');
      } else if (e.keyCode == 40) {
        elem = $(".lrn_focused .fake_blinking_cursor").prev().find('> .mq-denominator > .mq-empty-box');
      }
      this.moveCursor(elem, 'append');
    } else if ($(".lrn_focused .fake_blinking_cursor").next().hasClass('mq-supsub')) {
      if (e.keyCode == 38) {
        if ($(".lrn_focused .fake_blinking_cursor").next().find('> .mq-sup').length) {
          this.moveCursor($(".lrn_focused .fake_blinking_cursor").next().find('> .mq-sup > .mq-empty-box'), 'prepend');
        } else {
          this.jumpCursorUpDownParent(e);
        }
      } else if (e.keyCode == 40) {
        if ($(".lrn_focused .fake_blinking_cursor").next().find('> .mq-sub').length) {
          this.moveCursor($(".lrn_focused .fake_blinking_cursor").next().find('> .mq-sub > .mq-empty-box'), 'prepend');
        } else {
          this.jumpCursorUpDownParent(e);
        }
      }
    } else if ($(".lrn_focused .fake_blinking_cursor").prev().hasClass('mq-supsub')) {
      if (e.keyCode == 38) {
        if ($(".lrn_focused .fake_blinking_cursor").prev().find('> .mq-sup').length) {
          this.moveCursor($(".lrn_focused .fake_blinking_cursor").prev().find('> .mq-sup > .mq-empty-box'), 'append');
        } else {
          this.jumpCursorUpDownParent(e);
        }
      } else if (e.keyCode == 40) {
        if ($(".lrn_focused .fake_blinking_cursor").prev().find('> .mq-sub').length) {
          this.moveCursor($(".lrn_focused .fake_blinking_cursor").prev().find('> .mq-sub > .mq-empty-box'), 'append');
        } else {
          this.jumpCursorUpDownParent(e);
        }
      }
    } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-supsub')) {
      if ((e.keyCode == 38 && $(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-sup')) || (e.keyCode == 40 && $(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-sub'))) {
        jumpCursorUpDownParent(e);
      } else {
        if ($(".lrn_focused .fake_blinking_cursor").is(':last-child')) {
          this.moveCursor($(".lrn_focused .fake_blinking_cursor").closest('.mq-supsub'), 'insertAfter');
        } else {
          this.moveCursor($(".lrn_focused .fake_blinking_cursor").closest('.mq-supsub'), 'insertBefore');
        }
      }
    } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-fraction')) {
      this.jumpCursorUpDownParent(e);
    } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-sqrt-stem')) {
      this.jumpCursorUpDownParent(e);
    } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overunder')) {
      this.jumpCursorUpDownParent(e);
    } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-overunder')) {
      this.jumpCursorUpDownParent(e);
    } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overline')) {
      this.jumpCursorUpDownParent(e);
    } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overarrow')) {
      this.jumpCursorUpDownParent(e);
    } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overleftrightarrow')) {
      this.jumpCursorUpDownParent(e);
    }
  };
  this.removeSelection = function() {
    if ($(".lrn_focused .mq-selection").length) {
      $(".lrn_focused .mq-selection").children().unwrap();
      $(".lrn_focused .mq-selection").parent().html($(".lrn_focused .mq-selection").html());
    }
  };
  this.getFocusPos = function(element, e) {
    if (element.hasClass('mq-root-block') || element.hasClass('lrn_math_editable') || element.hasClass('lrn_response_input')) {
      if (!element.hasClass('mq-root-block')) {
        element = element.find(".mq-root-block");
      }
      var firstRealElement;
      if (element.children().length) {
        firstRealElement = element.children(":first-child");
        if (e.pageX < firstRealElement.offset().left) {
          return "left";
        } else {
          return "right";
        }
      } else
        return "left";
    } else {
      if (e.pageX > element.offset().left + element[0].getBoundingClientRect().width / 2) {
        return "right";
      } else {
        return "left";
      }
    }
  };
  this.getElementCursorNeighbour = function(element, position) {
    var neighbour;
    if (position == 'left') {
      neighbour = element.prev();
    } else {
      neighbour = element.next();
    }
    if (neighbour.length) {
      return neighbour.attr('id');
    } else if (element.parent().hasClass('mq-root-block')) {
      return null;
    } else if (element.parent().parent().parent().is('.mq-fraction, .mq-supsub')) {
      return element.parent().parent().parent().attr('id');
    }
  };
  this.getRealBoundaries = function(start, end) {
    if (start.is(end) || start.siblings().is(end)) {
      return [start, end];
    } else {
      var parentsStart = $.merge(start, start.parentsUntil('.mq-root-block'));
      var parentsEnd = $.merge(end, end.parentsUntil('.mq-root-block'));
      if (parentsStart.length === 0 || parentsStart.hasClass('mq-root-block') || parentsStart.closest('.mq-root-block').find('.mq-editable-field').length) {
        parentsStart = $('.mq-root-block.mq-hasCursor').children().first();
      }
      if (parentsEnd.length === 0 || parentsEnd.hasClass('mq-root-block') || parentsEnd.closest('.mq-root-block').find('.mq-editable-field').length) {
        parentsEnd = $('.mq-root-block.mq-hasCursor').children().last();
      }
      var realEnd = null;
      var realStart = null;
      parentsStart.each(function() {
        var thisS = $(this);
        parentsEnd.each(function() {
          if ($(this).siblings().is(thisS) || $(this).is(thisS)) {
            realEnd = $(this);
            return false;
          }
        });
        if (realEnd) {
          realStart = thisS;
          return false;
        }
      });
      if (realStart !== null && (realStart.hasClass('mq-numerator') || realStart.hasClass('mq-denominator'))) {
        realStart = realEnd = realStart.parent();
      }
      return [realStart, realEnd];
    }
  };
  this.addEventListeners = function() {
    var _this = this;
    $("a.cke_dialog_ui_button_ok").unbind("focus.mathToolbar").bind("focus.mathToolbar", function() {
      $(this).blur();
    });
    $("." + _this.settings.containerClassName + " .math_nav_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      $(".math_nav_button.active").removeClass('active');
      $(this).addClass('active');
      var type = $(this).attr('id');
      $("#tab_buttons button").addClass('hidden');
      $("#tab_buttons ." + type).removeClass('hidden');
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #response_icon").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      var formulaHtml = _this.createResponse();
      _this.insertBeforeCursor(formulaHtml);
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " .simple_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      var formulaHtml = _this.createSimpleCommandBlock($(this).html());
      _this.insertBeforeCursor(formulaHtml);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " .yellow_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      var formulaHtml = _this.createScalarBlock($(this).text());
      _this.insertBeforeCursor(formulaHtml);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " .grey_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      var formulaHtml = _this.createBinaryOperatorBlock($(this).html());
      _this.insertBeforeCursor(formulaHtml);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #left_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var e = jQuery.Event("keydown");
      e.keyCode = 37;
      $(document).trigger(e);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #right_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var e = jQuery.Event("keydown");
      e.keyCode = 39;
      $(document).trigger(e);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #backspace_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      } else {
        if ($(".lrn_focused .fake_blinking_cursor").prev().length) {
          if ($(".lrn_focused .fake_blinking_cursor").prev().children().length) {
            $(".lrn_focused .fake_blinking_cursor").prev().wrap('<span class="mq-selection"></span>');
            if ($(".lrn_focused .fake_blinking_cursor").prev().prev().hasClass('mq-nthroot')) {
              $(".lrn_focused .fake_blinking_cursor").prev().prev().prependTo($(".lrn_focused .fake_blinking_cursor").prev());
            }
            $(".lrn_focused .fake_blinking_cursor").remove();
          } else {
            $(".lrn_focused .fake_blinking_cursor").prev().remove();
          }
        } else {
          if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-supsub')) {
            var toRemove = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
            _this.moveCursor(toRemove, 'insertBefore');
            toRemove.remove();
          } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-sqrt-stem')) {
            var sqrtBlock = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
            _this.backspaceSqrt(sqrtBlock);
          } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().hasClass('mq-nthroot')) {
            var sqrtBlock = $(".lrn_focused .fake_blinking_cursor").parent().parent().next();
            _this.backspaceSqrt(sqrtBlock);
          } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-fraction')) {
            var fractElem = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
            fractElem.find('> .mq-denominator').next().remove();
            _this.unwrapOrRemove(fractElem.find('> .mq-numerator > .mq-empty-box'));
            _this.unwrapOrRemove(fractElem.find('> .mq-numerator'));
            _this.unwrapOrRemove(fractElem.find('> .mq-denominator > .mq-empty-box'));
            _this.unwrapOrRemove(fractElem.find('> .mq-denominator'));
            _this.moveCursor(fractElem, 'insertBefore');
            _this.unwrapOrRemove(fractElem);
          } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overline')) {
            var mainElem = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
            mainElem.find('> .mq-overline-inner > .mq-overline-inner-right').remove();
            mainElem.find('> .mq-overline-inner > .mq-overline-inner-left').remove();
            _this.unwrapOrRemove(mainElem.find('> .mq-overline-inner > .mq-empty-box'));
            _this.unwrapOrRemove(mainElem.find('> .mq-overline-inner'));
            _this.unwrapOrRemove(mainElem);
          } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overarrow')) {
            var mainElem = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
            mainElem.find('> .mq-overarrow-inner > .mq-overarrow-inner-right').remove();
            mainElem.find('> .mq-overarrow-inner > .mq-overarrow-inner-left').remove();
            _this.unwrapOrRemove(mainElem.find('> .mq-overarrow-inner > .mq-empty-box'));
            _this.unwrapOrRemove(mainElem.find('> .mq-overarrow-inner'));
            _this.unwrapOrRemove(mainElem);
          } else if ($(".lrn_focused .fake_blinking_cursor").parent().parent().parent().hasClass('mq-overleftrightarrow')) {
            var mainElem = $(".lrn_focused .fake_blinking_cursor").parent().parent().parent();
            mainElem.find('> .mq-overleftrightarrow-inner > .mq-overleftrightarrow-inner-right').remove();
            mainElem.find('> .mq-overleftrightarrow-inner > .mq-overleftrightarrow-inner-left').remove();
            _this.unwrapOrRemove(mainElem.find('> .mq-overleftrightarrow-inner > .mq-empty-box'));
            _this.unwrapOrRemove(mainElem.find('> .mq-overleftrightarrow-inner'));
            _this.moveCursor(fractElem, 'insertBefore');
            _this.unwrapOrRemove(mainElem);
          } else if ($(".lrn_focused .fake_blinking_cursor").parent().prev().hasClass('mq-paren')) {
            var removeElem = $(".lrn_focused .fake_blinking_cursor").parent().parent();
            var content = $(".lrn_focused .fake_blinking_cursor").parent();
            content.insertBefore(removeElem);
            content.children().unwrap();
            removeElem.remove();
          }
        }
      }
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #x_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      var formulaHtml = _this.createVarBlock('x');
      _this.insertBeforeCursor(formulaHtml);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #y_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      var formulaHtml = _this.createVarBlock('y');
      _this.insertBeforeCursor(formulaHtml);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #square").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var exponent = '<span id="command-' + (++commandCounter) + '" class="scalar_value">2</span>';
      var $newSquare = $(_this.createNewExponent(exponent));
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      $newSquare.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      var cursorDestElem = $newSquare.find("> .mq-sup >.mq-empty-box");
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #square_root").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newSquareRoot;
      if ($(".lrn_focused .mq-selection").length) {
        $newSquareRoot = $(_this.createNewNthRoot($(".lrn_focused .mq-selection").html()));
        $newSquareRoot.insertBefore($(".lrn_focused .mq-selection"));
        $(".lrn_focused .mq-selection").remove();
      } else {
        $newSquareRoot = $(_this.createNewNthRoot(''));
        $newSquareRoot.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      }
      var cursorDestElem = $newSquareRoot.find("> .mq-sqrt-stem > .mq-empty-box");
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #nth_root").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newNthRootSup;
      var $newNthRoot = $(_this.createNewNthRoot(''));
      var cursorDestElem;
      if ($(".lrn_focused .mq-selection").length) {
        var sup = $(".lrn_focused .mq-selection").html();
        $newNthRootSup = $(_this.createNewNthRootSup(sup));
        $newNthRoot.insertBefore($(".lrn_focused .mq-selection"));
        $newNthRootSup.insertBefore($newNthRoot);
        $(".lrn_focused .mq-selection").remove();
        cursorDestElem = $newNthRoot.find("> .mq-sqrt-stem > .mq-empty-box");
      } else {
        $newNthRootSup = $(_this.createNewNthRootSup(''));
        $newNthRootSup.insertAfter($(".lrn_focused .fake_blinking_cursor"));
        $newNthRoot.insertAfter($newNthRootSup);
        cursorDestElem = $newNthRootSup.find("> .mq-empty-box");
      }
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #fraction_prev").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var numerator = '';
      var $newFraction;
      var cursorDestElem;
      if ($(".lrn_focused .mq-selection").length) {
        numerator = $(".lrn_focused .mq-selection").html();
        $newFraction = $(_this.createNewFraction(numerator, ''));
        $newFraction.insertBefore($(".lrn_focused .mq-selection"));
        $(".lrn_focused .mq-selection").remove();
        cursorDestElem = $newFraction.find("> .mq-denominator > .mq-empty-box");
      } else {
        if ($(".lrn_focused .fake_blinking_cursor").prevAll().length && !$(".lrn_focused .fake_blinking_cursor").prev().hasClass('mq-binary-operator')) {
          $(".lrn_focused .fake_blinking_cursor").prevAll().each(function() {
            if ($(this).hasClass('mq-binary-operator')) {
              return false;
            }
            numerator = $(this).get(0).outerHTML + numerator;
            $(this).remove();
          });
          $newFraction = $(_this.createNewFraction(numerator, ''));
          cursorDestElem = $newFraction.find("> .mq-denominator > .mq-empty-box");
        } else {
          $newFraction = $(_this.createNewFraction('', ''));
          cursorDestElem = $newFraction.find("> .mq-numerator > .mq-empty-box");
        }
        $newFraction.insertBefore($(".lrn_focused .fake_blinking_cursor"));
      }
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #fraction").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newFraction = $(_this.createNewFraction('', ''));
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      $newFraction.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      var cursorDestElem = $newFraction.find("> .mq-numerator > .mq-empty-box");
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #exponent").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var exponent;
      if ($(".lrn_focused .mq-selection").length) {
        exponent = $(".lrn_focused .mq-selection").html();
        _this.moveCursor($(".lrn_focused .mq-selection"), 'insertBefore');
        $(".lrn_focused .mq-selection").remove();
      } else {
        exponent = '';
      }
      var $newExponent = $(_this.createNewExponent(exponent));
      $newExponent.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      var cursorDestElem = $newExponent.find("> .mq-sup >.mq-empty-box");
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #subscript").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var subscript;
      if ($(".lrn_focused .mq-selection").length) {
        subscript = $(".lrn_focused .mq-selection").html();
        $('<span class="fake_blinking_cursor">&#8203;</span>').insertBefore($(".lrn_focused .mq-selection"));
        $(".lrn_focused .mq-selection").remove();
      } else {
        subscript = '';
      }
      var $newExponent = $(_this.createNewsubscript(subscript));
      $newExponent.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      var cursorDestElem = $newExponent.find("> .mq-sub >.mq-empty-box");
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " .binary-operator-button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      var formulaHtml = _this.createBinaryOperatorBlock($(this).html());
      _this.insertBeforeCursor(formulaHtml);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " .non_symbola_button").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      var formulaHtml = '<span class="mq-nonSymbola" id="command-' + (++commandCounter) + '">' + $(this).html() + '</span>';
      _this.insertBeforeCursor(formulaHtml);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " .negatecomparison").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      var formulaHtml = _this.createNegateComparison($(this).html());
      _this.insertBeforeCursor(formulaHtml);
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #parentheses").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newParentheses;
      var cursorDestElem;
      if ($(".lrn_focused .mq-selection").length) {
        var enclosed = $(".lrn_focused .mq-selection").html();
        $newParentheses = $(_this.createEnclosed('(', enclosed));
        $newParentheses.insertBefore($(".lrn_focused .mq-selection"));
        $(".lrn_focused .mq-selection").remove();
      } else {
        $newParentheses = $(_this.createEnclosed('(', ''));
        $newParentheses.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      }
      var cursorDestElem = $newParentheses.find("> .mq-non-leaf");
      _this.moveCursor(cursorDestElem, 'prepend');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #brackets").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newBrackets;
      var cursorDestElem;
      if ($(".lrn_focused .mq-selection").length) {
        var enclosed = $(".lrn_focused .mq-selection").html();
        $newBrackets = $(_this.createEnclosed('[', enclosed));
        $newBrackets.insertBefore($(".lrn_focused .mq-selection"));
        $(".lrn_focused .mq-selection").remove();
      } else {
        $newBrackets = $(_this.createEnclosed('[', ''));
        $newBrackets.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      }
      var cursorDestElem = $newBrackets.find("> .mq-non-leaf");
      _this.moveCursor(cursorDestElem, 'prepend');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #absolute_value").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newAbs;
      if ($(".lrn_focused .mq-selection").length) {
        var value = $(".lrn_focused .mq-selection").html();
        $newAbs = $(_this.createAbs(value));
        $newAbs.insertBefore($(".lrn_focused .mq-selection"));
        $(".lrn_focused .mq-selection").remove();
      } else {
        $newAbs = $(_this.createAbs(''));
        $newAbs.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      }
      var cursorDestElem = $newAbs.find("> .mq-empty-box");
      _this.moveCursor(cursorDestElem, 'append');
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #vector").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newVector = $(_this.createNewUnderset('~', ''));
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      $newVector.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      var cursorDestElem = $newVector.find("> .mq-over > .mq-empty");
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #parallelogram").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newParal = $(_this.createNewParallelogram());
      if ($(".lrn_focused .mq-selection").length) {
        _this.dropSelection();
      }
      $newParal.insertBefore($(".lrn_focused .fake_blinking_cursor"));
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #overline").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newOverline;
      if ($(".lrn_focused .mq-selection").length) {
        var content = $(".lrn_focused .mq-selection").html();
        $newOverline = $(_this.createNewOverline(content));
        $newOverline.insertBefore($(".lrn_focused .mq-selection"));
        $(".lrn_focused .mq-selection").remove();
      } else {
        $newOverline = $(_this.createNewOverline(''));
        $newOverline.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      }
      var cursorDestElem = $newOverline.find("> .mq-overline-inner > .mq-empty-box");
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #overarrow").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newOverArrow;
      if ($(".lrn_focused .mq-selection").length) {
        var content = $(".lrn_focused .mq-selection").html();
        $newOverArrow = $(_this.createNewOverArrow(content));
        $newOverArrow.insertBefore($(".lrn_focused .mq-selection"));
        $(".lrn_focused .mq-selection").remove();
      } else {
        $newOverArrow = $(_this.createNewOverArrow(''));
        $newOverArrow.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      }
      var cursorDestElem = $newOverArrow.find("> .mq-overarrow-inner > .mq-empty-box");
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $("." + _this.settings.containerClassName + " #overleftright").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
      var $newOverLeftRightArrow;
      if ($(".lrn_focused .mq-selection").length) {
        var content = $(".lrn_focused .mq-selection").html();
        $newOverLeftRightArrow = $(_this.createNewOverLeftRight(content));
        $newOverLeftRightArrow.insertBefore($(".lrn_focused .mq-selection"));
        $(".lrn_focused .mq-selection").remove();
      } else {
        $newOverLeftRightArrow = $(_this.createNewOverLeftRight(''));
        $newOverLeftRightArrow.insertAfter($(".lrn_focused .fake_blinking_cursor"));
      }
      var cursorDestElem = $newOverLeftRightArrow.find("> .mq-overleftrightarrow-inner > .mq-empty-box");
      _this.moveCursor(cursorDestElem, 'append');
      _this.reScale();
      e.stopPropagation();
    });
    $(document).unbind("keydown.mathToolbar").bind("keydown.mathToolbar", function(e) {
      if ($(".lrn_focused").is(':visible') && $(".lrn_focused .fake_blinking_cursor").length || $(".lrn_focused .mq-selection").length) {
        e.preventDefault();
        if ($(".lrn_focused .mq-selection").length) {
          switch (e.originalEvent.key) {
            case 'Home':
            case 'End':
            case 'ArrowRight':
            case 'ArrowLeft':
            case 'ArrowUp':
            case 'ArrowDown':
              _this.cancelSelection();
              break;
            default:
              _this.dropSelection();
          }
        }
        switch (e.originalEvent.key) {
          case "Backspace":
            $("." + _this.settings.containerClassName + " #backspace_button").trigger('click');
            break;
          case '(':
          case ')':
            $("." + _this.settings.containerClassName + " #parentheses").trigger('click');
            break;
          case '[':
          case ']':
            $("#brackets").trigger('click');
            break;
          case '{':
          case '}':
            var $newBraces;
            var cursorDestElem;
            if ($(".lrn_focused .mq-selection").length) {
              var enclosed = $(".lrn_focused .mq-selection").html();
              $newBraces = $(_this.createEnclosed('{', enclosed));
              $newBraces.insertBefore($(".lrn_focused .mq-selection"));
              $(".lrn_focused .mq-selection").remove();
            } else {
              $newBraces = $(_this.createEnclosed('{', ''));
              $newBraces.insertAfter($(".lrn_focused .fake_blinking_cursor"));
            }
            var cursorDestElem = $newBraces.find("> .mq-non-leaf");
            _this.moveCursor(cursorDestElem, 'prepend');
            _this.reScale();
            break;
          case ',':
            $("." + _this.settings.containerClassName + " #comma_button").trigger('click');
            break;
          case '.':
          case 'Decimal':
          case 'NumpadDecimal':
            $("." + _this.settings.containerClassName + " #dot_button").trigger('click');
            break;
          case "Home":
          case "End":
            _this.handleHomeEndKeyEvents(e);
            break;
          case "ArrowRight":
          case "ArrowLeft":
            _this.handleLeftRightArrowKeyEvents(e);
            break;
          case "ArrowUp":
          case "ArrowDown":
            _this.handleUpDownArrowKeyEvents(e);
            break;
          case 'a':
            if (e.ctrlKey) {
              if (!($(".lrn_focused .fake_blinking_cursor").closest(".mq-root-block").children().length == 1 && $(".lrn_focused .fake_blinking_cursor").closest(".mq-root-block").children(':first-child').hasClass('fake_blinking_cursor'))) {
                var html = $(".lrn_focused .fake_blinking_cursor").closest(".mq-root-block").html();
                $(".lrn_focused .fake_blinking_cursor").closest(".mq-root-block").html('<span class="mq-selection">' + html + '</span>');
                _this.moveCursor(null, 'remove');
              }
            } else {
              $("." + _this.settings.containerClassName + " button:focus").blur();
              _this.insertBeforeCursor('<var id="command-' + (++commandCounter) + '">' + e.key + '</var>');
            }
            break;
          case 'x':
            $("." + _this.settings.containerClassName + " #x_button").trigger('click');
            break;
          case 'y':
            $("." + _this.settings.containerClassName + " #y_button").trigger('click');
            break;
          case '/':
            $("." + _this.settings.containerClassName + " #fraction_prev").trigger('click');
            break;
          case 'Divide':
          case 'NumpadDivide':
            $("." + _this.settings.containerClassName + " .grey_button:contains('÷')").trigger('click');
            break;
          case '*':
          case 'Multiply':
          case 'NumpadMultiply':
            $("." + _this.settings.containerClassName + " .grey_button:contains('×')").trigger('click');
            break;
          case '+':
          case 'Add':
          case 'NumpadAdd':
            $("." + _this.settings.containerClassName + " .grey_button:contains('+')").trigger('click');
            break;
          case '-':
          case 'Subtract':
          case 'NumpadSubtract':
            $("." + _this.settings.containerClassName + " .grey_button:contains('-')").trigger('click');
            break;
          case '=':
            $("." + _this.settings.containerClassName + " .grey_button:contains('=')").trigger('click');
            break;
          case '<':
            $("." + _this.settings.containerClassName + " #less_than").trigger('click');
            break;
          case '>':
            $("." + _this.settings.containerClassName + " #greater_than").trigger('click');
            break;
          case ':':
            $("." + _this.settings.containerClassName + " .blue_button:contains(':')").trigger('click');
            break;
          case '$':
            $("." + _this.settings.containerClassName + " #dollar_sign").trigger('click');
            break;
          case '%':
            $("." + _this.settings.containerClassName + " #percentage").trigger('click');
            break;
          case "'":
            $("." + _this.settings.containerClassName + " #arcminute").trigger('click');
            break;
          case '"':
            $("." + _this.settings.containerClassName + " #arcsecond").trigger('click');
            break;
          case '?':
            _this.insertBeforeCursor('<var id="command-' + (++commandCounter) + '" class="qm">' + e.key + '</var>');
            break;
          case ' ':
            $("." + _this.settings.containerClassName + " button:focus").blur();
            _this.insertBeforeCursor('<span>\&nbsp;</span>');
            break;
          default:
            if ((e.key >= '0' && e.key <= '9')) {
              $("." + _this.settings.containerClassName + " .yellow_button:contains(" + e.key + ")").trigger('click');
            } else if (e.key.length == 1) {
              $("." + _this.settings.containerClassName + " button:focus").blur();
              _this.insertBeforeCursor('<var id="command-' + (++commandCounter) + '">' + e.key + '</var>');
            }
        }
      }
    });
    $("." + _this.settings.containerClassName + " .mq-editable-field *").unbind("mousedown.mathToolbar touchstart.mathToolbar").bind("mousedown.mathToolbar touchstart.mathToolbar", function(e) {
      if ($(e.target).hasClass('mq-root-block')) {
        var lastChild = $(e.target).children(':last-child');
        if (lastChild.length && e.pageX > lastChild.offset().left + lastChild[0].getBoundingClientRect().width) {
          selectionStartX = lastChild.offset().left + lastChild[0].getBoundingClientRect().width;
        }
      } else {
        selectionStartX = $(e.target).offset().left;
        selectionStartY = $(e.target).offset().top;
      }
      down = true;
      selectionDirection = null;
      prevMoveEvent = null;
      $("*").addClass('user_select_none');
      var focusPos = _this.getFocusPos($(e.target), e);
      if ($(e.target).hasClass("mq-math-mode") || $(e.target).hasClass("mq-root-block") || $(e.target).hasClass("mq-editable-field")) {
        if (!$(e.target).find('.mq-editable-field').length) {
          var rootBlock;
          if ($(e.target).hasClass('mq-root-block')) {
            rootBlock = $(e.target);
          } else {
            rootBlock = $(e.target).find('.mq-root-block');
          }
          if (rootBlock) {
            $(".fake_blinking_cursor").remove();
            if (focusPos == 'left') {
              _this.moveCursor(rootBlock, 'prepend');
            } else {
              _this.moveCursor(rootBlock, 'append');
            }
          }
        }
      } else if ($(e.target).hasClass('response_command') || $(e.target).hasClass('scalar_value') || $(e.target).is('var') || $(e.target).hasClass('simple_command') || $(e.target).attr('class').match('mq-')) {
        if (!$(e.target).closest('.mq-root-block').find('.mq-editable-field').length) {
          if ($(e.target).hasClass('mq-empty-box') || $(e.target).prev().hasClass('mq-paren')) {
            if (focusPos == 'left') {
              _this.moveCursor($(e.target), 'prepend');
            } else {
              _this.moveCursor($(e.target), 'append');
            }
          } else if ($(e.target).hasClass('mq-numerator') || $(e.target).hasClass('mq-denominator')) {
            if (focusPos == 'left') {
              _this.moveCursor($(e.target).find('.mq-empty-box:first'), 'prepend');
            } else {
              _this.moveCursor($(e.target).find('.mq-empty-box:first'), 'append');
            }
          } else if ($(e.target).hasClass('mq-sqrt-prefix') || $(e.target).hasClass('mq-sqrt-stem')) {
            _this.moveCursor($(e.target).parent().find('> .mq-sqrt-stem > .mq-empty-box'), 'prepend');
          } else if ($(e.target).hasClass('mq-paren')) {
            _this.moveCursor($(e.target).parent().find('> .mq-non-leaf'), 'prepend');
          } else if ($(e.target).find('> .mq-paren').length) {
            _this.moveCursor($(e.target).find('> .mq-non-leaf'), 'prepend');
          } else {
            if (focusPos == 'left') {
              _this.moveCursor($(e.target), 'insertBefore');
            } else {
              _this.moveCursor($(e.target), 'insertAfter');
            }
          }
        }
      }
      cursorElemLeft = _this.getElementCursorNeighbour($(".lrn_focused .fake_blinking_cursor"), 'left');
      cursorElemRight = _this.getElementCursorNeighbour($(".lrn_focused .fake_blinking_cursor"), 'right');
      clearInterval(cursorAnimationId);
      cursorAnimationId = setInterval(function() {
        _this.cursorAnimation()
      }, 800);
      e.stopPropagation();
      if (!$(e.target).closest('.mq-math-mode').find('.mq-editable-field').length || $(e.target).hasClass('mq-editable-field') || $(e.target).closest('.mq-editable-field').length) {
        _this.removeSelection();
      }
    });
    $(document).unbind("mouseup.mathToolbar touchend.mathToolbar").bind("mouseup.mathToolbar touchend.smathToolbar", function(e) {
      down = false;
      prevMoveEvent = null;
      $("*").removeClass('user_select_none');
      if (!$(e.target).closest('.lrn_response_wrapper').length && !$(e.target).hasClass('lrn_response_wrapper') && !$(e.target).closest('.mathformula-input-transformed').length && !$(e.target).hasClass('mathformula-input-transformed') && $('.mathformula-input-transformed .lrn_input_ui').length && $('.mathformula-input-transformed .lrn_input_ui').offset().top == toolbarTop && $('.mathformula-input-transformed .lrn_input_ui').offset().left == toolbarLeft) {
        _this.moveCursor(null, 'remove');
      }
    });
    $("." + _this.settings.containerClassName + " .mq-editable-field *").unbind("mousemove.mathToolbar").bind("mousemove.mathToolbar", function(e) {
      if (down == true) {
        if ((!prevMoveEvent || prevMoveEvent.target != e.target) && !$(e.target).hasClass('fake_blinking_cursor')) {
          prevMoveEvent = e;
          $(".lrn_focused .mq-selection").children().unwrap();
          selectionDirection = null;
          var startElem;
          var endElem;
          var realBoundaries;
          if (e.pageX < selectionStartX) {
            if (!$(e.target).closest(".mq-root-block").find("#" + cursorElemLeft).length) {
              return false;
            }
            selectionDirection = 'left';
            if ($(e.target).hasClass('mq-root-block')) {
              startElem = _this.getElemByX($(e.target), e.pageX);
              if (!startElem) {
                startElem = $(e.target).children(':first-child');
              }
            } else if ($(e.target).is('.mq-numerator, .mq-denominator')) {
              startElem = $(e.target).closest('.mq-fraction');
            } else if ($(e.target).is('.mq-sqrt-prefix, .mq-sqrt-stem')) {
              startElem = $(e.target).parent();
              if (startElem.prev().hasClass('mq-nthroot')) {
                startElem = startElem.prev();
              }
            } else {
              startElem = $(e.target);
            }
            realBoundaries = _this.getRealBoundaries(startElem, startElem.closest(".mq-root-block").find("#" + cursorElemLeft));
          } else {
            if (!$(e.target).closest(".mq-root-block").find("#" + cursorElemRight).length)
              return false;
            selectionDirection = 'right';
            if ($(e.target).hasClass('mq-root-block')) {
              endElem = _this.getElemByX($(e.target), e.pageX);
              if (!endElem) {
                endElem = $(e.target).children(':last-child');
              }
            } else if ($(e.target).is('.mq-numerator, .mq-denominator')) {
              endElem = $(e.target).closest('.mq-fraction');
            } else {
              endElem = $(e.target);
            }
            realBoundaries = _this.getRealBoundaries($(e.target).closest(".mq-root-block").find("#" + cursorElemRight), endElem);
          }
          startElem = realBoundaries[0];
          endElem = realBoundaries[1];
          if (startElem.is(endElem)) {
            startElem.wrap('<span class="mq-selection"></span>');
          } else {
            startElem.nextUntil(endElem).andSelf().add(endElem).wrapAll('<span class="mq-selection"></span>');
          }
          $(".lrn_focused .fake_blinking_cursor").remove();
        }
      }
    });
    $(window).unbind("mousedown.mathToolbar touchstart.mathToolbar").bind("mousedown.mathToolbar touchstart.mathToolbar", function(e) {
      if ($('.mathformula-input-transformed .lrn_input_ui').length) {
        toolbarTop = $('.mathformula-input-transformed .lrn_input_ui').offset().top;
        toolbarLeft = $('.mathformula-input-transformed .lrn_input_ui').offset().left;
      } else {
        toolbarTop = 0;
        toolbarLeft = 0;
      }
    });
    $(window).unbind("mouseup.mathToolbar touchend.mathToolbar").bind("mouseup.mathToolbar touchend.mathToolbar", function(e) {
      if (e.which === 1 && $(e.target).closest('.mathformula-input-transformed').length === 0 && e.target.nodeName !== 'HTML' && $('.mathformula-input-transformed .lrn_input_ui').length && $('.mathformula-input-transformed .lrn_input_ui').offset().top == toolbarTop && $('.mathformula-input-transformed .lrn_input_ui').offset().left == toolbarLeft) {
        if ($(".mq-selection").closest('.mathformula-input-transformed').length) {
          _this.cancelSelection();
        }
        $('.mathformula-input-transformed .lrn_input_ui').hide();
        $('.mathformula-input-transformed.lrn_focused .fake_blinking_cursor').remove();
        $('.mathformula-input-transformed.lrn_focused').removeClass('lrn_focused');
      }
    });
    $(window).unbind("resize.mathToolbar").bind("resize.mathToolbar", function(e) {
      if ($('.lrn_input_ui').closest('.fillblank').length) {
        $('.lrn_input_ui').css('width', $('.ms-pbl-content').width() + 'px');
      }
    });
  };
  this.cursorAnimation = function() {
    $("." + this.settings.containerClassName + " .fake_blinking_cursor").animate({
      opacity: 0
    }, 'fast', 'swing').animate({
      opacity: 1
    }, 'fast', 'swing');
  };
  this.createMathformulaInputs = function() {
    if ($(".mathformula-input").length) {
      var settings = this.settings;
      $(".mathformula-input").each(function() {
        var val = $(this).html();
        var isCorrectAnswer = $(this).parent('.charts-correct-answer-text').length ? true : false;
        if (typeof settings.isPE !== 'undefined') {
          if (val !== "") {
            var valElem = $('<div>' + $.parseHTML(val)[0].data + '</div>');
            if (!isCorrectAnswer) {
              valElem.find('.mq-inner-editable').each(function() {
                var id = $(this).attr('id');
                $(this).replaceWith('<span class="response_command" id="' + id + '"><span class="response_left"><span>r</span></span><span class="response_right">Response</span><span style="clear:both"></span></span>');
              });
            }
            val = valElem.html();
          }
        }
        var responseIcon = 'false';
        if (typeof $(this).attr('data-responsefield') !== 'undefined' && $(this).attr('data-responsefield') === "1") {
          responseIcon = 'true';
        }
        if ($(this).hasClass('fillblank')) {
          var mathformulaInputElemHtml = '<span class="' + settings.containerClassName + ' mathformula-input-transformed fillblank lrn_clearfix">' + '<span class="lrn_response">' + val + '</span>' + '</span>';
        } else {
          var mathformulaInputElemHtml = '<div class="' + settings.containerClassName + ' mathformula-input-transformed lrn_clearfix" data-responsefield="' + responseIcon + '">' + '<div class="lrn_response_wrapper">' + '<div class="lrn_response lrn_clearfix">' + '<div class="lrn_response_input lrn_response_math lrn_response_font_boost">' + '<span class="lrn_math_editable mq-editable-field mq-math-mode">' + '<span class="mq-root-block">' + val + '</span>' + '</div>' + '</div>' + '</div>' + '</div>' + '</div>';
        }
        $(this).replaceWith(mathformulaInputElemHtml);
      });
      $("." + settings.containerClassName + " [id^='command-']").each(function() {
        var id = parseInt($(this).attr('id').replace('command-', ''));
        if (id > commandCounter) {
          commandCounter = id;
        }
      });
      var _this = this;
      $("." + _this.settings.containerClassName + ".mathformula-input-transformed").unbind("click.mathToolbar").bind("click.mathToolbar", function(e) {
        if (!$(e.target).find('.mq-inner-editable').length && !$(e.target).closest('.mq-root-block').find('.mq-inner-editable').length && $(this).find('.lrn_input_ui').is(':visible') === false) {
          $(".lrn_focused").removeClass('lrn_focused');
          $(e.target).closest('.mq-math-mode').addClass('lrn_focused');
          $('.lrn_input_ui').remove();
          $(this).find('.lrn_response').append(_this.buttonsHtml);
          if ($(this).attr('data-responsefield') === 'true') {
            $(this).find("#response_icon").show();
          }
          _this.addEventListeners();
          if ($('.lrn_input_ui').closest('.fillblank').length) {
            $('.lrn_input_ui').css('width', $('.ms-pbl-content').width() + 'px');
          }
          if ($(e.target).hasClass('mq-root-block')) {
            _this.moveCursor($(e.target), 'append');
          } else if ($(e.target).children('.mq-root-block').length) {
            _this.moveCursor($(e.target).find('.mq-root-block'), 'append');
          } else {
            _this.moveCursor($(e.target), 'insertAfter');
          }
          clearInterval(cursorAnimationId);
          cursorAnimationId = setInterval(function() {
            _this.cursorAnimation()
          }, 800);
          e.stopPropagation();
        }
      });
    }
  };
  this.formulaWithInput2mathjs = function() {
    var mainRoot = $('.mathformula-input-transformed .mq-root-block:first').clone();
    if ($('.mathformula-input-transformed .mq-inner-editable').length) {
      mainRoot.find('.mq-inner-editable').each(function() {
        if ($(this).find('.mq-root-block').children().length) {
          $(this).find('.mq-root-block').children().unwrap();
        }
        $(this).children().unwrap();
      });
    }
    return this.formula2mathjs(mainRoot);
  };
  this.formula2mathjs = function(root) {
    var mathjsExpr = '';
    var _this = this;
    if (root.children().length) {
      root.children().each(function() {
        if ($(this).hasClass('mq-fraction')) {
          var numerator = _this.formula2mathjs($(this).find('> .mq-numerator > .mq-empty-box'));
          var denominator = _this.formula2mathjs($(this).find('> .mq-denominator > .mq-empty-box'));
          var mixedNumber = false;
          if (isNaN(mathjsExpr.slice(-1)) === false) {
            var mixedNumber = true;
            var scalarStart = -1;
            while (mathjsExpr.length + scalarStart > 0 && isNaN(mathjsExpr.slice(scalarStart - 1)) === false) {
              scalarStart--;
            }
            mathjsExpr = mathjsExpr.slice(0, scalarStart) + '(' + mathjsExpr.slice(scalarStart);
            if (mathjsExpr.slice(scalarStart) < 0) {
              mathjsExpr += '-';
            } else {
              mathjsExpr += '+';
            }
          }
          mathjsExpr += '(' + numerator + ')/(' + denominator + ')';
          if (mixedNumber === true) {
            mathjsExpr += ')';
          }
        } else if ($(this).hasClass('mq-sup')) {
          var exponent = _this.formula2mathjs($(this).find('> .mq-empty-box'));
          mathjsExpr += '^(' + exponent + ')';
        } else if ($(this).hasClass('mq-sub')) {
          mathjsExpr += '_{' + _this.formula2mathjs($(this).find('> .mq-empty-box')) + '}';
        } else if ($(this).hasClass('mq-sqrt-stem')) {
          var stem = _this.formula2mathjs($(this).find('> .mq-empty-box'));
          var nthRoot = '';
          if ($(this).parent().prev().hasClass('mq-nthroot')) {
            nthRoot = _this.formula2mathjs($(this).parent().prev().find('> .mq-empty-box'));
          } else {
            nthRoot = 2;
          }
          mathjsExpr += 'math.pow(' + stem + '@(1/(' + nthRoot + ')))';
        } else if ($(this).hasClass('mq-abs')) {
          var stem = _this.formula2mathjs($(this).find('> .mq-empty-box'));
          mathjsExpr += 'math.abs(' + stem + ')';
        } else {
          mathjsExpr += _this.formula2mathjs($(this));
        }
      });
    } else {
      if (root.is('var, .scalar_value, .mq-binary-operator, .simple_command, .mq-nonSymbola, .mq-paren, .mq-negatecomparison, .mq-parallelogram-inner')) {
        if (root.text() === '×' || root.text() === '·') {
          return '*';
        } else if (root.text() === '÷') {
          return '/';
        } else {
          return root.text();
        }
      }
    }
    return mathjsExpr;
  };
  this.getPowEndIndex = function(mathjsExpr) {
    var innerBraces = 0;
    for (var i = 0; i < mathjsExpr.length; i++) {
      if (mathjsExpr[i] === '(') {
        innerBraces++;
      }
      if (mathjsExpr[i] === ')') {
        if (innerBraces > 0) {
          innerBraces--;
        } else {
          break;
        }
      }
    }
    return i;
  }
  this.evalPowContent = function(mathjsExpr) {
    var powEval = eval('math.pow(' + this.evalAllPows(mathjsExpr) + ')');
    if (powEval.isComplex) {
      return powEval.im;
    } else {
      return powEval;
    }
  }
  this.evalAllPows = function(mathjsExpr) {
    while (mathjsExpr.indexOf('math.pow(') !== -1) {
      mathjsExpr = mathjsExpr.replace(/@/g, ',');
      var expressionStart = mathjsExpr.substr(0, mathjsExpr.indexOf('math.pow('));
      var expressionEnd = mathjsExpr.substr(mathjsExpr.indexOf('math.pow(') + 9);
      var powEndIndex = this.getPowEndIndex(expressionEnd);
      var powExpression = expressionEnd.substr(0, powEndIndex);
      mathjsExpr = expressionStart + this.evalPowContent(powExpression) + expressionEnd.substr(powEndIndex + 1);
    }
    return mathjsExpr;
  }
  this.changeVariableWithScalar = function(mathjsExpr, variable, evalScalar) {
    mathjsExpr = mathjsExpr.replace(/math.pow/g, '^').replace(/math.abs/g, '|')
    var j = 0;
    while (j < mathjsExpr.length) {
      if (mathjsExpr[j] === variable) {
        if (isNaN(mathjsExpr[j - 1]) === false) {
          mathjsExpr = mathjsExpr.substr(0, j) + '*(' + evalScalar + ')' + mathjsExpr.substr(j + 1);
        } else {
          mathjsExpr = mathjsExpr.substr(0, j) + '(' + evalScalar + ')' + mathjsExpr.substr(j + 1);
        }
      }
      j++;
    }
    mathjsExpr = mathjsExpr.replace(/\)\(/g, ')*(');
    mathjsExpr = mathjsExpr.replace(/\)\^/g, ')*^');
    mathjsExpr = mathjsExpr.replace(/\^/g, 'math.pow');
    mathjsExpr = mathjsExpr.replace(/\@/g, ',');
    mathjsExpr = mathjsExpr.replace(/\)\|/g, ')*|');
    mathjsExpr = mathjsExpr.replace(/\|/g, 'math.abs');
    mathjsExpr = this.addAsterixToExpression(mathjsExpr);
    return mathjsExpr;
  };
  this.getPreviousGroup = function(mathjsExpr) {
    var exponentRoot;
    var expressionStart;
    if (!mathjsExpr[mathjsExpr.length - 1].match(/\)|\]|\}/)) {
      var exponentStartIndex = mathjsExpr.length - 1;
      if (isNaN(mathjsExpr[exponentStartIndex])) {
        exponentRoot = mathjsExpr[exponentStartIndex];
      } else {
        while (isNaN(mathjsExpr.substr(exponentStartIndex)) === false && exponentStartIndex >= 0) {
          exponentStartIndex--;
        }
        exponentRoot = mathjsExpr.substr(exponentStartIndex + 1);
      }
    } else {
      var exponentStartIndex = mathjsExpr.length - 1;
      var innerBraces = 0;
      var found = false;
      var closingTag = mathjsExpr[exponentStartIndex];
      var openingTag;
      switch (closingTag) {
        case ')':
          openingTag = '(';
          break;
        case ']':
          openingTag = '[';
          break;
        case '}':
          openingTag = '}';
          break;
      }
      exponentStartIndex--;
      while (found === false) {
        if (mathjsExpr[exponentStartIndex] === openingTag) {
          if (innerBraces === 0) {
            found = true;
          } else {
            innerBraces--;
          }
        } else if (mathjsExpr[exponentStartIndex] === closingTag) {
          innerBraces++;
        }
        exponentStartIndex--;
      }
      exponentRoot = mathjsExpr.substr(exponentStartIndex + 1);
    }
    expressionStart = mathjsExpr.substr(0, exponentStartIndex + 1);
    if (expressionStart.substr(-8) === 'math.abs') {
      expressionStart = expressionStart.substr(0, expressionStart.length - 8);
      exponentRoot = 'math.abs' + exponentRoot;
    }
    return expressionStart + '(math.pow(' + exponentRoot + ',';
  };
  this.replaceExponent = function(mathjsExpr) {
    var exponent;
    for (var i = 1; i < mathjsExpr.length; i++) {
      if (mathjsExpr[i] === '^') {
        var previousGroup = this.getPreviousGroup(mathjsExpr.substr(0, i));
        var exponentEndIndex = i + 1;
        if (!mathjsExpr[exponentEndIndex].match(/\(|\[|\{/)) {
          while (isNaN(mathjsExpr.substr(i + 1, exponentEndIndex - i)) === false && exponentEndIndex < mathjsExpr.length) {
            exponentEndIndex++;
          }
          exponent = mathjsExpr.substr(exponentEndIndex, exponentEndIndex - 1 - i);
        } else {
          var innerBraces = 0;
          var found = false;
          var openingTag = mathjsExpr[exponentEndIndex];
          var closingTag;
          switch (openingTag) {
            case '(':
              closingTag = ')';
              break;
            case '[':
              closingTag = ']';
              break;
            case '{':
              closingTag = '}';
              break;
          }
          exponentEndIndex++;
          while (found === false) {
            if (mathjsExpr[exponentEndIndex] === closingTag) {
              if (innerBraces === 0) {
                found = true;
              } else {
                innerBraces--;
              }
            } else if (mathjsExpr[exponentEndIndex] === openingTag) {
              innerBraces++;
            }
            exponentEndIndex++;
          }
          exponent = mathjsExpr.substr(i + 1, exponentEndIndex - i - 1);
        }
        mathjsExpr = previousGroup + exponent + '))' + mathjsExpr.substr(exponentEndIndex);
        i++;
      }
    }
    return mathjsExpr;
  };
  this.createPlusMinusExpr = function(mathjsExpr) {
    var mathjsExprArray = [];
    if (mathjsExpr.indexOf('±') !== -1) {
      var firstIndexOfPlusMinus = mathjsExpr.indexOf('±');
      var v1 = mathjsExpr.replace('±', '+');
      var v2 = mathjsExpr.replace('±', '-');
      mathjsExprArray.push(this.createPlusMinusExpr(v1));
      mathjsExprArray.push(this.createPlusMinusExpr(v2));
      mathjsExprArray = [].concat.apply([], mathjsExprArray);
    } else {
      mathjsExprArray.push(mathjsExpr);
    }
    return mathjsExprArray;
  };
  this.replacePercent = function(mathjsExpr, mathjsExpr1, mathjsExpr2) {
    while (mathjsExpr.indexOf('%') !== -1) {
      var unusedAlphabetChar;
      for (var pos in this.settings.alphabet) {
        if ($.inArray(this.settings.alphabet[pos], variablesUnique) !== -1) {
          continue;
        } else {
          variablesUnique.push(this.settings.alphabet[pos]);
          unusedAlphabetChar = this.settings.alphabet[pos];
          break;
        }
      }
      var pos = mathjsExpr.indexOf('%');
      var toReplace;
      if (pos === mathjsExpr.length - 1 || mathjsExpr[pos + 1].match(/\(|\*|\+|\-|\/|\±|\^|\s/)) {
        toReplace = '%';
      } else {
        toReplace = '%' + mathjsExpr[pos + 1];
      }
      var reg = new RegExp(toReplace, 'g');
      mathjsExpr = mathjsExpr.replace(reg, unusedAlphabetChar);
      mathjsExpr1 = mathjsExpr1.replace(reg, unusedAlphabetChar);
      mathjsExpr2 = mathjsExpr2.replace(reg, unusedAlphabetChar);
    }
    var ret = new Array();
    ret[0] = mathjsExpr1;
    ret[1] = mathjsExpr2;
    return ret;
  };
  this.addAsterixToExpression = function(mathjsExpr) {
    for (var i = 1; i < mathjsExpr.length; i++) {
      if (mathjsExpr[i].match(/\(|\[|\{/) && isNaN(mathjsExpr[i - 1]) === false) {
        mathjsExpr = this.addAsterixToExpressionPosition(mathjsExpr, i);
        i++;
      }
      if (mathjsExpr[i].match(/\)|\]|\}/) && isNaN(mathjsExpr[i + 1]) === false) {
        mathjsExpr = this.addAsterixToExpressionPosition(mathjsExpr, i + 1);
        i++;
      }
    }
    return mathjsExpr;
  }
  this.addAsterixToExpressionPosition = function(mathjsExpr, pos) {
    return mathjsExpr.substr(0, pos) + '*' + mathjsExpr.substr(pos);
  }
  this.replacePi = function(mathjsExpr) {
    for (var i = 1; i < mathjsExpr.length; i++) {
      if (mathjsExpr[i] === 'π' && !mathjsExpr[i - 1].match(/\(|\*|\+|\-|\/|\±/)) {
        mathjsExpr = this.addAsterixToExpressionPosition(mathjsExpr, i++);
      }
    }
    mathjsExpr = mathjsExpr.replace(/\*π/g, '*3.141592653589793');
    mathjsExpr = mathjsExpr.replace(/π/g, '3.141592653589793');
    return mathjsExpr;
  }
  this.compareExpressionParts = function(mathjsExpr1, mathjsExpr2, compareOptions) {
    if (mathjsExpr1 === "" || mathjsExpr2 === "") {
      return (mathjsExpr1 === mathjsExpr2);
    }
    if (mathjsExpr1.indexOf('^') !== -1) {
      mathjsExpr1 = this.replaceExponent(mathjsExpr1);
    }
    if (mathjsExpr2.indexOf('^') !== -1) {
      mathjsExpr2 = this.replaceExponent(mathjsExpr2);
    }
    if (mathjsExpr1.indexOf('π') !== -1) {
      mathjsExpr1 = this.replacePi(mathjsExpr1);
    }
    if (mathjsExpr2.indexOf('π') !== -1) {
      mathjsExpr2 = this.replacePi(mathjsExpr2);
    }
    if (compareOptions.evalMethod === "1") {
      var mathjsExpr = (mathjsExpr1 + ' ' + mathjsExpr2)
      mathjsExpr = mathjsExpr.replace(/math.pow/g, '');
      mathjsExpr = mathjsExpr.replace(/math.abs/g, '');
      var variables = mathjsExpr.split('').filter(function(n) {
        return this.settings.alphabet.indexOf(n) !== -1;
      }.bind(this));
      $.each(variables, function(i, el) {
        if ($.inArray(el, variablesUnique) === -1) {
          variablesUnique.push(el);
        }
      });
      if (variablesUnique.length) {
        if (mathjsExpr.indexOf('%') !== -1) {
          var res = this.replacePercent(mathjsExpr, mathjsExpr1, mathjsExpr2);
          mathjsExpr1 = res[0];
          mathjsExpr2 = res[1];
        }
        var scalarArray = new Array();
        for (var i = 0; i < this.settings.maxVariables * this.settings.testCycles; i++) {
          scalarArray[i] = i + 2;
        }
        var evalRatios = new Array();
        for (var j = 0; j < this.settings.testCycles; j++) {
          var mathjsExpr1Eval = mathjsExpr1;
          var mathjsExpr2Eval = mathjsExpr2;
          for (var variable in variablesUnique) {
            var evalScalarIndex = Math.floor(Math.random() * this.settings.maxVariables);
            var evalScalar = scalarArray.splice(evalScalarIndex, 1)[0];
            mathjsExpr1Eval = this.changeVariableWithScalar(mathjsExpr1Eval, variablesUnique[variable], evalScalar);
            mathjsExpr2Eval = this.changeVariableWithScalar(mathjsExpr2Eval, variablesUnique[variable], evalScalar);
          }
          mathjsExpr1Eval = this.evalAllPows(mathjsExpr1Eval);
          mathjsExpr2Eval = this.evalAllPows(mathjsExpr2Eval);
          var mathjsExpr1EvalArray = this.createPlusMinusExpr(mathjsExpr1Eval);
          var mathjsExpr2EvalArray = this.createPlusMinusExpr(mathjsExpr2Eval);
          for (var i = 0; i < mathjsExpr1EvalArray.length; i++) {
            for (var x = 0; x < mathjsExpr2EvalArray.length; x++) {
              try {
                var eval1 = eval(mathjsExpr1EvalArray[i]).toFixed(5);
                var eval2 = eval(mathjsExpr2EvalArray[x]).toFixed(5);
                evalRatios[j] = eval1 / eval2;
                if (Math.sign(eval1) !== Math.sign(eval2) || (j > 0 && evalRatios[j] !== evalRatios[j - 1])) {
                  return false;
                }
              } catch (err) {
                return false;
              }
            }
          }
        }
        return true;
      } else {
        mathjsExpr1 = this.evalAllPows(mathjsExpr1);
        mathjsExpr2 = this.evalAllPows(mathjsExpr2);
        mathjsExpr1 = this.addAsterixToExpression(mathjsExpr1);
        mathjsExpr2 = this.addAsterixToExpression(mathjsExpr2);
        var mathjsExpr1EvalArray = this.createPlusMinusExpr(mathjsExpr1);
        var mathjsExpr2EvalArray = this.createPlusMinusExpr(mathjsExpr2);
        for (var i = 0; i < mathjsExpr1EvalArray.length; i++) {
          for (var x = 0; x < mathjsExpr2EvalArray.length; x++) {
            try {
              var eval1 = eval(mathjsExpr1EvalArray[i]).toFixed(compareOptions.significantDecimals);
              var eval2 = eval(mathjsExpr2EvalArray[x]).toFixed(compareOptions.significantDecimals);
              if (parseFloat(eval1) !== parseFloat(eval2)) {
                return false;
              }
            } catch (err) {
              return false;
            }
          }
        }
        return true;
      }
    } else if (compareOptions.evalMethod === "2") {
      var subExpr1Array = this.getLiteralSubExpressions(mathjsExpr1, compareOptions);
      var subExpr2Array = this.getLiteralSubExpressions(mathjsExpr2, compareOptions);
      while (subExpr1Array.length) {
        var found = false;
        var elem1 = subExpr1Array[0];
        subExpr1Array.splice(0, 1);
        var idx2 = 0;
        while (idx2 < subExpr2Array.length) {
          if (elem1 === subExpr2Array[idx2]) {
            subExpr2Array.splice(idx2, 1);
            found = true;
            break;
          }
          idx2++;
        }
        if (found === false) {
          return false;
        }
      }
      if (subExpr1Array.length !== 0 || subExpr2Array.length !== 0) {
        return false;
      } else {
        return true;
      }
    }
  };
  this.getLiteralSubExpressions = function(mathjsExpr, compareOptions) {
    var subExprArray = mathjsExpr.split(/\+|-|\*/);
    var idx = 0;
    while (idx < subExprArray.length) {
      if (subExprArray[idx] === "") {
        subExprArray.splice(idx, 1);
      } else {
        var pos = mathjsExpr.indexOf(subExprArray[idx]);
        var formattedSubExpr = subExprArray[idx];
        if (compareOptions.ignoreCommas === true) {
          formattedSubExpr = formattedSubExpr.replace(/,/g, '');
        }
        if (compareOptions.ignoreCoefficientOne === true) {
          formattedSubExpr = this.removeCoefficientOne(formattedSubExpr);
        }
        if (compareOptions.ignoreTrailingZeros === true) {
          formattedSubExpr = this.removeTrailingZeros(formattedSubExpr);
        }
        if (pos === 0) {
          subExprArray[idx] = '+' + formattedSubExpr;
        } else {
          if (mathjsExpr[pos - 1] === '-') {
            subExprArray[idx] = '-' + formattedSubExpr;
          } else {
            subExprArray[idx] = '+' + formattedSubExpr;
          }
        }
        idx++;
      }
    }
    return subExprArray;
  };
  this.compareAllExpressionParts = function(mathjsExpr1, mathjsExpr2, reverse, compareOptions) {
    var expressionParts1 = mathjsExpr1.split(/=|<|>|≤|≥/);
    var expressionParts2 = mathjsExpr2.split(/=|<|>|≤|≥/);
    var compareOperators1 = mathjsExpr1.replace(/[^=<>≤≥]/g, '');
    var compareOperators2 = mathjsExpr2.replace(/[^=<>≤≥]/g, '');
    if (reverse === true) {
      var compareOperators2Reverse = compareOperators2.split("").reverse().join("");
      compareOperators2Reverse = compareOperators2Reverse.replace(/>/g, 'greaterthan');
      compareOperators2Reverse = compareOperators2Reverse.replace(/</g, '>');
      compareOperators2Reverse = compareOperators2Reverse.replace(/greaterthan/g, '<');
      compareOperators2Reverse = compareOperators2Reverse.replace(/≥/g, 'greaterorbiggerthan');
      compareOperators2Reverse = compareOperators2Reverse.replace(/≤/g, '≥');
      compareOperators2 = compareOperators2Reverse.replace(/greaterorbiggerthan/g, '≤');
      expressionParts2 = expressionParts2.reverse();
    }
    if (compareOperators1 !== compareOperators2) {
      return false;
    }
    for (var i = 0; i < expressionParts1.length; i++) {
      var expressionPartsFinal1 = expressionParts1[i];
      var expressionPartsFinal2 = expressionParts2[i];
      if (compareOptions.evalMethod === "1" && expressionParts1.length > 1 && i < expressionParts1.length - 1) {
        expressionPartsFinal1 = expressionParts1[i] + '-(' + expressionParts1[i + 1] + ')';
        expressionPartsFinal2 = expressionParts2[i] + '-(' + expressionParts2[i + 1] + ')';
        if (i == expressionParts1.length - 2) {
          i++;
        }
      }
      if (this.compareExpressionParts(expressionPartsFinal1, expressionPartsFinal2, compareOptions) === false) {
        return false;
      }
    }
    return true;
  };
  this.removeCoefficientOne = function(mathjsExpr) {
    var pos = 0;
    while (pos <= mathjsExpr.length) {
      if (mathjsExpr[pos] === '1') {
        if ((pos === 0 || isNaN(mathjsExpr[pos - 1]) === true) && (pos === mathjsExpr.length || isNaN(mathjsExpr[pos + 1]) === true)) {
          if (pos < mathjsExpr.length && mathjsExpr[pos + 1] === '*') {
            mathjsExpr = mathjsExpr.slice(0, pos) + mathjsExpr.slice(pos + 2);
          } else {
            mathjsExpr = mathjsExpr.slice(0, pos) + mathjsExpr.slice(pos + 1);
          }
        }
      }
      pos++;
    }
    return mathjsExpr;
  };
  this.removeTrailingZeros = function(mathjsExpr) {
    var pos = 0;
    var result = "";
    while (pos < mathjsExpr.length) {
      result += mathjsExpr[pos];
      if (mathjsExpr[pos] === '.') {
        var numStartPos = pos;
        var numEndPos = mathjsExpr.substr(numStartPos + 1).search(/[^0-9]/);
        if (numEndPos !== -1) {
          numEndPos += numStartPos;
        } else {
          numEndPos = mathjsExpr.length;
        }
        var number = mathjsExpr.substring(numStartPos + 1, numEndPos).replace(/0+$/, "");
        result += number;
        pos = numEndPos;
      }
      pos++;
    }
    return result;
  };
  this.compareExpressions = function(mathjsExpr1, mathjsExpr2, compareOptions) {
    mathjsExpr1 = mathjsExpr1.replace(/\s+/g, '');
    mathjsExpr2 = mathjsExpr2.replace(/\s+/g, '');
    if (compareOptions.evalMethod === "1") {
      mathjsExpr1 = mathjsExpr1.replace(/,/g, '');
      mathjsExpr2 = mathjsExpr2.replace(/,/g, '');
      variablesUnique = new Array();
      return (this.compareAllExpressionParts(mathjsExpr1, mathjsExpr2, false, compareOptions) || this.compareAllExpressionParts(mathjsExpr1, mathjsExpr2, true, compareOptions));
    } else if (compareOptions.evalMethod === "2") {
      if (compareOptions.ignoreOrder === false) {
        if (compareOptions.ignoreCommas === true) {
          mathjsExpr1 = mathjsExpr1.replace(/,/g, '');
          mathjsExpr2 = mathjsExpr2.replace(/,/g, '');
        }
        if (compareOptions.ignoreCoefficientOne === true) {
          mathjsExpr1 = this.removeCoefficientOne(mathjsExpr1);
          mathjsExpr2 = this.removeCoefficientOne(mathjsExpr2);
        }
        if (compareOptions.ignoreTrailingZeros === true) {
          mathjsExpr1 = this.removeTrailingZeros(mathjsExpr1);
          mathjsExpr2 = this.removeTrailingZeros(mathjsExpr2);
        }
        return mathjsExpr1 === mathjsExpr2;
      } else {
        return (this.compareAllExpressionParts(mathjsExpr1, mathjsExpr2, false, compareOptions) || this.compareAllExpressionParts(mathjsExpr1, mathjsExpr2, true, compareOptions));
      }
    }
  };
  this.hasEmptyFormulaInputs = function() {
    var hasEmpty = false;
    $("." + this.settings.containerClassName + " .mq-root-block").each(function() {
      if ($(this).html() === "") {
        hasEmpty = true;
        return false;
      }
    });
    return hasEmpty;
  };
};
if (typeof module === "object" && module.exports) {
  module.exports = MathToolbarClass;
}
'use strict';

function FluencyGameWrapper(selector, options) {
  this.selector = selector;
  this.defaults = {
    problem: {},
    answers: [],
    debug: false,
    onAnswerEnter: function() {
      return true;
    },
    onDecrementCounter: function() {}
  };
  this.settings = $.extend({}, this.defaults, options);
  if (typeof this.settings.problem['FGP'] != 'undefined') {
    this.settings.answers = this.settings.problem['FGP']['Answers'];
    this.init();
  }
}
FluencyGameWrapper.prototype = new FluencyGameWrapper();
FluencyGameWrapper.prototype.constructor = FluencyGameWrapper;
FluencyGameWrapper.prototype.init = function() {
  if (typeof this.marquee != 'undefined') {
    delete this.marquee;
  }
  this.marquee = new this.constructor.Marquee(this.selector, this.settings);
};
FluencyGameWrapper.prototype.setAnimationStopped = function(flag) {
  this.marquee.animationStopped = flag;
};
FluencyGameWrapper.prototype.stopAnimation = function() {
  this.marquee.stop();
};
(function(wrapper) {
  function Marquee(selector) {
    this.selector = selector;
    this.parentWidth = 0;
    this.parentHeight = 0;
    this.currentElementIndex = 0;
    this.currentElement = null;
    this.currentElementData = {};
    this.currentAnimationStartTime = 0;
    this.currentAnimationEndTime = 0;
    this.animationStopped = false;
    this.maxValue = 0;
    this.startValue = 0;
    this.elementSize = 0;
    this.elements = [];
    var defaultConfig = {
      pauseSpeed: 2500,
      entrySpeed: 1250,
      exitSpeed: 1250,
      elementClass: 'ms-pbl-fluency-game-element',
      shuffleOrder: true,
      debug: false
    };
    var params = (arguments.length > 1) ? arguments[1] : {};
    this.settings = $.extend({}, defaultConfig, params);
    if (this.settings.answers.length > 0) {
      this.init();
    }
  };
  Marquee.prototype.constructor = Marquee;
  Marquee.prototype.init = function() {
    this.parentWidth = $(this.selector).width();
    this.parentHeight = $(this.selector).height();
    var tmpElements = $(this.selector).find('.' + this.settings.elementClass);
    if (this.settings.shuffleOrder) {
      tmpElements = $(this.selector).find('.' + this.settings.elementClass).sort(function() {
        return (Math.round(Math.random()) - 0.5);
      });
    }
    for (var i = 0; i < tmpElements.length; i++) {
      this.elements.push({
        'element': tmpElements[i],
        'elementData': this.settings.answers[i]
      });
      if ($(tmpElements[i]).find('img.ms-pbl-fluency-game-answer-image').length == 0) {
        $(tmpElements[i]).prepend('<img class="ms-pbl-fluency-game-answer-image" src="' + this.settings.answers[i]['AnswerName'] + '" />');
        $(tmpElements[i]).find(".ms-pbl-fluency-game-element-inner").css({
          'top': this.settings.answers[i]['AnswerFontY'],
          'left': this.settings.answers[i]['AnswerFontX'],
          'width': this.settings.answers[i]['AnswerTextWidth'],
          'height': this.settings.answers[i]['AnswerTextHeight'],
        }).addClass('font-' + this.settings.answers[i]['AnswerFont']);
      }
    }
    this.hideElements();
    if (!$(this.selector).find('.pbl-fluency-skip').length) {
      $(this.selector).append('<div class="pbl-fluency-skip"><div><div>Next Answer</div></div></div>');
      $(this.selector).find('.pbl-fluency-skip').unbind('click').bind('click', this.skipAction.bind(this));
    }
  };
  Marquee.prototype.hideElements = function() {
    for (var idx = 0; idx < this.elements.length; idx++) {
      $(this.elements[idx]['element']).hide();
    }
  };
  Marquee.prototype.incrementCurrentElementIndex = function() {
    if (this.currentElementIndex + 1 < this.elements.length) {
      this.currentElementIndex++;
    } else {
      this.currentElementIndex = 0;
      this.settings.onDecrementCounter.call(this);
    }
  };
  Marquee.prototype.getRandomInt = function(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
  };
  Marquee.prototype.getRandomHorizontalPosition = function() {
    return this.getRandomInt(0, (this.parentWidth - this.currentElement.width()));
  };
  Marquee.prototype.getRandomVerticalPosition = function() {
    return this.getRandomInt(0, (this.parentHeight - this.currentElement.height()));
  };
  Marquee.prototype.setCurrentElement = function() {
    this.currentElement = $(this.elements[this.currentElementIndex]['element']);
    this.currentElementData = this.elements[this.currentElementIndex]['elementData'];
    this.currentElement.css({
      'top': 0,
      'left': 0
    });
    this.currentElement.show();
    var curElementCssProps = {};
    curElementCssProps.width = this.currentElement.width();
    curElementCssProps.height = this.currentElement.height();
    if (['LeftToRight', 'RightToLeft'].indexOf(this.currentElementData.MotionName) != -1) {
      this.elementSize = this.currentElement.width();
      if (this.currentElementData.MotionName == 'RightToLeft') {
        this.maxValue = 0;
        this.startValue = this.parentWidth;
      } else if (this.currentElementData.MotionName == 'LeftToRight') {
        this.startValue = -this.elementSize;
        this.maxValue = this.parentWidth;
      }
      curElementCssProps.left = this.startValue;
      curElementCssProps.top = (this.currentElementData.StartY) ? this.currentElementData.StartY : this.getRandomVerticalPosition();
    } else if (['TopToBottom', 'BottomToTop'].indexOf(this.currentElementData.MotionName) != -1) {
      this.elementSize = this.currentElement.height();
      if (this.currentElementData.MotionName == 'BottomToTop') {
        this.startValue = this.parentHeight;
        this.maxValue = 0;
      } else if (this.currentElementData.MotionName == 'TopToBottom') {
        this.startValue = -this.elementSize;
        this.maxValue = this.parentHeight;
      }
      curElementCssProps.top = this.startValue;
      curElementCssProps.left = (this.currentElementData.StartX) ? this.currentElementData.StartX : this.getRandomHorizontalPosition();
    } else if (this.currentElementData.MotionName == 'PopFromTop') {
      this.elementSize = this.currentElement.height();
      this.maxValue = 0;
      this.startValue = -this.elementSize;
      curElementCssProps.top = this.startValue;
      curElementCssProps.left = (this.currentElementData.StartX) ? this.currentElementData.StartX : this.getRandomHorizontalPosition();
    } else if (this.currentElementData.MotionName == 'PopFromBottom') {
      this.elementSize = this.currentElement.height();
      this.maxValue = this.parentHeight - this.elementSize;
      this.startValue = this.parentHeight;
      curElementCssProps.top = this.startValue;
      curElementCssProps.left = (this.currentElementData.StartX) ? this.currentElementData.StartX : this.getRandomHorizontalPosition();
    } else if (this.currentElementData.MotionName == 'PopFromLeft') {
      this.elementSize = this.currentElement.width();
      this.maxValue = 0;
      this.startValue = -this.elementSize;
      curElementCssProps.top = (this.currentElementData.StartY) ? this.currentElementData.StartY : this.getRandomVerticalPosition();
      curElementCssProps.left = this.startValue;
    } else if (this.currentElementData.MotionName == 'PopFromRight') {
      this.elementSize = this.currentElement.width();
      this.maxValue = this.parentWidth - this.elementSize;
      this.startValue = this.parentWidth;
      curElementCssProps.top = (this.currentElementData.StartY) ? this.currentElementData.StartY : this.getRandomVerticalPosition();
      curElementCssProps.left = this.startValue;
    }
    this.currentElement.css(curElementCssProps);
    if (this.settings.debug) {
      console.log('AnswerID: ' + this.currentElementData.pkFGPScreenAnswerID + ', MotionName: ' + this.currentElementData.MotionName + ': ', curElementCssProps);
    }
  };
  Marquee.prototype.getAnimationTargets = function() {
    var animationTargets = [{}, {}];
    if (this.currentElementData.MotionName == 'RightToLeft') {
      var distance = this.startValue - this.elementSize;
      animationTargets[0] = {
        'left': (distance / 2)
      };
      animationTargets[1] = {
        'left': -this.elementSize
      };
    } else if (this.currentElementData.MotionName == 'LeftToRight') {
      var distance = this.maxValue - this.elementSize;
      animationTargets[0] = {
        'left': (distance / 2)
      };
      animationTargets[1] = {
        'left': +this.maxValue
      };
    } else if (this.currentElementData.MotionName == 'BottomToTop') {
      var distance = this.startValue - this.elementSize;
      animationTargets[0] = {
        'top': (distance / 2)
      };
      animationTargets[1] = {
        'top': -this.elementSize
      };
    } else if (this.currentElementData.MotionName == 'TopToBottom') {
      var distance = this.maxValue - this.elementSize;
      animationTargets[0] = {
        'top': (distance / 2)
      };
      animationTargets[1] = {
        'top': this.maxValue
      };
    } else if (this.currentElementData.MotionName == 'PopFromTop') {
      animationTargets[0] = {
        'top': this.maxValue
      };
      animationTargets[1] = {
        'top': this.startValue
      };
    } else if (this.currentElementData.MotionName == 'PopFromBottom') {
      animationTargets[0] = {
        'top': this.maxValue
      };
      animationTargets[1] = {
        'top': this.startValue
      };
    } else if (this.currentElementData.MotionName == 'PopFromLeft') {
      animationTargets[0] = {
        'left': this.maxValue
      };
      animationTargets[1] = {
        'left': this.startValue
      };
    } else if (this.currentElementData.MotionName == 'PopFromRight') {
      animationTargets[0] = {
        'left': this.maxValue
      };
      animationTargets[1] = {
        'left': this.startValue
      };
    }
    return animationTargets;
  };
  Marquee.prototype.scroll = function() {
    if (this.settings.debug) {
      console.log(this.currentElementData.MotionName, 'timeFirst: ' + this.settings.entrySpeed, 'timeSecond: ' + this.settings.exitSpeed);
    }
    if (this.currentAnimation == 'first') {
      var duration = this.settings.entrySpeed;
      if (this.currentAnimationEndTime > 0) {
        duration = (this.settings.entrySpeed - (this.currentAnimationEndTime - this.currentAnimationStartTime))
      }
      this.currentElement.animate(this.currentAnimationTargets[0], {
        duration: duration,
        easing: 'linear',
        start: function() {
          this.currentAnimationStartTime = new Date().getTime();
        }.bind(this),
        always: function() {
          this.currentAnimationEndTime = new Date().getTime();
        }.bind(this),
        complete: function() {
          if (!this.animationStopped) {
            this.currentAnimationEndTime = 0;
            var tmpSoundSetting = (typeof G_SoundSetting != 'undefined') ? G_SoundSetting : app.labObject.soundSetting;
            if ((tmpSoundSetting == 2 || ([1, 3].indexOf(tmpSoundSetting) != -1 && app.labObject.hasProblemSoundPlayed())) && !app.labObject.isSoundPlaying()) {
              this.settings.onAnswerEnter.call(this, this.currentElement);
            }
            this.currentAnimation = 'second';
            $.when(this.currentElement.delay(this.settings.pauseSpeed)).done(function() {
              this.currentAnimationEndTime = 0;
              if (!this.animationStopped) {
                duration = this.settings.exitSpeed;
                if (this.currentAnimationEndTime > 0) {
                  duration = (this.settings.exitSpeed - (this.currentAnimationEndTime - this.currentAnimationStartTime))
                }
                this.currentElement.animate(this.currentAnimationTargets[1], {
                  duration: duration,
                  easing: 'linear',
                  start: function() {
                    this.currentAnimationStartTime = new Date().getTime();
                  }.bind(this),
                  always: function() {
                    this.currentAnimationEndTime = new Date().getTime();
                  }.bind(this),
                  complete: this.callback.bind(this)
                });
              }
            }.bind(this));
          }
        }.bind(this)
      });
    } else if (this.currentAnimation == 'second') {
      if (!this.animationStopped) {
        duration = this.settings.exitSpeed;
        if (this.currentAnimationEndTime > 0) {
          duration = (this.settings.exitSpeed - (this.currentAnimationEndTime - this.currentAnimationStartTime))
        }
        this.currentElement.animate(this.currentAnimationTargets[1], {
          duration: duration,
          easing: 'linear',
          start: function() {
            this.currentAnimationStartTime = new Date().getTime();
          }.bind(this),
          always: function() {
            this.currentAnimationEndTime = new Date().getTime();
          }.bind(this),
          complete: this.callback.bind(this)
        });
      }
    }
  };
  Marquee.prototype.skipAction = function() {
    if (this.currentAnimation == 'second') {
      this.currentElement.dequeue();
    }
    if (this.currentAnimation != 'second' || (this.currentAnimation == 'second' && !$(this.currentElement).is(':animated'))) {
      this.currentElement.stop(true, false);
      this.currentElement.animate(this.currentAnimationTargets[0], {
        duration: 0,
        easing: 'linear'
      });
      this.currentAnimation = 'second';
      this.scroll();
    }
  };
  Marquee.prototype.callback = function() {
    if (!this.animationStopped) {
      this.currentAnimationEndTime = 0;
      this.currentElement.hide();
      this.incrementCurrentElementIndex();
      this.setCurrentElement();
      this.currentAnimation = 'first';
      this.currentAnimationTargets = this.getAnimationTargets();
      this.scroll();
    }
  };
  Marquee.prototype.toggleSkip = function() {
    if ($(this.selector).find('.pbl-fluency-skip').is(':visible')) {
      $(this.selector).find('.pbl-fluency-skip').hide();
    } else {
      $(this.selector).find('.pbl-fluency-skip').show();
    }
  };
  Marquee.prototype.start = function() {
    this.animationStopped = false;
    this.hideElements();
    this.setCurrentElement();
    this.currentAnimation = 'first';
    this.currentAnimationTargets = this.getAnimationTargets();
    this.toggleSkip();
    this.scroll();
  };
  Marquee.prototype.stop = function() {
    if (this.currentElement) {
      this.animationStopped = true;
      this.currentElement.stop(true, false);
      this.toggleSkip();
    }
  };
  wrapper.Marquee = Marquee;
})(FluencyGameWrapper);
if (typeof module === "object" && module.exports) {
  module.exports = FluencyGameWrapper;
}

function AddPunctuation(selector, options) {
  this.selector = selector;
  this.currentElement = null;
  this.defaults = {
    container: null,
    acceptDropClass: 'ela-punctuation-spot',
    interactEvent: null
  };
  this.settings = $.extend({}, this.defaults, options);
  if (typeof this.selector != 'undefined') {
    this.init();
  }
}
AddPunctuation.prototype = new AddPunctuation();
AddPunctuation.prototype.constructor = AddPunctuation;
AddPunctuation.prototype.init = function() {
  var _this = this;
  this.activateDrag();
  $(this.selector + ' .charts-element-type[data-element-type="delete"]').bind('click', function(e) {
    $(_this.selector + ' .ela-punctuation-spot').html('');
  });
};
AddPunctuation.prototype.activateDrag = function() {
  var oldTarget = null;
  var _this = this;
  $(this.selector + ' .charts-element-type:not([data-element-type="delete"]), ' + this.selector + ' .ela-punctuation-added').dragdrop('destroy');
  $(this.selector + ' .charts-element-type:not([data-element-type="delete"]), ' + this.selector + ' .ela-punctuation-added').dragdrop({
    makeClone: true,
    sourceHide: true,
    appendDraggedTo: $('body'),
    dragClass: 'ela-punctuation-dragged',
    container: (this.settings.container) ? $(this.settings.container) : null,
    canDrag: function($src, e) {
      var tmp = null;
      if ($(e.target).hasClass('ela-punctuation-added')) {
        tmp = $src;
        _this.currentElement = 'old';
      } else {
        var hasDelete = $(e.target).parent().attr('data-element-type');
        tmp = (hasDelete == 'delete') ? null : $src;
        _this.currentElement = 'new';
      }
      if (_this.settings.interactEvent != null) {
        $(document).trigger(_this.settings.interactEvent);
      }
      return tmp;
    },
    onMove: function(e, $activeElement) {
      var posX, posY;
      if (e.type == "touchmove") {
        posX = e.originalEvent.touches[0].clientX;
        posY = e.originalEvent.touches[0].clientY;
      } else {
        posX = e.pageX;
        posY = e.pageY;
      }
      var destElement = this.getDropTarget($activeElement, posX, posY);
      if (oldTarget) {
        oldTarget.removeClass('focused');
      }
      if ($(destElement).hasClass(_this.settings.acceptDropClass)) {
        oldTarget = $(destElement);
        oldTarget.addClass('focused');
      }
    },
    canDrop: function($dst) {
      return (_this.currentElement == 'new') ? ($dst.hasClass(_this.settings.acceptDropClass) || ($dst.parents('.' + _this.settings.acceptDropClass).size()) > 0) : true;
    },
    didDrop: function($src, $dst, e) {
      if (_this.currentElement == 'new') {
        $dst.html($('<span class="ela-punctuation-added">').html($src.text().trim()));
      } else if (_this.currentElement == 'old') {
        if ($dst.hasClass(_this.settings.acceptDropClass) || ($dst.parents('.' + _this.settings.acceptDropClass).size()) > 0) {
          $dst.html($('<span class="ela-punctuation-added">').html($src.text().trim()));
        }
        $src.remove();
      }
    },
    afterDrop: function($src, $dst, e) {
      if (oldTarget) {
        oldTarget.removeClass('focused');
      }
      _this.activateDrag();
    }
  });
};
AddPunctuation.prototype.getAnswer = function() {
  return $(this.selector + ' .main-add-punctuation').find('.ela-punctuation-spot').map(function() {
    return $(this).text();
  }).get().join('|');
};
AddPunctuation.prototype.hasAnswer = function() {
  return $.inArray(true, $(this.selector + ' .main-add-punctuation').find('.ela-punctuation-spot').map(function() {
    return ($(this).text().length != 0) ? true : false;
  }).get()) != -1;
};
if (typeof module === "object" && module.exports) {
  module.exports = AddPunctuation;
}
var labProblem = {
  imagesLoadedPromise: $.Deferred(),
  subject: '',
  playIcons: '.play_icon, .play_icon_statement, .play_icon_mc, .play_icon_img, .play_icon_caption, .play_icon_fb, .play_icon_explore' + ', .lab-problem .pbl-large-sound-icon, .lab-problem .pbl-large-sound-icon .large_play_icon',
  init: function() {
    this.imagesLoadedPromise = $.Deferred();
  },
  needsSound: function() {
    return ($('.lab-problem .pbl-large-sound-icon').length > 0);
  },
  showPlayIcons: function() {
    $(this.playIcons).not('.do-not-show').show()
  },
  hidePlayIcons: function() {
    $(this.playIcons).hide();
  },
  imageLoadRetry: function(container, onLoadedCallback) {
    var $img = $(container + ' img:not(' + this.playIcons + ')');
    $img.each(function(i, e) {
      var src = $(e).attr('src');
      $(e).attr('src', src.replace(/(GifImg.gif)\?*[^'"]*/g, '$1?' + Math.random()));
      if (src.indexOf('.gif') > 0 && /(firefox|ipad|iphone|ipod)/g.test(navigator.userAgent.toLowerCase())) {
        var imgEl = $(e)[0];
        var imgInterval = setInterval(function() {
          if (imgEl.naturalWidth) {
            clearInterval(imgInterval);
            $(e).trigger('load');
          }
        }, 200);
      }
    });
    $img.attr('data-retries', '0').attr('onclick', 'this.setAttribute("data-retries", parseInt(this.getAttribute("data-retries"))+1);this.setAttribute("src", this.getAttribute("src"));').attr('onerror', 'if (parseInt(this.getAttribute("data-retries")) < 3) { this.setAttribute("data-retries", parseInt(this.getAttribute("data-retries"))+1);this.setAttribute("src", this.getAttribute("src")); }').attr('onload', 'this.removeAttribute("onclick")').filter(function() {
      return this.complete;
    }).each(onLoadedCallback).end().load(onLoadedCallback);
    return $img.length ? $img.length : 0;
  },
  imagesLoaded: function(container) {
    var _this = this;
    if (this.imagesLoadedPromise.state() == 'resolved') {
      this.imagesLoadedPromise = $.Deferred();
    }
    var imgTotal = $(container + ' img:not(' + this.playIcons + ')').length;
    var imgLoaded = 0;
    this.imageLoadRetry(container, function() {
      var $image = $(this);
      if (!$image.attr('onload')) return;
      $image.removeAttr('onload');
      var src = $image.attr('src');
      if (src.indexOf('.gif') > 0 && navigator.userAgent.toLowerCase().indexOf('firefox') < 0) {
        $image.attr('src', src);
      }
      if (++imgLoaded >= imgTotal) _this.imagesLoadedPromise.resolve({
        imageCount: imgTotal,
        timestamp: new Date().getTime()
      });
    });
    if (imgTotal <= 0) this.imagesLoadedPromise.resolve({
      imageCount: imgTotal,
      timestamp: new Date().getTime()
    });
    return this.imagesLoadedPromise.promise();
  },
  resizeImages: function(container, maxWidth) {
    var $img = $(container + ' img:not(' + this.playIcons + '), ' + container + ' iframe.mobyPlayer');
    $img.each(function(i, e) {
      var $e = $(e);
      var parentWidth = Math.min($e.parent().width(), maxWidth);
      if ($e.width() >= parentWidth) {
        $e.css({
          'max-width': '',
          'width': parentWidth + 'px',
          'height': 'auto'
        });
      } else {
        $e.css({
          'max-width': parentWidth + 'px',
          'width': '',
          'height': 'auto'
        });
      }
    });
  },
  resizeVideo: function(container, maxWidth) {
    var $video = $(container + ' iframe.mobyPlayer');
    $video.each(function(i, e) {
      var $e = $(e);
      var parentWidth = Math.min($e.parent().width(), maxWidth);
      if ($e.width() >= parentWidth) {
        $e.css({
          'max-width': '',
          'width': parentWidth + 'px',
          'height': 'auto'
        });
      } else {
        $e.css({
          'max-width': parentWidth + 'px',
          'width': '',
          'height': 'auto'
        });
      }
    });
  },
  autoResizeImages: function(container, parentSelector) {
    $('#problem-div .problem-statement-d').css('visibility', 'hidden');
    if (this.imageLoadRetry(container, function() {
        this.resizeImages(container, $(parentSelector).width());
        $('#problem-div .problem-statement-d').css('visibility', 'visible');
      }.bind(this)) <= 0) {
      $('#problem-div .problem-statement-d').css('visibility', 'visible');
    }
    if ($('#problem-div .problem-statement-d iframe.mobyPlayer').length > 0) {
      this.resizeVideo(container, $(parentSelector).width());
      $('#problem-div .problem-statement-d').css('visibility', 'visible');
    }
  },
  isChrome: function() {
    var regex = /Chrome\/[0-9]{1,2}\.[0-9]/;
    var matches = navigator.userAgent.match(regex);
    return (matches != null && matches.length == 1)
  },
  hasFeatureMathML: function() {
    MATHML_FEATURE = "org.w3c.dom.mathml";
    MATHML_FEATURE_VERSION = "2.0";
    if (this.isChrome()) return false;
    return document.implementation.hasFeature(MATHML_FEATURE, MATHML_FEATURE_VERSION);
  },
  initMathML: function() {
    if (this.hasFeatureMathML()) {
      return true;
    }
    var id = 'MathJax-script';
    if (document.getElementById(id) === null) {
      var script = document.createElement("script");
      script.setAttribute('id', id);
      script.setAttribute('type', 'text/javascript');
      script.setAttribute('src', 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/mml-chtml.js');
      script.setAttribute('defer', '');
      document.body.appendChild(script);
    }
    return false;
  },
  renderDynamicHTML: function(selector, dynamicHTML) {
    var skip = (!dynamicHTML || (dynamicHTML.length == 0)) ? true : false;
    if (!skip) {
      for (var i = 0; i < dynamicHTML.length; i++) {
        if (!dynamicHTML[i].items || (dynamicHTML[i].items.length == 0)) continue;
        var html = '';
        for (var j = 0; j < dynamicHTML[i].items.length; j++)
          html += (dynamicHTML[i].template.replace(/\{\{item\}\}/g, dynamicHTML[i].items[j]));
        $(selector + ' ' + dynamicHTML[i].parentSelector).html(html);
      }
    }
    if (!this.initMathML()) {
      console.log("No Native MathML using MathJax");
    }
    return;
  },
  parseDynamicHTML: function(dynamicHTML) {
    var textChunks = [];
    for (var i = 0; i < dynamicHTML.length; i++) {
      if (!dynamicHTML[i].items || (dynamicHTML[i].items.length == 0)) continue;
      if (dynamicHTML[i].parentSelector == ".pbl-discover-headers") {
        textChunks.push('<div class="pbl-discover-text">Discover</div>');
      }
      for (var j = 0; j < dynamicHTML[i].items.length; j++)
        textChunks.push(dynamicHTML[i].template.replace(/\{\{item\}\}/g, dynamicHTML[i].items[j]));
    }
    var finalText = textChunks.join('. ').replace(/<\/?[^>]+(>|$)/g, '');
    finalText = finalText.trim();
    var finalChar = finalText[finalText.length - 1];
    return (['.', '!', '?'].indexOf(finalChar) === -1) ? finalText + '.' : finalText;
  },
};
if (typeof module === "object" && module.exports) {
  module.exports = labProblem;
}
if (typeof module === "object" && module.exports) {
  module.exports = {
    problemInteract: problemInteract,
    Interact: Interact,
    InteractBlank: InteractBlank,
    InteractMC: InteractMC,
    InteractTemplate: InteractTemplate,
    InteractShortAnswer: InteractShortAnswer
  };
  var InteractManipulative = require('./manipulatives');
}

function problemInteract(selector, problem, lab) {
  var interractName = '';
  if (typeof problem == 'undefined') return;
  if (problem.TypeNew && problem.TypeNew.indexOf('Manipulative') >= 0) interractName = 'Manipulative';
  else if (problem.TypeNew == 'Short Answer') interractName = 'ShortAnswer';
  else if (problem.TypeNew == 'Page') interractName = 'Page';
  else interractName = problem.ProblemType.replace(/\s/g, '');
  var className = (eval('typeof Interact' + interractName) != 'undefined') ? eval('Interact' + interractName) : eval('Interact');
  return new className(selector, problem, lab);
}

function Interact(selector, problem, lab) {
  this.selector = selector;
  this.answer = null;
  this.noPoint = false;
  this.evaluateCorrect = false;
  this.problem = problem;
  this.feedbackPlayTimeout = null;
  this.evaluateCount = 0;
  this.studentInteracted = false;
  this.interactEvents = {};
  this.interactEvents.click = 'click.InteractStudent';
  this.interactEvents.keyup = 'keyup.InteractStudent';
}
Interact.prototype.isAnswerEntered = function() {
  return true;
};
Interact.prototype.showEnterAnswer = function() {
  app.labObject.showEnterAnswer();
};
Interact.prototype.parseAnswer = function() {
  this.answer = null;
  return null;
};
Interact.prototype.getAnswer = function() {
  return this.answer;
};
Interact.prototype.getCorrectAnswer = function() {
  if (typeof this.problem.CorrectAnswerCrypted != 'undefined') {
    if (this.problem.CorrectAnswerCrypted == null) {
      return this.problem.CorrectAnswerCrypted;
    }
    var encryptedAnswer = atob(this.problem.CorrectAnswerCrypted);
    var firstLetter = encryptedAnswer.substring(0, 1);
    var restAnswer = encryptedAnswer.slice(51);
    var output = JSON.parse(atob(firstLetter + restAnswer));
    output = output.replace(/(%(?![0-9A-Fa-f]{2}))/gm, '%25');
    try {
      return decodeURIComponent(output);
    } catch (e) {
      return output;
    }
  } else {
    return this.problem.CorrectAnswer;
  }
};
Interact.prototype.isAnswerCorrect = function() {
  return (this.answer == this.getCorrectAnswer());
};
Interact.prototype.invalidProblem = function() {
  return ($(this.selector + ' .problem-statement input').length == 0 && this.problem.CorrectAnswer == '');
};
Interact.prototype.needEvaluation = function() {
  return (typeof this.problem != 'undefined' && this.problem.TypeNew != 'Teach Me' && this.problem.TypeNew != 'Page' && this.getCorrectAnswer() != 'undefined' && this.getCorrectAnswer() != '' && this.getCorrectAnswer() !== null);
};
Interact.prototype.selfEvaluate = function() {
  return false;
};
Interact.prototype.isManipulative = function() {
  return false;
};
Interact.prototype.problemHasFeedback = function() {
  return (this.needEvaluation() && typeof this.problem.Feedback != 'undefined' && this.problem.Feedback != '');
};
Interact.prototype.alwaysFeedback = function() {
  return false;
};
Interact.prototype.problemFlashTime = function() {
  if (typeof this.problem.FlashTime != 'undefined') {
    if (this.problem.FlashTime) {
      var t = parseInt(this.problem.FlashTime);
      return (isNaN(t) ? -1 : t);
    }
  }
  return -1;
};
Interact.prototype.showProblemFeedback = function(params) {
  if (typeof module === "object" && module.exports) {
    return;
  }
  $(document).trigger('showProblemFeedback.MSLab', {});
  $('.pbl-header').remove();
  $('.problem-feedback').html(this.problem.Feedback.replace(/gif\?\d.(\d*)/g, 'gif'));
  $(".problem-feedback").css("visibility", "hidden");
  $(".feedback-overlay").css("height", "100%");
  $(".feedback-overlay").css("min-height", "");
  var SoundSetting = G_SoundSetting;
  if (params && typeof params.SoundSetting !== 'undefined')
    SoundSetting = params.SoundSetting;
  $(".feedback-overlay").show();
  $('.problem-feedback-wrap').show();
  $(".problem-feedback").show();
  if (SoundSetting > 0 && soundManager.supported()) {
    if (labProblem) labProblem.showPlayIcons();
    $(".pbl-dragdrop-answer .play_icon, .pbl-dragdrop-answer .play_icon_mc, .pbl-dragdrop-answer .play_icon_fb, .pbl-dragdrop-answer .play_icon_img").removeAttr('style');
    if (SoundSetting > 1) {
      var _this = this;
      if (this.problem.Feedback.indexOf("play(\"ProblemReadTextFeedback\")") >= 0) {
        this.feedbackPlayTimeout = setTimeout(function() {
          _this.feedbackPlayTimeout = null;
          play('ProblemReadTextFeedback');
        }, 2000);
      } else {
        var readTTS = null;
        $('.lab-problem .problem-feedback .auto_play_icon').each(function() {
          var s = $(this).attr('data-sound');
          if (s) readTTS = $(this);
          return false;
        });
        if (readTTS && (SoundSetting == 2)) {
          this.feedbackPlayTimeout = setTimeout(function() {
            _this.feedbackPlayTimeout = null;
            readTTS.trigger('click');
          }, 500);
        }
      }
    }
  } else {
    if (labProblem) labProblem.hidePlayIcons();
  }
  $(".problem-statement").css("visibility", "visible");
  $(".problem-feedback").css("visibility", "visible");
  $(".problem-statement input").prop('disabled', true);
  $('.lab-problem').get(0).scrollTop = 0;
  $('.lab-problem').addClass('ms-show-feedback');
  $(document).trigger('evaluateProblem.MSLab', {});
  if ($(".pbl-dragdrop-answers").length && parseInt(this.problem.IsDragDropNoGrayArea) == 2) {
    requestAnimationFrame(function() {
      $(".feedback-overlay").css("min-height", "100%");
      setTimeout(function() {
        $(".feedback-overlay").css("height", $('.lab-problem')[0].scrollHeight);
      }, 400);
    });
  } else {
    $.when(labProblem.imagesLoadedPromise.promise()).done(function() {
      var feedbackOverlay = document.querySelectorAll(".feedback-overlay");
      if (feedbackOverlay.length) {
        feedbackOverlay[0].style.height = parseInt(document.querySelectorAll(".content-problem")[0].scrollHeight) + 'px';
      }
    });
  }
};
Interact.prototype.noOp = function() {};
Interact.prototype.hasStudentInteracted = function() {
  return this.studentInteracted;
};
Interact.prototype.showAnswer = function(answer) {};
Interact.prototype.resetAnswer = function() {};

function InteractMC(selector, problem, lab) {
  Interact.prototype.constructor.call(this, selector, problem, lab);
  var _this = this;
  $(this.selector + ' .MCChoices input').unbind(this.interactEvents.click).bind(this.interactEvents.click, function() {
    _this.studentInteracted = true;
  });
}
InteractMC.prototype = new Interact();
InteractMC.prototype.constructor = InteractMC;
InteractMC.prototype.isAnswerEntered = function() {
  return ($(this.selector + ' .problem-statement .MCRadio').is(':checked'));
};
InteractMC.prototype.parseAnswer = function() {
  this.answer = $(this.selector + ' #MCChoices input:checked').map(function() {
    return $(this).attr('data-name');
  }).get().sort().join('|');
  return this.getAnswer();
};
InteractMC.prototype.showProblemFeedback = function(params) {
  Interact.prototype.showProblemFeedback.call(this, params);
  if (params && params.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    this.showAnswer(this.getCorrectAnswer());
  }
};
InteractMC.prototype.resetAnswer = function() {
  $(this.selector + ' .MCChoices .ms-pbl-choice input').parent().parent().removeClass("correct-input incorrect-input");
  $(this.selector + ' .MCChoices input:checked').prop('checked', false);
};
InteractMC.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  var correctAnswer = (this.getCorrectAnswer() + '').split("|");
  var i = 0;
  answer.split('|').forEach(function(ans) {
    $(this.selector + ' .MCChoices .ms-pbl-choice input[data-name="' + ans + '"]').prop('checked', true);
    if (correctAnswer[i] === ans) {
      $(this.selector + ' .MCChoices .ms-pbl-choice input[data-name="' + ans + '"]').parent().parent().addClass("correct-input");
    } else {
      $(this.selector + ' .MCChoices .ms-pbl-choice input[data-name="' + ans + '"]').parent().parent().addClass("incorrect-input");
    }
    i++;
  }.bind(this));
};

function InteractBlank(selector, problem, lab) {
  Interact.prototype.constructor.call(this, selector, problem, lab);
  this.mustFillAll = false;
  this.allowBlank = false;
  this.inputElement = ' .problem-statement input[type=text]';
  var _this = this;
  $(this.inputElement).unbind(this.interactEvents.keyup).bind(this.interactEvents.keyup, function() {
    if ($(this).val().trim().length > 0) {
      _this.studentInteracted = true;
    }
  });
}
InteractBlank.prototype = new Interact();
InteractBlank.prototype.constructor = InteractBlank;
InteractBlank.prototype.isAnswerEntered = function() {
  var inputsFilled = (this.mustFillAll ? ($(this.selector + this.inputElement).map(function() {
    return ($(this).val() != '') ? null : 1;
  }).length == 0) : ($(this.selector + this.inputElement).map(function() {
    return $(this).val();
  }).get().join('') != ''));
  return (this.allowBlank || inputsFilled);
};
InteractBlank.prototype.isAnswerCorrect = function() {
  this.evaluateCorrect = this.getIsAnswerCorrect();
  return (this.evaluateCorrect == 1);
};
InteractBlank.prototype.stripAnswer = function(answer, doLowercase) {
  var toReplace = [{
    from: [' '],
    to: ''
  }, {
    from: ['’', '´', '`'],
    to: '\''
  }];
  for (var i = 0; i < toReplace.length; i++) {
    for (var j = 0; j < toReplace[i].from.length; j++) {
      answer = answer.replace(toReplace[i].from[j], toReplace[i].to);
    }
  }
  return doLowercase ? answer.toLowerCase() : answer;
};
InteractBlank.prototype.getFieldTypes = function() {
  return (this.problem['BlankFieldType']) ? this.problem['BlankFieldType'].split("|").filter(function(element) {
    return element != null && element.length > 0;
  }) : [];
}
InteractBlank.prototype.isProblemCaseSensitive = function() {
  return (typeof this.problem['IsCaseSensitive'] !== 'undefined' && (this.problem['IsCaseSensitive'] == true || this.problem['IsCaseSensitive'] == 1)) ? true : false;
}
InteractBlank.prototype.checkAnswer = function(fieldType, correctAnswer, studentAnswer, isCaseSensitive) {
  var reg;
  var m;
  if (fieldType == 't') {
    return (this.stripAnswer(correctAnswer, !isCaseSensitive) == this.stripAnswer(studentAnswer, !isCaseSensitive));
  } else if (fieldType == 'n') {
    return (parseFloat(correctAnswer.replace(" ", "").replace(",", "")) == parseFloat(studentAnswer.replace(/[^0-9\.\-]/g, "")));
  } else if (fieldType == 'f') {
    studentAnswer = studentAnswer.replace(',', '');
    reg = /(-?)\s*(\d+)\s+(\d+)\s*\/\s*(\d+)/g;
    m = reg.exec(studentAnswer);
    if (m) {
      return ((parseFloat(correctAnswer)).toDecimal(4) == (parseFloat(m[1] + '1') * (parseFloat(m[2]) + parseFloat(m[3]) / parseFloat(m[4]))).toDecimal(4))
    }
    reg = /(-?)\s*([.]*\d+)\s*(\/|:)\s*(-?)\s*([.]*\d+)/g;
    m = reg.exec(studentAnswer);
    if (m) {
      return ((parseFloat(correctAnswer)).toDecimal(4) == ((parseFloat(m[1] + '1') * parseFloat(m[2])) / (parseFloat(m[4] + '1') * parseFloat(m[5]))).toDecimal(4));
    }
    return (parseFloat(correctAnswer) == parseFloat(studentAnswer.replace(/[^0-9\.\-]/g, '')));
  }
}
InteractBlank.prototype.getIsAnswerCorrect = function() {
  var fieldType = this.getFieldTypes();
  var correctField = (this.getCorrectAnswer() + '').split("|").filter(function(element) {
    return element != null && element.length > 0;
  });
  var isCaseSensitive = this.isProblemCaseSensitive();
  var studentAnswer = $(this.selector + this.inputElement).map(function() {
    return $(this).val().replace(/  +/g, ' ').trim();
  });
  if (fieldType.length === correctField.length && correctField.length === studentAnswer.length) {
    for (var i = 0; i < fieldType.length; i++) {
      if (!this.checkAnswer(fieldType[i], correctField[i], studentAnswer[i], isCaseSensitive)) {
        return 0;
      }
    }
  }
  return 1;
};
InteractBlank.prototype.parseAnswer = function() {
  var answers = $(this.selector + this.inputElement).map(function() {
    return $(this).val();
  }).get();
  this.answer = (answers.join('') != '') ? answers.join("|") : '';
  return this.getAnswer();
};
InteractBlank.prototype.showProblemFeedback = function(params) {
  Interact.prototype.showProblemFeedback.call(this, params);
  if (params && params.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    this.showAnswer(this.getCorrectAnswer());
  }
};
InteractBlank.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + this.inputElement);
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].classList.remove('correct-input');
    inputs[i].classList.remove('incorrect-input');
    inputs[i].value = ''
  }
};
InteractBlank.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  var fieldType = this.getFieldTypes();
  var answerArray = (answer + '').split('|');
  var correctAnswer = (this.getCorrectAnswer() + '').split("|");
  var _this = this;
  $(this.selector + this.inputElement).each(function(i, e) {
    if (i < correctAnswer.length) {
      $(e).val(answerArray[i]);
      if (_this.checkAnswer(fieldType[i], correctAnswer[i], answerArray[i], _this.isProblemCaseSensitive())) {
        $(e).addClass("correct-input");
      } else {
        $(e).addClass("incorrect-input");
      }
    }
  });
}

function InteractTemplate(selector, problem, lab) {
  Interact.prototype.constructor.call(this, selector, problem, lab);
  var _this = this;
  if ([1, 3, 5, 8, 9, 10, 11, 20, 26, 27, 30, 32, 40, 43, 45, 48, 49, 50, 51, 52, 53, 55, 60, 61, 62, 64].indexOf(parseInt(this.problem['fkMLTemplateID'])) == -1) {
    $(this.selector + ' input.template_field[type=text], ' + this.selector + ' input.small_field[type=text]').each(function() {
      var width = _this.textWidth($(this));
      if (width != -1) {
        $(this).width(width);
      }
    });
  }
};
InteractTemplate.prototype = new Interact();
InteractTemplate.prototype.constructor = InteractTemplate;
InteractTemplate.prototype.textWidth = function(element) {
  var width = -1;
  var text = '';
  if (typeof $(element).attr('maxlength') != 'undefined') {
    for (var i = 0; i < parseInt($(element).attr('maxlength')); i++) {
      text += 8;
    };
  }
  if (text.length > 0) {
    var fakeEl = $('<span>').hide().appendTo(document.body);
    fakeEl.text(text).css({
      'font': $(element).css('font'),
      'font-size': $(element).css('font-size')
    });
    width = fakeEl.width();
    fakeEl.remove();
    var paddingRight = (typeof $(element).css('padding-right') != 'undefined') ? parseInt($(element).css('padding-right').replace('px', '')) : 0;
    var paddingLeft = (typeof $(element).css('padding-left') != 'undefined') ? parseInt($(element).css('padding-left').replace('px', '')) : 0;
    width = width + paddingLeft + paddingRight;
  }
  return width;
};
InteractTemplate.prototype.isAnswerEntered = function() {
  return ($(this.selector + ' .problem-statement input[type=text]').map(function() {
    return ($(this).val() != '') ? null : 1;
  }).length == 0);
};
InteractTemplate.prototype.isAnswerCorrect = function() {
  this.evaluateCorrect = this.getIsAnswerCorrect();
  return this.evaluateCorrect;
}
InteractTemplate.prototype.getIsAnswerCorrect = function() {
  if (this.problem.ProblemType == 'Template' && this.problem.fkMLTemplateID == 63) {
    correctArr = (this.getCorrectAnswer() + '').split("|");
    return this.answer == parseFloat(correctArr[0] / correctArr[1]);
  } else {
    return (this.answer == (this.getCorrectAnswer() + '').split("|").map(function(x) {
      x = x.replace(/[^0-9\.-]/g, "");
      return isNaN(parseFloat(x)) ? x : parseFloat(x);
    }).join('|'));
  }
};
InteractTemplate.prototype.parseAnswer = function() {
  var answerDone = false;
  var inp = $(this.selector + ' .problem-statement input[type=text]').get().sort(function(a, b) {
    var compA = parseInt($(a).attr("name").replace("TF", ""));
    var compB = parseInt($(b).attr("name").replace("TF", ""));
    return (compA < compB) ? -1 : (compA > compB) ? 1 : 0;
  });
  if (this.problem.ProblemType == 'Template' && this.problem.fkMLTemplateID == 63) {
    var numerator = $(inp).filter(function() {
      if ($(this).attr("name") == "TF2") return true;
      return false;
    });
    var denominator = $(inp).filter(function() {
      if ($(this).attr("name") == "TF3") return true;
      return false;
    });
    this.answer = Math.round(parseFloat($(numerator).val() / $(denominator).val()) * 1000000000) / 1000000000;
    answerDone = true;
  } else if (this.problem.ProblemType == 'Template' && this.problem.fkMLTemplateID == 6) {
    var studentAnswer = $(inp).val().replace(',', '').replace(/  +/g, ' ').trim();
    reg = /(-?)\s*(\d+)\s+(\d+)\s*\/\s*(\d+)/g;
    m = reg.exec(studentAnswer);
    if (m) {
      this.answer = (parseFloat(m[1] + '1') * (parseFloat(m[2]) + parseFloat(m[3]) / parseFloat(m[4]))).toDecimal(4);
      if (this.answer == parseFloat(this.answer.replace(/[^0-9\.\-]/g, ''))) {
        this.answer = parseFloat(this.answer.replace(/[^0-9\.\-]/g, ''));
      }
      return this.answer;
    }
    reg = /(-?)\s*([.]*\d+)\s*(\/|:)\s*(-?)\s*([.]*\d+)/g;
    var m = reg.exec(studentAnswer);
    if (m) {
      this.answer = ((parseFloat(m[1] + '1') * parseFloat(m[2])) / (parseFloat(m[4] + '1') * parseFloat(m[5]))).toDecimal(4);
      if (this.answer == parseFloat(this.answer.replace(/[^0-9\.\-]/g, ''))) {
        this.answer = parseFloat(this.answer.replace(/[^0-9\.\-]/g, ''));
      }
      return this.answer;
    }
  }
  if (!answerDone) {
    this.answer = $(inp).map(function() {
      x = $(this).val();
      x = x.replace(/[^0-9\.-]/g, "");
      return isNaN(parseFloat(x)) ? x : parseFloat(x);
    }).get();
    if (this.answer.indexOf('.') >= 0) {
      var i = 0;
      while (i < this.answer.length && this.answer[i] == '') this.answer[i++] = '0';
      i = this.answer.length;
      while (i > 0 && this.answer[i - 1] == '') {
        this.answer[i - 1] = '0';
        i--;
      }
    }
    this.answer = this.answer.join('|');
  }
  return this.answer;
};
InteractTemplate.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + ' .template_field');
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].classList.remove('correct-input');
    inputs[i].classList.remove('incorrect-input');
    inputs[i].value = ''
  }
};
InteractTemplate.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  var correctField = (answer + '').split('|');
  var correctAnswer = (this.getCorrectAnswer() + '').split("|");
  var problemsInputs = Array.from(document.querySelectorAll(this.selector + ' .template_field'));
  problemsInputs = problemsInputs.sort(function(a, b) {
    if (!a.getAttribute('name') || !b.getAttribute('name')) {
      return 0;
    }
    var compA = parseInt(a.getAttribute('name').replace('TF', ''), 10);
    var compB = parseInt(b.getAttribute('name').replace('TF', ''), 10);
    return (compA < compB) ? -1 : (compA > compB) ? 1 : 0;
  });
  problemsInputs.forEach((e, i) => {
    if (i < correctAnswer.length) {
      $(e).val(correctField[i]);
      if (correctAnswer[i] === correctField[i]) {
        $(e).addClass("correct-input");
      } else {
        $(e).addClass("incorrect-input");
      }
    }
  });
}

function InteractShortAnswer(selector, problem, lab) {
  Interact.prototype.constructor.call(this, selector, problem);
}
InteractShortAnswer.prototype = new Interact();
InteractShortAnswer.prototype.constructor = InteractShortAnswer;
InteractShortAnswer.prototype.invalidProblem = function() {
  return false;
};
InteractShortAnswer.prototype.problemHasFeedback = function() {
  return (typeof this.problem.Feedback != 'undefined' && this.problem.Feedback != '');
};
InteractShortAnswer.prototype.getUserInput = function() {
  if (typeof tinymce != 'undefined') {
    var ed = tinymce.get('SAinput');
    if (ed) return ed.getContent();
  }
  return '';
}
InteractShortAnswer.prototype.isAnswerEntered = function() {
  this.answer = this.getUserInput();
  return (this.answer != '');
};
InteractShortAnswer.prototype.parseAnswer = function() {
  this.answer = this.getUserInput();
  return this.getAnswer();
};
InteractShortAnswer.prototype.showProblemFeedback = function() {
  this.viewSelector = 'lab-view-content';
  Interact.prototype.showProblemFeedback.call(this);
  var inputText = this.getUserInput();
  $('#SALabEditor, #SALabEditor .' + this.viewSelector).css('height', 'auto');
  $('#SALabEditor').css('height', 'auto').html('<div class="' + this.viewSelector + ' lab-box-sizing">\
    <iframe id="' + this.viewSelector + '" class="lab-box-sizing" src="about:blank" frameBorder="0" scrolling="no"></iframe>\
    </div>');
  var priorFrame = document.getElementById(this.viewSelector).contentWindow;
  var priorCss = '<link rel="stylesheet" type="text/css" href="/MM/css/elements/MW/mw_editor.css" />';
  var jsCode = '';
  var priorHtml = '<!DOCTYPE html><html><head>' + priorCss + jsCode + '</head><body></body></html>';
  priorFrame.document.open();
  priorFrame.document.write(priorHtml);
  priorFrame.document.write("");
  priorFrame.document.close();
  $('#' + this.viewSelector).contents().find('body').html(inputText);
  $('.mw-teacher-mark', $('#' + this.viewSelector).contents()).attr('onclick', '');
  var iframeContentHeight = $('#' + this.viewSelector).contents().find('body')[0].scrollHeight;
  var htmlEl = $('#' + this.viewSelector).contents().find('html');
  if (htmlEl && htmlEl[0].scrollHeight > iframeContentHeight) iframeContentHeight = htmlEl[0].scrollHeight;
  $(window).unbind('resize');
  if (typeof resizeTimerSA != 'undefined' && resizeTimerSA) clearTimeout(resizeTimerSA);
  $('#' + this.viewSelector).attr('height', iframeContentHeight);
  $('#' + this.viewSelector).css({
    'height': iframeContentHeight + 'px',
    'width': '100%'
  });
};
Number.prototype.toDecimal = function(n) {
  n = (isNaN(n)) ? 2 : n;

  function pad(s) {
    s = s || '.';
    return (s.length > n) ? s : pad(s + '0');
  }
  var x = this - Math.pow(10, -n) / 2;
  x += x / Math.pow(2, 53);
  return (isNaN(this)) ? this : (x.toFixed(n)).replace(/(\.\d*)?$/, pad);
};
if (typeof module === "object" && module.exports) {
  module.exports = InteractManipulative;
  require('./jquery/jquery.drag-drop.plugin');
  require('./jquery/jquery-mobyResizable');
  require('./jquery/jquery.bt.min');
  require('./jquery/jquery.flip');
  var interactModule = require('./interact');
  var Interact = interactModule.Interact;
  var InteractBlank = interactModule.InteractBlank;
  var MathToolbarClass = require('./mathformula-toolbar');
  var LineChartEditor = require('./line-chart-editor');
  var NumberLineEditor = require('./number-line-editor');
  var GraphEditor = require('./graph-editor');
  var UndoRedo = require('./undo-redo');
  var FluencyGameWrapper = require('./fluency-game-wrappers');
  var AddPunctuation = require('./add-punctuation');
}
var ManipulativeSoundSetting = 1;

function problemManipulative(selector, problem) {
  ManipulativeSoundSetting = (typeof G_SoundSetting !== 'undefined') ? G_SoundSetting : (typeof app.labObject.soundSetting !== 'undefined' ? app.labObject.soundSetting : 1);
  var ManipulativeFormat = ('ProblemFormat' in problem && problem.ProblemFormat != '') ? (problem.ProblemFormat.replace('-', '')) : 'undefined';
  if (ManipulativeFormat == 'Type') ManipulativeFormat = 'Typeman';
  ManipulativeFormat = ManipulativeFormat.replace(/(?:^|\s)\S/g, function(a) {
    return a.toUpperCase();
  }).replace(/ /g, '');
  var isIOS = /iPad|iPhone|iPod/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  if (isIOS) {
    $(selector).addClass('ms-device-ios');
  }
  if (eval('typeof ' + ManipulativeFormat) != 'undefined') {
    $(selector).addClass('ms-pbl-format-' + ManipulativeFormat);
    var className = eval(ManipulativeFormat);
    if (['Typeman', 'SpellingWord', 'ShortShort', 'LabelImage'].indexOf(ManipulativeFormat) != -1) {
      $(document).find('input, textarea').attr({
        'autocomplete': 'off',
        'autocorrect': 'off',
        'autocapitalize': 'off',
        'spellcheck': 'false'
      });
    }
    return new className(selector, problem);
  } else {
    return new ManipulativeGeneric(selector, problem);
  }
}

function InteractManipulative(selector, problem, lab, isSecondary = false) {
  Interact.prototype.constructor.call(this, selector, problem);
  this.manipulative = problemManipulative(selector, problem);
  this.manipulative.lab = lab;
  this.manipulative.isSecondary = isSecondary;
}
InteractManipulative.prototype = new Interact();
InteractManipulative.prototype.constructor = InteractManipulative;
InteractManipulative.prototype.showEnterAnswer = function() {
  this.manipulative.showMessageNext();
};
InteractManipulative.prototype.getNextMessage = function() {
  return ManipulativeBase.prototype.getNextMessage.call(this.manipulative);
};
InteractManipulative.prototype.invalidProblem = function() {
  return false;
};
InteractManipulative.prototype.isAnswerCorrect = function() {
  var manipulativeCorrect = this.manipulative.isAnswerCorrect();
  var secondaryCorrect = ((this.manipulative.secondary) ? this.manipulative.secondary.isAnswerCorrect() : true);
  this.evaluateCorrect = ((this.manipulative.selfEvaluate() || manipulativeCorrect) && (((this.manipulative.secondary) ? this.manipulative.secondary.selfEvaluate() : true) || secondaryCorrect)) ? 1 : 0;
  if (!this.manipulative.noPoint && this.manipulative.secondary) {
    if (this.manipulative.secondary.manipulative && this.manipulative.secondary.manipulative.noPoint) {
      this.manipulative.noPoint = this.manipulative.secondary.manipulative.noPoint;
    } else if (this.manipulative.secondary && this.manipulative.secondary.noPoint) {
      this.manipulative.noPoint = this.manipulative.secondary.noPoint;
    }
  }
  return (manipulativeCorrect && secondaryCorrect);
};
InteractManipulative.prototype.isAnswerEntered = function() {
  var manipulativeAnswerEntered = this.manipulative.isAnswerEntered();
  var secondaryAnswerEntered = true;
  if (this.manipulative.secondary) {
    secondaryAnswerEntered = this.manipulative.isTestManipulative ? this.manipulative.secondary.isAnswerEntered() : this.manipulative.secondary.isAnswerCorrect();
  }
  return (manipulativeAnswerEntered && secondaryAnswerEntered);
};
InteractManipulative.prototype.parseAnswer = function() {
  this.answer = (this.manipulative.secondary ? this.manipulative.secondary.parseAnswer() : this.manipulative.parseAnswer());
  return this.answer;
};
InteractManipulative.prototype.problemHasFeedback = function() {
  return this.manipulative.problemHasFeedback();
};
InteractManipulative.prototype.alwaysFeedback = function() {
  return this.manipulative.alwaysFeedback();
};
InteractManipulative.prototype.needEvaluation = function() {
  return (this.manipulative.secondary ? (this.manipulative.secondary.needEvaluation() || this.manipulative.needEvaluation()) : this.manipulative.needEvaluation());
};
InteractManipulative.prototype.selfEvaluate = function() {
  return (this.manipulative.secondary ? this.manipulative.secondary.selfEvaluate() : this.manipulative.selfEvaluate());
};
InteractManipulative.prototype.isManipulative = function() {
  return true;
};
InteractManipulative.prototype.showProblemFeedback = function(options) {
  Interact.prototype.showProblemFeedback.call(this, options);
  this.manipulative.showProblemFeedback(options);
  if (this.manipulative.secondary) {
    this.manipulative.secondary.showProblemFeedback(options);
  }
};
InteractManipulative.prototype.resetAnswer = function() {
  this.manipulative.resetAnswer();
  if (this.manipulative.secondary) {
    this.manipulative.secondary.resetAnswer();
  }
};
InteractManipulative.prototype.showAnswer = function(answer) {
  if (!this.manipulative.isSecondary) {
    this.manipulative.showAnswer(answer)
  } else if (this.manipulative.secondary && this.manipulative.isSecondary) {
    this.manipulative.secondary.showAnswer(answer);
  }
};
var interactStudentMessages = ['Please select an answer.', 'Please enter an answer.', 'Some answers are missing.'];
var interactEvents = {};
interactEvents.click = 'click.InteractStudent';
interactEvents.keyup = 'keyup.InteractStudent';
interactEvents.blur = 'blur.InteractStudent';
interactEvents.mousedown = 'mousedown.InteractStudent';
interactEvents.drag = 'InteractStudent.dragEvent';
interactEvents.add = 'InteractStudent.addElement';
interactEvents.move = 'InteractStudent.moveElement';

function ManipulativeBase(selector, problem) {
  this.selector = selector;
  this.problem = problem;
  this.completed = false;
  this.noPoint = false;
  this.noPointOnIncomplete = true;
  this.messageNext = {
    dialog: '#nextMessage',
    title: 'Oops!',
    message: '',
    image: '<div class="man-box-next-right-part"></div>',
    buttons: '<div class="flowbuttons"><div class="flowbutton" onclick="$(\'.lab-problem-message\').remove();">Try Again</div><br/><br/><div class="flowbutton" onclick="ManipulativeBase.prototype.skipProblem();$(\'.lab-problem-message\').remove()">Next Problem</div></div>',
    imageContainer: 'man-box-next-right-part'
  };
  this.secondary = null;
  this.evaluateCount = 0;
  this.isTestManipulative = (typeof problem !== 'undefined' && problem.TypeNew == 'Test Manipulative');
  this.isManipulative = (typeof problem !== 'undefined' && problem.TypeNew.indexOf('Manipulative') > -1);
  this.studentInteracted = false;
}
ManipulativeBase.prototype.noOp = function() {};
ManipulativeBase.prototype.skipProblem = function() {
  app && app.labObject && app.labObject.skipProblem && app.labObject.skipProblem();
};
ManipulativeBase.prototype.getNextMessage = function() {
  var messageNext = $.extend({}, this.messageNext);
  messageNext.buttons = '';
  if (this.isManipulative && !this.isTestManipulative && this.hasStudentInteracted()) {
    this.evaluateCount++;
    if (this.evaluateCount > 1 && this.messageNext.buttons != '') {
      messageNext.buttons = this.messageNext.buttons;
    }
  }
  if (this.isTestManipulative) {
    if (this.hasStudentInteracted()) {
      messageNext.message = (messageNext.message || '');
    } else {
      messageNext.message = (this.getInteractMessage() || '');
    }
  } else {
    messageNext.message = (messageNext.message || '');
  }
  return messageNext;
};
ManipulativeBase.prototype.hasStudentInteracted = function() {
  return this.studentInteracted;
};
ManipulativeBase.prototype.getInteractMessage = function() {
  return this.noInteractMessage || this.messageNext.message;
};
ManipulativeBase.prototype.showMessageNext = function() {
  var nextMessage = ManipulativeBase.prototype.getNextMessage.call(this);
  if (this.problemMessageTimeout) {
    clearTimeout(this.problemMessageTimeout);
    this.problemMessageTimeout = null;
  }
  $('.lab-problem-message').remove();
  $('body').append('\
      <div class="lab-problem-message">\
          <div class="standard-dialog-blue-overlay"></div>\
          <div class="lab-screen-bubble-content' + (nextMessage.buttons != '' ? ' withButtons' : '') + '">\
              <div class="lab-screen-bubble-cross" onclick="$(\'.lab-problem-message\').remove();"><div>x</div></div>\
              <div class="lab-screen-bubble">\
                  <div class="lab-screen-bubble-top"><div></div></div>\
                  <div class="lab-screen-bubble-container">\
                      <div class="lab-screen-bubble-container-left"><div></div></div>\
                      <div class="lab-screen-bubble-container-right"><div></div></div>\
                      <div class="lab-screen-bubble-container-bottom"><div></div></div>\
                      <div class="lab-screen-bubble-big-text lab-screen-bubble-score"><div></div></div>\
                      <div class="lab-screen-bubble-items"><div>\
                        <div class="lab-screen-bubble-big-text">' + nextMessage.title + '</div><br/>\
                        <div class="lab-screen-bubble-text">' + nextMessage.message + '</div>\
                        ' + (nextMessage.buttons || '') + '\
                      </div></div>\
                  </div>\
              </div>\
          </div>\
      </div>');
  if (nextMessage.buttons === '') {
    this.problemMessageTimeout = setTimeout(function() {
      this.problemMessageTimeout = null;
      $('.lab-problem-message').remove();
    }.bind(this), 4000);
  }
};
ManipulativeBase.prototype.setNoPoint = function(value) {
  this.noPoint = value;
};
ManipulativeBase.prototype.isAnswerEntered = function() {
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  }
  if (!this.completed && this.noPointOnIncomplete) this.setNoPoint(true);
  return this.completed;
};
ManipulativeBase.prototype.isAnswerCorrect = function() {
  return this.isTestManipulative ? this.completed : (this.completed && !this.noPoint);
};
ManipulativeBase.prototype.parseAnswer = function() {
  return null;
};
ManipulativeBase.prototype.hotspotClickPlay = function(who) {
  var soundFile = who.attr('data-sound') ? who.attr('data-sound') : ((who[0] && who[0].attr) ? who[0].attr('data-sound') : '');
  if (ManipulativeSoundSetting > 0 && soundFile && soundFile !== '') {
    this.lab.playFile(soundFile);
  }
};
ManipulativeBase.prototype.needEvaluation = function() {
  return true;
};
ManipulativeBase.prototype.selfEvaluate = function() {
  return !this.isTestManipulative;
};
ManipulativeBase.prototype.problemHasFeedback = function() {
  return (this.needEvaluation() && typeof this.problem.Feedback != 'undefined' && this.problem.Feedback != '');
};
ManipulativeBase.prototype.alwaysFeedback = function() {
  return true;
};
ManipulativeBase.prototype.setupSecondary = function(mandatory, problem) {
  if (typeof problem != 'undefined') {
    var secondaryProblem = $.extend({}, problem);
    var enterAnswerMessage = this.isTestManipulative ? 'Some answers are missing. Please complete part 1 and part 2.' : 'Some answers are missing or incorrect. Please enter a correct answer for part 1 and part 2.';
    if ((secondaryProblem.DAABlankFieldType != '' && secondaryProblem.DAABlankFieldType != null) || (secondaryProblem.DAACorrectAnswer != '' && secondaryProblem.DAACorrectAnswer != null)) {
      secondaryProblem.BlankField = secondaryProblem.DAABlankField;
      secondaryProblem.BlankFieldType = secondaryProblem.DAABlankFieldType;
      secondaryProblem.BlankFieldTTS = secondaryProblem.DAABlankFieldTTS;
      secondaryProblem.CorrectAnswer = secondaryProblem.DAACorrectAnswer;
      delete secondaryProblem.CorrectAnswerCrypted;
    }
    if (mandatory && ['MC', 'Blank', 'Draw'].indexOf(secondaryProblem.ProblemType) != -1) {
      this.messageNext.message = enterAnswerMessage;
      this.noInteractMessage = this.messageNext.message;
    }
    if (secondaryProblem.ProblemType == 'MC') {
      secondaryProblem.ProblemFormat = 'MC';
      this.secondary = new InteractManipulative(this.selector, secondaryProblem, this.lab, true);
      if (mandatory) {
        this.secondary.messageNext = $.extend({}, this.messageNext);
        this.secondary.messageNext.message = enterAnswerMessage;
      }
    } else if (secondaryProblem.ProblemType == 'Blank' || secondaryProblem.ProblemType == 'Draw') {
      this.secondary = new InteractBlank(this.selector, secondaryProblem, this.lab);
      if (mandatory) {
        this.secondary.mustFillAll = true;
        this.secondary.messageNext = $.extend({}, this.messageNext);
        this.secondary.messageNext.message = enterAnswerMessage;
      }
    }
    if (secondaryProblem.ProblemType == 'Blank' || secondaryProblem.ProblemType == 'MC')
      $(this.selector).addClass('DragAndDropNoExpand');
  }
};
ManipulativeBase.prototype.getID = function(id) {
  if (id) return (parseInt(id) >> 8) % 16;
  return -1;
};
ManipulativeBase.prototype.getIDTwo = function(id) {
  if (id) return (parseInt(id) >> 8) % 21;
  return -1;
};
ManipulativeBase.prototype.showProblemFeedback = function(options) {};
ManipulativeBase.prototype.showAnswer = function(answer) {};
ManipulativeBase.prototype.resetAnswer = function() {};
ManipulativeBase.prototype.getCorrectAnswer = function() {
  return Interact.prototype.getCorrectAnswer.call(this);
};

function ManipulativeGeneric(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.completed = true;
  this.studentInteracted = true;
}
ManipulativeGeneric.prototype = new ManipulativeBase();
ManipulativeGeneric.prototype.constructor = ManipulativeGeneric;
ManipulativeGeneric.prototype.problemHasFeedback = function() {
  return false;
};
ManipulativeGeneric.prototype.needEvaluation = function() {
  return false;
};

function GradableHotspot(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'You are missing one or more of the correct answers.';
  this.noInteractMessage = interactStudentMessages[0];
  this.correctImg = {
    addClass: 'pbl-hotspot-correct',
    width: 39,
    height: 39
  };
  this.incorrectImg = {
    addClass: 'pbl-hotspot-incorrect',
    width: 39,
    height: 39
  };
  if (typeof problem.IsLargeGradableHotspotCheckmarks !== 'undefined') {
    if (problem.IsLargeGradableHotspotCheckmarks == true || problem.IsLargeGradableHotspotCheckmarks == 1) {
      this.correctImg = {
        addClass: 'pbl-hotspot-correct',
        width: 104,
        height: 104
      };
      this.incorrectImg = {
        addClass: 'pbl-hotspot-incorrect',
        width: 104,
        height: 104
      };
    }
  }
  this.triedClass = this.isTestManipulative ? 'pbl-hotspot-tried-test' : 'pbl-hotspot-tried';
  this.totalCorrect = this.getTotalCorrect();
  this.correctCount = 0;
  this.bindEvents();
  this.setupSecondary(true, problem);
}
GradableHotspot.prototype = new ManipulativeBase();
GradableHotspot.prototype.constructor = GradableHotspot;
GradableHotspot.prototype.bindEvents = function() {
  var _this = this;
  if (parseInt(this.problem.IsPDProblem) == 1) {
    $(this.selector + ' .problem-statement').unbind('click').bind('click', function(e) {
      _this.studentInteracted = true;
      if (!$(e.target).hasClass('pbl-hotspot')) {
        _this.setNoPoint(true);
      } else if ($(e.target).hasClass('pbl-hotspot') && !$(e.target).hasClass('pbl-hotspot-sound-icon') && !$(e.target).hasClass('pbl-hotspot-invisible-sound-icon')) {
        _this.onHotspotClick(e);
      }
      app.labObject.onNextClick(e);
    });
  } else {
    $(this.selector + ' .pbl-hotspot:not(.pbl-hotspot-sound-icon):not(.pbl-hotspot-invisible-sound-icon)').unbind('click').bind('click', function(e) {
      _this.studentInteracted = true;
      _this.onHotspotClick(e);
    });
  }
};
GradableHotspot.prototype.getTotalCorrect = function() {
  totalCorrect = 0;
  $(this.selector + ' .pbl-hotspot:not(.pbl-hotspot-sound-icon):not(.pbl-hotspot-invisible-sound-icon)').each(function() {
    totalCorrect += (parseInt($(this).attr('data-status')) >> 8) % 2;
  });
  return totalCorrect;
};
GradableHotspot.prototype.getPosition = function(offset, width, height, fromCenter) {
  return {
    top: offset.top + fromCenter * Math.round(height / 2),
    left: offset.left + fromCenter * Math.round(width / 2)
  };
};
GradableHotspot.prototype.onHotspotClick = function(e) {
  var $el = $(e.target);
  if (!$el.attr('data-flashX')) {
    this.hotspotClickPlay($el);
    if (this.isTestManipulative) {
      if (typeof this.problem.IsSingleGradableHotspotSelected !== 'undefined') {
        if (this.problem.IsSingleGradableHotspotSelected == true || this.problem.IsSingleGradableHotspotSelected == 1) {
          $(this.selector + ' .pbl-hotspot').not($el).removeClass(this.triedClass);
        }
      }
      $el.toggleClass(this.triedClass);
      this.completed = ($(this.selector + ' .pbl-hotspot').map(function(i, e) {
        var id = ((this.getID($(e).attr('data-status')) % 2) > 0);
        return ((id && !($(e).hasClass(this.triedClass))) || (!id && $(e).hasClass(this.triedClass))) ? 1 : null;
      }.bind(this)).get().length > 0) ? false : true;
      return;
    }
    var hasFlashingRedXs = (typeof this.problem.IsFlashRedXs !== 'undefined' && (this.problem.IsFlashRedXs == true || this.problem.IsFlashRedXs == 1)) ? true : false;
    if (!hasFlashingRedXs && $el.hasClass(this.triedClass)) return;
    var isCorrect = (parseInt($el.attr('data-status')) >> 8) % 2;
    if (!isCorrect) this.setNoPoint(true);
    var centerPoint = this.getPosition($el.position(), $el.outerWidth(), $el.outerHeight(), 1);
    var backupStyle = $el.attr('style');
    var replaceImg = isCorrect ? this.correctImg : this.incorrectImg;
    var newTopLeft = this.getPosition(centerPoint, replaceImg.width, replaceImg.height, -1);
    $el.attr('style', 'top:' + newTopLeft.top + 'px;left:' + newTopLeft.left + 'px;width:' + replaceImg.width + 'px;height:' + replaceImg.height + 'px;');
    if (hasFlashingRedXs && !isCorrect) {
      $el.attr('data-flashX', 1);
      $el.hide().addClass(this.triedClass).addClass(replaceImg.addClass).addClass('hasFlashingRedXs').fadeIn("slow");
      setTimeout(function() {
        $el.fadeOut("slow", function() {
          $el.removeClass(replaceImg.addClass).attr('style', backupStyle).removeAttr('data-flashX');
        });
      }, 1000);
    } else {
      $el.addClass(this.triedClass).addClass(replaceImg.addClass);
    }
    this.correctCount += isCorrect;
    this.completed = (this.correctCount >= this.totalCorrect);
  }
};
GradableHotspot.prototype.selfEvaluate = function() {
  return (this.secondary ? false : (!this.isTestManipulative));
};
GradableHotspot.prototype.isAnswerEntered = function() {
  var returnValue = this.completed;
  if (this.secondary || this.isTestManipulative) {
    returnValue = document.querySelectorAll(this.selector + ' .pbl-hotspot:not(.pbl-hotspot-sound-icon):not(.pbl-hotspot-invisible-sound-icon).' + this.triedClass + ', ' + this.selector + ' .pbl-hotspot:not(.pbl-hotspot-sound-icon):not(.pbl-hotspot-invisible-sound-icon).' + this.correctImg.addClass).length ? true : false;
  }
  return returnValue;
};
GradableHotspot.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.selector + ' .pbl-hotspot').removeClass(this.triedClass).removeClass(this.correctImg.addClass).removeClass(this.incorrectImg.addClass).each(function(i, el) {
      var $el = $(el);
      if ((parseInt($el.attr('data-status')) >> 8) % 2) {
        var centerPoint = this.getPosition($el.position(), $el.outerWidth(), $el.outerHeight(), 1);
        var newTopLeft = this.getPosition(centerPoint, this.correctImg.width, this.correctImg.height, -1);
        $el.attr('style', 'top:' + newTopLeft.top + 'px;left:' + newTopLeft.left + 'px;width:' + this.correctImg.width + 'px;height:' + this.correctImg.height + 'px;');
        $el.addClass(this.correctImg.addClass);
      }
    }.bind(this));
  }
};
GradableHotspot.prototype.parseAnswer = function() {
  var answers = [];
  $(this.selector + ' .pbl-hotspot').each(function(i, el) {
    var $el = $(el);
    if ($el.hasClass('pbl-hotspot-tried-test') || $el.hasClass('pbl-hotspot-tried')) {
      answers.push(i);
    }
  });
  this.answer = answers.join('|');
  return this.answer;
};
GradableHotspot.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + ' .pbl-hotspot');
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].classList.remove(this.triedClass);
    inputs[i].classList.remove(this.correctImg.addClass);
    inputs[i].classList.remove(this.incorrectImg.addClass);
  }
};
GradableHotspot.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  $(this.selector + ' .pbl-hotspot').each(function(i, el) {
    var $el = $(el);
    if (answer.includes(i)) {
      var isCorrect = (parseInt($el.attr('data-status')) >> 8) % 2;
      var centerPoint = this.getPosition($el.position(), $el.outerWidth(), $el.outerHeight(), 1);
      var newTopLeft = this.getPosition(centerPoint, this.correctImg.width, this.correctImg.height, -1);
      $el.attr('style', 'top:' + newTopLeft.top + 'px;left:' + newTopLeft.left + 'px;width:' + this.correctImg.width + 'px;height:' + this.correctImg.height + 'px;');
      if (isCorrect) {
        $el.addClass(this.correctImg.addClass);
      } else {
        $el.addClass(this.incorrectImg.addClass);
      }
    }
  }.bind(this));
};

function DragAndDrop(selector, problem) {
  if (!problem) return;
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'Not all answers have been dragged to the correct spot.';
  this.noInteractMessage = interactStudentMessages[1];
  this.dragAndDropVersion = 1;
  this.missedAnswers = 0;
  this.noPointOnIncomplete = false;
  this.totalCorrect = this.getTotalCorrect();
  this.setup(problem);
  this.showNextAnswer();
}
DragAndDrop.prototype = new ManipulativeBase();
DragAndDrop.prototype.constructor = DragAndDrop;
DragAndDrop.prototype.setup = function(problem) {
  if ((typeof this.problem != 'undefined') && (this.problem.IsDragDropNoGrayArea != null && this.problem.IsDragDropNoGrayArea != '' && this.problem.IsDragDropNoGrayArea > 0)) {
    if (this.problem.IsDragDropNoGrayArea == 1)
      $(this.selector).addClass('pbl-nobackground');
    else
    if (this.problem.IsDragDropNoGrayArea == 2)
      $(this.selector).addClass('pbl-bottombackground');
    else
    if (this.problem.IsDragDropNoGrayArea > 2 && typeof this.problem.DragDropGrayAreaWidth != 'undefined' && this.problem.DragDropGrayAreaWidth > 0)
      $(this.selector).addClass('pbl-leftbackground');
  }
  this.DragDropCorrectCount = this.getTotalCorrectCount();
  this.bindEvents();
  this.setupSecondary(true, problem);
};
DragAndDrop.prototype.getAnswerAssoc = function(answer) {
  var ans = [];
  if (answer && typeof answer == 'string' && answer != '') {
    var ansHotspots = answer.split(' ');
    for (var i = 0; i < ansHotspots.length; i++) {
      if ((typeof ansHotspots[i] == 'string') && (ansHotspots[i].indexOf('-') >= 0)) {
        var idcnt = ansHotspots[i].split('-');
        if (this.dragAndDropVersion == 1) {
          ans.push({
            'id': this.getID(idcnt[0]),
            'cnt': this.getID(idcnt[1]),
            'stat': answer
          });
        } else {
          ans.push({
            'id': this.getIDTwo(idcnt[0]),
            'cnt': this.getIDTwo(idcnt[1]),
            'stat': answer
          });
        }
      } else {
        if (this.dragAndDropVersion == 1) {
          ans.push({
            'id': ((typeof ansHotspots[i] == 'string') ? this.getID(ansHotspots[i]) : -1),
            'cnt': 100,
            'stat': answer
          });
        } else {
          ans.push({
            'id': ((typeof ansHotspots[i] == 'string') ? this.getIDTwo(ansHotspots[i]) : -1),
            'cnt': 100,
            'stat': answer
          });
        }
      }
    }
  }
  return ans;
};
DragAndDrop.prototype.answerMatch = function(answer, hotspot) {
  var ans = this.getAnswerAssoc(answer);
  var hot = this.getID(hotspot);
  if (this.dragAndDropVersion == 2) {
    hot = this.getIDTwo(hotspot);
  }
  isMatch = -1;
  for (var i = 0; i < ans.length; i++)
    if (ans[i].id == hot) {
      isMatch = 0;
      if ((this.getAnswerCountInHotspot(answer, hotspot) < ans[i].cnt) && this.hotspotHasRoom(hotspot))
        isMatch = 1;
      break;
    }
  return isMatch;
};
DragAndDrop.prototype.hotspotHasRoom = function(hotspot) {
  var hasRoom = false;
  var _this = this;
  $(this.selector + ' .pbl-hotspot-drop').each(function() {
    if ($(this).attr('data-status') == hotspot) {
      var maxAllowed = _this.getID($(this).attr('data-count'));
      if (_this.dragAndDropVersion == 2) {
        maxAllowed = _this.getIDTwo($(this).attr('data-count'));
      }
      if ((maxAllowed < 0) || (maxAllowed >= 0 && $('.pbl-dragdrop-answer', $(this)).length < maxAllowed))
        hasRoom = true;
    }
  });
  return hasRoom;
};
DragAndDrop.prototype.getAnswerCountInHotspot = function(answer, hotspot) {
  var count = 0;
  $(this.selector + ' .pbl-hotspot-drop').each(function() {
    if ($(this).attr('data-status') == hotspot) {
      $('.pbl-dragdrop-answer', $(this)).each(function() {
        if ($(this).attr('data-status') == answer) count++;
      });
    }
  });
  return count;
};
DragAndDrop.prototype.getAnswerCountInHotspots = function(answer) {
  var count = 0;
  $(this.selector + ' .pbl-hotspot-drop').each(function() {
    $('.pbl-dragdrop-answer', $(this)).each(function() {
      if ($(this).attr('data-status') == answer) count++;
    });
  });
  return count;
};
DragAndDrop.prototype.getTotalCorrectCount = function() {
  return ((typeof this.problem != 'undefined') && (typeof this.problem.DragDropCorrectCount != 'undefined') && this.problem.DragDropCorrectCount !== null && this.problem.DragDropCorrectCount != '' && (parseInt(this.problem.DragDropCorrectCount) > 0)) ? parseInt(this.problem.DragDropCorrectCount) : 0;
};
DragAndDrop.prototype.getTotalAnswers = function() {
  return $(this.selector + ' .pbl-hotspot-drop-container .pbl-dragdrop-answer').length;
};
DragAndDrop.prototype.getTotalCorrect = function() {
  var _this = this;
  var totalCorrect = 0;
  var hotspots = [];
  $(this.selector + ' .pbl-hotspot-drop').each(function() {
    hotspots.push($(this).attr('data-status'));
  });
  $(this.selector + ' .pbl-dragdrop-answer').each(function() {
    var x = $(this).attr('data-status');
    for (var i = 0; i < hotspots.length; i++)
      if (_this.answerMatch(x, hotspots[i]) >= 0) {
        totalCorrect++;
        break;
      }
  });
  return totalCorrect;
};
DragAndDrop.prototype.getCorrectCount = function() {
  var correctCount = 0;
  $(this.selector + ' .pbl-hotspot-drop').each(function(i, hot) {
    var hotStatus = $(hot).attr('data-status');
    $('.pbl-dragdrop-answer', $(hot)).each(function(idx, ans) {
      if (this.answerMatch($(ans).attr('data-status'), hotStatus) >= 0) {
        correctCount++;
      }
    }.bind(this));
  }.bind(this));
  return correctCount;
};
DragAndDrop.prototype.getIncorrectCount = function() {
  var incorrectCount = 0;
  $(this.selector + ' .pbl-hotspot-drop').each(function(i, hot) {
    var hotStatus = $(hot).attr('data-status');
    $('.pbl-dragdrop-answer', $(hot)).each(function(idx, ans) {
      incorrectCount += this.answerNotMatch($(ans).attr('data-status'), hotStatus);
    }.bind(this));
  }.bind(this));
  return incorrectCount;
};
DragAndDrop.prototype.answerNotMatch = function(answer, hotspot) {
  var ans = this.getAnswerAssoc(answer);
  var hot = this.getID(hotspot);
  if (this.dragAndDropVersion == 2) {
    hot = this.getIDTwo(hotspot);
  }
  isNotMatch = 1;
  for (var i = 0; i < ans.length; i++) {
    if (ans[i].id == hot) {
      isNotMatch = 0;
      break;
    }
  }
  return isNotMatch;
};
DragAndDrop.prototype.checkHotspotsCapacity = function() {
  var ret = true;
  $(this.selector + ' .pbl-hotspot-drop').each(function(i, hot) {
    if (typeof $(hot).attr('data-count') != 'undefined') {
      var hotCount = this.getID($(hot).attr('data-count'));
      if (this.dragAndDropVersion == 2) {
        hotCount = this.getIDTwo($(hot).attr('data-count'));
      }
      ret = ret & (hotCount >= $('.pbl-dragdrop-answer', $(hot)).length);
    }
  }.bind(this));
  return ret;
};
DragAndDrop.prototype.showNextAnswer = function() {
  $(this.selector + ' .pbl-dragdrop-showone .pbl-dragdrop-answer').not('.pbl-dragdrop-answer-correct').first().fadeIn(500).css('display', 'inline-block');
};
DragAndDrop.prototype.dropMiss = function() {
  this.setNoPoint(true);
};
DragAndDrop.prototype.studentDrags = function() {
  if (this.dragAndDropVersion == 1) {
    this.missedAnswers++;
    if (this.missedAnswers > 3) {
      this.evaluateCount = 2;
      this.showMessageNext();
      this.missedAnswers = 0;
    }
  }
};
DragAndDrop.prototype.isCompleted = function() {
  if (this.DragDropCorrectCount > 0) return (this.getIncorrectCount() == 0 && this.DragDropCorrectCount == this.getTotalAnswers());
  return (this.getIncorrectCount() == 0 && this.getCorrectCount() >= this.totalCorrect && this.checkHotspotsCapacity());
};
DragAndDrop.prototype.getElemRect = function($el) {
  return Reposition.prototype.getElemRect.call(this, $el);
};
DragAndDrop.prototype.bindEvents = function() {
  if (typeof this.problem == 'undefined') return;
  var _this = this;
  var animateBack, animateEl = null,
    afterDropSourceEl = null;
  var dropClass = 'pbl-hotspot-drop';
  var backgroundClass = 'pbl-background';
  var dropAnswersClass = 'pbl-dragdrop-answers';
  var dragDropSelector = this.selector + ' .pbl-dragdrop-answers .pbl-dragdrop-answer';
  if ((typeof this.problem != 'undefined') && (this.problem.IsDragDropNoGrayArea == true || this.problem.IsDragDropNoGrayArea == 1))
    dragDropSelector = dragDropSelector + ',' + this.selector + ' .pbl-background > .pbl-dragdrop-answer';
  this.eventTimestamp = 0;
  this.elementPosition = {};
  $(dragDropSelector).dragdrop({
    makeClone: true,
    sourceHide: true,
    appendDraggedTo: $('body'),
    dropClass: ((this.problem.DragDropShowHotspot && this.problem.DragDropShowHotspot == 1) ? 'pbl-hotspot-dropover' : ''),
    parentClass: dropClass,
    dragClass: 'dragged',
    container: $(this.selector),
    canDrag: function($src, e) {
      var clickedOnPlayIcon = $(e.target).hasClass('play_icon');
      if ($(e.target).closest('.pbl-dragdrop-answer').hasClass('shouldPlaySound') && ManipulativeSoundSetting >= 1) {
        var tmpEvent = $.extend({}, e, {
          target: $(e.target).closest('.pbl-dragdrop-answer')
        });
        if (typeof app !== 'undefined' && app.labObject) {
          app.labObject.autoSoundClick(tmpEvent, _this.problem);
        } else {
          var event;
          if (document.createEvent) {
            event = document.createEvent("HTMLEvents");
            event.initEvent("manipulatives:playSound", true, true);
          } else {
            event = document.createEventObject();
            event.eventType = "manipulatives:playSound";
          }
          event.eventName = "manipulatives:playSound";
          event.details = tmpEvent;
          if (document.createEvent) {
            document.dispatchEvent(event);
          } else {
            document.fireEvent("on" + event.eventType, event);
          }
        }
      }
      animateBack = true;
      _this.dropArea = Reposition.prototype.getDropAreas.call(_this, $(_this.selector + ' .' + dropClass));
      if (_this.isTestManipulative) {
        _this.dropAnswersArea = Reposition.prototype.getDropAreas.call(_this, $(_this.selector + ' .' + dropAnswersClass + ' .pbl-dragdrop-answer'));
      }
      _this.studentInteracted = true;
      _this.noPointOnIncomplete = true;
      return (($src.hasClass('pbl-dragdrop-answer-correct') && (_this.dragAndDropVersion == 1 && _this.DragDropCorrectCount <= 0)) || (animateEl !== null) || clickedOnPlayIcon) ? null : $src;
    },
    onScroll: function() {
      _this.dropArea = Reposition.prototype.getDropAreas.call(_this, $(_this.selector + ' .' + dropClass));
      if (_this.isTestManipulative) {
        _this.dropAnswersArea = Reposition.prototype.getDropAreas.call(_this, $(_this.selector + ' .' + dropAnswersClass + ' .pbl-dragdrop-answer'));
      }
    },
    canDrop: function($dst) {
      var hasDropClass = ($dst.hasClass(dropClass) || $dst.parents('.' + dropClass).size() > 0);
      var hasBackgroundClass = ($dst.hasClass(backgroundClass) || $dst.parents('.' + backgroundClass).size() > 0);
      var hasDropAnswersClass = ($dst.parents('.' + dropAnswersClass).size() > 0);
      return (_this.isTestManipulative) ? ((hasDropClass || hasBackgroundClass) && !hasDropAnswersClass) : hasDropClass;
    },
    didDrop: function($src, $dst, e) {
      var dropTarget;
      if (_this.isTestManipulative) {
        dropTarget = $dst.hasClass(dropClass) ? $dst : ($dst.parents('.' + dropClass).length ? $dst.parents('.' + dropClass) : ($dst.hasClass(backgroundClass) ? $dst : $dst.parents('.' + backgroundClass)));
        $src.css('display', '');
        var $el = $src.clone(true);
        if (dropTarget.hasClass('pbl-hotspot-drop-nocenter') || !dropTarget.hasClass(dropClass)) {
          var $active = $('.pbl-dragdrop-answer.dragged');
          $src.css({
            'top': ($active.offset().top - dropTarget.offset().top) + 'px',
            'left': ($active.offset().left - dropTarget.offset().left) + 'px',
            'position': 'absolute'
          });
          $('img', $src).css({
            'max-width': 'none'
          });
        } else {
          $src.css({
            'position': ''
          });
        }
        var doSwapAnswer = false;
        if (_this.dragAndDropVersion == 1) {
          doSwapAnswer = (_this.getID(dropTarget.attr('data-count')) == 1 && !_this.hotspotHasRoom($dst.attr('data-status')));
        } else if (_this.dragAndDropVersion == 2) {
          doSwapAnswer = ($(_this.selector + ' .' + dropClass + '.pbl-hotspot-single-answer').length == $(_this.selector + ' .' + dropClass).length && dropTarget.hasClass('pbl-hotspot-single-answer') && dropTarget.find('.pbl-dragdrop-answer').length == 1) ? true : false;
        }
        if ($src.parents('.pbl-dragdrop-answers').length) {
          $el.insertAfter($src);
        } else {
          $el.remove();
        }
        $src.appendTo(dropTarget.hasClass(dropClass) ? $('.pbl-hotspot-drop-container', dropTarget) : dropTarget);
        animateBack = false;
        _this.completed = _this.isCompleted();
        _this.showNextAnswer();
        if (doSwapAnswer) {
          afterDropSourceEl = $('.pbl-dragdrop-answer:first-child', dropTarget);
          animateEl = afterDropSourceEl.clone(false);
          animateEl.css({
            'position': 'absolute',
            'left': dropTarget.offset().left,
            'top': dropTarget.offset().top
          });
          animateEl.appendTo($('body'));
          afterDropSourceEl.css('display', 'none');
          animateBack = true;
        } else if (dropTarget.find('.pbl-dragdrop-answer').length > _this.getID($dst.attr('data-count')) && _this.problem.BounceBack == 1) {
          animateBack = true;
        }
      } else {
        dropTarget = $dst.hasClass(dropClass) ? $dst : $dst.parents('.' + dropClass);
        if (_this.answerMatch($src.attr('data-status'), dropTarget.attr('data-status')) >= 1) {
          if (_this.dragAndDropVersion == 1)
            $src.addClass('pbl-dragdrop-answer-correct');
          $src.css('display', '');
          var $el = $src.clone(true);
          if (dropTarget.hasClass('pbl-hotspot-drop-nocenter')) {
            var $active = $('.pbl-dragdrop-answer.dragged');
            $src.css({
              'top': ($active.offset().top - dropTarget.offset().top) + 'px',
              'left': ($active.offset().left - dropTarget.offset().left) + 'px'
            });
          }
          if ($src.parents('.pbl-hotspot-drop-container').length) $el.remove();
          else $el.insertAfter($src);
          $src.appendTo($('.pbl-hotspot-drop-container', dropTarget));
          animateBack = false;
          _this.completed = _this.isCompleted();
          _this.showNextAnswer();
        } else {
          if (!($('.pbl-dragdrop-answer-correct', dropTarget).length && (_this.dragAndDropVersion == 1 && _this.DragDropCorrectCount <= 0))) {
            _this.dropMiss();
          }
          if (_this.dragAndDropVersion == 2) {
            _this.dropMiss();
          } else if (_this.dragAndDropVersion == 1) {
            _this.studentDrags();
          }
        }
      }
    },
    beforeDrop: function($sourceElement, $destElement, $activeElement, e, didMove) {
      animateBack = (animateBack && didMove);
      if (animateBack && animateEl == null) {
        animateEl = $activeElement.clone(false);
        animateEl.insertAfter($activeElement);
      }
    },
    afterDrop: function($src, $dst, e) {
      if (animateBack) {
        var dataStatus = $(animateEl).attr('data-status');
        var destPos = {
          top: 0,
          left: 0
        };
        var srcPos = $(animateEl).offset();
        var $destEl = null;
        $(dragDropSelector).each(function(i) {
          if ($(this).attr('data-status') == dataStatus) {
            destPos = $(this).offset();
            $destEl = $(this);
            return false;
          }
        });
        var localSourceElement = $src;
        if (afterDropSourceEl != null) {
          localSourceElement = afterDropSourceEl;
        } else {
          localSourceElement.css('visibility', 'hidden');
        }
        if ((Math.abs(srcPos.top - destPos.top) < 5) && (Math.abs(srcPos.left - destPos.left) < 5))
          $(((' ' + $(e.target).attr('class')).replace(/  /g, ' ').replace(/ /g, '.')), localSourceElement).click();
        animateEl.animate({
          left: destPos.left,
          top: destPos.top
        }, {
          duration: 400,
          always: function(animation, jumpedToEnd) {
            if (localSourceElement.parents('.pbl-hotspot-drop-container').length || localSourceElement.parents('.pbl-dragdrop-answers').length == 0) {
              localSourceElement.remove();
              if ($destEl) {
                $destEl.css('visibility', '');
              }
            } else localSourceElement.css('visibility', '');
            animateEl.remove();
            animateEl = afterDropSourceEl = null;
            animateBack = false;
            _this.completed = _this.isCompleted();
          }
        });
      }
    },
    getDropTarget: function($activeElement, posX, posY) {
      var elOffset = _this.getElemRect($activeElement);
      var x = elOffset.x1 + (elOffset.x2 - elOffset.x1) / 2;
      var y = elOffset.y1 + (elOffset.y2 - elOffset.y1) / 2;
      var cursor = {
        x1: x,
        x2: x,
        y1: y,
        y2: y
      };
      if (_this.isTestManipulative) {
        var hot = Reposition.prototype.getIntersect.call(_this, _this.dropArea, cursor, true);
        if (!hot) {
          hot = Reposition.prototype.getIntersect.call(_this, _this.dropAnswersArea, cursor, true);
          if (!hot) {
            hot = Reposition.prototype.getIntersect.call(_this, [_this.getElemRect($(_this.selector + ' .' + backgroundClass))], cursor, true);
          }
        }
        return hot;
      } else {
        return Reposition.prototype.getIntersect.call(_this, _this.dropArea, cursor, true);
      }
    }
  });
};
DragAndDrop.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.selector + ' .pbl-hotspot-drop .pbl-dragdrop-answer').remove();
    var dragDropSelector = this.selector + ' .pbl-dragdrop-answers .pbl-dragdrop-answer';
    if ((typeof this.problem != 'undefined') && (this.problem.IsDragDropNoGrayArea == true || this.problem.IsDragDropNoGrayArea == 1))
      dragDropSelector = dragDropSelector + ',' + this.selector + ' .pbl-background > .pbl-dragdrop-answer';
    $(dragDropSelector).each(function(i, ans) {
      var answerCount = 0;
      var maxAnswerCount = 1;
      if (this.dragAndDropVersion == 2) {
        maxAnswerCount = $(ans).attr('data-target') ? this.getIDTwo($(ans).attr('data-target')) : 100;
      }
      $(this.selector + ' .pbl-hotspot-drop').each(function(j, hot) {
        while (answerCount < maxAnswerCount && this.hotspotHasRoom($(hot).attr('data-status')) && this.answerMatch($(ans).attr('data-status'), $(hot).attr('data-status')) >= 1) {
          var $el = $(ans).clone(true);
          $el.css({
            'display': '',
            'opacity': '',
            visibility: ''
          });
          $el.appendTo($('.pbl-hotspot-drop-container', $(hot)));
          answerCount++;
        }
      }.bind(this));
      if (this.dragAndDropVersion == 1 && answerCount > 0) {
        $(ans).css({
          visibility: 'hidden'
        });
      }
    }.bind(this));
  }
};

function Explore(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'Please click all the buttons.';
  this.triedClass = 'pbl-hotspot-tried';
  this.noPointOnIncomplete = false;
  this.inOrder = (typeof this.problem.IsClickButtonsInOrder !== 'undefined' && (this.problem.IsClickButtonsInOrder == true || this.problem.IsClickButtonsInOrder == 1)) ? true : false;
  this.nextButton = 1;
  this.bindEvents();
}
Explore.prototype = new ManipulativeBase();
Explore.prototype.constructor = Explore;
Explore.prototype.checkNextIcon = function() {
  var classes = ['pbl-hotspot-explore-br', 'pbl-hotspot-explore-sr', 'pbl-hotspot-explore-bw', 'pbl-hotspot-explore-sw'];
  for (var i = 0; i < classes.length; i++) {
    if ($(this.selector + ' .pbl-hotspot-explore.' + classes[i] + this.nextButton).length) {
      return classes[i] + this.nextButton;
    } else {
      for (var j = (this.nextButton + 1); j <= 6; j++) {
        if ($(this.selector + ' .pbl-hotspot-explore.' + classes[i] + j).length) {
          this.nextButton = j;
          return classes[i] + j;
        }
      }
    }
  }
  return false;
};
Explore.prototype.checkNextButton = function(element) {
  if (!this.inOrder) return true;
  var nextButtonClass = this.checkNextIcon();
  if (element.hasClass(nextButtonClass)) {
    this.nextButton++;
    return true;
  }
  return false;
};
Explore.prototype.bindEvents = function() {
  var _this = this;
  $(this.selector + ' .pbl-hotspot-explore').on('click', function(e) {
    if (_this.checkNextButton($(this))) {
      _this.onHotspotClick($(this));
    } else {
      alert('Please click the buttons in order.');
    }
  });
  $(this.selector + ' .pbl-hotspot-explore-feedback').on('click', function(e) {
    if (!_this.inOrder) {
      if (!$(e.target).hasClass('play_icon_explore')) {
        var status = parseInt($(this).attr('data-status'));
        var $el = $(this);
        $(_this.selector + ' .pbl-hotspot-sound-icon.pbl-hotspot-attached').each(function() {
          var x = parseInt($(this).attr('data-status'));
          if (x == status) {
            $(this).hide();
          }
        });
        $(_this.selector + ' .pbl-hotspot-explore').each(function() {
          var x = parseInt($(this).attr('data-status'));
          if (x == status) {
            $el.hide();
            $(this).show();
          }
        });
      }
    }
  });
};
Explore.prototype.onHotspotClick = function($el) {
  var _this = this;
  var hide = (!$el.hasClass('pbl-hotspot-explore-area'));
  var status = parseInt($el.attr('data-status'));
  if (!$el.hasClass(this.triedClass))
    $el.addClass(this.triedClass);
  $(this.selector + ' .pbl-hotspot-explore-feedback').each(function() {
    var x = parseInt($(this).attr('data-status'));
    if (x == status) {
      if (hide) $el.hide();
      $(this).toggle();
      var expandHeight = $(this).position().top + $(this).height();
      if ($(_this.selector + ' .pbl-background').height() < expandHeight)
        $(_this.selector + ' .pbl-background').css('height', expandHeight + 'px');
    }
  });
  $(this.selector + ' .pbl-hotspot-sound-icon.pbl-hotspot-attached').each(function() {
    var x = parseInt($(this).attr('data-status'));
    if (x == status) {
      if (hide) $el.hide();
      $(this).toggle();
    }
  });
  this.completed = ($(this.selector + ' .pbl-hotspot-explore').not('.' + this.triedClass).length <= 0);
};

function Bullet(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'Please open all bullet points.';
  this.triedClass = 'pbl-hotspot-tried';
  this.noPointOnIncomplete = false;
  this.bindEvents();
}
Bullet.prototype = new ManipulativeBase();
Bullet.prototype.constructor = Bullet;
Bullet.prototype.bindEvents = function() {
  var _this = this;
  $(this.selector + ' .pbl-hotspot-bullet').on('touchstart click', function(e) {
    if (e && e.target && e.target !== this && ($(e.target).hasClass('play_icon_mc') || $(e.target).hasClass('auto_play_icon'))) {
      return;
    }
    _this.onHotspotClick(e);
  });
};
Bullet.prototype.onHotspotClick = function(e) {
  var $el = $(e.currentTarget);
  if (e.handled !== true) {
    e.handled = true;
    var status = parseInt($el.attr('data-status'));
    $el.addClass(this.triedClass);
    $(this.selector + ' .pbl-hotspot-bullet-feedback').each(function() {
      var x = parseInt($(this).attr('data-status'));
      if (x == status)
        $(this).show();
    });
    this.completed = ($(this.selector + ' .pbl-hotspot-bullet').not('.' + this.triedClass).length <= 0);
  } else {
    return false;
  }
};

function Dropdown(selector, problem) {
  if (!problem) return;
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  if (this.isTestManipulative) {
    this.messageNext.message = 'Some answers are missing.';
  } else {
    this.messageNext.message = 'Some answers are missing or incorrect.';
  }
  this.noInteractMessage = interactStudentMessages[0];
  this.doSelfEvaluate();
  this.bindEvents();
  this.setupSecondary(true, problem);
}
Dropdown.prototype = new ManipulativeBase();
Dropdown.prototype.constructor = Dropdown;
Dropdown.prototype.getCorrectAnswers = function() {
  var answers = (this.getCorrectAnswer() + '').split('|');
  for (var i = 0; i < answers.length; i++) {
    answers[i] = answers[i].replace(/&#(\d+);/g, function(m, n) {
      if (n > 0xFFFF) {
        var H = Math.floor((n - 0x10000) / 0x400) + 0xD800;
        var L = (n - 0x10000) % 0x400 + 0xDC00;
        return String.fromCharCode(H, L);
      } else {
        return String.fromCharCode(n);
      }
    });
  }
  return answers;
};
Dropdown.prototype.doSelfEvaluate = function() {
  if (typeof this.problem == 'undefined') return;
  var _this = this;
  this.completed = true;
  this.setNoPoint(false);
  var answers = this.getCorrectAnswers();
  $(this.selector + ' .ms-pbl-dropdown-select-input').each(function(i, e) {
    $(this).removeClass('correct dropdown-selected');
    var selected = $(this).attr('data-value');
    if (_this.isTestManipulative) {
      $(this).addClass('dropdown-selected');
    }
    if ((selected == null) || selected == '')
      _this.completed = false;
    else {
      if (answers && answers[i] && (answers[i] != selected)) {
        _this.completed = false;
        _this.setNoPoint(true);
      } else {
        if (!_this.isTestManipulative) {
          $(this).addClass('correct');
        }
      }
    }
  });
  return this.completed;
};
Dropdown.prototype.isAnswerEntered = function() {
  var answers = this.getCorrectAnswers();
  var elements = document.querySelectorAll(this.selector + ' .ms-pbl-dropdown-select-input');
  for (var i = 0; i < elements.length; i++) {
    if (!elements[i].getAttribute('data-value') || (!this.isTestManipulative && elements[i].getAttribute('data-value') != answers[i])) {
      return false;
    }
  }
  return true;
};
Dropdown.prototype.closeAll = function() {
  var selectedVal = $(this.selector + ' .ms-pbl-dropdown-select-open').find('.ms-pbl-dropdown-select-input').attr('data-value');
  $(this.selector + ' .ms-pbl-dropdown-select-open').find('.ms-pbl-dropdown-select-input').html(selectedVal);
  $(this.selector + ' .ms-pbl-dropdown-select-open').find('.ms-pbl-dropdown-select-option[data-value="' + selectedVal + '"]').removeClass('ms-pbl-dropdown-select-option-selected');
  $(this.selector + ' .ms-pbl-dropdown-select-open').removeClass('ms-pbl-dropdown-select-open');
  if ($(this.selector + ' .ms-pbl-bubble-select-open').length) {
    $(this.selector + ' .ms-pbl-bubble-select-open').css({
      'height': 'auto'
    });
    $(this.selector + ' .ms-pbl-bubble-select-open').removeClass('ms-pbl-bubble-select-open');
  }
};
Dropdown.prototype.bindEvents = function() {
  var _this = this;
  $(this.selector + ' .ms-pbl-dropdown-select-option').on('click', function(e) {
    _this.studentInteracted = true;
    $(this).siblings('.ms-pbl-dropdown-select-option').removeClass('ms-pbl-dropdown-select-option-selected');
    $(this).addClass('ms-pbl-dropdown-select-option-selected');
    $(this).siblings('.ms-pbl-dropdown-select-input').attr('data-value', $(this).attr('data-value')).html($(this).html());
    _this.closeAll();
    _this.doSelfEvaluate();
    e.stopPropagation();
  });
  $(this.selector + ' .ms-pbl-dropdown-select').on('click', function(e) {
    var el = $(this);
    _this.closeAll();
    el.toggleClass('ms-pbl-dropdown-select-open');
    var selectedVal = $(this).find('.ms-pbl-dropdown-select-input').attr('data-value');
    if (el.hasClass('ms-pbl-dropdown-select-open')) {
      $(this).find('.ms-pbl-dropdown-select-input').html('');
      $(this).find('.ms-pbl-dropdown-select-option[data-value="' + selectedVal + '"]').addClass('ms-pbl-dropdown-select-option-selected');
    } else {
      $(this).find('.ms-pbl-dropdown-select-input').html(selectedVal);
      $(this).find('.ms-pbl-dropdown-select-option[data-value="' + selectedVal + '"]').removeClass('ms-pbl-dropdown-select-option-selected');
    }
    if (el.parents('.ms-pbl-bubble').length) {
      el.parents('.ms-pbl-bubble').toggleClass('ms-pbl-bubble-select-open');
      if (el.parents('.ms-pbl-bubble').hasClass('ms-pbl-bubble-select-open')) {
        el.parents('.ms-pbl-bubble').css({
          'height': el.find('.ms-pbl-dropdown-select-answers').height() + 'px'
        });
      }
    }
    e.stopPropagation();
  });
  $(document).on('click', function(e) {
    _this.closeAll();
  });
};
Dropdown.prototype.parseAnswer = function() {
  this.answer = $(this.selector + ' .ms-pbl-dropdown-select-input').map(function() {
    return $(this).attr('data-value');
  }).get().join('|');
  return this.answer;
};
Dropdown.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    var answers = (this.getCorrectAnswer() + '').split('|');
    for (var i = 0; i < answers.length; i++) {
      answers[i] = answers[i].replace(/&#(\d+);/g, function(m, n) {
        return String.fromCharCode(n);
      });
    }
    $(this.selector + ' .ms-pbl-dropdown-select').each(function(i, el) {
      var $input = $('.ms-pbl-dropdown-select-input', $(el));
      $input.removeClass('dropdown-selected').addClass('correct');
      $('.ms-pbl-dropdown-select-option', $(el)).each(function(j, o) {
        if ($(o).attr('data-value') == answers[i]) {
          $input.attr('data-value', answers[i]).html($(o).html());
        }
      });
    });
  }
};
Dropdown.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + ' .ms-pbl-dropdown-select');
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].classList.remove('dropdown-selected');
    inputs[i].classList.remove('correct');
  }
};
Dropdown.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  var studentAnswers = (answer + '').split('|');
  var correctAnswers = (this.getCorrectAnswer() + '').split('|');
  for (var i = 0; i < correctAnswers.length; i++) {
    studentAnswers[i] = studentAnswers[i].replace(/&#(\d+);/g, function(m, n) {
      return String.fromCharCode(n);
    });
    correctAnswers[i] = correctAnswers[i].replace(/&#(\d+);/g, function(m, n) {
      return String.fromCharCode(n);
    });
  }
  $(this.selector + ' .ms-pbl-dropdown-select').each(function(i, el) {
    var $input = $('.ms-pbl-dropdown-select-input', $(el));
    if (studentAnswers[i] == correctAnswers[i]) {
      $input.addClass('correct');
    }
    $('.ms-pbl-dropdown-select-option', $(el)).each(function(j, o) {
      if ($(o).attr('data-value') == studentAnswers[i]) {
        $input.attr('data-value', studentAnswers[i]).html($(o).html());
      }
    });
  });
}

function Typeman(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  $(selector + ' img').on('dragstart', function(e) {
    e.preventDefault();
  });
  this.messageNext.message = 'Please enter an answer in each fill-in-the-blank space.';
  this.noInteractMessage = interactStudentMessages[1];
  var _this = this;
  $(this.selector).find('.ms-pbl-inputbox input').unbind(interactEvents.keyup).bind(interactEvents.keyup, function(e) {
    if ($(this).val().trim().length > 0) {
      _this.studentInteracted = true;
    }
  });
  this.isCaseSensitive = (typeof this.problem.IsCaseSensitive !== 'undefined' && (this.problem.IsCaseSensitive == true || this.problem.IsCaseSensitive == 1)) ? true : false;
  this.setupSecondary(true, problem);
  if (this.secondary != null) {
    this.secondary.inputElement = this.secondary.inputElement + '.pbl-ms-secondary';
  }
}
Typeman.prototype = new ManipulativeBase();
Typeman.prototype.constructor = Typeman;
Typeman.prototype.selfEvaluate = function() {
  return false;
};
Typeman.prototype.isAnswerEntered = function() {
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  }
  this.completed = ($(this.selector + ' .ms-pbl-inputbox input').map(function() {
    return ($(this).val() != '') ? null : 1;
  }).length == 0);
  return this.completed;
};
Typeman.prototype.isAnswerCorrect = function() {
  var _this = this;
  var reg;
  var m;
  var correctField = (this.getCorrectAnswer() + '').split("|");
  var isCorrect = true;
  $(this.selector + ' .ms-pbl-inputbox').each(function(i, e) {
    var studentAnswer = $('input', $(this)).val();
    var fieldType = $(this).attr('data-input-type');
    if (fieldType == 't') {
      if (_this.isCaseSensitive) {
        if (correctField[i].replace(' ', '') != studentAnswer.replace(' ', '')) {
          isCorrect = false;
        }
      } else if (correctField[i].replace(' ', '').toLowerCase() != studentAnswer.replace(' ', '').toLowerCase()) {
        isCorrect = false;
      }
    } else if (fieldType == 'n') {
      if (parseFloat(correctField[i].replace(" ", "").replace(",", "")) != parseFloat(studentAnswer.replace(/[^0-9\.\-]/g, "")))
        isCorrect = false;
    } else if (fieldType == 'f') {
      studentAnswer = studentAnswer.replace(',', '');
      reg = /(-?)\s*(\d+)\s+(\d+)\s*\/\s*(\d+)/g;
      m = reg.exec(studentAnswer);
      if (m) {
        if (!((parseFloat(correctField[i])).toDecimal(4) == (parseFloat(m[1] + '1') * (parseFloat(m[2]) + parseFloat(m[3]) / parseFloat(m[4]))).toDecimal(4))) isCorrect = false;
      } else {
        reg = /(-?)\s*(\d+)\s*(\/|:)\s*(-?)\s*(\d+)/g;
        var m = reg.exec(studentAnswer);
        if (m) {
          if (!((parseFloat(correctField[i])).toDecimal(4) == ((parseFloat(m[1] + '1') * parseFloat(m[2])) / (parseFloat(m[4] + '1') * parseFloat(m[5]))).toDecimal(4))) isCorrect = false;
        } else {
          if (parseFloat(correctField[i]) != parseFloat(studentAnswer.replace(/[^0-9\.\-]/g, ''))) isCorrect = false;
        }
      }
    }
    return isCorrect;
  });
  if (!isCorrect) this.setNoPoint(true);
  return (isCorrect ? 1 : 0);
};
Typeman.prototype.parseAnswer = function() {
  var answers = $(this.selector + ' .ms-pbl-inputbox input').map(function() {
    return $(this).val().replace(/  +/g, ' ').trim();
  }).get();
  this.answer = (answers.join('') != '') ? answers.join("|") : '';
  return this.answer;
};
Typeman.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    var answers = (this.getCorrectAnswer() + '').split('|');
    $(this.selector + ' .ms-pbl-inputbox').each(function(i, el) {
      $(this).find('input').val(answers[i]);
    });
  }
};
Typeman.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + ' .ms-pbl-inputbox');
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].value = ''
  }
};
Typeman.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  var answers = (answer + '').split('|');
  $(this.selector + ' .ms-pbl-inputbox').each(function(i, el) {
    $(this).find('input').val(answers[i]);
  });
};

function ShortShort(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  $(selector + ' img').on('dragstart', function(e) {
    e.preventDefault();
  });
  this.messageNext.message = 'Please enter an answer in the fill-in-the-blank space.';
  $(this.selector).find('.ms-pbl-shortshort textarea').unbind(interactEvents.keyup).bind(interactEvents.keyup, function() {
    this.studentInteracted = true;
  }.bind(this));
  this.setupSecondary(true, problem);
}
ShortShort.prototype = new ManipulativeBase();
ShortShort.prototype.constructor = ShortShort;
ShortShort.prototype.selfEvaluate = function() {
  return false;
};
ShortShort.prototype.isAnswerEntered = function() {
  this.completed = ($(this.selector + this.selector + ' .ms-pbl-shortshort textarea').map(function() {
    return $(this).val();
  }).get().join('') != '');
  return this.completed;
};
ShortShort.prototype.isAnswerCorrect = function() {
  var isCorrect = true;
  var correctField = (this.getCorrectAnswer() + '').toLowerCase().split("|");
  $(this.selector + ' .ms-pbl-shortshort textarea').each(function(i, e) {
    var studentAnswer = $(this).val().toLowerCase();
    var variation = correctField[i].split(';');
    var correct = false;
    for (var v = 0; v < variation.length; v++)
      if (studentAnswer.indexOf(variation[v]) != -1) {
        correct = true;
        break;
      }
    isCorrect = correct;
    return isCorrect;
  });
  if (!isCorrect) this.setNoPoint(true);
  return (isCorrect ? 1 : 0);
};
ShortShort.prototype.parseAnswer = function() {
  var answers = $(this.selector + ' .ms-pbl-shortshort textarea').map(function() {
    return $(this).val().replace(/  +/g, ' ').trim();
  }).get();
  this.answer = (answers.join('') != '') ? answers.join("|") : '';
  return this.answer;
};
ShortShort.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
  }
};

function MC(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'Please check all the correct answers.';
  this.triedClass = 'pbl-hotspot-tried';
  this.bindEvents();
}
MC.prototype = new ManipulativeBase();
MC.prototype.constructor = MC;
MC.prototype.selfEvaluate = function() {
  return (this.isSecondary ? false : ManipulativeBase.prototype.selfEvaluate.call(this));
};
MC.prototype.checkCompleted = function() {
  this.completed = (this.getSelectedAnswers(true) == this.getCorrectAnswer());
};
MC.prototype.bindEvents = function() {
  var _this = this;
  $(this.selector + ' .ms-pbl-manchoice-item').on('click', function(e) {
    _this.studentInteracted = true;
    var correct = (_this.getCorrectAnswer().indexOf($('.ms-pbl-manchoice', $(this)).attr('data-name')) != -1);
    if (_this.isTestManipulative || (!_this.isTestManipulative && !$(this).hasClass(_this.triedClass))) {
      if (!_this.isTestManipulative) {
        $(this).addClass(_this.triedClass);
      }
      if (_this.isTestManipulative) {
        if (_this.problem.IsChoiceRadio == 1) {
          $(_this.selector + ' .ms-pbl-manchoice-selected').not($(this)).removeClass('ms-pbl-manchoice-selected');
        }
        $(this).toggleClass('ms-pbl-manchoice-selected');
        _this.checkCompleted();
      } else {
        if (correct) {
          $(this).addClass('ms-pbl-manchoice-correct');
        } else {
          _this.setNoPoint.call(_this, true);
          $(this).addClass('ms-pbl-manchoice-incorrect');
        }
        _this.checkCompleted();
      }
    }
  });
};
MC.prototype.getSelectedAnswers = function(correct = false) {
  var className = (correct) ? 'ms-pbl-manchoice-correct' : this.triedClass;
  className = this.isTestManipulative ? 'ms-pbl-manchoice-selected' : className;
  return $(this.selector + ' .' + className + ' .ms-pbl-manchoice').map(function() {
    return $(this).attr('data-name');
  }).get().sort().join('|');
};
MC.prototype.parseAnswer = function() {
  return this.getSelectedAnswers();
};
MC.prototype.isAnswerEntered = function() {
  var correctManChoice = this.selector + ' .ms-pbl-manchoice-correct .ms-pbl-manchoice';
  var incorrectManChoice = this.selector + ' .ms-pbl-manchoice-incorrect .ms-pbl-manchoice';
  var bothManChoices = correctManChoice + ', ' + incorrectManChoice;
  if (!this.isSecondary) {
    var selectedAnswers = document.querySelectorAll(bothManChoices);
    this.noPointOnIncomplete = selectedAnswers.length > 0;
    return ManipulativeBase.prototype.isAnswerEntered.call(this);
  }
  if (this.isTestManipulative) {
    return document.querySelectorAll(this.selector + ' .ms-pbl-manchoice-selected').length !== 0;
  }
  var selectedAnswers = document.querySelectorAll(bothManChoices);
  this.noPointOnIncomplete = selectedAnswers.length > 0;
  return selectedAnswers.length > 0 || ManipulativeBase.prototype.isAnswerEntered.call(this);
};
MC.prototype.isAnswerCorrect = function() {
  if (this.isTestManipulative) {
    return this.completed;
  }
  return (this.getSelectedAnswers(true) == this.getCorrectAnswer() && (!this.isSecondary ? !this.noPoint : true));
};
MC.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    this.showAnswer(this.getCorrectAnswer());
  }
};
MC.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + ' .ms-pbl-manchoice-item');
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].classList.remove('ms-pbl-manchoice-selected');
    inputs[i].classList.remove('ms-pbl-manchoice-correct');
    inputs[i].classList.remove('ms-pbl-manchoice-incorrect');
    inputs[i].classList.remove(this.triedClass);
  }
};
MC.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  var correctClassName = this.isTestManipulative && this.problem.IsChoiceRadio == 1 ? 'ms-pbl-manchoice-selected' : 'ms-pbl-manchoice-correct';
  var incorrectClassName = (this.isTestManipulative && this.problem.IsChoiceRadio == 1) ? 'ms-pbl-manchoice-selected' : 'ms-pbl-manchoice-incorrect';
  $(this.selector + ' .ms-pbl-manchoice-item').each(function(i, el) {
    var dataName = $('.ms-pbl-manchoice', $(el)).attr('data-name');
    if (answer.indexOf(dataName) != -1) {
      if (this.getCorrectAnswer().indexOf(dataName) != -1) {
        $(el).addClass(correctClassName);
      } else {
        $(el).addClass(incorrectClassName);
      }
    }
  }.bind(this));
};

function Reposition(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'All answers must be dragged to their correct positions.';
  this.noInteractMessage = interactStudentMessages[1];
  this.bindEvents();
  this.setupSecondary(true, problem);
}
Reposition.prototype = new ManipulativeBase();
Reposition.prototype.constructor = Reposition;
Reposition.prototype.getElemRect = function($el) {
  var offset = $el.offset();
  return {
    el: $el,
    x1: offset.left,
    y1: offset.top,
    x2: offset.left + $el.outerWidth(),
    y2: offset.top + $el.outerHeight()
  };
};
Reposition.prototype.getDropAreas = function($elems) {
  var _this = this;
  var dropAreas = [];
  $elems.each(function() {
    dropAreas.push(_this.getElemRect($(this)));
  });
  return dropAreas;
};
Reposition.prototype.getIntersect = function(elems, el, inside) {
  var intersect = null;
  for (var i = 0; i < elems.length; i++) {
    if (inside) {
      if (el.x1 >= elems[i].x1 && el.x2 <= elems[i].x2 && el.y1 >= elems[i].y1 && el.y2 <= elems[i].y2) {
        intersect = elems[i].el;
      }
    } else {
      if (!(el.x1 > elems[i].x2 || el.x2 < elems[i].x1 || el.y1 > elems[i].y2 || el.y2 < elems[i].y1)) {
        if (intersect) return null;
        intersect = elems[i].el;
      }
    }
  }
  return intersect;
};
Reposition.prototype.bindEvents = function() {
  var _this = this;
  var animateEl = {};
  var acceptDropClass = 'pbl-dragdrop-accept';
  var initialCell;
  $(this.selector + ' .pbl-dragdrop-answer').addClass(acceptDropClass);
  $(this.selector + ' .pbl-dragdrop-answer').dragdrop({
    makeClone: true,
    sourceHide: true,
    appendDraggedTo: $('body'),
    parentClass: acceptDropClass,
    dragClass: 'dragged',
    dropClass: 'drop',
    container: $(this.selector),
    canDrag: function($src, e) {
      var clickedOnPlayIcon = $(e.target).hasClass('play_icon');
      var isAlreadyAnsweredCorrectly = $(e.target).hasClass('pbl-answer-locked') || $(e.target).parent().hasClass('pbl-answer-locked');
      _this.studentInteracted = true;
      if (ManipulativeSoundSetting >= 1 && ($(e.target).hasClass('shouldPlaySound') || $(e.target).parent().hasClass('shouldPlaySound'))) {
        app.labObject.autoSoundClick(e, _this.problem);
      }
      if (!clickedOnPlayIcon && !isAlreadyAnsweredCorrectly) {
        initialCell = $src.parent();
        $src.removeClass(acceptDropClass);
        _this.dropArea = _this.getDropAreas($(_this.selector + ' .' + acceptDropClass));
      }
      return (clickedOnPlayIcon || isAlreadyAnsweredCorrectly) ? null : $src;
    },
    canDrop: function($dst) {
      return ($dst.hasClass(acceptDropClass) || ($dst.parents('.' + acceptDropClass).size()) > 0);
    },
    didDrop: function($src, $dst, e) {
      implicatedElements = [];
      var dropTarget = $dst.hasClass(acceptDropClass) ? $dst : $dst.parents('.' + acceptDropClass);
      if (((parseInt(dropTarget.parents('.pbl-hotspot:not(.pbl-hotspot-sound-icon)').attr('data-status') >> 8) % 16) == (parseInt($src.attr('data-status') >> 8) % 16)) || _this.isTestManipulative) {
        $src.appendTo(dropTarget.parent());
        var srcPos = dropTarget.offset();
        dropTarget.appendTo(initialCell);
        var destPos = dropTarget.offset();
        var animateExistingEl = dropTarget.clone(false);
        dropTarget.css('visibility', 'hidden');
        animateExistingEl.appendTo($('body'));
        animateExistingEl.addClass('pbl-answer-animate').css({
          'position': 'absolute',
          'top': srcPos.top + 'px',
          'left': srcPos.left + 'px'
        }).animate({
          left: destPos.left,
          top: destPos.top
        }, {
          duration: 400,
          always: function(animation, jumpedToEnd) {
            dropTarget.css('visibility', '');
            animateExistingEl.remove();
          }
        });
        _this.completed = true;
        $(_this.selector + ' .pbl-hotspot:not(.pbl-hotspot-sound-icon)').each(function() {
          var answer = parseInt($('.pbl-dragdrop-answer', $(this)).attr('data-status'));
          var current = parseInt($(this).attr('data-status'));
          if (((answer >> 8) % 16) != ((current >> 8) % 16)) {
            _this.completed = false;
          } else {
            if (!_this.isTestManipulative) {
              $(this).find('.pbl-dragdrop-answer').addClass('pbl-answer-locked');
            }
          }
        });
      } else {
        _this.setNoPoint(true);
      }
    },
    beforeDrop: function($sourceElement, $destElement, $activeElement, e) {
      var elementId = $sourceElement[0].getAttribute('data-status');
      animateEl[elementId] = $activeElement.clone(false);
      animateEl[elementId].insertAfter($activeElement);
    },
    afterDrop: function($src, $dst, e) {
      var destPos = $src.offset();
      $src.css('visibility', 'hidden');
      if (!$src.hasClass('pbl-answer-locked')) {
        $src.addClass(acceptDropClass);
      }
      var elementId = $src[0].getAttribute('data-status');
      animateEl[elementId].animate({
        left: destPos.left,
        top: destPos.top
      }, {
        duration: 400,
        always: function(animation, jumpedToEnd) {
          $src.css('visibility', '');
          animateEl[elementId].remove();
          animateEl[elementId] = null;
          var elementsToAnimate = $(_this.selector + ' .pbl-answer-locked:not(.pbl-already-animated)');
          elementsToAnimate.each(function(index) {
            var currentElement = $(this);
            currentElement.append('<div class="pbl-hotspot-correct"></div>').find('.pbl-hotspot-correct').fadeIn('slow').delay(1000).fadeOut('slow', function() {
              currentElement.addClass('pbl-already-animated').find('.pbl-hotspot-correct').remove();
            });
          });
        }
      });
    },
    getDropTarget: function($activeElement, posX, posY) {
      $activeElement.css("display", "none");
      var destElement = document.elementFromPoint(posX - document.documentElement.scrollLeft - document.body.scrollLeft, posY - document.documentElement.scrollTop - document.body.scrollTop);
      $activeElement.css("display", "");
      if (destElement) {
        var $dst = $(destElement);
        if ($dst.hasClass(acceptDropClass) || ($dst.parents('.' + acceptDropClass).size()) > 0)
          return destElement;
      }
      destElement = _this.getIntersect(_this.dropArea, _this.getElemRect($activeElement), false);
      return destElement;
    }
  });
};
Reposition.prototype.isAnswerEntered = function() {
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  }
  if (!this.completed && this.noPointOnIncomplete && this.hasStudentInteracted()) this.setNoPoint(true);
  return this.completed;
};
Reposition.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    this.showAnswer(true);
  }
};
Reposition.prototype.showAnswer = function(answer) {
  if (answer === true) {
    $(this.selector + ' .pbl-dragdrop-answer').each(function(i, e) {
      var answer = $(e).attr('data-status');
      $(this.selector + ' .pbl-hotspot:not(.pbl-hotspot-sound-icon)').each(function(j, hot) {
        var current = parseInt($(hot).attr('data-status'));
        if (((answer >> 8) % 16) == ((current >> 8) % 16)) {
          $(e).appendTo($('.pbl-hotspot-drop-container', $(hot)));
        }
      }.bind(this));
    }.bind(this));
  }
};
Reposition.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + ' .pbl-hotspot:not(.pbl-hotspot-sound-icon)');
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].remove();
  }
};

function Intro(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.completed = true;
}
Intro.prototype = new ManipulativeBase();
Intro.prototype.constructor = Intro;
Intro.prototype.needEvaluation = function() {
  return false;
};
Intro.prototype.showAnswer = function(answer) {};

function Build(selector, problem) {
  if (!problem) return;
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.completed = true;
  this.studentInteracted = true;
  this.bindEvents();
  this.setupSecondary(true, problem);
}
Build.prototype = new ManipulativeBase();
Build.prototype.constructor = Build;
Build.prototype.bindEvents = function() {
  var dropContainer = 'pbl-background';
  $(this.selector + ' .' + dropContainer).addClass('drop');
  $(this.selector + ' .pbl-build-answer').dragdrop({
    makeClone: true,
    sourceHide: true,
    container: $(this.selector),
    dragClass: 'dragged',
    appendDraggedTo: $('body'),
    parentClass: dropContainer,
    container: $(this.selector),
    canDrag: function($src, e) {
      return $src;
    },
    beforeDrop: function($src, $dst, $active, e) {
      if ($dst) {
        var d = $dst.hasClass('drop') ? $dst : $dst.parents('.drop');
        $src.css({
          'top': ($active.offset().top - d.offset().top) + 'px',
          'left': ($active.offset().left - d.offset().left) + 'px'
        });
      }
    },
    didDrop: function($src, $dst, e) {}
  });
};
Build.prototype.needEvaluation = function() {
  return false;
};
Build.prototype.problemHasFeedback = function() {
  return (typeof this.problem.Feedback != 'undefined' && this.problem.Feedback != '');
};
Build.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.selector + ' .pbl-hotspot-drop .pbl-hotspots').remove();
  }
};
Build.prototype.showAnswer = function(answer) {};

function DragAndAnswer(selector, problem) {
  Build.prototype.constructor.call(this, selector, problem);
}
DragAndAnswer.prototype = new Build();
DragAndAnswer.prototype.constructor = DragAndAnswer;
DragAndAnswer.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    this.showAnswer(true);
  }
};
DragAndAnswer.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  if (answer === true) {
    $(this.selector + ' .pbl-hotspot').each(function(i, el) {
      if ((parseInt($(el).attr('data-status')) >> 8) % 2) {
        $(el).addClass('pbl-hotspot-border pbl-hotspot-tried-correct');
      }
    });
  }
};
DragAndAnswer.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + ' .pbl-hotspot');
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].classList.remove(this.triedClass);
    inputs[i].classList.remove('pbl-hotspot-border');
    inputs[i].classList.remove('pbl-hotspot-tried-correct');
  }
};

function DragAndDrop2(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'Not all answers have been dragged to the correct spot.';
  this.noInteractMessage = interactStudentMessages[1];
  this.dragAndDropVersion = 2;
  this.backgroundClass = 'pbl-background';
  this.setup(problem);
}
DragAndDrop2.prototype = new DragAndDrop();
DragAndDrop2.prototype.constructor = DragAndDrop2;
DragAndDrop2.prototype.isAnswerEntered = function() {
  this.completed = this.isCompleted();
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  }
  if (!this.completed) {
    this.setNoPoint(true);
  }
  return this.completed;
};
DragAndDrop2.prototype.isCompleted = function() {
  if (this.DragDropCorrectCount > 0) {
    var ta = this.getTotalAnswers();
    return (this.DragDropCorrectCount == ta);
  }
  var _this = this;
  var completed = true;
  var totalCorrect = 0;
  $(this.selector + ' .pbl-dragdrop-answers .pbl-dragdrop-answer').each(function() {
    var tgt = $(this).attr('data-target');
    if (typeof tgt != 'undefined' && tgt !== null) {
      totalCorrect += _this.getIDTwo(tgt);
      if (_this.getAnswerCountInHotspots($(this).attr('data-status')) != _this.getIDTwo(tgt)) {
        completed = false;
      }
    }
  });
  if (($(this.selector + ' .' + this.backgroundClass + ' > .pbl-dragdrop-answer').length > 0) || (totalCorrect != _this.getCorrectCount())) {
    completed = false;
  }
  return completed;
};
DragAndDrop2.prototype.showNextAnswer = function() {
  $(this.selector + ' .pbl-dragdrop-answers .pbl-dragdrop-answer').css('visibility', '');
};

function BulletCFU(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'Please open all bullet points.';
  this.triedClass = 'pbl-hotspot-tried';
  this.noPointOnIncomplete = false;
  this.bindEvents();
}
BulletCFU.prototype = new Bullet();
BulletCFU.prototype.constructor = BulletCFU;
BulletCFU.prototype.showAnswer = function(answer) {};

function LabelImage(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  if (typeof this.problem == 'undefined') return;
  this.evaluateDropdown = false;
  this.noPointOnIncomplete = false;
  var answers = (this.getCorrectAnswer() + '').split('|');
  var blankTypes = (problem.BlankFieldType) ? problem.BlankFieldType.split('|') : [];
  var blankProblem = $.extend({}, problem);
  var dropDownProblem = $.extend({}, problem);
  blankProblem.CorrectAnswer = [];
  blankProblem.BlankFieldType = [];
  dropDownProblem.CorrectAnswer = [];
  $('.ms-pbl-dropdown-select-input, input:not(.pbl-ms-secondary)', $(selector + ' .pbl-hotspots')).each(function(idx, e) {
    if ($(e).is('input')) {
      blankProblem.CorrectAnswer.push(answers[idx]);
      blankProblem.BlankFieldType.push(blankTypes[idx]);
    } else {
      dropDownProblem.CorrectAnswer.push(answers[idx]);
    }
  });
  blankProblem.CorrectAnswer = blankProblem.CorrectAnswer.join('|');
  blankProblem.BlankFieldType = blankProblem.BlankFieldType.join('|');
  blankProblem.ProblemType = 'Draw';
  dropDownProblem.CorrectAnswer = dropDownProblem.CorrectAnswer.join('|');
  this.problem = dropDownProblem;
  if (this.isTestManipulative) {
    this.messageNext.message = 'Some answers are missing.';
  } else {
    this.messageNext.message = 'Some answers are missing or incorrect.';
  }
  this.noInteractMessage = interactStudentMessages[2];
  if (blankProblem.BlankFieldType != '') {
    this.mainEvaluation = new InteractBlank(this.selector, blankProblem);
    this.mainEvaluation.inputElement = this.mainEvaluation.inputElement + ':not(.pbl-ms-secondary)';
    this.mainEvaluation.mustFillAll = true;
    this.mainEvaluation.messageNext = $.extend({}, this.messageNext);
    this.mainEvaluation.messageNext.message = 'Please enter an answer for each blank.';
  }
  if ($(this.selector + ' .ms-pbl-dropdown-select-input').length > 0) {
    this.doSelfEvaluate();
    this.evaluateDropdown = true;
  }
  this.bindEvents();
  this.setupSecondary((typeof this.mainEvaluation !== 'undefined') ? true : false, problem);
  if (this.secondary != null) {
    this.secondary.inputElement = this.secondary.inputElement + '.pbl-ms-secondary';
  }
  this.studentInteractBind();
};
LabelImage.prototype = new Dropdown();
LabelImage.prototype.constructor = LabelImage;
LabelImage.prototype.selfEvaluate = function() {
  return (this.secondary ? false : (typeof this.mainEvaluation === 'undefined' && !this.isTestManipulative));
};
LabelImage.prototype.isAnswerEntered = function() {
  var mainEvaluationAnswerEntered = true;
  if (typeof this.mainEvaluation !== 'undefined') {
    mainEvaluationAnswerEntered = this.mainEvaluation.isAnswerEntered();
    if (!this.isTestManipulative) {
      mainEvaluationAnswerEntered = mainEvaluationAnswerEntered && this.mainEvaluation.isAnswerCorrect();
    }
  }
  return (Dropdown.prototype.isAnswerEntered.call(this) && mainEvaluationAnswerEntered);
};
LabelImage.prototype.isAnswerCorrect = function() {
  var startCorrect = (this.evaluateDropdown) ? Dropdown.prototype.isAnswerCorrect.call(this) : true;
  return (startCorrect && ((typeof this.mainEvaluation !== 'undefined') ? this.mainEvaluation.isAnswerCorrect() : true));
};
LabelImage.prototype.parseAnswer = function() {
  return (typeof this.mainEvaluation !== 'undefined') ? this.mainEvaluation.parseAnswer() : true;
};
LabelImage.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    Dropdown.prototype.showProblemFeedback.call(this, options);
    if (typeof this.mainEvaluation !== 'undefined') this.mainEvaluation.showProblemFeedback(options);
  }
};
LabelImage.prototype.studentInteractBind = function() {
  var _this = this;
  $(this.selector).find('.ms-pbl-dropdown-select-option').unbind(interactEvents.click).bind(interactEvents.click, function() {
    this.studentInteracted = true;
  }.bind(this));
  $(this.selector).find('.ms-pbl-bubble input').unbind(interactEvents.keyup).bind(interactEvents.keyup, function(e) {
    if ($(this).val().trim().length > 0) {
      _this.studentInteracted = true;
    }
  });
  $(this.selector).find('.pbl-build-answer-input input').unbind(interactEvents.keyup).bind(interactEvents.keyup, function(e) {
    if ($(this).val().trim().length > 0) {
      _this.studentInteracted = true;
    }
  });
};
LabelImage.prototype.showAnswer = function(answer) {
  if (typeof this.mainEvaluation !== 'undefined') {
    this.mainEvaluation.showAnswer(answer);
  }
};

function SpellingWord(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  if (typeof this.problem == 'undefined') return;
  this.noPointOnIncomplete = false;
  this.spellProblem = {
    word: this.problem.StatementText,
    id: this.problem.pkMLProblemID,
    feedbackScreen: false,
    maxAttempts: 0,
    attempts: 0,
    autoplaySound: (typeof problem.autoplaySound !== 'undefined') ? problem.autoplaySound : true,
    isCaseSensitive: (typeof this.problem.IsCaseSensitive !== 'undefined' && (this.problem.IsCaseSensitive == true || this.problem.IsCaseSensitive == 1)) ? true : false
  };
  this.noInteractMessage = interactStudentMessages[1];
  this.bindEvents();
  $(this.selector + ' .lab-spell-feedback .lab-spell-tryagain').html('Try again!');
  if (this.spellProblem.autoplaySound) {
    $(this.selector + ' .problem-statement .auto_play_icon').click();
  }
  if ($(this.selector + ' .lab-spell-input input').length) {
    this.calculateTextSize();
  }
}
SpellingWord.prototype = new ManipulativeBase();
SpellingWord.prototype.constructor = SpellingWord;
SpellingWord.prototype.textWidth = function(text, font, letterSpacing) {
  if (!this.fakeEl) {
    var style = '';
    if (letterSpacing) {
      style += 'letter-spacing: ' + letterSpacing + 'px;';
    }
    this.fakeEl = $('<span id="text-width">').attr('style', style).hide().appendTo(document.body);
  }
  this.fakeEl.text(text || this.val() || this.text()).css('font', font || this.css('font'));
  return this.fakeEl.width();
};
SpellingWord.prototype.recursiveTextSize = function(size, letterSpacing, minSize, defaultSize, defaultLetterSpacing) {
  var currentLetterSpacing = defaultLetterSpacing - parseInt((defaultSize - size) / 10);
  var inputWidth = $(this.selector + ' .lab-spell-input input').width();
  var textWidth = this.textWidth(this.spellProblem.word, size + 'px arial', letterSpacing);
  if (textWidth > inputWidth && size > minSize) {
    return this.recursiveTextSize(size - 1, currentLetterSpacing, minSize, defaultSize, defaultLetterSpacing);
  } else {
    return {
      'size': size,
      'spacing': currentLetterSpacing
    };
  }
};
SpellingWord.prototype.calculateTextSize = function() {
  var defaultFontSize = parseInt($(this.selector + ' .lab-spell-input input').css('font-size').replace('px', ''), 10);
  var defaultLetterSpacing = parseInt($(this.selector + ' .lab-spell-input input').css('letter-spacing').replace('px', ''), 10);
  var inputWidth = $(this.selector + ' .lab-spell-input input').width();
  var textWidth = this.textWidth(this.spellProblem.word, defaultFontSize + 'px arial', defaultLetterSpacing);
  var finalTextSize = this.recursiveTextSize(defaultFontSize, defaultLetterSpacing, 30, defaultFontSize, defaultLetterSpacing);
  $(this.selector + ' .lab-spell-input input,' +
    this.selector + ' .lab-spell-feedback .lab-spell-inputhtml,' +
    this.selector + ' .lab-spell-feedback .lab-spell-word').css({
    'font-size': finalTextSize.size + 'px',
    'letter-spacing': finalTextSize.spacing + 'px'
  });
};
SpellingWord.prototype.bindEvents = function() {
  $(this.selector + ' .lab-spell-input input').focus();
  $(this.selector + ' .lab-spell-inputhtml').on('click', function() {
    $('.lab-next').click();
  });
  $(document).on('showProblemFeedback.MSLab', app.labObject.stopSounds.bind(app.labObject));
  var _this = this;
  $(this.selector).find('.lab-spell-input input').unbind(interactEvents.keyup).bind(interactEvents.keyup, function(e) {
    if ($(this).val().trim().length > 0) {
      _this.studentInteracted = true;
    }
  });
};
SpellingWord.prototype.hideSpellProblemFeedback = function() {
  this.spellProblem.feedbackScreen = false;
  $(this.selector + ' .lab-spell-input input').prop('disabled', false);
  $(this.selector + ' .lab-spell-format').removeClass('lab-spell-format-feedback');
  $(this.selector + ' .lab-spell-input input').focus();
};
SpellingWord.prototype.displaySpellProblemFeedback = function() {
  var html = '';
  for (var i = 0, wordLen = this.spellProblem.word.length; i < this.spellProblem.answer.length; i++) {
    if (i < wordLen) {
      var compare = this.spellProblem.word.charAt(i).toLowerCase() == this.spellProblem.answer.charAt(i).toLowerCase();
      if (this.spellProblem.isCaseSensitive) {
        compare = this.spellProblem.word.charAt(i) == this.spellProblem.answer.charAt(i);
      }
      if (compare) html += this.spellProblem.answer.charAt(i);
      else html += '<span class="orange">' + this.spellProblem.answer.charAt(i) + '</span>';
    } else {
      html += '<span class="orange">' + this.spellProblem.answer.charAt(i) + '</span>';
    }
  }
  if (html == '') html = '&nbsp;';
  this.spellProblem.feedbackScreen = true;
  $(this.selector + ' .lab-spell-input input').prop('disabled', true);
  $(this.selector + ' .lab-spell-format').addClass('lab-spell-format-feedback');
  $(this.selector + ' .lab-spell-inputhtml').html(html);
};
SpellingWord.prototype.testAnswer = function() {
  var ret = false;
  this.spellProblem.answer = $(this.selector + ' .lab-spell-input input').val().trim();
  ret = (this.spellProblem.answer.toLowerCase() == this.spellProblem.word.toLowerCase()) ? true : false;
  if (this.spellProblem.isCaseSensitive) {
    ret = (this.spellProblem.answer == this.spellProblem.word) ? true : false;
  }
  return ret;
};
SpellingWord.prototype.showMessageNext = function() {
  if (this.spellProblem.feedbackScreen) {
    this.hideSpellProblemFeedback();
  } else {
    if (!this.spellProblem.answer || this.spellProblem.answer.length == 0) {
      if (this.isTestManipulative) {
        ManipulativeBase.prototype.showMessageNext.call(this);
      } else {
        InteractBlank.prototype.showEnterAnswer.call(this);
      }
    } else {
      this.setNoPoint(true);
      this.displaySpellProblemFeedback();
    }
  }
};
SpellingWord.prototype.parseAnswer = function() {
  this.spellProblem.answer = $(this.selector + ' .lab-spell-input input').val().replace(/  +/g, ' ').trim();
  return this.spellProblem.answer;
};
SpellingWord.prototype.isAnswerEntered = function() {
  if (this.spellProblem.feedbackScreen) return false;
  this.completed = this.testAnswer();
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  } else {
    return ManipulativeBase.prototype.isAnswerEntered.call(this);
  }
};
SpellingWord.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.selector + ' .lab-spell-input input').val(this.spellProblem.word);
  }
};
SpellingWord.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + ' .lab-spell-input input');
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].classList.remove('correct-input');
    inputs[i].classList.remove('incorrect-input');
    inputs[i].value = ''
  }
};
SpellingWord.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  var correctField = (answer + '').split('|');
  var correctAnswer = (this.spellProblem.word + '').split("|");
  $(this.selector + ' .lab-spell-input input').each(function(i, e) {
    if (i < correctAnswer.length) {
      $(e).val(correctField[i]);
      if (correctAnswer[i].toLowerCase() === correctField[i].toLowerCase()) {
        $(e).addClass("correct-input");
      } else {
        $(e).addClass("incorrect-input");
      }
    }
  });
};

function HighlightText(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'Not all correct answers have been selected.';
  this.noInteractMessage = interactStudentMessages[0];
  this.currentProblemType = (this.isTestManipulative) ? 'test' : 'other';
  this.answerClass = {
    'test': ['pbl-hightlight-incorrect-answer-test', 'pbl-hightlight-correct-answer-test'],
    'other': ['pbl-hightlight-incorrect-answer', 'pbl-hightlight-correct-answer']
  };
  this.bindEvents();
  this.setupSecondary(true, problem);
}
HighlightText.prototype = new ManipulativeBase();
HighlightText.prototype.constructor = HighlightText;
HighlightText.prototype.bindEvents = function() {
  var _this = this;
  $(this.selector + ' .pbl-hightlight-answer').on('click', function(e) {
    _this.studentInteracted = true;
    if ($(this).hasClass(_this.answerClass[_this.currentProblemType][0]) || $(this).hasClass(_this.answerClass[_this.currentProblemType][1])) {
      if (_this.isTestManipulative) {
        $(this).removeClass(_this.answerClass[_this.currentProblemType][0] + ' ' + _this.answerClass[_this.currentProblemType][1]);
      }
    } else {
      var ans = _this.getID($(this).attr('data-status'));
      if (typeof _this.answerClass[_this.currentProblemType][ans] != 'undefined') {
        if (ans == 0 && !_this.isTestManipulative) {
          _this.setNoPoint(true);
        }
        $(this).addClass(_this.answerClass[_this.currentProblemType][ans]);
      }
    }
    _this.completed = _this.isCompleted();
  });
};
HighlightText.prototype.selfEvaluate = function() {
  return false;
};
HighlightText.prototype.isCompleted = function() {
  var _this = this;
  var countCorrectAnswers = $(this.selector + ' .pbl-hightlight-answer').map(function() {
    return (_this.getID($(this).attr('data-status')) > 0 ? 1 : null);
  }).get().length;
  var selectedAnswers = $(this.selector + ' .pbl-hightlight-answer').map(function() {
    return $(this).hasClass(_this.answerClass[_this.currentProblemType][1]) ? 1 : null;
  }).get().length;
  return selectedAnswers == countCorrectAnswers;
};
HighlightText.prototype.isAnswerCorrect = function() {
  var _this = this;
  var problemCorrectAnswers = $(this.selector + ' .pbl-hightlight-answer').map(function() {
    return (_this.getID($(this).attr('data-status')) > 0 ? 1 : null);
  }).get().length;
  var correctAnswers = $(this.selector + ' .pbl-hightlight-answer').map(function() {
    return ($(this).hasClass(_this.answerClass[_this.currentProblemType][1])) ? 1 : null;
  }).get().length;
  var allAnswers = $(this.selector + ' .pbl-hightlight-answer').map(function() {
    return ($(this).hasClass(_this.answerClass[_this.currentProblemType][0]) || $(this).hasClass(_this.answerClass[_this.currentProblemType][1])) ? 1 : null;
  }).get().length;
  return (problemCorrectAnswers == correctAnswers && allAnswers == problemCorrectAnswers && (this.isTestManipulative ? true : !this.noPoint));
};
HighlightText.prototype.isAnswerEntered = function() {
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  }
  return this.completed;
};
HighlightText.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.selector + ' .pbl-hightlight-answer').each(function(i, el) {
      $(el).removeClass(this.answerClass[this.currentProblemType][0] + ' ' + this.answerClass[this.currentProblemType][1]);
      if (this.getID($(el).attr('data-status')) == 1) {
        $(el).addClass('pbl-hightlight-correct-answer');
      }
    }.bind(this));
  }
};
HighlightText.prototype.parseAnswer = function() {
  var answers = [];
  $(this.selector + ' .pbl-hightlight-answer').each(function(i, el) {
    var $el = $(el);
    if ($el.hasClass(this.answerClass[this.currentProblemType][0]) || $el.hasClass(this.answerClass[this.currentProblemType][1])) {
      answers.push(i);
    }
  }.bind(this));
  this.answer = answers.join('|');
  return this.answer;
};
HighlightText.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + ' .pbl-hightlight-answer');
  for (var i = 0; i < inputs.length; i++) {
    Object.keys(this.answerClass).forEach(function(key, index) {
      inputs[i].classList.remove(this.answerClass[key][0]);
      inputs[i].classList.remove(this.answerClass[key][1]);
    }.bind(this));
  }
};
HighlightText.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  $(this.selector + ' .pbl-hightlight-answer').each(function(i, el) {
    var $el = $(el);
    if (answer.includes(i)) {
      var isCorrect = this.getID($(el).attr('data-status')) == 1;
      var theIndex = (isCorrect ? 1 : 0);
      $el.addClass(this.answerClass['other'][theIndex]);
    }
  }.bind(this));
};

function FlashCard(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  $(this.selector + ' .pbl-flipcard.front-card').show();
  $(this.selector + ' .content-problem .problem-statement').append('<div class="pbl-flipcard-flip">click anywhere to flip card</div>');
  this.bindEvents();
}
FlashCard.prototype = new ManipulativeBase();
FlashCard.prototype.constructor = FlashCard;
FlashCard.prototype.bindEvents = function() {
  var flipParent = this.selector + ' .content-problem .problem-statement';
  var flipElement = flipParent + ' .pbl-main-flipcard';
  $(flipElement).flip({
    'axis': 'x',
    'trigger': 'manual',
    'front': '.pbl-flipcard.front-card',
    'back': '.pbl-flipcard.back-card'
  });
  $(flipElement + ', ' + flipParent + ' .pbl-flipcard-flip').on('click', function(e) {
    if (!$(e.target).hasClass('play_icon') && !$(e.target).hasClass('auto_play_icon')) {
      $(flipElement).flip('toggle');
    }
  });
};
FlashCard.prototype.isAnswerEntered = function() {
  return true;
};
FlashCard.prototype.isAnswerCorrect = function() {
  return true;
};
FlashCard.prototype.isCompleted = function() {
  return true;
};

function DisappearingMatching(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.maxSearchIterations = 10;
  this.smallest_overlap = 9007199254740992;
  this.minVal = 15;
  this.maxWidth = null;
  this.maxHeight = null;
  this.filled_areas = [];
  this.imagesLeftToLoad = 0;
  this.messageNext.message = 'All answers must be matched.';
  var tmpHeight = $(this.selector).closest('.pbl-matching-wrapper').height();
  this.maxHeight = (tmpHeight) ? tmpHeight : $(this.selector).height();
  var tmpWidth = $(this.selector).closest('.pbl-matching-wrapper').width();
  this.maxWidth = (tmpWidth) ? tmpWidth : $(this.selector).width();
  this.selectorBox = this.selector + ' .pbl-matching-wrapper .pbl-matching-box';
  this.selectorWrapper = this.selector + ' .pbl-matching-wrapper';
  $(this.selectorWrapper).css({
    'height': this.maxHeight
  });
  var _this = this;
  var allImages = $(this.selector + ' img');
  this.imagesLeftToLoad = allImages.length;
  allImages.each(function() {
    if (this.complete) {
      _this.imagesLoaded();
    } else {
      $(this).one('load', function() {
        _this.imagesLoaded();
      });
    }
  });
  this.setupSecondary(true, problem);
}
DisappearingMatching.prototype = new ManipulativeBase();
DisappearingMatching.prototype.constructor = DisappearingMatching;
DisappearingMatching.prototype.imagesLoaded = function() {
  this.imagesLeftToLoad--;
  if (this.imagesLeftToLoad === 0) {
    this.imagesPreloaded();
  }
};
DisappearingMatching.prototype.imagesPreloaded = function() {
  this.initializeBoxes();
  this.bindEvents();
};
DisappearingMatching.prototype.getRandomInt = function(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
};
DisappearingMatching.prototype.calculateOverlap = function(a1) {
  var overlap = 0;
  for (i = 0; i < this.filled_areas.length; i++) {
    var a2 = this.filled_areas[i];
    if (a1.x + a1.width < a2.x) {
      continue;
    }
    if (a2.x + a2.width < a1.x) {
      continue;
    }
    if (a1.y + a1.height < a2.y) {
      continue;
    }
    if (a2.y + a2.height < a1.y) {
      continue;
    }
    var x1 = Math.max(a1.x, a2.x);
    var y1 = Math.max(a1.y, a2.y);
    var x2 = Math.min(a1.x + a1.width, a2.x + a2.width);
    var y2 = Math.min(a1.y + a1.height, a2.y + a2.height);
    var intersection = ((x1 - x2) * (y1 - y2));
    overlap += intersection;
  }
  return overlap;
};
DisappearingMatching.prototype.initializeBoxes = function() {
  var _this = this;
  if (_this.selectorBox) {
    $(_this.selectorBox).each(function() {
      _this.repositionBox($(this));
    });
  }
};
DisappearingMatching.prototype.checkValues = function(value1, valueTotal) {
  var randomValue = this.getRandomInt(this.minVal, valueTotal);
  var fullSize = randomValue + value1;
  if (fullSize > valueTotal) {
    return this.checkValues(value1, valueTotal);
  } else {
    return randomValue;
  }
};
DisappearingMatching.prototype.repositionBox = function(element) {
  var _this = this;
  var area;
  var best_choice;
  var smallest_overlap = _this.smallest_overlap;
  var maxLocalWidth = _this.maxWidth - 20;
  var maxLocalHeight = _this.maxHeight - 20;
  for (var i = 0; i < _this.maxSearchIterations; i++) {
    var x = _this.checkValues(element.outerWidth(true), maxLocalWidth);
    var y = _this.checkValues(element.outerHeight(true), maxLocalHeight);
    area = {
      'x': x,
      'y': y,
      'width': element.outerWidth(true),
      'height': element.outerHeight(true)
    };
    var overlap = _this.calculateOverlap(area);
    if (overlap < smallest_overlap) {
      smallest_overlap = overlap;
      best_choice = area;
    }
    if (overlap === 0) {
      break;
    }
  }
  _this.filled_areas.push(best_choice);
  element.css({
    'top': best_choice.y + 'px',
    'left': best_choice.x + 'px'
  });
};
DisappearingMatching.prototype.bindEvents = function() {
  var _this = this;
  var dropClass = 'pbl-matching-box';
  $(_this.selectorBox).dragdrop({
    makeClone: true,
    sourceHide: true,
    container: $(this.selector),
    appendDraggedTo: $(this.selector),
    dragClass: 'dragged',
    canDrag: function($src, e) {
      var clickedOnPlayIcon = $(e.target).hasClass('play_icon');
      return (clickedOnPlayIcon) ? null : $src;
    },
    canDrop: function($dst) {
      return $dst.hasClass(dropClass) || $dst.parents('.' + dropClass).size() > 0;
    },
    didDrop: function($src, $dst, e) {},
    beforeDrop: function($sourceElement, $destElement, $activeElement, e) {
      if ($destElement) {
        var activePosition = $activeElement.offset();
        var parentPosition = $(_this.selectorWrapper).offset();
        $sourceElement.css({
          'top': (activePosition.top - parentPosition.top) + 'px',
          'left': (activePosition.left - parentPosition.left) + 'px',
          'z-index': 2
        });
        var dropTarget = $destElement.hasClass(dropClass) ? $destElement : $destElement.parents('.' + dropClass);
        if (_this.getID($sourceElement.attr('data-status')) == _this.getID(dropTarget.attr('data-status'))) {
          $sourceElement.add(dropTarget).addClass("correct").delay(1000).queue(function() {
            $sourceElement.remove();
            dropTarget.remove();
            _this.completed = _this.isCompleted();
            if (_this.completed) {
              $(_this.selectorWrapper).hide();
            }
            $(this).dequeue();
          });
        } else {
          _this.setNoPoint(true);
          $sourceElement.add(dropTarget).addClass("incorrect").delay(1000).queue(function() {
            $sourceElement.removeClass('incorrect');
            dropTarget.removeClass('incorrect');
            $sourceElement.css({
              'z-index': ''
            });
            $(this).dequeue();
            _this.repositionBox($sourceElement);
          });
        }
      }
    },
    afterDrop: function($src, $dst, e) {
      $src.css({
        'visibility': ''
      });
    }
  });
};
DisappearingMatching.prototype.isAnswerEntered = function() {
  this.completed = this.isCompleted();
  return this.completed;
};
DisappearingMatching.prototype.isCompleted = function() {
  return ($(this.selectorBox).length) ? false : true;
};
DisappearingMatching.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
  }
};

function FluencyGame(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.fluencyWrapperHandle = null;
  this.isFluencyGames = true;
  this.currentWord = '';
  this.elementsWrapper = this.selector + ' .pbl-fluency-game-wrapper';
  this.selectorAnswers = this.selector + ' .pbl-fluency-game-wrapper .ms-pbl-fluency-game-element';
  this.selectorStatement = this.selector + ' .ms-pbl-content-statement';
  this.selectorStatementImage = this.selectorStatement + ' .ms-pbl-statement-image img';
  this.messageNext.message = 'Please check all the correct answers.';
  this.noInteractMessage = interactStudentMessages[0];
  if (typeof this.problem != 'undefined') {
    $(this.elementsWrapper).prepend('<img class="pbl-fluency-game-wrapper-background" src="' + this.problem['FGP']['Background'] + '" />');
    this.fluencyWrapperHandle = new FluencyGameWrapper(this.elementsWrapper, {
      'problem': this.problem,
      'onAnswerEnter': function(element) {
        element.trigger('wrapper-enter');
      },
      'onDecrementCounter': function() {
        app.labObject.onEvent('onDecrementCounter');
      }
    });
    this.bindEvents();
    labProblem.init();
    $.when(labProblem.imagesLoadedPromise.promise()).done(function() {
      if ($(this.selectorAnswers).length && ($(this.selectorAnswers).hasClass('pbl-fluency-game-element-mixed') || $(this.selectorAnswers).hasClass('pbl-fluency-game-element-text')) && !($(this.elementsWrapper).hasClass('pbl-fluency-game-fontsize-small') || $(this.elementsWrapper).hasClass('pbl-fluency-game-fontsize-medium') || $(this.elementsWrapper).hasClass('pbl-fluency-game-fontsize-large'))) {
        this.calculateTextSize();
      }
      if (!$('.lab-problem').hasClass('ms-show-feedback')) {
        if ($(this.selectorStatementImage).length != 0) {
          var originalImageHeight = $(this.selectorStatementImage).height();
          $(this.selectorStatementImage).hide();
          var imageHeight = parseInt($(this.selectorStatement).css('max-height').replace('px', '')) - $(this.selectorStatement).height();
          $(this.selectorStatementImage).removeAttr('style').height((imageHeight < originalImageHeight ? imageHeight : originalImageHeight));
        }
        this.fluencyWrapperHandle.marquee.start();
      }
    }.bind(this));
  }
}
FluencyGame.prototype = new ManipulativeBase();
FluencyGame.prototype.constructor = FluencyGame;
FluencyGame.prototype.isAnswerCorrect = function() {
  return this.completed;
};
FluencyGame.prototype.parseAnswer = function() {
  this.answer = $(this.selectorAnswers + '[data-clicked="true"]').attr('data-name');
  return this.answer;
};
FluencyGame.prototype.selfEvaluate = function() {
  return false;
};
FluencyGame.prototype.needEvaluation = function() {
  return true;
};
FluencyGame.prototype.isAnswerEntered = function() {
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  }
  return ($.inArray(true, $(this.selectorAnswers).map(function(i, e) {
    return ((typeof $(e).attr('data-clicked') != 'undefined') ? ($(e).attr('data-clicked') ? true : false) : false);
  }.bind(this)).get()) != -1);
};
FluencyGame.prototype.bindEvents = function() {
  var _this = this;
  $(this.selectorAnswers).on('wrapper-enter', function(e) {
    if (typeof app !== 'undefined' && app.labObject && app.labObject.hasAnySoundPlayed && !app.labObject.isSoundPlaying()) {
      app.labObject.autoSoundClickElement($(e.target).closest('.ms-pbl-fluency-game-element'), e, _this.problem);
    }
  });
  $(this.selectorAnswers).on('click', function(e) {
    if (typeof $(this).attr('data-clicked') == 'undefined') {
      $(this).attr('data-clicked', true);
    }
    _this.studentInteracted = true;
    _this.completed = (_this.getCorrectAnswer() == $(this).attr('data-name'));
    app.labObject.onNextClick(e);
    $(this).removeAttr('data-clicked');
  });
};
FluencyGame.prototype.showProblemFeedback = function(options) {
  if (this.fluencyWrapperHandle) {
    this.fluencyWrapperHandle.stopAnimation();
    clearTimeout(this.soundPollHandle);
  }
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  $.when(labProblem.imagesLoadedPromise.promise()).done(function() {
    var handler = this.fluencyWrapperHandle.marquee;
    handler.hideElements();
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    for (var i = 0; i < handler.elements.length; i++) {
      if (this.getCorrectAnswer().indexOf($(handler.elements[i].element).attr('data-name')) >= 0) {
        handler.currentElementIndex = i;
        break;
      }
    }
    handler.setCurrentElement();
    var animationTargets = handler.getAnimationTargets();
    handler.currentElement.css(animationTargets[0]);
  }.bind(this));
};
FluencyGame.prototype.calculateTextSize = function() {
  var answers = $(this.selectorAnswers);
  for (var i = 0; i < answers.length; i++) {
    var textContainer = $(answers[i]).find('.ms-pbl-fluency-game-element-inner');
    var containerText = $(answers[i]).find('.ms-pbl-fluency-game-element-vertical').text();
    textContainer.addClass('font-text-size-' + containerText.length);
  }
};

function GameMC(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.selectorAnswers = this.selector + ' .pbl-game-mc-wrapper .pbl-game-mc-answer';
  this.fadeInDuration = 750;
  this.fadeInTimeOut = 350;
  this.playingForPS = false;
  this.maxAnswerHeight = 80;
  if ($(this.selector + ' .pbl-game-mc-format-2').length == 0) {
    this.resizeAnswers();
  }
  $(this.selectorAnswers).hide();
  var _this = this;
  $(this.selectorAnswers).each(function(index) {
    var element = $(this);
    element.append('<div class="pbl-game-mc-answer-status"></div>');
    setTimeout(function() {
      element.fadeIn(_this.fadeInDuration);
    }, index * _this.fadeInTimeOut);
  });
  if ($(this.selector + ' .pbl-game-mc-format-2').length == 0) {
    $(window).on('resize', function() {
      clearTimeout(resizeTimer);
      var resizeTimer = setTimeout(this.resizeAnswers.bind(this), 200);
    }.bind(this));
  }
  this.setAnswerPlaybackArray();
  this.messageNext.message = 'Please check all the correct answers.';
  this.noInteractMessage = interactStudentMessages[0];
  this.clickedClass = 'pbl-game-mc-answer-selected';
  this.bindEvents();
}
GameMC.prototype = new ManipulativeBase();
GameMC.prototype.constructor = GameMC;
GameMC.prototype.resizeAnswers = function() {
  var _this = this;
  _this.maxAnswerHeight = 80;
  $(this.selectorAnswers).css('height', 'auto');
  $(this.selectorAnswers).each(function() {
    if (_this.maxAnswerHeight < $(this).height()) {
      _this.maxAnswerHeight = $(this).height();
    }
  });
  $(this.selectorAnswers).height(this.maxAnswerHeight);
};
GameMC.prototype.setAnswerPlaybackArray = function() {
  this.answersPlayback = $(this.selectorAnswers + '[data-sound!=""]');
};
GameMC.prototype.checkCompleted = function(className) {
  this.completed = ($(this.selector + ' .pbl-game-mc-answer.' + className).map(function() {
    return $(this).attr('data-name');
  }).get().sort().join('|') == this.getCorrectAnswer());
};
GameMC.prototype.parseAnswer = function() {
  return $(this.selector + ' .pbl-game-mc-answer.' + this.clickedClass).map(function() {
    return $(this).attr('data-name');
  }).get().sort().join('|');
};
GameMC.prototype.isAnswerCorrect = function() {
  this.checkCompleted(this.clickedClass);
  return this.completed;
};
GameMC.prototype.selfEvaluate = function() {
  return false;
};
GameMC.prototype.needEvaluation = function() {
  return true;
};
GameMC.prototype.isAnswerEntered = function() {
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  }
  return $(this.selector + ' .pbl-game-mc-answer.' + this.clickedClass).length > 0;
};
GameMC.prototype.doNextAnswerPlayback = function() {
  var _this = this;
  if (this.answersPlayback.length > 0) {
    var answer = this.answersPlayback.splice(0, 1);
    var currentMc = $(answer).attr('data-name');
    $(this.selector + ' .pbl-game-mc-answer[data-name=' + currentMc + ']').off('GameMC.fakeSound').on('GameMC.fakeSound', function(e) {
      var tmpEvent = $.extend({}, e, {
        target: $(e.target).closest('.pbl-game-mc-answer')
      });
      if (typeof app !== 'undefined' && app.labObject && ManipulativeSoundSetting >= 1) {
        app.labObject.autoSoundClick(tmpEvent, _this.problem);
      } else {
        var event;
        if (document.createEvent) {
          event = document.createEvent("HTMLEvents");
          event.initEvent("manipulatives:playSound", true, true);
        } else {
          event = document.createEventObject();
          event.eventType = "manipulatives:playSound";
        }
        event.eventName = "manipulatives:playSound";
        event.details = tmpEvent;
        if (document.createEvent) {
          document.dispatchEvent(event);
        } else {
          document.fireEvent("on" + event.eventType, event);
        }
      }
    });
    $(this.selector + ' .pbl-game-mc-answer').animate({
      'opacity': 0.5
    }, 250, function() {
      setTimeout(function() {
        $(this.selector + ' .pbl-game-mc-answer[data-name=' + currentMc + ']').animate({
          'opacity': 1
        }, 250, function() {
          $(this.selector + ' .pbl-game-mc-answer[data-name=' + currentMc + ']').trigger('GameMC.fakeSound').off('GameMC.fakeSound');
        }.bind(this));
      }.bind(this), 250);
    }.bind(this));
  } else {
    this.playingForPS = false;
    $(this.selector + ' .pbl-game-mc-answer').animate({
      'opacity': 1
    }, 250, function() {
      $(this).css('opacity', '');
    });
    this.setAnswerPlaybackArray();
  }
};
GameMC.prototype.bindEvents = function() {
  var _this = this;
  $(this.selector + ' .pbl-game-mc-answer').on('click', function(e) {
    _this.studentInteracted = true;
    if (!_this.playingForPS) {
      var tmpEvent = $.extend({}, e, {
        target: $(e.target).closest('.pbl-game-mc-answer')
      });
      if (typeof app !== 'undefined' && app.labObject && ManipulativeSoundSetting >= 1) {
        app.labObject.autoSoundClick(tmpEvent, _this.problem);
      } else {
        var event;
        if (document.createEvent) {
          event = document.createEvent("HTMLEvents");
          event.initEvent("manipulatives:playSound", true, true);
        } else {
          event = document.createEventObject();
          event.eventType = "manipulatives:playSound";
        }
        event.eventName = "manipulatives:playSound";
        event.details = tmpEvent;
        if (document.createEvent) {
          document.dispatchEvent(event);
        } else {
          document.fireEvent("on" + event.eventType, event);
        }
      }
    }
    if (_this.isTestManipulative) {
      $(this).toggleClass(_this.clickedClass);
    } else {
      if (!$(this).hasClass(_this.clickedClass)) {
        var correct = (_this.getCorrectAnswer().indexOf($(this).attr('data-name')) != -1);
        $(this).addClass(_this.clickedClass);
        if (correct) {
          $(this).addClass('pbl-game-mc-answer-correct');
          _this.checkCompleted('pbl-game-mc-answer-correct');
        } else {
          $(this).addClass('pbl-game-mc-answer-incorrect');
          _this.setNoPoint(true);
        }
      }
    }
  });
  $(document).off('MSLab.soundDonePlaying').on('MSLab.soundDonePlaying', function(mainEvent, passedEvent) {
    mainEvent.preventDefault();
    mainEvent.stopPropagation();
    if (Object.keys(passedEvent).length) {
      var selectedElement = passedEvent.target[0] || passedEvent.target;
      if ($(selectedElement.parentElement).hasClass('ms-pbl-statement-sound-paragraph') || _this.playingForPS) {
        if (!_this.playingForPS) {
          $(this.selector + ' .pbl-game-mc-answer').css({
            'opacity': 0.5
          });
        }
        _this.playingForPS = true;
        setTimeout(_this.doNextAnswerPlayback.bind(_this), 500);
      }
    }
  });
};
GameMC.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    this.answersPlayback = [];
    $(this.selector + ' .pbl-game-mc-answer').each(function(i, el) {
      $(el).removeClass('pbl-game-mc-answer-correct pbl-game-mc-answer-incorrect').css({
        opacity: (this.getCorrectAnswer().indexOf($(el).attr('data-name')) < 0) ? 0.5 : 1
      });
    }.bind(this));
  }
};

function LineOrDotPlot(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.resizableSelector = this.selector + ' .pbl-charts-wrapper .pbl-charts-chart-element-resizable';
  this.chartElementGrid = 25;
  this.messageNext.message = 'All answers must be matched.';
  this.noInteractMessage = interactStudentMessages[1];
  this.bindEvents();
  this.setupSecondary(true, problem);
};
LineOrDotPlot.prototype = new ManipulativeBase();
LineOrDotPlot.prototype.constructor = LineOrDotPlot;
LineOrDotPlot.prototype.bindEvents = function() {
  var _this = this;
  $(this.resizableSelector).mobyResizable({
    direction: 'vertical',
    type: 'plot',
    stepSpeed: this.chartElementGrid,
    maxStep: 10,
    startStep: 1,
    onResize: function(element) {
      _this.studentInteracted = true;
    }
  });
};
LineOrDotPlot.prototype.selfEvaluate = function() {
  return false;
};
LineOrDotPlot.prototype.isAnswerEntered = function() {
  return ($.inArray(true, $(this.resizableSelector).map(function(i, e) {
    return ((typeof $(e).attr('data-moved') != 'undefined') ? ($(e).attr('data-moved') ? true : false) : false);
  }).get()) != -1);
};
LineOrDotPlot.prototype.isAnswerCorrect = function() {
  return ($.inArray(false, $(this.resizableSelector).map(function(i, e) {
    return ($(e).attr('data-increments') == this.getID($(e).attr('data-status')));
  }.bind(this)).get()) == -1);
};
LineOrDotPlot.prototype.showProblemFeedback = function(options) {
  var _this = this;
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.resizableSelector).each(function() {
      var status = _this.getID($(this).attr('data-status'));
      $(this).attr('data-increments', status).attr('data-moved', true).height(_this.chartElementGrid * status);
    });
  }
};

function BarChart(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.resizableSelector = this.selector + ' .pbl-charts-wrapper .pbl-charts-chart-element-resizable';
  this.chartElementWidth = 50;
  if (!$(this.selector + ' .pbl-charts-wrapper').length) {
    return;
  }
  var tmpMin = $(this.selector + ' .pbl-charts-wrapper').attr('data-minval');
  var tmpMax = $(this.selector + ' .pbl-charts-wrapper').attr('data-maxval');
  this.minVal = parseFloat(tmpMin).toFixed(1);
  this.maxVal = parseFloat(tmpMax).toFixed(1);
  this.stepSpeed = parseFloat($(this.selector + ' .pbl-charts-wrapper').attr('data-gridStep'));
  var difference = this.maxVal - this.minVal;
  this.chartElementGrid = (30 / parseFloat(difference / 10)) * this.stepSpeed;
  this.messageNext.message = 'All answers must be matched.';
  this.noInteractMessage = interactStudentMessages[1];
  this.bindEvents();
  this.setupSecondary(true, problem);
};
BarChart.prototype = new ManipulativeBase();
BarChart.prototype.constructor = BarChart;
BarChart.prototype.bindEvents = function() {
  var _this = this;
  $(this.resizableSelector).mobyResizable({
    direction: 'vertical',
    type: 'bar',
    startStep: 1,
    stepSpeed: this.stepSpeed,
    minVal: this.minVal,
    maxVal: this.maxVal,
    onCreate: function(element) {
      $(element).find('.resizable-handle').each(function() {
        $(this).bt("0", {
          trigger: 'none',
          positions: ['top'],
          clickAnywhereToClose: false,
          spikeLength: 10,
          width: $(element).width(),
          shrinkToFit: true,
          padding: '0px',
          fill: 'white',
          windowMargin: 0,
          cssStyles: {
            'text-align': 'center'
          }
        });
      });
    },
    onStart: function(element) {
      if (typeof element.attr('data-resizing') === 'undefined') {
        element.attr('data-resizing', true);
      }
      $(element).css({
        'z-index': 2
      });
      $(element).find('.resizable-handle').btOn();
      _this.setElementBtValue(element, _this.minVal);
    },
    onStop: function(element) {
      if (typeof element.attr('data-resizing') !== 'undefined') {
        element.removeAttr('data-resizing');
      }
      $(element).find('.resizable-handle').btOff();
      $(element).css({
        'z-index': 'auto'
      });
    },
    onResize: function(element) {
      _this.setElementBtValue(element, _this.minVal);
      _this.studentInteracted = true;
    }
  }).bind("mouseenter touchstart", function(event) {
    if (typeof $(this).parent().attr('data-resizing') === 'undefined') {
      $(this).css({
        'z-index': 2
      });
      $(this).find('.resizable-handle').btOn();
      _this.setElementBtValue($(this).parent(), _this.minVal);
    }
  }).bind("mouseleave touchend", function(event) {
    if (typeof $(this).parent().attr('data-resizing') === 'undefined') {
      $(this).find('.resizable-handle').btOff();
      $(this).css({
        'z-index': 'auto'
      });
    }
  });
};
BarChart.prototype.setElementBtValue = function(element, initialValue) {
  var value = $(element).find('.pbl-charts-chart-element-resizable').attr('data-increments') ? $(element).find('.pbl-charts-chart-element-resizable').attr('data-increments') : initialValue;
  var precision = this.countDecimals(this.stepSpeed);
  if (precision != 0) {
    $(element).find('.bt-content').text(parseFloat(value).toFixed(precision));
  } else {
    $(element).find('.bt-content').text(parseInt(value));
  }
};
BarChart.prototype.countDecimals = function(value) {
  if (Math.floor(value) === value) return 0;
  return value.toString().split(".")[1].length || 0;
};
BarChart.prototype.getStatusValue = function(status) {
  var precision = (arguments.length > 1) ? arguments[1] : 0;
  var tmpStatus = ((status ^ 3) >> 8);
  return (tmpStatus / Math.pow(10, precision));
};
BarChart.prototype.selfEvaluate = function() {
  return false;
};
BarChart.prototype.isAnswerEntered = function() {
  return ($.inArray(true, $(this.resizableSelector).map(function(i, e) {
    return ((typeof $(e).attr('data-moved') != 'undefined') ? ($(e).attr('data-moved') ? true : false) : false);
  }.bind(this)).get()) != -1);
};
BarChart.prototype.isAnswerCorrect = function() {
  var _this = this;
  return ($.inArray(false, $(this.resizableSelector).map(function(i, e) {
    return ($(e).attr('data-increments') == this.getStatusValue($(e).attr('data-status'), $(e).attr('data-precision')));
  }.bind(this)).get()) == -1);
};
BarChart.prototype.showProblemFeedback = function(options) {
  var _this = this;
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.resizableSelector).each(function() {
      var status = _this.getStatusValue($(this).attr('data-status'), $(this).attr('data-precision'));
      height = ((status - _this.minVal) / _this.stepSpeed) * _this.chartElementGrid;
      $(this).attr('data-increments', status).attr('data-moved', true).height(height.toFixed(1));
      $(this).find('.resizable-handle').btOn();
      _this.setElementBtValue($(this).parent(), status);
    });
  }
};

function Histogram(selector, problem) {
  BarChart.prototype.constructor.call(this, selector, problem);
}
Histogram.prototype = new BarChart();
Histogram.prototype.constructor = BarChart;

function MCStandard(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'Please check all the correct answers.';
  this.noInteractMessage = interactStudentMessages[0];
  this.bindEvents();
  this.setupSecondary(true, problem);
}
MCStandard.prototype = new ManipulativeBase();
MCStandard.prototype.constructor = MCStandard;
MCStandard.prototype.parseAnswer = function() {
  this.answer = $(this.selector + ' input[name="mc-standard-selected"]:checked').map(function() {
    return $(this).attr('value');
  }).get().sort().join('|');
  return this.answer;
};
MCStandard.prototype.checkCompleted = function(className) {
  this.completed = (this.parseAnswer() == this.getCorrectAnswer());
};
MCStandard.prototype.isAnswerEntered = function() {
  return ($(this.selector + ' input[name="mc-standard-selected"]:checked').length > 0);
};
MCStandard.prototype.selfEvaluate = function() {
  return false;
};
MCStandard.prototype.bindEvents = function() {
  var _this = this;
  $(this.selector + ' .ms-pbl-mc-standard-item input').on('click', function(e) {
    e.stopPropagation();
    _this.studentInteracted = true;
    _this.checkCompleted();
  });
  $(this.selector + ' .ms-pbl-mc-standard-item').on('click', function(e) {
    _this.studentInteracted = true;
    var input = $('.ms-pbl-mc-standard-item-select input', $(this));
    if (!_this.problem.IsChoiceRadio) {
      input.prop("checked", !input.prop("checked"));
    } else {
      input.prop("checked", true);
    }
    _this.checkCompleted();
    return false;
  });
};
MCStandard.prototype.showProblemFeedback = function(options) {
  var _this = this;
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.selector + ' .ms-pbl-mc-standard-choice .ms-pbl-mc-standard-item').each(function(i, el) {
      $('input', $(el)).removeAttr('checked');
      if (this.getCorrectAnswer().indexOf($('input', $(el)).val()) != -1) {
        $('input', $(el)).attr('checked', true);
      }
    }.bind(this));
  }
};

function MCMatrix(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.answerElements = this.selector + ' .pbl-mc-matrix .pbl-mc-matrix-answer';
  this.messageNext.message = 'Please check all the correct answers.';
  this.noInteractMessage = interactStudentMessages[0];
  $(this.selector).find('.pbl-mc-matrix-column input').unbind(interactEvents.click).bind(interactEvents.click, function() {
    this.studentInteracted = true;
  }.bind(this));
  this.setupSecondary(true, problem);
}
MCMatrix.prototype = new ManipulativeBase();
MCMatrix.prototype.constructor = MCMatrix;
MCMatrix.prototype.selfEvaluate = function() {
  return false;
};
MCMatrix.prototype.isAnswerEntered = function() {
  return ($(this.answerElements + ':checked').length > 0);
};
MCMatrix.prototype.isAnswerCorrect = function() {
  return ($(this.answerElements + ':checked').map(function() {
    return $(this).attr('value');
  }).get().join('|') == this.getCorrectAnswer());
};
MCMatrix.prototype.showProblemFeedback = function(options) {
  var _this = this;
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.selector + ' .pbl-mc-matrix-row .pbl-mc-matrix-column').each(function(i, el) {
      $('input', $(el)).removeAttr('checked');
      if (this.getCorrectAnswer().indexOf($('input', $(el)).val()) != -1) {
        $('input', $(el)).attr('checked', true);
      }
    }.bind(this));
  }
};

function NumberLineBase(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
}
NumberLineBase.prototype = new ManipulativeBase();
NumberLineBase.prototype.constructor = NumberLineBase;
NumberLineBase.prototype.getStatusValue = function(status) {
  return ((status ^ 3) >> 8);
};
NumberLineBase.prototype.selfEvaluate = function() {
  return false;
};

function NumberLineDotPlot(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.maxNumberOfEntries = 17;
  this.numberLineElementsSelector = this.selector + ' .pbl-nldolp-elements-wrapper .pbl-nldolp-element';
  this.numberLineElementEntryClass = 'pbl-nldolp-entry';
  this.numberLineElementEntryHtml = '<div class="' + this.numberLineElementEntryClass + '"></div>';
  this.numberLineButtonDisabledClass = 'pbl-nldolp-button-disabled';
  this.messageNext.message = 'All answers must be matched.';
  this.noInteractMessage = interactStudentMessages[1];
  this.serializeElements = function() {
    return ($(this.numberLineElementsSelector).map(function(i, e) {
      return $(e).find('.' + this.numberLineElementEntryClass).length
    }.bind(this)).get());
  };
  this.drawFunction = function(action, stack, buttonStates) {
    if (action != 'add') {
      for (var i = 0; i < stack.length; i++) {
        while ($(this.numberLineElementsSelector + '-' + i).find('.' + this.numberLineElementEntryClass).length != stack[i]) {
          if (stack[i] < $(this.numberLineElementsSelector + '-' + i).find('.' + this.numberLineElementEntryClass).length) {
            $(this.numberLineElementsSelector + '-' + i).find('.' + this.numberLineElementEntryClass + ':first-child').remove();
          } else if (stack[i] > $(this.numberLineElementsSelector + '-' + i).find('.' + this.numberLineElementEntryClass).length) {
            $(this.numberLineElementsSelector + '-' + i).append(this.numberLineElementEntryHtml);
          }
        }
        if (stack[i] == 0 && $(this.numberLineElementsSelector + '-' + i).attr('data-clicked')) {
          $(this.numberLineElementsSelector + '-' + i).removeAttr('data-clicked');
        }
      }
    }
    if (buttonStates['undo_active']) {
      $(this.selector + ' .pbl-nldolp-undo-button').removeClass(this.numberLineButtonDisabledClass);
    } else {
      $(this.selector + ' .pbl-nldolp-undo-button').addClass(this.numberLineButtonDisabledClass);
    }
    if (buttonStates['redo_active']) {
      $(this.selector + ' .pbl-nldolp-redo-button').removeClass(this.numberLineButtonDisabledClass);
    } else {
      $(this.selector + ' .pbl-nldolp-redo-button').addClass(this.numberLineButtonDisabledClass);
    }
  };
  this.commandStack = new UndoRedo({
    'drawFunction': this.drawFunction.bind(this)
  });
  this.commandStack.setCurrentState(this.serializeElements());
  this.bindEvents();
  this.setupSecondary(true, problem);
}
NumberLineDotPlot.prototype = new NumberLineBase();
NumberLineDotPlot.prototype.constructor = NumberLineDotPlot;
NumberLineDotPlot.prototype.bindEvents = function() {
  var _this = this;
  $(this.numberLineElementsSelector).on('click', function(e) {
    _this.studentInteracted = true;
    if ($(this).find('.' + _this.numberLineElementEntryClass).length < _this.maxNumberOfEntries) {
      if (typeof $(this).attr('data-clicked') == 'undefined') {
        $(this).attr('data-clicked', true);
      }
      $(this).append(_this.numberLineElementEntryHtml);
      var state = _this.serializeElements();
      _this.commandStack.addCommand(state);
    }
  });
  $(this.selector + ' .pbl-nldolp-undo-button').on('click', function(e) {
    if (!$(this).hasClass(_this.numberLineButtonDisabledClass)) {
      _this.commandStack.undoCommand();
    }
  });
  $(this.selector + ' .pbl-nldolp-redo-button').on('click', function(e) {
    if (!$(this).hasClass(_this.numberLineButtonDisabledClass)) {
      _this.commandStack.redoCommand();
    }
  });
  $(this.selector + ' .pbl-nldolp-reset-button').on('click', function(e) {
    _this.commandStack.resetCommand();
  });
};
NumberLineDotPlot.prototype.isAnswerEntered = function() {
  return ($.inArray(true, $(this.numberLineElementsSelector).map(function(i, e) {
    return ((typeof $(e).attr('data-clicked') != 'undefined') ? ($(e).attr('data-clicked') ? true : false) : false);
  }.bind(this)).get()) != -1);
};
NumberLineDotPlot.prototype.isAnswerCorrect = function() {
  return ($.inArray(false, $(this.numberLineElementsSelector).map(function(i, e) {
    return ($(e).find('.' + this.numberLineElementEntryClass).length == this.getStatusValue($(e).attr('data-status')));
  }.bind(this)).get()) == -1);
};
NumberLineDotPlot.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    var currentState = [];
    $(this.numberLineElementsSelector).each(function(i, el) {
      $('.' + this.numberLineElementEntryClass, $(el)).remove();
      currentState[i] = this.getStatusValue($(el).attr('data-status'));
      for (var x = 0; x < currentState[i]; x++) {
        $(el).trigger('click');
      }
    }.bind(this));
    $('.pbl-nldolp-buttons').hide();
  }
};

function NumberLineDragAndDrop(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.dragDropSelector = this.selector + ' .pbl-nldnd-answer';
  this.dragDropAnswersSelector = this.selector + ' .pbl-nldnd-answers-wrapper .pbl-nldnd-answer';
  this.elementSelector = this.selector + ' .pbl-nldnd-elements-wrapper .pbl-nldnd-element';
  this.answersClass = 'pbl-nldnd-answers-wrapper';
  this.elementClass = 'pbl-nldnd-element';
  this.answerClass = 'pbl-nldnd-answer';
  this.guidelineClass = 'pbl-nldnd-guidline';
  this.messageNext.message = 'All answers must be matched.';
  this.noInteractMessage = interactStudentMessages[1];
  this.bindEvents();
  this.setupSecondary(true, problem);
}
NumberLineDragAndDrop.prototype = new NumberLineBase();
NumberLineDragAndDrop.prototype.constructor = NumberLineDragAndDrop;
NumberLineDragAndDrop.prototype.bindEvents = function() {
  var _this = this;
  $(_this.dragDropSelector).dragdrop({
    makeClone: true,
    sourceHide: true,
    appendDraggedTo: $('body'),
    dragClass: 'dragged',
    container: $(this.selector),
    canDrag: function($src, e) {
      return $src;
    },
    canDrop: function($dst) {
      var hasDropClass = ($dst.hasClass(_this.elementClass) || $dst.parents('.' + _this.elementClass).size() > 0);
      var hasDropAnswersClass = ($dst.hasClass(_this.answersClass) || $dst.parents('.' + _this.answersClass).size() > 0);
      if (($dst.hasClass(_this.elementClass) && $dst.find('.' + _this.guidelineClass).length == 0) && $dst.parents('.' + _this.elementClass).find('.' + _this.guidelineClass).length == 0) {
        $(_this.selector).find('.' + _this.guidelineClass).remove();
        var elementToAddTo = ($dst.hasClass(_this.elementClass) ? $dst : $dst.parents('.' + _this.elementClass));
        $('<div />').addClass('' + _this.guidelineClass).appendTo($dst);
      }
      _this.studentInteracted = true;
      return hasDropClass || hasDropAnswersClass;
    },
    didDrop: function($src, $dst, e) {
      var dropTarget = $dst.hasClass(_this.elementClass) ? $dst : (($dst.parents('.' + _this.elementClass).length) ? $dst.parents('.' + _this.elementClass) : ($dst.hasClass(_this.answersClass) ? $dst : $dst.parents('.' + _this.answersClass)));
      $(_this.elementSelector).find('.' + _this.guidelineClass).remove();
      if (dropTarget.hasClass(_this.answersClass)) {
        var found = false;
        $(_this.dragDropAnswersSelector).each(function(i) {
          if ($(this).attr('data-status') == $src.attr('data-status') || $(this).text() == $src.text()) {
            found = true;
            $(this).css({
              'visibility': '',
              'display': 'inline-block'
            });
            return false;
          }
        });
        if (found && ($dst.hasClass(_this.answersClass) || $dst.parents('.' + _this.answersClass).size() != 0) && $src.parents('.' + _this.answersClass).size() == 0) {
          $src.remove();
        }
      } else {
        if ($(dropTarget).find('[data-status="' + $src.attr('data-status') + '"]').length == 0) {
          if ($src.parents('.' + _this.elementClass).length && ($(dropTarget).hasClass(_this.elementClass) || $(dropTarget).parents('.' + _this.elementClass).length)) {
            var $el = $src.css('visibility', '').clone(true);
            $src.remove();
            $el.appendTo(dropTarget);
          } else {
            var $el = $src.css('visibility', '').clone(true);
            $src.hide();
            $el.appendTo(dropTarget);
          }
        }
      }
    }
  });
};
NumberLineDragAndDrop.prototype.isAnswerEntered = function() {
  return ($.inArray(true, $(this.elementSelector).map(function(i, e) {
    return ($(e).find('.' + this.answerClass).length > 0);
  }.bind(this)).get()) != -1);
};
NumberLineDragAndDrop.prototype.isAnswerCorrect = function() {
  var _this = this;
  var tmp = [];
  $(this.elementSelector).each(function() {
    var parentStatus = _this.getStatusValue($(this).attr('data-status'));
    var parentHasCorrectCount = _this.getStatusValue($(this).attr('data-count')) == $(this).find('.' + _this.answerClass).length;
    var parentHasOnlyAcceptedAnswers = true;
    $(this).find('.' + _this.answerClass).each(function() {
      if (_this.getStatusValue($(this).attr('data-status')) != parentStatus) {
        parentHasOnlyAcceptedAnswers = false;
        return false;
      }
    });
    tmp.push(parentHasOnlyAcceptedAnswers && parentHasCorrectCount);
  });
  return ($.inArray(false, tmp) == -1);
};
NumberLineDragAndDrop.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    var _this = this;
    $(_this.elementSelector).html('');
    $(this.dragDropAnswersSelector).each(function(i, el) {
      var currentDataStatus = _this.getStatusValue($(el).attr('data-status'));
      $(_this.elementSelector).each(function(i, el2) {
        if (_this.getStatusValue($(el2).attr('data-status')) == currentDataStatus) {
          var $src = $(el).css({
            'visibility': '',
            'display': 'inline-block'
          }).clone(true);
          $src.appendTo($(el2));
          $(el).hide();
        }
      });
    });
  }
};

function GraphBase(selector, problem) {
  if (typeof problem == 'undefined') return;
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.correctAnswer = [];
  this.messageNext.message = 'All answers must be matched.';
  this.noInteractMessage = interactStudentMessages[1];
  $(document).unbind(interactEvents.move).bind(interactEvents.move, function(e) {
    this.studentInteracted = true;
  }.bind(this));
  this.chartAnswerTypes = {
    811: 'point',
    812: 'vector',
    813: 'line',
    814: 'circle',
    815: 'segment',
    816: 'polygon',
    817: 'ray',
    818: 'parabola'
  };
  this.graph_editor = $(this.selector + ' #graph-editor');
  this.graphSettings = {
    elements: [],
    type: this.graph_editor.attr('data-type'),
    x_max: (typeof this.graph_editor.attr('data-xmax') != 'undefined') ? parseFloat(this.graph_editor.attr('data-xmax')) : 10,
    x_min: (typeof this.graph_editor.attr('data-xmin') != 'undefined') ? parseFloat(this.graph_editor.attr('data-xmin')) : 0,
    y_max: (typeof this.graph_editor.attr('data-ymax') != 'undefined') ? parseFloat(this.graph_editor.attr('data-ymax')) : 10,
    y_min: (typeof this.graph_editor.attr('data-ymin') != 'undefined') ? parseFloat(this.graph_editor.attr('data-ymin')) : 0,
    x_grid_distance: (typeof this.graph_editor.attr('data-x-grid-distance') != 'undefined') ? parseFloat(this.graph_editor.attr('data-x-grid-distance')) : 1,
    y_grid_distance: (typeof this.graph_editor.attr('data-y-grid-distance') != 'undefined') ? parseFloat(this.graph_editor.attr('data-y-grid-distance')) : 1,
    x_tick_distance: (typeof this.graph_editor.attr('data-x-tick-distance') != 'undefined') ? parseFloat(this.graph_editor.attr('data-x-tick-distance')) : 1,
    y_tick_distance: (typeof this.graph_editor.attr('data-y-tick-distance') != 'undefined') ? parseFloat(this.graph_editor.attr('data-y-tick-distance')) : 1,
    x_axis_label: (typeof this.graph_editor.attr('data-x-axis-label') != 'undefined') ? this.graph_editor.attr('data-x-axis-label') : false,
    y_axis_label: (typeof this.graph_editor.attr('data-y-axis-label') != 'undefined') ? this.graph_editor.attr('data-y-axis-label') : false,
    is_view: true,
    types: {
      'point': 811,
      'vector': 812,
      'line': 813,
      'circle': 814,
      'segment': 815,
      'polygon': 816,
      'ray': 817,
      'parabola': 818
    },
    elementMoveEvent: this.isTestManipulative ? 'InteractStudent.moveElement' : null
  }
  var tools = (typeof this.graph_editor.attr('data-tools') != 'undefined') ? this.graph_editor.attr('data-tools').split(',') : [];
  var _this = this;
  var newData = this.reverseArrayKeyValues(this.graphSettings['types']);
  for (var i = 0; i < tools.length; i++) {
    if (typeof newData[tools[i]] != 'undefined') {
      _this.graphSettings['tool_' + newData[tools[i]]] = true;
    }
  }
  for (var i = 0; i < this.problem['ProblemChartAnswer'].length; i++) {
    this.correctAnswer.push(this.problem['ProblemChartAnswer'][i]);
  }
  if (typeof this.editor != 'undefined') {
    delete this.editor;
  }
  this.editor = new GraphEditor('graph-editor', this.graphSettings);
  this.setupSecondary(true, problem);
};
GraphBase.prototype = new ManipulativeBase();
GraphBase.prototype.constructor = GraphBase;
GraphBase.prototype.reverseArrayKeyValues = function(theArray) {
  var newArray = Object.keys(theArray).reduce(function(obj, key) {
    obj[theArray[key]] = key;
    return obj;
  }, {});
  return newArray;
};
GraphBase.prototype.selfEvaluate = function() {
  return false;
};
GraphBase.prototype.isAnswerEntered = function() {
  return (this.editor.getAnswer().length > 0);
};
GraphBase.prototype.isAnswerCorrect = function() {
  var ret = false;
  var userAnswers = this.editor.getAnswer();
  if (this.correctAnswer.length != userAnswers.length) {
    return ret;
  } else {
    ret = true;
    var correctAnswer = JSON.parse(JSON.stringify(this.correctAnswer));
    for (var i = 0; i < correctAnswer.length; i++) {
      correctAnswer[i].type = parseInt(correctAnswer[i].type);
      if (correctAnswer[i].type == 816) {
        correctAnswer[i].points = correctAnswer[i].points.sort(function(a, b) {
          if (a.x == b.x) return a.y - b.y;
          return a.x - b.x;
        });
      }
    }
    correctAnswer.sort(function(a, b) {
      var tmp = (a.type - b.type);
      if (tmp == 0) {
        if (a.points[0].x == b.points[0].x) {
          tmp = a.points[0].y - b.points[0].y;
        } else {
          tmp = a.points[0].x - b.points[0].x;
        }
      }
      return tmp;
    });
    for (var i = 0; i < userAnswers.length; i++) {
      if ([814, 818].indexOf(userAnswers[i].type) == -1) {
        userAnswers[i].points = userAnswers[i].points.sort(function(a, b) {
          if (a.x == b.x) return a.y - b.y;
          return a.x - b.x;
        });
      }
    }
    userAnswers.sort(function(a, b) {
      var tmp = (a.type - b.type);
      if (tmp == 0) {
        if (a.points[0].x == b.points[0].x) {
          tmp = a.points[0].y - b.points[0].y;
        } else {
          tmp = a.points[0].x - b.points[0].x;
        }
      }
      return tmp;
    });
    var correctAnswersStandard = correctAnswer.filter(function(element, index) {
      return ([811, 812, 815, 816].indexOf(element.type) != -1) ? true : false;
    });
    var userAnswersStandard = userAnswers.filter(function(element, index) {
      return ([811, 812, 815, 816].indexOf(element.type) != -1) ? true : false;
    });
    var correctAnswersNonStandard = correctAnswer.filter(function(element, index) {
      return ([813, 814, 817, 818].indexOf(element.type) != -1) ? true : false;
    });
    var userAnswersNonStandard = userAnswers.filter(function(element, index) {
      return ([813, 814, 817, 818].indexOf(element.type) != -1) ? true : false;
    });
    var nonStandardCheck = true;
    for (var idx = 0; idx < correctAnswersNonStandard.length; idx++) {
      element = correctAnswersNonStandard[idx];
      userElement = userAnswersNonStandard[idx];
      if (element.type == 814) {
        if (userElement.type != 814) {
          nonStandardCheck = false;
          break;
        } else {
          if (element.points[0].x != userElement.points[0].x || element.points[0].y != userElement.points[0].y) {
            nonStandardCheck = false;
            break;
          } else {
            var correctCircleRadius = Math.sqrt(Math.pow((element.points[0].x - element.points[1].x), 2) + Math.pow((element.points[0].y - element.points[1].y), 2));
            var userCircleRadius = Math.sqrt(Math.pow((userElement.points[0].x - userElement.points[1].x), 2) + Math.pow((userElement.points[0].y - userElement.points[1].y), 2));
            if (correctCircleRadius != userCircleRadius) {
              nonStandardCheck = false;
              break;
            }
          }
        }
      } else if (element.type == 818) {
        if (userElement.type != 818) {
          nonStandardCheck = false;
          break;
        } else {
          if (element.points[0].x != userElement.points[0].x || element.points[0].y != userElement.points[0].y) {
            nonStandardCheck = false;
            break;
          } else {
            var correctParabola = (element.points[1].y - element.points[0].y) / Math.pow(element.points[1].x - element.points[0].x, 2) * (element.points[1].x - element.points[0].x) * (element.points[1].x - element.points[0].x) + element.points[0].y;
            var userParabola = (userElement.points[1].y - userElement.points[0].y) / Math.pow(userElement.points[1].x - userElement.points[0].x, 2) * (userElement.points[1].x - userElement.points[0].x) * (userElement.points[1].x - userElement.points[0].x) + userElement.points[0].y;
            if (correctParabola != userParabola) {
              nonStandardCheck = false;
              break;
            }
          }
        }
      } else if (element.type == 813) {
        if (userElement.type != 813) {
          nonStandardCheck = false;
          break;
        } else {
          if (!this.editor.arePointsCollinear(userElement.points[0], element.points[0], element.points[1]) || !this.editor.arePointsCollinear(userElement.points[1], element.points[0], element.points[1])) {
            nonStandardCheck = false;
            break;
          }
        }
      } else if (element.type == 817) {
        if (userElement.type != 817) {
          nonStandardCheck = false;
          break;
        } else {
          if (element.points[0].x != userElement.points[0].x || element.points[0].y != userElement.points[0].y) {
            nonStandardCheck = false;
            break;
          } else {
            if (!this.editor.arePointsCollinear(userElement.points[1], element.points[0], element.points[1])) {
              nonStandardCheck = false;
              break;
            }
          }
        }
      }
    };
    ret = (nonStandardCheck && JSON.stringify(userAnswersStandard) === JSON.stringify(correctAnswersStandard));
  }
  return ret;
};
GraphBase.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    var _this = this;
    var newElements = $.map(this.correctAnswer, function(el) {
      var tmpEl = JSON.parse(JSON.stringify(el));
      tmpEl['type'] = _this.chartAnswerTypes[parseInt(el.type)];
      return tmpEl;
    });
    var settings = JSON.parse(JSON.stringify(this.graphSettings));
    settings['elements'] = newElements;
    if (typeof this.editor != 'undefined') {
      delete this.editor;
    }
    this.editor = new GraphEditor('graph-editor', settings);
  }
};

function Graphing1stQuadrant(selector, problem) {
  GraphBase.prototype.constructor.call(this, selector, problem);
};
Graphing1stQuadrant.prototype = new GraphBase();
Graphing1stQuadrant.prototype.constructor = Graphing1stQuadrant;

function GraphingCoordinatePlane(selector, problem) {
  GraphBase.prototype.constructor.call(this, selector, problem);
};
GraphingCoordinatePlane.prototype = new GraphBase();
GraphingCoordinatePlane.prototype.constructor = GraphingCoordinatePlane;

function LineChart(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.correctAnswer = [];
  this.messageNext.message = 'All answers must be matched.';
  this.noInteractMessage = interactStudentMessages[1];
  var lineChartEditor = $(this.selector + ' #line-chart-editor');
  this.settings = {
    is_view: true,
    elements: [],
    x_min: (typeof lineChartEditor.attr('data-xmin') != 'undefined') ? parseFloat(lineChartEditor.attr('data-xmin')) : 0,
    x_max: (typeof lineChartEditor.attr('data-xmax') != 'undefined') ? parseFloat(lineChartEditor.attr('data-xmax')) : 10,
    y_min: (typeof lineChartEditor.attr('data-ymin') != 'undefined') ? parseFloat(lineChartEditor.attr('data-ymin')) : 0,
    y_max: (typeof lineChartEditor.attr('data-ymax') != 'undefined') ? parseFloat(lineChartEditor.attr('data-ymax')) : 10,
    numberOfPoints: (typeof lineChartEditor.attr('data-points') != 'undefined') ? parseFloat(lineChartEditor.attr('data-points')) : 0,
    labels: this.problem['ProblemChartAnswer']['labels'],
    startAtZero: (typeof lineChartEditor.attr('data-startzero') != 'undefined') ? parseInt(lineChartEditor.attr('data-startzero')) : false,
    elementMoveEvent: this.isTestManipulative ? 'InteractStudent.moveElement' : null
  };
  this.correctAnswer = this.problem['ProblemChartAnswer']['points'];
  if (typeof this.editor != 'undefined') {
    delete this.editor;
  }
  this.editor = new LineChartEditor('line-chart', this.settings);
  $(document).unbind(interactEvents.move).bind(interactEvents.move, function(e) {
    this.studentInteracted = true;
  }.bind(this));
  this.setupSecondary(true, problem);
};
LineChart.prototype = new ManipulativeBase();
LineChart.prototype.constructor = LineChart;
LineChart.prototype.selfEvaluate = function() {
  return false;
};
LineChart.prototype.isAnswerEntered = function() {
  var userAnswers = this.editor.getAnswer();
  return (this.editor.getAnswer().length > 0 && ($.inArray(true, userAnswers.map(function(i, e) {
    return (i.y != 0);
  })) != -1));
};
LineChart.prototype.isAnswerCorrect = function() {
  var ret = false;
  var userAnswers = this.editor.getAnswer();
  if (this.correctAnswer.length != userAnswers.length) {
    return ret;
  } else {
    ret = true;
    userAnswers.sort(function(a, b) {
      if (a.x == b.x) return a.y - b.y;
      return a.x - b.x;
    });
    ret = JSON.stringify(userAnswers) === JSON.stringify(this.correctAnswer);
  }
  return ret;
};
LineChart.prototype.showProblemFeedback = function(options) {
  var _this = this;
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    var elements = [];
    elements.push({
      type: 'cline',
      points: this.correctAnswer
    });
    this.settings.elements = elements;
    if (typeof this.editor != 'undefined') {
      delete this.editor;
    }
    this.editor = new LineChartEditor('line-chart', this.settings);
  }
};

function NumberLineGlobal(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.correctAnswer = [];
  this.messageNext.message = 'All answers must be matched.';
}
NumberLineGlobal.prototype = new ManipulativeBase();
NumberLineGlobal.prototype.constructor = NumberLineGlobal;
NumberLineGlobal.prototype.reverseArrayKeyValues = function(theArray) {
  var newArray = Object.keys(theArray).reduce(function(obj, key) {
    obj[theArray[key]] = key;
    return obj;
  }, {});
  return newArray;
};
NumberLineGlobal.prototype.selfEvaluate = function() {
  return false;
};
NumberLineGlobal.prototype.isAnswerEntered = function() {
  return (this.editor.getAnswer().length > 0);
};
NumberLineGlobal.prototype.strcmp = function(str1, str2) {
  return ((str1 === str2) ? 0 : ((str1 > str2) ? 1 : -1))
};
NumberLineGlobal.prototype.isAnswerCorrect = function() {
  var ret = false;
  var userAnswers = this.editor.getAnswer();
  if (this.correctAnswer.length != userAnswers.length) {
    return ret;
  } else {
    ret = true;
    for (var i = 0; i < userAnswers.length; i++) {
      userAnswers[i].points = userAnswers[i].points.sort(function(a, b) {
        if (a.x == b.x) return a.y - b.y;
        return a.x - b.x;
      });
    }
    userAnswers.sort(function(a, b) {
      var tmp = this.strcmp(a.type, b.type);
      if (tmp == 0) {
        if (a.points[0].x == b.points[0].x) {
          tmp = a.points[0].y - b.points[0].y;
        } else {
          tmp = a.points[0].x - b.points[0].x;
        }
      }
      return tmp;
    }.bind(this));
    ret = JSON.stringify(userAnswers) === JSON.stringify(this.correctAnswer);
  }
  return ret;
};
NumberLineGlobal.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    var tmpSettings = JSON.parse(JSON.stringify(this.settings));
    tmpSettings['elements'] = this.correctAnswer;
    if (typeof this.editor != 'undefined') {
      delete this.editor;
    }
    this.editor = new NumberLineEditor('.number-line-element', tmpSettings);
    $('.charts-element-tool li').removeClass('active');
  }
};

function NumberLineHorizontal(selector, problem) {
  NumberLineGlobal.prototype.constructor.call(this, selector, problem);
  var numberLineEditor = $(this.selector + ' .main-number-line');
  this.settings = {
    min: (typeof numberLineEditor.attr('data-min') != 'undefined') ? parseFloat(numberLineEditor.attr('data-min')) : 0,
    max: (typeof numberLineEditor.attr('data-max') != 'undefined') ? parseFloat(numberLineEditor.attr('data-max')) : 10,
    majorTickDensity: (typeof numberLineEditor.attr('data-majorTicks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-majorTicks')) : 1,
    minorTicksDensity: (typeof numberLineEditor.attr('data-minorTicks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-minorTicks')) : 1,
    numberOfStacks: (typeof numberLineEditor.attr('data-stacks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-stacks')) : 1,
    vertical: (typeof numberLineEditor.attr('data-vertical') != 'undefined') ? parseFloat(numberLineEditor.attr('data-vertical')) : false,
    elementAddEvent: this.isTestManipulative ? 'InteractStudent.addElement' : null
  };
  this.correctAnswer = this.problem['ProblemChartAnswer'];
  if (typeof this.editor != 'undefined') {
    delete this.editor;
  }
  this.editor = new NumberLineEditor('.number-line-element', this.settings);
  this.noInteractMessage = interactStudentMessages[1];
  var _this = this;
  $(document).unbind(interactEvents.add).bind(interactEvents.add, function(e) {
    _this.studentInteracted = true;
  });
  this.setupSecondary(true, problem);
}
NumberLineHorizontal.prototype = new NumberLineGlobal();
NumberLineHorizontal.prototype.constructor = NumberLineHorizontal;

function NumberLineVertical(selector, problem) {
  NumberLineGlobal.prototype.constructor.call(this, selector, problem);
  var numberLineEditor = $(this.selector + ' .main-number-line');
  this.settings = {
    min: (typeof numberLineEditor.attr('data-min') != 'undefined') ? parseFloat(numberLineEditor.attr('data-min')) : 0,
    max: (typeof numberLineEditor.attr('data-max') != 'undefined') ? parseFloat(numberLineEditor.attr('data-max')) : 10,
    majorTickDensity: (typeof numberLineEditor.attr('data-majorTicks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-majorTicks')) : 1,
    minorTicksDensity: (typeof numberLineEditor.attr('data-minorTicks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-minorTicks')) : 1,
    numberOfStacks: (typeof numberLineEditor.attr('data-stacks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-stacks')) : 1,
    vertical: (typeof numberLineEditor.attr('data-vertical') != 'undefined') ? parseFloat(numberLineEditor.attr('data-vertical')) : false,
    elementAddEvent: this.isTestManipulative ? 'InteractStudent.addElement' : null
  };
  this.correctAnswer = this.problem['ProblemChartAnswer'];
  if (typeof this.editor != 'undefined') {
    delete this.editor;
  }
  this.editor = new NumberLineEditor('.number-line-element', this.settings);
  this.noInteractMessage = interactStudentMessages[1];
  var _this = this;
  $(document).unbind(interactEvents.add).bind(interactEvents.add, function(e) {
    _this.studentInteracted = true;
  });
  this.setupSecondary(true, problem);
}
NumberLineVertical.prototype = new NumberLineGlobal();
NumberLineVertical.prototype.constructor = NumberLineVertical;

function NumberLineHorizontalStacked(selector, problem) {
  NumberLineGlobal.prototype.constructor.call(this, selector, problem);
  var numberLineEditor = $(this.selector + ' .main-number-line');
  this.settings = {
    min: (typeof numberLineEditor.attr('data-min') != 'undefined') ? parseFloat(numberLineEditor.attr('data-min')) : 0,
    max: (typeof numberLineEditor.attr('data-max') != 'undefined') ? parseFloat(numberLineEditor.attr('data-max')) : 10,
    majorTickDensity: (typeof numberLineEditor.attr('data-majorTicks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-majorTicks')) : 1,
    minorTicksDensity: (typeof numberLineEditor.attr('data-minorTicks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-minorTicks')) : 1,
    numberOfStacks: (typeof numberLineEditor.attr('data-stacks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-stacks')) : 1,
    vertical: (typeof numberLineEditor.attr('data-vertical') != 'undefined') ? parseFloat(numberLineEditor.attr('data-vertical')) : false,
    isStacked: true,
    elementAddEvent: this.isTestManipulative ? 'InteractStudent.addElement' : null
  };
  this.correctAnswer = this.problem['ProblemChartAnswer'];
  if (typeof this.editor != 'undefined') {
    delete this.editor;
  }
  this.editor = new NumberLineEditor('.number-line-element', this.settings);
  this.noInteractMessage = interactStudentMessages[1];
  var _this = this;
  $(document).unbind(interactEvents.add).bind(interactEvents.add, function(e) {
    _this.studentInteracted = true;
  });
  this.setupSecondary(true, problem);
}
NumberLineHorizontalStacked.prototype = new NumberLineGlobal();
NumberLineHorizontalStacked.prototype.constructor = NumberLineHorizontalStacked;

function NumberLineVerticalStacked(selector, problem) {
  NumberLineGlobal.prototype.constructor.call(this, selector, problem);
  var numberLineEditor = $(this.selector + ' .main-number-line');
  this.settings = {
    min: (typeof numberLineEditor.attr('data-min') != 'undefined') ? parseFloat(numberLineEditor.attr('data-min')) : 0,
    max: (typeof numberLineEditor.attr('data-max') != 'undefined') ? parseFloat(numberLineEditor.attr('data-max')) : 10,
    majorTickDensity: (typeof numberLineEditor.attr('data-majorTicks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-majorTicks')) : 1,
    minorTicksDensity: (typeof numberLineEditor.attr('data-minorTicks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-minorTicks')) : 1,
    numberOfStacks: (typeof numberLineEditor.attr('data-stacks') != 'undefined') ? parseFloat(numberLineEditor.attr('data-stacks')) : 1,
    vertical: (typeof numberLineEditor.attr('data-vertical') != 'undefined') ? parseFloat(numberLineEditor.attr('data-vertical')) : false,
    isStacked: true,
    elementAddEvent: this.isTestManipulative ? 'InteractStudent.addElement' : null
  };
  this.correctAnswer = this.problem['ProblemChartAnswer'];
  if (typeof this.editor != 'undefined') {
    delete this.editor;
  }
  this.editor = new NumberLineEditor('.number-line-element', this.settings);
  this.noInteractMessage = interactStudentMessages[1];
  var _this = this;
  $(document).unbind(interactEvents.add).bind(interactEvents.add, function(e) {
    _this.studentInteracted = true;
  });
  this.setupSecondary(true, problem);
}
NumberLineVerticalStacked.prototype = new NumberLineGlobal();
NumberLineVerticalStacked.prototype.constructor = NumberLineVerticalStacked;

function MathFormula(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'All fields must have an answer.';
  this.noInteractMessage = interactStudentMessages[1];
  if (typeof this.mathToolbar != 'undefined') {
    delete this.mathToolbar;
  }
  this.mathToolbar = new MathToolbarClass({
    responseIcon: false
  });
  this.mathToolbar.createMathformulaInputs();
  var _this = this;
  $(document).unbind(interactEvents.mousedown).bind(interactEvents.mousedown, function(e) {
    _this.studentInteracted = true;
    document.querySelectorAll(_this.selector + ' .mathformula-input-transformed .mq-root-block').forEach(function(formulaHolder) {
      if (formulaHolder.innerHTML === '') {
        _this.studentInteracted = false;
        return;
      }
      var mathToolbarElements = formulaHolder.querySelectorAll('*');
      if (mathToolbarElements.length === 1 && mathToolbarElements[0].classList.contains('fake_blinking_cursor')) {
        _this.studentInteracted = false;
        return;
      }
    });
  });
  this.setupSecondary(true, problem);
};
MathFormula.prototype = new ManipulativeBase();
MathFormula.prototype.constructor = MathFormula;
MathFormula.prototype.selfEvaluate = function() {
  return false;
};
MathFormula.prototype.isAnswerEntered = function() {
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  } else {
    return !this.mathToolbar.hasEmptyFormulaInputs();
  }
};
MathFormula.prototype.isAnswerCorrect = function() {
  return this.mathToolbar.compareExpressions(this.mathToolbar.formulaWithInput2mathjs(), this.getCorrectAnswer(), {
    'evalMethod': this.problem['MathFormula']['EvaluationMethod'],
    'ignoreCommas': this.problem['MathFormula']['IgnoreCommas'],
    'ignoreOrder': this.problem['MathFormula']['IgnoreOrder'],
    'ignoreCoefficientOne': this.problem['MathFormula']['IgnoreCoefficient'],
    'ignoreTrailingZeros': this.problem['MathFormula']['IgnoreTrailingZeros'],
    'significantDecimals': this.problem['MathFormula']['DecimalPlaces']
  });
};
MathFormula.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $(this.selector + ' .mq-root-block').html(this.problem['MathFormula']['CorrectAnswer']);
  }
};

function FillBlankMath(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'All fields must have an answer.';
  this.noInteractMessage = interactStudentMessages[1];
  if (typeof this.mathToolbar != 'undefined') {
    delete this.mathToolbar;
  }
  this.mathToolbar = new MathToolbarClass({
    responseIcon: false
  });
  this.mathToolbar.createMathformulaInputs();
  var _this = this;
  $(document).unbind(interactEvents.mousedown).bind(interactEvents.mousedown, function(e) {
    _this.studentInteracted = true;
    document.querySelectorAll(_this.selector + ' .mathformula-input-transformed').forEach(function(formulaHolder) {
      if (formulaHolder.querySelector('.mq-root-block') !== null && formulaHolder.querySelector('.mq-root-block').innerHTML === '') {
        _this.studentInteracted = false;
        return;
      }
      var mathToolbarElements = formulaHolder.querySelectorAll('.mq-root-block *');
      if (mathToolbarElements.length === 1 && mathToolbarElements[0].classList.contains('fake_blinking_cursor')) {
        _this.studentInteracted = false;
        return;
      }
    });
  });
  this.setupSecondary(true, problem);
};
FillBlankMath.prototype = new ManipulativeBase();
FillBlankMath.prototype.constructor = FillBlankMath;
FillBlankMath.prototype.selfEvaluate = function() {
  return false;
};
FillBlankMath.prototype.isAnswerEntered = function() {
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  } else {
    return !this.mathToolbar.hasEmptyFormulaInputs();
  }
};
FillBlankMath.prototype.parseAnswer = function() {
  var answers = [];
  document.querySelectorAll(this.selector + ' .mathformula-input-transformed .mq-root-block').forEach(function(formulaHolder) {
    answers.push(formulaHolder.innerHTML);
  })
  this.answer = answers.join('|');
  return this.answer;
};
FillBlankMath.prototype.isAnswerCorrect = function() {
  var _this = this;
  var isCorrect;
  $(".mathformula-input-transformed .mq-inner-editable[id^=response-]").each(function() {
    var id = $(this).attr('id').replace('response-', '');
    var answerElement = null;
    var mainRoot = $(this).find('.mq-root-block:first').clone();
    mainRoot.find('.mq-inner-editable').each(function() {
      var childrenRoots = $(this).find('.mq-root-block').children();
      if (childrenRoots.length) {
        answerElement = childrenRoots.unwrap();
      }
      $(this).children().unwrap();
    });
    if (answerElement == null) {
      answerElement = mainRoot;
    }
    isCorrect = _this.mathToolbar.compareExpressions(_this.mathToolbar.formula2mathjs(answerElement), _this.mathToolbar.formula2mathjs($('<span>' + _this.problem.FIB[id - 1].CorrectAnswer + '</span>')), {
      'evalMethod': '' + _this.problem.FIB[id - 1].EvaluationMethod,
      'significantDecimals': _this.problem.FIB[id - 1].DecimalPlaces,
      'ignoreCommas': false,
      'ignoreOrder': false,
      'ignoreCoefficientOne': false,
      'ignoreTrailingZeros': false,
    });
    if (!isCorrect) {
      return false;
    }
  });
  return isCorrect;
};
FillBlankMath.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    var _this = this;
    $(".mathformula-input-transformed .mq-inner-editable[id^=response-]").each(function() {
      var id = $(this).attr('id').replace('response-', '');
      $(this).html(_this.problem.FIB[id - 1].CorrectAnswer);
    });
  }
};
FillBlankMath.prototype.resetAnswer = function() {
  var inputs = document.querySelectorAll(this.selector + this.inputElement);
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].classList.remove('correct-input');
    inputs[i].classList.remove('incorrect-input');
    inputs[i].value = ''
  }
};
FillBlankMath.prototype.showAnswer = function(answer) {
  this.resetAnswer();
  var correctField = (answer + '').split('|');
  var correctAnswer = (this.getCorrectAnswer() + '').split("|");
  $(this.selector + this.inputElement).each(function(i, e) {
    if (i < correctAnswer.length) {
      $(e).val(correctField[i]);
      if (correctAnswer[i] === correctField[i]) {
        $(e).addClass("correct-input");
      } else {
        $(e).addClass("incorrect-input");
      }
    }
  });
};

function ELAAddPunctuation(selector, problem) {
  ManipulativeBase.prototype.constructor.call(this, selector, problem);
  this.messageNext.message = 'All fields must have an answer.';
  this.noInteractMessage = interactStudentMessages[1];
  this.editor = new AddPunctuation('.add-punctuation-wrapper', {
    interactEvent: this.isTestManipulative ? interactEvents.drag : null
  });
  $(document).unbind(interactEvents.drag).bind(interactEvents.drag, function() {
    this.studentInteracted = true;
  }.bind(this));
  this.setupSecondary(true, problem);
}
ELAAddPunctuation.prototype = new ManipulativeBase();
ELAAddPunctuation.prototype.constructor = ELAAddPunctuation;
ELAAddPunctuation.prototype.selfEvaluate = function() {
  return false;
};
ELAAddPunctuation.prototype.isAnswerEntered = function() {
  if (this.isTestManipulative) {
    return (this.hasStudentInteracted()) ? true : false;
  } else {
    return this.editor.hasAnswer();
  }
};
ELAAddPunctuation.prototype.isAnswerCorrect = function() {
  return this.getCorrectAnswer() == this.editor.getAnswer();
};
ELAAddPunctuation.prototype.showProblemFeedback = function(options) {
  ManipulativeBase.prototype.showProblemFeedback.call(this, options);
  if (options && options.isFluencyGames) {
    $(this.selector + ' .feedback-overlay').addClass('transparent-overlay');
    $('.add-punctuation-wrapper .ela-punctuation-spot').html('');
    $.each(this.getCorrectAnswer().split('|'), function(i, val) {
      if (val.length > 0) {
        $('.add-punctuation-wrapper .ela-punctuation-spot:eq(' + i + ')').html('<span class="ela-punctuation-added">' + val + '</span>');
      }
    });
  }
};;
(function($, window, document, undefined) {
  "use strict";
  $.fn.ensureLoad = function(handler) {
    return this.each(function() {
      if (this.complete) {
        handler.call(this);
      } else {
        $(this).on('load', handler);
      }
    });
  }
})(jQuery, window, document);
var messenger = {
  addEmailCount: 1,
  addMobileCount: 1,
  loadedContact: -1,
  lastClickedMessage: -1,
  selectedBox: 'inbox',
  gettingMoreData: false,
  currentPage: 0,
  screen: '',
  onCloseCallback: function() {},
  stack: {
    firstName: "",
    lastName: ""
  },
  selectedAll: {
    1: false,
    2: false,
    3: false,
    4: false
  },
  run: function() {
    dialog.open('student-messenger-dialog', {
      requestUrl: '/MM/MT/messenger_student/inbox' + '?_=' + Math.floor((Math.random() * 9999) + 1),
      afterOpen: function() {
        $('#student-messenger-dialog .standard-dialog-blue-title').text('Messenger Inbox');
        $('#student-messenger-dialog').data('section', 'inbox');
      }
    });
  },
  toggleMenu: function() {
    $('.messenger-menu .messenger-menu-items').fadeToggle('slow');
  },
  loadSection: function(section, title) {
    $('#student-messenger-dialog .standard-dialog-blue-loading').fadeIn(500, function() {
      $.ajax({
        type: 'POST',
        url: '/MM/MT/messenger_student/' + section + '?_=' + Math.floor((Math.random() * 9999) + 1),
        success: function(data) {
          $('#student-messenger-dialog .standard-dialog-blue-title').text('Messenger ' + title);
          if (data) {
            $('#student-messenger-dialog-content-html').html(data);
          }
          $('#student-messenger-dialog').data('section', section);
          $('#student-messenger-dialog .standard-dialog-blue-loading').fadeOut(500);
        },
        dataType: 'html'
      });
    });
  },
  loadMessage: function(id, section, tracking) {
    $('#student-messenger-dialog .standard-dialog-blue-loading').fadeIn(500, function() {
      $.get('/MM/MT/messenger_student/get_message/' + id + '/' + section + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
        $('#student-messenger-dialog-content-html').html(response);
        $('#student-messenger-dialog .standard-dialog-blue-loading').fadeOut(500);
        $.get('/MM/MT/messenger_student/mark_read/' + tracking + '/0', function() {
          messenger.checkForMessages(function(count) {
            $("#labstart-messenger-icon .count").html(count);
          });
        });
      }, 'html');
    });
  },
  deleteMessage: function(message) {
    $.get('/MM/MT/messenger_student/delete_message/' + message + "/student" + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
      messenger.loadSection('inbox', 'Messenger Inbox');
    });
  },
  deleteContact: function(id) {
    $.get("/MM/MT/messenger_student/delete_contact/" + id + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
      messenger.unloadEditDialog();
      messenger.loadSection('contact', 'Contact Info');
    }, 'json');
  },
  loadReply: function(message) {
    $('#student-messenger-dialog .standard-dialog-blue-loading').fadeIn(500, function() {
      $.get('/MM/MT/messenger_student/reply/' + message + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
        $('#student-messenger-dialog-content-html').html(response);
        $('#student-messenger-dialog-content-html textarea').placeholder();
        $('#student-messenger-dialog .standard-dialog-blue-loading').fadeOut(500);
      }, 'html');
    });
  },
  sendReply: function() {
    if ($(".message-text").val() == "") {
      alert('Please type a message.');
      return;
    }
    var teacherID = 0;
    if ($('input[name="data[teacher]"]').length) {
      teacherID = $('input[name="data[teacher]"]').val();
    }
    var data = $("#reply-to-message").serialize();
    $('#student-messenger-dialog .standard-dialog-blue-loading').fadeIn(500, function() {
      $.post("/MM/MT/messenger_student/send_reply" + '?_=' + Math.floor((Math.random() * 9999) + 1), data, function(response) {
        if (response.code == 'OK') {
          messenger.loadSection('inbox', 'Inbox');
          if (app.jsVars.AblyRealtime) {
            if (typeof(teacherID) != "undefined" && !isNaN(teacherID) && parseInt(teacherID) > 0)
              teacherMessagesChannel = app.jsVars.AblyRealtime.channels.get('t-' + teacherID);
            teacherMessagesChannel.publish('newMessage', {
              messageType: 'from-student',
              student_id: app.jsVars.studentId
            }, function(err) {
              if (err) console.log('realtime app error');
            });
          } else {
            window.alert("Real time functionality not available at this moment. Please check back later.");
          }
        } else {
          alert("Inappropriate words are not allowed! Please correct your message.");
        }
      }, 'json');
    });
  },
  createMessage: function() {
    $('#student-messenger-dialog .standard-dialog-blue-loading').fadeIn(500, function() {
      $.get('/MM/MT/messenger_student/new_message' + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
        $('#student-messenger-dialog-content-html').html(response);
        $('#student-messenger-dialog-content-html textarea').placeholder();
        $('#student-messenger-dialog .standard-dialog-blue-loading').fadeOut(500);
      }, 'html');
    });
  },
  sendMessage: function() {
    var content = $(".message-text").val();
    var to = $("#teacher-select").val();
    if (to == -1) {
      alert("Please select a contact.");
      return;
    }
    if (content == "") {
      alert('Please type a message.');
      return;
    }
    $('#student-messenger-dialog .standard-dialog-blue-loading').fadeIn(500, function() {
      $.post("/MM/MT/messenger_student/send_message" + '?_=' + Math.floor((Math.random() * 9999) + 1), {
        data: {
          content: content,
          to: to
        }
      }, function(response) {
        if (response.code == 'OK') {
          messenger.loadSection('inbox', 'Inbox');
          var teacherID = 0;
          var sel = $("#teacher-select")[0];
          if (sel.length) {
            teacherID = $(sel.options[sel.selectedIndex]).attr('data-id');
          }
          if (typeof(teacherID) != "undefined" && !isNaN(teacherID) && parseInt(teacherID) > 0)
            if (LiveMessage) LiveMessage.sendMessage(parseInt(teacherID));
        } else {
          alert("Inappropriate words are not allowed! Please correct your message.");
        }
      }, 'json');
    });
  },
  createContact: function(noStudent) {
    if ($("#first-name").val() == '') {
      setTimeout(function() {
        $("#first-name").btOn();
      }, 150);
      return;
    }
    if ($("#last-name").val() == '') {
      setTimeout(function() {
        $("#last-name").btOn();
      }, 150);
      return;
    }
    app.busy();
    $.get('/MM/MT/messenger_student/load_add_dialog' + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
      $("body").append(response);
      if (noStudent === false) {
        $("#relation option[value='1']").remove();
      }
      $.when(messenger.relationChanged()).done(function() {
        setTimeout(function() {
          messenger.showAddDialog();
        }, 500);
      });
      app.free();
      setTimeout(function() {
        $("form#contact-add").show();
      }, 1000);
      messenger.addMobileCount = 1;
      messenger.addEmailCount = 1;
      setTimeout(function() {
        $("#first-name, #last-name").bt({
          trigger: 'none',
          positions: ['right', 'left', 'top']
        });
      }, 150);
    });
  },
  saveContact: function() {
    if ($("#first-name").val() == '') {
      setTimeout(function() {
        $("#first-name").btOn();
      }, 150);
      return;
    }
    if ($("#last-name").val() == '') {
      setTimeout(function() {
        $("#last-name").btOn();
      }, 150);
      return;
    }
    $('#loading').show();
    var data = $("#contact-add").serialize();
    $.post("/MM/MT/messenger_student/save_contact" + '?_=' + Math.floor((Math.random() * 9999) + 1), data, function(response) {
      $('#loading').hide();
      messenger.unloadAddDialog();
      $('#student-messenger-dialog .standard-dialog-blue-loading').fadeIn(500, function() {
        messenger.loadSection('contact', 'Contact Info');
      });
    }, 'json');
  },
  editContact: function(id, noStudent) {
    if ($("#first-name").val() == '') {
      setTimeout(function() {
        $("#first-name").btOn();
      }, 150);
      return;
    }
    if ($("#last-name").val() == '') {
      setTimeout(function() {
        $("#last-name").btOn();
      }, 150);
      return;
    }
    $('#loading').show();
    $.get('/MM/MT/messenger_student/load_edit_dialog/' + id + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
      $("body").append(response);
      if (noStudent === false) {
        $("#relation option[value='1']").remove();
      }
      messenger.stack.firstName = $("#first-name").val();
      messenger.stack.lastName = $("#last-name").val();
      $.when(messenger.relationChanged()).done(function() {
        setTimeout(function() {
          messenger.showEditDialog();
        }, 500);
      });
      $('#loading').hide();
      messenger.addMobileCount = 1;
      messenger.addEmailCount = 1;
      $("#contact-id").val(id);
      setTimeout(function() {
        $("#first-name, #last-name").bt({
          trigger: 'none',
          positions: ['right', 'left', 'top']
        });
      }, 150);
    });
  },
  saveEditedContact: function() {
    if ($("#first-name").val() == '') {
      setTimeout(function() {
        $("#first-name").btOn();
      }, 150);
      return;
    }
    if ($("#last-name").val() == '') {
      setTimeout(function() {
        $("#last-name").btOn();
      }, 150);
      return;
    }
    $('#loading').show();
    var data = $("#contact-edit").serialize();
    $.post("/MM/MT/messenger_student/edit_contact" + '?_=' + Math.floor((Math.random() * 9999) + 1), data, function(response) {
      $('#loading').hide();
      messenger.unloadEditDialog();
      messenger.loadSection('contact', 'Contact Info');
    }, 'json');
  },
  resetAllSelected: function() {
    messenger.selectedAll['1'] = false;
    messenger.selectedAll['2'] = false;
    messenger.selectedAll['3'] = false;
    messenger.selectedAll['4'] = false;
  },
  checkAll: function(source, type) {
    $(".selected-contact-" + type).attr('checked', $(source).is(':checked'));
    messenger.selectedAll[type] = $(source).is(':checked');
  },
  unloadAddDialog: function() {
    dialog.close('messenger-add-dialog-std', {
      afterClose: function() {
        $('.messenger-add-dialog-std, messenger-add-dialog-std-overlay').remove();
      }
    });
  },
  unloadEditDialog: function() {
    dialog.close('messenger-edit-dialog-std', {
      afterClose: function() {
        $('.messenger-edit-dialog-std, messenger-edit-dialog-std-overlay').remove();
      }
    });
  },
  showEditDialog: function() {
    dialog.open('messenger-edit-dialog-std');
  },
  showAddDialog: function() {
    dialog.open('messenger-add-dialog-std');
  },
  addDialogAddMobile: function() {
    messenger.addMobileCount++;
    var html = "\
   <div class=\"mobile-component mobile-more\">\
    <input id='mobile-" + messenger.addMobileCount + "'name='data[mobile][" + messenger.addMobileCount + "]'/>\
    <span class=\"delete\" onclick='messenger.removeInput(\"#mobile-" + messenger.addMobileCount + "\")'><img src='/MM/img/ex-trash.png'/></span>\
   </div>\
  ";
    $(html).insertBefore(".add-more-mobile");
  },
  editDialogAddMobile: function() {
    messenger.addMobileCount++;
    var html = "\
   <div class=\"mobile-component\">\
    <input id='mobile-" + messenger.addMobileCount + "'name='data[mobile][" + messenger.addMobileCount + "]'/>\
    <span class=\"delete\" onclick='messenger.removeInput(\"#mobile-" + messenger.addMobileCount + "\")'><img src='/MM/img/ex-trash.png'/></span>\
   </div>\
  ";
    $(html).insertBefore(".add-more-mobile");
  },
  editDialogAddEmail: function() {
    messenger.addEmailCount++;
    var html = "\
   <div class=\"email-component email-more\">\
    <input id='email-" + messenger.addEmailCount + "'name='data[email][" + messenger.addEmailCount + "]'/>\
    <span class=\"delete\" onclick='messenger.removeInput(\"#email-" + messenger.addEmailCount + "\")'><img src='/MM/img/ex-trash.png'/></span>\
   </div>\
  ";
    $(html).insertBefore(".add-more-email");
  },
  addDialogAddEmail: function() {
    messenger.addEmailCount++;
    var html = "\
   <div class=\"email-component email-more\">\
    <input id='email-" + messenger.addEmailCount + "'name='data[email][" + messenger.addEmailCount + "]'/>\
    <span class=\"delete\" onclick='messenger.removeInput(\"#email-" + messenger.addEmailCount + "\")'><img src='/MM/img/ex-trash.png'/></span>\
   </div>\
  ";
    $(html).insertBefore(".add-more-email");
  },
  removeDelivery: function(selector, id) {
    app.busy();
    $.get('/MM/MT/messenger/remove_delivery/' + id + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
      messenger.removeInput(selector);
      app.free();
    });
  },
  removeInput: function(selector) {
    $(selector).parent().remove();
  },
  pagingInbox: function() {
    $('.message-sumaries').scroll(function() {
      var item = $('.message-sumaries');
      if (item.outerHeight() == (item.get(0).scrollHeight - item.scrollTop())) {
        if (messenger.gettingMoreData == false) {
          messenger.gettingMoreData = true;
          messenger.currentPage++;
          app.busy();
          $.get('/MM/MT/messenger/more_inbox/' + messenger.currentPage, function(response) {
            app.free();
            $('.message-sumaries').append(response);
            if (response != "") {
              messenger.gettingMoreData = false;
            }
          });
        }
      }
    });
  },
  pagingDeleted: function() {
    $('.message-sumaries').scroll(function() {
      var item = $('.message-sumaries');
      if (item.outerHeight() == (item.get(0).scrollHeight - item.scrollTop())) {
        if (messenger.gettingMoreData == false) {
          messenger.gettingMoreData = true;
          messenger.currentPage++;
          app.busy();
          $.get('/MM/MT/messenger/more_deleted/' + messenger.currentPage, function(response) {
            app.free();
            $('.message-sumaries').append(response);
            if (response != "") {
              messenger.gettingMoreData = false;
            }
          });
        }
      }
    });
  },
  pagingSent: function() {
    $('.message-sumaries').scroll(function() {
      var item = $('.message-sumaries');
      if (item.outerHeight() == (item.get(0).scrollHeight - item.scrollTop())) {
        if (messenger.gettingMoreData == false) {
          messenger.gettingMoreData = true;
          messenger.currentPage++;
          app.busy();
          $.get('/MM/MT/messenger/more_sent/' + messenger.currentPage, function(response) {
            app.free();
            $('.message-sumaries').append(response);
            if (response != "") {
              messenger.gettingMoreData = false;
            }
          });
        }
      }
    });
  },
  toggleContinueReplyMessage: function(type) {
    if (type == 1) {
      $(".button-send-reply-teacher").show();
      $("#TeacherReplyToText").show();
      $("#TeacherReplyContents").show();
      $(".button-continue-reply-teacher").hide();
    } else {
      $(".button-send-reply-teacher").hide();
      $("#TeacherReplyToText").hide();
      $("#TeacherReplyContents").hide();
      $(".button-continue-reply-teacher").show();
    }
  },
  studentChanged: function() {
    var id = $("#student-select").val();
    app.busy();
    $.get("/MM/MT/messenger/set_filter_student/" + id + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
      app.free();
      if (messenger.selectedBox == 'inbox') {
        messenger.selectInbox();
      } else {
        messenger.selectSent();
      }
    }, 'json');
  },
  relationChanged: function() {
    var selectedValue = $("#relation").val();
    app.busy();
    if (selectedValue == 1) {
      $.get("/MM/MT/messenger_student/get_user/" + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
        $("#first-name").val(response.CurrentUser.User.NameFirst);
        $("#last-name").val(response.CurrentUser.User.NameLast);
        $("#first-name").parent().parent().hide();
        $("#last-name").parent().parent().hide();
        app.free();
      }, 'json');
    } else {
      if ($("#contact-id").length) {
        $("#first-name").val(messenger.stack.firstName);
        $("#last-name").val(messenger.stack.lastName);
      } else {
        $("#first-name").val("");
        $("#last-name").val("");
      }
      $("#first-name").parent().parent().show();
      $("#last-name").parent().parent().show();
      app.free();
    }
  },
  relationChangedTeacher: function() {
    var selectedValue = $("#relation").val();
    if (selectedValue == 1) {
      $("#first-name").parent().parent().hide();
      $("#last-name").parent().parent().hide();
      $(".table-input-mobile").hide();
      $(".table-input-email").hide();
      $("#notes").parent().parent().hide();
      $(".save-contact").hide();
      $(".message-privacy").show();
    } else {
      $("#first-name").parent().parent().show();
      $("#last-name").parent().parent().show();
      $(".table-input-mobile").show();
      $(".table-input-email").show();
      $("#notes").parent().parent().show();
      $(".save-contact").show();
      $(".message-privacy").hide();
    }
  },
  limitInput: function(selector, limit) {
    var string = $(selector).val();
    if (string.length > limit) {
      string = string.substr(0, limit);
      $(selector).val(string);
      return false;
    }
  },
  unloadGetMoreMessage: function() {
    $(".messenger-overlay2").hide();
    $(".messenger-more-message-dialog").remove();
  },
  getMoreMessage: function(id) {
    app.busy();
    $.get("/MM/MT/messenger/get_more_message/" + id + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
      $("body").append(response);
      $(".messenger-more-message-dialog").show();
      if (messenger.useCenter == true) $(".messenger-more-message-dialog").center();
      app.free();
      $(".messenger-overlay2").show();
    });
  },
  ucwords: function(str) {
    return (str + '').replace(/^([a-z])|\s+([a-z])/g, function($1) {
      return $1.toUpperCase();
    });
  },
  uppercase: function(selector) {
    $(selector).val(messenger.ucwords($(selector).val()));
  },
  checkForMessages: function(callback) {
    $.get("/MM/MT/messenger_student/check_for_messages/" + '?_=' + Math.floor((Math.random() * 9999) + 1), function(response) {
      if ($(".messenger-panel-button-div").length > 0) {
        if (response.newMessageCount >= 10) {
          $(".messenger-panel-button-div").css("width", "118px");
        }
      }
      callback(response.newMessageCount);
    }, 'json');
  }
};

function onMessengerIconClick() {
  messenger.run();
}

function AssessmentsApi(config) {
  this.config = {
    assessmentsLabUrl: '',
    subjects: {},
    endpoints: {}
  };
  if (config) {
    this.setConfig(config);
  }
}
AssessmentsApi.prototype.setConfig = function(config) {
  this.config = config;
};
AssessmentsApi.prototype.getConfig = function() {
  return $.extend({}, this.config);
};
AssessmentsApi.prototype.getEndpoint = function(name, params) {
  if (!name) {
    console.log('"name" argument is not set');
    return false;
  }
  var parts = name.split('.');
  var serviceName = parts.shift();
  var service = this.getConfig().endpoints[serviceName];
  if (service.server.indexOf('https') == -1 && service.server.indexOf('http') == -1) {
    service.server = 'https://' + service.server;
  }
  var url = service.server + '/' + service.version;
  var endpoint = service;
  for (var i = 0; i < parts.length; i++) {
    url += endpoint.endpoints[parts[i]].path;
    endpoint = endpoint.endpoints[parts[i]];
  }
  for (var key in params) {
    var replacement = '{' + key + '}';
    url = url.replace(replacement, params[key]);
  }
  return {
    url: url,
    method: endpoint.method
  };
};
AssessmentsApi.prototype.getAssignments = function(studentId, restrictedTo) {
  var endpoint = this.getEndpoint('za-api.student.tests.assigned', {
    studentId: studentId
  });
  if (restrictedTo === undefined) {
    restrictedTo = false;
  }
  $.ajax({
    type: endpoint.method,
    url: endpoint.url,
    xhrFields: {
      withCredentials: true
    },
    data: {
      restrictedTo,
    }
  }).done(function(assignments) {
    $(document).trigger('api.assessments.assignments.fetched', assignments);
  }).fail(function(xhr, textStatus, error) {
    $(document).trigger('api.assessments.assignments.error', {
      text: textStatus,
      error: error
    });
  });
};
AssessmentsApi.prototype.createPMTest = function(students, teacherId, subjectId, testType, gradeMin, gradeMax, assignmentName) {
  testType = testType || 0;
  gradeMax = gradeMax || null;
  if (testType) {
    gradeMin = gradeMax = null;
  }
  var endpoint = this.getEndpoint('za-api.gl.subject.test', {
    subjectId: subjectId
  });
  $.ajax({
    type: endpoint.method,
    url: endpoint.url,
    data: JSON.stringify({
      students: students,
      teacherId: teacherId,
      ZLRequest: true,
      testLength: null,
      dateDue: null,
      skipPassed: testType,
      gradeId: gradeMin,
      gradeMax: gradeMax,
      name: assignmentName || null,
    }),
    xhrFields: {
      withCredentials: true
    },
    contentType: "application/json; charset=utf-8",
    dataType: "json",
  }).done(function(placementTest) {
    $(document).trigger('api.assessments.placement.created', placementTest);
  }).fail(function(xhr, textStatus, error) {
    $(document).trigger('api.assessments.placement.error', {
      text: textStatus,
      error: error
    });
  });
};
AssessmentsApi.prototype.deletePMTest = function(studentTestIds, studentId, subjectId) {
  var endpoint = this.getEndpoint('za-api.gl.subject.students.tests', {
    subjectId: subjectId,
    studentId: studentId
  });
  $.ajax({
    type: endpoint.method,
    url: endpoint.url,
    data: JSON.stringify({
      studentTestIds: studentTestIds,
      testIds: []
    }),
    xhrFields: {
      withCredentials: true
    },
    contentType: "application/json; charset=utf-8",
    dataType: "json",
  }).done(function(placementTest) {
    $(document).trigger('api.assessments.placement.delete.success', placementTest);
  }).fail(function(xhr, textStatus, error) {
    $(document).trigger('api.assessments.placement.delete.error', {
      text: textStatus,
      error: error
    });
  });
};
AssessmentsApi.prototype.getStudentProblems = function(subjectId, studentId, fkZATestID, callBack) {
  var endpoint = this.getEndpoint('za-api.gl.subject.student.test.problems', {
    subjectId: subjectId,
    studentId: studentId,
    studentTestId: fkZATestID
  });
  $.ajax({
    type: endpoint.method,
    url: endpoint.url,
    xhrFields: {
      withCredentials: true
    },
    contentType: "application/json; charset=utf-8",
    dataType: "json",
  }).done(function(problemList) {
    callBack(problemList);
  });
};
AssessmentsApi.prototype.resetStudent = function(subjectId, studentId, callBack) {
  var endpoint = this.getEndpoint('za-api.student.reset', {
    studentId: studentId
  });
  $.ajax({
    type: endpoint.method,
    url: endpoint.url,
    data: JSON.stringify({
      moduleId: subjectId
    }),
    xhrFields: {
      withCredentials: true
    },
    contentType: "application/json; charset=utf-8",
    dataType: "json",
  }).done(function(problemList) {
    callBack(problemList);
  });
};
AssessmentsApi.prototype.bulkResetStudents = function(subjectId, studentsIDs, callback) {
  var endpoint = this.getEndpoint('za-api.student.bulkReset');
  $.ajax({
    type: endpoint.method,
    url: endpoint.url,
    data: JSON.stringify({
      moduleId: subjectId,
      studentsIDs: studentsIDs
    }),
    xhrFields: {
      withCredentials: true
    },
    contentType: "application/json; charset=utf-8",
    dataType: "json",
  }).done(function(callbackParams) {
    callback(callbackParams);
  });
};
AssessmentsApi.prototype.saveSoundSettings = function(teacherId, studentIds, soundSetting) {
  var endpoint = null;
  var soundSettings = null;
  if (studentIds.length == 0) {
    endpoint = this.getEndpoint('za-api.settings.teacher', {
      teacherId: teacherId
    });
    soundSettings = {
      GLPM: {
        Teacher: {
          SoundSetting: soundSetting
        }
      },
      GLPL: {
        Teacher: {
          SoundSetting: soundSetting
        }
      },
      GLPFR: {
        Teacher: {
          SoundSetting: soundSetting
        }
      }
    };
  } else {
    endpoint = this.getEndpoint('za-api.settings.students', {
      teacherId: teacherId
    });
    soundSettings = {
      settings: {
        GLPM: {
          Student: {
            SoundSetting: soundSetting
          }
        },
        GLPL: {
          Student: {
            SoundSetting: soundSetting
          }
        },
        GLPFR: {
          Student: {
            SoundSetting: soundSetting
          }
        }
      },
      studentIds: studentIds
    };
  }
  $.ajax({
    type: endpoint.method,
    url: endpoint.url,
    data: JSON.stringify(soundSettings),
    xhrFields: {
      withCredentials: true
    },
    contentType: "application/json; charset=utf-8",
    dataType: "json",
  });
};
AssessmentsApi.prototype.getStudentTestSkills = function(subjectId, studentId, studentTestId) {
  var endpoint = this.getEndpoint('za-api.gl.subject.students.tests.skills', {
    subjectId: subjectId,
    studentId: studentId,
    studentTestId: studentTestId
  });
  $.ajax({
    type: endpoint.method,
    url: endpoint.url,
    xhrFields: {
      withCredentials: true
    }
  }).done(function(assignments) {
    $(document).trigger('api.assessments.placement.test.skills.fetched', assignments);
  }).fail(function(xhr, textStatus, error) {
    $(document).trigger('api.assessments.placement.test.skills.error', {
      text: textStatus,
      error: error
    });
  });
};
var soundSettings = {
  soundIsPlaying: false,
  displaySoundSettingsSections: function(lab, labName) {
    jsVars.hiddenReadAloudSettingsModule = lab.responsiveVoice.hiddenReadAloudSettingsModules.indexOf(labName.toLowerCase()) > -1;
    jsVars.hiddenPollySettingsModule = lab.responsiveVoice.defaultType !== 'polly' || Object.keys(lab.responsiveVoice.pollySettingsModules).indexOf(labName.toLowerCase()) === -1;
    if (jsVars.hiddenReadAloudSettingsModule) {
      $('.read-aloud-section').hide();
      if (parseInt(jsVars.isVoiceSelectable, 10) === 0 && parseInt(jsVars.isSpeechHighlightSelectable, 10) === 0) {
        $(".sound-diagnostic-fieldset").show();
        $(".sound-diagnostic-text").html("Teacher has disabled voice settings in the teacher's module.");
        $('#sound-settings-content-html .save-button').hide();
      }
    }
    if (parseInt(jsVars.isVoiceSelectable, 10) !== 0) {
      soundSettings.fillSoundSettingsHtml(lab.responsiveVoice.voicesData, jsVars.voiceName, jsVars.voiceSpeed);
    }
    $("input[name='speech-highlight']").prop("checked", !!parseInt(jsVars.isSpeechHighlight, 10)).trigger('change');
    this.handleReadAloudSetting();
    $(".sound-setting-fieldset").on('change', this.handleReadAloudSetting);
  },
  handleReadAloudSetting: function() {
    if (jsVars.hiddenPollySettingsModule) {
      $('.word-highlighting-section').hide();
      $('.voice-section').hide();
      if (jsVars.hiddenReadAloudSettingsModule) {
        $(".sound-diagnostic-fieldset").show();
        $(".sound-diagnostic-text").html("Your sound settings are correct.");
        $('#sound-settings-content-html .save-button').hide();
      }
      return;
    }
    var readAloudSetting = parseInt($('.sound-setting-fieldset').val(), 10);
    var isSpeechHighlightSelectable = parseInt(jsVars.isSpeechHighlightSelectable, 10);
    var isVoiceSelectable = parseInt(jsVars.isVoiceSelectable, 10);
    if (isSpeechHighlightSelectable === 0 || (!jsVars.hiddenReadAloudSettingsModule && readAloudSetting === 0)) {
      $('.word-highlighting-section').hide();
    } else {
      $('.word-highlighting-section').show();
    }
    if (isVoiceSelectable === 0 || (!jsVars.hiddenReadAloudSettingsModule && readAloudSetting === 0)) {
      $('.voice-section').hide();
    } else {
      $('.voice-section').show();
    }
  },
  fillSoundSettingsHtml: function(voicesData, voiceName, voiceSpeed) {
    var htmlVoiceSpeedOptions = "";
    var htmlVoiceName = "";
    var clonedMappedSpeeds = voicesData.mappedSpeeds.map(function(x) {
      return x;
    });
    for (var speed of clonedMappedSpeeds.reverse()) {
      var checked = parseInt(speed.id) === parseInt(voiceSpeed) ? 'checked' : '';
      htmlVoiceSpeedOptions += '<div class="option">\
     <input \
      type="radio"\
      onchange="soundSettings.select_voice_speed(this)"\
      name="voice-speed"\
      id="voice-speed-id-' + speed.id + '" \
      value="' + speed.id + '" \
      ' + checked + '\
     />\
     ' + speed.frontendValue + '\
    </div>';
    }
    $(".voice-speed-container").html(htmlVoiceSpeedOptions);
    for (var name of voicesData.mappedNames) {
      var background = voicesData.styles[name.frontendValue];
      var selected = parseInt(name.id) === parseInt(voiceName) ? 'selected' : '';
      htmlVoiceName += '<div class="voice ' + selected + '" id="voice-name-id-' + name.id + '" data-id="' + name.id + '" style="background: ' + background + '" onclick="soundSettings.select_voice_name(this)">\
     <span class="checkmark ' + selected + '">\
      <div class="checkmark-circle"></div>\
      <div class="checkmark-stem"></div>\
      <div class="checkmark-kick"></div>\
     </span>\
     <span>' + name.frontendValue + '</span>\
    </div>';
    }
    $(".voice-name-container").html(htmlVoiceName);
  },
  select_voice: function(voiceNameId) {
    var voiceSpeedId = $('input[name="voice-speed"]:checked').val();
    var responsiveVoice = window.app.labObject.responsiveVoice;
    var lab = [window['MSlab'], window['TMlab'], window['TPlab'], window['VLlab'], window['MRlab'], window['CL']].filter(function(l) {
      return !!l;
    })[0];
    this.playTTS('Hello, my name is ' + responsiveVoice.getTextFrontendVoiceName(voiceNameId), {
      polly: {
        voice: window.app.labObject.responsiveVoice.getTextVoiceName(voiceNameId),
        noSpeechMark: true,
        speed: window.app.labObject.responsiveVoice.getTextVoiceSpeed(voiceSpeedId),
        moduleId: 'mc',
        onplay: function() {
          soundSettings.soundIsPlaying = true;
        },
        onfinish: function() {
          soundSettings.soundIsPlaying = false;
        }
      }
    }, lab);
  },
  select_voice_speed: function(target) {
    var voiceNameId = $(".voice.selected").attr('data-id');
    soundSettings.select_voice(voiceNameId);
  },
  select_voice_name: function(target) {
    $('.voice').removeClass('selected');
    $('.checkmark').removeClass('selected')
    $(target).find('.checkmark').addClass('selected');
    $(target).addClass('selected');
    var voiceNameId = $(target).attr('data-id');
    soundSettings.select_voice(voiceNameId);
  },
  playTTS: function(id, options, lab) {
    var readThis = id;
    if (lab && lab.pauseInitedSound) {
      lab.pauseInitedSound();
    }
    if (id.substring(id.length - 3).toLowerCase() == 'tts' && typeof CurrentProblem !== 'undefined' && typeof CurrentProblem[id] !== 'undefined') {
      readThis = CurrentProblem[id];
    }
    lab.responsiveVoice.responsiveVoiceReady.promise().then(function() {
      lab.responsiveVoice.speak(readThis, options);
    });
  },
};
/*!
 * @license CreateJS
 * Visit http://createjs.com/ for documentation, updates and examples.
 *
 * Copyright (c) 2011-2015 gskinner.com, inc.
 *
 * Distributed under the terms of the MIT license.
 * http://www.opensource.org/licenses/mit-license.html
 *
 * This notice shall be included in all copies or substantial portions of the Software.
 */
this.createjs = this.createjs || {}, createjs.extend = function(a, b) {
    "use strict";

    function c() {
      this.constructor = a
    }
    return c.prototype = b.prototype, a.prototype = new c
  }, this.createjs = this.createjs || {}, createjs.promote = function(a, b) {
    "use strict";
    var c = a.prototype,
      d = Object.getPrototypeOf && Object.getPrototypeOf(c) || c.__proto__;
    if (d) {
      c[(b += "_") + "constructor"] = d.constructor;
      for (var e in d) c.hasOwnProperty(e) && "function" == typeof d[e] && (c[b + e] = d[e])
    }
    return a
  }, this.createjs = this.createjs || {}, createjs.indexOf = function(a, b) {
    "use strict";
    for (var c = 0, d = a.length; d > c; c++)
      if (b === a[c]) return c;
    return -1
  }, this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      throw "UID cannot be instantiated"
    }
    a._nextID = 0, a.get = function() {
      return a._nextID++
    }, createjs.UID = a
  }(), this.createjs = this.createjs || {}, createjs.deprecate = function(a, b) {
    "use strict";
    return function() {
      var c = "Deprecated property or method '" + b + "'. See docs for info.";
      return console && (console.warn ? console.warn(c) : console.log(c)), a && a.apply(this, arguments)
    }
  }, this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c) {
      this.type = a, this.target = null, this.currentTarget = null, this.eventPhase = 0, this.bubbles = !!b, this.cancelable = !!c, this.timeStamp = (new Date).getTime(), this.defaultPrevented = !1, this.propagationStopped = !1, this.immediatePropagationStopped = !1, this.removed = !1
    }
    var b = a.prototype;
    b.preventDefault = function() {
      this.defaultPrevented = this.cancelable && !0
    }, b.stopPropagation = function() {
      this.propagationStopped = !0
    }, b.stopImmediatePropagation = function() {
      this.immediatePropagationStopped = this.propagationStopped = !0
    }, b.remove = function() {
      this.removed = !0
    }, b.clone = function() {
      return new a(this.type, this.bubbles, this.cancelable)
    }, b.set = function(a) {
      for (var b in a) this[b] = a[b];
      return this
    }, b.toString = function() {
      return "[Event (type=" + this.type + ")]"
    }, createjs.Event = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      this._listeners = null, this._captureListeners = null
    }
    var b = a.prototype;
    a.initialize = function(a) {
      a.addEventListener = b.addEventListener, a.on = b.on, a.removeEventListener = a.off = b.removeEventListener, a.removeAllEventListeners = b.removeAllEventListeners, a.hasEventListener = b.hasEventListener, a.dispatchEvent = b.dispatchEvent, a._dispatchEvent = b._dispatchEvent, a.willTrigger = b.willTrigger
    }, b.addEventListener = function(a, b, c) {
      var d;
      d = c ? this._captureListeners = this._captureListeners || {} : this._listeners = this._listeners || {};
      var e = d[a];
      return e && this.removeEventListener(a, b, c), e = d[a], e ? e.push(b) : d[a] = [b], b
    }, b.on = function(a, b, c, d, e, f) {
      return b.handleEvent && (c = c || b, b = b.handleEvent), c = c || this, this.addEventListener(a, function(a) {
        b.call(c, a, e), d && a.remove()
      }, f)
    }, b.removeEventListener = function(a, b, c) {
      var d = c ? this._captureListeners : this._listeners;
      if (d) {
        var e = d[a];
        if (e)
          for (var f = 0, g = e.length; g > f; f++)
            if (e[f] == b) {
              1 == g ? delete d[a] : e.splice(f, 1);
              break
            }
      }
    }, b.off = b.removeEventListener, b.removeAllEventListeners = function(a) {
      a ? (this._listeners && delete this._listeners[a], this._captureListeners && delete this._captureListeners[a]) : this._listeners = this._captureListeners = null
    }, b.dispatchEvent = function(a, b, c) {
      if ("string" == typeof a) {
        var d = this._listeners;
        if (!(b || d && d[a])) return !0;
        a = new createjs.Event(a, b, c)
      } else a.target && a.clone && (a = a.clone());
      try {
        a.target = this
      } catch (e) {}
      if (a.bubbles && this.parent) {
        for (var f = this, g = [f]; f.parent;) g.push(f = f.parent);
        var h, i = g.length;
        for (h = i - 1; h >= 0 && !a.propagationStopped; h--) g[h]._dispatchEvent(a, 1 + (0 == h));
        for (h = 1; i > h && !a.propagationStopped; h++) g[h]._dispatchEvent(a, 3)
      } else this._dispatchEvent(a, 2);
      return !a.defaultPrevented
    }, b.hasEventListener = function(a) {
      var b = this._listeners,
        c = this._captureListeners;
      return !!(b && b[a] || c && c[a])
    }, b.willTrigger = function(a) {
      for (var b = this; b;) {
        if (b.hasEventListener(a)) return !0;
        b = b.parent
      }
      return !1
    }, b.toString = function() {
      return "[EventDispatcher]"
    }, b._dispatchEvent = function(a, b) {
      var c, d, e = 2 >= b ? this._captureListeners : this._listeners;
      if (a && e && (d = e[a.type]) && (c = d.length)) {
        try {
          a.currentTarget = this
        } catch (f) {}
        try {
          a.eventPhase = 0 | b
        } catch (f) {}
        a.removed = !1, d = d.slice();
        for (var g = 0; c > g && !a.immediatePropagationStopped; g++) {
          var h = d[g];
          h.handleEvent ? h.handleEvent(a) : h(a), a.removed && (this.off(a.type, h, 1 == b), a.removed = !1)
        }
      }
      2 === b && this._dispatchEvent(a, 2.1)
    }, createjs.EventDispatcher = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      throw "Ticker cannot be instantiated."
    }
    a.RAF_SYNCHED = "synched", a.RAF = "raf", a.TIMEOUT = "timeout", a.timingMode = null, a.maxDelta = 0, a.paused = !1, a.removeEventListener = null, a.removeAllEventListeners = null, a.dispatchEvent = null, a.hasEventListener = null, a._listeners = null, createjs.EventDispatcher.initialize(a), a._addEventListener = a.addEventListener, a.addEventListener = function() {
      return !a._inited && a.init(), a._addEventListener.apply(a, arguments)
    }, a._inited = !1, a._startTime = 0, a._pausedTime = 0, a._ticks = 0, a._pausedTicks = 0, a._interval = 50, a._lastTime = 0, a._times = null, a._tickTimes = null, a._timerId = null, a._raf = !0, a._setInterval = function(b) {
      a._interval = b, a._inited && a._setupTick()
    }, a.setInterval = createjs.deprecate(a._setInterval, "Ticker.setInterval"), a._getInterval = function() {
      return a._interval
    }, a.getInterval = createjs.deprecate(a._getInterval, "Ticker.getInterval"), a._setFPS = function(b) {
      a._setInterval(1e3 / b)
    }, a.setFPS = createjs.deprecate(a._setFPS, "Ticker.setFPS"), a._getFPS = function() {
      return 1e3 / a._interval
    }, a.getFPS = createjs.deprecate(a._getFPS, "Ticker.getFPS");
    try {
      Object.defineProperties(a, {
        interval: {
          get: a._getInterval,
          set: a._setInterval
        },
        framerate: {
          get: a._getFPS,
          set: a._setFPS
        }
      })
    } catch (b) {
      console.log(b)
    }
    a.init = function() {
      a._inited || (a._inited = !0, a._times = [], a._tickTimes = [], a._startTime = a._getTime(), a._times.push(a._lastTime = 0), a.interval = a._interval)
    }, a.reset = function() {
      if (a._raf) {
        var b = window.cancelAnimationFrame || window.webkitCancelAnimationFrame || window.mozCancelAnimationFrame || window.oCancelAnimationFrame || window.msCancelAnimationFrame;
        b && b(a._timerId)
      } else clearTimeout(a._timerId);
      a.removeAllEventListeners("tick"), a._timerId = a._times = a._tickTimes = null, a._startTime = a._lastTime = a._ticks = a._pausedTime = 0, a._inited = !1
    }, a.getMeasuredTickTime = function(b) {
      var c = 0,
        d = a._tickTimes;
      if (!d || d.length < 1) return -1;
      b = Math.min(d.length, b || 0 | a._getFPS());
      for (var e = 0; b > e; e++) c += d[e];
      return c / b
    }, a.getMeasuredFPS = function(b) {
      var c = a._times;
      return !c || c.length < 2 ? -1 : (b = Math.min(c.length - 1, b || 0 | a._getFPS()), 1e3 / ((c[0] - c[b]) / b))
    }, a.getTime = function(b) {
      return a._startTime ? a._getTime() - (b ? a._pausedTime : 0) : -1
    }, a.getEventTime = function(b) {
      return a._startTime ? (a._lastTime || a._startTime) - (b ? a._pausedTime : 0) : -1
    }, a.getTicks = function(b) {
      return a._ticks - (b ? a._pausedTicks : 0)
    }, a._handleSynch = function() {
      a._timerId = null, a._setupTick(), a._getTime() - a._lastTime >= .97 * (a._interval - 1) && a._tick()
    }, a._handleRAF = function() {
      a._timerId = null, a._setupTick(), a._tick()
    }, a._handleTimeout = function() {
      a._timerId = null, a._setupTick(), a._tick()
    }, a._setupTick = function() {
      if (null == a._timerId) {
        var b = a.timingMode;
        if (b == a.RAF_SYNCHED || b == a.RAF) {
          var c = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame;
          if (c) return a._timerId = c(b == a.RAF ? a._handleRAF : a._handleSynch), void(a._raf = !0)
        }
        a._raf = !1, a._timerId = setTimeout(a._handleTimeout, a._interval)
      }
    }, a._tick = function() {
      var b = a.paused,
        c = a._getTime(),
        d = c - a._lastTime;
      if (a._lastTime = c, a._ticks++, b && (a._pausedTicks++, a._pausedTime += d), a.hasEventListener("tick")) {
        var e = new createjs.Event("tick"),
          f = a.maxDelta;
        e.delta = f && d > f ? f : d, e.paused = b, e.time = c, e.runTime = c - a._pausedTime, a.dispatchEvent(e)
      }
      for (a._tickTimes.unshift(a._getTime() - c); a._tickTimes.length > 100;) a._tickTimes.pop();
      for (a._times.unshift(c); a._times.length > 100;) a._times.pop()
    };
    var c = window,
      d = c.performance.now || c.performance.mozNow || c.performance.msNow || c.performance.oNow || c.performance.webkitNow;
    a._getTime = function() {
      return (d && d.call(c.performance) || (new Date).getTime()) - a._startTime
    }, createjs.Ticker = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.readyState = a.readyState, this._video = a, this._canvas = null, this._lastTime = -1, this.readyState < 2 && a.addEventListener("canplaythrough", this._videoReady.bind(this))
    }
    var b = a.prototype;
    b.getImage = function() {
      if (!(this.readyState < 2)) {
        var a = this._canvas,
          b = this._video;
        if (a || (a = this._canvas = createjs.createCanvas ? createjs.createCanvas() : document.createElement("canvas"), a.width = b.videoWidth, a.height = b.videoHeight), b.readyState >= 2 && b.currentTime !== this._lastTime) {
          var c = a.getContext("2d");
          c.clearRect(0, 0, a.width, a.height), c.drawImage(b, 0, 0, a.width, a.height), this._lastTime = b.currentTime
        }
        return a
      }
    }, b._videoReady = function() {
      this.readyState = 2
    }, createjs.VideoBuffer = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c, d, e, f, g, h, i, j, k) {
      this.Event_constructor(a, b, c), this.stageX = d, this.stageY = e, this.rawX = null == i ? d : i, this.rawY = null == j ? e : j, this.nativeEvent = f, this.pointerID = g, this.primary = !!h, this.relatedTarget = k
    }
    var b = createjs.extend(a, createjs.Event);
    b._get_localX = function() {
      return this.currentTarget.globalToLocal(this.rawX, this.rawY).x
    }, b._get_localY = function() {
      return this.currentTarget.globalToLocal(this.rawX, this.rawY).y
    }, b._get_isTouch = function() {
      return -1 !== this.pointerID
    };
    try {
      Object.defineProperties(b, {
        localX: {
          get: b._get_localX
        },
        localY: {
          get: b._get_localY
        },
        isTouch: {
          get: b._get_isTouch
        }
      })
    } catch (c) {}
    b.clone = function() {
      return new a(this.type, this.bubbles, this.cancelable, this.stageX, this.stageY, this.nativeEvent, this.pointerID, this.primary, this.rawX, this.rawY)
    }, b.toString = function() {
      return "[MouseEvent (type=" + this.type + " stageX=" + this.stageX + " stageY=" + this.stageY + ")]"
    }, createjs.MouseEvent = createjs.promote(a, "Event")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c, d, e, f) {
      this.setValues(a, b, c, d, e, f)
    }
    var b = a.prototype;
    a.DEG_TO_RAD = Math.PI / 180, a.identity = null, b.setValues = function(a, b, c, d, e, f) {
      return this.a = null == a ? 1 : a, this.b = b || 0, this.c = c || 0, this.d = null == d ? 1 : d, this.tx = e || 0, this.ty = f || 0, this
    }, b.append = function(a, b, c, d, e, f) {
      var g = this.a,
        h = this.b,
        i = this.c,
        j = this.d;
      return (1 != a || 0 != b || 0 != c || 1 != d) && (this.a = g * a + i * b, this.b = h * a + j * b, this.c = g * c + i * d, this.d = h * c + j * d), this.tx = g * e + i * f + this.tx, this.ty = h * e + j * f + this.ty, this
    }, b.prepend = function(a, b, c, d, e, f) {
      var g = this.a,
        h = this.c,
        i = this.tx;
      return this.a = a * g + c * this.b, this.b = b * g + d * this.b, this.c = a * h + c * this.d, this.d = b * h + d * this.d, this.tx = a * i + c * this.ty + e, this.ty = b * i + d * this.ty + f, this
    }, b.appendMatrix = function(a) {
      return this.append(a.a, a.b, a.c, a.d, a.tx, a.ty)
    }, b.prependMatrix = function(a) {
      return this.prepend(a.a, a.b, a.c, a.d, a.tx, a.ty)
    }, b.appendTransform = function(b, c, d, e, f, g, h, i, j) {
      if (f % 360) var k = f * a.DEG_TO_RAD,
        l = Math.cos(k),
        m = Math.sin(k);
      else l = 1, m = 0;
      return g || h ? (g *= a.DEG_TO_RAD, h *= a.DEG_TO_RAD, this.append(Math.cos(h), Math.sin(h), -Math.sin(g), Math.cos(g), b, c), this.append(l * d, m * d, -m * e, l * e, 0, 0)) : this.append(l * d, m * d, -m * e, l * e, b, c), (i || j) && (this.tx -= i * this.a + j * this.c, this.ty -= i * this.b + j * this.d), this
    }, b.prependTransform = function(b, c, d, e, f, g, h, i, j) {
      if (f % 360) var k = f * a.DEG_TO_RAD,
        l = Math.cos(k),
        m = Math.sin(k);
      else l = 1, m = 0;
      return (i || j) && (this.tx -= i, this.ty -= j), g || h ? (g *= a.DEG_TO_RAD, h *= a.DEG_TO_RAD, this.prepend(l * d, m * d, -m * e, l * e, 0, 0), this.prepend(Math.cos(h), Math.sin(h), -Math.sin(g), Math.cos(g), b, c)) : this.prepend(l * d, m * d, -m * e, l * e, b, c), this
    }, b.rotate = function(b) {
      b *= a.DEG_TO_RAD;
      var c = Math.cos(b),
        d = Math.sin(b),
        e = this.a,
        f = this.b;
      return this.a = e * c + this.c * d, this.b = f * c + this.d * d, this.c = -e * d + this.c * c, this.d = -f * d + this.d * c, this
    }, b.skew = function(b, c) {
      return b *= a.DEG_TO_RAD, c *= a.DEG_TO_RAD, this.append(Math.cos(c), Math.sin(c), -Math.sin(b), Math.cos(b), 0, 0), this
    }, b.scale = function(a, b) {
      return this.a *= a, this.b *= a, this.c *= b, this.d *= b, this
    }, b.translate = function(a, b) {
      return this.tx += this.a * a + this.c * b, this.ty += this.b * a + this.d * b, this
    }, b.identity = function() {
      return this.a = this.d = 1, this.b = this.c = this.tx = this.ty = 0, this
    }, b.invert = function() {
      var a = this.a,
        b = this.b,
        c = this.c,
        d = this.d,
        e = this.tx,
        f = a * d - b * c;
      return this.a = d / f, this.b = -b / f, this.c = -c / f, this.d = a / f, this.tx = (c * this.ty - d * e) / f, this.ty = -(a * this.ty - b * e) / f, this
    }, b.isIdentity = function() {
      return 0 === this.tx && 0 === this.ty && 1 === this.a && 0 === this.b && 0 === this.c && 1 === this.d
    }, b.equals = function(a) {
      return this.tx === a.tx && this.ty === a.ty && this.a === a.a && this.b === a.b && this.c === a.c && this.d === a.d
    }, b.transformPoint = function(a, b, c) {
      return c = c || {}, c.x = a * this.a + b * this.c + this.tx, c.y = a * this.b + b * this.d + this.ty, c
    }, b.decompose = function(b) {
      null == b && (b = {}), b.x = this.tx, b.y = this.ty, b.scaleX = Math.sqrt(this.a * this.a + this.b * this.b), b.scaleY = Math.sqrt(this.c * this.c + this.d * this.d);
      var c = Math.atan2(-this.c, this.d),
        d = Math.atan2(this.b, this.a),
        e = Math.abs(1 - c / d);
      return 1e-5 > e ? (b.rotation = d / a.DEG_TO_RAD, this.a < 0 && this.d >= 0 && (b.rotation += b.rotation <= 0 ? 180 : -180), b.skewX = b.skewY = 0) : (b.skewX = c / a.DEG_TO_RAD, b.skewY = d / a.DEG_TO_RAD), b
    }, b.copy = function(a) {
      return this.setValues(a.a, a.b, a.c, a.d, a.tx, a.ty)
    }, b.clone = function() {
      return new a(this.a, this.b, this.c, this.d, this.tx, this.ty)
    }, b.toString = function() {
      return "[Matrix2D (a=" + this.a + " b=" + this.b + " c=" + this.c + " d=" + this.d + " tx=" + this.tx + " ty=" + this.ty + ")]"
    }, a.identity = new a, createjs.Matrix2D = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c, d, e) {
      this.setValues(a, b, c, d, e)
    }
    var b = a.prototype;
    b.setValues = function(a, b, c, d, e) {
      return this.visible = null == a ? !0 : !!a, this.alpha = null == b ? 1 : b, this.shadow = c, this.compositeOperation = d, this.matrix = e || this.matrix && this.matrix.identity() || new createjs.Matrix2D, this
    }, b.append = function(a, b, c, d, e) {
      return this.alpha *= b, this.shadow = c || this.shadow, this.compositeOperation = d || this.compositeOperation, this.visible = this.visible && a, e && this.matrix.appendMatrix(e), this
    }, b.prepend = function(a, b, c, d, e) {
      return this.alpha *= b, this.shadow = this.shadow || c, this.compositeOperation = this.compositeOperation || d, this.visible = this.visible && a, e && this.matrix.prependMatrix(e), this
    }, b.identity = function() {
      return this.visible = !0, this.alpha = 1, this.shadow = this.compositeOperation = null, this.matrix.identity(), this
    }, b.clone = function() {
      return new a(this.alpha, this.shadow, this.compositeOperation, this.visible, this.matrix.clone())
    }, createjs.DisplayProps = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.setValues(a, b)
    }
    var b = a.prototype;
    b.setValues = function(a, b) {
      return this.x = a || 0, this.y = b || 0, this
    }, b.copy = function(a) {
      return this.x = a.x, this.y = a.y, this
    }, b.clone = function() {
      return new a(this.x, this.y)
    }, b.toString = function() {
      return "[Point (x=" + this.x + " y=" + this.y + ")]"
    }, createjs.Point = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c, d) {
      this.setValues(a, b, c, d)
    }
    var b = a.prototype;
    b.setValues = function(a, b, c, d) {
      return this.x = a || 0, this.y = b || 0, this.width = c || 0, this.height = d || 0, this
    }, b.extend = function(a, b, c, d) {
      return c = c || 0, d = d || 0, a + c > this.x + this.width && (this.width = a + c - this.x), b + d > this.y + this.height && (this.height = b + d - this.y), a < this.x && (this.width += this.x - a, this.x = a), b < this.y && (this.height += this.y - b, this.y = b), this
    }, b.pad = function(a, b, c, d) {
      return this.x -= b, this.y -= a, this.width += b + d, this.height += a + c, this
    }, b.copy = function(a) {
      return this.setValues(a.x, a.y, a.width, a.height)
    }, b.contains = function(a, b, c, d) {
      return c = c || 0, d = d || 0, a >= this.x && a + c <= this.x + this.width && b >= this.y && b + d <= this.y + this.height
    }, b.union = function(a) {
      return this.clone().extend(a.x, a.y, a.width, a.height)
    }, b.intersection = function(b) {
      var c = b.x,
        d = b.y,
        e = c + b.width,
        f = d + b.height;
      return this.x > c && (c = this.x), this.y > d && (d = this.y), this.x + this.width < e && (e = this.x + this.width), this.y + this.height < f && (f = this.y + this.height), c >= e || d >= f ? null : new a(c, d, e - c, f - d)
    }, b.intersects = function(a) {
      return a.x <= this.x + this.width && this.x <= a.x + a.width && a.y <= this.y + this.height && this.y <= a.y + a.height
    }, b.isEmpty = function() {
      return this.width <= 0 || this.height <= 0
    }, b.clone = function() {
      return new a(this.x, this.y, this.width, this.height)
    }, b.toString = function() {
      return "[Rectangle (x=" + this.x + " y=" + this.y + " width=" + this.width + " height=" + this.height + ")]"
    }, createjs.Rectangle = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c, d, e, f, g) {
      a.addEventListener && (this.target = a, this.overLabel = null == c ? "over" : c, this.outLabel = null == b ? "out" : b, this.downLabel = null == d ? "down" : d, this.play = e, this._isPressed = !1, this._isOver = !1, this._enabled = !1, a.mouseChildren = !1, this.enabled = !0, this.handleEvent({}), f && (g && (f.actionsEnabled = !1, f.gotoAndStop && f.gotoAndStop(g)), a.hitArea = f))
    }
    var b = a.prototype;
    b._setEnabled = function(a) {
      if (a != this._enabled) {
        var b = this.target;
        this._enabled = a, a ? (b.cursor = "pointer", b.addEventListener("rollover", this), b.addEventListener("rollout", this), b.addEventListener("mousedown", this), b.addEventListener("pressup", this), b._reset && (b.__reset = b._reset, b._reset = this._reset)) : (b.cursor = null, b.removeEventListener("rollover", this), b.removeEventListener("rollout", this), b.removeEventListener("mousedown", this), b.removeEventListener("pressup", this), b.__reset && (b._reset = b.__reset, delete b.__reset))
      }
    }, b.setEnabled = createjs.deprecate(b._setEnabled, "ButtonHelper.setEnabled"), b._getEnabled = function() {
      return this._enabled
    }, b.getEnabled = createjs.deprecate(b._getEnabled, "ButtonHelper.getEnabled");
    try {
      Object.defineProperties(b, {
        enabled: {
          get: b._getEnabled,
          set: b._setEnabled
        }
      })
    } catch (c) {}
    b.toString = function() {
      return "[ButtonHelper]"
    }, b.handleEvent = function(a) {
      var b, c = this.target,
        d = a.type;
      "mousedown" == d ? (this._isPressed = !0, b = this.downLabel) : "pressup" == d ? (this._isPressed = !1, b = this._isOver ? this.overLabel : this.outLabel) : "rollover" == d ? (this._isOver = !0, b = this._isPressed ? this.downLabel : this.overLabel) : (this._isOver = !1, b = this._isPressed ? this.overLabel : this.outLabel), this.play ? c.gotoAndPlay && c.gotoAndPlay(b) : c.gotoAndStop && c.gotoAndStop(b)
    }, b._reset = function() {
      var a = this.paused;
      this.__reset(), this.paused = a
    }, createjs.ButtonHelper = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c, d) {
      this.color = a || "black", this.offsetX = b || 0, this.offsetY = c || 0, this.blur = d || 0
    }
    var b = a.prototype;
    a.identity = new a("transparent", 0, 0, 0), b.toString = function() {
      return "[Shadow]"
    }, b.clone = function() {
      return new a(this.color, this.offsetX, this.offsetY, this.blur)
    }, createjs.Shadow = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.EventDispatcher_constructor(), this.complete = !0, this.framerate = 0, this._animations = null, this._frames = null, this._images = null, this._data = null, this._loadCount = 0, this._frameHeight = 0, this._frameWidth = 0, this._numFrames = 0, this._regX = 0, this._regY = 0, this._spacing = 0, this._margin = 0, this._parseData(a)
    }
    var b = createjs.extend(a, createjs.EventDispatcher);
    b._getAnimations = function() {
      return this._animations.slice()
    }, b.getAnimations = createjs.deprecate(b._getAnimations, "SpriteSheet.getAnimations");
    try {
      Object.defineProperties(b, {
        animations: {
          get: b._getAnimations
        }
      })
    } catch (c) {}
    b.getNumFrames = function(a) {
      if (null == a) return this._frames ? this._frames.length : this._numFrames || 0;
      var b = this._data[a];
      return null == b ? 0 : b.frames.length
    }, b.getAnimation = function(a) {
      return this._data[a]
    }, b.getFrame = function(a) {
      var b;
      return this._frames && (b = this._frames[a]) ? b : null
    }, b.getFrameBounds = function(a, b) {
      var c = this.getFrame(a);
      return c ? (b || new createjs.Rectangle).setValues(-c.regX, -c.regY, c.rect.width, c.rect.height) : null
    }, b.toString = function() {
      return "[SpriteSheet]"
    }, b.clone = function() {
      throw "SpriteSheet cannot be cloned."
    }, b._parseData = function(a) {
      var b, c, d, e;
      if (null != a) {
        if (this.framerate = a.framerate || 0, a.images && (c = a.images.length) > 0)
          for (e = this._images = [], b = 0; c > b; b++) {
            var f = a.images[b];
            if ("string" == typeof f) {
              var g = f;
              f = document.createElement("img"), f.src = g
            }
            e.push(f), f.getContext || f.naturalWidth || (this._loadCount++, this.complete = !1, function(a, b) {
              f.onload = function() {
                a._handleImageLoad(b)
              }
            }(this, g), function(a, b) {
              f.onerror = function() {
                a._handleImageError(b)
              }
            }(this, g))
          }
        if (null == a.frames);
        else if (Array.isArray(a.frames))
          for (this._frames = [], e = a.frames, b = 0, c = e.length; c > b; b++) {
            var h = e[b];
            this._frames.push({
              image: this._images[h[4] ? h[4] : 0],
              rect: new createjs.Rectangle(h[0], h[1], h[2], h[3]),
              regX: h[5] || 0,
              regY: h[6] || 0
            })
          } else d = a.frames, this._frameWidth = d.width, this._frameHeight = d.height, this._regX = d.regX || 0, this._regY = d.regY || 0, this._spacing = d.spacing || 0, this._margin = d.margin || 0, this._numFrames = d.count, 0 == this._loadCount && this._calculateFrames();
        if (this._animations = [], null != (d = a.animations)) {
          this._data = {};
          var i;
          for (i in d) {
            var j = {
                name: i
              },
              k = d[i];
            if ("number" == typeof k) e = j.frames = [k];
            else if (Array.isArray(k))
              if (1 == k.length) j.frames = [k[0]];
              else
                for (j.speed = k[3], j.next = k[2], e = j.frames = [], b = k[0]; b <= k[1]; b++) e.push(b);
            else {
              j.speed = k.speed, j.next = k.next;
              var l = k.frames;
              e = j.frames = "number" == typeof l ? [l] : l.slice(0)
            }(j.next === !0 || void 0 === j.next) && (j.next = i), (j.next === !1 || e.length < 2 && j.next == i) && (j.next = null), j.speed || (j.speed = 1), this._animations.push(i), this._data[i] = j
          }
        }
      }
    }, b._handleImageLoad = function(a) {
      0 == --this._loadCount && (this._calculateFrames(), this.complete = !0, this.dispatchEvent("complete"))
    }, b._handleImageError = function(a) {
      var b = new createjs.Event("error");
      b.src = a, this.dispatchEvent(b), 0 == --this._loadCount && this.dispatchEvent("complete")
    }, b._calculateFrames = function() {
      if (!this._frames && 0 != this._frameWidth) {
        this._frames = [];
        var a = this._numFrames || 1e5,
          b = 0,
          c = this._frameWidth,
          d = this._frameHeight,
          e = this._spacing,
          f = this._margin;
        a: for (var g = 0, h = this._images; g < h.length; g++)
          for (var i = h[g], j = i.width || i.naturalWidth, k = i.height || i.naturalHeight, l = f; k - f - d >= l;) {
            for (var m = f; j - f - c >= m;) {
              if (b >= a) break a;
              b++, this._frames.push({
                image: i,
                rect: new createjs.Rectangle(m, l, c, d),
                regX: this._regX,
                regY: this._regY
              }), m += c + e
            }
            l += d + e
          }
        this._numFrames = b
      }
    }, createjs.SpriteSheet = createjs.promote(a, "EventDispatcher")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      this.command = null, this._stroke = null, this._strokeStyle = null, this._oldStrokeStyle = null, this._strokeDash = null, this._oldStrokeDash = null, this._strokeIgnoreScale = !1, this._fill = null, this._instructions = [], this._commitIndex = 0, this._activeInstructions = [], this._dirty = !1, this._storeIndex = 0, this.clear()
    }
    var b = a.prototype,
      c = a;
    a.getRGB = function(a, b, c, d) {
      return null != a && null == c && (d = b, c = 255 & a, b = a >> 8 & 255, a = a >> 16 & 255), null == d ? "rgb(" + a + "," + b + "," + c + ")" : "rgba(" + a + "," + b + "," + c + "," + d + ")"
    }, a.getHSL = function(a, b, c, d) {
      return null == d ? "hsl(" + a % 360 + "," + b + "%," + c + "%)" : "hsla(" + a % 360 + "," + b + "%," + c + "%," + d + ")"
    }, a.BASE_64 = {
      A: 0,
      B: 1,
      C: 2,
      D: 3,
      E: 4,
      F: 5,
      G: 6,
      H: 7,
      I: 8,
      J: 9,
      K: 10,
      L: 11,
      M: 12,
      N: 13,
      O: 14,
      P: 15,
      Q: 16,
      R: 17,
      S: 18,
      T: 19,
      U: 20,
      V: 21,
      W: 22,
      X: 23,
      Y: 24,
      Z: 25,
      a: 26,
      b: 27,
      c: 28,
      d: 29,
      e: 30,
      f: 31,
      g: 32,
      h: 33,
      i: 34,
      j: 35,
      k: 36,
      l: 37,
      m: 38,
      n: 39,
      o: 40,
      p: 41,
      q: 42,
      r: 43,
      s: 44,
      t: 45,
      u: 46,
      v: 47,
      w: 48,
      x: 49,
      y: 50,
      z: 51,
      0: 52,
      1: 53,
      2: 54,
      3: 55,
      4: 56,
      5: 57,
      6: 58,
      7: 59,
      8: 60,
      9: 61,
      "+": 62,
      "/": 63
    }, a.STROKE_CAPS_MAP = ["butt", "round", "square"], a.STROKE_JOINTS_MAP = ["miter", "round", "bevel"];
    var d = createjs.createCanvas ? createjs.createCanvas() : document.createElement("canvas");
    d.getContext && (a._ctx = d.getContext("2d"), d.width = d.height = 1), b._getInstructions = function() {
      return this._updateInstructions(), this._instructions
    }, b.getInstructions = createjs.deprecate(b._getInstructions, "Graphics.getInstructions");
    try {
      Object.defineProperties(b, {
        instructions: {
          get: b._getInstructions
        }
      })
    } catch (e) {}
    b.isEmpty = function() {
      return !(this._instructions.length || this._activeInstructions.length)
    }, b.draw = function(a, b) {
      this._updateInstructions();
      for (var c = this._instructions, d = this._storeIndex, e = c.length; e > d; d++) c[d].exec(a, b)
    }, b.drawAsPath = function(a) {
      this._updateInstructions();
      for (var b, c = this._instructions, d = this._storeIndex, e = c.length; e > d; d++)(b = c[d]).path !== !1 && b.exec(a)
    }, b.moveTo = function(a, b) {
      return this.append(new c.MoveTo(a, b), !0)
    }, b.lineTo = function(a, b) {
      return this.append(new c.LineTo(a, b))
    }, b.arcTo = function(a, b, d, e, f) {
      return this.append(new c.ArcTo(a, b, d, e, f))
    }, b.arc = function(a, b, d, e, f, g) {
      return this.append(new c.Arc(a, b, d, e, f, g))
    }, b.quadraticCurveTo = function(a, b, d, e) {
      return this.append(new c.QuadraticCurveTo(a, b, d, e))
    }, b.bezierCurveTo = function(a, b, d, e, f, g) {
      return this.append(new c.BezierCurveTo(a, b, d, e, f, g))
    }, b.rect = function(a, b, d, e) {
      return this.append(new c.Rect(a, b, d, e))
    }, b.closePath = function() {
      return this._activeInstructions.length ? this.append(new c.ClosePath) : this
    }, b.clear = function() {
      return this._instructions.length = this._activeInstructions.length = this._commitIndex = 0, this._strokeStyle = this._oldStrokeStyle = this._stroke = this._fill = this._strokeDash = this._oldStrokeDash = null, this._dirty = this._strokeIgnoreScale = !1, this
    }, b.beginFill = function(a) {
      return this._setFill(a ? new c.Fill(a) : null)
    }, b.beginLinearGradientFill = function(a, b, d, e, f, g) {
      return this._setFill((new c.Fill).linearGradient(a, b, d, e, f, g))
    }, b.beginRadialGradientFill = function(a, b, d, e, f, g, h, i) {
      return this._setFill((new c.Fill).radialGradient(a, b, d, e, f, g, h, i))
    }, b.beginBitmapFill = function(a, b, d) {
      return this._setFill(new c.Fill(null, d).bitmap(a, b))
    }, b.endFill = function() {
      return this.beginFill()
    }, b.setStrokeStyle = function(a, b, d, e, f) {
      return this._updateInstructions(!0), this._strokeStyle = this.command = new c.StrokeStyle(a, b, d, e, f), this._stroke && (this._stroke.ignoreScale = f), this._strokeIgnoreScale = f, this
    }, b.setStrokeDash = function(a, b) {
      return this._updateInstructions(!0), this._strokeDash = this.command = new c.StrokeDash(a, b), this
    }, b.beginStroke = function(a) {
      return this._setStroke(a ? new c.Stroke(a) : null)
    }, b.beginLinearGradientStroke = function(a, b, d, e, f, g) {
      return this._setStroke((new c.Stroke).linearGradient(a, b, d, e, f, g))
    }, b.beginRadialGradientStroke = function(a, b, d, e, f, g, h, i) {
      return this._setStroke((new c.Stroke).radialGradient(a, b, d, e, f, g, h, i))
    }, b.beginBitmapStroke = function(a, b) {
      return this._setStroke((new c.Stroke).bitmap(a, b))
    }, b.endStroke = function() {
      return this.beginStroke()
    }, b.curveTo = b.quadraticCurveTo, b.drawRect = b.rect, b.drawRoundRect = function(a, b, c, d, e) {
      return this.drawRoundRectComplex(a, b, c, d, e, e, e, e)
    }, b.drawRoundRectComplex = function(a, b, d, e, f, g, h, i) {
      return this.append(new c.RoundRect(a, b, d, e, f, g, h, i))
    }, b.drawCircle = function(a, b, d) {
      return this.append(new c.Circle(a, b, d))
    }, b.drawEllipse = function(a, b, d, e) {
      return this.append(new c.Ellipse(a, b, d, e))
    }, b.drawPolyStar = function(a, b, d, e, f, g) {
      return this.append(new c.PolyStar(a, b, d, e, f, g))
    }, b.append = function(a, b) {
      return this._activeInstructions.push(a), this.command = a, b || (this._dirty = !0), this
    }, b.decodePath = function(b) {
      for (var c = [this.moveTo, this.lineTo, this.quadraticCurveTo, this.bezierCurveTo, this.closePath], d = [2, 2, 4, 6, 0], e = 0, f = b.length, g = [], h = 0, i = 0, j = a.BASE_64; f > e;) {
        var k = b.charAt(e),
          l = j[k],
          m = l >> 3,
          n = c[m];
        if (!n || 3 & l) throw "bad path data (@" + e + "): " + k;
        var o = d[m];
        m || (h = i = 0), g.length = 0, e++;
        for (var p = (l >> 2 & 1) + 2, q = 0; o > q; q++) {
          var r = j[b.charAt(e)],
            s = r >> 5 ? -1 : 1;
          r = (31 & r) << 6 | j[b.charAt(e + 1)], 3 == p && (r = r << 6 | j[b.charAt(e + 2)]), r = s * r / 10, q % 2 ? h = r += h : i = r += i, g[q] = r, e += p
        }
        n.apply(this, g)
      }
      return this
    }, b.store = function() {
      return this._updateInstructions(!0), this._storeIndex = this._instructions.length, this
    }, b.unstore = function() {
      return this._storeIndex = 0, this
    }, b.clone = function() {
      var b = new a;
      return b.command = this.command, b._stroke = this._stroke, b._strokeStyle = this._strokeStyle, b._strokeDash = this._strokeDash, b._strokeIgnoreScale = this._strokeIgnoreScale, b._fill = this._fill, b._instructions = this._instructions.slice(), b._commitIndex = this._commitIndex, b._activeInstructions = this._activeInstructions.slice(), b._dirty = this._dirty, b._storeIndex = this._storeIndex, b
    }, b.toString = function() {
      return "[Graphics]"
    }, b.mt = b.moveTo, b.lt = b.lineTo, b.at = b.arcTo, b.bt = b.bezierCurveTo, b.qt = b.quadraticCurveTo, b.a = b.arc, b.r = b.rect, b.cp = b.closePath, b.c = b.clear, b.f = b.beginFill, b.lf = b.beginLinearGradientFill, b.rf = b.beginRadialGradientFill, b.bf = b.beginBitmapFill, b.ef = b.endFill, b.ss = b.setStrokeStyle, b.sd = b.setStrokeDash, b.s = b.beginStroke, b.ls = b.beginLinearGradientStroke, b.rs = b.beginRadialGradientStroke, b.bs = b.beginBitmapStroke, b.es = b.endStroke, b.dr = b.drawRect, b.rr = b.drawRoundRect, b.rc = b.drawRoundRectComplex, b.dc = b.drawCircle, b.de = b.drawEllipse, b.dp = b.drawPolyStar, b.p = b.decodePath, b._updateInstructions = function(b) {
      var c = this._instructions,
        d = this._activeInstructions,
        e = this._commitIndex;
      if (this._dirty && d.length) {
        c.length = e, c.push(a.beginCmd);
        var f = d.length,
          g = c.length;
        c.length = g + f;
        for (var h = 0; f > h; h++) c[h + g] = d[h];
        this._fill && c.push(this._fill), this._stroke && (this._strokeDash !== this._oldStrokeDash && c.push(this._strokeDash), this._strokeStyle !== this._oldStrokeStyle && c.push(this._strokeStyle), b && (this._oldStrokeStyle = this._strokeStyle, this._oldStrokeDash = this._strokeDash), c.push(this._stroke)), this._dirty = !1
      }
      b && (d.length = 0, this._commitIndex = c.length)
    }, b._setFill = function(a) {
      return this._updateInstructions(!0), this.command = this._fill = a, this
    }, b._setStroke = function(a) {
      return this._updateInstructions(!0), (this.command = this._stroke = a) && (a.ignoreScale = this._strokeIgnoreScale), this
    }, (c.LineTo = function(a, b) {
      this.x = a, this.y = b
    }).prototype.exec = function(a) {
      a.lineTo(this.x, this.y)
    }, (c.MoveTo = function(a, b) {
      this.x = a, this.y = b
    }).prototype.exec = function(a) {
      a.moveTo(this.x, this.y)
    }, (c.ArcTo = function(a, b, c, d, e) {
      this.x1 = a, this.y1 = b, this.x2 = c, this.y2 = d, this.radius = e
    }).prototype.exec = function(a) {
      a.arcTo(this.x1, this.y1, this.x2, this.y2, this.radius)
    }, (c.Arc = function(a, b, c, d, e, f) {
      this.x = a, this.y = b, this.radius = c, this.startAngle = d, this.endAngle = e, this.anticlockwise = !!f
    }).prototype.exec = function(a) {
      a.arc(this.x, this.y, this.radius, this.startAngle, this.endAngle, this.anticlockwise)
    }, (c.QuadraticCurveTo = function(a, b, c, d) {
      this.cpx = a, this.cpy = b, this.x = c, this.y = d
    }).prototype.exec = function(a) {
      a.quadraticCurveTo(this.cpx, this.cpy, this.x, this.y)
    }, (c.BezierCurveTo = function(a, b, c, d, e, f) {
      this.cp1x = a, this.cp1y = b, this.cp2x = c, this.cp2y = d, this.x = e, this.y = f
    }).prototype.exec = function(a) {
      a.bezierCurveTo(this.cp1x, this.cp1y, this.cp2x, this.cp2y, this.x, this.y)
    }, (c.Rect = function(a, b, c, d) {
      this.x = a, this.y = b, this.w = c, this.h = d
    }).prototype.exec = function(a) {
      a.rect(this.x, this.y, this.w, this.h)
    }, (c.ClosePath = function() {}).prototype.exec = function(a) {
      a.closePath()
    }, (c.BeginPath = function() {}).prototype.exec = function(a) {
      a.beginPath()
    }, b = (c.Fill = function(a, b) {
      this.style = a, this.matrix = b
    }).prototype, b.exec = function(a) {
      if (this.style) {
        a.fillStyle = this.style;
        var b = this.matrix;
        b && (a.save(), a.transform(b.a, b.b, b.c, b.d, b.tx, b.ty)), a.fill(), b && a.restore()
      }
    }, b.linearGradient = function(b, c, d, e, f, g) {
      for (var h = this.style = a._ctx.createLinearGradient(d, e, f, g), i = 0, j = b.length; j > i; i++) h.addColorStop(c[i], b[i]);
      return h.props = {
        colors: b,
        ratios: c,
        x0: d,
        y0: e,
        x1: f,
        y1: g,
        type: "linear"
      }, this
    }, b.radialGradient = function(b, c, d, e, f, g, h, i) {
      for (var j = this.style = a._ctx.createRadialGradient(d, e, f, g, h, i), k = 0, l = b.length; l > k; k++) j.addColorStop(c[k], b[k]);
      return j.props = {
        colors: b,
        ratios: c,
        x0: d,
        y0: e,
        r0: f,
        x1: g,
        y1: h,
        r1: i,
        type: "radial"
      }, this
    }, b.bitmap = function(b, c) {
      if (b.naturalWidth || b.getContext || b.readyState >= 2) {
        var d = this.style = a._ctx.createPattern(b, c || "");
        d.props = {
          image: b,
          repetition: c,
          type: "bitmap"
        }
      }
      return this
    }, b.path = !1, b = (c.Stroke = function(a, b) {
      this.style = a, this.ignoreScale = b
    }).prototype, b.exec = function(a) {
      this.style && (a.strokeStyle = this.style, this.ignoreScale && (a.save(), a.setTransform(1, 0, 0, 1, 0, 0)), a.stroke(), this.ignoreScale && a.restore())
    }, b.linearGradient = c.Fill.prototype.linearGradient, b.radialGradient = c.Fill.prototype.radialGradient, b.bitmap = c.Fill.prototype.bitmap, b.path = !1, b = (c.StrokeStyle = function(a, b, c, d, e) {
      this.width = a, this.caps = b, this.joints = c, this.miterLimit = d, this.ignoreScale = e
    }).prototype, b.exec = function(b) {
      b.lineWidth = null == this.width ? "1" : this.width, b.lineCap = null == this.caps ? "butt" : isNaN(this.caps) ? this.caps : a.STROKE_CAPS_MAP[this.caps], b.lineJoin = null == this.joints ? "miter" : isNaN(this.joints) ? this.joints : a.STROKE_JOINTS_MAP[this.joints], b.miterLimit = null == this.miterLimit ? "10" : this.miterLimit, b.ignoreScale = null == this.ignoreScale ? !1 : this.ignoreScale
    }, b.path = !1, (c.StrokeDash = function(a, b) {
      this.segments = a, this.offset = b || 0
    }).prototype.exec = function(a) {
      a.setLineDash && (a.setLineDash(this.segments || c.StrokeDash.EMPTY_SEGMENTS), a.lineDashOffset = this.offset || 0)
    }, c.StrokeDash.EMPTY_SEGMENTS = [], (c.RoundRect = function(a, b, c, d, e, f, g, h) {
      this.x = a, this.y = b, this.w = c, this.h = d, this.radiusTL = e, this.radiusTR = f, this.radiusBR = g, this.radiusBL = h
    }).prototype.exec = function(a) {
      var b = (j > i ? i : j) / 2,
        c = 0,
        d = 0,
        e = 0,
        f = 0,
        g = this.x,
        h = this.y,
        i = this.w,
        j = this.h,
        k = this.radiusTL,
        l = this.radiusTR,
        m = this.radiusBR,
        n = this.radiusBL;
      0 > k && (k *= c = -1), k > b && (k = b), 0 > l && (l *= d = -1), l > b && (l = b), 0 > m && (m *= e = -1), m > b && (m = b), 0 > n && (n *= f = -1), n > b && (n = b), a.moveTo(g + i - l, h), a.arcTo(g + i + l * d, h - l * d, g + i, h + l, l), a.lineTo(g + i, h + j - m), a.arcTo(g + i + m * e, h + j + m * e, g + i - m, h + j, m), a.lineTo(g + n, h + j), a.arcTo(g - n * f, h + j + n * f, g, h + j - n, n), a.lineTo(g, h + k), a.arcTo(g - k * c, h - k * c, g + k, h, k), a.closePath()
    }, (c.Circle = function(a, b, c) {
      this.x = a, this.y = b, this.radius = c
    }).prototype.exec = function(a) {
      a.arc(this.x, this.y, this.radius, 0, 2 * Math.PI)
    }, (c.Ellipse = function(a, b, c, d) {
      this.x = a, this.y = b, this.w = c, this.h = d
    }).prototype.exec = function(a) {
      var b = this.x,
        c = this.y,
        d = this.w,
        e = this.h,
        f = .5522848,
        g = d / 2 * f,
        h = e / 2 * f,
        i = b + d,
        j = c + e,
        k = b + d / 2,
        l = c + e / 2;
      a.moveTo(b, l), a.bezierCurveTo(b, l - h, k - g, c, k, c), a.bezierCurveTo(k + g, c, i, l - h, i, l), a.bezierCurveTo(i, l + h, k + g, j, k, j), a.bezierCurveTo(k - g, j, b, l + h, b, l)
    }, (c.PolyStar = function(a, b, c, d, e, f) {
      this.x = a, this.y = b, this.radius = c, this.sides = d, this.pointSize = e, this.angle = f
    }).prototype.exec = function(a) {
      var b = this.x,
        c = this.y,
        d = this.radius,
        e = (this.angle || 0) / 180 * Math.PI,
        f = this.sides,
        g = 1 - (this.pointSize || 0),
        h = Math.PI / f;
      a.moveTo(b + Math.cos(e) * d, c + Math.sin(e) * d);
      for (var i = 0; f > i; i++) e += h, 1 != g && a.lineTo(b + Math.cos(e) * d * g, c + Math.sin(e) * d * g), e += h, a.lineTo(b + Math.cos(e) * d, c + Math.sin(e) * d);
      a.closePath()
    }, a.beginCmd = new c.BeginPath, createjs.Graphics = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      this.EventDispatcher_constructor(), this.alpha = 1, this.cacheCanvas = null, this.bitmapCache = null, this.id = createjs.UID.get(), this.mouseEnabled = !0, this.tickEnabled = !0, this.name = null, this.parent = null, this.regX = 0, this.regY = 0, this.rotation = 0, this.scaleX = 1, this.scaleY = 1, this.skewX = 0, this.skewY = 0, this.shadow = null, this.visible = !0, this.x = 0, this.y = 0, this.transformMatrix = null, this.compositeOperation = null, this.snapToPixel = !0, this.filters = null, this.mask = null, this.hitArea = null, this.cursor = null, this._props = new createjs.DisplayProps, this._rectangle = new createjs.Rectangle, this._bounds = null, this._webGLRenderStyle = a._StageGL_NONE
    }
    var b = createjs.extend(a, createjs.EventDispatcher);
    a._MOUSE_EVENTS = ["click", "dblclick", "mousedown", "mouseout", "mouseover", "pressmove", "pressup", "rollout", "rollover"], a.suppressCrossDomainErrors = !1, a._snapToPixelEnabled = !1, a._StageGL_NONE = 0, a._StageGL_SPRITE = 1, a._StageGL_BITMAP = 2;
    var c = createjs.createCanvas ? createjs.createCanvas() : document.createElement("canvas");
    c.getContext && (a._hitTestCanvas = c, a._hitTestContext = c.getContext("2d"), c.width = c.height = 1), b._getStage = function() {
      for (var a = this, b = createjs.Stage; a.parent;) a = a.parent;
      return a instanceof b ? a : null
    }, b.getStage = createjs.deprecate(b._getStage, "DisplayObject.getStage");
    try {
      Object.defineProperties(b, {
        stage: {
          get: b._getStage
        },
        cacheID: {
          get: function() {
            return this.bitmapCache && this.bitmapCache.cacheID
          },
          set: function(a) {
            this.bitmapCache && (this.bitmapCache.cacheID = a)
          }
        },
        scale: {
          get: function() {
            return this.scaleX
          },
          set: function(a) {
            this.scaleX = this.scaleY = a
          }
        }
      })
    } catch (d) {}
    b.isVisible = function() {
      return !!(this.visible && this.alpha > 0 && 0 != this.scaleX && 0 != this.scaleY)
    }, b.draw = function(a, b) {
      var c = this.bitmapCache;
      return c && !b ? c.draw(a) : !1
    }, b.updateContext = function(b) {
      var c = this,
        d = c.mask,
        e = c._props.matrix;
      d && d.graphics && !d.graphics.isEmpty() && (d.getMatrix(e), b.transform(e.a, e.b, e.c, e.d, e.tx, e.ty), d.graphics.drawAsPath(b), b.clip(), e.invert(), b.transform(e.a, e.b, e.c, e.d, e.tx, e.ty)), this.getMatrix(e);
      var f = e.tx,
        g = e.ty;
      a._snapToPixelEnabled && c.snapToPixel && (f = f + (0 > f ? -.5 : .5) | 0, g = g + (0 > g ? -.5 : .5) | 0), b.transform(e.a, e.b, e.c, e.d, f, g), b.globalAlpha *= c.alpha, c.compositeOperation && (b.globalCompositeOperation = c.compositeOperation), c.shadow && this._applyShadow(b, c.shadow)
    }, b.cache = function(a, b, c, d, e, f) {
      this.bitmapCache || (this.bitmapCache = new createjs.BitmapCache), this.bitmapCache.define(this, a, b, c, d, e, f)
    }, b.updateCache = function(a) {
      if (!this.bitmapCache) throw "cache() must be called before updateCache()";
      this.bitmapCache.update(a)
    }, b.uncache = function() {
      this.bitmapCache && (this.bitmapCache.release(), this.bitmapCache = void 0)
    }, b.getCacheDataURL = function() {
      return this.bitmapCache ? this.bitmapCache.getDataURL() : null
    }, b.localToGlobal = function(a, b, c) {
      return this.getConcatenatedMatrix(this._props.matrix).transformPoint(a, b, c || new createjs.Point)
    }, b.globalToLocal = function(a, b, c) {
      return this.getConcatenatedMatrix(this._props.matrix).invert().transformPoint(a, b, c || new createjs.Point)
    }, b.localToLocal = function(a, b, c, d) {
      return d = this.localToGlobal(a, b, d), c.globalToLocal(d.x, d.y, d)
    }, b.setTransform = function(a, b, c, d, e, f, g, h, i) {
      return this.x = a || 0, this.y = b || 0, this.scaleX = null == c ? 1 : c, this.scaleY = null == d ? 1 : d, this.rotation = e || 0, this.skewX = f || 0, this.skewY = g || 0, this.regX = h || 0, this.regY = i || 0, this
    }, b.getMatrix = function(a) {
      var b = this,
        c = a && a.identity() || new createjs.Matrix2D;
      return b.transformMatrix ? c.copy(b.transformMatrix) : c.appendTransform(b.x, b.y, b.scaleX, b.scaleY, b.rotation, b.skewX, b.skewY, b.regX, b.regY)
    }, b.getConcatenatedMatrix = function(a) {
      for (var b = this, c = this.getMatrix(a); b = b.parent;) c.prependMatrix(b.getMatrix(b._props.matrix));
      return c
    }, b.getConcatenatedDisplayProps = function(a) {
      a = a ? a.identity() : new createjs.DisplayProps;
      var b = this,
        c = b.getMatrix(a.matrix);
      do a.prepend(b.visible, b.alpha, b.shadow, b.compositeOperation), b != this && c.prependMatrix(b.getMatrix(b._props.matrix)); while (b = b.parent);
      return a
    }, b.hitTest = function(b, c) {
      var d = a._hitTestContext;
      d.setTransform(1, 0, 0, 1, -b, -c), this.draw(d);
      var e = this._testHit(d);
      return d.setTransform(1, 0, 0, 1, 0, 0), d.clearRect(0, 0, 2, 2), e
    }, b.set = function(a) {
      for (var b in a) this[b] = a[b];
      return this
    }, b.getBounds = function() {
      if (this._bounds) return this._rectangle.copy(this._bounds);
      var a = this.cacheCanvas;
      if (a) {
        var b = this._cacheScale;
        return this._rectangle.setValues(this._cacheOffsetX, this._cacheOffsetY, a.width / b, a.height / b)
      }
      return null
    }, b.getTransformedBounds = function() {
      return this._getBounds()
    }, b.setBounds = function(a, b, c, d) {
      return null == a ? void(this._bounds = a) : void(this._bounds = (this._bounds || new createjs.Rectangle).setValues(a, b, c, d))
    }, b.clone = function() {
      return this._cloneProps(new a)
    }, b.toString = function() {
      return "[DisplayObject (name=" + this.name + ")]"
    }, b._updateState = null, b._cloneProps = function(a) {
      return a.alpha = this.alpha, a.mouseEnabled = this.mouseEnabled, a.tickEnabled = this.tickEnabled, a.name = this.name, a.regX = this.regX, a.regY = this.regY, a.rotation = this.rotation, a.scaleX = this.scaleX, a.scaleY = this.scaleY, a.shadow = this.shadow, a.skewX = this.skewX, a.skewY = this.skewY, a.visible = this.visible, a.x = this.x, a.y = this.y, a.compositeOperation = this.compositeOperation, a.snapToPixel = this.snapToPixel, a.filters = null == this.filters ? null : this.filters.slice(0), a.mask = this.mask, a.hitArea = this.hitArea, a.cursor = this.cursor, a._bounds = this._bounds, a
    }, b._applyShadow = function(a, b) {
      b = b || Shadow.identity, a.shadowColor = b.color, a.shadowOffsetX = b.offsetX, a.shadowOffsetY = b.offsetY, a.shadowBlur = b.blur
    }, b._tick = function(a) {
      var b = this._listeners;
      b && b.tick && (a.target = null, a.propagationStopped = a.immediatePropagationStopped = !1, this.dispatchEvent(a))
    }, b._testHit = function(b) {
      try {
        var c = b.getImageData(0, 0, 1, 1).data[3] > 1
      } catch (d) {
        if (!a.suppressCrossDomainErrors) throw "An error has occurred. This is most likely due to security restrictions on reading canvas pixel data with local or cross-domain images."
      }
      return c
    }, b._getBounds = function(a, b) {
      return this._transformBounds(this.getBounds(), a, b)
    }, b._transformBounds = function(a, b, c) {
      if (!a) return a;
      var d = a.x,
        e = a.y,
        f = a.width,
        g = a.height,
        h = this._props.matrix;
      h = c ? h.identity() : this.getMatrix(h), (d || e) && h.appendTransform(0, 0, 1, 1, 0, 0, 0, -d, -e), b && h.prependMatrix(b);
      var i = f * h.a,
        j = f * h.b,
        k = g * h.c,
        l = g * h.d,
        m = h.tx,
        n = h.ty,
        o = m,
        p = m,
        q = n,
        r = n;
      return (d = i + m) < o ? o = d : d > p && (p = d), (d = i + k + m) < o ? o = d : d > p && (p = d), (d = k + m) < o ? o = d : d > p && (p = d), (e = j + n) < q ? q = e : e > r && (r = e), (e = j + l + n) < q ? q = e : e > r && (r = e), (e = l + n) < q ? q = e : e > r && (r = e), a.setValues(o, q, p - o, r - q)
    }, b._hasMouseEventListener = function() {
      for (var b = a._MOUSE_EVENTS, c = 0, d = b.length; d > c; c++)
        if (this.hasEventListener(b[c])) return !0;
      return !!this.cursor
    }, createjs.DisplayObject = createjs.promote(a, "EventDispatcher")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      this.DisplayObject_constructor(), this.children = [], this.mouseChildren = !0, this.tickChildren = !0
    }
    var b = createjs.extend(a, createjs.DisplayObject);
    b._getNumChildren = function() {
      return this.children.length
    }, b.getNumChildren = createjs.deprecate(b._getNumChildren, "Container.getNumChildren");
    try {
      Object.defineProperties(b, {
        numChildren: {
          get: b._getNumChildren
        }
      })
    } catch (c) {}
    b.initialize = a, b.isVisible = function() {
      var a = this.cacheCanvas || this.children.length;
      return !!(this.visible && this.alpha > 0 && 0 != this.scaleX && 0 != this.scaleY && a)
    }, b.draw = function(a, b) {
      if (this.DisplayObject_draw(a, b)) return !0;
      for (var c = this.children.slice(), d = 0, e = c.length; e > d; d++) {
        var f = c[d];
        f.isVisible() && (a.save(), f.updateContext(a), f.draw(a), a.restore())
      }
      return !0
    }, b.addChild = function(a) {
      if (null == a) return a;
      var b = arguments.length;
      if (b > 1) {
        for (var c = 0; b > c; c++) this.addChild(arguments[c]);
        return arguments[b - 1]
      }
      var d = a.parent,
        e = d === this;
      return d && d._removeChildAt(createjs.indexOf(d.children, a), e), a.parent = this, this.children.push(a), e || a.dispatchEvent("added"), a
    }, b.addChildAt = function(a, b) {
      var c = arguments.length,
        d = arguments[c - 1];
      if (0 > d || d > this.children.length) return arguments[c - 2];
      if (c > 2) {
        for (var e = 0; c - 1 > e; e++) this.addChildAt(arguments[e], d + e);
        return arguments[c - 2]
      }
      var f = a.parent,
        g = f === this;
      return f && f._removeChildAt(createjs.indexOf(f.children, a), g), a.parent = this, this.children.splice(b, 0, a), g || a.dispatchEvent("added"), a
    }, b.removeChild = function(a) {
      var b = arguments.length;
      if (b > 1) {
        for (var c = !0, d = 0; b > d; d++) c = c && this.removeChild(arguments[d]);
        return c
      }
      return this._removeChildAt(createjs.indexOf(this.children, a))
    }, b.removeChildAt = function(a) {
      var b = arguments.length;
      if (b > 1) {
        for (var c = [], d = 0; b > d; d++) c[d] = arguments[d];
        c.sort(function(a, b) {
          return b - a
        });
        for (var e = !0, d = 0; b > d; d++) e = e && this._removeChildAt(c[d]);
        return e
      }
      return this._removeChildAt(a)
    }, b.removeAllChildren = function() {
      for (var a = this.children; a.length;) this._removeChildAt(0)
    }, b.getChildAt = function(a) {
      return this.children[a]
    }, b.getChildByName = function(a) {
      for (var b = this.children, c = 0, d = b.length; d > c; c++)
        if (b[c].name == a) return b[c];
      return null
    }, b.sortChildren = function(a) {
      this.children.sort(a)
    }, b.getChildIndex = function(a) {
      return createjs.indexOf(this.children, a)
    }, b.swapChildrenAt = function(a, b) {
      var c = this.children,
        d = c[a],
        e = c[b];
      d && e && (c[a] = e, c[b] = d)
    }, b.swapChildren = function(a, b) {
      for (var c, d, e = this.children, f = 0, g = e.length; g > f && (e[f] == a && (c = f), e[f] == b && (d = f), null == c || null == d); f++);
      f != g && (e[c] = b, e[d] = a)
    }, b.setChildIndex = function(a, b) {
      var c = this.children,
        d = c.length;
      if (!(a.parent != this || 0 > b || b >= d)) {
        for (var e = 0; d > e && c[e] != a; e++);
        e != d && e != b && (c.splice(e, 1), c.splice(b, 0, a))
      }
    }, b.contains = function(a) {
      for (; a;) {
        if (a == this) return !0;
        a = a.parent
      }
      return !1
    }, b.hitTest = function(a, b) {
      return null != this.getObjectUnderPoint(a, b)
    }, b.getObjectsUnderPoint = function(a, b, c) {
      var d = [],
        e = this.localToGlobal(a, b);
      return this._getObjectsUnderPoint(e.x, e.y, d, c > 0, 1 == c), d
    }, b.getObjectUnderPoint = function(a, b, c) {
      var d = this.localToGlobal(a, b);
      return this._getObjectsUnderPoint(d.x, d.y, null, c > 0, 1 == c)
    }, b.getBounds = function() {
      return this._getBounds(null, !0)
    }, b.getTransformedBounds = function() {
      return this._getBounds()
    }, b.clone = function(b) {
      var c = this._cloneProps(new a);
      return b && this._cloneChildren(c), c
    }, b.toString = function() {
      return "[Container (name=" + this.name + ")]"
    }, b._tick = function(a) {
      if (this.tickChildren)
        for (var b = this.children.length - 1; b >= 0; b--) {
          var c = this.children[b];
          c.tickEnabled && c._tick && c._tick(a)
        }
      this.DisplayObject__tick(a)
    }, b._cloneChildren = function(a) {
      a.children.length && a.removeAllChildren();
      for (var b = a.children, c = 0, d = this.children.length; d > c; c++) {
        var e = this.children[c].clone(!0);
        e.parent = a, b.push(e)
      }
    }, b._removeChildAt = function(a, b) {
      if (0 > a || a > this.children.length - 1) return !1;
      var c = this.children[a];
      return c && (c.parent = null), this.children.splice(a, 1), b || c.dispatchEvent("removed"), !0
    }, b._getObjectsUnderPoint = function(b, c, d, e, f, g) {
      if (g = g || 0, !g && !this._testMask(this, b, c)) return null;
      var h, i = createjs.DisplayObject._hitTestContext;
      f = f || e && this._hasMouseEventListener();
      for (var j = this.children, k = j.length, l = k - 1; l >= 0; l--) {
        var m = j[l],
          n = m.hitArea;
        if (m.visible && (n || m.isVisible()) && (!e || m.mouseEnabled) && (n || this._testMask(m, b, c)))
          if (!n && m instanceof a) {
            var o = m._getObjectsUnderPoint(b, c, d, e, f, g + 1);
            if (!d && o) return e && !this.mouseChildren ? this : o
          } else {
            if (e && !f && !m._hasMouseEventListener()) continue;
            var p = m.getConcatenatedDisplayProps(m._props);
            if (h = p.matrix, n && (h.appendMatrix(n.getMatrix(n._props.matrix)), p.alpha = n.alpha), i.globalAlpha = p.alpha, i.setTransform(h.a, h.b, h.c, h.d, h.tx - b, h.ty - c), (n || m).draw(i), !this._testHit(i)) continue;
            if (i.setTransform(1, 0, 0, 1, 0, 0), i.clearRect(0, 0, 2, 2), !d) return e && !this.mouseChildren ? this : m;
            d.push(m)
          }
      }
      return null
    }, b._testMask = function(a, b, c) {
      var d = a.mask;
      if (!d || !d.graphics || d.graphics.isEmpty()) return !0;
      var e = this._props.matrix,
        f = a.parent;
      e = f ? f.getConcatenatedMatrix(e) : e.identity(), e = d.getMatrix(d._props.matrix).prependMatrix(e);
      var g = createjs.DisplayObject._hitTestContext;
      return g.setTransform(e.a, e.b, e.c, e.d, e.tx - b, e.ty - c), d.graphics.drawAsPath(g), g.fillStyle = "#000", g.fill(), this._testHit(g) ? (g.setTransform(1, 0, 0, 1, 0, 0), g.clearRect(0, 0, 2, 2), !0) : !1
    }, b._getBounds = function(a, b) {
      var c = this.DisplayObject_getBounds();
      if (c) return this._transformBounds(c, a, b);
      var d = this._props.matrix;
      d = b ? d.identity() : this.getMatrix(d), a && d.prependMatrix(a);
      for (var e = this.children.length, f = null, g = 0; e > g; g++) {
        var h = this.children[g];
        h.visible && (c = h._getBounds(d)) && (f ? f.extend(c.x, c.y, c.width, c.height) : f = c.clone())
      }
      return f
    }, createjs.Container = createjs.promote(a, "DisplayObject")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.Container_constructor(), this.autoClear = !0, this.canvas = "string" == typeof a ? document.getElementById(a) : a, this.mouseX = 0, this.mouseY = 0, this.drawRect = null, this.snapToPixelEnabled = !1, this.mouseInBounds = !1, this.tickOnUpdate = !0, this.mouseMoveOutside = !1, this.preventSelection = !0, this._pointerData = {}, this._pointerCount = 0, this._primaryPointerID = null, this._mouseOverIntervalID = null, this._nextStage = null, this._prevStage = null, this.enableDOMEvents(!0)
    }
    var b = createjs.extend(a, createjs.Container);
    b._get_nextStage = function() {
      return this._nextStage
    }, b._set_nextStage = function(a) {
      this._nextStage && (this._nextStage._prevStage = null), a && (a._prevStage = this), this._nextStage = a
    };
    try {
      Object.defineProperties(b, {
        nextStage: {
          get: b._get_nextStage,
          set: b._set_nextStage
        }
      })
    } catch (c) {}
    b.update = function(a) {
      if (this.canvas && (this.tickOnUpdate && this.tick(a), this.dispatchEvent("drawstart", !1, !0) !== !1)) {
        createjs.DisplayObject._snapToPixelEnabled = this.snapToPixelEnabled;
        var b = this.drawRect,
          c = this.canvas.getContext("2d");
        c.setTransform(1, 0, 0, 1, 0, 0), this.autoClear && (b ? c.clearRect(b.x, b.y, b.width, b.height) : c.clearRect(0, 0, this.canvas.width + 1, this.canvas.height + 1)), c.save(), this.drawRect && (c.beginPath(), c.rect(b.x, b.y, b.width, b.height), c.clip()), this.updateContext(c), this.draw(c, !1), c.restore(), this.dispatchEvent("drawend")
      }
    }, b.tick = function(a) {
      if (this.tickEnabled && this.dispatchEvent("tickstart", !1, !0) !== !1) {
        var b = new createjs.Event("tick");
        if (a)
          for (var c in a) a.hasOwnProperty(c) && (b[c] = a[c]);
        this._tick(b), this.dispatchEvent("tickend")
      }
    }, b.handleEvent = function(a) {
      "tick" == a.type && this.update(a)
    }, b.clear = function() {
      if (this.canvas) {
        var a = this.canvas.getContext("2d");
        a.setTransform(1, 0, 0, 1, 0, 0), a.clearRect(0, 0, this.canvas.width + 1, this.canvas.height + 1)
      }
    }, b.toDataURL = function(a, b) {
      var c, d = this.canvas.getContext("2d"),
        e = this.canvas.width,
        f = this.canvas.height;
      if (a) {
        c = d.getImageData(0, 0, e, f);
        var g = d.globalCompositeOperation;
        d.globalCompositeOperation = "destination-over", d.fillStyle = a, d.fillRect(0, 0, e, f)
      }
      var h = this.canvas.toDataURL(b || "image/png");
      return a && (d.putImageData(c, 0, 0), d.globalCompositeOperation = g), h
    }, b.enableMouseOver = function(a) {
      if (this._mouseOverIntervalID && (clearInterval(this._mouseOverIntervalID), this._mouseOverIntervalID = null, 0 == a && this._testMouseOver(!0)), null == a) a = 20;
      else if (0 >= a) return;
      var b = this;
      this._mouseOverIntervalID = setInterval(function() {
        b._testMouseOver()
      }, 1e3 / Math.min(50, a))
    }, b.enableDOMEvents = function(a) {
      null == a && (a = !0);
      var b, c, d = this._eventListeners;
      if (!a && d) {
        for (b in d) c = d[b], c.t.removeEventListener(b, c.f, !1);
        this._eventListeners = null
      } else if (a && !d && this.canvas) {
        var e = window.addEventListener ? window : document,
          f = this;
        d = this._eventListeners = {}, d.mouseup = {
          t: e,
          f: function(a) {
            f._handleMouseUp(a)
          }
        }, d.mousemove = {
          t: e,
          f: function(a) {
            f._handleMouseMove(a)
          }
        }, d.dblclick = {
          t: this.canvas,
          f: function(a) {
            f._handleDoubleClick(a)
          }
        }, d.mousedown = {
          t: this.canvas,
          f: function(a) {
            f._handleMouseDown(a)
          }
        };
        for (b in d) c = d[b], c.t.addEventListener(b, c.f, !1)
      }
    }, b.clone = function() {
      throw "Stage cannot be cloned."
    }, b.toString = function() {
      return "[Stage (name=" + this.name + ")]"
    }, b._getElementRect = function(a) {
      var b;
      try {
        b = a.getBoundingClientRect()
      } catch (c) {
        b = {
          top: a.offsetTop,
          left: a.offsetLeft,
          width: a.offsetWidth,
          height: a.offsetHeight
        }
      }
      var d = (window.pageXOffset || document.scrollLeft || 0) - (document.clientLeft || document.body.clientLeft || 0),
        e = (window.pageYOffset || document.scrollTop || 0) - (document.clientTop || document.body.clientTop || 0),
        f = window.getComputedStyle ? getComputedStyle(a, null) : a.currentStyle,
        g = parseInt(f.paddingLeft) + parseInt(f.borderLeftWidth),
        h = parseInt(f.paddingTop) + parseInt(f.borderTopWidth),
        i = parseInt(f.paddingRight) + parseInt(f.borderRightWidth),
        j = parseInt(f.paddingBottom) + parseInt(f.borderBottomWidth);
      return {
        left: b.left + d + g,
        right: b.right + d - i,
        top: b.top + e + h,
        bottom: b.bottom + e - j
      }
    }, b._getPointerData = function(a) {
      var b = this._pointerData[a];
      return b || (b = this._pointerData[a] = {
        x: 0,
        y: 0
      }), b
    }, b._handleMouseMove = function(a) {
      a || (a = window.event), this._handlePointerMove(-1, a, a.pageX, a.pageY)
    }, b._handlePointerMove = function(a, b, c, d, e) {
      if ((!this._prevStage || void 0 !== e) && this.canvas) {
        var f = this._nextStage,
          g = this._getPointerData(a),
          h = g.inBounds;
        this._updatePointerPosition(a, b, c, d), (h || g.inBounds || this.mouseMoveOutside) && (-1 === a && g.inBounds == !h && this._dispatchMouseEvent(this, h ? "mouseleave" : "mouseenter", !1, a, g, b), this._dispatchMouseEvent(this, "stagemousemove", !1, a, g, b), this._dispatchMouseEvent(g.target, "pressmove", !0, a, g, b)), f && f._handlePointerMove(a, b, c, d, null)
      }
    }, b._updatePointerPosition = function(a, b, c, d) {
      var e = this._getElementRect(this.canvas);
      c -= e.left, d -= e.top;
      var f = this.canvas.width,
        g = this.canvas.height;
      c /= (e.right - e.left) / f, d /= (e.bottom - e.top) / g;
      var h = this._getPointerData(a);
      (h.inBounds = c >= 0 && d >= 0 && f - 1 >= c && g - 1 >= d) ? (h.x = c, h.y = d) : this.mouseMoveOutside && (h.x = 0 > c ? 0 : c > f - 1 ? f - 1 : c, h.y = 0 > d ? 0 : d > g - 1 ? g - 1 : d), h.posEvtObj = b, h.rawX = c, h.rawY = d, (a === this._primaryPointerID || -1 === a) && (this.mouseX = h.x, this.mouseY = h.y, this.mouseInBounds = h.inBounds)
    }, b._handleMouseUp = function(a) {
      this._handlePointerUp(-1, a, !1)
    }, b._handlePointerUp = function(a, b, c, d) {
      var e = this._nextStage,
        f = this._getPointerData(a);
      if (!this._prevStage || void 0 !== d) {
        var g = null,
          h = f.target;
        d || !h && !e || (g = this._getObjectsUnderPoint(f.x, f.y, null, !0)), f.down && (this._dispatchMouseEvent(this, "stagemouseup", !1, a, f, b, g), f.down = !1), g == h && this._dispatchMouseEvent(h, "click", !0, a, f, b), this._dispatchMouseEvent(h, "pressup", !0, a, f, b), c ? (a == this._primaryPointerID && (this._primaryPointerID = null), delete this._pointerData[a]) : f.target = null, e && e._handlePointerUp(a, b, c, d || g && this)
      }
    }, b._handleMouseDown = function(a) {
      this._handlePointerDown(-1, a, a.pageX, a.pageY)
    }, b._handlePointerDown = function(a, b, c, d, e) {
      this.preventSelection && b.preventDefault(), (null == this._primaryPointerID || -1 === a) && (this._primaryPointerID = a), null != d && this._updatePointerPosition(a, b, c, d);
      var f = null,
        g = this._nextStage,
        h = this._getPointerData(a);
      e || (f = h.target = this._getObjectsUnderPoint(h.x, h.y, null, !0)), h.inBounds && (this._dispatchMouseEvent(this, "stagemousedown", !1, a, h, b, f), h.down = !0), this._dispatchMouseEvent(f, "mousedown", !0, a, h, b), g && g._handlePointerDown(a, b, c, d, e || f && this)
    }, b._testMouseOver = function(a, b, c) {
      if (!this._prevStage || void 0 !== b) {
        var d = this._nextStage;
        if (!this._mouseOverIntervalID) return void(d && d._testMouseOver(a, b, c));
        var e = this._getPointerData(-1);
        if (e && (a || this.mouseX != this._mouseOverX || this.mouseY != this._mouseOverY || !this.mouseInBounds)) {
          var f, g, h, i = e.posEvtObj,
            j = c || i && i.target == this.canvas,
            k = null,
            l = -1,
            m = "";
          !b && (a || this.mouseInBounds && j) && (k = this._getObjectsUnderPoint(this.mouseX, this.mouseY, null, !0), this._mouseOverX = this.mouseX, this._mouseOverY = this.mouseY);
          var n = this._mouseOverTarget || [],
            o = n[n.length - 1],
            p = this._mouseOverTarget = [];
          for (f = k; f;) p.unshift(f), m || (m = f.cursor), f = f.parent;
          for (this.canvas.style.cursor = m, !b && c && (c.canvas.style.cursor = m), g = 0, h = p.length; h > g && p[g] == n[g]; g++) l = g;
          for (o != k && this._dispatchMouseEvent(o, "mouseout", !0, -1, e, i, k), g = n.length - 1; g > l; g--) this._dispatchMouseEvent(n[g], "rollout", !1, -1, e, i, k);
          for (g = p.length - 1; g > l; g--) this._dispatchMouseEvent(p[g], "rollover", !1, -1, e, i, o);
          o != k && this._dispatchMouseEvent(k, "mouseover", !0, -1, e, i, o), d && d._testMouseOver(a, b || k && this, c || j && this)
        }
      }
    }, b._handleDoubleClick = function(a, b) {
      var c = null,
        d = this._nextStage,
        e = this._getPointerData(-1);
      b || (c = this._getObjectsUnderPoint(e.x, e.y, null, !0), this._dispatchMouseEvent(c, "dblclick", !0, -1, e, a)), d && d._handleDoubleClick(a, b || c && this)
    }, b._dispatchMouseEvent = function(a, b, c, d, e, f, g) {
      if (a && (c || a.hasEventListener(b))) {
        var h = new createjs.MouseEvent(b, c, !1, e.x, e.y, f, d, d === this._primaryPointerID || -1 === d, e.rawX, e.rawY, g);
        a.dispatchEvent(h)
      }
    }, createjs.Stage = createjs.promote(a, "Container")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(b, c) {
      if (this.Stage_constructor(b), void 0 !== c) {
        if ("object" != typeof c) throw "Invalid options object";
        var d = c.premultiply,
          e = c.transparent,
          f = c.antialias,
          g = c.preserveBuffer,
          h = c.autoPurge
      }
      this.vocalDebug = !1, this._preserveBuffer = g || !1, this._antialias = f || !1, this._transparent = e || !1, this._premultiply = d || !1, this._autoPurge = void 0, this.autoPurge = h, this._viewportWidth = 0, this._viewportHeight = 0, this._projectionMatrix = null, this._webGLContext = null, this._clearColor = {
        r: .5,
        g: .5,
        b: .5,
        a: 0
      }, this._maxCardsPerBatch = a.DEFAULT_MAX_BATCH_SIZE, this._activeShader = null, this._vertices = null, this._vertexPositionBuffer = null, this._uvs = null, this._uvPositionBuffer = null, this._indices = null, this._textureIndexBuffer = null, this._alphas = null, this._alphaBuffer = null, this._textureDictionary = [], this._textureIDs = {}, this._batchTextures = [], this._baseTextures = [], this._batchTextureCount = 8, this._lastTextureInsert = -1, this._batchID = 0, this._drawID = 0, this._slotBlacklist = [], this._isDrawing = 0, this._lastTrackedCanvas = 0, this.isCacheControlled = !1, this._cacheContainer = new createjs.Container, this._initializeWebGL()
    }
    var b = createjs.extend(a, createjs.Stage);
    a.buildUVRects = function(a, b, c) {
      if (!a || !a._frames) return null;
      void 0 === b && (b = -1), void 0 === c && (c = !1);
      for (var d = -1 != b && c ? b : 0, e = -1 != b && c ? b + 1 : a._frames.length, f = d; e > f; f++) {
        var g = a._frames[f];
        if (!(g.uvRect || g.image.width <= 0 || g.image.height <= 0)) {
          var h = g.rect;
          g.uvRect = {
            t: h.y / g.image.height,
            l: h.x / g.image.width,
            b: (h.y + h.height) / g.image.height,
            r: (h.x + h.width) / g.image.width
          }
        }
      }
      return a._frames[-1 != b ? b : 0].uvRect || {
        t: 0,
        l: 0,
        b: 1,
        r: 1
      }
    }, a.isWebGLActive = function(a) {
      return a && a instanceof WebGLRenderingContext && "undefined" != typeof WebGLRenderingContext
    }, a.VERTEX_PROPERTY_COUNT = 6, a.INDICIES_PER_CARD = 6, a.DEFAULT_MAX_BATCH_SIZE = 1e4, a.WEBGL_MAX_INDEX_NUM = Math.pow(2, 16), a.UV_RECT = {
      t: 0,
      l: 0,
      b: 1,
      r: 1
    };
    try {
      a.COVER_VERT = new Float32Array([-1, 1, 1, 1, -1, -1, 1, 1, 1, -1, -1, -1]), a.COVER_UV = new Float32Array([0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 0, 1]), a.COVER_UV_FLIP = new Float32Array([0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0])
    } catch (c) {}
    a.REGULAR_VARYING_HEADER = "precision mediump float;varying vec2 vTextureCoord;varying lowp float indexPicker;varying lowp float alphaValue;", a.REGULAR_VERTEX_HEADER = a.REGULAR_VARYING_HEADER + "attribute vec2 vertexPosition;attribute vec2 uvPosition;attribute lowp float textureIndex;attribute lowp float objectAlpha;uniform mat4 pMatrix;", a.REGULAR_FRAGMENT_HEADER = a.REGULAR_VARYING_HEADER + "uniform sampler2D uSampler[{{count}}];", a.REGULAR_VERTEX_BODY = "void main(void) {gl_Position = vec4((vertexPosition.x * pMatrix[0][0]) + pMatrix[3][0],(vertexPosition.y * pMatrix[1][1]) + pMatrix[3][1],pMatrix[3][2],1.0);alphaValue = objectAlpha;indexPicker = textureIndex;vTextureCoord = uvPosition;}", a.REGULAR_FRAGMENT_BODY = "void main(void) {vec4 color = vec4(1.0, 0.0, 0.0, 1.0);if (indexPicker <= 0.5) {color = texture2D(uSampler[0], vTextureCoord);{{alternates}}}{{fragColor}}}", a.REGULAR_FRAG_COLOR_NORMAL = "gl_FragColor = vec4(color.rgb, color.a * alphaValue);", a.REGULAR_FRAG_COLOR_PREMULTIPLY = "if(color.a > 0.0035) {gl_FragColor = vec4(color.rgb/color.a, color.a * alphaValue);} else {gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);}", a.PARTICLE_VERTEX_BODY = a.REGULAR_VERTEX_BODY, a.PARTICLE_FRAGMENT_BODY = a.REGULAR_FRAGMENT_BODY, a.COVER_VARYING_HEADER = "precision mediump float;varying highp vec2 vRenderCoord;varying highp vec2 vTextureCoord;", a.COVER_VERTEX_HEADER = a.COVER_VARYING_HEADER + "attribute vec2 vertexPosition;attribute vec2 uvPosition;uniform float uUpright;", a.COVER_FRAGMENT_HEADER = a.COVER_VARYING_HEADER + "uniform sampler2D uSampler;", a.COVER_VERTEX_BODY = "void main(void) {gl_Position = vec4(vertexPosition.x, vertexPosition.y, 0.0, 1.0);vRenderCoord = uvPosition;vTextureCoord = vec2(uvPosition.x, abs(uUpright - uvPosition.y));}", a.COVER_FRAGMENT_BODY = "void main(void) {vec4 color = texture2D(uSampler, vRenderCoord);gl_FragColor = color;}", b._get_isWebGL = function() {
      return !!this._webGLContext
    }, b._set_autoPurge = function(a) {
      a = isNaN(a) ? 1200 : a, -1 != a && (a = 10 > a ? 10 : a), this._autoPurge = a
    }, b._get_autoPurge = function() {
      return Number(this._autoPurge)
    };
    try {
      Object.defineProperties(b, {
        isWebGL: {
          get: b._get_isWebGL
        },
        autoPurge: {
          get: b._get_autoPurge,
          set: b._set_autoPurge
        }
      })
    } catch (c) {}
    b._initializeWebGL = function() {
      if (this.canvas) {
        if (!this._webGLContext || this._webGLContext.canvas !== this.canvas) {
          var a = {
              depth: !1,
              alpha: this._transparent,
              stencil: !0,
              antialias: this._antialias,
              premultipliedAlpha: this._premultiply,
              preserveDrawingBuffer: this._preserveBuffer
            },
            b = this._webGLContext = this._fetchWebGLContext(this.canvas, a);
          if (!b) return null;
          this.updateSimultaneousTextureCount(b.getParameter(b.MAX_TEXTURE_IMAGE_UNITS)), this._maxTextureSlots = b.getParameter(b.MAX_COMBINED_TEXTURE_IMAGE_UNITS), this._createBuffers(b), this._initTextures(b), b.disable(b.DEPTH_TEST), b.enable(b.BLEND), b.blendFuncSeparate(b.SRC_ALPHA, b.ONE_MINUS_SRC_ALPHA, b.ONE, b.ONE_MINUS_SRC_ALPHA), b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL, this._premultiply), this._webGLContext.clearColor(this._clearColor.r, this._clearColor.g, this._clearColor.b, this._clearColor.a), this.updateViewport(this._viewportWidth || this.canvas.width, this._viewportHeight || this.canvas.height)
        }
      } else this._webGLContext = null;
      return this._webGLContext
    }, b.update = function(a) {
      if (this.canvas) {
        if (this.tickOnUpdate && this.tick(a), this.dispatchEvent("drawstart"), this.autoClear && this.clear(), this._webGLContext) this._batchDraw(this, this._webGLContext), -1 == this._autoPurge || this._drawID % (this._autoPurge / 2 | 0) || this.purgeTextures(this._autoPurge);
        else {
          var b = this.canvas.getContext("2d");
          b.save(), this.updateContext(b), this.draw(b, !1), b.restore()
        }
        this.dispatchEvent("drawend")
      }
    }, b.clear = function() {
      if (this.canvas)
        if (a.isWebGLActive(this._webGLContext)) {
          var b = this._webGLContext,
            c = this._clearColor,
            d = this._transparent ? c.a : 1;
          this._webGLContext.clearColor(c.r * d, c.g * d, c.b * d, d), b.clear(b.COLOR_BUFFER_BIT), this._webGLContext.clearColor(c.r, c.g, c.b, c.a)
        } else this.Stage_clear()
    }, b.draw = function(b, c) {
      if (b === this._webGLContext && a.isWebGLActive(this._webGLContext)) {
        var d = this._webGLContext;
        return this._batchDraw(this, d, c), !0
      }
      return this.Stage_draw(b, c)
    }, b.cacheDraw = function(b, c, d) {
      if (a.isWebGLActive(this._webGLContext)) {
        var e = this._webGLContext;
        return this._cacheDraw(e, b, c, d), !0
      }
      return !1
    }, b.protectTextureSlot = function(a, b) {
      if (a > this._maxTextureSlots || 0 > a) throw "Slot outside of acceptable range";
      this._slotBlacklist[a] = !!b
    }, b.getTargetRenderTexture = function(a, b, c) {
      var d, e = !1,
        f = this._webGLContext;
      if (void 0 !== a.__lastRT && a.__lastRT === a.__rtA && (e = !0), e ? (void 0 === a.__rtB ? a.__rtB = this.getRenderBufferTexture(b, c) : ((b != a.__rtB._width || c != a.__rtB._height) && this.resizeTexture(a.__rtB, b, c), this.setTextureParams(f)), d = a.__rtB) : (void 0 === a.__rtA ? a.__rtA = this.getRenderBufferTexture(b, c) : ((b != a.__rtA._width || c != a.__rtA._height) && this.resizeTexture(a.__rtA, b, c), this.setTextureParams(f)), d = a.__rtA), !d) throw "Problems creating render textures, known causes include using too much VRAM by not releasing WebGL texture instances";
      return a.__lastRT = d, d
    }, b.releaseTexture = function(a) {
      var b, c;
      if (a) {
        if (a.children)
          for (b = 0, c = a.children.length; c > b; b++) this.releaseTexture(a.children[b]);
        a.cacheCanvas && a.uncache();
        var d = void 0;
        if (void 0 !== a._storeID) {
          if (a === this._textureDictionary[a._storeID]) return this._killTextureObject(a), void(a._storeID = void 0);
          d = a
        } else if (2 === a._webGLRenderStyle) d = a.image;
        else if (1 === a._webGLRenderStyle) {
          for (b = 0, c = a.spriteSheet._images.length; c > b; b++) this.releaseTexture(a.spriteSheet._images[b]);
          return
        }
        if (void 0 === d) return void(this.vocalDebug && console.log("No associated texture found on release"));
        this._killTextureObject(this._textureDictionary[d._storeID]), d._storeID = void 0
      }
    }, b.purgeTextures = function(a) {
      void 0 == a && (a = 100);
      for (var b = this._textureDictionary, c = b.length, d = 0; c > d; d++) {
        var e = b[d];
        e && e._drawID + a <= this._drawID && this._killTextureObject(e)
      }
    }, b.updateSimultaneousTextureCount = function(a) {
      var b = this._webGLContext,
        c = !1;
      for ((1 > a || isNaN(a)) && (a = 1), this._batchTextureCount = a; !c;) try {
        this._activeShader = this._fetchShaderProgram(b), c = !0
      } catch (d) {
        if (1 == this._batchTextureCount) throw "Cannot compile shader " + d;
        this._batchTextureCount -= 4, this._batchTextureCount < 1 && (this._batchTextureCount = 1), this.vocalDebug && console.log("Reducing desired texture count due to errors: " + this._batchTextureCount)
      }
    }, b.updateViewport = function(a, b) {
      this._viewportWidth = 0 | a, this._viewportHeight = 0 | b;
      var c = this._webGLContext;
      c && (c.viewport(0, 0, this._viewportWidth, this._viewportHeight), this._projectionMatrix = new Float32Array([2 / this._viewportWidth, 0, 0, 0, 0, -2 / this._viewportHeight, 1, 0, 0, 0, 1, 0, -1, 1, .1, 0]), this._projectionMatrixFlip = new Float32Array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]), this._projectionMatrixFlip.set(this._projectionMatrix), this._projectionMatrixFlip[5] *= -1, this._projectionMatrixFlip[13] *= -1)
    }, b.getFilterShader = function(a) {
      a || (a = this);
      var b = this._webGLContext,
        c = this._activeShader;
      if (a._builtShader) c = a._builtShader, a.shaderParamSetup && (b.useProgram(c), a.shaderParamSetup(b, this, c));
      else try {
        c = this._fetchShaderProgram(b, "filter", a.VTX_SHADER_BODY, a.FRAG_SHADER_BODY, a.shaderParamSetup && a.shaderParamSetup.bind(a)), a._builtShader = c, c._name = a.toString()
      } catch (d) {
        console && console.log("SHADER SWITCH FAILURE", d)
      }
      return c
    }, b.getBaseTexture = function(a, b) {
      var c = Math.ceil(a > 0 ? a : 1) || 1,
        d = Math.ceil(b > 0 ? b : 1) || 1,
        e = this._webGLContext,
        f = e.createTexture();
      return this.resizeTexture(f, c, d), this.setTextureParams(e, !1), f
    }, b.resizeTexture = function(a, b, c) {
      var d = this._webGLContext;
      d.bindTexture(d.TEXTURE_2D, a), d.texImage2D(d.TEXTURE_2D, 0, d.RGBA, b, c, 0, d.RGBA, d.UNSIGNED_BYTE, null), a.width = b, a.height = c
    }, b.getRenderBufferTexture = function(a, b) {
      var c = this._webGLContext,
        d = this.getBaseTexture(a, b);
      if (!d) return null;
      var e = c.createFramebuffer();
      return e ? (d.width = a, d.height = b, c.bindFramebuffer(c.FRAMEBUFFER, e), c.framebufferTexture2D(c.FRAMEBUFFER, c.COLOR_ATTACHMENT0, c.TEXTURE_2D, d, 0), e._renderTexture = d, d._frameBuffer = e, d._storeID = this._textureDictionary.length, this._textureDictionary[d._storeID] = d, c.bindFramebuffer(c.FRAMEBUFFER, null), d) : null
    }, b.setTextureParams = function(a, b) {
      b && this._antialias ? (a.texParameteri(a.TEXTURE_2D, a.TEXTURE_MIN_FILTER, a.LINEAR), a.texParameteri(a.TEXTURE_2D, a.TEXTURE_MAG_FILTER, a.LINEAR)) : (a.texParameteri(a.TEXTURE_2D, a.TEXTURE_MIN_FILTER, a.NEAREST), a.texParameteri(a.TEXTURE_2D, a.TEXTURE_MAG_FILTER, a.NEAREST)), a.texParameteri(a.TEXTURE_2D, a.TEXTURE_WRAP_S, a.CLAMP_TO_EDGE), a.texParameteri(a.TEXTURE_2D, a.TEXTURE_WRAP_T, a.CLAMP_TO_EDGE)
    }, b.setClearColor = function(a) {
      var b, c, d, e, f;
      "string" == typeof a ? 0 == a.indexOf("#") ? (4 == a.length && (a = "#" + a.charAt(1) + a.charAt(1) + a.charAt(2) + a.charAt(2) + a.charAt(3) + a.charAt(3)), b = Number("0x" + a.slice(1, 3)) / 255, c = Number("0x" + a.slice(3, 5)) / 255, d = Number("0x" + a.slice(5, 7)) / 255, e = Number("0x" + a.slice(7, 9)) / 255) : 0 == a.indexOf("rgba(") && (f = a.slice(5, -1).split(","), b = Number(f[0]) / 255, c = Number(f[1]) / 255, d = Number(f[2]) / 255, e = Number(f[3])) : (b = ((4278190080 & a) >>> 24) / 255, c = ((16711680 & a) >>> 16) / 255, d = ((65280 & a) >>> 8) / 255, e = (255 & a) / 255), this._clearColor.r = b || 0, this._clearColor.g = c || 0, this._clearColor.b = d || 0, this._clearColor.a = e || 0, this._webGLContext && this._webGLContext.clearColor(this._clearColor.r, this._clearColor.g, this._clearColor.b, this._clearColor.a);
    }, b.toString = function() {
      return "[StageGL (name=" + this.name + ")]"
    }, b._fetchWebGLContext = function(a, b) {
      var c;
      try {
        c = a.getContext("webgl", b) || a.getContext("experimental-webgl", b)
      } catch (d) {}
      if (c) c.viewportWidth = a.width, c.viewportHeight = a.height;
      else {
        var e = "Could not initialize WebGL";
        console.error ? console.error(e) : console.log(e)
      }
      return c
    }, b._fetchShaderProgram = function(b, c, d, e, f) {
      b.useProgram(null);
      var g, h;
      switch (c) {
        case "filter":
          h = a.COVER_VERTEX_HEADER + (d || a.COVER_VERTEX_BODY), g = a.COVER_FRAGMENT_HEADER + (e || a.COVER_FRAGMENT_BODY);
          break;
        case "particle":
          h = a.REGULAR_VERTEX_HEADER + a.PARTICLE_VERTEX_BODY, g = a.REGULAR_FRAGMENT_HEADER + a.PARTICLE_FRAGMENT_BODY;
          break;
        case "override":
          h = a.REGULAR_VERTEX_HEADER + (d || a.REGULAR_VERTEX_BODY), g = a.REGULAR_FRAGMENT_HEADER + (e || a.REGULAR_FRAGMENT_BODY);
          break;
        case "regular":
        default:
          h = a.REGULAR_VERTEX_HEADER + a.REGULAR_VERTEX_BODY, g = a.REGULAR_FRAGMENT_HEADER + a.REGULAR_FRAGMENT_BODY
      }
      var i = this._createShader(b, b.VERTEX_SHADER, h),
        j = this._createShader(b, b.FRAGMENT_SHADER, g),
        k = b.createProgram();
      if (b.attachShader(k, i), b.attachShader(k, j), b.linkProgram(k), k._type = c, !b.getProgramParameter(k, b.LINK_STATUS)) throw b.useProgram(this._activeShader), b.getProgramInfoLog(k);
      switch (b.useProgram(k), c) {
        case "filter":
          k.vertexPositionAttribute = b.getAttribLocation(k, "vertexPosition"), b.enableVertexAttribArray(k.vertexPositionAttribute), k.uvPositionAttribute = b.getAttribLocation(k, "uvPosition"), b.enableVertexAttribArray(k.uvPositionAttribute), k.samplerUniform = b.getUniformLocation(k, "uSampler"), b.uniform1i(k.samplerUniform, 0), k.uprightUniform = b.getUniformLocation(k, "uUpright"), b.uniform1f(k.uprightUniform, 0), f && f(b, this, k);
          break;
        case "override":
        case "particle":
        case "regular":
        default:
          k.vertexPositionAttribute = b.getAttribLocation(k, "vertexPosition"), b.enableVertexAttribArray(k.vertexPositionAttribute), k.uvPositionAttribute = b.getAttribLocation(k, "uvPosition"), b.enableVertexAttribArray(k.uvPositionAttribute), k.textureIndexAttribute = b.getAttribLocation(k, "textureIndex"), b.enableVertexAttribArray(k.textureIndexAttribute), k.alphaAttribute = b.getAttribLocation(k, "objectAlpha"), b.enableVertexAttribArray(k.alphaAttribute);
          for (var l = [], m = 0; m < this._batchTextureCount; m++) l[m] = m;
          k.samplerData = l, k.samplerUniform = b.getUniformLocation(k, "uSampler"), b.uniform1iv(k.samplerUniform, l), k.pMatrixUniform = b.getUniformLocation(k, "pMatrix")
      }
      return b.useProgram(this._activeShader), k
    }, b._createShader = function(b, c, d) {
      d = d.replace(/{{count}}/g, this._batchTextureCount);
      for (var e = "", f = 1; f < this._batchTextureCount; f++) e += "} else if (indexPicker <= " + f + ".5) { color = texture2D(uSampler[" + f + "], vTextureCoord);";
      d = d.replace(/{{alternates}}/g, e), d = d.replace(/{{fragColor}}/g, this._premultiply ? a.REGULAR_FRAG_COLOR_PREMULTIPLY : a.REGULAR_FRAG_COLOR_NORMAL);
      var g = b.createShader(c);
      if (b.shaderSource(g, d), b.compileShader(g), !b.getShaderParameter(g, b.COMPILE_STATUS)) throw b.getShaderInfoLog(g);
      return g
    }, b._createBuffers = function(b) {
      var c, d, e, f = this._maxCardsPerBatch * a.INDICIES_PER_CARD,
        g = this._vertexPositionBuffer = b.createBuffer();
      b.bindBuffer(b.ARRAY_BUFFER, g), c = 2;
      var h = this._vertices = new Float32Array(f * c);
      for (d = 0, e = h.length; e > d; d += c) h[d] = h[d + 1] = 0;
      b.bufferData(b.ARRAY_BUFFER, h, b.DYNAMIC_DRAW), g.itemSize = c, g.numItems = f;
      var i = this._uvPositionBuffer = b.createBuffer();
      b.bindBuffer(b.ARRAY_BUFFER, i), c = 2;
      var j = this._uvs = new Float32Array(f * c);
      for (d = 0, e = j.length; e > d; d += c) j[d] = j[d + 1] = 0;
      b.bufferData(b.ARRAY_BUFFER, j, b.DYNAMIC_DRAW), i.itemSize = c, i.numItems = f;
      var k = this._textureIndexBuffer = b.createBuffer();
      b.bindBuffer(b.ARRAY_BUFFER, k), c = 1;
      var l = this._indices = new Float32Array(f * c);
      for (d = 0, e = l.length; e > d; d++) l[d] = 0;
      b.bufferData(b.ARRAY_BUFFER, l, b.DYNAMIC_DRAW), k.itemSize = c, k.numItems = f;
      var m = this._alphaBuffer = b.createBuffer();
      b.bindBuffer(b.ARRAY_BUFFER, m), c = 1;
      var n = this._alphas = new Float32Array(f * c);
      for (d = 0, e = n.length; e > d; d++) n[d] = 1;
      b.bufferData(b.ARRAY_BUFFER, n, b.DYNAMIC_DRAW), m.itemSize = c, m.numItems = f
    }, b._initTextures = function() {
      this._lastTextureInsert = -1, this._textureDictionary = [], this._textureIDs = {}, this._baseTextures = [], this._batchTextures = [];
      for (var a = 0; a < this._batchTextureCount; a++) {
        var b = this.getBaseTexture();
        if (this._baseTextures[a] = this._batchTextures[a] = b, !b) throw "Problems creating basic textures, known causes include using too much VRAM by not releasing WebGL texture instances"
      }
    }, b._loadTextureImage = function(a, b) {
      var c = b.src;
      c || (b._isCanvas = !0, c = b.src = "canvas_" + this._lastTrackedCanvas++);
      var d = this._textureIDs[c];
      void 0 === d && (d = this._textureIDs[c] = this._textureDictionary.length), void 0 === this._textureDictionary[d] && (this._textureDictionary[d] = this.getBaseTexture());
      var e = this._textureDictionary[d];
      if (e) e._batchID = this._batchID, e._storeID = d, e._imageData = b, this._insertTextureInBatch(a, e), b._storeID = d, b.complete || b.naturalWidth || b._isCanvas ? this._updateTextureImageData(a, b) : b.addEventListener("load", this._updateTextureImageData.bind(this, a, b));
      else {
        var f = "Problem creating desired texture, known causes include using too much VRAM by not releasing WebGL texture instances";
        console.error && console.error(f) || console.log(f), e = this._baseTextures[0], e._batchID = this._batchID, e._storeID = -1, e._imageData = e, this._insertTextureInBatch(a, e)
      }
      return e
    }, b._updateTextureImageData = function(a, b) {
      var c = b.width & b.width - 1 || b.height & b.height - 1,
        d = this._textureDictionary[b._storeID];
      a.activeTexture(a.TEXTURE0 + d._activeIndex), a.bindTexture(a.TEXTURE_2D, d), d.isPOT = !c, this.setTextureParams(a, d.isPOT);
      try {
        a.texImage2D(a.TEXTURE_2D, 0, a.RGBA, a.RGBA, a.UNSIGNED_BYTE, b)
      } catch (e) {
        var f = "\nAn error has occurred. This is most likely due to security restrictions on WebGL images with local or cross-domain origins";
        console.error ? (console.error(f), console.error(e)) : console && (console.log(f), console.log(e))
      }
      b._invalid = !1, d._w = b.width, d._h = b.height, this.vocalDebug && (c && console.warn("NPOT(Non Power of Two) Texture: " + b.src), (b.width > a.MAX_TEXTURE_SIZE || b.height > a.MAX_TEXTURE_SIZE) && console && console.error("Oversized Texture: " + b.width + "x" + b.height + " vs " + a.MAX_TEXTURE_SIZE + "max"))
    }, b._insertTextureInBatch = function(a, b) {
      if (this._batchTextures[b._activeIndex] !== b) {
        var c = -1,
          d = (this._lastTextureInsert + 1) % this._batchTextureCount,
          e = d;
        do {
          if (this._batchTextures[e]._batchID != this._batchID && !this._slotBlacklist[e]) {
            c = e;
            break
          }
          e = (e + 1) % this._batchTextureCount
        } while (e !== d); - 1 === c && (this.batchReason = "textureOverflow", this._drawBuffers(a), this.batchCardCount = 0, c = d), this._batchTextures[c] = b, b._activeIndex = c;
        var f = b._imageData;
        f && f._invalid && void 0 !== b._drawID ? this._updateTextureImageData(a, f) : (a.activeTexture(a.TEXTURE0 + c), a.bindTexture(a.TEXTURE_2D, b), this.setTextureParams(a)), this._lastTextureInsert = c
      } else {
        var f = b._imageData;
        void 0 != b._storeID && f && f._invalid && this._updateTextureImageData(a, f)
      }
      b._drawID = this._drawID, b._batchID = this._batchID
    }, b._killTextureObject = function(a) {
      if (a) {
        var b = this._webGLContext;
        if (void 0 !== a._storeID && a._storeID >= 0) {
          this._textureDictionary[a._storeID] = void 0;
          for (var c in this._textureIDs) this._textureIDs[c] == a._storeID && delete this._textureIDs[c];
          a._imageData && (a._imageData._storeID = void 0), a._imageData = a._storeID = void 0
        }
        void 0 !== a._activeIndex && this._batchTextures[a._activeIndex] === a && (this._batchTextures[a._activeIndex] = this._baseTextures[a._activeIndex]);
        try {
          a._frameBuffer && b.deleteFramebuffer(a._frameBuffer), a._frameBuffer = void 0
        } catch (d) {
          this.vocalDebug && console.log(d)
        }
        try {
          b.deleteTexture(a)
        } catch (d) {
          this.vocalDebug && console.log(d)
        }
      }
    }, b._backupBatchTextures = function(a, b) {
      var c = this._webGLContext;
      this._backupTextures || (this._backupTextures = []), void 0 === b && (b = this._backupTextures);
      for (var d = 0; d < this._batchTextureCount; d++) c.activeTexture(c.TEXTURE0 + d), a ? this._batchTextures[d] = b[d] : (b[d] = this._batchTextures[d], this._batchTextures[d] = this._baseTextures[d]), c.bindTexture(c.TEXTURE_2D, this._batchTextures[d]), this.setTextureParams(c, this._batchTextures[d].isPOT);
      a && b === this._backupTextures && (this._backupTextures = [])
    }, b._batchDraw = function(a, b, c) {
      this._isDrawing > 0 && this._drawBuffers(b), this._isDrawing++, this._drawID++, this.batchCardCount = 0, this.depth = 0, this._appendToBatchGroup(a, b, new createjs.Matrix2D, this.alpha, c), this.batchReason = "drawFinish", this._drawBuffers(b), this._isDrawing--
    }, b._cacheDraw = function(a, b, c, d) {
      var e, f = this._activeShader,
        g = this._slotBlacklist,
        h = this._maxTextureSlots - 1,
        i = this._viewportWidth,
        j = this._viewportHeight;
      this.protectTextureSlot(h, !0);
      var k = b.getMatrix();
      k = k.clone(), k.scale(1 / d.scale, 1 / d.scale), k = k.invert(), k.translate(-d.offX / d.scale * b.scaleX, -d.offY / d.scale * b.scaleY);
      var l = this._cacheContainer;
      l.children = [b], l.transformMatrix = k, this._backupBatchTextures(!1), c && c.length ? this._drawFilters(b, c, d) : this.isCacheControlled ? (a.clear(a.COLOR_BUFFER_BIT), this._batchDraw(l, a, !0)) : (a.activeTexture(a.TEXTURE0 + h), b.cacheCanvas = this.getTargetRenderTexture(b, d._drawWidth, d._drawHeight), e = b.cacheCanvas, a.bindFramebuffer(a.FRAMEBUFFER, e._frameBuffer), this.updateViewport(d._drawWidth, d._drawHeight), this._projectionMatrix = this._projectionMatrixFlip, a.clear(a.COLOR_BUFFER_BIT), this._batchDraw(l, a, !0), a.bindFramebuffer(a.FRAMEBUFFER, null), this.updateViewport(i, j)), this._backupBatchTextures(!0), this.protectTextureSlot(h, !1), this._activeShader = f, this._slotBlacklist = g
    }, b._drawFilters = function(a, b, c) {
      var d, e = this._webGLContext,
        f = this._maxTextureSlots - 1,
        g = this._viewportWidth,
        h = this._viewportHeight,
        i = this._cacheContainer,
        j = b.length;
      e.activeTexture(e.TEXTURE0 + f), d = this.getTargetRenderTexture(a, c._drawWidth, c._drawHeight), e.bindFramebuffer(e.FRAMEBUFFER, d._frameBuffer), this.updateViewport(c._drawWidth, c._drawHeight), e.clear(e.COLOR_BUFFER_BIT), this._batchDraw(i, e, !0), e.activeTexture(e.TEXTURE0), e.bindTexture(e.TEXTURE_2D, d), this.setTextureParams(e);
      var k = !1,
        l = 0,
        m = b[l];
      do this._activeShader = this.getFilterShader(m), this._activeShader && (e.activeTexture(e.TEXTURE0 + f), d = this.getTargetRenderTexture(a, c._drawWidth, c._drawHeight), e.bindFramebuffer(e.FRAMEBUFFER, d._frameBuffer), e.viewport(0, 0, c._drawWidth, c._drawHeight), e.clear(e.COLOR_BUFFER_BIT), this._drawCover(e, k), e.activeTexture(e.TEXTURE0), e.bindTexture(e.TEXTURE_2D, d), this.setTextureParams(e), (j > 1 || b[0]._multiPass) && (k = !k), m = null !== m._multiPass ? m._multiPass : b[++l]); while (m);
      this.isCacheControlled ? (e.bindFramebuffer(e.FRAMEBUFFER, null), this.updateViewport(g, h), this._activeShader = this.getFilterShader(this), e.clear(e.COLOR_BUFFER_BIT), this._drawCover(e, k)) : (k && (e.activeTexture(e.TEXTURE0 + f), d = this.getTargetRenderTexture(a, c._drawWidth, c._drawHeight), e.bindFramebuffer(e.FRAMEBUFFER, d._frameBuffer), this._activeShader = this.getFilterShader(this), e.viewport(0, 0, c._drawWidth, c._drawHeight), e.clear(e.COLOR_BUFFER_BIT), this._drawCover(e, !k)), e.bindFramebuffer(e.FRAMEBUFFER, null), this.updateViewport(g, h), a.cacheCanvas = d)
    }, b._appendToBatchGroup = function(b, c, d, e, f) {
      b._glMtx || (b._glMtx = new createjs.Matrix2D);
      var g = b._glMtx;
      g.copy(d), b.transformMatrix ? g.appendMatrix(b.transformMatrix) : g.appendTransform(b.x, b.y, b.scaleX, b.scaleY, b.rotation, b.skewX, b.skewY, b.regX, b.regY);
      for (var h, i, j, k, l = b.children.length, m = 0; l > m; m++) {
        var n = b.children[m];
        if (n.visible && e)
          if (n.cacheCanvas && !f || (n._updateState && n._updateState(), !n.children)) {
            this.batchCardCount + 1 > this._maxCardsPerBatch && (this.batchReason = "vertexOverflow", this._drawBuffers(c), this.batchCardCount = 0), n._glMtx || (n._glMtx = new createjs.Matrix2D);
            var o = n._glMtx;
            o.copy(g), n.transformMatrix ? o.appendMatrix(n.transformMatrix) : o.appendTransform(n.x, n.y, n.scaleX, n.scaleY, n.rotation, n.skewX, n.skewY, n.regX, n.regY);
            var p, q, r, s, t, u, v = n.cacheCanvas && !f;
            if (2 === n._webGLRenderStyle || v) r = (f ? !1 : n.cacheCanvas) || n.image;
            else {
              if (1 !== n._webGLRenderStyle) continue;
              if (s = n.spriteSheet.getFrame(n.currentFrame), null === s) continue;
              r = s.image
            }
            var w = this._uvs,
              x = this._vertices,
              y = this._indices,
              z = this._alphas;
            if (r) {
              if (void 0 === r._storeID) t = this._loadTextureImage(c, r), this._insertTextureInBatch(c, t);
              else {
                if (t = this._textureDictionary[r._storeID], !t) {
                  this.vocalDebug && console.log("Texture should not be looked up while not being stored.");
                  continue
                }
                t._batchID !== this._batchID && this._insertTextureInBatch(c, t)
              }
              if (q = t._activeIndex, 2 === n._webGLRenderStyle || v) !v && n.sourceRect ? (n._uvRect || (n._uvRect = {}), u = n.sourceRect, p = n._uvRect, p.t = u.y / r.height, p.l = u.x / r.width, p.b = (u.y + u.height) / r.height, p.r = (u.x + u.width) / r.width, h = 0, i = 0, j = u.width + h, k = u.height + i) : (p = a.UV_RECT, v ? (u = n.bitmapCache, h = u.x + u._filterOffX / u.scale, i = u.y + u._filterOffY / u.scale, j = u._drawWidth / u.scale + h, k = u._drawHeight / u.scale + i) : (h = 0, i = 0, j = r.width + h, k = r.height + i));
              else if (1 === n._webGLRenderStyle) {
                var A = s.rect;
                p = s.uvRect, p || (p = a.buildUVRects(n.spriteSheet, n.currentFrame, !1)), h = -s.regX, i = -s.regY, j = A.width - s.regX, k = A.height - s.regY
              }
              var B = this.batchCardCount * a.INDICIES_PER_CARD,
                C = 2 * B;
              x[C] = h * o.a + i * o.c + o.tx, x[C + 1] = h * o.b + i * o.d + o.ty, x[C + 2] = h * o.a + k * o.c + o.tx, x[C + 3] = h * o.b + k * o.d + o.ty, x[C + 4] = j * o.a + i * o.c + o.tx, x[C + 5] = j * o.b + i * o.d + o.ty, x[C + 6] = x[C + 2], x[C + 7] = x[C + 3], x[C + 8] = x[C + 4], x[C + 9] = x[C + 5], x[C + 10] = j * o.a + k * o.c + o.tx, x[C + 11] = j * o.b + k * o.d + o.ty, w[C] = p.l, w[C + 1] = p.t, w[C + 2] = p.l, w[C + 3] = p.b, w[C + 4] = p.r, w[C + 5] = p.t, w[C + 6] = p.l, w[C + 7] = p.b, w[C + 8] = p.r, w[C + 9] = p.t, w[C + 10] = p.r, w[C + 11] = p.b, y[B] = y[B + 1] = y[B + 2] = y[B + 3] = y[B + 4] = y[B + 5] = q, z[B] = z[B + 1] = z[B + 2] = z[B + 3] = z[B + 4] = z[B + 5] = n.alpha * e, this.batchCardCount++
            }
          } else this._appendToBatchGroup(n, c, g, n.alpha * e)
      }
    }, b._drawBuffers = function(b) {
      if (!(this.batchCardCount <= 0)) {
        this.vocalDebug && console.log("Draw[" + this._drawID + ":" + this._batchID + "] : " + this.batchReason);
        var c = this._activeShader,
          d = this._vertexPositionBuffer,
          e = this._textureIndexBuffer,
          f = this._uvPositionBuffer,
          g = this._alphaBuffer;
        b.useProgram(c), b.bindBuffer(b.ARRAY_BUFFER, d), b.vertexAttribPointer(c.vertexPositionAttribute, d.itemSize, b.FLOAT, !1, 0, 0), b.bufferSubData(b.ARRAY_BUFFER, 0, this._vertices), b.bindBuffer(b.ARRAY_BUFFER, e), b.vertexAttribPointer(c.textureIndexAttribute, e.itemSize, b.FLOAT, !1, 0, 0), b.bufferSubData(b.ARRAY_BUFFER, 0, this._indices), b.bindBuffer(b.ARRAY_BUFFER, f), b.vertexAttribPointer(c.uvPositionAttribute, f.itemSize, b.FLOAT, !1, 0, 0), b.bufferSubData(b.ARRAY_BUFFER, 0, this._uvs), b.bindBuffer(b.ARRAY_BUFFER, g), b.vertexAttribPointer(c.alphaAttribute, g.itemSize, b.FLOAT, !1, 0, 0), b.bufferSubData(b.ARRAY_BUFFER, 0, this._alphas), b.uniformMatrix4fv(c.pMatrixUniform, b.FALSE, this._projectionMatrix);
        for (var h = 0; h < this._batchTextureCount; h++) {
          var i = this._batchTextures[h];
          b.activeTexture(b.TEXTURE0 + h), b.bindTexture(b.TEXTURE_2D, i), this.setTextureParams(b, i.isPOT)
        }
        b.drawArrays(b.TRIANGLES, 0, this.batchCardCount * a.INDICIES_PER_CARD), this._batchID++
      }
    }, b._drawCover = function(b, c) {
      this._isDrawing > 0 && this._drawBuffers(b), this.vocalDebug && console.log("Draw[" + this._drawID + ":" + this._batchID + "] : Cover");
      var d = this._activeShader,
        e = this._vertexPositionBuffer,
        f = this._uvPositionBuffer;
      b.clear(b.COLOR_BUFFER_BIT), b.useProgram(d), b.bindBuffer(b.ARRAY_BUFFER, e), b.vertexAttribPointer(d.vertexPositionAttribute, e.itemSize, b.FLOAT, !1, 0, 0), b.bufferSubData(b.ARRAY_BUFFER, 0, a.COVER_VERT), b.bindBuffer(b.ARRAY_BUFFER, f), b.vertexAttribPointer(d.uvPositionAttribute, f.itemSize, b.FLOAT, !1, 0, 0), b.bufferSubData(b.ARRAY_BUFFER, 0, c ? a.COVER_UV_FLIP : a.COVER_UV), b.uniform1i(d.samplerUniform, 0), b.uniform1f(d.uprightUniform, c ? 0 : 1), b.drawArrays(b.TRIANGLES, 0, a.INDICIES_PER_CARD)
    }, createjs.StageGL = createjs.promote(a, "Stage")
  }(), this.createjs = this.createjs || {},
  function() {
    function a(a) {
      this.DisplayObject_constructor(), "string" == typeof a ? (this.image = document.createElement("img"), this.image.src = a) : this.image = a, this.sourceRect = null, this._webGLRenderStyle = createjs.DisplayObject._StageGL_BITMAP
    }
    var b = createjs.extend(a, createjs.DisplayObject);
    b.initialize = a, b.isVisible = function() {
      var a = this.image,
        b = this.cacheCanvas || a && (a.naturalWidth || a.getContext || a.readyState >= 2);
      return !!(this.visible && this.alpha > 0 && 0 != this.scaleX && 0 != this.scaleY && b)
    }, b.draw = function(a, b) {
      if (this.DisplayObject_draw(a, b)) return !0;
      var c = this.image,
        d = this.sourceRect;
      if (c.getImage && (c = c.getImage()), !c) return !0;
      if (d) {
        var e = d.x,
          f = d.y,
          g = e + d.width,
          h = f + d.height,
          i = 0,
          j = 0,
          k = c.width,
          l = c.height;
        0 > e && (i -= e, e = 0), g > k && (g = k), 0 > f && (j -= f, f = 0), h > l && (h = l), a.drawImage(c, e, f, g - e, h - f, i, j, g - e, h - f)
      } else a.drawImage(c, 0, 0);
      return !0
    }, b.getBounds = function() {
      var a = this.DisplayObject_getBounds();
      if (a) return a;
      var b = this.image,
        c = this.sourceRect || b,
        d = b && (b.naturalWidth || b.getContext || b.readyState >= 2);
      return d ? this._rectangle.setValues(0, 0, c.width, c.height) : null
    }, b.clone = function(b) {
      var c = this.image;
      c && b && (c = c.cloneNode());
      var d = new a(c);
      return this.sourceRect && (d.sourceRect = this.sourceRect.clone()), this._cloneProps(d), d
    }, b.toString = function() {
      return "[Bitmap (name=" + this.name + ")]"
    }, createjs.Bitmap = createjs.promote(a, "DisplayObject")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.DisplayObject_constructor(), this.currentFrame = 0, this.currentAnimation = null, this.paused = !0, this.spriteSheet = a, this.currentAnimationFrame = 0, this.framerate = 0, this._animation = null, this._currentFrame = null, this._skipAdvance = !1, this._webGLRenderStyle = createjs.DisplayObject._StageGL_SPRITE, null != b && this.gotoAndPlay(b)
    }
    var b = createjs.extend(a, createjs.DisplayObject);
    b.initialize = a, b.isVisible = function() {
      var a = this.cacheCanvas || this.spriteSheet.complete;
      return !!(this.visible && this.alpha > 0 && 0 != this.scaleX && 0 != this.scaleY && a)
    }, b.draw = function(a, b) {
      if (this.DisplayObject_draw(a, b)) return !0;
      this._normalizeFrame();
      var c = this.spriteSheet.getFrame(0 | this._currentFrame);
      if (!c) return !1;
      var d = c.rect;
      return d.width && d.height && a.drawImage(c.image, d.x, d.y, d.width, d.height, -c.regX, -c.regY, d.width, d.height), !0
    }, b.play = function() {
      this.paused = !1
    }, b.stop = function() {
      this.paused = !0
    }, b.gotoAndPlay = function(a) {
      this.paused = !1, this._skipAdvance = !0, this._goto(a)
    }, b.gotoAndStop = function(a) {
      this.paused = !0, this._goto(a)
    }, b.advance = function(a) {
      var b = this.framerate || this.spriteSheet.framerate,
        c = b && null != a ? a / (1e3 / b) : 1;
      this._normalizeFrame(c)
    }, b.getBounds = function() {
      return this.DisplayObject_getBounds() || this.spriteSheet.getFrameBounds(this.currentFrame, this._rectangle)
    }, b.clone = function() {
      return this._cloneProps(new a(this.spriteSheet))
    }, b.toString = function() {
      return "[Sprite (name=" + this.name + ")]"
    }, b._cloneProps = function(a) {
      return this.DisplayObject__cloneProps(a), a.currentFrame = this.currentFrame, a.currentAnimation = this.currentAnimation, a.paused = this.paused, a.currentAnimationFrame = this.currentAnimationFrame, a.framerate = this.framerate, a._animation = this._animation, a._currentFrame = this._currentFrame, a._skipAdvance = this._skipAdvance, a
    }, b._tick = function(a) {
      this.paused || (this._skipAdvance || this.advance(a && a.delta), this._skipAdvance = !1), this.DisplayObject__tick(a)
    }, b._normalizeFrame = function(a) {
      a = a || 0;
      var b, c = this._animation,
        d = this.paused,
        e = this._currentFrame;
      if (c) {
        var f = c.speed || 1,
          g = this.currentAnimationFrame;
        if (b = c.frames.length, g + a * f >= b) {
          var h = c.next;
          if (this._dispatchAnimationEnd(c, e, d, h, b - 1)) return;
          if (h) return this._goto(h, a - (b - g) / f);
          this.paused = !0, g = c.frames.length - 1
        } else g += a * f;
        this.currentAnimationFrame = g, this._currentFrame = c.frames[0 | g]
      } else if (e = this._currentFrame += a, b = this.spriteSheet.getNumFrames(), e >= b && b > 0 && !this._dispatchAnimationEnd(c, e, d, b - 1) && (this._currentFrame -= b) >= b) return this._normalizeFrame();
      e = 0 | this._currentFrame, this.currentFrame != e && (this.currentFrame = e, this.dispatchEvent("change"))
    }, b._dispatchAnimationEnd = function(a, b, c, d, e) {
      var f = a ? a.name : null;
      if (this.hasEventListener("animationend")) {
        var g = new createjs.Event("animationend");
        g.name = f, g.next = d, this.dispatchEvent(g)
      }
      var h = this._animation != a || this._currentFrame != b;
      return h || c || !this.paused || (this.currentAnimationFrame = e, h = !0), h
    }, b._goto = function(a, b) {
      if (this.currentAnimationFrame = 0, isNaN(a)) {
        var c = this.spriteSheet.getAnimation(a);
        c && (this._animation = c, this.currentAnimation = a, this._normalizeFrame(b))
      } else this.currentAnimation = this._animation = null, this._currentFrame = a, this._normalizeFrame()
    }, createjs.Sprite = createjs.promote(a, "DisplayObject")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.DisplayObject_constructor(), this.graphics = a ? a : new createjs.Graphics
    }
    var b = createjs.extend(a, createjs.DisplayObject);
    b.isVisible = function() {
      var a = this.cacheCanvas || this.graphics && !this.graphics.isEmpty();
      return !!(this.visible && this.alpha > 0 && 0 != this.scaleX && 0 != this.scaleY && a)
    }, b.draw = function(a, b) {
      return this.DisplayObject_draw(a, b) ? !0 : (this.graphics.draw(a, this), !0)
    }, b.clone = function(b) {
      var c = b && this.graphics ? this.graphics.clone() : this.graphics;
      return this._cloneProps(new a(c))
    }, b.toString = function() {
      return "[Shape (name=" + this.name + ")]"
    }, createjs.Shape = createjs.promote(a, "DisplayObject")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c) {
      this.DisplayObject_constructor(), this.text = a, this.font = b, this.color = c, this.textAlign = "left", this.textBaseline = "top", this.maxWidth = null, this.outline = 0, this.lineHeight = 0, this.lineWidth = null
    }
    var b = createjs.extend(a, createjs.DisplayObject),
      c = createjs.createCanvas ? createjs.createCanvas() : document.createElement("canvas");
    c.getContext && (a._workingContext = c.getContext("2d"), c.width = c.height = 1), a.H_OFFSETS = {
      start: 0,
      left: 0,
      center: -.5,
      end: -1,
      right: -1
    }, a.V_OFFSETS = {
      top: 0,
      hanging: -.01,
      middle: -.4,
      alphabetic: -.8,
      ideographic: -.85,
      bottom: -1
    }, b.isVisible = function() {
      var a = this.cacheCanvas || null != this.text && "" !== this.text;
      return !!(this.visible && this.alpha > 0 && 0 != this.scaleX && 0 != this.scaleY && a)
    }, b.draw = function(a, b) {
      if (this.DisplayObject_draw(a, b)) return !0;
      var c = this.color || "#000";
      return this.outline ? (a.strokeStyle = c, a.lineWidth = 1 * this.outline) : a.fillStyle = c, this._drawText(this._prepContext(a)), !0
    }, b.getMeasuredWidth = function() {
      return this._getMeasuredWidth(this.text)
    }, b.getMeasuredLineHeight = function() {
      return 1.2 * this._getMeasuredWidth("M")
    }, b.getMeasuredHeight = function() {
      return this._drawText(null, {}).height
    }, b.getBounds = function() {
      var b = this.DisplayObject_getBounds();
      if (b) return b;
      if (null == this.text || "" === this.text) return null;
      var c = this._drawText(null, {}),
        d = this.maxWidth && this.maxWidth < c.width ? this.maxWidth : c.width,
        e = d * a.H_OFFSETS[this.textAlign || "left"],
        f = this.lineHeight || this.getMeasuredLineHeight(),
        g = f * a.V_OFFSETS[this.textBaseline || "top"];
      return this._rectangle.setValues(e, g, d, c.height)
    }, b.getMetrics = function() {
      var b = {
        lines: []
      };
      return b.lineHeight = this.lineHeight || this.getMeasuredLineHeight(), b.vOffset = b.lineHeight * a.V_OFFSETS[this.textBaseline || "top"], this._drawText(null, b, b.lines)
    }, b.clone = function() {
      return this._cloneProps(new a(this.text, this.font, this.color))
    }, b.toString = function() {
      return "[Text (text=" + (this.text.length > 20 ? this.text.substr(0, 17) + "..." : this.text) + ")]"
    }, b._cloneProps = function(a) {
      return this.DisplayObject__cloneProps(a), a.textAlign = this.textAlign, a.textBaseline = this.textBaseline, a.maxWidth = this.maxWidth, a.outline = this.outline, a.lineHeight = this.lineHeight, a.lineWidth = this.lineWidth, a
    }, b._prepContext = function(a) {
      return a.font = this.font || "10px sans-serif", a.textAlign = this.textAlign || "left", a.textBaseline = this.textBaseline || "top", a.lineJoin = "miter", a.miterLimit = 2.5, a
    }, b._drawText = function(b, c, d) {
      var e = !!b;
      e || (b = a._workingContext, b.save(), this._prepContext(b));
      for (var f = this.lineHeight || this.getMeasuredLineHeight(), g = 0, h = 0, i = String(this.text).split(/(?:\r\n|\r|\n)/), j = 0, k = i.length; k > j; j++) {
        var l = i[j],
          m = null;
        if (null != this.lineWidth && (m = b.measureText(l).width) > this.lineWidth) {
          var n = l.split(/(\s)/);
          l = n[0], m = b.measureText(l).width;
          for (var o = 1, p = n.length; p > o; o += 2) {
            var q = b.measureText(n[o] + n[o + 1]).width;
            m + q > this.lineWidth ? (e && this._drawTextLine(b, l, h * f), d && d.push(l), m > g && (g = m), l = n[o + 1], m = b.measureText(l).width, h++) : (l += n[o] + n[o + 1], m += q)
          }
        }
        e && this._drawTextLine(b, l, h * f), d && d.push(l), c && null == m && (m = b.measureText(l).width), m > g && (g = m), h++
      }
      return c && (c.width = g, c.height = h * f), e || b.restore(), c
    }, b._drawTextLine = function(a, b, c) {
      this.outline ? a.strokeText(b, 0, c, this.maxWidth || 65535) : a.fillText(b, 0, c, this.maxWidth || 65535)
    }, b._getMeasuredWidth = function(b) {
      var c = a._workingContext;
      c.save();
      var d = this._prepContext(c).measureText(b).width;
      return c.restore(), d
    }, createjs.Text = createjs.promote(a, "DisplayObject")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.Container_constructor(), this.text = a || "", this.spriteSheet = b, this.lineHeight = 0, this.letterSpacing = 0, this.spaceWidth = 0, this._oldProps = {
        text: 0,
        spriteSheet: 0,
        lineHeight: 0,
        letterSpacing: 0,
        spaceWidth: 0
      }, this._oldStage = null, this._drawAction = null
    }
    var b = createjs.extend(a, createjs.Container);
    a.maxPoolSize = 100, a._spritePool = [], b.draw = function(a, b) {
      this.DisplayObject_draw(a, b) || (this._updateState(), this.Container_draw(a, b))
    }, b.getBounds = function() {
      return this._updateText(), this.Container_getBounds()
    }, b.isVisible = function() {
      var a = this.cacheCanvas || this.spriteSheet && this.spriteSheet.complete && this.text;
      return !!(this.visible && this.alpha > 0 && 0 !== this.scaleX && 0 !== this.scaleY && a)
    }, b.clone = function() {
      return this._cloneProps(new a(this.text, this.spriteSheet))
    }, b.addChild = b.addChildAt = b.removeChild = b.removeChildAt = b.removeAllChildren = function() {}, b._updateState = function() {
      this._updateText()
    }, b._cloneProps = function(a) {
      return this.Container__cloneProps(a), a.lineHeight = this.lineHeight, a.letterSpacing = this.letterSpacing, a.spaceWidth = this.spaceWidth, a
    }, b._getFrameIndex = function(a, b) {
      var c, d = b.getAnimation(a);
      return d || (a != (c = a.toUpperCase()) || a != (c = a.toLowerCase()) || (c = null), c && (d = b.getAnimation(c))), d && d.frames[0]
    }, b._getFrame = function(a, b) {
      var c = this._getFrameIndex(a, b);
      return null == c ? c : b.getFrame(c)
    }, b._getLineHeight = function(a) {
      var b = this._getFrame("1", a) || this._getFrame("T", a) || this._getFrame("L", a) || a.getFrame(0);
      return b ? b.rect.height : 1
    }, b._getSpaceWidth = function(a) {
      var b = this._getFrame("1", a) || this._getFrame("l", a) || this._getFrame("e", a) || this._getFrame("a", a) || a.getFrame(0);
      return b ? b.rect.width : 1
    }, b._updateText = function() {
      var b, c = 0,
        d = 0,
        e = this._oldProps,
        f = !1,
        g = this.spaceWidth,
        h = this.lineHeight,
        i = this.spriteSheet,
        j = a._spritePool,
        k = this.children,
        l = 0,
        m = k.length;
      for (var n in e) e[n] != this[n] && (e[n] = this[n], f = !0);
      if (f) {
        var o = !!this._getFrame(" ", i);
        o || g || (g = this._getSpaceWidth(i)), h || (h = this._getLineHeight(i));
        for (var p = 0, q = this.text.length; q > p; p++) {
          var r = this.text.charAt(p);
          if (" " != r || o)
            if ("\n" != r && "\r" != r) {
              var s = this._getFrameIndex(r, i);
              null != s && (m > l ? b = k[l] : (k.push(b = j.length ? j.pop() : new createjs.Sprite), b.parent = this, m++), b.spriteSheet = i, b.gotoAndStop(s), b.x = c, b.y = d, l++, c += b.getBounds().width + this.letterSpacing)
            } else "\r" == r && "\n" == this.text.charAt(p + 1) && p++, c = 0, d += h;
          else c += g
        }
        for (; m > l;) j.push(b = k.pop()), b.parent = null, m--;
        j.length > a.maxPoolSize && (j.length = a.maxPoolSize)
      }
    }, createjs.BitmapText = createjs.promote(a, "Container")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(b) {
      this.Container_constructor(), !a.inited && a.init();
      var c, d, e, f;
      b instanceof String || arguments.length > 1 ? (c = b, d = arguments[1], e = arguments[2], f = arguments[3], null == e && (e = -1), b = null) : b && (c = b.mode, d = b.startPosition, e = b.loop, f = b.labels), b || (b = {
        labels: f
      }), this.mode = c || a.INDEPENDENT, this.startPosition = d || 0, this.loop = e === !0 ? -1 : e || 0, this.currentFrame = 0, this.paused = b.paused || !1, this.actionsEnabled = !0, this.autoReset = !0, this.frameBounds = this.frameBounds || b.frameBounds, this.framerate = null, b.useTicks = b.paused = !0, this.timeline = new createjs.Timeline(b), this._synchOffset = 0, this._rawPosition = -1, this._bound_resolveState = this._resolveState.bind(this), this._t = 0, this._managed = {}
    }

    function b() {
      throw "MovieClipPlugin cannot be instantiated."
    }
    var c = createjs.extend(a, createjs.Container);
    a.INDEPENDENT = "independent", a.SINGLE_FRAME = "single", a.SYNCHED = "synched", a.inited = !1, a.init = function() {
      a.inited || (b.install(), a.inited = !0)
    }, c._getLabels = function() {
      return this.timeline.getLabels()
    }, c.getLabels = createjs.deprecate(c._getLabels, "MovieClip.getLabels"), c._getCurrentLabel = function() {
      return this.timeline.currentLabel
    }, c.getCurrentLabel = createjs.deprecate(c._getCurrentLabel, "MovieClip.getCurrentLabel"), c._getDuration = function() {
      return this.timeline.duration
    }, c.getDuration = createjs.deprecate(c._getDuration, "MovieClip.getDuration");
    try {
      Object.defineProperties(c, {
        labels: {
          get: c._getLabels
        },
        currentLabel: {
          get: c._getCurrentLabel
        },
        totalFrames: {
          get: c._getDuration
        },
        duration: {
          get: c._getDuration
        }
      })
    } catch (d) {}
    c.initialize = a, c.isVisible = function() {
      return !!(this.visible && this.alpha > 0 && 0 != this.scaleX && 0 != this.scaleY)
    }, c.draw = function(a, b) {
      return this.DisplayObject_draw(a, b) ? !0 : (this._updateState(), this.Container_draw(a, b), !0)
    }, c.play = function() {
      this.paused = !1
    }, c.stop = function() {
      this.paused = !0
    }, c.gotoAndPlay = function(a) {
      this.paused = !1, this._goto(a)
    }, c.gotoAndStop = function(a) {
      this.paused = !0, this._goto(a)
    }, c.advance = function(b) {
      var c = a.INDEPENDENT;
      if (this.mode === c) {
        for (var d = this, e = d.framerate;
          (d = d.parent) && null === e;) d.mode === c && (e = d._framerate);
        if (this._framerate = e, !this.paused) {
          var f = null !== e && -1 !== e && null !== b ? b / (1e3 / e) + this._t : 1,
            g = 0 | f;
          for (this._t = f - g; g--;) this._updateTimeline(this._rawPosition + 1, !1)
        }
      }
    }, c.clone = function() {
      throw "MovieClip cannot be cloned."
    }, c.toString = function() {
      return "[MovieClip (name=" + this.name + ")]"
    }, c._updateState = function() {
      (-1 === this._rawPosition || this.mode !== a.INDEPENDENT) && this._updateTimeline(-1)
    }, c._tick = function(a) {
      this.advance(a && a.delta), this.Container__tick(a)
    }, c._goto = function(a) {
      var b = this.timeline.resolve(a);
      null != b && (this._t = 0, this._updateTimeline(b, !0))
    }, c._reset = function() {
      this._rawPosition = -1, this._t = this.currentFrame = 0, this.paused = !1
    }, c._updateTimeline = function(b, c) {
      var d = this.mode !== a.INDEPENDENT,
        e = this.timeline;
      d && (b = this.startPosition + (this.mode === a.SINGLE_FRAME ? 0 : this._synchOffset)), 0 > b && (b = 0), (this._rawPosition !== b || d) && (this._rawPosition = b, e.loop = this.loop, e.setPosition(b, d || !this.actionsEnabled, c, this._bound_resolveState))
    }, c._renderFirstFrame = function() {
      var a = this.timeline,
        b = a.rawPosition;
      a.setPosition(0, !0, !0, this._bound_resolveState), a.rawPosition = b
    }, c._resolveState = function() {
      var a = this.timeline;
      this.currentFrame = a.position;
      for (var b in this._managed) this._managed[b] = 1;
      for (var c = a.tweens, d = 0, e = c.length; e > d; d++) {
        var f = c[d],
          g = f.target;
        if (g !== this && !f.passive) {
          var h = f._stepPosition;
          g instanceof createjs.DisplayObject ? this._addManagedChild(g, h) : this._setState(g.state, h)
        }
      }
      var i = this.children;
      for (d = i.length - 1; d >= 0; d--) {
        var j = i[d].id;
        1 === this._managed[j] && (this.removeChildAt(d), delete this._managed[j])
      }
    }, c._setState = function(a, b) {
      if (a)
        for (var c = a.length - 1; c >= 0; c--) {
          var d = a[c],
            e = d.t,
            f = d.p;
          for (var g in f) e[g] = f[g];
          this._addManagedChild(e, b)
        }
    }, c._addManagedChild = function(b, c) {
      b._off || (this.addChildAt(b, 0), b instanceof a && (b._synchOffset = c, b.mode === a.INDEPENDENT && b.autoReset && !this._managed[b.id] && b._reset()), this._managed[b.id] = 2)
    }, c._getBounds = function(a, b) {
      var c = this.DisplayObject_getBounds();
      return c || this.frameBounds && (c = this._rectangle.copy(this.frameBounds[this.currentFrame])), c ? this._transformBounds(c, a, b) : this.Container__getBounds(a, b)
    }, createjs.MovieClip = createjs.promote(a, "Container"), b.priority = 100, b.ID = "MovieClip", b.install = function() {
      createjs.Tween._installPlugin(b)
    }, b.init = function(c, d, e) {
      "startPosition" === d && c.target instanceof a && c._addPlugin(b)
    }, b.step = function(a, b, c) {}, b.change = function(a, b, c, d, e, f) {
      return "startPosition" === c ? 1 === e ? b.props[c] : b.prev.props[c] : void 0
    }
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      throw "SpriteSheetUtils cannot be instantiated"
    }
    var b = createjs.createCanvas ? createjs.createCanvas() : document.createElement("canvas");
    b.getContext && (a._workingCanvas = b, a._workingContext = b.getContext("2d"), b.width = b.height = 1), a.extractFrame = function(b, c) {
      isNaN(c) && (c = b.getAnimation(c).frames[0]);
      var d = b.getFrame(c);
      if (!d) return null;
      var e = d.rect,
        f = a._workingCanvas;
      f.width = e.width, f.height = e.height, a._workingContext.drawImage(d.image, e.x, e.y, e.width, e.height, 0, 0, e.width, e.height);
      var g = document.createElement("img");
      return g.src = f.toDataURL("image/png"), g
    }, a.addFlippedFrames = createjs.deprecate(null, "SpriteSheetUtils.addFlippedFrames"), a.mergeAlpha = createjs.deprecate(null, "SpriteSheetUtils.mergeAlpha"), a._flip = function(b, c, d, e) {
      for (var f = b._images, g = a._workingCanvas, h = a._workingContext, i = f.length / c, j = 0; i > j; j++) {
        var k = f[j];
        k.__tmp = j, h.setTransform(1, 0, 0, 1, 0, 0), h.clearRect(0, 0, g.width + 1, g.height + 1), g.width = k.width, g.height = k.height, h.setTransform(d ? -1 : 1, 0, 0, e ? -1 : 1, d ? k.width : 0, e ? k.height : 0), h.drawImage(k, 0, 0);
        var l = document.createElement("img");
        l.src = g.toDataURL("image/png"), l.width = k.width || k.naturalWidth, l.height = k.height || k.naturalHeight, f.push(l)
      }
      var m = b._frames,
        n = m.length / c;
      for (j = 0; n > j; j++) {
        k = m[j];
        var o = k.rect.clone();
        l = f[k.image.__tmp + i * c];
        var p = {
          image: l,
          rect: o,
          regX: k.regX,
          regY: k.regY
        };
        d && (o.x = (l.width || l.naturalWidth) - o.x - o.width, p.regX = o.width - k.regX), e && (o.y = (l.height || l.naturalHeight) - o.y - o.height, p.regY = o.height - k.regY), m.push(p)
      }
      var q = "_" + (d ? "h" : "") + (e ? "v" : ""),
        r = b._animations,
        s = b._data,
        t = r.length / c;
      for (j = 0; t > j; j++) {
        var u = r[j];
        k = s[u];
        var v = {
          name: u + q,
          speed: k.speed,
          next: k.next,
          frames: []
        };
        k.next && (v.next += q), m = k.frames;
        for (var w = 0, x = m.length; x > w; w++) v.frames.push(m[w] + n * c);
        s[v.name] = v, r.push(v.name)
      }
    }, createjs.SpriteSheetUtils = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.EventDispatcher_constructor(), this.maxWidth = 2048, this.maxHeight = 2048, this.spriteSheet = null, this.scale = 1, this.padding = 1, this.timeSlice = .3, this.progress = -1, this.framerate = a || 0, this._frames = [], this._animations = {}, this._data = null, this._nextFrameIndex = 0, this._index = 0, this._timerID = null, this._scale = 1
    }
    var b = createjs.extend(a, createjs.EventDispatcher);
    a.ERR_DIMENSIONS = "frame dimensions exceed max spritesheet dimensions", a.ERR_RUNNING = "a build is already running", b.addFrame = function(b, c, d, e, f) {
      if (this._data) throw a.ERR_RUNNING;
      var g = c || b.bounds || b.nominalBounds;
      return !g && b.getBounds && (g = b.getBounds()), g ? (d = d || 1, this._frames.push({
        source: b,
        sourceRect: g,
        scale: d,
        funct: e,
        data: f,
        index: this._frames.length,
        height: g.height * d
      }) - 1) : null
    }, b.addAnimation = function(b, c, d, e) {
      if (this._data) throw a.ERR_RUNNING;
      this._animations[b] = {
        frames: c,
        next: d,
        speed: e
      }
    }, b.addMovieClip = function(b, c, d, e, f, g) {
      if (this._data) throw a.ERR_RUNNING;
      var h = b.frameBounds,
        i = c || b.bounds || b.nominalBounds;
      if (!i && b.getBounds && (i = b.getBounds()), i || h) {
        var j, k, l = this._frames.length,
          m = b.timeline.duration;
        for (j = 0; m > j; j++) {
          var n = h && h[j] ? h[j] : i;
          this.addFrame(b, n, d, this._setupMovieClipFrame, {
            i: j,
            f: e,
            d: f
          })
        }
        var o = b.timeline._labels,
          p = [];
        for (var q in o) p.push({
          index: o[q],
          label: q
        });
        if (p.length)
          for (p.sort(function(a, b) {
              return a.index - b.index
            }), j = 0, k = p.length; k > j; j++) {
            for (var r = p[j].label, s = l + p[j].index, t = l + (j == k - 1 ? m : p[j + 1].index), u = [], v = s; t > v; v++) u.push(v);
            (!g || (r = g(r, b, s, t))) && this.addAnimation(r, u, !0)
          }
      }
    }, b.build = function() {
      if (this._data) throw a.ERR_RUNNING;
      for (this._startBuild(); this._drawNext(););
      return this._endBuild(), this.spriteSheet
    }, b.buildAsync = function(b) {
      if (this._data) throw a.ERR_RUNNING;
      this.timeSlice = b, this._startBuild();
      var c = this;
      this._timerID = setTimeout(function() {
        c._run()
      }, 50 - 50 * Math.max(.01, Math.min(.99, this.timeSlice || .3)))
    }, b.stopAsync = function() {
      clearTimeout(this._timerID), this._data = null
    }, b.clone = function() {
      throw "SpriteSheetBuilder cannot be cloned."
    }, b.toString = function() {
      return "[SpriteSheetBuilder]"
    }, b._startBuild = function() {
      var b = this.padding || 0;
      this.progress = 0, this.spriteSheet = null, this._index = 0, this._scale = this.scale;
      var c = [];
      this._data = {
        images: [],
        frames: c,
        framerate: this.framerate,
        animations: this._animations
      };
      var d = this._frames.slice();
      if (d.sort(function(a, b) {
          return a.height <= b.height ? -1 : 1
        }), d[d.length - 1].height + 2 * b > this.maxHeight) throw a.ERR_DIMENSIONS;
      for (var e = 0, f = 0, g = 0; d.length;) {
        var h = this._fillRow(d, e, g, c, b);
        if (h.w > f && (f = h.w), e += h.h, !h.h || !d.length) {
          var i = createjs.createCanvas ? createjs.createCanvas() : document.createElement("canvas");
          i.width = this._getSize(f, this.maxWidth), i.height = this._getSize(e, this.maxHeight), this._data.images[g] = i, h.h || (f = e = 0, g++)
        }
      }
    }, b._setupMovieClipFrame = function(a, b) {
      var c = a.actionsEnabled;
      a.actionsEnabled = !1, a.gotoAndStop(b.i), a.actionsEnabled = c, b.f && b.f(a, b.d, b.i)
    }, b._getSize = function(a, b) {
      for (var c = 4; Math.pow(2, ++c) < a;);
      return Math.min(b, Math.pow(2, c))
    }, b._fillRow = function(b, c, d, e, f) {
      var g = this.maxWidth,
        h = this.maxHeight;
      c += f;
      for (var i = h - c, j = f, k = 0, l = b.length - 1; l >= 0; l--) {
        var m = b[l],
          n = this._scale * m.scale,
          o = m.sourceRect,
          p = m.source,
          q = Math.floor(n * o.x - f),
          r = Math.floor(n * o.y - f),
          s = Math.ceil(n * o.height + 2 * f),
          t = Math.ceil(n * o.width + 2 * f);
        if (t > g) throw a.ERR_DIMENSIONS;
        s > i || j + t > g || (m.img = d, m.rect = new createjs.Rectangle(j, c, t, s), k = k || s, b.splice(l, 1), e[m.index] = [j, c, t, s, d, Math.round(-q + n * p.regX - f), Math.round(-r + n * p.regY - f)], j += t)
      }
      return {
        w: j,
        h: k
      }
    }, b._endBuild = function() {
      this.spriteSheet = new createjs.SpriteSheet(this._data), this._data = null, this.progress = 1, this.dispatchEvent("complete")
    }, b._run = function() {
      for (var a = 50 * Math.max(.01, Math.min(.99, this.timeSlice || .3)), b = (new Date).getTime() + a, c = !1; b > (new Date).getTime();)
        if (!this._drawNext()) {
          c = !0;
          break
        } if (c) this._endBuild();
      else {
        var d = this;
        this._timerID = setTimeout(function() {
          d._run()
        }, 50 - a)
      }
      var e = this.progress = this._index / this._frames.length;
      if (this.hasEventListener("progress")) {
        var f = new createjs.Event("progress");
        f.progress = e, this.dispatchEvent(f)
      }
    }, b._drawNext = function() {
      var a = this._frames[this._index],
        b = a.scale * this._scale,
        c = a.rect,
        d = a.sourceRect,
        e = this._data.images[a.img],
        f = e.getContext("2d");
      return a.funct && a.funct(a.source, a.data), f.save(), f.beginPath(), f.rect(c.x, c.y, c.width, c.height), f.clip(), f.translate(Math.ceil(c.x - d.x * b), Math.ceil(c.y - d.y * b)), f.scale(b, b), a.source.draw(f), f.restore(), ++this._index < this._frames.length
    }, createjs.SpriteSheetBuilder = createjs.promote(a, "EventDispatcher")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.DisplayObject_constructor(), "string" == typeof a && (a = document.getElementById(a)), this.mouseEnabled = !1;
      var b = a.style;
      b.position = "absolute", b.transformOrigin = b.WebkitTransformOrigin = b.msTransformOrigin = b.MozTransformOrigin = b.OTransformOrigin = "0% 0%", this.htmlElement = a, this._oldProps = null, this._oldStage = null, this._drawAction = null
    }
    var b = createjs.extend(a, createjs.DisplayObject);
    b.isVisible = function() {
      return null != this.htmlElement
    }, b.draw = function(a, b) {
      return !0
    }, b.cache = function() {}, b.uncache = function() {}, b.updateCache = function() {}, b.hitTest = function() {}, b.localToGlobal = function() {}, b.globalToLocal = function() {}, b.localToLocal = function() {}, b.clone = function() {
      throw "DOMElement cannot be cloned."
    }, b.toString = function() {
      return "[DOMElement (name=" + this.name + ")]"
    }, b._tick = function(a) {
      var b = this.stage;
      b && b !== this._oldStage && (this._drawAction && b.off("drawend", this._drawAction), this._drawAction = b.on("drawend", this._handleDrawEnd, this), this._oldStage = b), this.DisplayObject__tick(a)
    }, b._handleDrawEnd = function(a) {
      var b = this.htmlElement;
      if (b) {
        var c = b.style,
          d = this.getConcatenatedDisplayProps(this._props),
          e = d.matrix,
          f = d.visible ? "visible" : "hidden";
        if (f != c.visibility && (c.visibility = f), d.visible) {
          var g = this._oldProps,
            h = g && g.matrix,
            i = 1e4;
          if (!h || !h.equals(e)) {
            var j = "matrix(" + (e.a * i | 0) / i + "," + (e.b * i | 0) / i + "," + (e.c * i | 0) / i + "," + (e.d * i | 0) / i + "," + (e.tx + .5 | 0);
            c.transform = c.WebkitTransform = c.OTransform = c.msTransform = j + "," + (e.ty + .5 | 0) + ")", c.MozTransform = j + "px," + (e.ty + .5 | 0) + "px)", g || (g = this._oldProps = new createjs.DisplayProps(!0, null)), g.matrix.copy(e)
          }
          g.alpha != d.alpha && (c.opacity = "" + (d.alpha * i | 0) / i, g.alpha = d.alpha)
        }
      }
    }, createjs.DOMElement = createjs.promote(a, "DisplayObject")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      this.usesContext = !1, this._multiPass = null, this.VTX_SHADER_BODY = null, this.FRAG_SHADER_BODY = null
    }
    var b = a.prototype;
    b.getBounds = function(a) {
      return a
    }, b.shaderParamSetup = function(a, b, c) {}, b.applyFilter = function(a, b, c, d, e, f, g, h) {
      f = f || a, null == g && (g = b), null == h && (h = c);
      try {
        var i = a.getImageData(b, c, d, e)
      } catch (j) {
        return !1
      }
      return this._applyFilter(i) ? (f.putImageData(i, g, h), !0) : !1
    }, b.toString = function() {
      return "[Filter]"
    }, b.clone = function() {
      return new a
    }, b._applyFilter = function(a) {
      return !0
    }, createjs.Filter = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      this.width = void 0, this.height = void 0, this.x = void 0, this.y = void 0, this.scale = 1, this.offX = 0, this.offY = 0, this.cacheID = 0, this._filterOffX = 0, this._filterOffY = 0, this._cacheDataURLID = 0, this._cacheDataURL = null, this._drawWidth = 0, this._drawHeight = 0
    }
    var b = a.prototype;
    a.getFilterBounds = function(a, b) {
      b || (b = new createjs.Rectangle);
      var c = a.filters,
        d = c && c.length;
      if (0 >= !!d) return b;
      for (var e = 0; d > e; e++) {
        var f = c[e];
        if (f && f.getBounds) {
          var g = f.getBounds();
          g && (0 == e ? b.setValues(g.x, g.y, g.width, g.height) : b.extend(g.x, g.y, g.width, g.height))
        }
      }
      return b
    }, b.toString = function() {
      return "[BitmapCache]"
    }, b.define = function(a, b, c, d, e, f, g) {
      if (!a) throw "No symbol to cache";
      this._options = g, this.target = a, this.width = d >= 1 ? d : 1, this.height = e >= 1 ? e : 1, this.x = b || 0, this.y = c || 0, this.scale = f || 1, this.update()
    }, b.update = function(b) {
      if (!this.target) throw "define() must be called before update()";
      var c = a.getFilterBounds(this.target),
        d = this.target.cacheCanvas;
      this._drawWidth = Math.ceil(this.width * this.scale) + c.width, this._drawHeight = Math.ceil(this.height * this.scale) + c.height, d && this._drawWidth == d.width && this._drawHeight == d.height || this._updateSurface(), this._filterOffX = c.x, this._filterOffY = c.y, this.offX = this.x * this.scale + this._filterOffX, this.offY = this.y * this.scale + this._filterOffY, this._drawToCache(b), this.cacheID = this.cacheID ? this.cacheID + 1 : 1
    }, b.release = function() {
      if (this._webGLCache) this._webGLCache.isCacheControlled || (this.__lastRT && (this.__lastRT = void 0), this.__rtA && this._webGLCache._killTextureObject(this.__rtA), this.__rtB && this._webGLCache._killTextureObject(this.__rtB), this.target && this.target.cacheCanvas && this._webGLCache._killTextureObject(this.target.cacheCanvas)), this._webGLCache = !1;
      else {
        var a = this.target.stage;
        a instanceof createjs.StageGL && a.releaseTexture(this.target.cacheCanvas)
      }
      this.target = this.target.cacheCanvas = null, this.cacheID = this._cacheDataURLID = this._cacheDataURL = void 0, this.width = this.height = this.x = this.y = this.offX = this.offY = 0, this.scale = 1
    }, b.getCacheDataURL = function() {
      var a = this.target && this.target.cacheCanvas;
      return a ? (this.cacheID != this._cacheDataURLID && (this._cacheDataURLID = this.cacheID, this._cacheDataURL = a.toDataURL ? a.toDataURL() : null), this._cacheDataURL) : null
    }, b.draw = function(a) {
      return this.target ? (a.drawImage(this.target.cacheCanvas, this.x + this._filterOffX / this.scale, this.y + this._filterOffY / this.scale, this._drawWidth / this.scale, this._drawHeight / this.scale), !0) : !1
    }, b._updateSurface = function() {
      if (!this._options || !this._options.useGL) {
        var a = this.target.cacheCanvas;
        return a || (a = this.target.cacheCanvas = createjs.createCanvas ? createjs.createCanvas() : document.createElement("canvas")), a.width = this._drawWidth, void(a.height = this._drawHeight)
      }
      if (!this._webGLCache)
        if ("stage" === this._options.useGL) {
          if (!this.target.stage || !this.target.stage.isWebGL) {
            var b = "Cannot use 'stage' for cache because the object's parent stage is ";
            throw b += this.target.stage ? "non WebGL." : "not set, please addChild to the correct stage."
          }
          this.target.cacheCanvas = !0, this._webGLCache = this.target.stage
        } else if ("new" === this._options.useGL) this.target.cacheCanvas = document.createElement("canvas"), this._webGLCache = new createjs.StageGL(this.target.cacheCanvas, {
        antialias: !0,
        transparent: !0,
        autoPurge: -1
      }), this._webGLCache.isCacheControlled = !0;
      else {
        if (!(this._options.useGL instanceof createjs.StageGL)) throw "Invalid option provided to useGL, expected ['stage', 'new', StageGL, undefined], got " + this._options.useGL;
        this.target.cacheCanvas = !0, this._webGLCache = this._options.useGL, this._webGLCache.isCacheControlled = !0
      }
      var a = this.target.cacheCanvas,
        c = this._webGLCache;
      c.isCacheControlled && (a.width = this._drawWidth, a.height = this._drawHeight, c.updateViewport(this._drawWidth, this._drawHeight)), this.target.filters ? (c.getTargetRenderTexture(this.target, this._drawWidth, this._drawHeight), c.getTargetRenderTexture(this.target, this._drawWidth, this._drawHeight)) : c.isCacheControlled || c.getTargetRenderTexture(this.target, this._drawWidth, this._drawHeight)
    }, b._drawToCache = function(a) {
      var b = this.target.cacheCanvas,
        c = this.target,
        d = this._webGLCache;
      if (d) d.cacheDraw(c, c.filters, this), b = this.target.cacheCanvas, b.width = this._drawWidth, b.height = this._drawHeight;
      else {
        var e = b.getContext("2d");
        a || e.clearRect(0, 0, this._drawWidth + 1, this._drawHeight + 1), e.save(), e.globalCompositeOperation = a, e.setTransform(this.scale, 0, 0, this.scale, -this._filterOffX, -this._filterOffY), e.translate(-this.x, -this.y), c.draw(e, !0), e.restore(), c.filters && c.filters.length && this._applyFilters(e)
      }
      b._invalid = !0
    }, b._applyFilters = function(a) {
      var b, c = this.target.filters,
        d = this._drawWidth,
        e = this._drawHeight,
        f = 0,
        g = c[f];
      do g.usesContext ? (b && (a.putImageData(b, 0, 0), b = null), g.applyFilter(a, 0, 0, d, e)) : (b || (b = a.getImageData(0, 0, d, e)), g._applyFilter(b)), g = null !== g._multiPass ? g._multiPass : c[++f]; while (g);
      b && a.putImageData(b, 0, 0)
    }, createjs.BitmapCache = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c) {
      this.Filter_constructor(), this._blurX = a, this._blurXTable = [], this._lastBlurX = null, this._blurY = b, this._blurYTable = [], this._lastBlurY = null, this._quality, this._lastQuality = null, this.FRAG_SHADER_TEMPLATE = "uniform float xWeight[{{blurX}}];uniform float yWeight[{{blurY}}];uniform vec2 textureOffset;void main(void) {vec4 color = vec4(0.0);float xAdj = ({{blurX}}.0-1.0)/2.0;float yAdj = ({{blurY}}.0-1.0)/2.0;vec2 sampleOffset;for(int i=0; i<{{blurX}}; i++) {for(int j=0; j<{{blurY}}; j++) {sampleOffset = vRenderCoord + (textureOffset * vec2(float(i)-xAdj, float(j)-yAdj));color += texture2D(uSampler, sampleOffset) * (xWeight[i] * yWeight[j]);}}gl_FragColor = color.rgba;}", (isNaN(c) || 1 > c) && (c = 1), this.setQuality(0 | c)
    }
    var b = createjs.extend(a, createjs.Filter);
    b.getBlurX = function() {
      return this._blurX
    }, b.getBlurY = function() {
      return this._blurY
    }, b.setBlurX = function(a) {
      (isNaN(a) || 0 > a) && (a = 0), this._blurX = a
    }, b.setBlurY = function(a) {
      (isNaN(a) || 0 > a) && (a = 0), this._blurY = a
    }, b.getQuality = function() {
      return this._quality
    }, b.setQuality = function(a) {
      (isNaN(a) || 0 > a) && (a = 0), this._quality = 0 | a
    }, b._getShader = function() {
      var a = this._lastBlurX !== this._blurX,
        b = this._lastBlurY !== this._blurY,
        c = this._lastQuality !== this._quality;
      return a || b || c ? ((a || c) && (this._blurXTable = this._getTable(this._blurX * this._quality)), (b || c) && (this._blurYTable = this._getTable(this._blurY * this._quality)), this._updateShader(), this._lastBlurX = this._blurX, this._lastBlurY = this._blurY, void(this._lastQuality = this._quality)) : this._compiledShader
    }, b._setShader = function() {
      this._compiledShader
    };
    try {
      Object.defineProperties(b, {
        blurX: {
          get: b.getBlurX,
          set: b.setBlurX
        },
        blurY: {
          get: b.getBlurY,
          set: b.setBlurY
        },
        quality: {
          get: b.getQuality,
          set: b.setQuality
        },
        _builtShader: {
          get: b._getShader,
          set: b._setShader
        }
      })
    } catch (c) {
      console.log(c)
    }
    b._getTable = function(a) {
      var b = 4.2;
      if (1 >= a) return [1];
      var c = [],
        d = Math.ceil(2 * a);
      d += d % 2 ? 0 : 1;
      for (var e = d / 2 | 0, f = -e; e >= f; f++) {
        var g = f / e * b;
        c.push(1 / Math.sqrt(2 * Math.PI) * Math.pow(Math.E, -(Math.pow(g, 2) / 4)))
      }
      var h = c.reduce(function(a, b) {
        return a + b
      });
      return c.map(function(a, b, c) {
        return a / h
      })
    }, b._updateShader = function() {
      if (void 0 !== this._blurX && void 0 !== this._blurY) {
        var a = this.FRAG_SHADER_TEMPLATE;
        a = a.replace(/\{\{blurX\}\}/g, this._blurXTable.length.toFixed(0)), a = a.replace(/\{\{blurY\}\}/g, this._blurYTable.length.toFixed(0)), this.FRAG_SHADER_BODY = a
      }
    }, b.shaderParamSetup = function(a, b, c) {
      a.uniform1fv(a.getUniformLocation(c, "xWeight"), this._blurXTable), a.uniform1fv(a.getUniformLocation(c, "yWeight"), this._blurYTable), a.uniform2f(a.getUniformLocation(c, "textureOffset"), 2 / (b._viewportWidth * this._quality), 2 / (b._viewportHeight * this._quality))
    }, a.MUL_TABLE = [1, 171, 205, 293, 57, 373, 79, 137, 241, 27, 391, 357, 41, 19, 283, 265, 497, 469, 443, 421, 25, 191, 365, 349, 335, 161, 155, 149, 9, 278, 269, 261, 505, 245, 475, 231, 449, 437, 213, 415, 405, 395, 193, 377, 369, 361, 353, 345, 169, 331, 325, 319, 313, 307, 301, 37, 145, 285, 281, 69, 271, 267, 263, 259, 509, 501, 493, 243, 479, 118, 465, 459, 113, 446, 55, 435, 429, 423, 209, 413, 51, 403, 199, 393, 97, 3, 379, 375, 371, 367, 363, 359, 355, 351, 347, 43, 85, 337, 333, 165, 327, 323, 5, 317, 157, 311, 77, 305, 303, 75, 297, 294, 73, 289, 287, 71, 141, 279, 277, 275, 68, 135, 67, 133, 33, 262, 260, 129, 511, 507, 503, 499, 495, 491, 61, 121, 481, 477, 237, 235, 467, 232, 115, 457, 227, 451, 7, 445, 221, 439, 218, 433, 215, 427, 425, 211, 419, 417, 207, 411, 409, 203, 202, 401, 399, 396, 197, 49, 389, 387, 385, 383, 95, 189, 47, 187, 93, 185, 23, 183, 91, 181, 45, 179, 89, 177, 11, 175, 87, 173, 345, 343, 341, 339, 337, 21, 167, 83, 331, 329, 327, 163, 81, 323, 321, 319, 159, 79, 315, 313, 39, 155, 309, 307, 153, 305, 303, 151, 75, 299, 149, 37, 295, 147, 73, 291, 145, 289, 287, 143, 285, 71, 141, 281, 35, 279, 139, 69, 275, 137, 273, 17, 271, 135, 269, 267, 133, 265, 33, 263, 131, 261, 130, 259, 129, 257, 1], a.SHG_TABLE = [0, 9, 10, 11, 9, 12, 10, 11, 12, 9, 13, 13, 10, 9, 13, 13, 14, 14, 14, 14, 10, 13, 14, 14, 14, 13, 13, 13, 9, 14, 14, 14, 15, 14, 15, 14, 15, 15, 14, 15, 15, 15, 14, 15, 15, 15, 15, 15, 14, 15, 15, 15, 15, 15, 15, 12, 14, 15, 15, 13, 15, 15, 15, 15, 16, 16, 16, 15, 16, 14, 16, 16, 14, 16, 13, 16, 16, 16, 15, 16, 13, 16, 15, 16, 14, 9, 16, 16, 16, 16, 16, 16, 16, 16, 16, 13, 14, 16, 16, 15, 16, 16, 10, 16, 15, 16, 14, 16, 16, 14, 16, 16, 14, 16, 16, 14, 15, 16, 16, 16, 14, 15, 14, 15, 13, 16, 16, 15, 17, 17, 17, 17, 17, 17, 14, 15, 17, 17, 16, 16, 17, 16, 15, 17, 16, 17, 11, 17, 16, 17, 16, 17, 16, 17, 17, 16, 17, 17, 16, 17, 17, 16, 16, 17, 17, 17, 16, 14, 17, 17, 17, 17, 15, 16, 14, 16, 15, 16, 13, 16, 15, 16, 14, 16, 15, 16, 12, 16, 15, 16, 17, 17, 17, 17, 17, 13, 16, 15, 17, 17, 17, 16, 15, 17, 17, 17, 16, 15, 17, 17, 14, 16, 17, 17, 16, 17, 17, 16, 15, 17, 16, 14, 17, 16, 15, 17, 16, 17, 17, 16, 17, 15, 16, 17, 14, 17, 16, 15, 17, 16, 17, 13, 17, 16, 17, 17, 16, 17, 14, 17, 16, 17, 16, 17, 16, 17, 9], b.getBounds = function(a) {
      var b = 0 | this.blurX,
        c = 0 | this.blurY;
      if (0 >= b && 0 >= c) return a;
      var d = Math.pow(this.quality, .2);
      return (a || new createjs.Rectangle).pad(c * d + 1, b * d + 1, c * d + 1, b * d + 1)
    }, b.clone = function() {
      return new a(this.blurX, this.blurY, this.quality)
    }, b.toString = function() {
      return "[BlurFilter]"
    }, b._applyFilter = function(b) {
      var c = this._blurX >> 1;
      if (isNaN(c) || 0 > c) return !1;
      var d = this._blurY >> 1;
      if (isNaN(d) || 0 > d) return !1;
      if (0 == c && 0 == d) return !1;
      var e = this.quality;
      (isNaN(e) || 1 > e) && (e = 1), e |= 0, e > 3 && (e = 3), 1 > e && (e = 1);
      var f = b.data,
        g = 0,
        h = 0,
        i = 0,
        j = 0,
        k = 0,
        l = 0,
        m = 0,
        n = 0,
        o = 0,
        p = 0,
        q = 0,
        r = 0,
        s = 0,
        t = 0,
        u = 0,
        v = c + c + 1 | 0,
        w = d + d + 1 | 0,
        x = 0 | b.width,
        y = 0 | b.height,
        z = x - 1 | 0,
        A = y - 1 | 0,
        B = c + 1 | 0,
        C = d + 1 | 0,
        D = {
          r: 0,
          b: 0,
          g: 0,
          a: 0
        },
        E = D;
      for (i = 1; v > i; i++) E = E.n = {
        r: 0,
        b: 0,
        g: 0,
        a: 0
      };
      E.n = D;
      var F = {
          r: 0,
          b: 0,
          g: 0,
          a: 0
        },
        G = F;
      for (i = 1; w > i; i++) G = G.n = {
        r: 0,
        b: 0,
        g: 0,
        a: 0
      };
      G.n = F;
      for (var H = null, I = 0 | a.MUL_TABLE[c], J = 0 | a.SHG_TABLE[c], K = 0 | a.MUL_TABLE[d], L = 0 | a.SHG_TABLE[d]; e-- > 0;) {
        m = l = 0;
        var M = I,
          N = J;
        for (h = y; --h > -1;) {
          for (n = B * (r = f[0 | l]), o = B * (s = f[l + 1 | 0]), p = B * (t = f[l + 2 | 0]), q = B * (u = f[l + 3 | 0]), E = D, i = B; --i > -1;) E.r = r, E.g = s, E.b = t, E.a = u, E = E.n;
          for (i = 1; B > i; i++) j = l + ((i > z ? z : i) << 2) | 0, n += E.r = f[j], o += E.g = f[j + 1], p += E.b = f[j + 2], q += E.a = f[j + 3], E = E.n;
          for (H = D, g = 0; x > g; g++) f[l++] = n * M >>> N, f[l++] = o * M >>> N, f[l++] = p * M >>> N, f[l++] = q * M >>> N, j = m + ((j = g + c + 1) < z ? j : z) << 2, n -= H.r - (H.r = f[j]), o -= H.g - (H.g = f[j + 1]), p -= H.b - (H.b = f[j + 2]), q -= H.a - (H.a = f[j + 3]), H = H.n;
          m += x
        }
        for (M = K, N = L, g = 0; x > g; g++) {
          for (l = g << 2 | 0, n = C * (r = f[l]) | 0, o = C * (s = f[l + 1 | 0]) | 0, p = C * (t = f[l + 2 | 0]) | 0, q = C * (u = f[l + 3 | 0]) | 0, G = F, i = 0; C > i; i++) G.r = r, G.g = s, G.b = t, G.a = u, G = G.n;
          for (k = x, i = 1; d >= i; i++) l = k + g << 2, n += G.r = f[l], o += G.g = f[l + 1], p += G.b = f[l + 2], q += G.a = f[l + 3], G = G.n, A > i && (k += x);
          if (l = g, H = F, e > 0)
            for (h = 0; y > h; h++) j = l << 2, f[j + 3] = u = q * M >>> N, u > 0 ? (f[j] = n * M >>> N, f[j + 1] = o * M >>> N, f[j + 2] = p * M >>> N) : f[j] = f[j + 1] = f[j + 2] = 0, j = g + ((j = h + C) < A ? j : A) * x << 2, n -= H.r - (H.r = f[j]), o -= H.g - (H.g = f[j + 1]), p -= H.b - (H.b = f[j + 2]), q -= H.a - (H.a = f[j + 3]), H = H.n, l += x;
          else
            for (h = 0; y > h; h++) j = l << 2, f[j + 3] = u = q * M >>> N, u > 0 ? (u = 255 / u, f[j] = (n * M >>> N) * u, f[j + 1] = (o * M >>> N) * u, f[j + 2] = (p * M >>> N) * u) : f[j] = f[j + 1] = f[j + 2] = 0, j = g + ((j = h + C) < A ? j : A) * x << 2, n -= H.r - (H.r = f[j]), o -= H.g - (H.g = f[j + 1]), p -= H.b - (H.b = f[j + 2]), q -= H.a - (H.a = f[j + 3]), H = H.n, l += x
        }
      }
      return !0
    }, createjs.BlurFilter = createjs.promote(a, "Filter")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.Filter_constructor(), this.alphaMap = a, this._alphaMap = null, this._mapData = null, this._mapTexture = null, this.FRAG_SHADER_BODY = "uniform sampler2D uAlphaSampler;void main(void) {vec4 color = texture2D(uSampler, vRenderCoord);vec4 alphaMap = texture2D(uAlphaSampler, vTextureCoord);gl_FragColor = vec4(color.rgb, color.a * (alphaMap.r * ceil(alphaMap.a)));}"
    }
    var b = createjs.extend(a, createjs.Filter);
    b.shaderParamSetup = function(a, b, c) {
      this._mapTexture || (this._mapTexture = a.createTexture()), a.activeTexture(a.TEXTURE1), a.bindTexture(a.TEXTURE_2D, this._mapTexture), b.setTextureParams(a), a.texImage2D(a.TEXTURE_2D, 0, a.RGBA, a.RGBA, a.UNSIGNED_BYTE, this.alphaMap), a.uniform1i(a.getUniformLocation(c, "uAlphaSampler"), 1)
    }, b.clone = function() {
      var b = new a(this.alphaMap);
      return b._alphaMap = this._alphaMap, b._mapData = this._mapData, b
    }, b.toString = function() {
      return "[AlphaMapFilter]"
    }, b._applyFilter = function(a) {
      if (!this.alphaMap) return !0;
      if (!this._prepAlphaMap()) return !1;
      for (var b = a.data, c = this._mapData, d = 0, e = b.length; e > d; d += 4) b[d + 3] = c[d] || 0;
      return !0
    }, b._prepAlphaMap = function() {
      if (!this.alphaMap) return !1;
      if (this.alphaMap == this._alphaMap && this._mapData) return !0;
      this._mapData = null;
      var a, b = this._alphaMap = this.alphaMap,
        c = b;
      b instanceof HTMLCanvasElement ? a = c.getContext("2d") : (c = createjs.createCanvas ? createjs.createCanvas() : document.createElement("canvas"), c.width = b.width, c.height = b.height, a = c.getContext("2d"), a.drawImage(b, 0, 0));
      try {
        var d = a.getImageData(0, 0, b.width, b.height)
      } catch (e) {
        return !1
      }
      return this._mapData = d.data, !0
    }, createjs.AlphaMapFilter = createjs.promote(a, "Filter")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.Filter_constructor(), this.mask = a, this.usesContext = !0, this.FRAG_SHADER_BODY = "uniform sampler2D uAlphaSampler;void main(void) {vec4 color = texture2D(uSampler, vRenderCoord);vec4 alphaMap = texture2D(uAlphaSampler, vTextureCoord);gl_FragColor = vec4(color.rgb, color.a * alphaMap.a);}"
    }
    var b = createjs.extend(a, createjs.Filter);
    b.shaderParamSetup = function(a, b, c) {
      this._mapTexture || (this._mapTexture = a.createTexture()), a.activeTexture(a.TEXTURE1), a.bindTexture(a.TEXTURE_2D, this._mapTexture), b.setTextureParams(a), a.texImage2D(a.TEXTURE_2D, 0, a.RGBA, a.RGBA, a.UNSIGNED_BYTE, this.mask), a.uniform1i(a.getUniformLocation(c, "uAlphaSampler"), 1)
    }, b.applyFilter = function(a, b, c, d, e, f, g, h) {
      return this.mask ? (f = f || a, null == g && (g = b), null == h && (h = c), f.save(), a != f ? !1 : (f.globalCompositeOperation = "destination-in", f.drawImage(this.mask, g, h), f.restore(), !0)) : !0
    }, b.clone = function() {
      return new a(this.mask)
    }, b.toString = function() {
      return "[AlphaMaskFilter]"
    }, createjs.AlphaMaskFilter = createjs.promote(a, "Filter")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c, d, e, f, g, h) {
      this.Filter_constructor(), this.redMultiplier = null != a ? a : 1, this.greenMultiplier = null != b ? b : 1, this.blueMultiplier = null != c ? c : 1, this.alphaMultiplier = null != d ? d : 1, this.redOffset = e || 0, this.greenOffset = f || 0, this.blueOffset = g || 0, this.alphaOffset = h || 0, this.FRAG_SHADER_BODY = "uniform vec4 uColorMultiplier;uniform vec4 uColorOffset;void main(void) {vec4 color = texture2D(uSampler, vRenderCoord);gl_FragColor = (color * uColorMultiplier) + uColorOffset;}"
    }
    var b = createjs.extend(a, createjs.Filter);
    b.shaderParamSetup = function(a, b, c) {
      a.uniform4f(a.getUniformLocation(c, "uColorMultiplier"), this.redMultiplier, this.greenMultiplier, this.blueMultiplier, this.alphaMultiplier), a.uniform4f(a.getUniformLocation(c, "uColorOffset"), this.redOffset / 255, this.greenOffset / 255, this.blueOffset / 255, this.alphaOffset / 255)
    }, b.toString = function() {
      return "[ColorFilter]"
    }, b.clone = function() {
      return new a(this.redMultiplier, this.greenMultiplier, this.blueMultiplier, this.alphaMultiplier, this.redOffset, this.greenOffset, this.blueOffset, this.alphaOffset)
    }, b._applyFilter = function(a) {
      for (var b = a.data, c = b.length, d = 0; c > d; d += 4) b[d] = b[d] * this.redMultiplier + this.redOffset, b[d + 1] = b[d + 1] * this.greenMultiplier + this.greenOffset, b[d + 2] = b[d + 2] * this.blueMultiplier + this.blueOffset, b[d + 3] = b[d + 3] * this.alphaMultiplier + this.alphaOffset;
      return !0
    }, createjs.ColorFilter = createjs.promote(a, "Filter")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c, d) {
      this.setColor(a, b, c, d)
    }
    var b = a.prototype;
    a.DELTA_INDEX = [0, .01, .02, .04, .05, .06, .07, .08, .1, .11, .12, .14, .15, .16, .17, .18, .2, .21, .22, .24, .25, .27, .28, .3, .32, .34, .36, .38, .4, .42, .44, .46, .48, .5, .53, .56, .59, .62, .65, .68, .71, .74, .77, .8, .83, .86, .89, .92, .95, .98, 1, 1.06, 1.12, 1.18, 1.24, 1.3, 1.36, 1.42, 1.48, 1.54, 1.6, 1.66, 1.72, 1.78, 1.84, 1.9, 1.96, 2, 2.12, 2.25, 2.37, 2.5, 2.62, 2.75, 2.87, 3, 3.2, 3.4, 3.6, 3.8, 4, 4.3, 4.7, 4.9, 5, 5.5, 6, 6.5, 6.8, 7, 7.3, 7.5, 7.8, 8, 8.4, 8.7, 9, 9.4, 9.6, 9.8, 10], a.IDENTITY_MATRIX = [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1], a.LENGTH = a.IDENTITY_MATRIX.length, b.setColor = function(a, b, c, d) {
      return this.reset().adjustColor(a, b, c, d)
    }, b.reset = function() {
      return this.copy(a.IDENTITY_MATRIX)
    }, b.adjustColor = function(a, b, c, d) {
      return this.adjustHue(d), this.adjustContrast(b), this.adjustBrightness(a), this.adjustSaturation(c)
    }, b.adjustBrightness = function(a) {
      return 0 == a || isNaN(a) ? this : (a = this._cleanValue(a, 255), this._multiplyMatrix([1, 0, 0, 0, a, 0, 1, 0, 0, a, 0, 0, 1, 0, a, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1]), this)
    }, b.adjustContrast = function(b) {
      if (0 == b || isNaN(b)) return this;
      b = this._cleanValue(b, 100);
      var c;
      return 0 > b ? c = 127 + b / 100 * 127 : (c = b % 1, c = 0 == c ? a.DELTA_INDEX[b] : a.DELTA_INDEX[b << 0] * (1 - c) + a.DELTA_INDEX[(b << 0) + 1] * c, c = 127 * c + 127), this._multiplyMatrix([c / 127, 0, 0, 0, .5 * (127 - c), 0, c / 127, 0, 0, .5 * (127 - c), 0, 0, c / 127, 0, .5 * (127 - c), 0, 0, 0, 1, 0, 0, 0, 0, 0, 1]), this
    }, b.adjustSaturation = function(a) {
      if (0 == a || isNaN(a)) return this;
      a = this._cleanValue(a, 100);
      var b = 1 + (a > 0 ? 3 * a / 100 : a / 100),
        c = .3086,
        d = .6094,
        e = .082;
      return this._multiplyMatrix([c * (1 - b) + b, d * (1 - b), e * (1 - b), 0, 0, c * (1 - b), d * (1 - b) + b, e * (1 - b), 0, 0, c * (1 - b), d * (1 - b), e * (1 - b) + b, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1]), this
    }, b.adjustHue = function(a) {
      if (0 == a || isNaN(a)) return this;
      a = this._cleanValue(a, 180) / 180 * Math.PI;
      var b = Math.cos(a),
        c = Math.sin(a),
        d = .213,
        e = .715,
        f = .072;
      return this._multiplyMatrix([d + b * (1 - d) + c * -d, e + b * -e + c * -e, f + b * -f + c * (1 - f), 0, 0, d + b * -d + .143 * c, e + b * (1 - e) + .14 * c, f + b * -f + c * -.283, 0, 0, d + b * -d + c * -(1 - d), e + b * -e + c * e, f + b * (1 - f) + c * f, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1]), this
    }, b.concat = function(b) {
      return b = this._fixMatrix(b), b.length != a.LENGTH ? this : (this._multiplyMatrix(b), this)
    }, b.clone = function() {
      return (new a).copy(this)
    }, b.toArray = function() {
      for (var b = [], c = 0, d = a.LENGTH; d > c; c++) b[c] = this[c];
      return b
    }, b.copy = function(b) {
      for (var c = a.LENGTH, d = 0; c > d; d++) this[d] = b[d];
      return this
    }, b.toString = function() {
      return "[ColorMatrix]"
    }, b._multiplyMatrix = function(a) {
      var b, c, d, e = [];
      for (b = 0; 5 > b; b++) {
        for (c = 0; 5 > c; c++) e[c] = this[c + 5 * b];
        for (c = 0; 5 > c; c++) {
          var f = 0;
          for (d = 0; 5 > d; d++) f += a[c + 5 * d] * e[d];
          this[c + 5 * b] = f
        }
      }
    }, b._cleanValue = function(a, b) {
      return Math.min(b, Math.max(-b, a))
    }, b._fixMatrix = function(b) {
      return b instanceof a && (b = b.toArray()), b.length < a.LENGTH ? b = b.slice(0, b.length).concat(a.IDENTITY_MATRIX.slice(b.length, a.LENGTH)) : b.length > a.LENGTH && (b = b.slice(0, a.LENGTH)), b
    }, createjs.ColorMatrix = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.Filter_constructor(), this.matrix = a, this.FRAG_SHADER_BODY = "uniform mat4 uColorMatrix;uniform vec4 uColorMatrixOffset;void main(void) {vec4 color = texture2D(uSampler, vRenderCoord);mat4 m = uColorMatrix;vec4 newColor = vec4(0,0,0,0);newColor.r = color.r*m[0][0] + color.g*m[0][1] + color.b*m[0][2] + color.a*m[0][3];newColor.g = color.r*m[1][0] + color.g*m[1][1] + color.b*m[1][2] + color.a*m[1][3];newColor.b = color.r*m[2][0] + color.g*m[2][1] + color.b*m[2][2] + color.a*m[2][3];newColor.a = color.r*m[3][0] + color.g*m[3][1] + color.b*m[3][2] + color.a*m[3][3];gl_FragColor = newColor + uColorMatrixOffset;}"
    }
    var b = createjs.extend(a, createjs.Filter);
    b.shaderParamSetup = function(a, b, c) {
      var d = this.matrix,
        e = new Float32Array([d[0], d[1], d[2], d[3], d[5], d[6], d[7], d[8], d[10], d[11], d[12], d[13], d[15], d[16], d[17], d[18]]);
      a.uniformMatrix4fv(a.getUniformLocation(c, "uColorMatrix"), !1, e), a.uniform4f(a.getUniformLocation(c, "uColorMatrixOffset"), d[4] / 255, d[9] / 255, d[14] / 255, d[19] / 255)
    }, b.toString = function() {
      return "[ColorMatrixFilter]"
    }, b.clone = function() {
      return new a(this.matrix)
    }, b._applyFilter = function(a) {
      for (var b, c, d, e, f = a.data, g = f.length, h = this.matrix, i = h[0], j = h[1], k = h[2], l = h[3], m = h[4], n = h[5], o = h[6], p = h[7], q = h[8], r = h[9], s = h[10], t = h[11], u = h[12], v = h[13], w = h[14], x = h[15], y = h[16], z = h[17], A = h[18], B = h[19], C = 0; g > C; C += 4) b = f[C], c = f[C + 1], d = f[C + 2], e = f[C + 3], f[C] = b * i + c * j + d * k + e * l + m, f[C + 1] = b * n + c * o + d * p + e * q + r, f[C + 2] = b * s + c * t + d * u + e * v + w, f[C + 3] = b * x + c * y + d * z + e * A + B;
      return !0
    }, createjs.ColorMatrixFilter = createjs.promote(a, "Filter")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      throw "Touch cannot be instantiated"
    }
    a.isSupported = function() {
      return !!("ontouchstart" in window || window.navigator.msPointerEnabled && window.navigator.msMaxTouchPoints > 0 || window.navigator.pointerEnabled && window.navigator.maxTouchPoints > 0)
    }, a.enable = function(b, c, d) {
      return b && b.canvas && a.isSupported() ? b.__touch ? !0 : (b.__touch = {
        pointers: {},
        multitouch: !c,
        preventDefault: !d,
        count: 0
      }, "ontouchstart" in window ? a._IOS_enable(b) : (window.navigator.msPointerEnabled || window.navigator.pointerEnabled) && a._IE_enable(b), !0) : !1
    }, a.disable = function(b) {
      b && ("ontouchstart" in window ? a._IOS_disable(b) : (window.navigator.msPointerEnabled || window.navigator.pointerEnabled) && a._IE_disable(b), delete b.__touch)
    }, a._IOS_enable = function(b) {
      var c = b.canvas,
        d = b.__touch.f = function(c) {
          a._IOS_handleEvent(b, c)
        };
      c.addEventListener("touchstart", d, !1), c.addEventListener("touchmove", d, !1), c.addEventListener("touchend", d, !1), c.addEventListener("touchcancel", d, !1)
    }, a._IOS_disable = function(a) {
      var b = a.canvas;
      if (b) {
        var c = a.__touch.f;
        b.removeEventListener("touchstart", c, !1), b.removeEventListener("touchmove", c, !1), b.removeEventListener("touchend", c, !1), b.removeEventListener("touchcancel", c, !1)
      }
    }, a._IOS_handleEvent = function(a, b) {
      if (a) {
        a.__touch.preventDefault && b.preventDefault && b.preventDefault();
        for (var c = b.changedTouches, d = b.type, e = 0, f = c.length; f > e; e++) {
          var g = c[e],
            h = g.identifier;
          g.target == a.canvas && ("touchstart" == d ? this._handleStart(a, h, b, g.pageX, g.pageY) : "touchmove" == d ? this._handleMove(a, h, b, g.pageX, g.pageY) : ("touchend" == d || "touchcancel" == d) && this._handleEnd(a, h, b))
        }
      }
    }, a._IE_enable = function(b) {
      var c = b.canvas,
        d = b.__touch.f = function(c) {
          a._IE_handleEvent(b, c)
        };
      void 0 === window.navigator.pointerEnabled ? (c.addEventListener("MSPointerDown", d, !1), window.addEventListener("MSPointerMove", d, !1), window.addEventListener("MSPointerUp", d, !1), window.addEventListener("MSPointerCancel", d, !1), b.__touch.preventDefault && (c.style.msTouchAction = "none")) : (c.addEventListener("pointerdown", d, !1), window.addEventListener("pointermove", d, !1), window.addEventListener("pointerup", d, !1), window.addEventListener("pointercancel", d, !1), b.__touch.preventDefault && (c.style.touchAction = "none")), b.__touch.activeIDs = {}
    }, a._IE_disable = function(a) {
      var b = a.__touch.f;
      void 0 === window.navigator.pointerEnabled ? (window.removeEventListener("MSPointerMove", b, !1), window.removeEventListener("MSPointerUp", b, !1), window.removeEventListener("MSPointerCancel", b, !1), a.canvas && a.canvas.removeEventListener("MSPointerDown", b, !1)) : (window.removeEventListener("pointermove", b, !1), window.removeEventListener("pointerup", b, !1), window.removeEventListener("pointercancel", b, !1), a.canvas && a.canvas.removeEventListener("pointerdown", b, !1))
    }, a._IE_handleEvent = function(a, b) {
      if (a) {
        a.__touch.preventDefault && b.preventDefault && b.preventDefault();
        var c = b.type,
          d = b.pointerId,
          e = a.__touch.activeIDs;
        if ("MSPointerDown" == c || "pointerdown" == c) {
          if (b.srcElement != a.canvas) return;
          e[d] = !0, this._handleStart(a, d, b, b.pageX, b.pageY)
        } else e[d] && ("MSPointerMove" == c || "pointermove" == c ? this._handleMove(a, d, b, b.pageX, b.pageY) : ("MSPointerUp" == c || "MSPointerCancel" == c || "pointerup" == c || "pointercancel" == c) && (delete e[d], this._handleEnd(a, d, b)))
      }
    }, a._handleStart = function(a, b, c, d, e) {
      var f = a.__touch;
      if (f.multitouch || !f.count) {
        var g = f.pointers;
        g[b] || (g[b] = !0, f.count++, a._handlePointerDown(b, c, d, e))
      }
    }, a._handleMove = function(a, b, c, d, e) {
      a.__touch.pointers[b] && a._handlePointerMove(b, c, d, e)
    }, a._handleEnd = function(a, b, c) {
      var d = a.__touch,
        e = d.pointers;
      e[b] && (d.count--, a._handlePointerUp(b, c, !0), delete e[b])
    }, createjs.Touch = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";
    var a = createjs.EaselJS = createjs.EaselJS || {};
    a.version = "NEXT", a.buildDate = "Thu, 14 Sep 2017 22:19:48 GMT"
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";
    var a = createjs.PreloadJS = createjs.PreloadJS || {};
    a.version = "NEXT", a.buildDate = "Thu, 14 Sep 2017 22:19:45 GMT"
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";
    createjs.proxy = function(a, b) {
      var c = Array.prototype.slice.call(arguments, 2);
      return function() {
        return a.apply(b, Array.prototype.slice.call(arguments, 0).concat(c))
      }
    }
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c) {
      this.Event_constructor("error"), this.title = a, this.message = b, this.data = c
    }
    var b = createjs.extend(a, createjs.Event);
    b.clone = function() {
      return new createjs.ErrorEvent(this.title, this.message, this.data)
    }, createjs.ErrorEvent = createjs.promote(a, "Event")
  }(), this.createjs = this.createjs || {},
  function(a) {
    "use strict";

    function b(a, b) {
      this.Event_constructor("progress"), this.loaded = a, this.total = null == b ? 1 : b, this.progress = 0 == b ? 0 : this.loaded / this.total;
    }
    var c = createjs.extend(b, createjs.Event);
    c.clone = function() {
      return new createjs.ProgressEvent(this.loaded, this.total)
    }, createjs.ProgressEvent = createjs.promote(b, "Event")
  }(window),
  function() {
    function a(b, d) {
      function f(a) {
        if (f[a] !== q) return f[a];
        var b;
        if ("bug-string-char-index" == a) b = "a" != "a" [0];
        else if ("json" == a) b = f("json-stringify") && f("json-parse");
        else {
          var c, e = '{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';
          if ("json-stringify" == a) {
            var i = d.stringify,
              k = "function" == typeof i && t;
            if (k) {
              (c = function() {
                return 1
              }).toJSON = c;
              try {
                k = "0" === i(0) && "0" === i(new g) && '""' == i(new h) && i(s) === q && i(q) === q && i() === q && "1" === i(c) && "[1]" == i([c]) && "[null]" == i([q]) && "null" == i(null) && "[null,null,null]" == i([q, s, null]) && i({
                  a: [c, !0, !1, null, "\x00\b\n\f\r "]
                }) == e && "1" === i(null, c) && "[\n 1,\n 2\n]" == i([1, 2], null, 1) && '"-271821-04-20T00:00:00.000Z"' == i(new j(-864e13)) && '"+275760-09-13T00:00:00.000Z"' == i(new j(864e13)) && '"-000001-01-01T00:00:00.000Z"' == i(new j(-621987552e5)) && '"1969-12-31T23:59:59.999Z"' == i(new j(-1))
              } catch (l) {
                k = !1
              }
            }
            b = k
          }
          if ("json-parse" == a) {
            var m = d.parse;
            if ("function" == typeof m) try {
              if (0 === m("0") && !m(!1)) {
                c = m(e);
                var n = 5 == c.a.length && 1 === c.a[0];
                if (n) {
                  try {
                    n = !m('" "')
                  } catch (l) {}
                  if (n) try {
                    n = 1 !== m("01")
                  } catch (l) {}
                  if (n) try {
                    n = 1 !== m("1.")
                  } catch (l) {}
                }
              }
            } catch (l) {
              n = !1
            }
            b = n
          }
        }
        return f[a] = !!b
      }
      b || (b = e.Object()), d || (d = e.Object());
      var g = b.Number || e.Number,
        h = b.String || e.String,
        i = b.Object || e.Object,
        j = b.Date || e.Date,
        k = b.SyntaxError || e.SyntaxError,
        l = b.TypeError || e.TypeError,
        m = b.Math || e.Math,
        n = b.JSON || e.JSON;
      "object" == typeof n && n && (d.stringify = n.stringify, d.parse = n.parse);
      var o, p, q, r = i.prototype,
        s = r.toString,
        t = new j(-0xc782b5b800cec);
      try {
        t = -109252 == t.getUTCFullYear() && 0 === t.getUTCMonth() && 1 === t.getUTCDate() && 10 == t.getUTCHours() && 37 == t.getUTCMinutes() && 6 == t.getUTCSeconds() && 708 == t.getUTCMilliseconds()
      } catch (u) {}
      if (!f("json")) {
        var v = "[object Function]",
          w = "[object Date]",
          x = "[object Number]",
          y = "[object String]",
          z = "[object Array]",
          A = "[object Boolean]",
          B = f("bug-string-char-index");
        if (!t) var C = m.floor,
          D = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334],
          E = function(a, b) {
            return D[b] + 365 * (a - 1970) + C((a - 1969 + (b = +(b > 1))) / 4) - C((a - 1901 + b) / 100) + C((a - 1601 + b) / 400)
          };
        if ((o = r.hasOwnProperty) || (o = function(a) {
            var b, c = {};
            return (c.__proto__ = null, c.__proto__ = {
              toString: 1
            }, c).toString != s ? o = function(a) {
              var b = this.__proto__,
                c = a in (this.__proto__ = null, this);
              return this.__proto__ = b, c
            } : (b = c.constructor, o = function(a) {
              var c = (this.constructor || b).prototype;
              return a in this && !(a in c && this[a] === c[a])
            }), c = null, o.call(this, a)
          }), p = function(a, b) {
            var d, e, f, g = 0;
            (d = function() {
              this.valueOf = 0
            }).prototype.valueOf = 0, e = new d;
            for (f in e) o.call(e, f) && g++;
            return d = e = null, g ? p = 2 == g ? function(a, b) {
              var c, d = {},
                e = s.call(a) == v;
              for (c in a) e && "prototype" == c || o.call(d, c) || !(d[c] = 1) || !o.call(a, c) || b(c)
            } : function(a, b) {
              var c, d, e = s.call(a) == v;
              for (c in a) e && "prototype" == c || !o.call(a, c) || (d = "constructor" === c) || b(c);
              (d || o.call(a, c = "constructor")) && b(c)
            } : (e = ["valueOf", "toString", "toLocaleString", "propertyIsEnumerable", "isPrototypeOf", "hasOwnProperty", "constructor"], p = function(a, b) {
              var d, f, g = s.call(a) == v,
                h = !g && "function" != typeof a.constructor && c[typeof a.hasOwnProperty] && a.hasOwnProperty || o;
              for (d in a) g && "prototype" == d || !h.call(a, d) || b(d);
              for (f = e.length; d = e[--f]; h.call(a, d) && b(d));
            }), p(a, b)
          }, !f("json-stringify")) {
          var F = {
              92: "\\\\",
              34: '\\"',
              8: "\\b",
              12: "\\f",
              10: "\\n",
              13: "\\r",
              9: "\\t"
            },
            G = "000000",
            H = function(a, b) {
              return (G + (b || 0)).slice(-a)
            },
            I = "\\u00",
            J = function(a) {
              for (var b = '"', c = 0, d = a.length, e = !B || d > 10, f = e && (B ? a.split("") : a); d > c; c++) {
                var g = a.charCodeAt(c);
                switch (g) {
                  case 8:
                  case 9:
                  case 10:
                  case 12:
                  case 13:
                  case 34:
                  case 92:
                    b += F[g];
                    break;
                  default:
                    if (32 > g) {
                      b += I + H(2, g.toString(16));
                      break
                    }
                    b += e ? f[c] : a.charAt(c)
                }
              }
              return b + '"'
            },
            K = function(a, b, c, d, e, f, g) {
              var h, i, j, k, m, n, r, t, u, v, B, D, F, G, I, L;
              try {
                h = b[a]
              } catch (M) {}
              if ("object" == typeof h && h)
                if (i = s.call(h), i != w || o.call(h, "toJSON")) "function" == typeof h.toJSON && (i != x && i != y && i != z || o.call(h, "toJSON")) && (h = h.toJSON(a));
                else if (h > -1 / 0 && 1 / 0 > h) {
                if (E) {
                  for (m = C(h / 864e5), j = C(m / 365.2425) + 1970 - 1; E(j + 1, 0) <= m; j++);
                  for (k = C((m - E(j, 0)) / 30.42); E(j, k + 1) <= m; k++);
                  m = 1 + m - E(j, k), n = (h % 864e5 + 864e5) % 864e5, r = C(n / 36e5) % 24, t = C(n / 6e4) % 60, u = C(n / 1e3) % 60, v = n % 1e3
                } else j = h.getUTCFullYear(), k = h.getUTCMonth(), m = h.getUTCDate(), r = h.getUTCHours(), t = h.getUTCMinutes(), u = h.getUTCSeconds(), v = h.getUTCMilliseconds();
                h = (0 >= j || j >= 1e4 ? (0 > j ? "-" : "+") + H(6, 0 > j ? -j : j) : H(4, j)) + "-" + H(2, k + 1) + "-" + H(2, m) + "T" + H(2, r) + ":" + H(2, t) + ":" + H(2, u) + "." + H(3, v) + "Z"
              } else h = null;
              if (c && (h = c.call(b, a, h)), null === h) return "null";
              if (i = s.call(h), i == A) return "" + h;
              if (i == x) return h > -1 / 0 && 1 / 0 > h ? "" + h : "null";
              if (i == y) return J("" + h);
              if ("object" == typeof h) {
                for (G = g.length; G--;)
                  if (g[G] === h) throw l();
                if (g.push(h), B = [], I = f, f += e, i == z) {
                  for (F = 0, G = h.length; G > F; F++) D = K(F, h, c, d, e, f, g), B.push(D === q ? "null" : D);
                  L = B.length ? e ? "[\n" + f + B.join(",\n" + f) + "\n" + I + "]" : "[" + B.join(",") + "]" : "[]"
                } else p(d || h, function(a) {
                  var b = K(a, h, c, d, e, f, g);
                  b !== q && B.push(J(a) + ":" + (e ? " " : "") + b)
                }), L = B.length ? e ? "{\n" + f + B.join(",\n" + f) + "\n" + I + "}" : "{" + B.join(",") + "}" : "{}";
                return g.pop(), L
              }
            };
          d.stringify = function(a, b, d) {
            var e, f, g, h;
            if (c[typeof b] && b)
              if ((h = s.call(b)) == v) f = b;
              else if (h == z) {
              g = {};
              for (var i, j = 0, k = b.length; k > j; i = b[j++], h = s.call(i), (h == y || h == x) && (g[i] = 1));
            }
            if (d)
              if ((h = s.call(d)) == x) {
                if ((d -= d % 1) > 0)
                  for (e = "", d > 10 && (d = 10); e.length < d; e += " ");
              } else h == y && (e = d.length <= 10 ? d : d.slice(0, 10));
            return K("", (i = {}, i[""] = a, i), f, g, e, "", [])
          }
        }
        if (!f("json-parse")) {
          var L, M, N = h.fromCharCode,
            O = {
              92: "\\",
              34: '"',
              47: "/",
              98: "\b",
              116: " ",
              110: "\n",
              102: "\f",
              114: "\r"
            },
            P = function() {
              throw L = M = null, k()
            },
            Q = function() {
              for (var a, b, c, d, e, f = M, g = f.length; g > L;) switch (e = f.charCodeAt(L)) {
                case 9:
                case 10:
                case 13:
                case 32:
                  L++;
                  break;
                case 123:
                case 125:
                case 91:
                case 93:
                case 58:
                case 44:
                  return a = B ? f.charAt(L) : f[L], L++, a;
                case 34:
                  for (a = "@", L++; g > L;)
                    if (e = f.charCodeAt(L), 32 > e) P();
                    else if (92 == e) switch (e = f.charCodeAt(++L)) {
                    case 92:
                    case 34:
                    case 47:
                    case 98:
                    case 116:
                    case 110:
                    case 102:
                    case 114:
                      a += O[e], L++;
                      break;
                    case 117:
                      for (b = ++L, c = L + 4; c > L; L++) e = f.charCodeAt(L), e >= 48 && 57 >= e || e >= 97 && 102 >= e || e >= 65 && 70 >= e || P();
                      a += N("0x" + f.slice(b, L));
                      break;
                    default:
                      P()
                  } else {
                    if (34 == e) break;
                    for (e = f.charCodeAt(L), b = L; e >= 32 && 92 != e && 34 != e;) e = f.charCodeAt(++L);
                    a += f.slice(b, L)
                  }
                  if (34 == f.charCodeAt(L)) return L++, a;
                  P();
                default:
                  if (b = L, 45 == e && (d = !0, e = f.charCodeAt(++L)), e >= 48 && 57 >= e) {
                    for (48 == e && (e = f.charCodeAt(L + 1), e >= 48 && 57 >= e) && P(), d = !1; g > L && (e = f.charCodeAt(L), e >= 48 && 57 >= e); L++);
                    if (46 == f.charCodeAt(L)) {
                      for (c = ++L; g > c && (e = f.charCodeAt(c), e >= 48 && 57 >= e); c++);
                      c == L && P(), L = c
                    }
                    if (e = f.charCodeAt(L), 101 == e || 69 == e) {
                      for (e = f.charCodeAt(++L), (43 == e || 45 == e) && L++, c = L; g > c && (e = f.charCodeAt(c), e >= 48 && 57 >= e); c++);
                      c == L && P(), L = c
                    }
                    return +f.slice(b, L)
                  }
                  if (d && P(), "true" == f.slice(L, L + 4)) return L += 4, !0;
                  if ("false" == f.slice(L, L + 5)) return L += 5, !1;
                  if ("null" == f.slice(L, L + 4)) return L += 4, null;
                  P()
              }
              return "$"
            },
            R = function(a) {
              var b, c;
              if ("$" == a && P(), "string" == typeof a) {
                if ("@" == (B ? a.charAt(0) : a[0])) return a.slice(1);
                if ("[" == a) {
                  for (b = []; a = Q(), "]" != a; c || (c = !0)) c && ("," == a ? (a = Q(), "]" == a && P()) : P()), "," == a && P(), b.push(R(a));
                  return b
                }
                if ("{" == a) {
                  for (b = {}; a = Q(), "}" != a; c || (c = !0)) c && ("," == a ? (a = Q(), "}" == a && P()) : P()), ("," == a || "string" != typeof a || "@" != (B ? a.charAt(0) : a[0]) || ":" != Q()) && P(), b[a.slice(1)] = R(Q());
                  return b
                }
                P()
              }
              return a
            },
            S = function(a, b, c) {
              var d = T(a, b, c);
              d === q ? delete a[b] : a[b] = d
            },
            T = function(a, b, c) {
              var d, e = a[b];
              if ("object" == typeof e && e)
                if (s.call(e) == z)
                  for (d = e.length; d--;) S(e, d, c);
                else p(e, function(a) {
                  S(e, a, c)
                });
              return c.call(a, b, e)
            };
          d.parse = function(a, b) {
            var c, d;
            return L = 0, M = "" + a, c = R(Q()), "$" != Q() && P(), L = M = null, b && s.call(b) == v ? T((d = {}, d[""] = c, d), "", b) : c
          }
        }
      }
      return d.runInContext = a, d
    }
    var b = "function" == typeof define && define.amd,
      c = {
        "function": !0,
        object: !0
      },
      d = c[typeof exports] && exports && !exports.nodeType && exports,
      e = c[typeof window] && window || this,
      f = d && c[typeof module] && module && !module.nodeType && "object" == typeof global && global;
    if (!f || f.global !== f && f.window !== f && f.self !== f || (e = f), d && !b) a(e, d);
    else {
      var g = e.JSON,
        h = e.JSON3,
        i = !1,
        j = a(e, e.JSON3 = {
          noConflict: function() {
            return i || (i = !0, e.JSON = g, e.JSON3 = h, g = h = null), j
          }
        });
      e.JSON = {
        parse: j.parse,
        stringify: j.stringify
      }
    }
    b && define(function() {
      return j
    })
  }.call(this),
  function() {
    var a = {};
    a.a = function() {
      return a.el("a")
    }, a.svg = function() {
      return a.el("svg")
    }, a.object = function() {
      return a.el("object")
    }, a.image = function() {
      return a.el("image")
    }, a.img = function() {
      return a.el("img")
    }, a.style = function() {
      return a.el("style")
    }, a.link = function() {
      return a.el("link")
    }, a.script = function() {
      return a.el("script")
    }, a.audio = function() {
      return a.el("audio")
    }, a.video = function() {
      return a.el("video")
    }, a.text = function(a) {
      return document.createTextNode(a)
    }, a.el = function(a) {
      return document.createElement(a)
    }, createjs.Elements = a
  }(),
  function() {
    var a = {};
    a.ABSOLUTE_PATT = /^(?:\w+:)?\/{2}/i, a.RELATIVE_PATT = /^[.\/]*?\//i, a.EXTENSION_PATT = /\/?[^\/]+\.(\w{1,5})$/i, a.parseURI = function(b) {
      var c = {
        absolute: !1,
        relative: !1,
        protocol: null,
        hostname: null,
        port: null,
        pathname: null,
        search: null,
        hash: null,
        host: null
      };
      if (null == b) return c;
      var d = createjs.Elements.a();
      d.href = b;
      for (var e in c) e in d && (c[e] = d[e]);
      var f = b.indexOf("?");
      f > -1 && (b = b.substr(0, f));
      var g;
      return a.ABSOLUTE_PATT.test(b) ? c.absolute = !0 : a.RELATIVE_PATT.test(b) && (c.relative = !0), (g = b.match(a.EXTENSION_PATT)) && (c.extension = g[1].toLowerCase()), c
    }, a.formatQueryString = function(a, b) {
      if (null == a) throw new Error("You must specify data.");
      var c = [];
      for (var d in a) c.push(d + "=" + escape(a[d]));
      return b && (c = c.concat(b)), c.join("&")
    }, a.buildURI = function(a, b) {
      if (null == b) return a;
      var c = [],
        d = a.indexOf("?");
      if (-1 != d) {
        var e = a.slice(d + 1);
        c = c.concat(e.split("&"))
      }
      return -1 != d ? a.slice(0, d) + "?" + this.formatQueryString(b, c) : a + "?" + this.formatQueryString(b, c)
    }, a.isCrossDomain = function(a) {
      var b = createjs.Elements.a();
      b.href = a.src;
      var c = createjs.Elements.a();
      c.href = location.href;
      var d = "" != b.hostname && (b.port != c.port || b.protocol != c.protocol || b.hostname != c.hostname);
      return d
    }, a.isLocal = function(a) {
      var b = createjs.Elements.a();
      return b.href = a.src, "" == b.hostname && "file:" == b.protocol
    }, createjs.URLUtils = a
  }(),
  function() {
    var a = {
      container: null
    };
    a.appendToHead = function(b) {
      a.getHead().appendChild(b)
    }, a.appendToBody = function(b) {
      if (null == a.container) {
        a.container = document.createElement("div"), a.container.id = "preloadjs-container";
        var c = a.container.style;
        c.visibility = "hidden", c.position = "absolute", c.width = a.container.style.height = "10px", c.overflow = "hidden", c.transform = c.msTransform = c.webkitTransform = c.oTransform = "translate(-10px, -10px)", a.getBody().appendChild(a.container)
      }
      a.container.appendChild(b)
    }, a.getHead = function() {
      return document.head || document.getElementsByTagName("head")[0]
    }, a.getBody = function() {
      return document.body || document.getElementsByTagName("body")[0]
    }, a.removeChild = function(a) {
      a.parent && a.parent.removeChild(a)
    }, a.isImageTag = function(a) {
      return a instanceof HTMLImageElement
    }, a.isAudioTag = function(a) {
      return window.HTMLAudioElement ? a instanceof HTMLAudioElement : !1
    }, a.isVideoTag = function(a) {
      return window.HTMLVideoElement ? a instanceof HTMLVideoElement : !1
    }, createjs.DomUtils = a
  }(),
  function() {
    var a = {};
    a.parseXML = function(a) {
      var b = null;
      try {
        if (window.DOMParser) {
          var c = new DOMParser;
          b = c.parseFromString(a, "text/xml")
        }
      } catch (d) {}
      if (!b) try {
        b = new ActiveXObject("Microsoft.XMLDOM"), b.async = !1, b.loadXML(a)
      } catch (d) {
        b = null
      }
      return b
    }, a.parseJSON = function(a) {
      if (null == a) return null;
      try {
        return JSON.parse(a)
      } catch (b) {
        throw b
      }
    }, createjs.DataUtils = a
  }(), this.createjs = this.createjs || {},
  function() {
    var a = {};
    a.BINARY = "binary", a.CSS = "css", a.FONT = "font", a.FONTCSS = "fontcss", a.IMAGE = "image", a.JAVASCRIPT = "javascript", a.JSON = "json", a.JSONP = "jsonp", a.MANIFEST = "manifest", a.SOUND = "sound", a.VIDEO = "video", a.SPRITESHEET = "spritesheet", a.SVG = "svg", a.TEXT = "text", a.XML = "xml", createjs.Types = a
  }(), this.createjs = this.createjs || {},
  function() {
    var a = {};
    a.POST = "POST", a.GET = "GET", createjs.Methods = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      this.src = null, this.type = null, this.id = null, this.maintainOrder = !1, this.callback = null, this.data = null, this.method = createjs.Methods.GET, this.values = null, this.headers = null, this.withCredentials = !1, this.mimeType = null, this.crossOrigin = null, this.loadTimeout = c.LOAD_TIMEOUT_DEFAULT
    }
    var b = a.prototype = {},
      c = a;
    c.LOAD_TIMEOUT_DEFAULT = 8e3, c.create = function(b) {
      if ("string" == typeof b) {
        var d = new a;
        return d.src = b, d
      }
      if (b instanceof c) return b;
      if (b instanceof Object && b.src) return null == b.loadTimeout && (b.loadTimeout = c.LOAD_TIMEOUT_DEFAULT), b;
      throw new Error("Type not recognized.")
    }, b.set = function(a) {
      for (var b in a) this[b] = a[b];
      return this
    }, createjs.LoadItem = c
  }(),
  function() {
    var a = {};
    a.isBinary = function(a) {
      switch (a) {
        case createjs.Types.IMAGE:
        case createjs.Types.BINARY:
          return !0;
        default:
          return !1
      }
    }, a.isText = function(a) {
      switch (a) {
        case createjs.Types.TEXT:
        case createjs.Types.JSON:
        case createjs.Types.MANIFEST:
        case createjs.Types.XML:
        case createjs.Types.CSS:
        case createjs.Types.SVG:
        case createjs.Types.JAVASCRIPT:
        case createjs.Types.SPRITESHEET:
          return !0;
        default:
          return !1
      }
    }, a.getTypeByExtension = function(a) {
      if (null == a) return createjs.Types.TEXT;
      switch (a.toLowerCase()) {
        case "jpeg":
        case "jpg":
        case "gif":
        case "png":
        case "webp":
        case "bmp":
          return createjs.Types.IMAGE;
        case "ogg":
        case "mp3":
        case "webm":
          return createjs.Types.SOUND;
        case "mp4":
        case "webm":
        case "ts":
          return createjs.Types.VIDEO;
        case "json":
          return createjs.Types.JSON;
        case "xml":
          return createjs.Types.XML;
        case "css":
          return createjs.Types.CSS;
        case "js":
          return createjs.Types.JAVASCRIPT;
        case "svg":
          return createjs.Types.SVG;
        default:
          return createjs.Types.TEXT
      }
    }, createjs.RequestUtils = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c) {
      this.EventDispatcher_constructor(), this.loaded = !1, this.canceled = !1, this.progress = 0, this.type = c, this.resultFormatter = null, a ? this._item = createjs.LoadItem.create(a) : this._item = null, this._preferXHR = b, this._result = null, this._rawResult = null, this._loadedItems = null, this._tagSrcAttribute = null, this._tag = null
    }
    var b = createjs.extend(a, createjs.EventDispatcher),
      c = a;
    try {
      Object.defineProperties(c, {
        POST: {
          get: createjs.deprecate(function() {
            return createjs.Methods.POST
          }, "AbstractLoader.POST")
        },
        GET: {
          get: createjs.deprecate(function() {
            return createjs.Methods.GET
          }, "AbstractLoader.GET")
        },
        BINARY: {
          get: createjs.deprecate(function() {
            return createjs.Types.BINARY
          }, "AbstractLoader.BINARY")
        },
        CSS: {
          get: createjs.deprecate(function() {
            return createjs.Types.CSS
          }, "AbstractLoader.CSS")
        },
        FONT: {
          get: createjs.deprecate(function() {
            return createjs.Types.FONT
          }, "AbstractLoader.FONT")
        },
        FONTCSS: {
          get: createjs.deprecate(function() {
            return createjs.Types.FONTCSS
          }, "AbstractLoader.FONTCSS")
        },
        IMAGE: {
          get: createjs.deprecate(function() {
            return createjs.Types.IMAGE
          }, "AbstractLoader.IMAGE")
        },
        JAVASCRIPT: {
          get: createjs.deprecate(function() {
            return createjs.Types.JAVASCRIPT
          }, "AbstractLoader.JAVASCRIPT")
        },
        JSON: {
          get: createjs.deprecate(function() {
            return createjs.Types.JSON
          }, "AbstractLoader.JSON")
        },
        JSONP: {
          get: createjs.deprecate(function() {
            return createjs.Types.JSONP
          }, "AbstractLoader.JSONP")
        },
        MANIFEST: {
          get: createjs.deprecate(function() {
            return createjs.Types.MANIFEST
          }, "AbstractLoader.MANIFEST")
        },
        SOUND: {
          get: createjs.deprecate(function() {
            return createjs.Types.SOUND
          }, "AbstractLoader.SOUND")
        },
        VIDEO: {
          get: createjs.deprecate(function() {
            return createjs.Types.VIDEO
          }, "AbstractLoader.VIDEO")
        },
        SPRITESHEET: {
          get: createjs.deprecate(function() {
            return createjs.Types.SPRITESHEET
          }, "AbstractLoader.SPRITESHEET")
        },
        SVG: {
          get: createjs.deprecate(function() {
            return createjs.Types.SVG
          }, "AbstractLoader.SVG")
        },
        TEXT: {
          get: createjs.deprecate(function() {
            return createjs.Types.TEXT
          }, "AbstractLoader.TEXT")
        },
        XML: {
          get: createjs.deprecate(function() {
            return createjs.Types.XML
          }, "AbstractLoader.XML")
        }
      })
    } catch (d) {}
    b.getItem = function() {
      return this._item
    }, b.getResult = function(a) {
      return a ? this._rawResult : this._result
    }, b.getTag = function() {
      return this._tag
    }, b.setTag = function(a) {
      this._tag = a
    }, b.load = function() {
      this._createRequest(), this._request.on("complete", this, this), this._request.on("progress", this, this), this._request.on("loadStart", this, this), this._request.on("abort", this, this), this._request.on("timeout", this, this), this._request.on("error", this, this);
      var a = new createjs.Event("initialize");
      a.loader = this._request, this.dispatchEvent(a), this._request.load()
    }, b.cancel = function() {
      this.canceled = !0, this.destroy()
    }, b.destroy = function() {
      this._request && (this._request.removeAllEventListeners(), this._request.destroy()), this._request = null, this._item = null, this._rawResult = null, this._result = null, this._loadItems = null, this.removeAllEventListeners()
    }, b.getLoadedItems = function() {
      return this._loadedItems
    }, b._createRequest = function() {
      this._preferXHR ? this._request = new createjs.XHRRequest(this._item) : this._request = new createjs.TagRequest(this._item, this._tag || this._createTag(), this._tagSrcAttribute)
    }, b._createTag = function(a) {
      return null
    }, b._sendLoadStart = function() {
      this._isCanceled() || this.dispatchEvent("loadstart")
    }, b._sendProgress = function(a) {
      if (!this._isCanceled()) {
        var b = null;
        "number" == typeof a ? (this.progress = a, b = new createjs.ProgressEvent(this.progress)) : (b = a, this.progress = a.loaded / a.total, b.progress = this.progress, (isNaN(this.progress) || this.progress == 1 / 0) && (this.progress = 0)), this.hasEventListener("progress") && this.dispatchEvent(b)
      }
    }, b._sendComplete = function() {
      if (!this._isCanceled()) {
        this.loaded = !0;
        var a = new createjs.Event("complete");
        a.rawResult = this._rawResult, null != this._result && (a.result = this._result), this.dispatchEvent(a)
      }
    }, b._sendError = function(a) {
      !this._isCanceled() && this.hasEventListener("error") && (null == a && (a = new createjs.ErrorEvent("PRELOAD_ERROR_EMPTY")), this.dispatchEvent(a))
    }, b._isCanceled = function() {
      return null == window.createjs || this.canceled ? !0 : !1
    }, b.resultFormatter = null, b.handleEvent = function(a) {
      switch (a.type) {
        case "complete":
          this._rawResult = a.target._response;
          var b = this.resultFormatter && this.resultFormatter(this);
          b instanceof Function ? b.call(this, createjs.proxy(this._resultFormatSuccess, this), createjs.proxy(this._resultFormatFailed, this)) : (this._result = b || this._rawResult, this._sendComplete());
          break;
        case "progress":
          this._sendProgress(a);
          break;
        case "error":
          this._sendError(a);
          break;
        case "loadstart":
          this._sendLoadStart();
          break;
        case "abort":
        case "timeout":
          this._isCanceled() || this.dispatchEvent(new createjs.ErrorEvent("PRELOAD_" + a.type.toUpperCase() + "_ERROR"))
      }
    }, b._resultFormatSuccess = function(a) {
      this._result = a, this._sendComplete()
    }, b._resultFormatFailed = function(a) {
      this._sendError(a)
    }, b.toString = function() {
      return "[PreloadJS AbstractLoader]"
    }, createjs.AbstractLoader = createjs.promote(a, "EventDispatcher")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c) {
      this.AbstractLoader_constructor(a, b, c), this.resultFormatter = this._formatResult, this._tagSrcAttribute = "src", this.on("initialize", this._updateXHR, this)
    }
    var b = createjs.extend(a, createjs.AbstractLoader);
    b.load = function() {
      this._tag || (this._tag = this._createTag(this._item.src)), this._tag.preload = "auto", this._tag.load(), this.AbstractLoader_load()
    }, b._createTag = function() {}, b._createRequest = function() {
      this._preferXHR ? this._request = new createjs.XHRRequest(this._item) : this._request = new createjs.MediaTagRequest(this._item, this._tag || this._createTag(), this._tagSrcAttribute)
    }, b._updateXHR = function(a) {
      a.loader.setResponseType && a.loader.setResponseType("blob")
    }, b._formatResult = function(a) {
      if (this._tag.removeEventListener && this._tag.removeEventListener("canplaythrough", this._loadedHandler), this._tag.onstalled = null, this._preferXHR) {
        var b = window.URL || window.webkitURL,
          c = a.getResult(!0);
        a.getTag().src = b.createObjectURL(c)
      }
      return a.getTag()
    }, createjs.AbstractMediaLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";
    var a = function(a) {
        this._item = a
      },
      b = createjs.extend(a, createjs.EventDispatcher);
    b.load = function() {}, b.destroy = function() {}, b.cancel = function() {}, createjs.AbstractRequest = createjs.promote(a, "EventDispatcher")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c) {
      this.AbstractRequest_constructor(a), this._tag = b, this._tagSrcAttribute = c, this._loadedHandler = createjs.proxy(this._handleTagComplete, this), this._addedToDOM = !1
    }
    var b = createjs.extend(a, createjs.AbstractRequest);
    b.load = function() {
      this._tag.onload = createjs.proxy(this._handleTagComplete, this), this._tag.onreadystatechange = createjs.proxy(this._handleReadyStateChange, this), this._tag.onerror = createjs.proxy(this._handleError, this);
      var a = new createjs.Event("initialize");
      a.loader = this._tag, this.dispatchEvent(a), this._loadTimeout = setTimeout(createjs.proxy(this._handleTimeout, this), this._item.loadTimeout), this._tag[this._tagSrcAttribute] = this._item.src, null == this._tag.parentNode && (createjs.DomUtils.appendToBody(this._tag), this._addedToDOM = !0)
    }, b.destroy = function() {
      this._clean(), this._tag = null, this.AbstractRequest_destroy()
    }, b._handleReadyStateChange = function() {
      clearTimeout(this._loadTimeout);
      var a = this._tag;
      ("loaded" == a.readyState || "complete" == a.readyState) && this._handleTagComplete()
    }, b._handleError = function() {
      this._clean(), this.dispatchEvent("error")
    }, b._handleTagComplete = function() {
      this._rawResult = this._tag, this._result = this.resultFormatter && this.resultFormatter(this) || this._rawResult, this._clean(), this.dispatchEvent("complete")
    }, b._handleTimeout = function() {
      this._clean(), this.dispatchEvent(new createjs.Event("timeout"))
    }, b._clean = function() {
      this._tag.onload = null, this._tag.onreadystatechange = null, this._tag.onerror = null, this._addedToDOM && null != this._tag.parentNode && this._tag.parentNode.removeChild(this._tag), clearTimeout(this._loadTimeout)
    }, b._handleStalled = function() {}, createjs.TagRequest = createjs.promote(a, "AbstractRequest")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c) {
      this.AbstractRequest_constructor(a), this._tag = b, this._tagSrcAttribute = c, this._loadedHandler = createjs.proxy(this._handleTagComplete, this)
    }
    var b = createjs.extend(a, createjs.TagRequest);
    b.load = function() {
      var a = createjs.proxy(this._handleStalled, this);
      this._stalledCallback = a;
      var b = createjs.proxy(this._handleProgress, this);
      this._handleProgress = b, this._tag.addEventListener("stalled", a), this._tag.addEventListener("progress", b), this._tag.addEventListener && this._tag.addEventListener("canplaythrough", this._loadedHandler, !1), this.TagRequest_load()
    }, b._handleReadyStateChange = function() {
      clearTimeout(this._loadTimeout);
      var a = this._tag;
      ("loaded" == a.readyState || "complete" == a.readyState) && this._handleTagComplete()
    }, b._handleStalled = function() {}, b._handleProgress = function(a) {
      if (a && !(a.loaded > 0 && 0 == a.total)) {
        var b = new createjs.ProgressEvent(a.loaded, a.total);
        this.dispatchEvent(b)
      }
    }, b._clean = function() {
      this._tag.removeEventListener && this._tag.removeEventListener("canplaythrough", this._loadedHandler), this._tag.removeEventListener("stalled", this._stalledCallback), this._tag.removeEventListener("progress", this._progressCallback), this.TagRequest__clean()
    }, createjs.MediaTagRequest = createjs.promote(a, "TagRequest")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.AbstractRequest_constructor(a), this._request = null, this._loadTimeout = null, this._xhrLevel = 1, this._response = null, this._rawResponse = null, this._canceled = !1, this._handleLoadStartProxy = createjs.proxy(this._handleLoadStart, this), this._handleProgressProxy = createjs.proxy(this._handleProgress, this), this._handleAbortProxy = createjs.proxy(this._handleAbort, this), this._handleErrorProxy = createjs.proxy(this._handleError, this), this._handleTimeoutProxy = createjs.proxy(this._handleTimeout, this), this._handleLoadProxy = createjs.proxy(this._handleLoad, this), this._handleReadyStateChangeProxy = createjs.proxy(this._handleReadyStateChange, this), !this._createXHR(a)
    }
    var b = createjs.extend(a, createjs.AbstractRequest);
    a.ACTIVEX_VERSIONS = ["Msxml2.XMLHTTP.6.0", "Msxml2.XMLHTTP.5.0", "Msxml2.XMLHTTP.4.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"], b.getResult = function(a) {
      return a && this._rawResponse ? this._rawResponse : this._response
    }, b.cancel = function() {
      this.canceled = !0, this._clean(), this._request.abort()
    }, b.load = function() {
      if (null == this._request) return void this._handleError();
      null != this._request.addEventListener ? (this._request.addEventListener("loadstart", this._handleLoadStartProxy, !1), this._request.addEventListener("progress", this._handleProgressProxy, !1), this._request.addEventListener("abort", this._handleAbortProxy, !1), this._request.addEventListener("error", this._handleErrorProxy, !1), this._request.addEventListener("timeout", this._handleTimeoutProxy, !1), this._request.addEventListener("load", this._handleLoadProxy, !1), this._request.addEventListener("readystatechange", this._handleReadyStateChangeProxy, !1)) : (this._request.onloadstart = this._handleLoadStartProxy, this._request.onprogress = this._handleProgressProxy, this._request.onabort = this._handleAbortProxy, this._request.onerror = this._handleErrorProxy, this._request.ontimeout = this._handleTimeoutProxy, this._request.onload = this._handleLoadProxy, this._request.onreadystatechange = this._handleReadyStateChangeProxy), 1 == this._xhrLevel && (this._loadTimeout = setTimeout(createjs.proxy(this._handleTimeout, this), this._item.loadTimeout));
      try {
        this._item.values ? this._request.send(createjs.URLUtils.formatQueryString(this._item.values)) : this._request.send()
      } catch (a) {
        this.dispatchEvent(new createjs.ErrorEvent("XHR_SEND", null, a))
      }
    }, b.setResponseType = function(a) {
      "blob" === a && (a = window.URL ? "blob" : "arraybuffer", this._responseType = a), this._request.responseType = a
    }, b.getAllResponseHeaders = function() {
      return this._request.getAllResponseHeaders instanceof Function ? this._request.getAllResponseHeaders() : null
    }, b.getResponseHeader = function(a) {
      return this._request.getResponseHeader instanceof Function ? this._request.getResponseHeader(a) : null
    }, b._handleProgress = function(a) {
      if (a && !(a.loaded > 0 && 0 == a.total)) {
        var b = new createjs.ProgressEvent(a.loaded, a.total);
        this.dispatchEvent(b)
      }
    }, b._handleLoadStart = function(a) {
      clearTimeout(this._loadTimeout), this.dispatchEvent("loadstart")
    }, b._handleAbort = function(a) {
      this._clean(), this.dispatchEvent(new createjs.ErrorEvent("XHR_ABORTED", null, a))
    }, b._handleError = function(a) {
      this._clean(), this.dispatchEvent(new createjs.ErrorEvent(a.message))
    }, b._handleReadyStateChange = function(a) {
      4 == this._request.readyState && this._handleLoad()
    }, b._handleLoad = function(a) {
      if (!this.loaded) {
        this.loaded = !0;
        var b = this._checkError();
        if (b) return void this._handleError(b);
        if (this._response = this._getResponse(), "arraybuffer" === this._responseType) try {
          this._response = new Blob([this._response])
        } catch (c) {
          if (window.BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder || window.MSBlobBuilder, "TypeError" === c.name && window.BlobBuilder) {
            var d = new BlobBuilder;
            d.append(this._response), this._response = d.getBlob()
          }
        }
        this._clean(), this.dispatchEvent(new createjs.Event("complete"))
      }
    }, b._handleTimeout = function(a) {
      this._clean(), this.dispatchEvent(new createjs.ErrorEvent("PRELOAD_TIMEOUT", null, a))
    }, b._checkError = function() {
      var a = parseInt(this._request.status);
      return a >= 400 && 599 >= a ? new Error(a) : 0 == a && /^https?:/.test(location.protocol) ? new Error(0) : null
    }, b._getResponse = function() {
      if (null != this._response) return this._response;
      if (null != this._request.response) return this._request.response;
      try {
        if (null != this._request.responseText) return this._request.responseText
      } catch (a) {}
      try {
        if (null != this._request.responseXML) return this._request.responseXML
      } catch (a) {}
      return null
    }, b._createXHR = function(a) {
      var b = createjs.URLUtils.isCrossDomain(a),
        c = {},
        d = null;
      if (window.XMLHttpRequest) d = new XMLHttpRequest, b && void 0 === d.withCredentials && window.XDomainRequest && (d = new XDomainRequest);
      else {
        for (var e = 0, f = s.ACTIVEX_VERSIONS.length; f > e; e++) {
          var g = s.ACTIVEX_VERSIONS[e];
          try {
            d = new ActiveXObject(g);
            break
          } catch (h) {}
        }
        if (null == d) return !1
      }
      null == a.mimeType && createjs.RequestUtils.isText(a.type) && (a.mimeType = "text/plain; charset=utf-8"), a.mimeType && d.overrideMimeType && d.overrideMimeType(a.mimeType), this._xhrLevel = "string" == typeof d.responseType ? 2 : 1;
      var i = null;
      if (i = a.method == createjs.Methods.GET ? createjs.URLUtils.buildURI(a.src, a.values) : a.src, d.open(a.method || createjs.Methods.GET, i, !0), b && d instanceof XMLHttpRequest && 1 == this._xhrLevel && (c.Origin = location.origin), a.values && a.method == createjs.Methods.POST && (c["Content-Type"] = "application/x-www-form-urlencoded"), b || c["X-Requested-With"] || (c["X-Requested-With"] = "XMLHttpRequest"), a.headers)
        for (var j in a.headers) c[j] = a.headers[j];
      for (j in c) d.setRequestHeader(j, c[j]);
      return d instanceof XMLHttpRequest && void 0 !== a.withCredentials && (d.withCredentials = a.withCredentials), this._request = d, !0
    }, b._clean = function() {
      clearTimeout(this._loadTimeout), null != this._request.removeEventListener ? (this._request.removeEventListener("loadstart", this._handleLoadStartProxy), this._request.removeEventListener("progress", this._handleProgressProxy), this._request.removeEventListener("abort", this._handleAbortProxy), this._request.removeEventListener("error", this._handleErrorProxy), this._request.removeEventListener("timeout", this._handleTimeoutProxy), this._request.removeEventListener("load", this._handleLoadProxy), this._request.removeEventListener("readystatechange", this._handleReadyStateChangeProxy)) : (this._request.onloadstart = null, this._request.onprogress = null, this._request.onabort = null, this._request.onerror = null, this._request.ontimeout = null, this._request.onload = null, this._request.onreadystatechange = null)
    }, b.toString = function() {
      return "[PreloadJS XHRRequest]"
    }, createjs.XHRRequest = createjs.promote(a, "AbstractRequest")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c) {
      this.AbstractLoader_constructor(), this._plugins = [], this._typeCallbacks = {}, this._extensionCallbacks = {}, this.next = null, this.maintainScriptOrder = !0, this.stopOnError = !1, this._maxConnections = 1, this._availableLoaders = [createjs.FontLoader, createjs.ImageLoader, createjs.JavaScriptLoader, createjs.CSSLoader, createjs.JSONLoader, createjs.JSONPLoader, createjs.SoundLoader, createjs.ManifestLoader, createjs.SpriteSheetLoader, createjs.XMLLoader, createjs.SVGLoader, createjs.BinaryLoader, createjs.VideoLoader, createjs.TextLoader], this._defaultLoaderLength = this._availableLoaders.length, this.init(a, b, c)
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    try {
      Object.defineProperties(c, {
        POST: {
          get: createjs.deprecate(function() {
            return createjs.Methods.POST
          }, "AbstractLoader.POST")
        },
        GET: {
          get: createjs.deprecate(function() {
            return createjs.Methods.GET
          }, "AbstractLoader.GET")
        },
        BINARY: {
          get: createjs.deprecate(function() {
            return createjs.Types.BINARY
          }, "AbstractLoader.BINARY")
        },
        CSS: {
          get: createjs.deprecate(function() {
            return createjs.Types.CSS
          }, "AbstractLoader.CSS")
        },
        FONT: {
          get: createjs.deprecate(function() {
            return createjs.Types.FONT
          }, "AbstractLoader.FONT")
        },
        FONTCSS: {
          get: createjs.deprecate(function() {
            return createjs.Types.FONTCSS
          }, "AbstractLoader.FONTCSS")
        },
        IMAGE: {
          get: createjs.deprecate(function() {
            return createjs.Types.IMAGE
          }, "AbstractLoader.IMAGE")
        },
        JAVASCRIPT: {
          get: createjs.deprecate(function() {
            return createjs.Types.JAVASCRIPT
          }, "AbstractLoader.JAVASCRIPT")
        },
        JSON: {
          get: createjs.deprecate(function() {
            return createjs.Types.JSON
          }, "AbstractLoader.JSON")
        },
        JSONP: {
          get: createjs.deprecate(function() {
            return createjs.Types.JSONP
          }, "AbstractLoader.JSONP")
        },
        MANIFEST: {
          get: createjs.deprecate(function() {
            return createjs.Types.MANIFEST
          }, "AbstractLoader.MANIFEST")
        },
        SOUND: {
          get: createjs.deprecate(function() {
            return createjs.Types.SOUND
          }, "AbstractLoader.SOUND")
        },
        VIDEO: {
          get: createjs.deprecate(function() {
            return createjs.Types.VIDEO
          }, "AbstractLoader.VIDEO")
        },
        SPRITESHEET: {
          get: createjs.deprecate(function() {
            return createjs.Types.SPRITESHEET
          }, "AbstractLoader.SPRITESHEET")
        },
        SVG: {
          get: createjs.deprecate(function() {
            return createjs.Types.SVG
          }, "AbstractLoader.SVG")
        },
        TEXT: {
          get: createjs.deprecate(function() {
            return createjs.Types.TEXT
          }, "AbstractLoader.TEXT")
        },
        XML: {
          get: createjs.deprecate(function() {
            return createjs.Types.XML
          }, "AbstractLoader.XML")
        }
      })
    } catch (d) {}
    b.init = function(a, b, c) {
      this.preferXHR = !0, this._preferXHR = !0, this.setPreferXHR(a), this._paused = !1, this._basePath = b, this._crossOrigin = c, this._loadStartWasDispatched = !1, this._currentlyLoadingScript = null, this._currentLoads = [], this._loadQueue = [], this._loadQueueBackup = [], this._loadItemsById = {}, this._loadItemsBySrc = {}, this._loadedResults = {}, this._loadedRawResults = {}, this._numItems = 0, this._numItemsLoaded = 0, this._scriptOrder = [], this._loadedScripts = [], this._lastProgress = NaN
    }, b.registerLoader = function(a) {
      if (!a || !a.canLoadItem) throw new Error("loader is of an incorrect type.");
      if (-1 != this._availableLoaders.indexOf(a)) throw new Error("loader already exists.");
      this._availableLoaders.unshift(a)
    }, b.unregisterLoader = function(a) {
      var b = this._availableLoaders.indexOf(a); - 1 != b && b < this._defaultLoaderLength - 1 && this._availableLoaders.splice(b, 1)
    }, b.setPreferXHR = function(a) {
      return this.preferXHR = 0 != a && null != window.XMLHttpRequest, this.preferXHR
    }, b.removeAll = function() {
      this.remove()
    }, b.remove = function(a) {
      var b = null;
      if (a && !Array.isArray(a)) b = [a];
      else if (a) b = a;
      else if (arguments.length > 0) return;
      var c = !1;
      if (b) {
        for (; b.length;) {
          var d = b.pop(),
            e = this.getResult(d);
          for (f = this._loadQueue.length - 1; f >= 0; f--)
            if (g = this._loadQueue[f].getItem(), g.id == d || g.src == d) {
              this._loadQueue.splice(f, 1)[0].cancel();
              break
            } for (f = this._loadQueueBackup.length - 1; f >= 0; f--)
            if (g = this._loadQueueBackup[f].getItem(), g.id == d || g.src == d) {
              this._loadQueueBackup.splice(f, 1)[0].cancel();
              break
            } if (e) this._disposeItem(this.getItem(d));
          else
            for (var f = this._currentLoads.length - 1; f >= 0; f--) {
              var g = this._currentLoads[f].getItem();
              if (g.id == d || g.src == d) {
                this._currentLoads.splice(f, 1)[0].cancel(), c = !0;
                break
              }
            }
        }
        c && this._loadNext()
      } else {
        this.close();
        for (var h in this._loadItemsById) this._disposeItem(this._loadItemsById[h]);
        this.init(this.preferXHR, this._basePath)
      }
    }, b.reset = function() {
      this.close();
      for (var a in this._loadItemsById) this._disposeItem(this._loadItemsById[a]);
      for (var b = [], c = 0, d = this._loadQueueBackup.length; d > c; c++) b.push(this._loadQueueBackup[c].getItem());
      this.loadManifest(b, !1)
    }, b.installPlugin = function(a) {
      if (null != a && null != a.getPreloadHandlers) {
        this._plugins.push(a);
        var b = a.getPreloadHandlers();
        if (b.scope = a, null != b.types)
          for (var c = 0, d = b.types.length; d > c; c++) this._typeCallbacks[b.types[c]] = b;
        if (null != b.extensions)
          for (c = 0, d = b.extensions.length; d > c; c++) this._extensionCallbacks[b.extensions[c]] = b
      }
    }, b.setMaxConnections = function(a) {
      this._maxConnections = a, !this._paused && this._loadQueue.length > 0 && this._loadNext()
    }, b.loadFile = function(a, b, c) {
      if (null == a) {
        var d = new createjs.ErrorEvent("PRELOAD_NO_FILE");
        return void this._sendError(d)
      }
      this._addItem(a, null, c), b !== !1 ? this.setPaused(!1) : this.setPaused(!0)
    }, b.loadManifest = function(a, b, d) {
      var e = null,
        f = null;
      if (Array.isArray(a)) {
        if (0 == a.length) {
          var g = new createjs.ErrorEvent("PRELOAD_MANIFEST_EMPTY");
          return void this._sendError(g)
        }
        e = a
      } else if ("string" == typeof a) e = [{
        src: a,
        type: c.MANIFEST
      }];
      else {
        if ("object" != typeof a) {
          var g = new createjs.ErrorEvent("PRELOAD_MANIFEST_NULL");
          return void this._sendError(g)
        }
        if (void 0 !== a.src) {
          if (null == a.type) a.type = c.MANIFEST;
          else if (a.type != c.MANIFEST) {
            var g = new createjs.ErrorEvent("PRELOAD_MANIFEST_TYPE");
            this._sendError(g)
          }
          e = [a]
        } else void 0 !== a.manifest && (e = a.manifest, f = a.path)
      }
      for (var h = 0, i = e.length; i > h; h++) this._addItem(e[h], f, d);
      b !== !1 ? this.setPaused(!1) : this.setPaused(!0)
    }, b.load = function() {
      this.setPaused(!1)
    }, b.getItem = function(a) {
      return this._loadItemsById[a] || this._loadItemsBySrc[a]
    }, b.getResult = function(a, b) {
      var c = this._loadItemsById[a] || this._loadItemsBySrc[a];
      if (null == c) return null;
      var d = c.id;
      return b && this._loadedRawResults[d] ? this._loadedRawResults[d] : this._loadedResults[d]
    }, b.getItems = function(a) {
      var b = [];
      for (var c in this._loadItemsById) {
        var d = this._loadItemsById[c],
          e = this.getResult(c);
        (a !== !0 || null != e) && b.push({
          item: d,
          result: e,
          rawResult: this.getResult(c, !0)
        })
      }
      return b
    }, b.setPaused = function(a) {
      this._paused = a, this._paused || this._loadNext()
    }, b.close = function() {
      for (; this._currentLoads.length;) this._currentLoads.pop().cancel();
      this._scriptOrder.length = 0, this._loadedScripts.length = 0, this.loadStartWasDispatched = !1, this._itemCount = 0, this._lastProgress = NaN
    }, b._addItem = function(a, b, c) {
      var d = this._createLoadItem(a, b, c);
      if (null != d) {
        var e = this._createLoader(d);
        null != e && ("plugins" in e && (e.plugins = this._plugins), d._loader = e, this._loadQueue.push(e), this._loadQueueBackup.push(e), this._numItems++, this._updateProgress(), (this.maintainScriptOrder && d.type == createjs.Types.JAVASCRIPT || d.maintainOrder === !0) && (this._scriptOrder.push(d), this._loadedScripts.push(null)))
      }
    }, b._createLoadItem = function(a, b, c) {
      var d = createjs.LoadItem.create(a);
      if (null == d) return null;
      var e = "",
        f = c || this._basePath;
      if (d.src instanceof Object) {
        if (!d.type) return null;
        if (b) {
          e = b;
          var g = createjs.URLUtils.parseURI(b);
          null == f || g.absolute || g.relative || (e = f + e)
        } else null != f && (e = f)
      } else {
        var h = createjs.URLUtils.parseURI(d.src);
        h.extension && (d.ext = h.extension), null == d.type && (d.type = createjs.RequestUtils.getTypeByExtension(d.ext));
        var i = d.src;
        if (!h.absolute && !h.relative)
          if (b) {
            e = b;
            var g = createjs.URLUtils.parseURI(b);
            i = b + i, null == f || g.absolute || g.relative || (e = f + e)
          } else null != f && (e = f);
        d.src = e + d.src
      }
      d.path = e, (void 0 === d.id || null === d.id || "" === d.id) && (d.id = i);
      var j = this._typeCallbacks[d.type] || this._extensionCallbacks[d.ext];
      if (j) {
        var k = j.callback.call(j.scope, d, this);
        if (k === !1) return null;
        k === !0 || null != k && (d._loader = k), h = createjs.URLUtils.parseURI(d.src), null != h.extension && (d.ext = h.extension)
      }
      return this._loadItemsById[d.id] = d, this._loadItemsBySrc[d.src] = d, null == d.crossOrigin && (d.crossOrigin = this._crossOrigin), d
    }, b._createLoader = function(a) {
      if (null != a._loader) return a._loader;
      for (var b = this.preferXHR, c = 0; c < this._availableLoaders.length; c++) {
        var d = this._availableLoaders[c];
        if (d && d.canLoadItem(a)) return new d(a, b)
      }
      return null
    }, b._loadNext = function() {
      if (!this._paused) {
        this._loadStartWasDispatched || (this._sendLoadStart(), this._loadStartWasDispatched = !0), this._numItems == this._numItemsLoaded ? (this.loaded = !0, this._sendComplete(), this.next && this.next.load && this.next.load()) : this.loaded = !1;
        for (var a = 0; a < this._loadQueue.length && !(this._currentLoads.length >= this._maxConnections); a++) {
          var b = this._loadQueue[a];
          this._canStartLoad(b) && (this._loadQueue.splice(a, 1), a--, this._loadItem(b))
        }
      }
    }, b._loadItem = function(a) {
      a.on("fileload", this._handleFileLoad, this), a.on("progress", this._handleProgress, this), a.on("complete", this._handleFileComplete, this), a.on("error", this._handleError, this), a.on("fileerror", this._handleFileError, this), this._currentLoads.push(a), this._sendFileStart(a.getItem()), a.load()
    }, b._handleFileLoad = function(a) {
      a.target = null, this.dispatchEvent(a)
    }, b._handleFileError = function(a) {
      var b = new createjs.ErrorEvent("FILE_LOAD_ERROR", null, a.item);
      this._sendError(b)
    }, b._handleError = function(a) {
      var b = a.target;
      this._numItemsLoaded++, this._finishOrderedItem(b, !0), this._updateProgress();
      var c = new createjs.ErrorEvent("FILE_LOAD_ERROR", null, b.getItem());
      this._sendError(c), this.stopOnError ? this.setPaused(!0) : (this._removeLoadItem(b), this._cleanLoadItem(b), this._loadNext())
    }, b._handleFileComplete = function(a) {
      var b = a.target,
        c = b.getItem(),
        d = b.getResult();
      this._loadedResults[c.id] = d;
      var e = b.getResult(!0);
      null != e && e !== d && (this._loadedRawResults[c.id] = e), this._saveLoadedItems(b), this._removeLoadItem(b), this._finishOrderedItem(b) || this._processFinishedLoad(c, b), this._cleanLoadItem(b)
    }, b._saveLoadedItems = function(a) {
      var b = a.getLoadedItems();
      if (null !== b)
        for (var c = 0; c < b.length; c++) {
          var d = b[c].item;
          this._loadItemsBySrc[d.src] = d, this._loadItemsById[d.id] = d, this._loadedResults[d.id] = b[c].result, this._loadedRawResults[d.id] = b[c].rawResult
        }
    }, b._finishOrderedItem = function(a, b) {
      var c = a.getItem();
      if (this.maintainScriptOrder && c.type == createjs.Types.JAVASCRIPT || c.maintainOrder) {
        a instanceof createjs.JavaScriptLoader && (this._currentlyLoadingScript = !1);
        var d = createjs.indexOf(this._scriptOrder, c);
        return -1 == d ? !1 : (this._loadedScripts[d] = b === !0 ? !0 : c, this._checkScriptLoadOrder(), !0)
      }
      return !1
    }, b._checkScriptLoadOrder = function() {
      for (var a = this._loadedScripts.length, b = 0; a > b; b++) {
        var c = this._loadedScripts[b];
        if (null === c) break;
        if (c !== !0) {
          var d = this._loadedResults[c.id];
          c.type == createjs.Types.JAVASCRIPT && createjs.DomUtils.appendToHead(d);
          var e = c._loader;
          this._processFinishedLoad(c, e), this._loadedScripts[b] = !0
        }
      }
    }, b._processFinishedLoad = function(a, b) {
      if (this._numItemsLoaded++, !this.maintainScriptOrder && a.type == createjs.Types.JAVASCRIPT) {
        var c = b.getTag();
        createjs.DomUtils.appendToHead(c)
      }
      this._updateProgress(), this._sendFileComplete(a, b), this._loadNext()
    }, b._canStartLoad = function(a) {
      if (!this.maintainScriptOrder || a.preferXHR) return !0;
      var b = a.getItem();
      if (b.type != createjs.Types.JAVASCRIPT) return !0;
      if (this._currentlyLoadingScript) return !1;
      for (var c = this._scriptOrder.indexOf(b), d = 0; c > d;) {
        var e = this._loadedScripts[d];
        if (null == e) return !1;
        d++
      }
      return this._currentlyLoadingScript = !0, !0
    }, b._removeLoadItem = function(a) {
      for (var b = this._currentLoads.length, c = 0; b > c; c++)
        if (this._currentLoads[c] == a) {
          this._currentLoads.splice(c, 1);
          break
        }
    }, b._cleanLoadItem = function(a) {
      var b = a.getItem();
      b && delete b._loader
    }, b._handleProgress = function(a) {
      var b = a.target;
      this._sendFileProgress(b.getItem(), b.progress), this._updateProgress()
    }, b._updateProgress = function() {
      var a = this._numItemsLoaded / this._numItems,
        b = this._numItems - this._numItemsLoaded;
      if (b > 0) {
        for (var c = 0, d = 0, e = this._currentLoads.length; e > d; d++) c += this._currentLoads[d].progress;
        a += c / b * (b / this._numItems)
      }
      this._lastProgress != a && (this._sendProgress(a), this._lastProgress = a)
    }, b._disposeItem = function(a) {
      delete this._loadedResults[a.id], delete this._loadedRawResults[a.id], delete this._loadItemsById[a.id], delete this._loadItemsBySrc[a.src]
    }, b._sendFileProgress = function(a, b) {
      if (!this._isCanceled() && !this._paused && this.hasEventListener("fileprogress")) {
        var c = new createjs.Event("fileprogress");
        c.progress = b, c.loaded = b, c.total = 1, c.item = a, this.dispatchEvent(c)
      }
    }, b._sendFileComplete = function(a, b) {
      if (!this._isCanceled() && !this._paused) {
        var c = new createjs.Event("fileload");
        c.loader = b, c.item = a, c.result = this._loadedResults[a.id], c.rawResult = this._loadedRawResults[a.id], a.completeHandler && a.completeHandler(c), this.hasEventListener("fileload") && this.dispatchEvent(c)
      }
    }, b._sendFileStart = function(a) {
      var b = new createjs.Event("filestart");
      b.item = a, this.hasEventListener("filestart") && this.dispatchEvent(b)
    }, b.toString = function() {
      return "[PreloadJS LoadQueue]"
    }, createjs.LoadQueue = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.AbstractLoader_constructor(a, !0, createjs.Types.TEXT)
    }
    var b = (createjs.extend(a, createjs.AbstractLoader), a);
    b.canLoadItem = function(a) {
      return a.type == createjs.Types.TEXT
    }, createjs.TextLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.AbstractLoader_constructor(a, !0, createjs.Types.BINARY), this.on("initialize", this._updateXHR, this)
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.canLoadItem = function(a) {
      return a.type == createjs.Types.BINARY
    }, b._updateXHR = function(a) {
      a.loader.setResponseType("arraybuffer")
    }, createjs.BinaryLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.AbstractLoader_constructor(a, b, createjs.Types.CSS), this.resultFormatter = this._formatResult, this._tagSrcAttribute = "href", b ? this._tag = createjs.Elements.style() : this._tag = createjs.Elements.link(), this._tag.rel = "stylesheet", this._tag.type = "text/css"
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.canLoadItem = function(a) {
      return a.type == createjs.Types.CSS
    }, b._formatResult = function(a) {
      if (this._preferXHR) {
        var b = a.getTag();
        if (b.styleSheet) b.styleSheet.cssText = a.getResult(!0);
        else {
          var c = createjs.Elements.text(a.getResult(!0));
          b.appendChild(c)
        }
      } else b = this._tag;
      return createjs.DomUtils.appendToHead(b), b
    }, createjs.CSSLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.AbstractLoader_constructor(a, b, a.type), this._faces = {}, this._watched = [], this._count = 0, this._watchInterval = null, this._loadTimeout = null, this._injectCSS = void 0 === a.injectCSS ? !0 : a.injectCSS, this.dispatchEvent("initialize")
    }
    var b = createjs.extend(a, createjs.AbstractLoader);
    a.canLoadItem = function(a) {
      return a.type == createjs.Types.FONT || a.type == createjs.Types.FONTCSS
    }, a.sampleText = "abcdefghijklmnopqrstuvwxyz ABCDEFGHIJKLMNOPQRSTUVWXYZ", a._ctx = document.createElement("canvas").getContext("2d"), a._referenceFonts = ["serif", "monospace"], a.WEIGHT_REGEX = /[- ._]*(thin|normal|book|regular|medium|black|heavy|[1-9]00|(?:extra|ultra|semi|demi)?[- ._]*(?:light|bold))[- ._]*/gi, a.STYLE_REGEX = /[- ._]*(italic|oblique)[- ._]*/gi, a.FONT_FORMAT = {
      woff2: "woff2",
      woff: "woff",
      ttf: "truetype",
      otf: "truetype"
    }, a.FONT_WEIGHT = {
      thin: 100,
      extralight: 200,
      ultralight: 200,
      light: 300,
      semilight: 300,
      demilight: 300,
      book: "normal",
      regular: "normal",
      semibold: 600,
      demibold: 600,
      extrabold: 800,
      ultrabold: 800,
      black: 900,
      heavy: 900
    }, a.WATCH_DURATION = 10, b.load = function() {
      if (this.type == createjs.Types.FONTCSS) {
        var a = this._watchCSS();
        if (!a) return void this.AbstractLoader_load()
      } else if (this._item.src instanceof Array) this._watchFontArray();
      else {
        var b = this._defFromSrc(this._item.src);
        this._watchFont(b), this._injectStyleTag(this._cssFromDef(b))
      }
      this._loadTimeout = setTimeout(createjs.proxy(this._handleTimeout, this), this._item.loadTimeout), this.dispatchEvent("loadstart")
    }, b._handleTimeout = function() {
      this._stopWatching(), this.dispatchEvent(new createjs.ErrorEvent("PRELOAD_TIMEOUT"))
    }, b._createRequest = function() {
      return this._request
    }, b.handleEvent = function(a) {
      switch (a.type) {
        case "complete":
          this._rawResult = a.target._response, this._result = !0, this._parseCSS(this._rawResult);
          break;
        case "error":
          this._stopWatching(), this.AbstractLoader_handleEvent(a)
      }
    }, b._watchCSS = function() {
      var a = this._item.src;
      return a instanceof HTMLStyleElement && (this._injectCSS && !a.parentNode && (document.head || document.getElementsByTagName("head")[0]).appendChild(a), this._injectCSS = !1, a = "\n" + a.textContent), -1 !== a.search(/\n|\r|@font-face/i) ? (this._parseCSS(a), !0) : (this._request = new createjs.XHRRequest(this._item), !1)
    }, b._parseCSS = function(a) {
      for (var b = /@font-face\s*\{([^}]+)}/g;;) {
        var c = b.exec(a);
        if (!c) break;
        this._watchFont(this._parseFontFace(c[1]))
      }
      this._injectStyleTag(a)
    }, b._watchFontArray = function() {
      for (var a, b = this._item.src, c = "", d = b.length - 1; d >= 0; d--) {
        var e = b[d];
        a = "string" == typeof e ? this._defFromSrc(e) : this._defFromObj(e), this._watchFont(a), c += this._cssFromDef(a) + "\n"
      }
      this._injectStyleTag(c)
    }, b._injectStyleTag = function(a) {
      if (this._injectCSS) {
        var b = document.head || document.getElementsByTagName("head")[0],
          c = document.createElement("style");
        c.type = "text/css", c.styleSheet ? c.styleSheet.cssText = a : c.appendChild(document.createTextNode(a)), b.appendChild(c)
      }
    }, b._parseFontFace = function(a) {
      var b = this._getCSSValue(a, "font-family"),
        c = this._getCSSValue(a, "src");
      return b && c ? this._defFromObj({
        family: b,
        src: c,
        style: this._getCSSValue(a, "font-style"),
        weight: this._getCSSValue(a, "font-weight")
      }) : null
    }, b._watchFont = function(a) {
      a && !this._faces[a.id] && (this._faces[a.id] = a, this._watched.push(a), this._count++, this._calculateReferenceSizes(a), this._startWatching())
    }, b._startWatching = function() {
      null == this._watchInterval && (this._watchInterval = setInterval(createjs.proxy(this._watch, this), a.WATCH_DURATION))
    }, b._stopWatching = function() {
      clearInterval(this._watchInterval), clearTimeout(this._loadTimeout), this._watchInterval = null
    }, b._watch = function() {
      for (var b = this._watched, c = a._referenceFonts, d = b.length, e = d - 1; e >= 0; e--)
        for (var f = b[e], g = f.refs, h = g.length - 1; h >= 0; h--) {
          var i = this._getTextWidth(f.family + "," + c[h], f.weight, f.style);
          if (i != g[h]) {
            var j = new createjs.Event("fileload");
            f.type = "font-family", j.item = f, this.dispatchEvent(j), b.splice(e, 1);
            break
          }
        }
      if (d !== b.length) {
        var j = new createjs.ProgressEvent(this._count - b.length, this._count);
        this.dispatchEvent(j)
      }
      0 === d && (this._stopWatching(), this._sendComplete())
    }, b._calculateReferenceSizes = function(b) {
      for (var c = a._referenceFonts, d = b.refs = [], e = 0; e < c.length; e++) d[e] = this._getTextWidth(c[e], b.weight, b.style)
    }, b._defFromSrc = function(b) {
      var c, d = /[- ._]+/g,
        e = b,
        f = null;
      c = e.search(/[?#]/), -1 !== c && (e = e.substr(0, c)), c = e.lastIndexOf("."), -1 !== c && (f = e.substr(c + 1), e = e.substr(0, c)), c = e.lastIndexOf("/"), -1 !== c && (e = e.substr(c + 1));
      var g = e,
        h = g.match(a.WEIGHT_REGEX);
      h && (h = h[0], g = g.replace(h, ""), h = h.replace(d, "").toLowerCase());
      var i = e.match(a.STYLE_REGEX);
      i && (g = g.replace(i[0], ""), i = "italic"), g = g.replace(d, "");
      var j = "local('" + e.replace(d, " ") + "'), url('" + b + "')",
        k = a.FONT_FORMAT[f];
      return k && (j += " format('" + k + "')"), this._defFromObj({
        family: g,
        weight: a.FONT_WEIGHT[h] || h,
        style: i,
        src: j
      })
    }, b._defFromObj = function(a) {
      var b = {
        family: a.family,
        src: a.src,
        style: a.style || "normal",
        weight: a.weight || "normal"
      };
      return b.id = b.family + ";" + b.style + ";" + b.weight, b
    }, b._cssFromDef = function(a) {
      return "@font-face {\n font-family: '" + a.family + "';\n font-style: " + a.style + ";\n font-weight: " + a.weight + ";\n src: " + a.src + ";\n}"
    }, b._getTextWidth = function(b, c, d) {
      var e = a._ctx;
      return e.font = d + " " + c + " 72px " + b, e.measureText(a.sampleText).width
    }, b._getCSSValue = function(a, b) {
      var c = new RegExp(b + ":s*([^;}]+?)s*[;}]"),
        d = c.exec(a);
      return d && d[1] ? d[1] : null
    }, createjs.FontLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.AbstractLoader_constructor(a, b, createjs.Types.IMAGE), this.resultFormatter = this._formatResult, this._tagSrcAttribute = "src", createjs.DomUtils.isImageTag(a) ? this._tag = a : createjs.DomUtils.isImageTag(a.src) ? this._tag = a.src : createjs.DomUtils.isImageTag(a.tag) && (this._tag = a.tag), null != this._tag ? this._preferXHR = !1 : this._tag = createjs.Elements.img(), this.on("initialize", this._updateXHR, this)
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.canLoadItem = function(a) {
      return a.type == createjs.Types.IMAGE
    }, b.load = function() {
      if ("" != this._tag.src && this._tag.complete) return void this._sendComplete();
      var a = this._item.crossOrigin;
      1 == a && (a = "Anonymous"), null == a || createjs.URLUtils.isLocal(this._item) || (this._tag.crossOrigin = a), this.AbstractLoader_load()
    }, b._updateXHR = function(a) {
      a.loader.mimeType = "text/plain; charset=x-user-defined-binary", a.loader.setResponseType && a.loader.setResponseType("blob")
    }, b._formatResult = function(a) {
      return this._formatImage
    }, b._formatImage = function(a, b) {
      var c = this._tag,
        d = window.URL || window.webkitURL;
      if (this._preferXHR)
        if (d) {
          var e = d.createObjectURL(this.getResult(!0));
          c.src = e, c.addEventListener("load", this._cleanUpURL, !1), c.addEventListener("error", this._cleanUpURL, !1)
        } else c.src = this._item.src;
      else;
      c.complete ? a(c) : (c.onload = createjs.proxy(function() {
        a(this._tag), c.onload = c.onerror = null
      }, this), c.onerror = createjs.proxy(function(a) {
        b(new createjs.ErrorEvent("IMAGE_FORMAT", null, a)), c.onload = c.onerror = null
      }, this))
    }, b._cleanUpURL = function(a) {
      var b = window.URL || window.webkitURL;
      b.revokeObjectURL(a.target.src)
    }, createjs.ImageLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.AbstractLoader_constructor(a, b, createjs.Types.JAVASCRIPT), this.resultFormatter = this._formatResult, this._tagSrcAttribute = "src", this.setTag(createjs.Elements.script())
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.canLoadItem = function(a) {
      return a.type == createjs.Types.JAVASCRIPT
    }, b._formatResult = function(a) {
      var b = a.getTag();
      return this._preferXHR && (b.text = a.getResult(!0)), b
    }, createjs.JavaScriptLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.AbstractLoader_constructor(a, !0, createjs.Types.JSON), this.resultFormatter = this._formatResult
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.canLoadItem = function(a) {
      return a.type == createjs.Types.JSON
    }, b._formatResult = function(a) {
      var b = null;
      try {
        b = createjs.DataUtils.parseJSON(a.getResult(!0))
      } catch (c) {
        var d = new createjs.ErrorEvent("JSON_FORMAT", null, c);
        return this._sendError(d), c
      }
      return b
    }, createjs.JSONLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.AbstractLoader_constructor(a, !1, createjs.Types.JSONP), this.setTag(createjs.Elements.script()), this.getTag().type = "text/javascript"
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.canLoadItem = function(a) {
      return a.type == createjs.Types.JSONP
    }, b.cancel = function() {
      this.AbstractLoader_cancel(), this._dispose()
    }, b.load = function() {
      if (null == this._item.callback) throw new Error("callback is required for loading JSONP requests.");
      if (null != window[this._item.callback]) throw new Error("JSONP callback '" + this._item.callback + "' already exists on window. You need to specify a different callback or re-name the current one.");
      window[this._item.callback] = createjs.proxy(this._handleLoad, this), createjs.DomUtils.appendToBody(this._tag), this._loadTimeout = setTimeout(createjs.proxy(this._handleTimeout, this), this._item.loadTimeout), this._tag.src = this._item.src
    }, b._handleLoad = function(a) {
      this._result = this._rawResult = a, this._sendComplete(), this._dispose()
    }, b._handleTimeout = function() {
      this._dispose(), this.dispatchEvent(new createjs.ErrorEvent("timeout"))
    }, b._dispose = function() {
      createjs.DomUtils.removeChild(this._tag), delete window[this._item.callback], clearTimeout(this._loadTimeout)
    }, createjs.JSONPLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.AbstractLoader_constructor(a, b, createjs.Types.MANIFEST), this.plugins = null, this._manifestQueue = null
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.MANIFEST_PROGRESS = .25, c.canLoadItem = function(a) {
      return a.type == createjs.Types.MANIFEST
    }, b.load = function() {
      this.AbstractLoader_load()
    }, b._createRequest = function() {
      var a = this._item.callback;
      null != a ? this._request = new createjs.JSONPLoader(this._item) : this._request = new createjs.JSONLoader(this._item)
    }, b.handleEvent = function(a) {
      switch (a.type) {
        case "complete":
          return this._rawResult = a.target.getResult(!0), this._result = a.target.getResult(), this._sendProgress(c.MANIFEST_PROGRESS), void this._loadManifest(this._result);
        case "progress":
          return a.loaded *= c.MANIFEST_PROGRESS, this.progress = a.loaded / a.total, (isNaN(this.progress) || this.progress == 1 / 0) && (this.progress = 0), void this._sendProgress(a)
      }
      this.AbstractLoader_handleEvent(a)
    }, b.destroy = function() {
      this.AbstractLoader_destroy(), this._manifestQueue.close()
    }, b._loadManifest = function(a) {
      if (a && a.manifest) {
        var b = this._manifestQueue = new createjs.LoadQueue(this._preferXHR);
        b.on("fileload", this._handleManifestFileLoad, this), b.on("progress", this._handleManifestProgress, this), b.on("complete", this._handleManifestComplete, this, !0), b.on("error", this._handleManifestError, this, !0);
        for (var c = 0, d = this.plugins.length; d > c; c++) b.installPlugin(this.plugins[c]);
        b.loadManifest(a)
      } else this._sendComplete()
    }, b._handleManifestFileLoad = function(a) {
      a.target = null, this.dispatchEvent(a)
    }, b._handleManifestComplete = function(a) {
      this._loadedItems = this._manifestQueue.getItems(!0), this._sendComplete()
    }, b._handleManifestProgress = function(a) {
      this.progress = a.progress * (1 - c.MANIFEST_PROGRESS) + c.MANIFEST_PROGRESS, this._sendProgress(this.progress)
    }, b._handleManifestError = function(a) {
      var b = new createjs.Event("fileerror");
      b.item = a.data, this.dispatchEvent(b)
    }, createjs.ManifestLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.AbstractMediaLoader_constructor(a, b, createjs.Types.SOUND), createjs.DomUtils.isAudioTag(a) ? this._tag = a : createjs.DomUtils.isAudioTag(a.src) ? this._tag = a : createjs.DomUtils.isAudioTag(a.tag) && (this._tag = createjs.DomUtils.isAudioTag(a) ? a : a.src), null != this._tag && (this._preferXHR = !1)
    }
    var b = createjs.extend(a, createjs.AbstractMediaLoader),
      c = a;
    c.canLoadItem = function(a) {
      return a.type == createjs.Types.SOUND
    }, b._createTag = function(a) {
      var b = createjs.Elements.audio();
      return b.autoplay = !1, b.preload = "none", b.src = a, b
    }, createjs.SoundLoader = createjs.promote(a, "AbstractMediaLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.AbstractMediaLoader_constructor(a, b, createjs.Types.VIDEO), createjs.DomUtils.isVideoTag(a) || createjs.DomUtils.isVideoTag(a.src) ? (this.setTag(createjs.DomUtils.isVideoTag(a) ? a : a.src), this._preferXHR = !1) : this.setTag(this._createTag())
    }
    var b = createjs.extend(a, createjs.AbstractMediaLoader),
      c = a;
    b._createTag = function() {
      return createjs.Elements.video()
    }, c.canLoadItem = function(a) {
      return a.type == createjs.Types.VIDEO
    }, createjs.VideoLoader = createjs.promote(a, "AbstractMediaLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.AbstractLoader_constructor(a, b, createjs.Types.SPRITESHEET), this._manifestQueue = null
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.SPRITESHEET_PROGRESS = .25, c.canLoadItem = function(a) {
      return a.type == createjs.Types.SPRITESHEET
    }, b.destroy = function() {
      this.AbstractLoader_destroy(), this._manifestQueue.close()
    }, b._createRequest = function() {
      var a = this._item.callback;
      null != a ? this._request = new createjs.JSONPLoader(this._item) : this._request = new createjs.JSONLoader(this._item)
    }, b.handleEvent = function(a) {
      switch (a.type) {
        case "complete":
          return this._rawResult = a.target.getResult(!0), this._result = a.target.getResult(), this._sendProgress(c.SPRITESHEET_PROGRESS), void this._loadManifest(this._result);
        case "progress":
          return a.loaded *= c.SPRITESHEET_PROGRESS, this.progress = a.loaded / a.total, (isNaN(this.progress) || this.progress == 1 / 0) && (this.progress = 0), void this._sendProgress(a)
      }
      this.AbstractLoader_handleEvent(a)
    }, b._loadManifest = function(a) {
      if (a && a.images) {
        var b = this._manifestQueue = new createjs.LoadQueue(this._preferXHR, this._item.path, this._item.crossOrigin);
        b.on("complete", this._handleManifestComplete, this, !0), b.on("fileload", this._handleManifestFileLoad, this), b.on("progress", this._handleManifestProgress, this), b.on("error", this._handleManifestError, this, !0), b.loadManifest(a.images)
      }
    }, b._handleManifestFileLoad = function(a) {
      var b = a.result;
      if (null != b) {
        var c = this.getResult().images,
          d = c.indexOf(a.item.src);
        c[d] = b
      }
    }, b._handleManifestComplete = function(a) {
      this._result = new createjs.SpriteSheet(this._result), this._loadedItems = this._manifestQueue.getItems(!0), this._sendComplete()
    }, b._handleManifestProgress = function(a) {
      this.progress = a.progress * (1 - c.SPRITESHEET_PROGRESS) + c.SPRITESHEET_PROGRESS, this._sendProgress(this.progress)
    }, b._handleManifestError = function(a) {
      var b = new createjs.Event("fileerror");
      b.item = a.data, this.dispatchEvent(b)
    }, createjs.SpriteSheetLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b) {
      this.AbstractLoader_constructor(a, b, createjs.Types.SVG), this.resultFormatter = this._formatResult, this._tagSrcAttribute = "data", b ? this.setTag(createjs.Elements.svg()) : (this.setTag(createjs.Elements.object()), this.getTag().type = "image/svg+xml")
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.canLoadItem = function(a) {
      return a.type == createjs.Types.SVG
    }, b._formatResult = function(a) {
      var b = createjs.DataUtils.parseXML(a.getResult(!0)),
        c = a.getTag();
      if (!this._preferXHR && document.body.contains(c) && document.body.removeChild(c), null != b.documentElement) {
        var d = b.documentElement;
        return document.importNode && (d = document.importNode(d, !0)), c.appendChild(d), c
      }
      return b
    }, createjs.SVGLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.AbstractLoader_constructor(a, !0, createjs.Types.XML), this.resultFormatter = this._formatResult
    }
    var b = createjs.extend(a, createjs.AbstractLoader),
      c = a;
    c.canLoadItem = function(a) {
      return a.type == createjs.Types.XML
    }, b._formatResult = function(a) {
      return createjs.DataUtils.parseXML(a.getResult(!0))
    }, createjs.XMLLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    var a = createjs.SoundJS = createjs.SoundJS || {};
    a.version = "NEXT", a.buildDate = "Thu, 14 Sep 2017 22:19:45 GMT"
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      throw "BrowserDetect cannot be instantiated"
    }
    var b = a.agent = window.navigator.userAgent;
    a.isWindowPhone = b.indexOf("IEMobile") > -1 || b.indexOf("Windows Phone") > -1, a.isFirefox = b.indexOf("Firefox") > -1, a.isOpera = null != window.opera, a.isChrome = b.indexOf("Chrome") > -1, a.isIOS = (b.indexOf("iPod") > -1 || b.indexOf("iPhone") > -1 || b.indexOf("iPad") > -1) && !a.isWindowPhone, a.isAndroid = b.indexOf("Android") > -1 && !a.isWindowPhone, a.isBlackberry = b.indexOf("Blackberry") > -1, createjs.BrowserDetect = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";
    var a = function() {
        this.interrupt = null, this.delay = null, this.offset = null, this.loop = null, this.volume = null, this.pan = null, this.startTime = null, this.duration = null
      },
      b = a.prototype = {},
      c = a;
    c.create = function(a) {
      if ("string" == typeof a) return console && (console.warn || console.log)("Deprecated behaviour. Sound.play takes a configuration object instead of individual arguments. See docs for info."), (new createjs.PlayPropsConfig).set({
        interrupt: a
      });
      if (null == a || a instanceof c || a instanceof Object) return (new createjs.PlayPropsConfig).set(a);
      if (null == a) throw new Error("PlayProps configuration not recognized.")
    }, b.set = function(a) {
      if (null != a)
        for (var b in a) this[b] = a[b];
      return this
    }, b.toString = function() {
      return "[PlayPropsConfig]"
    }, createjs.PlayPropsConfig = c
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      throw "Sound cannot be instantiated"
    }

    function b(a, b) {
      this.init(a, b)
    }
    var c = a;
    c.INTERRUPT_ANY = "any", c.INTERRUPT_EARLY = "early", c.INTERRUPT_LATE = "late", c.INTERRUPT_NONE = "none", c.PLAY_INITED = "playInited", c.PLAY_SUCCEEDED = "playSucceeded", c.PLAY_INTERRUPTED = "playInterrupted", c.PLAY_FINISHED = "playFinished", c.PLAY_FAILED = "playFailed", c.SUPPORTED_EXTENSIONS = ["mp3", "ogg", "opus", "mpeg", "wav", "m4a", "mp4", "aiff", "wma", "mid"], c.EXTENSION_MAP = {
      m4a: "mp4"
    }, c.FILE_PATTERN = /^(?:(\w+:)\/{2}(\w+(?:\.\w+)*\/?))?([\/.]*?(?:[^?]+)?\/)?((?:[^\/?]+)\.(\w+))(?:\?(\S+)?)?$/, c.defaultInterruptBehavior = c.INTERRUPT_NONE, c.alternateExtensions = [], c.activePlugin = null, c._masterVolume = 1, c._getMasterVolume = function() {
      return this._masterVolume
    }, c.getVolume = createjs.deprecate(c._getMasterVolume, "Sound.getVolume"), c._setMasterVolume = function(a) {
      if (null != Number(a) && (a = Math.max(0, Math.min(1, a)), c._masterVolume = a, !this.activePlugin || !this.activePlugin.setVolume || !this.activePlugin.setVolume(a)))
        for (var b = this._instances, d = 0, e = b.length; e > d; d++) b[d].setMasterVolume(a)
    }, c.setVolume = createjs.deprecate(c._setMasterVolume, "Sound.setVolume"), c._masterMute = !1, c._getMute = function() {
      return this._masterMute
    }, c.getMute = createjs.deprecate(c._getMute, "Sound.getMute"), c._setMute = function(a) {
      if (null != a && (this._masterMute = a, !this.activePlugin || !this.activePlugin.setMute || !this.activePlugin.setMute(a)))
        for (var b = this._instances, c = 0, d = b.length; d > c; c++) b[c].setMasterMute(a)
    }, c.setMute = createjs.deprecate(c._setMute, "Sound.setMute"), c._getCapabilities = function() {
      return null == c.activePlugin ? null : c.activePlugin._capabilities
    }, c.getCapabilities = createjs.deprecate(c._getCapabilities, "Sound.getCapabilities"), Object.defineProperties(c, {
      volume: {
        get: c._getMasterVolume,
        set: c._setMasterVolume
      },
      muted: {
        get: c._getMute,
        set: c._setMute
      },
      capabilities: {
        get: c._getCapabilities
      }
    }), c._pluginsRegistered = !1, c._lastID = 0, c._instances = [], c._idHash = {}, c._preloadHash = {}, c._defaultPlayPropsHash = {}, c.addEventListener = null, c.removeEventListener = null, c.removeAllEventListeners = null, c.dispatchEvent = null, c.hasEventListener = null, c._listeners = null, createjs.EventDispatcher.initialize(c), c.getPreloadHandlers = function() {
      return {
        callback: createjs.proxy(c.initLoad, c),
        types: ["sound"],
        extensions: c.SUPPORTED_EXTENSIONS
      }
    }, c._handleLoadComplete = function(a) {
      var b = a.target.getItem().src;
      if (c._preloadHash[b])
        for (var d = 0, e = c._preloadHash[b].length; e > d; d++) {
          var f = c._preloadHash[b][d];
          if (c._preloadHash[b][d] = !0, c.hasEventListener("fileload")) {
            var a = new createjs.Event("fileload");
            a.src = f.src, a.id = f.id, a.data = f.data, a.sprite = f.sprite, c.dispatchEvent(a)
          }
        }
    }, c._handleLoadError = function(a) {
      var b = a.target.getItem().src;
      if (c._preloadHash[b])
        for (var d = 0, e = c._preloadHash[b].length; e > d; d++) {
          var f = c._preloadHash[b][d];
          if (c._preloadHash[b][d] = !1, c.hasEventListener("fileerror")) {
            var a = new createjs.Event("fileerror");
            a.src = f.src, a.id = f.id, a.data = f.data, a.sprite = f.sprite, c.dispatchEvent(a)
          }
        }
    }, c._registerPlugin = function(a) {
      return a.isSupported() ? (c.activePlugin = new a, !0) : !1
    }, c.registerPlugins = function(a) {
      c._pluginsRegistered = !0;
      for (var b = 0, d = a.length; d > b; b++)
        if (c._registerPlugin(a[b])) return !0;
      return !1
    }, c.initializeDefaultPlugins = function() {
      return null != c.activePlugin ? !0 : c._pluginsRegistered ? !1 : c.registerPlugins([createjs.WebAudioPlugin, createjs.HTMLAudioPlugin]) ? !0 : !1
    }, c.isReady = function() {
      return null != c.activePlugin
    }, c.initLoad = function(a) {
      return "video" == a.type ? !0 : c._registerSound(a)
    }, c._registerSound = function(a) {
      if (!c.initializeDefaultPlugins()) return !1;
      var d;
      if (a.src instanceof Object ? (d = c._parseSrc(a.src), d.src = a.path + d.src) : d = c._parsePath(a.src), null == d) return !1;
      a.src = d.src, a.type = "sound";
      var e = a.data,
        f = null;
      if (null != e && (isNaN(e.channels) ? isNaN(e) || (f = parseInt(e)) : f = parseInt(e.channels), e.audioSprite))
        for (var g, h = e.audioSprite.length; h--;) g = e.audioSprite[h], c._idHash[g.id] = {
          src: a.src,
          startTime: parseInt(g.startTime),
          duration: parseInt(g.duration)
        }, g.defaultPlayProps && (c._defaultPlayPropsHash[g.id] = createjs.PlayPropsConfig.create(g.defaultPlayProps));
      null != a.id && (c._idHash[a.id] = {
        src: a.src
      });
      var i = c.activePlugin.register(a);
      return b.create(a.src, f), null != e && isNaN(e) ? a.data.channels = f || b.maxPerChannel() : a.data = f || b.maxPerChannel(), i.type && (a.type = i.type), a.defaultPlayProps && (c._defaultPlayPropsHash[a.src] = createjs.PlayPropsConfig.create(a.defaultPlayProps)), i
    }, c.registerSound = function(a, b, d, e, f) {
      var g = {
        src: a,
        id: b,
        data: d,
        defaultPlayProps: f
      };
      a instanceof Object && a.src && (e = b, g = a), g = createjs.LoadItem.create(g), g.path = e, null == e || g.src instanceof Object || (g.src = e + g.src);
      var h = c._registerSound(g);
      if (!h) return !1;
      if (c._preloadHash[g.src] || (c._preloadHash[g.src] = []), c._preloadHash[g.src].push(g), 1 == c._preloadHash[g.src].length) h.on("complete", this._handleLoadComplete, this), h.on("error", this._handleLoadError, this), c.activePlugin.preload(h);
      else if (1 == c._preloadHash[g.src][0]) return !0;
      return g
    }, c.registerSounds = function(a, b) {
      var c = [];
      a.path && (b ? b += a.path : b = a.path, a = a.manifest);
      for (var d = 0, e = a.length; e > d; d++) c[d] = createjs.Sound.registerSound(a[d].src, a[d].id, a[d].data, b, a[d].defaultPlayProps);
      return c
    }, c.removeSound = function(a, d) {
      if (null == c.activePlugin) return !1;
      a instanceof Object && a.src && (a = a.src);
      var e;
      if (a instanceof Object ? e = c._parseSrc(a) : (a = c._getSrcById(a).src, e = c._parsePath(a)), null == e) return !1;
      a = e.src, null != d && (a = d + a);
      for (var f in c._idHash) c._idHash[f].src == a && delete c._idHash[f];
      return b.removeSrc(a), delete c._preloadHash[a], c.activePlugin.removeSound(a), !0
    }, c.removeSounds = function(a, b) {
      var c = [];
      a.path && (b ? b += a.path : b = a.path, a = a.manifest);
      for (var d = 0, e = a.length; e > d; d++) c[d] = createjs.Sound.removeSound(a[d].src, b);
      return c
    }, c.removeAllSounds = function() {
      c._idHash = {}, c._preloadHash = {}, b.removeAll(), c.activePlugin && c.activePlugin.removeAllSounds()
    }, c.loadComplete = function(a) {
      if (!c.isReady()) return !1;
      var b = c._parsePath(a);
      return a = b ? c._getSrcById(b.src).src : c._getSrcById(a).src, void 0 == c._preloadHash[a] ? !1 : 1 == c._preloadHash[a][0]
    }, c._parsePath = function(a) {
      "string" != typeof a && (a = a.toString());
      var b = a.match(c.FILE_PATTERN);
      if (null == b) return !1;
      for (var d = b[4], e = b[5], f = c.capabilities, g = 0; !f[e];)
        if (e = c.alternateExtensions[g++], g > c.alternateExtensions.length) return null;
      a = a.replace("." + b[5], "." + e);
      var h = {
        name: d,
        src: a,
        extension: e
      };
      return h
    }, c._parseSrc = function(a) {
      var b = {
          name: void 0,
          src: void 0,
          extension: void 0
        },
        d = c.capabilities;
      for (var e in a)
        if (a.hasOwnProperty(e) && d[e]) {
          b.src = a[e], b.extension = e;
          break
        } if (!b.src) return !1;
      var f = b.src.lastIndexOf("/");
      return -1 != f ? b.name = b.src.slice(f + 1) : b.name = b.src, b
    }, c.play = function(a, b) {
      var d = createjs.PlayPropsConfig.create(b),
        e = c.createInstance(a, d.startTime, d.duration),
        f = c._playInstance(e, d);
      return f || e._playFailed(), e
    }, c.createInstance = function(a, d, e) {
      if (!c.initializeDefaultPlugins()) return new createjs.DefaultSoundInstance(a, d, e);
      var f = c._defaultPlayPropsHash[a];
      a = c._getSrcById(a);
      var g = c._parsePath(a.src),
        h = null;
      return null != g && null != g.src ? (b.create(g.src), null == d && (d = a.startTime), h = c.activePlugin.create(g.src, d, e || a.duration), f = f || c._defaultPlayPropsHash[g.src], f && h.applyPlayProps(f)) : h = new createjs.DefaultSoundInstance(a, d, e), h.uniqueId = c._lastID++, h
    }, c.stop = function() {
      for (var a = this._instances, b = a.length; b--;) a[b].stop()
    }, c.setDefaultPlayProps = function(a, b) {
      a = c._getSrcById(a), c._defaultPlayPropsHash[c._parsePath(a.src).src] = createjs.PlayPropsConfig.create(b)
    }, c.getDefaultPlayProps = function(a) {
      return a = c._getSrcById(a), c._defaultPlayPropsHash[c._parsePath(a.src).src]
    }, c._playInstance = function(a, b) {
      var d = c._defaultPlayPropsHash[a.src] || {};
      if (null == b.interrupt && (b.interrupt = d.interrupt || c.defaultInterruptBehavior), null == b.delay && (b.delay = d.delay || 0), null == b.offset && (b.offset = a.position), null == b.loop && (b.loop = a.loop), null == b.volume && (b.volume = a.volume), null == b.pan && (b.pan = a.pan), 0 == b.delay) {
        var e = c._beginPlaying(a, b);
        if (!e) return !1
      } else {
        var f = setTimeout(function() {
          c._beginPlaying(a, b)
        }, b.delay);
        a.delayTimeoutId = f
      }
      return this._instances.push(a), !0
    }, c._beginPlaying = function(a, c) {
      if (!b.add(a, c.interrupt)) return !1;
      var d = a._beginPlaying(c);
      if (!d) {
        var e = createjs.indexOf(this._instances, a);
        return e > -1 && this._instances.splice(e, 1), !1
      }
      return !0
    }, c._getSrcById = function(a) {
      return c._idHash[a] || {
        src: a
      }
    }, c._playFinished = function(a) {
      b.remove(a);
      var c = createjs.indexOf(this._instances, a);
      c > -1 && this._instances.splice(c, 1)
    }, createjs.Sound = a, b.channels = {}, b.create = function(a, c) {
      var d = b.get(a);
      return null == d ? (b.channels[a] = new b(a, c), !0) : !1
    }, b.removeSrc = function(a) {
      var c = b.get(a);
      return null == c ? !1 : (c._removeAll(), delete b.channels[a], !0)
    }, b.removeAll = function() {
      for (var a in b.channels) b.channels[a]._removeAll();
      b.channels = {}
    }, b.add = function(a, c) {
      var d = b.get(a.src);
      return null == d ? !1 : d._add(a, c)
    }, b.remove = function(a) {
      var c = b.get(a.src);
      return null == c ? !1 : (c._remove(a), !0)
    }, b.maxPerChannel = function() {
      return d.maxDefault
    }, b.get = function(a) {
      return b.channels[a]
    };
    var d = b.prototype;
    d.constructor = b, d.src = null, d.max = null, d.maxDefault = 100, d.length = 0, d.init = function(a, b) {
      this.src = a, this.max = b || this.maxDefault, -1 == this.max && (this.max = this.maxDefault), this._instances = []
    }, d._get = function(a) {
      return this._instances[a]
    }, d._add = function(a, b) {
      return this._getSlot(b, a) ? (this._instances.push(a), this.length++, !0) : !1
    }, d._remove = function(a) {
      var b = createjs.indexOf(this._instances, a);
      return -1 == b ? !1 : (this._instances.splice(b, 1), this.length--, !0)
    }, d._removeAll = function() {
      for (var a = this.length - 1; a >= 0; a--) this._instances[a].stop()
    }, d._getSlot = function(b, c) {
      var d, e;
      if (b != a.INTERRUPT_NONE && (e = this._get(0), null == e)) return !0;
      for (var f = 0, g = this.max; g > f; f++) {
        if (d = this._get(f), null == d) return !0;
        if (d.playState == a.PLAY_FINISHED || d.playState == a.PLAY_INTERRUPTED || d.playState == a.PLAY_FAILED) {
          e = d;
          break
        }
        b != a.INTERRUPT_NONE && (b == a.INTERRUPT_EARLY && d.position < e.position || b == a.INTERRUPT_LATE && d.position > e.position) && (e = d)
      }
      return null != e ? (e._interrupt(), this._remove(e), !0) : !1
    }, d.toString = function() {
      return "[Sound SoundChannel]"
    }
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";
    var a = function(a, b, c, d) {
        this.EventDispatcher_constructor(), this.src = a, this.uniqueId = -1, this.playState = null, this.delayTimeoutId = null, this._volume = 1, Object.defineProperty(this, "volume", {
          get: this._getVolume,
          set: this._setVolume
        }), this._pan = 0, Object.defineProperty(this, "pan", {
          get: this._getPan,
          set: this._setPan
        }), this._startTime = Math.max(0, b || 0), Object.defineProperty(this, "startTime", {
          get: this._getStartTime,
          set: this._setStartTime
        }), this._duration = Math.max(0, c || 0), Object.defineProperty(this, "duration", {
          get: this._getDuration,
          set: this._setDuration
        }), this._playbackResource = null, Object.defineProperty(this, "playbackResource", {
          get: this._getPlaybackResource,
          set: this._setPlaybackResource
        }), d !== !1 && d !== !0 && this._setPlaybackResource(d), this._position = 0, Object.defineProperty(this, "position", {
          get: this._getPosition,
          set: this._setPosition
        }), this._loop = 0, Object.defineProperty(this, "loop", {
          get: this._getLoop,
          set: this._setLoop
        }), this._muted = !1, Object.defineProperty(this, "muted", {
          get: this._getMuted,
          set: this._setMuted
        }), this._paused = !1, Object.defineProperty(this, "paused", {
          get: this._getPaused,
          set: this._setPaused
        })
      },
      b = createjs.extend(a, createjs.EventDispatcher);
    b.play = function(a) {
      var b = createjs.PlayPropsConfig.create(a);
      return this.playState == createjs.Sound.PLAY_SUCCEEDED ? (this.applyPlayProps(b), void(this._paused && this._setPaused(!1))) : (this._cleanUp(), createjs.Sound._playInstance(this, b), this)
    }, b.stop = function() {
      return this._position = 0, this._paused = !1, this._handleStop(), this._cleanUp(), this.playState = createjs.Sound.PLAY_FINISHED, this
    }, b.destroy = function() {
      this._cleanUp(), this.src = null, this.playbackResource = null, this.removeAllEventListeners()
    }, b.applyPlayProps = function(a) {
      return null != a.offset && this._setPosition(a.offset), null != a.loop && this._setLoop(a.loop), null != a.volume && this._setVolume(a.volume), null != a.pan && this._setPan(a.pan), null != a.startTime && (this._setStartTime(a.startTime), this._setDuration(a.duration)), this
    }, b.toString = function() {
      return "[AbstractSoundInstance]"
    }, b._getPaused = function() {
      return this._paused
    }, b._setPaused = function(a) {
      return a !== !0 && a !== !1 || this._paused == a || 1 == a && this.playState != createjs.Sound.PLAY_SUCCEEDED ? void 0 : (this._paused = a, a ? this._pause() : this._resume(), clearTimeout(this.delayTimeoutId), this)
    }, b._setVolume = function(a) {
      return a == this._volume ? this : (this._volume = Math.max(0, Math.min(1, a)), this._muted || this._updateVolume(), this)
    }, b._getVolume = function() {
      return this._volume
    }, b._setMuted = function(a) {
      return a === !0 || a === !1 ? (this._muted = a, this._updateVolume(), this) : void 0
    }, b._getMuted = function() {
      return this._muted
    }, b._setPan = function(a) {
      return a == this._pan ? this : (this._pan = Math.max(-1, Math.min(1, a)), this._updatePan(), this)
    }, b._getPan = function() {
      return this._pan
    }, b._getPosition = function() {
      return this._paused || this.playState != createjs.Sound.PLAY_SUCCEEDED || (this._position = this._calculateCurrentPosition()), this._position
    }, b._setPosition = function(a) {
      return this._position = Math.max(0, a), this.playState == createjs.Sound.PLAY_SUCCEEDED && this._updatePosition(), this
    }, b._getStartTime = function() {
      return this._startTime
    }, b._setStartTime = function(a) {
      return a == this._startTime ? this : (this._startTime = Math.max(0, a || 0), this._updateStartTime(), this)
    }, b._getDuration = function() {
      return this._duration
    }, b._setDuration = function(a) {
      return a == this._duration ? this : (this._duration = Math.max(0, a || 0), this._updateDuration(), this)
    }, b._setPlaybackResource = function(a) {
      return this._playbackResource = a, 0 == this._duration && this._playbackResource && this._setDurationFromSource(), this
    }, b._getPlaybackResource = function() {
      return this._playbackResource
    }, b._getLoop = function() {
      return this._loop
    }, b._setLoop = function(a) {
      null != this._playbackResource && (0 != this._loop && 0 == a ? this._removeLooping(a) : 0 == this._loop && 0 != a && this._addLooping(a)), this._loop = a
    }, b._sendEvent = function(a) {
      var b = new createjs.Event(a);
      this.dispatchEvent(b)
    }, b._cleanUp = function() {
      clearTimeout(this.delayTimeoutId), this._handleCleanUp(), this._paused = !1, createjs.Sound._playFinished(this)
    }, b._interrupt = function() {
      this._cleanUp(), this.playState = createjs.Sound.PLAY_INTERRUPTED, this._sendEvent("interrupted")
    }, b._beginPlaying = function(a) {
      return this._setPosition(a.offset), this._setLoop(a.loop), this._setVolume(a.volume), this._setPan(a.pan), null != a.startTime && (this._setStartTime(a.startTime), this._setDuration(a.duration)), null != this._playbackResource && this._position < this._duration ? (this._paused = !1, this._handleSoundReady(), this.playState = createjs.Sound.PLAY_SUCCEEDED, this._sendEvent("succeeded"), !0) : (this._playFailed(), !1)
    }, b._playFailed = function() {
      this._cleanUp(), this.playState = createjs.Sound.PLAY_FAILED, this._sendEvent("failed")
    }, b._handleSoundComplete = function(a) {
      return this._position = 0, 0 != this._loop ? (this._loop--, this._handleLoop(), void this._sendEvent("loop")) : (this._cleanUp(), this.playState = createjs.Sound.PLAY_FINISHED, void this._sendEvent("complete"))
    }, b._handleSoundReady = function() {}, b._updateVolume = function() {}, b._updatePan = function() {}, b._updateStartTime = function() {}, b._updateDuration = function() {}, b._setDurationFromSource = function() {}, b._calculateCurrentPosition = function() {}, b._updatePosition = function() {}, b._removeLooping = function(a) {}, b._addLooping = function(a) {}, b._pause = function() {}, b._resume = function() {}, b._handleStop = function() {}, b._handleCleanUp = function() {}, b._handleLoop = function() {}, createjs.AbstractSoundInstance = createjs.promote(a, "EventDispatcher"), createjs.DefaultSoundInstance = createjs.AbstractSoundInstance
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";
    var a = function() {
        this._capabilities = null, this._loaders = {}, this._audioSources = {}, this._soundInstances = {}, this._volume = 1, this._loaderClass, this._soundInstanceClass
      },
      b = a.prototype;
    a._capabilities = null, a.isSupported = function() {
      return !0
    }, b.register = function(a) {
      var b = this._loaders[a.src];
      return b && !b.canceled ? this._loaders[a.src] : (this._audioSources[a.src] = !0, this._soundInstances[a.src] = [], b = new this._loaderClass(a), b.on("complete", this._handlePreloadComplete, this), this._loaders[a.src] = b, b)
    }, b.preload = function(a) {
      a.on("error", this._handlePreloadError, this), a.load()
    }, b.isPreloadStarted = function(a) {
      return null != this._audioSources[a]
    }, b.isPreloadComplete = function(a) {
      return !(null == this._audioSources[a] || 1 == this._audioSources[a])
    }, b.removeSound = function(a) {
      if (this._soundInstances[a]) {
        for (var b = this._soundInstances[a].length; b--;) {
          var c = this._soundInstances[a][b];
          c.destroy()
        }
        delete this._soundInstances[a], delete this._audioSources[a], this._loaders[a] && this._loaders[a].destroy(), delete this._loaders[a]
      }
    }, b.removeAllSounds = function() {
      for (var a in this._audioSources) this.removeSound(a)
    }, b.create = function(a, b, c) {
      this.isPreloadStarted(a) || this.preload(this.register(a));
      var d = new this._soundInstanceClass(a, b, c, this._audioSources[a]);
      return this._soundInstances[a] && this._soundInstances[a].push(d), d.setMasterVolume && d.setMasterVolume(createjs.Sound.volume), d.setMasterMute && d.setMasterMute(createjs.Sound.muted), d
    }, b.setVolume = function(a) {
      return this._volume = a, this._updateVolume(), !0
    }, b.getVolume = function() {
      return this._volume
    }, b.setMute = function(a) {
      return this._updateVolume(), !0
    }, b.toString = function() {
      return "[AbstractPlugin]"
    }, b._handlePreloadComplete = function(a) {
      var b = a.target.getItem().src;
      this._audioSources[b] = a.result;
      for (var c = 0, d = this._soundInstances[b].length; d > c; c++) {
        var e = this._soundInstances[b][c];
        e.setPlaybackResource(this._audioSources[b]), this._soundInstances[b] = null
      }
    }, b._handlePreloadError = function(a) {}, b._updateVolume = function() {}, createjs.AbstractPlugin = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.AbstractLoader_constructor(a, !0, createjs.Types.SOUND)
    }
    var b = createjs.extend(a, createjs.AbstractLoader);
    a.context = null, b.toString = function() {
      return "[WebAudioLoader]"
    }, b._createRequest = function() {
      this._request = new createjs.XHRRequest(this._item, !1), this._request.setResponseType("arraybuffer")
    }, b._sendComplete = function(b) {
      a.context.decodeAudioData(this._rawResult, createjs.proxy(this._handleAudioDecoded, this), createjs.proxy(this._sendError, this))
    }, b._handleAudioDecoded = function(a) {
      this._result = a, this.AbstractLoader__sendComplete()
    }, createjs.WebAudioLoader = createjs.promote(a, "AbstractLoader")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, d, e) {
      this.AbstractSoundInstance_constructor(a, b, d, e), this.gainNode = c.context.createGain(), this.panNode = c.context.createPanner(), this.panNode.panningModel = c._panningModel, this.panNode.connect(this.gainNode), this._updatePan(), this.sourceNode = null, this._soundCompleteTimeout = null, this._sourceNodeNext = null, this._playbackStartTime = 0, this._endedHandler = createjs.proxy(this._handleSoundComplete, this)
    }
    var b = createjs.extend(a, createjs.AbstractSoundInstance),
      c = a;
    c.context = null, c._scratchBuffer = null, c.destinationNode = null, c._panningModel = "equalpower", b.destroy = function() {
      this.AbstractSoundInstance_destroy(), this.panNode.disconnect(0), this.panNode = null, this.gainNode.disconnect(0), this.gainNode = null
    }, b.toString = function() {
      return "[WebAudioSoundInstance]"
    }, b._updatePan = function() {
      this.panNode.setPosition(this._pan, 0, -.5)
    }, b._removeLooping = function(a) {
      this._sourceNodeNext = this._cleanUpAudioNode(this._sourceNodeNext)
    }, b._addLooping = function(a) {
      this.playState == createjs.Sound.PLAY_SUCCEEDED && (this._sourceNodeNext = this._createAndPlayAudioNode(this._playbackStartTime, 0))
    }, b._setDurationFromSource = function() {
      this._duration = 1e3 * this.playbackResource.duration
    }, b._handleCleanUp = function() {
      this.sourceNode && this.playState == createjs.Sound.PLAY_SUCCEEDED && (this.sourceNode = this._cleanUpAudioNode(this.sourceNode), this._sourceNodeNext = this._cleanUpAudioNode(this._sourceNodeNext)), 0 != this.gainNode.numberOfOutputs && this.gainNode.disconnect(0), clearTimeout(this._soundCompleteTimeout), this._playbackStartTime = 0
    }, b._cleanUpAudioNode = function(a) {
      if (a) {
        if (a.stop(0), a.disconnect(0), createjs.BrowserDetect.isIOS) try {
          a.buffer = c._scratchBuffer
        } catch (b) {}
        a = null
      }
      return a
    }, b._handleSoundReady = function(a) {
      this.gainNode.connect(c.destinationNode);
      var b = .001 * this._duration,
        d = Math.min(.001 * Math.max(0, this._position), b);
      this.sourceNode = this._createAndPlayAudioNode(c.context.currentTime - b, d), this._playbackStartTime = this.sourceNode.startTime - d, this._soundCompleteTimeout = setTimeout(this._endedHandler, 1e3 * (b - d)), 0 != this._loop && (this._sourceNodeNext = this._createAndPlayAudioNode(this._playbackStartTime, 0))
    }, b._createAndPlayAudioNode = function(a, b) {
      var d = c.context.createBufferSource();
      d.buffer = this.playbackResource, d.connect(this.panNode);
      var e = .001 * this._duration;
      return d.startTime = a + e, d.start(d.startTime, b + .001 * this._startTime, e - b), d
    }, b._pause = function() {
      this._position = 1e3 * (c.context.currentTime - this._playbackStartTime), this.sourceNode = this._cleanUpAudioNode(this.sourceNode), this._sourceNodeNext = this._cleanUpAudioNode(this._sourceNodeNext), 0 != this.gainNode.numberOfOutputs && this.gainNode.disconnect(0), clearTimeout(this._soundCompleteTimeout)
    }, b._resume = function() {
      this._handleSoundReady()
    }, b._updateVolume = function() {
      var a = this._muted ? 0 : this._volume;
      a != this.gainNode.gain.value && (this.gainNode.gain.value = a)
    }, b._calculateCurrentPosition = function() {
      return 1e3 * (c.context.currentTime - this._playbackStartTime)
    }, b._updatePosition = function() {
      this.sourceNode = this._cleanUpAudioNode(this.sourceNode), this._sourceNodeNext = this._cleanUpAudioNode(this._sourceNodeNext), clearTimeout(this._soundCompleteTimeout), this._paused || this._handleSoundReady()
    }, b._handleLoop = function() {
      this._cleanUpAudioNode(this.sourceNode), this.sourceNode = this._sourceNodeNext, this._playbackStartTime = this.sourceNode.startTime, this._sourceNodeNext = this._createAndPlayAudioNode(this._playbackStartTime, 0), this._soundCompleteTimeout = setTimeout(this._endedHandler, this._duration)
    }, b._updateDuration = function() {
      this.playState == createjs.Sound.PLAY_SUCCEEDED && (this._pause(), this._resume())
    }, createjs.WebAudioSoundInstance = createjs.promote(a, "AbstractSoundInstance")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      this.AbstractPlugin_constructor(), this._panningModel = c._panningModel, this.context = c.context, this.dynamicsCompressorNode = this.context.createDynamicsCompressor(), this.dynamicsCompressorNode.connect(this.context.destination), this.gainNode = this.context.createGain(), this.gainNode.connect(this.dynamicsCompressorNode), createjs.WebAudioSoundInstance.destinationNode = this.gainNode, this._capabilities = c._capabilities, this._loaderClass = createjs.WebAudioLoader, this._soundInstanceClass = createjs.WebAudioSoundInstance, this._addPropsToClasses()
    }
    var b = createjs.extend(a, createjs.AbstractPlugin),
      c = a;
    c._capabilities = null, c._panningModel = "equalpower", c.context = null, c._scratchBuffer = null, c._unlocked = !1, c.DEFAULT_SAMPLE_RATE = 44100, c.isSupported = function() {
      var a = createjs.BrowserDetect.isIOS || createjs.BrowserDetect.isAndroid || createjs.BrowserDetect.isBlackberry;
      return "file:" != location.protocol || a || this._isFileXHRSupported() ? (c._generateCapabilities(), null == c.context ? !1 : !0) : !1
    }, c.playEmptySound = function() {
      if (null != c.context) {
        var a = c.context.createBufferSource();
        a.buffer = c._scratchBuffer, a.connect(c.context.destination), a.start(0, 0, 0)
      }
    }, c._isFileXHRSupported = function() {
      var a = !0,
        b = new XMLHttpRequest;
      try {
        b.open("GET", "WebAudioPluginTest.fail", !1)
      } catch (c) {
        return a = !1
      }
      b.onerror = function() {
        a = !1
      }, b.onload = function() {
        a = 404 == this.status || 200 == this.status || 0 == this.status && "" != this.response
      };
      try {
        b.send()
      } catch (c) {
        a = !1
      }
      return a
    }, c._generateCapabilities = function() {
      if (null == c._capabilities) {
        var a = document.createElement("audio");
        if (null == a.canPlayType) return null;
        if (null == c.context && (c.context = c._createAudioContext(), null == c.context)) return null;
        null == c._scratchBuffer && (c._scratchBuffer = c.context.createBuffer(1, 1, 22050)), c._compatibilitySetUp(), "ontouchstart" in window && "running" != c.context.state && (c._unlock(), document.addEventListener("mousedown", c._unlock, !0), document.addEventListener("touchstart", c._unlock, !0), document.addEventListener("touchend", c._unlock, !0)), c._capabilities = {
          panning: !0,
          volume: !0,
          tracks: -1
        };
        for (var b = createjs.Sound.SUPPORTED_EXTENSIONS, d = createjs.Sound.EXTENSION_MAP, e = 0, f = b.length; f > e; e++) {
          var g = b[e],
            h = d[g] || g;
          c._capabilities[g] = "no" != a.canPlayType("audio/" + g) && "" != a.canPlayType("audio/" + g) || "no" != a.canPlayType("audio/" + h) && "" != a.canPlayType("audio/" + h)
        }
        c.context.destination.numberOfChannels < 2 && (c._capabilities.panning = !1)
      }
    }, c._createAudioContext = function() {
      var a = window.AudioContext || window.webkitAudioContext;
      if (null == a) return null;
      var b = new a;
      if (/(iPhone|iPad)/i.test(navigator.userAgent) && b.sampleRate !== c.DEFAULT_SAMPLE_RATE) {
        var d = b.createBuffer(1, 1, c.DEFAULT_SAMPLE_RATE),
          e = b.createBufferSource();
        e.buffer = d, e.connect(b.destination), e.start(0), e.disconnect(), b.close(), b = new a
      }
      return b
    }, c._compatibilitySetUp = function() {
      if (c._panningModel = "equalpower", !c.context.createGain) {
        c.context.createGain = c.context.createGainNode;
        var a = c.context.createBufferSource();
        a.__proto__.start = a.__proto__.noteGrainOn, a.__proto__.stop = a.__proto__.noteOff, c._panningModel = 0
      }
    }, c._unlock = function() {
      c._unlocked || (c.playEmptySound(), "running" == c.context.state && (document.removeEventListener("mousedown", c._unlock, !0), document.removeEventListener("touchend", c._unlock, !0), document.removeEventListener("touchstart", c._unlock, !0), c._unlocked = !0))
    }, b.toString = function() {
      return "[WebAudioPlugin]"
    }, b._addPropsToClasses = function() {
      var a = this._soundInstanceClass;
      a.context = this.context, a._scratchBuffer = c._scratchBuffer, a.destinationNode = this.gainNode, a._panningModel = this._panningModel, this._loaderClass.context = this.context
    }, b._updateVolume = function() {
      var a = createjs.Sound._masterMute ? 0 : this._volume;
      a != this.gainNode.gain.value && (this.gainNode.gain.value = a)
    }, createjs.WebAudioPlugin = createjs.promote(a, "AbstractPlugin")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      throw "HTMLAudioTagPool cannot be instantiated"
    }

    function b(a) {
      this._tags = []
    }
    var c = a;
    c._tags = {}, c._tagPool = new b, c._tagUsed = {}, c.get = function(a) {
      var b = c._tags[a];
      return null == b ? (b = c._tags[a] = c._tagPool.get(), b.src = a) : c._tagUsed[a] ? (b = c._tagPool.get(), b.src = a) : c._tagUsed[a] = !0, b
    }, c.set = function(a, b) {
      b == c._tags[a] ? c._tagUsed[a] = !1 : c._tagPool.set(b)
    }, c.remove = function(a) {
      var b = c._tags[a];
      return null == b ? !1 : (c._tagPool.set(b), delete c._tags[a], delete c._tagUsed[a], !0)
    }, c.getDuration = function(a) {
      var b = c._tags[a];
      return null != b && b.duration ? 1e3 * b.duration : 0
    }, createjs.HTMLAudioTagPool = a;
    var d = b.prototype;
    d.constructor = b, d.get = function() {
      var a;
      return a = 0 == this._tags.length ? this._createTag() : this._tags.pop(), null == a.parentNode && document.body.appendChild(a), a
    }, d.set = function(a) {
      var b = createjs.indexOf(this._tags, a); - 1 == b && (this._tags.src = null, this._tags.push(a))
    }, d.toString = function() {
      return "[TagPool]"
    }, d._createTag = function() {
      var a = document.createElement("audio");
      return a.autoplay = !1, a.preload = "none", a
    }
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a, b, c, d) {
      this.AbstractSoundInstance_constructor(a, b, c, d), this._audioSpriteStopTime = null, this._delayTimeoutId = null, this._endedHandler = createjs.proxy(this._handleSoundComplete, this), this._readyHandler = createjs.proxy(this._handleTagReady, this), this._stalledHandler = createjs.proxy(this._playFailed, this), this._audioSpriteEndHandler = createjs.proxy(this._handleAudioSpriteLoop, this), this._loopHandler = createjs.proxy(this._handleSoundComplete, this), c ? this._audioSpriteStopTime = .001 * (b + c) : this._duration = createjs.HTMLAudioTagPool.getDuration(this.src)
    }
    var b = createjs.extend(a, createjs.AbstractSoundInstance);
    b.setMasterVolume = function(a) {
      this._updateVolume()
    }, b.setMasterMute = function(a) {
      this._updateVolume()
    }, b.toString = function() {
      return "[HTMLAudioSoundInstance]"
    }, b._removeLooping = function() {
      null != this._playbackResource && (this._playbackResource.loop = !1, this._playbackResource.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED, this._loopHandler, !1))
    }, b._addLooping = function() {
      null == this._playbackResource || this._audioSpriteStopTime || (this._playbackResource.addEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED, this._loopHandler, !1), this._playbackResource.loop = !0)
    }, b._handleCleanUp = function() {
      var a = this._playbackResource;
      if (null != a) {
        a.pause(), a.loop = !1, a.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_ENDED, this._endedHandler, !1), a.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_READY, this._readyHandler, !1), a.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_STALLED, this._stalledHandler, !1), a.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED, this._loopHandler, !1), a.removeEventListener(createjs.HTMLAudioPlugin._TIME_UPDATE, this._audioSpriteEndHandler, !1);
        try {
          a.currentTime = this._startTime
        } catch (b) {}
        createjs.HTMLAudioTagPool.set(this.src, a), this._playbackResource = null
      }
    }, b._beginPlaying = function(a) {
      return this._playbackResource = createjs.HTMLAudioTagPool.get(this.src), this.AbstractSoundInstance__beginPlaying(a)
    }, b._handleSoundReady = function(a) {
      if (4 !== this._playbackResource.readyState) {
        var b = this._playbackResource;
        return b.addEventListener(createjs.HTMLAudioPlugin._AUDIO_READY, this._readyHandler, !1), b.addEventListener(createjs.HTMLAudioPlugin._AUDIO_STALLED, this._stalledHandler, !1), b.preload = "auto", void b.load()
      }
      this._updateVolume(), this._playbackResource.currentTime = .001 * (this._startTime + this._position), this._audioSpriteStopTime ? this._playbackResource.addEventListener(createjs.HTMLAudioPlugin._TIME_UPDATE, this._audioSpriteEndHandler, !1) : (this._playbackResource.addEventListener(createjs.HTMLAudioPlugin._AUDIO_ENDED, this._endedHandler, !1), 0 != this._loop && (this._playbackResource.addEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED, this._loopHandler, !1), this._playbackResource.loop = !0)), this._playbackResource.play()
    }, b._handleTagReady = function(a) {
      this._playbackResource.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_READY, this._readyHandler, !1), this._playbackResource.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_STALLED, this._stalledHandler, !1), this._handleSoundReady()
    }, b._pause = function() {
      this._playbackResource.pause()
    }, b._resume = function() {
      this._playbackResource.play()
    }, b._updateVolume = function() {
      if (null != this._playbackResource) {
        var a = this._muted || createjs.Sound._masterMute ? 0 : this._volume * createjs.Sound._masterVolume;
        a != this._playbackResource.volume && (this._playbackResource.volume = a)
      }
    }, b._calculateCurrentPosition = function() {
      return 1e3 * this._playbackResource.currentTime - this._startTime
    }, b._updatePosition = function() {
      this._playbackResource.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED, this._loopHandler, !1), this._playbackResource.addEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED, this._handleSetPositionSeek, !1);
      try {
        this._playbackResource.currentTime = .001 * (this._position + this._startTime)
      } catch (a) {
        this._handleSetPositionSeek(null)
      }
    }, b._handleSetPositionSeek = function(a) {
      null != this._playbackResource && (this._playbackResource.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED, this._handleSetPositionSeek, !1), this._playbackResource.addEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED, this._loopHandler, !1))
    }, b._handleAudioSpriteLoop = function(a) {
      this._playbackResource.currentTime <= this._audioSpriteStopTime || (this._playbackResource.pause(), 0 == this._loop ? this._handleSoundComplete(null) : (this._position = 0, this._loop--, this._playbackResource.currentTime = .001 * this._startTime, this._paused || this._playbackResource.play(), this._sendEvent("loop")))
    }, b._handleLoop = function(a) {
      0 == this._loop && (this._playbackResource.loop = !1, this._playbackResource.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED, this._loopHandler, !1))
    }, b._updateStartTime = function() {
      this._audioSpriteStopTime = .001 * (this._startTime + this._duration), this.playState == createjs.Sound.PLAY_SUCCEEDED && (this._playbackResource.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_ENDED, this._endedHandler, !1), this._playbackResource.addEventListener(createjs.HTMLAudioPlugin._TIME_UPDATE, this._audioSpriteEndHandler, !1))
    }, b._updateDuration = function() {
      this._audioSpriteStopTime = .001 * (this._startTime + this._duration), this.playState == createjs.Sound.PLAY_SUCCEEDED && (this._playbackResource.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_ENDED, this._endedHandler, !1), this._playbackResource.addEventListener(createjs.HTMLAudioPlugin._TIME_UPDATE, this._audioSpriteEndHandler, !1))
    }, b._setDurationFromSource = function() {
      this._duration = createjs.HTMLAudioTagPool.getDuration(this.src), this._playbackResource = null
    }, createjs.HTMLAudioSoundInstance = createjs.promote(a, "AbstractSoundInstance")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      this.AbstractPlugin_constructor(), this._capabilities = c._capabilities, this._loaderClass = createjs.SoundLoader, this._soundInstanceClass = createjs.HTMLAudioSoundInstance
    }
    var b = createjs.extend(a, createjs.AbstractPlugin),
      c = a;
    c.MAX_INSTANCES = 30, c._AUDIO_READY = "canplaythrough", c._AUDIO_ENDED = "ended", c._AUDIO_SEEKED = "seeked", c._AUDIO_STALLED = "stalled", c._TIME_UPDATE = "timeupdate", c._capabilities = null, c.isSupported = function() {
      return c._generateCapabilities(), null != c._capabilities
    }, c._generateCapabilities = function() {
      if (null == c._capabilities) {
        var a = document.createElement("audio");
        if (null == a.canPlayType) return null;
        c._capabilities = {
          panning: !1,
          volume: !0,
          tracks: -1
        };
        for (var b = createjs.Sound.SUPPORTED_EXTENSIONS, d = createjs.Sound.EXTENSION_MAP, e = 0, f = b.length; f > e; e++) {
          var g = b[e],
            h = d[g] || g;
          c._capabilities[g] = "no" != a.canPlayType("audio/" + g) && "" != a.canPlayType("audio/" + g) || "no" != a.canPlayType("audio/" + h) && "" != a.canPlayType("audio/" + h)
        }
      }
    }, b.register = function(a) {
      var b = createjs.HTMLAudioTagPool.get(a.src),
        c = this.AbstractPlugin_register(a);
      return c.setTag(b), c
    }, b.removeSound = function(a) {
      this.AbstractPlugin_removeSound(a), createjs.HTMLAudioTagPool.remove(a)
    }, b.create = function(a, b, c) {
      var d = this.AbstractPlugin_create(a, b, c);
      return d.playbackResource = null, d
    }, b.toString = function() {
      return "[HTMLAudioPlugin]"
    }, b.setVolume = b.getVolume = b.setMute = null, createjs.HTMLAudioPlugin = createjs.promote(a, "AbstractPlugin")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      this.EventDispatcher_constructor(), this.ignoreGlobalPause = !1, this.loop = 0, this.useTicks = !1, this.reversed = !1, this.bounce = !1, this.timeScale = 1, this.duration = 0, this.position = 0, this.rawPosition = -1, this._paused = !0, this._next = null, this._prev = null, this._parent = null, this._labels = null, this._labelList = null, a && (this.useTicks = !!a.useTicks, this.ignoreGlobalPause = !!a.ignoreGlobalPause, this.loop = a.loop === !0 ? -1 : a.loop || 0, this.reversed = !!a.reversed, this.bounce = !!a.bounce, this.timeScale = a.timeScale || 1, a.onChange && this.addEventListener("change", a.onChange), a.onComplete && this.addEventListener("complete", a.onComplete))
    }
    var b = createjs.extend(a, createjs.EventDispatcher);
    b._setPaused = function(a) {
      return createjs.Tween._register(this, a), this
    }, b.setPaused = createjs.deprecate(b._setPaused, "AbstractTween.setPaused"), b._getPaused = function() {
      return this._paused
    }, b.getPaused = createjs.deprecate(b._getPaused, "AbstactTween.getPaused"), b._getCurrentLabel = function(a) {
      var b = this.getLabels();
      null == a && (a = this.position);
      for (var c = 0, d = b.length; d > c && !(a < b[c].position); c++);
      return 0 === c ? null : b[c - 1].label
    }, b.getCurrentLabel = createjs.deprecate(b._getCurrentLabel, "AbstractTween.getCurrentLabel");
    try {
      Object.defineProperties(b, {
        paused: {
          set: b._setPaused,
          get: b._getPaused
        },
        currentLabel: {
          get: b._getCurrentLabel
        }
      })
    } catch (c) {}
    b.advance = function(a, b) {
      this.setPosition(this.rawPosition + a * this.timeScale, b)
    }, b.setPosition = function(a, b, c, d) {
      var e = this.duration,
        f = this.loop,
        g = this.rawPosition,
        h = 0,
        i = 0,
        j = !1;
      if (0 > a && (a = 0), 0 === e) {
        if (j = !0, -1 !== g) return j
      } else {
        if (h = a / e | 0, i = a - h * e, j = -1 !== f && a >= f * e + e, j && (a = (i = e) * (h = f) + e), a === g) return j;
        var k = !this.reversed != !(this.bounce && h % 2);
        k && (i = e - i)
      }
      this.position = i, this.rawPosition = a, this._updatePosition(c, j), j && (this.paused = !0), d && d(this), b || this._runActions(g, a, c, !c && -1 === g), this.dispatchEvent("change"), j && this.dispatchEvent("complete");
    }, b.calculatePosition = function(a) {
      var b = this.duration,
        c = this.loop,
        d = 0,
        e = 0;
      if (0 === b) return 0; - 1 !== c && a >= c * b + b ? (e = b, d = c) : 0 > a ? e = 0 : (d = a / b | 0, e = a - d * b);
      var f = !this.reversed != !(this.bounce && d % 2);
      return f ? b - e : e
    }, b.getLabels = function() {
      var a = this._labelList;
      if (!a) {
        a = this._labelList = [];
        var b = this._labels;
        for (var c in b) a.push({
          label: c,
          position: b[c]
        });
        a.sort(function(a, b) {
          return a.position - b.position
        })
      }
      return a
    }, b.setLabels = function(a) {
      this._labels = a, this._labelList = null
    }, b.addLabel = function(a, b) {
      this._labels || (this._labels = {}), this._labels[a] = b;
      var c = this._labelList;
      if (c) {
        for (var d = 0, e = c.length; e > d && !(b < c[d].position); d++);
        c.splice(d, 0, {
          label: a,
          position: b
        })
      }
    }, b.gotoAndPlay = function(a) {
      this.paused = !1, this._goto(a)
    }, b.gotoAndStop = function(a) {
      this.paused = !0, this._goto(a)
    }, b.resolve = function(a) {
      var b = Number(a);
      return isNaN(b) && (b = this._labels && this._labels[a]), b
    }, b.toString = function() {
      return "[AbstractTween]"
    }, b.clone = function() {
      throw "AbstractTween can not be cloned."
    }, b._init = function(a) {
      a && a.paused || (this.paused = !1), a && null != a.position && this.setPosition(a.position)
    }, b._updatePosition = function(a, b) {}, b._goto = function(a) {
      var b = this.resolve(a);
      null != b && this.setPosition(b, !1, !0)
    }, b._runActions = function(a, b, c, d) {
      if (this._actionHead || this.tweens) {
        var e, f, g, h, i = this.duration,
          j = this.reversed,
          k = this.bounce,
          l = this.loop;
        if (0 === i ? (e = f = g = h = 0, j = k = !1) : (e = a / i | 0, f = b / i | 0, g = a - e * i, h = b - f * i), -1 !== l && (f > l && (h = i, f = l), e > l && (g = i, e = l)), c) return this._runActionsRange(h, h, c, d);
        if (e !== f || g !== h || c || d) {
          -1 === e && (e = g = 0);
          var m = b >= a,
            n = e;
          do {
            var o = !j != !(k && n % 2),
              p = n === e ? g : m ? 0 : i,
              q = n === f ? h : m ? i : 0;
            if (o && (p = i - p, q = i - q), k && n !== e && p === q);
            else if (this._runActionsRange(p, q, c, d || n !== e && !k)) return !0;
            d = !1
          } while (m && ++n <= f || !m && --n >= f)
        }
      }
    }, b._runActionsRange = function(a, b, c, d) {}, createjs.AbstractTween = createjs.promote(a, "EventDispatcher")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(c, d) {
      this.AbstractTween_constructor(d), this.pluginData = null, this.target = c, this.passive = !1, this._stepHead = new b(null, 0, 0, {}, null, !0), this._stepTail = this._stepHead, this._stepPosition = 0, this._actionHead = null, this._actionTail = null, this._plugins = null, this._pluginIds = null, this._injected = null, d && (this.pluginData = d.pluginData, d.override && a.removeTweens(c)), this.pluginData || (this.pluginData = {}), this._init(d)
    }

    function b(a, b, c, d, e, f) {
      this.next = null, this.prev = a, this.t = b, this.d = c, this.props = d, this.ease = e, this.passive = f, this.index = a ? a.index + 1 : 0
    }

    function c(a, b, c, d, e) {
      this.next = null, this.prev = a, this.t = b, this.d = 0, this.scope = c, this.funct = d, this.params = e
    }
    var d = createjs.extend(a, createjs.AbstractTween);
    a.IGNORE = {}, a._tweens = [], a._plugins = null, a._tweenHead = null, a._tweenTail = null, a.get = function(b, c) {
      return new a(b, c)
    }, a.tick = function(b, c) {
      for (var d = a._tweenHead; d;) {
        var e = d._next;
        c && !d.ignoreGlobalPause || d._paused || d.advance(d.useTicks ? 1 : b), d = e
      }
    }, a.handleEvent = function(a) {
      "tick" === a.type && this.tick(a.delta, a.paused)
    }, a.removeTweens = function(b) {
      if (b.tweenjs_count) {
        for (var c = a._tweenHead; c;) {
          var d = c._next;
          c.target === b && a._register(c, !0), c = d
        }
        b.tweenjs_count = 0
      }
    }, a.removeAllTweens = function() {
      for (var b = a._tweenHead; b;) {
        var c = b._next;
        b._paused = !0, b.target && (b.target.tweenjs_count = 0), b._next = b._prev = null, b = c
      }
      a._tweenHead = a._tweenTail = null
    }, a.hasActiveTweens = function(b) {
      return b ? !!b.tweenjs_count : !!a._tweenHead
    }, a._installPlugin = function(b) {
      for (var c = b.priority = b.priority || 0, d = a._plugins = a._plugins || [], e = 0, f = d.length; f > e && !(c < d[e].priority); e++);
      d.splice(e, 0, b)
    }, a._register = function(b, c) {
      var d = b.target;
      if (!c && b._paused) {
        d && (d.tweenjs_count = d.tweenjs_count ? d.tweenjs_count + 1 : 1);
        var e = a._tweenTail;
        e ? (a._tweenTail = e._next = b, b._prev = e) : a._tweenHead = a._tweenTail = b, !a._inited && createjs.Ticker && (createjs.Ticker.addEventListener("tick", a), a._inited = !0)
      } else if (c && !b._paused) {
        d && d.tweenjs_count--;
        var f = b._next,
          g = b._prev;
        f ? f._prev = g : a._tweenTail = g, g ? g._next = f : a._tweenHead = f, b._next = b._prev = null
      }
      b._paused = c
    }, d.wait = function(a, b) {
      return a > 0 && this._addStep(+a, this._stepTail.props, null, b), this
    }, d.to = function(a, b, c) {
      (null == b || 0 > b) && (b = 0);
      var d = this._addStep(+b, null, c);
      return this._appendProps(a, d), this
    }, d.label = function(a) {
      return this.addLabel(a, this.duration), this
    }, d.call = function(a, b, c) {
      return this._addAction(c || this.target, a, b || [this])
    }, d.set = function(a, b) {
      return this._addAction(b || this.target, this._set, [a])
    }, d.play = function(a) {
      return this._addAction(a || this, this._set, [{
        paused: !1
      }])
    }, d.pause = function(a) {
      return this._addAction(a || this, this._set, [{
        paused: !0
      }])
    }, d.w = d.wait, d.t = d.to, d.c = d.call, d.s = d.set, d.toString = function() {
      return "[Tween]"
    }, d.clone = function() {
      throw "Tween can not be cloned."
    }, d._addPlugin = function(a) {
      var b = this._pluginIds || (this._pluginIds = {}),
        c = a.ID;
      if (c && !b[c]) {
        b[c] = !0;
        for (var d = this._plugins || (this._plugins = []), e = a.priority || 0, f = 0, g = d.length; g > f; f++)
          if (e < d[f].priority) return void d.splice(f, 0, a);
        d.push(a)
      }
    }, d._updatePosition = function(a, b) {
      var c = this._stepHead.next,
        d = this.position,
        e = this.duration;
      if (this.target && c) {
        for (var f = c.next; f && f.t <= d;) c = c.next, f = c.next;
        var g = b ? 0 === e ? 1 : d / e : (d - c.t) / c.d;
        this._updateTargetProps(c, g, b)
      }
      this._stepPosition = c ? d - c.t : 0
    }, d._updateTargetProps = function(b, c, d) {
      if (!(this.passive = !!b.passive)) {
        var e, f, g, h, i = b.prev.props,
          j = b.props;
        (h = b.ease) && (c = h(c, 0, 1, 1));
        var k = this._plugins;
        a: for (var l in i) {
          if (f = i[l], g = j[l], e = f !== g && "number" == typeof f ? f + (g - f) * c : c >= 1 ? g : f, k)
            for (var m = 0, n = k.length; n > m; m++) {
              var o = k[m].change(this, b, l, e, c, d);
              if (o === a.IGNORE) continue a;
              void 0 !== o && (e = o)
            }
          this.target[l] = e
        }
      }
    }, d._runActionsRange = function(a, b, c, d) {
      var e = a > b,
        f = e ? this._actionTail : this._actionHead,
        g = b,
        h = a;
      e && (g = a, h = b);
      for (var i = this.position; f;) {
        var j = f.t;
        if ((j === b || j > h && g > j || d && j === a) && (f.funct.apply(f.scope, f.params), i !== this.position)) return !0;
        f = e ? f.prev : f.next
      }
    }, d._appendProps = function(b, c, d) {
      var e, f, g, h, i, j = this._stepHead.props,
        k = this.target,
        l = a._plugins,
        m = c.prev,
        n = m.props,
        o = c.props || (c.props = this._cloneProps(n)),
        p = {};
      for (e in b)
        if (b.hasOwnProperty(e) && (p[e] = o[e] = b[e], void 0 === j[e])) {
          if (h = void 0, l)
            for (f = l.length - 1; f >= 0; f--)
              if (g = l[f].init(this, e, h), void 0 !== g && (h = g), h === a.IGNORE) {
                delete o[e], delete p[e];
                break
              } h !== a.IGNORE && (void 0 === h && (h = k[e]), n[e] = void 0 === h ? null : h)
        } for (e in p) {
        g = b[e];
        for (var q, r = m;
          (q = r) && (r = q.prev);)
          if (r.props !== q.props) {
            if (void 0 !== r.props[e]) break;
            r.props[e] = n[e]
          }
      }
      if (d !== !1 && (l = this._plugins))
        for (f = l.length - 1; f >= 0; f--) l[f].step(this, c, p);
      (i = this._injected) && (this._injected = null, this._appendProps(i, c, !1))
    }, d._injectProp = function(a, b) {
      var c = this._injected || (this._injected = {});
      c[a] = b
    }, d._addStep = function(a, c, d, e) {
      var f = new b(this._stepTail, this.duration, a, c, d, e || !1);
      return this.duration += a, this._stepTail = this._stepTail.next = f
    }, d._addAction = function(a, b, d) {
      var e = new c(this._actionTail, this.duration, a, b, d);
      return this._actionTail ? this._actionTail.next = e : this._actionHead = e, this._actionTail = e, this
    }, d._set = function(a) {
      for (var b in a) this[b] = a[b]
    }, d._cloneProps = function(a) {
      var b = {};
      for (var c in a) b[c] = a[c];
      return b
    }, createjs.Tween = createjs.promote(a, "AbstractTween")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a(a) {
      var b, c;
      a instanceof Array || null == a && arguments.length > 1 ? (b = a, c = arguments[1], a = arguments[2]) : a && (b = a.tweens, c = a.labels), this.AbstractTween_constructor(a), this.tweens = [], b && this.addTween.apply(this, b), this.setLabels(c), this._init(a)
    }
    var b = createjs.extend(a, createjs.AbstractTween);
    b.addTween = function(a) {
      a._parent && a._parent.removeTween(a);
      var b = arguments.length;
      if (b > 1) {
        for (var c = 0; b > c; c++) this.addTween(arguments[c]);
        return arguments[b - 1]
      }
      if (0 === b) return null;
      this.tweens.push(a), a._parent = this, a.paused = !0;
      var d = a.duration;
      return a.loop > 0 && (d *= a.loop + 1), d > this.duration && (this.duration = d), this.rawPosition >= 0 && a.setPosition(this.rawPosition), a
    }, b.removeTween = function(a) {
      var b = arguments.length;
      if (b > 1) {
        for (var c = !0, d = 0; b > d; d++) c = c && this.removeTween(arguments[d]);
        return c
      }
      if (0 === b) return !0;
      for (var e = this.tweens, d = e.length; d--;)
        if (e[d] === a) return e.splice(d, 1), a._parent = null, a.duration >= this.duration && this.updateDuration(), !0;
      return !1
    }, b.updateDuration = function() {
      this.duration = 0;
      for (var a = 0, b = this.tweens.length; b > a; a++) {
        var c = this.tweens[a],
          d = c.duration;
        c.loop > 0 && (d *= c.loop + 1), d > this.duration && (this.duration = d)
      }
    }, b.toString = function() {
      return "[Timeline]"
    }, b.clone = function() {
      throw "Timeline can not be cloned."
    }, b._updatePosition = function(a, b) {
      for (var c = this.position, d = 0, e = this.tweens.length; e > d; d++) this.tweens[d].setPosition(c, !0, a)
    }, b._runActionsRange = function(a, b, c, d) {
      for (var e = this.position, f = 0, g = this.tweens.length; g > f; f++)
        if (this.tweens[f]._runActions(a, b, c, d), e !== this.position) return !0
    }, createjs.Timeline = createjs.promote(a, "AbstractTween")
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      throw "Ease cannot be instantiated."
    }
    a.linear = function(a) {
      return a
    }, a.none = a.linear, a.get = function(a) {
      return -1 > a ? a = -1 : a > 1 && (a = 1),
        function(b) {
          return 0 == a ? b : 0 > a ? b * (b * -a + 1 + a) : b * ((2 - b) * a + (1 - a))
        }
    }, a.getPowIn = function(a) {
      return function(b) {
        return Math.pow(b, a)
      }
    }, a.getPowOut = function(a) {
      return function(b) {
        return 1 - Math.pow(1 - b, a)
      }
    }, a.getPowInOut = function(a) {
      return function(b) {
        return (b *= 2) < 1 ? .5 * Math.pow(b, a) : 1 - .5 * Math.abs(Math.pow(2 - b, a))
      }
    }, a.quadIn = a.getPowIn(2), a.quadOut = a.getPowOut(2), a.quadInOut = a.getPowInOut(2), a.cubicIn = a.getPowIn(3), a.cubicOut = a.getPowOut(3), a.cubicInOut = a.getPowInOut(3), a.quartIn = a.getPowIn(4), a.quartOut = a.getPowOut(4), a.quartInOut = a.getPowInOut(4), a.quintIn = a.getPowIn(5), a.quintOut = a.getPowOut(5), a.quintInOut = a.getPowInOut(5), a.sineIn = function(a) {
      return 1 - Math.cos(a * Math.PI / 2)
    }, a.sineOut = function(a) {
      return Math.sin(a * Math.PI / 2)
    }, a.sineInOut = function(a) {
      return -.5 * (Math.cos(Math.PI * a) - 1)
    }, a.getBackIn = function(a) {
      return function(b) {
        return b * b * ((a + 1) * b - a)
      }
    }, a.backIn = a.getBackIn(1.7), a.getBackOut = function(a) {
      return function(b) {
        return --b * b * ((a + 1) * b + a) + 1
      }
    }, a.backOut = a.getBackOut(1.7), a.getBackInOut = function(a) {
      return a *= 1.525,
        function(b) {
          return (b *= 2) < 1 ? .5 * (b * b * ((a + 1) * b - a)) : .5 * ((b -= 2) * b * ((a + 1) * b + a) + 2)
        }
    }, a.backInOut = a.getBackInOut(1.7), a.circIn = function(a) {
      return -(Math.sqrt(1 - a * a) - 1)
    }, a.circOut = function(a) {
      return Math.sqrt(1 - --a * a)
    }, a.circInOut = function(a) {
      return (a *= 2) < 1 ? -.5 * (Math.sqrt(1 - a * a) - 1) : .5 * (Math.sqrt(1 - (a -= 2) * a) + 1)
    }, a.bounceIn = function(b) {
      return 1 - a.bounceOut(1 - b)
    }, a.bounceOut = function(a) {
      return 1 / 2.75 > a ? 7.5625 * a * a : 2 / 2.75 > a ? 7.5625 * (a -= 1.5 / 2.75) * a + .75 : 2.5 / 2.75 > a ? 7.5625 * (a -= 2.25 / 2.75) * a + .9375 : 7.5625 * (a -= 2.625 / 2.75) * a + .984375
    }, a.bounceInOut = function(b) {
      return .5 > b ? .5 * a.bounceIn(2 * b) : .5 * a.bounceOut(2 * b - 1) + .5
    }, a.getElasticIn = function(a, b) {
      var c = 2 * Math.PI;
      return function(d) {
        if (0 == d || 1 == d) return d;
        var e = b / c * Math.asin(1 / a);
        return -(a * Math.pow(2, 10 * (d -= 1)) * Math.sin((d - e) * c / b))
      }
    }, a.elasticIn = a.getElasticIn(1, .3), a.getElasticOut = function(a, b) {
      var c = 2 * Math.PI;
      return function(d) {
        if (0 == d || 1 == d) return d;
        var e = b / c * Math.asin(1 / a);
        return a * Math.pow(2, -10 * d) * Math.sin((d - e) * c / b) + 1
      }
    }, a.elasticOut = a.getElasticOut(1, .3), a.getElasticInOut = function(a, b) {
      var c = 2 * Math.PI;
      return function(d) {
        var e = b / c * Math.asin(1 / a);
        return (d *= 2) < 1 ? -.5 * (a * Math.pow(2, 10 * (d -= 1)) * Math.sin((d - e) * c / b)) : a * Math.pow(2, -10 * (d -= 1)) * Math.sin((d - e) * c / b) * .5 + 1
      }
    }, a.elasticInOut = a.getElasticInOut(1, .3 * 1.5), createjs.Ease = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";

    function a() {
      throw "MotionGuidePlugin cannot be instantiated."
    }
    var b = a;
    b.priority = 0, b.ID = "MotionGuide", b.install = function() {
      return createjs.Tween._installPlugin(a), createjs.Tween.IGNORE
    }, b.init = function(a, c, d) {
      "guide" == c && a._addPlugin(b)
    }, b.step = function(a, c, d) {
      for (var e in d)
        if ("guide" === e) {
          var f = c.props.guide,
            g = b._solveGuideData(d.guide, f);
          f.valid = !g;
          var h = f.endData;
          if (a._injectProp("x", h.x), a._injectProp("y", h.y), g || !f.orient) break;
          var i = void 0 === c.prev.props.rotation ? a.target.rotation || 0 : c.prev.props.rotation;
          if (f.startOffsetRot = i - f.startData.rotation, "fixed" == f.orient) f.endAbsRot = h.rotation + f.startOffsetRot, f.deltaRotation = 0;
          else {
            var j = void 0 === d.rotation ? a.target.rotation || 0 : d.rotation,
              k = j - f.endData.rotation - f.startOffsetRot,
              l = k % 360;
            switch (f.endAbsRot = j, f.orient) {
              case "auto":
                f.deltaRotation = k;
                break;
              case "cw":
                f.deltaRotation = (l + 360) % 360 + 360 * Math.abs(k / 360 | 0);
                break;
              case "ccw":
                f.deltaRotation = (l - 360) % 360 + -360 * Math.abs(k / 360 | 0)
            }
          }
          a._injectProp("rotation", f.endAbsRot)
        }
    }, b.change = function(a, c, d, e, f, g) {
      var h = c.props.guide;
      if (h && c.props !== c.prev.props && h !== c.prev.props.guide) return "guide" === d && !h.valid || "x" == d || "y" == d || "rotation" === d && h.orient ? createjs.Tween.IGNORE : void b._ratioToPositionData(f, h, a.target)
    }, b.debug = function(a, c, d) {
      a = a.guide || a;
      var e = b._findPathProblems(a);
      if (e && console.error("MotionGuidePlugin Error found: \n" + e), !c) return e;
      var f, g = a.path,
        h = g.length,
        i = 3,
        j = 9;
      for (c.save(), c.lineCap = "round", c.lineJoin = "miter", c.beginPath(), c.moveTo(g[0], g[1]), f = 2; h > f; f += 4) c.quadraticCurveTo(g[f], g[f + 1], g[f + 2], g[f + 3]);
      c.strokeStyle = "black", c.lineWidth = 1.5 * i, c.stroke(), c.strokeStyle = "white", c.lineWidth = i, c.stroke(), c.closePath();
      var k = d.length;
      if (d && k) {
        var l = {},
          m = {};
        b._solveGuideData(a, l);
        for (var f = 0; k > f; f++) l.orient = "fixed", b._ratioToPositionData(d[f], l, m), c.beginPath(), c.moveTo(m.x, m.y), c.lineTo(m.x + Math.cos(.0174533 * m.rotation) * j, m.y + Math.sin(.0174533 * m.rotation) * j), c.strokeStyle = "black", c.lineWidth = 1.5 * i, c.stroke(), c.strokeStyle = "red", c.lineWidth = i, c.stroke(), c.closePath()
      }
      return c.restore(), e
    }, b._solveGuideData = function(a, c) {
      var d = void 0;
      if (d = b.debug(a)) return d;
      var e = c.path = a.path;
      c.orient = a.orient;
      c.subLines = [], c.totalLength = 0, c.startOffsetRot = 0, c.deltaRotation = 0, c.startData = {
        ratio: 0
      }, c.endData = {
        ratio: 1
      }, c.animSpan = 1;
      var f, g, h, i, j, k, l, m, n, o = e.length,
        p = 10,
        q = {};
      for (f = e[0], g = e[1], l = 2; o > l; l += 4) {
        h = e[l], i = e[l + 1], j = e[l + 2], k = e[l + 3];
        var r = {
            weightings: [],
            estLength: 0,
            portion: 0
          },
          s = f,
          t = g;
        for (m = 1; p >= m; m++) {
          b._getParamsForCurve(f, g, h, i, j, k, m / p, !1, q);
          var u = q.x - s,
            v = q.y - t;
          n = Math.sqrt(u * u + v * v), r.weightings.push(n), r.estLength += n, s = q.x, t = q.y
        }
        for (c.totalLength += r.estLength, m = 0; p > m; m++) n = r.estLength, r.weightings[m] = r.weightings[m] / n;
        c.subLines.push(r), f = j, g = k
      }
      n = c.totalLength;
      var w = c.subLines.length;
      for (l = 0; w > l; l++) c.subLines[l].portion = c.subLines[l].estLength / n;
      var x = isNaN(a.start) ? 0 : a.start,
        y = isNaN(a.end) ? 1 : a.end;
      b._ratioToPositionData(x, c, c.startData), b._ratioToPositionData(y, c, c.endData), c.startData.ratio = x, c.endData.ratio = y, c.animSpan = c.endData.ratio - c.startData.ratio
    }, b._ratioToPositionData = function(a, c, d) {
      var e, f, g, h, i, j = c.subLines,
        k = 0,
        l = 10,
        m = a * c.animSpan + c.startData.ratio;
      for (f = j.length, e = 0; f > e; e++) {
        if (h = j[e].portion, k + h >= m) {
          i = e;
          break
        }
        k += h
      }
      void 0 === i && (i = f - 1, k -= h);
      var n = j[i].weightings,
        o = h;
      for (f = n.length, e = 0; f > e && (h = n[e] * o, !(k + h >= m)); e++) k += h;
      i = 4 * i + 2, g = e / l + (m - k) / h * (1 / l);
      var p = c.path;
      return b._getParamsForCurve(p[i - 2], p[i - 1], p[i], p[i + 1], p[i + 2], p[i + 3], g, c.orient, d), c.orient && (a >= .99999 && 1.00001 >= a && void 0 !== c.endAbsRot ? d.rotation = c.endAbsRot : d.rotation += c.startOffsetRot + a * c.deltaRotation), d
    }, b._getParamsForCurve = function(a, b, c, d, e, f, g, h, i) {
      var j = 1 - g;
      i.x = j * j * a + 2 * j * g * c + g * g * e, i.y = j * j * b + 2 * j * g * d + g * g * f, h && (i.rotation = 57.2957795 * Math.atan2((d - b) * j + (f - d) * g, (c - a) * j + (e - c) * g))
    }, b._findPathProblems = function(a) {
      var b = a.path,
        c = b && b.length || 0;
      if (6 > c || (c - 2) % 4) {
        var d = " Cannot parse 'path' array due to invalid number of entries in path. ";
        return d += "There should be an odd number of points, at least 3 points, and 2 entries per point (x & y). ", d += "See 'CanvasRenderingContext2D.quadraticCurveTo' for details as 'path' models a quadratic bezier.\n\n", d += "Only [ " + c + " ] values found. Expected: " + Math.max(4 * Math.ceil((c - 2) / 4) + 2, 6)
      }
      for (var e = 0; c > e; e++)
        if (isNaN(b[e])) return "All data in path array must be numeric";
      var f = a.start;
      if (isNaN(f) && void 0 !== f) return "'start' out of bounds. Expected 0 to 1, got: " + f;
      var g = a.end;
      if (isNaN(g) && void 0 !== g) return "'end' out of bounds. Expected 0 to 1, got: " + g;
      var h = a.orient;
      return h && "fixed" != h && "auto" != h && "cw" != h && "ccw" != h ? 'Invalid orientation value. Expected ["fixed", "auto", "cw", "ccw", undefined], got: ' + h : void 0
    }, createjs.MotionGuidePlugin = a
  }(), this.createjs = this.createjs || {},
  function() {
    "use strict";
    var a = createjs.TweenJS = createjs.TweenJS || {};
    a.version = "NEXT", a.buildDate = "Thu, 14 Sep 2017 22:19:45 GMT"
  }();
var MobyLoader = {
  isVisible: false,
  ready: false,
  _cb: null,
  _problems: [],
  _audioFiles: [],
  _loadedAudio: 0,
  _cacheFiles: new Set(),
  _preloadAudio: function(url) {
    var queue = new createjs.LoadQueue();
    queue.installPlugin(createjs.Sound);
    queue.on("complete", this._loadedAudioHandler, this);
    queue.loadFile({
      id: url,
      src: url
    });
  },
  _loadedAudioHandler: function() {
    MobyLoader._loadedAudio++;
    var loadedPercent = (MobyLoader._loadedAudio / MobyLoader._audioFiles.length) * 100;
    MobyLoader._setProgress(loadedPercent);
    if (MobyLoader._loadedAudio == MobyLoader._audioFiles.length) {
      MobyLoader.ready = true;
    }
  },
  _handleProgressBar: function() {
    for (var i in this._audioFiles) {
      this._preloadAudio(this._audioFiles[i]);
      this._cacheFiles.add(this._audioFiles[i]);
    }
  },
  _reset: function() {
    this.isVisible = false;
    this.ready = false;
    this._cb = null;
    this._problems = [];
    this._audioFiles = [];
    this._loadedAudio = 0;
    this._setProgress(0);
  },
  _setProgress: function(percentage) {
    percentage = Math.ceil(percentage);
    if (percentage > 100) {
      percentage = 100;
    }
    var opacity = percentage / 100;
    $(".ml-logo").css({
      opacity: opacity
    });
    $(".ml-bar-container").css({
      opacity: opacity
    });
    $(".ml-bar").css({
      width: percentage + '%'
    });
    $(".ml-percentage").html(percentage + '%');
    if (percentage === 0) {
      $(".ml-message > h4").html("Great Job!");
      $(".ml-message > span").html("Hang tight for a moment ...");
    }
    if (percentage >= 100) {
      $(".ml-message > h4").html("Done!");
      $(".ml-message > span").html("Click the next button to continue.");
      $(".lab-footer > .lab-next").show();
    }
  },
  _cacheFilter: function(files) {
    return files.filter(function(file) {
      return !MobyLoader._cacheFiles.has(file);
    }.bind(this));
  },
  cacheFile: function(files) {
    if (typeof files === "string") {
      if (!this._cacheFiles.has(files)) {
        this._cacheFiles.add(files);
      }
      return;
    }
    if (Array.isArray(files)) {
      for (var i in files) {
        if (!this._cacheFiles.has(files[i])) {
          this._cacheFiles.add(files[i]);
        }
      }
      return;
    }
  },
  showMobyLoader: function(audioFiles, cb) {
    if (!Array.isArray(audioFiles)) return;
    this._audioFiles = this._cacheFilter(audioFiles);
    if (this._audioFiles.length === 0) {
      if (typeof cb === "function") cb();
      this._reset();
      return;
    }
    if (this.isVisible === false && typeof cb === 'function') {
      if (typeof soundManager !== 'undefined') {
        soundManager.destroySound('aSound');
      }
      this.isVisible = true;
      this.ready = false;
      this._cb = cb;
      $(".ml-container").css('display', 'flex');
      $("#loading").hide();
      $(".lab-problem").hide();
      this._handleProgressBar();
    }
  },
  hideMobyLoader: function() {
    if (this.isVisible === true && this._cb) {
      this._cb();
      $(".ml-container").hide();
      $(".lab-problem").show();
      this._reset();
    }
  },
}
$(document).ready(function() {
  if ($('.el-toggle-wrapper').length === 0) {
    return;
  }
  $('.el-toggle-wrapper > .el-toggle-container input').change(function() {
    $(this).parent().toggleClass('el-toggle-enabled', this.checked);
  });
});
LabClass.prototype.animateCorrectBox = function(selector, callback) {
  $('#lab-correct > div').hide();
  $('#lab-correct').show();
  var _this = this;
  $(selector).fadeIn(150, function() {
    var keepCorrectTime = _this.keepCorrectTime || 1000;
    setTimeout(function() {
      $(selector).fadeOut(150, function() {
        _this.onEndAnimateCorrectBox(callback);
      });
    }, keepCorrectTime);
  });
};
LabClass.prototype.onEndAnimateCorrectBox = function(callback) {
  $('#lab-correct').hide();
  if (typeof callback != 'undefined') callback();
};
LabClass.prototype.showCorrect = function(callback) {
  this.animateCorrectBox('.correct-answer', callback);
};
LabClass.prototype.showIncorrect = function(callback) {
  this.animateCorrectBox('.incorrect-answer', callback);
};
LabClass.prototype.showPartial = function(callback) {
  this.animateCorrectBox('.partial-answer', callback);
};
LabClass.prototype.showEnterAnswer = function(callback) {
  if (typeof this.correctBoxTimeout !== 'undefined' && this.correctBoxTimeout !== null) {
    clearTimeout(this.correctBoxTimeout);
    this.correctBoxTimeout = null;
  }
  this.screen.showProblemMessage({
    title: 'Oops!',
    message: 'You are missing one or more of the correct answers.'
  });
  var keepCorrectTime = this.keepCorrectTime || 1000;
  this.correctBoxTimeout = setTimeout(function() {
    this.correctBoxTimeout = null;
    this.screen.hideProblemMessage();
    if (callback) callback();
  }.bind(this), keepCorrectTime * 2);
};
LabClass.prototype.showTimeUp = function(callback) {
  this.animateCorrectBox('.time-up', callback);
};
var toc = {
  currentLesson: -1,
  currentStrand: -1,
  problemsArray: [],
  datasource: null,
  showIFrame: function(selector, show) {
    if (show) {
      $("#toc_dialog").find(selector).removeAttr('style').attr('height', 555);
    } else {
      $("#toc_dialog").find(selector).attr('style', 'display: block;line-height:0;height: 0;overflow: hidden;');
    }
  },
  changeIframePage: function(src) {
    var deferred = $.Deferred(),
      iframe = $("#toc_dialog").find("#toc_iframe").attr({
        "src": src
      });
    iframe.load(deferred.resolve);
    return deferred.promise();
  },
  changeProblemPage: function(src) {
    var deferred = $.Deferred(),
      iframe = $("#toc_dialog").find("#problem_iframe").attr({
        "src": src
      });
    iframe.load(deferred.resolve);
    return deferred.promise();
  },
  open: function() {
    var isMobile = false;
    if (navigator.userAgent.match(/iPad|iPhone|iPod|Android|Windows Phone/i)) {
      isMobile = true;
    }
    toc.datasource = jsVars.module.dataSource;
    var id = MSlab.userInteract.problem.pkMLProblemID;
    $("#toc_dialog").find("#toc_iframe, #problem_iframe").contents().find('html').html('');
    toc.showIFrame("#toc_iframe, #problem_iframe", false);
    dialog.open('toc_dialog', {
      'afterOpen': function() {
        $("#loading").show();
        $.when(toc.changeIframePage("/MM/" + toc.datasource + "/home/tableOfContents/" + id)).then(function() {
          $("#loading").hide();
          toc.showIFrame("#toc_iframe", true);
          if (toc.currentStrand != -1) {
            if (!isMobile) {
              $("#toc_dialog").find("#toc_iframe").contents().find('html, body').animate({
                scrollTop: $("#toc_dialog").find("#toc_iframe").contents().find(".strand.strand-" + toc.currentStrand).offset().top
              }, 0);
            } else {
              $("#toc_dialog").find("#toc_iframe").contents().find("#strand-" + toc.currentStrand)[0].scrollIntoView();
            }
          } else if (toc.currentLesson != -1) {
            if (!isMobile) {
              $("#toc_dialog").find("#toc_iframe").contents().find('html, body').animate({
                scrollTop: $("#toc_dialog").find("#toc_iframe").contents().find(".lesson.lesson-" + toc.currentLesson).offset().top
              }, 0);
            } else {
              $("#toc_dialog").find("#toc_iframe").contents().find("#lesson-" + toc.currentLesson)[0].scrollIntoView();
            }
          }
        });
        $("#toc_dialog").find(".standard-dialog-blue-cross").attr("onclick", "toc.close();");
      }
    });
  },
  close: function() {
    dialog.close('toc_dialog', {
      'afterClose': function() {
        toc.changeIframePage("about:blank");
        toc.changeProblemPage("about:blank");
      }
    });
  },
  expand: function(type, id, lessonID) {
    var parent = $("#toc_dialog").find("#toc_iframe").contents();
    var main = '.' + type + '-' + id;
    var elements = '';
    var lessonID = lessonID || id;
    if (type == 'lesson') {
      elements = '.lesson' + main;
    } else if (type == 'strand') {
      elements = '.strand' + main;
    }
    if ($(elements, parent).hasClass('expanded')) {
      if (type == 'lesson') {
        var toHide = '.strand' + main + ', .problems' + main;
        elements += ', .strand' + main;
      } else {
        var toHide = '.problems' + main;
      }
      $(toHide, parent).hide();
      $(elements, parent).removeClass('expanded');
    } else {
      if (type == 'strand') {
        if ($(".problems" + main, parent).length == 0) {
          $("#loading").show();
          $.get(mmapp.sbjUrl('home/strandContents/' + id + '/' + lessonID), function(main, parent, elements, response) {
            var responseHTML = $.parseHTML(response);
            $(elements, parent).after(responseHTML);
            $(".problems" + main, parent).show();
            $(elements, parent).addClass('expanded');
            $("#loading").hide();
          }.bind(this, main, parent, elements))
        } else {
          $(".problems" + main, parent).find('img').each(function() {
            $(this).attr('src', $(this).attr('rel'));
          })
          $(".problems" + main, parent).show();
          $(elements, parent).addClass('expanded');
        }
      } else {
        $(".strand" + main, parent).show();
        $(elements, parent).addClass('expanded');
      }
    }
  },
  showFeedBack: function(id, done, strand) {
    $("#toc_dialog").find(".prev_toc a, .next_toc a, .back_toc a").hide();
    toc.showIFrame("#toc_iframe, #problem_iframe", false);
    $("#loading").show();
    var request_url = "/MM/" + toc.datasource + "/home/tableOfContents_feedback/" + id;
    var problemIsAttempted = false;
    if (G_lab.arrProblemList.size > 0) {
      for (var i = 0; i < G_lab.arrProblemList.size; i++) {
        if (parseInt(G_lab.arrProblemList[i]['Problem']['pkMLProblemID']) == id && G_lab.arrProblemList[i]['StudentProblem']['Attempted'] && (id != CurrentProblem['pkMLProblemID'])) {
          request_url += '/1';
          problemIsAttempted = true;
          break;
        }
      }
    }
    var current_problem = $('#toc_iframe').contents().find('.problem-' + id);
    if (!current_problem.length) {
      return false;
    } else {
      var data = {
        fkMLStrandID: strand || current_problem.parent().attr('data-id') || null,
        feedback: problemIsAttempted || done || current_problem.hasClass('done') || false
      };
      var problem_list = current_problem.parent().find('.problem');
      var current_problem_position = 0;
      problem_list.each(function() {
        if ($(this).attr('data-id') == id) {
          return false;
        }
        current_problem_position++;
      })
      if (problem_list.get(current_problem_position + 1)) {
        data.next = problem_list.eq(current_problem_position + 1).attr('data-id')
      }
      if (current_problem_position > 0 && problem_list.get(current_problem_position - 1)) {
        data.prev = problem_list.eq(current_problem_position - 1).attr('data-id')
      }
    }
    var previewURL = "/MM/" + toc.datasource + "/home/preview/" + id + "/0/true&?isTocPreview=1";
    previewURL += data.feedback != 1 ? "&nofeedback=1" : "";
    $.when(toc.changeProblemPage(previewURL)).then(function() {
      var iframe_contents = $("#toc_dialog").find("#problem_iframe").contents();
      $("#loading").hide();
      $("#toc_dialog").find(".back_toc a").show();
      toc.showIFrame("#problem_iframe", true);
      iframe_contents.find('.content-problem, .pbl-header').css({
        pointerEvents: 'none',
        userSelect: 'none'
      });
      if (data.prev) {
        toc.setClick('prev', data.prev);
      }
      if (data.next) {
        toc.setClick('next', data.next);
      }
      var strandList = new Array();
      G_lab.arrStrand.forEach(function(strand) {
        if (strand['Strand']['pkMLStrandID'] != G_lab.StudentCurrent.StudentStrandType.fkMLStrandID) {
          strandList.push(strand['Strand']['pkMLStrandID']);
        }
      });
      var problemInNextStrands = ($.inArray(data.fkMLStrandID, strandList) != -1) ? 1 : 0;
      if (data.feedback != 1 || !problemIsAttempted || problemInNextStrands) {
        iframe_contents.find('.problem-feedback').remove();
        $('#problem_iframe')[0].contentWindow.doNext = function() {}
      }
      if (iframe_contents.find('.pbl-background-wrapper').attr('data-format') != 'GradableHotspot') {
        iframe_contents.find('.pbl-hotspot').show();
        iframe_contents.find('.pbl-hotspot.pbl-hotspot-explore-feedback .play_icon_explore').hide();
      }
      toc.showIFrame("#problem_iframe", true);
    });
  },
  backToList: function() {
    var id = MSlab.userInteract.problem.pkMLProblemID;
    $("#toc_dialog").find(".prev_toc a, .next_toc a, .back_toc a").hide().removeAttr("style");
    toc.showIFrame("#toc_iframe, #problem_iframe", false);
    toc.showIFrame("#toc_iframe", true);
  },
  setClick: function(type, id) {
    if (type == 'prev') {
      $("#toc_dialog").find(".prev_toc a").attr("onclick", "javascript:toc.showFeedBack(" + id + ")").show();
    } else if (type == 'next') {
      $("#toc_dialog").find(".next_toc a").attr("onclick", "javascript:toc.showFeedBack(" + id + ")").show();
    }
  }
};
var mmapp = {
  ajax: function(url, options) {
    $.ajaxSetup({
      cache: false
    });
    $.ajax(url, options);
  },
  get: function(url, data, callback, type) {
    if (jQuery.isFunction(data)) {
      type = type || callback;
      callback = data;
      data = undefined;
    }
    return mmapp.ajax({
      url: url,
      type: 'GET',
      dataType: type,
      data: data,
      success: callback
    });
  },
  post: function(url, data, callback, type) {
    if (jQuery.isFunction(data)) {
      type = type || callback;
      callback = data;
      data = undefined;
    }
    return mmapp.ajax({
      url: url,
      type: 'POST',
      dataType: type,
      data: data,
      success: callback
    });
  },
  getJSON: function(url, data, callback) {
    mmapp.get(url, data, callback, "json");
  },
  mcUrl: function(url) {
    return window.location.protocol + "//" + window.location.host + mmapp.webroot + app.jsVars.defaultPrefix + '/' + url;
  },
  sbjUrl: function(url) {
    return window.location.protocol + "//" + window.location.host + mmapp.webroot + mmapp.module.name + '/' + url;
  }
};
LabClass.prototype.redirect = function(redirectUrl, unbindbeforeunload) {
  if (arguments.length > 1) {
    if (arguments[1])
      $(window).unbind('beforeunload');
  } else {
    $(window).unbind('beforeunload');
  }
  var url = arguments[0];
  if (window.nativeBridge) {
    if ((window.nativeBridge.isSyncLockTablet() == true) && (window.nativeBridge.getTabletMode() == 2) && (url.indexOf('/MM/SI') > -1)) {
      window.location = url;
    } else {
      window.location = url;
    }
  } else {
    window.location = url;
  }
};
LabClass.prototype.showGameTime = function(gameTime, next, parent_selector) {
  'use strict';
  if (!gameTime || gameTime <= 0) {
    next();
    return false;
  }
  var _this = this;
  var old_nextClick = this.onNextClick;
  this.onNextClick = this.noOp;
  this.setNextMessage('');
  var gameLine = '<span>' + gameTime + '</span>&nbsp;second' + (gameTime == 1 ? '' : 's') + ' of Game Time earned!';
  var splash = '.lab-splash-animate';
  var lab_next = $('.lab-next:visible');
  lab_next.hide();
  var parent = $(parent_selector || '.lab-problem');
  var old_content = parent.children().detach();
  parent.html('<div class="' + (splash.replace('.', '')) + '"></div>');
  var splash = $(splash);
  splash.html('<div class="lab-screen-gametime">' + '<div class="lab-screen-gametime-score centered">' +
    gameLine + '</div>' + '</div>');
  splash.css({
    opacity: 0,
    visibility: "visible",
    'left': 0
  }).animate({
    opacity: 1
  }, function() {
    setTimeout(function() {
      splash.animate({
        opacity: 0
      }, function() {
        lab_next.show();
        _this.onNextClick = old_nextClick;
        parent.empty().append(old_content);
        next();
      });
    }, 2000);
  });
  return true;
};
(function($) {
  $.fn.dropDownMenu = function() {
    return this.each(function() {
      var closeTimer = 0;
      var $this = $(this);
      var $subMenu = $($this.attr('data-submenu'));
      var setPosition = ($this.attr('data-set-position') !== '0');
      $this.bind('click', onMenuClick);
      if (!$('html').hasClass('mobile')) {
        $this.mouseover(closeSubMenuReset).mouseout(closeSubMenuStart);
        $subMenu.mouseover(closeSubMenuReset).mouseout(closeSubMenuStart);
      }
      $subMenu.on('click', '.lab-submenu-item', closeSubMenuStart);

      function onMenuClick(e) {
        if ($subMenu.is(':visible')) {
          closeSubMenuStart();
        } else {
          if ($('html').hasClass('mobile') && $subMenu.find('div:not(.mobile-hidden)').length == 0) {
            return;
          }
          $(this).parent().find('.dropdown-menu-active').trigger('click');
          $subMenu.show();
          if (setPosition) {
            var offset = $this.offset();
            var position = $this.position();
            var topPos = position.top + offset.top + $this.height() - 1;
            var leftPos = offset.left + $this.outerWidth() - $subMenu.outerWidth();
            $subMenu.css('top', topPos + 'px');
            $subMenu.css('left', leftPos + 'px');
          }
          $this.addClass('dropdown-menu-active');
          e.stopPropagation();
          $(document).on('click', onClickOutside);
        }
      };

      function onClickOutside(e) {
        closeSubMenu();
        e.stopPropagation();
      };

      function closeSubMenu() {
        $subMenu.hide();
        $this.removeClass('dropdown-menu-active');
        $(document).off('click', onClickOutside);
      };

      function closeSubMenuStart() {
        closeTimer = setTimeout(closeSubMenu, 100);
      };

      function closeSubMenuReset() {
        if (closeTimer) {
          clearTimeout(closeTimer);
          closeTimer = null;
        }
        if (!$subMenu.is(':visible')) $this.trigger('click');
      };
    });
  };
  $(function() {
    $('.dropdown-menu').dropDownMenu();
  });
}(jQuery));
